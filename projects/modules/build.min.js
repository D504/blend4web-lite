!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.nb4w=t()}(this,function(){"use strict";function e(e,t){var r="undefined"!=typeof Float32Array?Float32Array:Array,a=t;a.create=function(){var e=new r(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.clone=function(e){var t=new r(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},a.copy=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.transpose=function(e,t){if(t===e){var r=e[1],a=e[2],n=e[3],_=e[6],s=e[7],o=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=a,t[9]=_,t[11]=e[14],t[12]=n,t[13]=s,t[14]=o}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},a.invert=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=e[4],o=e[5],i=e[6],l=e[7],c=e[8],u=e[9],d=e[10],f=e[11],m=e[12],p=e[13],h=e[14],v=e[15],b=r*o-a*s,g=r*i-n*s,y=r*l-_*s,E=a*i-n*o,w=a*l-_*o,A=n*l-_*i,T=c*p-u*m,x=c*h-d*m,O=c*v-f*m,R=u*h-d*p,k=u*v-f*p,N=d*v-f*h,M=b*N-g*k+y*R+E*O-w*x+A*T;return M?(M=1/M,t[0]=(o*N-i*k+l*R)*M,t[1]=(n*k-a*N-_*R)*M,t[2]=(p*A-h*w+v*E)*M,t[3]=(d*w-u*A-f*E)*M,t[4]=(i*O-s*N-l*x)*M,t[5]=(r*N-n*O+_*x)*M,t[6]=(h*y-m*A-v*g)*M,t[7]=(c*A-d*y+f*g)*M,t[8]=(s*k-o*O+l*T)*M,t[9]=(a*O-r*k-_*T)*M,t[10]=(m*w-p*y+v*b)*M,t[11]=(u*y-c*w-f*b)*M,t[12]=(o*x-s*R-i*T)*M,t[13]=(r*R-a*x+n*T)*M,t[14]=(p*g-m*E-h*b)*M,t[15]=(c*E-u*g+d*b)*M,t):null},a.adjoint=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=e[4],o=e[5],i=e[6],l=e[7],c=e[8],u=e[9],d=e[10],f=e[11],m=e[12],p=e[13],h=e[14],v=e[15];return t[0]=o*(d*v-f*h)-u*(i*v-l*h)+p*(i*f-l*d),t[1]=-(a*(d*v-f*h)-u*(n*v-_*h)+p*(n*f-_*d)),t[2]=a*(i*v-l*h)-o*(n*v-_*h)+p*(n*l-_*i),t[3]=-(a*(i*f-l*d)-o*(n*f-_*d)+u*(n*l-_*i)),t[4]=-(s*(d*v-f*h)-c*(i*v-l*h)+m*(i*f-l*d)),t[5]=r*(d*v-f*h)-c*(n*v-_*h)+m*(n*f-_*d),t[6]=-(r*(i*v-l*h)-s*(n*v-_*h)+m*(n*l-_*i)),t[7]=r*(i*f-l*d)-s*(n*f-_*d)+c*(n*l-_*i),t[8]=s*(u*v-f*p)-c*(o*v-l*p)+m*(o*f-l*u),t[9]=-(r*(u*v-f*p)-c*(a*v-_*p)+m*(a*f-_*u)),t[10]=r*(o*v-l*p)-s*(a*v-_*p)+m*(a*l-_*o),t[11]=-(r*(o*f-l*u)-s*(a*f-_*u)+c*(a*l-_*o)),t[12]=-(s*(u*h-d*p)-c*(o*h-i*p)+m*(o*d-i*u)),t[13]=r*(u*h-d*p)-c*(a*h-n*p)+m*(a*d-n*u),t[14]=-(r*(o*h-i*p)-s*(a*h-n*p)+m*(a*i-n*o)),t[15]=r*(o*d-i*u)-s*(a*d-n*u)+c*(a*i-n*o),t},a.determinant=function(e){var t=e[0],r=e[1],a=e[2],n=e[3],_=e[4],s=e[5],o=e[6],i=e[7],l=e[8],c=e[9],u=e[10],d=e[11],f=e[12],m=e[13],p=e[14],h=e[15];return(t*s-r*_)*(u*h-d*p)-(t*o-a*_)*(c*h-d*m)+(t*i-n*_)*(c*p-u*m)+(r*o-a*s)*(l*h-d*f)-(r*i-n*s)*(l*p-u*f)+(a*i-n*o)*(l*m-c*f)},a.multiply=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3],o=e[4],i=e[5],l=e[6],c=e[7],u=e[8],d=e[9],f=e[10],m=e[11],p=e[12],h=e[13],v=e[14],b=e[15],g=t[0],y=t[1],E=t[2],w=t[3];return r[0]=g*a+y*o+E*u+w*p,r[1]=g*n+y*i+E*d+w*h,r[2]=g*_+y*l+E*f+w*v,r[3]=g*s+y*c+E*m+w*b,g=t[4],y=t[5],E=t[6],w=t[7],r[4]=g*a+y*o+E*u+w*p,r[5]=g*n+y*i+E*d+w*h,r[6]=g*_+y*l+E*f+w*v,r[7]=g*s+y*c+E*m+w*b,g=t[8],y=t[9],E=t[10],w=t[11],r[8]=g*a+y*o+E*u+w*p,r[9]=g*n+y*i+E*d+w*h,r[10]=g*_+y*l+E*f+w*v,r[11]=g*s+y*c+E*m+w*b,g=t[12],y=t[13],E=t[14],w=t[15],r[12]=g*a+y*o+E*u+w*p,r[13]=g*n+y*i+E*d+w*h,r[14]=g*_+y*l+E*f+w*v,r[15]=g*s+y*c+E*m+w*b,r},a.mul=a.multiply,a.translate=function(e,t,r){var a,n,_,s,o,i,l,c,u,d,f,m,p=t[0],h=t[1],v=t[2];return e===r?(r[12]=e[0]*p+e[4]*h+e[8]*v+e[12],r[13]=e[1]*p+e[5]*h+e[9]*v+e[13],r[14]=e[2]*p+e[6]*h+e[10]*v+e[14],r[15]=e[3]*p+e[7]*h+e[11]*v+e[15]):(a=e[0],n=e[1],_=e[2],s=e[3],o=e[4],i=e[5],l=e[6],c=e[7],u=e[8],d=e[9],f=e[10],m=e[11],r[0]=a,r[1]=n,r[2]=_,r[3]=s,r[4]=o,r[5]=i,r[6]=l,r[7]=c,r[8]=u,r[9]=d,r[10]=f,r[11]=m,r[12]=a*p+o*h+u*v+e[12],r[13]=n*p+i*h+d*v+e[13],r[14]=_*p+l*h+f*v+e[14],r[15]=s*p+c*h+m*v+e[15]),r},a.scale=function(e,t,r){var a=t[0],n=t[1],_=t[2];return r[0]=e[0]*a,r[1]=e[1]*a,r[2]=e[2]*a,r[3]=e[3]*a,r[4]=e[4]*n,r[5]=e[5]*n,r[6]=e[6]*n,r[7]=e[7]*n,r[8]=e[8]*_,r[9]=e[9]*_,r[10]=e[10]*_,r[11]=e[11]*_,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r},a.rotate=function(e,t,r,a){var n,_,s,o,i,l,c,u,d,f,m,p,h,v,b,g,y,E,w,A,T,x,O,R,k=r[0],N=r[1],M=r[2],I=Math.sqrt(k*k+N*N+M*M);return Math.abs(I)<1e-7?null:(I=1/I,k*=I,N*=I,M*=I,n=Math.sin(t),_=Math.cos(t),s=1-_,o=e[0],i=e[1],l=e[2],c=e[3],u=e[4],d=e[5],f=e[6],m=e[7],p=e[8],h=e[9],v=e[10],b=e[11],g=k*k*s+_,y=N*k*s+M*n,E=M*k*s-N*n,w=k*N*s-M*n,A=N*N*s+_,T=M*N*s+k*n,x=k*M*s+N*n,O=N*M*s-k*n,R=M*M*s+_,a[0]=o*g+u*y+p*E,a[1]=i*g+d*y+h*E,a[2]=l*g+f*y+v*E,a[3]=c*g+m*y+b*E,a[4]=o*w+u*A+p*T,a[5]=i*w+d*A+h*T,a[6]=l*w+f*A+v*T,a[7]=c*w+m*A+b*T,a[8]=o*x+u*O+p*R,a[9]=i*x+d*O+h*R,a[10]=l*x+f*O+v*R,a[11]=c*x+m*O+b*R,e!==a&&(a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15]),a)},a.rotateX=function(e,t,r){var a=Math.sin(t),n=Math.cos(t),_=e[4],s=e[5],o=e[6],i=e[7],l=e[8],c=e[9],u=e[10],d=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=_*n+l*a,r[5]=s*n+c*a,r[6]=o*n+u*a,r[7]=i*n+d*a,r[8]=l*n-_*a,r[9]=c*n-s*a,r[10]=u*n-o*a,r[11]=d*n-i*a,r},a.rotateY=function(e,t,r){var a=Math.sin(t),n=Math.cos(t),_=e[0],s=e[1],o=e[2],i=e[3],l=e[8],c=e[9],u=e[10],d=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=_*n-l*a,r[1]=s*n-c*a,r[2]=o*n-u*a,r[3]=i*n-d*a,r[8]=_*a+l*n,r[9]=s*a+c*n,r[10]=o*a+u*n,r[11]=i*a+d*n,r},a.rotateZ=function(e,t,r){var a=Math.sin(t),n=Math.cos(t),_=e[0],s=e[1],o=e[2],i=e[3],l=e[4],c=e[5],u=e[6],d=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=_*n+l*a,r[1]=s*n+c*a,r[2]=o*n+u*a,r[3]=i*n+d*a,r[4]=l*n-_*a,r[5]=c*n-s*a,r[6]=u*n-o*a,r[7]=d*n-i*a,r},a.fromTranslation=function(e,t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},a.fromScaling=function(e,t){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.fromRotation=function(e,t,r){var a,n,_,s=t[0],o=t[1],i=t[2],l=Math.sqrt(s*s+o*o+i*i);return Math.abs(l)<1e-7?null:(l=1/l,s*=l,o*=l,i*=l,a=Math.sin(e),n=Math.cos(e),_=1-n,r[0]=s*s*_+n,r[1]=o*s*_+i*a,r[2]=i*s*_-o*a,r[3]=0,r[4]=s*o*_-i*a,r[5]=o*o*_+n,r[6]=i*o*_+s*a,r[7]=0,r[8]=s*i*_+o*a,r[9]=o*i*_-s*a,r[10]=i*i*_+n,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)},a.fromXRotation=function(e,t){var r=Math.sin(e),a=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.fromYRotation=function(e,t){var r=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.fromZRotation=function(e,t){var r=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.fromRotationTranslation=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3],o=a+a,i=n+n,l=_+_,c=a*o,u=a*i,d=a*l,f=n*i,m=n*l,p=_*l,h=s*o,v=s*i,b=s*l;return r[0]=1-(f+p),r[1]=u+b,r[2]=d-v,r[3]=0,r[4]=u-b,r[5]=1-(c+p),r[6]=m+h,r[7]=0,r[8]=d+v,r[9]=m-h,r[10]=1-(c+f),r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r},a.fromRotationTranslationScale=function(e,t,r,a){var n=e[0],_=e[1],s=e[2],o=e[3],i=n+n,l=_+_,c=s+s,u=n*i,d=n*l,f=n*c,m=_*l,p=_*c,h=s*c,v=o*i,b=o*l,g=o*c,y=r[0],E=r[1],w=r[2];return a[0]=(1-(m+h))*y,a[1]=(d+g)*y,a[2]=(f-b)*y,a[3]=0,a[4]=(d-g)*E,a[5]=(1-(u+h))*E,a[6]=(p+v)*E,a[7]=0,a[8]=(f+b)*w,a[9]=(p-v)*w,a[10]=(1-(u+m))*w,a[11]=0,a[12]=t[0],a[13]=t[1],a[14]=t[2],a[15]=1,a},a.fromRotationTranslationScaleOrigin=function(e,t,r,a,n){var _=e[0],s=e[1],o=e[2],i=e[3],l=_+_,c=s+s,u=o+o,d=_*l,f=_*c,m=_*u,p=s*c,h=s*u,v=o*u,b=i*l,g=i*c,y=i*u,E=r[0],w=r[1],A=r[2],T=a[0],x=a[1],O=a[2];return n[0]=(1-(p+v))*E,n[1]=(f+y)*E,n[2]=(m-g)*E,n[3]=0,n[4]=(f-y)*w,n[5]=(1-(d+v))*w,n[6]=(h+b)*w,n[7]=0,n[8]=(m+g)*A,n[9]=(h-b)*A,n[10]=(1-(d+p))*A,n[11]=0,n[12]=t[0]+T-(n[0]*T+n[4]*x+n[8]*O),n[13]=t[1]+x-(n[1]*T+n[5]*x+n[9]*O),n[14]=t[2]+O-(n[2]*T+n[6]*x+n[10]*O),n[15]=1,n},a.fromQuat=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=r+r,o=a+a,i=n+n,l=r*s,c=a*s,u=a*o,d=n*s,f=n*o,m=n*i,p=_*s,h=_*o,v=_*i;return t[0]=1-u-m,t[1]=c+v,t[2]=d-h,t[3]=0,t[4]=c-v,t[5]=1-l-m,t[6]=f+p,t[7]=0,t[8]=d+h,t[9]=f-p,t[10]=1-l-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.frustum=function(e,t,r,a,n,_,s){var o=1/(t-e),i=1/(a-r),l=1/(n-_);return s[0]=2*n*o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*n*i,s[6]=0,s[7]=0,s[8]=(t+e)*o,s[9]=(a+r)*i,s[10]=(_+n)*l,s[11]=-1,s[12]=0,s[13]=0,s[14]=_*n*2*l,s[15]=0,s},a.perspective=function(e,t,r,a,n){var _=1/Math.tan(e/2),s=1/(r-a);return n[0]=_/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=_,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=(a+r)*s,n[11]=-1,n[12]=0,n[13]=0,n[14]=2*a*r*s,n[15]=0,n},a.perspectiveFromFieldOfView=function(e,t,r,a){var n=Math.tan(e.upDegrees*Math.PI/180),_=Math.tan(e.downDegrees*Math.PI/180),s=Math.tan(e.leftDegrees*Math.PI/180),o=Math.tan(e.rightDegrees*Math.PI/180),i=2/(s+o),l=2/(n+_);return a[0]=i,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=l,a[6]=0,a[7]=0,a[8]=-(s-o)*i*.5,a[9]=(n-_)*l*.5,a[10]=r/(t-r),a[11]=-1,a[12]=0,a[13]=0,a[14]=r*t/(t-r),a[15]=0,a},a.ortho=function(e,t,r,a,n,_,s){var o=1/(e-t),i=1/(r-a),l=1/(n-_);return s[0]=-2*o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*i,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*l,s[11]=0,s[12]=(e+t)*o,s[13]=(a+r)*i,s[14]=(_+n)*l,s[15]=1,s},a.lookAt=function(e,t,r,n){var _,s,o,i,l,c,u,d,f,m,p=e[0],h=e[1],v=e[2],b=r[0],g=r[1],y=r[2],E=t[0],w=t[1],A=t[2];return Math.abs(p-E)<1e-7&&Math.abs(h-w)<1e-7&&Math.abs(v-A)<1e-7?a.identity(n):(u=p-E,d=h-w,f=v-A,m=1/Math.sqrt(u*u+d*d+f*f),u*=m,d*=m,f*=m,_=g*f-y*d,s=y*u-b*f,o=b*d-g*u,(m=Math.sqrt(_*_+s*s+o*o))?(_*=m=1/m,s*=m,o*=m):(_=0,s=0,o=0),i=d*o-f*s,l=f*_-u*o,c=u*s-d*_,(m=Math.sqrt(i*i+l*l+c*c))?(i*=m=1/m,l*=m,c*=m):(i=0,l=0,c=0),n[0]=_,n[1]=i,n[2]=u,n[3]=0,n[4]=s,n[5]=l,n[6]=d,n[7]=0,n[8]=o,n[9]=c,n[10]=f,n[11]=0,n[12]=-(_*p+s*h+o*v),n[13]=-(i*p+l*h+c*v),n[14]=-(u*p+d*h+f*v),n[15]=1,n)},a.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},a.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))}}function t(e,t){var r="undefined"!=typeof Float32Array?Float32Array:Array,a=Math.random,n=t;n.create=function(){var e=new r(3);return e[0]=0,e[1]=0,e[2]=0,e},n.clone=function(e){var t=new r(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},n.fromValues=function(e,t,a){var n=new r(3);return n[0]=e,n[1]=t,n[2]=a,n},n.copy=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},n.set=function(e,t,r,a){return a[0]=e,a[1]=t,a[2]=r,a},n.add=function(e,t,r){return r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r},n.subtract=function(e,t,r){return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r},n.sub=n.subtract,n.multiply=function(e,t,r){return r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r},n.mul=n.multiply,n.divide=function(e,t,r){return r[0]=e[0]/t[0],r[1]=e[1]/t[1],r[2]=e[2]/t[2],r},n.div=n.divide,n.min=function(e,t,r){return r[0]=Math.min(e[0],t[0]),r[1]=Math.min(e[1],t[1]),r[2]=Math.min(e[2],t[2]),r},n.max=function(e,t,r){return r[0]=Math.max(e[0],t[0]),r[1]=Math.max(e[1],t[1]),r[2]=Math.max(e[2],t[2]),r},n.scale=function(e,t,r){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r},n.scaleAndAdd=function(e,t,r,a){return a[0]=e[0]+t[0]*r,a[1]=e[1]+t[1]*r,a[2]=e[2]+t[2]*r,a},n.distance=function(e,t){var r=t[0]-e[0],a=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(r*r+a*a+n*n)},n.dist=n.distance,n.squaredDistance=function(e,t){var r=t[0]-e[0],a=t[1]-e[1],n=t[2]-e[2];return r*r+a*a+n*n},n.sqrDist=n.squaredDistance,n.length=function(e){var t=e[0],r=e[1],a=e[2];return Math.sqrt(t*t+r*r+a*a)},n.len=n.length,n.squaredLength=function(e){var t=e[0],r=e[1],a=e[2];return t*t+r*r+a*a},n.sqrLen=n.squaredLength,n.negate=function(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},n.inverse=function(e,t){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},n.normalize=function(e,t){var r=e[0],a=e[1],n=e[2],_=r*r+a*a+n*n;return _>0&&(_=1/Math.sqrt(_),t[0]=e[0]*_,t[1]=e[1]*_,t[2]=e[2]*_),t},n.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},n.cross=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=t[0],o=t[1],i=t[2];return r[0]=n*i-_*o,r[1]=_*s-a*i,r[2]=a*o-n*s,r},n.lerp=function(e,t,r,a){var n=e[0],_=e[1],s=e[2];return a[0]=n+r*(t[0]-n),a[1]=_+r*(t[1]-_),a[2]=s+r*(t[2]-s),a},n.hermite=function(e,t,r,a,n,_){var s=n*n,o=s*(2*n-3)+1,i=s*(n-2)+n,l=s*(n-1),c=s*(3-2*n);return _[0]=e[0]*o+t[0]*i+r[0]*l+a[0]*c,_[1]=e[1]*o+t[1]*i+r[1]*l+a[1]*c,_[2]=e[2]*o+t[2]*i+r[2]*l+a[2]*c,_},n.bezier=function(e,t,r,a,n,_){var s=1-n,o=s*s,i=n*n,l=o*s,c=3*n*o,u=3*i*s,d=i*n;return _[0]=e[0]*l+t[0]*c+r[0]*u+a[0]*d,_[1]=e[1]*l+t[1]*c+r[1]*u+a[1]*d,_[2]=e[2]*l+t[2]*c+r[2]*u+a[2]*d,_},n.random=function(e,t){e=e||1;var r=2*a()*Math.PI,n=2*a()-1,_=Math.sqrt(1-n*n)*e;return t[0]=Math.cos(r)*_,t[1]=Math.sin(r)*_,t[2]=n*e,t},n.transformMat4=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=t[3]*a+t[7]*n+t[11]*_+t[15];return s=s||1,r[0]=(t[0]*a+t[4]*n+t[8]*_+t[12])/s,r[1]=(t[1]*a+t[5]*n+t[9]*_+t[13])/s,r[2]=(t[2]*a+t[6]*n+t[10]*_+t[14])/s,r},n.transformMat3=function(e,t,r){var a=e[0],n=e[1],_=e[2];return r[0]=a*t[0]+n*t[3]+_*t[6],r[1]=a*t[1]+n*t[4]+_*t[7],r[2]=a*t[2]+n*t[5]+_*t[8],r},n.transformQuat=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=t[0],o=t[1],i=t[2],l=t[3],c=l*a+o*_-i*n,u=l*n+i*a-s*_,d=l*_+s*n-o*a,f=-s*a-o*n-i*_;return r[0]=c*l+f*-s+u*-i-d*-o,r[1]=u*l+f*-o+d*-s-c*-i,r[2]=d*l+f*-i+c*-o-u*-s,r},n.rotateX=function(e,t,r,a){var n=[],_=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],_[0]=n[0],_[1]=n[1]*Math.cos(r)-n[2]*Math.sin(r),_[2]=n[1]*Math.sin(r)+n[2]*Math.cos(r),a[0]=_[0]+t[0],a[1]=_[1]+t[1],a[2]=_[2]+t[2],a},n.rotateY=function(e,t,r,a){var n=[],_=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],_[0]=n[2]*Math.sin(r)+n[0]*Math.cos(r),_[1]=n[1],_[2]=n[2]*Math.cos(r)-n[0]*Math.sin(r),a[0]=_[0]+t[0],a[1]=_[1]+t[1],a[2]=_[2]+t[2],a},n.rotateZ=function(e,t,r,a){var n=[],_=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],_[0]=n[0]*Math.cos(r)-n[1]*Math.sin(r),_[1]=n[0]*Math.sin(r)+n[1]*Math.cos(r),_[2]=n[2],a[0]=_[0]+t[0],a[1]=_[1]+t[1],a[2]=_[2]+t[2],a},n.forEach=function(){var e=n.create();return function(t,r,a,n,_,s){var o,i;for(r||(r=3),a||(a=0),i=n?Math.min(n*r+a,t.length):t.length,o=a;o<i;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],_(e,s,e),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}}(),n.angle=function(e,t){var r=n.fromValues(e[0],e[1],e[2]),a=n.fromValues(t[0],t[1],t[2]);n.normalize(r,r),n.normalize(a,a);var _=n.dot(r,a);return _>1?0:Math.acos(_)},n.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}}function r(e,t){var r="undefined"!=typeof Float32Array?Float32Array:Array,a=Math.random,n=t;n.create=function(){var e=new r(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},n.clone=function(e){var t=new r(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},n.fromValues=function(e,t,a,n){var _=new r(4);return _[0]=e,_[1]=t,_[2]=a,_[3]=n,_},n.copy=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},n.set=function(e,t,r,a,n){return n[0]=e,n[1]=t,n[2]=r,n[3]=a,n},n.add=function(e,t,r){return r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r},n.subtract=function(e,t,r){return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r[3]=e[3]-t[3],r},n.sub=n.subtract,n.multiply=function(e,t,r){return r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r[3]=e[3]*t[3],r},n.mul=n.multiply,n.divide=function(e,t,r){return r[0]=e[0]/t[0],r[1]=e[1]/t[1],r[2]=e[2]/t[2],r[3]=e[3]/t[3],r},n.div=n.divide,n.min=function(e,t,r){return r[0]=Math.min(e[0],t[0]),r[1]=Math.min(e[1],t[1]),r[2]=Math.min(e[2],t[2]),r[3]=Math.min(e[3],t[3]),r},n.max=function(e,t,r){return r[0]=Math.max(e[0],t[0]),r[1]=Math.max(e[1],t[1]),r[2]=Math.max(e[2],t[2]),r[3]=Math.max(e[3],t[3]),r},n.scale=function(e,t,r){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r},n.scaleAndAdd=function(e,t,r,a){return a[0]=e[0]+t[0]*r,a[1]=e[1]+t[1]*r,a[2]=e[2]+t[2]*r,a[3]=e[3]+t[3]*r,a},n.distance=function(e,t){var r=t[0]-e[0],a=t[1]-e[1],n=t[2]-e[2],_=t[3]-e[3];return Math.sqrt(r*r+a*a+n*n+_*_)},n.dist=n.distance,n.squaredDistance=function(e,t){var r=t[0]-e[0],a=t[1]-e[1],n=t[2]-e[2],_=t[3]-e[3];return r*r+a*a+n*n+_*_},n.sqrDist=n.squaredDistance,n.length=function(e){var t=e[0],r=e[1],a=e[2],n=e[3];return Math.sqrt(t*t+r*r+a*a+n*n)},n.len=n.length,n.squaredLength=function(e){var t=e[0],r=e[1],a=e[2],n=e[3];return t*t+r*r+a*a+n*n},n.sqrLen=n.squaredLength,n.negate=function(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},n.inverse=function(e,t){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},n.normalize=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=r*r+a*a+n*n+_*_;return s>0&&(s=1/Math.sqrt(s),t[0]=r*s,t[1]=a*s,t[2]=n*s,t[3]=_*s),t},n.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},n.lerp=function(e,t,r,a){var n=e[0],_=e[1],s=e[2],o=e[3];return a[0]=n+r*(t[0]-n),a[1]=_+r*(t[1]-_),a[2]=s+r*(t[2]-s),a[3]=o+r*(t[3]-o),a},n.random=function(e,t){return e=e||1,t[0]=a(),t[1]=a(),t[2]=a(),t[3]=a(),n.normalize(t,t),n.scale(t,e,t),t},n.transformMat4=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3];return r[0]=t[0]*a+t[4]*n+t[8]*_+t[12]*s,r[1]=t[1]*a+t[5]*n+t[9]*_+t[13]*s,r[2]=t[2]*a+t[6]*n+t[10]*_+t[14]*s,r[3]=t[3]*a+t[7]*n+t[11]*_+t[15]*s,r},n.transformQuat=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=t[0],o=t[1],i=t[2],l=t[3],c=l*a+o*_-i*n,u=l*n+i*a-s*_,d=l*_+s*n-o*a,f=-s*a-o*n-i*_;return r[0]=c*l+f*-s+u*-i-d*-o,r[1]=u*l+f*-o+d*-s-c*-i,r[2]=d*l+f*-i+c*-o-u*-s,r[3]=e[3],r},n.forEach=function(){var e=n.create();return function(t,r,a,n,_,s){var o,i;for(r||(r=4),a||(a=0),i=n?Math.min(n*r+a,t.length):t.length,o=a;o<i;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],e[3]=t[o+3],_(e,s,e),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2],t[o+3]=e[3];return t}}(),n.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}}function a(e,t){var r="undefined"!=typeof Float32Array?Float32Array:Array,a=t;a.create=function(){var e=new r(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},a.fromMat4=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},a.clone=function(e){var t=new r(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.copy=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},a.transpose=function(e,t){if(t===e){var r=e[1],a=e[2],n=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=a,t[7]=n}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},a.invert=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=e[4],o=e[5],i=e[6],l=e[7],c=e[8],u=c*s-o*l,d=-c*_+o*i,f=l*_-s*i,m=r*u+a*d+n*f;return m?(m=1/m,t[0]=u*m,t[1]=(-c*a+n*l)*m,t[2]=(o*a-n*s)*m,t[3]=d*m,t[4]=(c*r-n*i)*m,t[5]=(-o*r+n*_)*m,t[6]=f*m,t[7]=(-l*r+a*i)*m,t[8]=(s*r-a*_)*m,t):null},a.adjoint=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=e[4],o=e[5],i=e[6],l=e[7],c=e[8];return t[0]=s*c-o*l,t[1]=n*l-a*c,t[2]=a*o-n*s,t[3]=o*i-_*c,t[4]=r*c-n*i,t[5]=n*_-r*o,t[6]=_*l-s*i,t[7]=a*i-r*l,t[8]=r*s-a*_,t},a.determinant=function(e){var t=e[0],r=e[1],a=e[2],n=e[3],_=e[4],s=e[5],o=e[6],i=e[7],l=e[8];return t*(l*_-s*i)+r*(-l*n+s*o)+a*(i*n-_*o)},a.multiply=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3],o=e[4],i=e[5],l=e[6],c=e[7],u=e[8],d=t[0],f=t[1],m=t[2],p=t[3],h=t[4],v=t[5],b=t[6],g=t[7],y=t[8];return r[0]=d*a+f*s+m*l,r[1]=d*n+f*o+m*c,r[2]=d*_+f*i+m*u,r[3]=p*a+h*s+v*l,r[4]=p*n+h*o+v*c,r[5]=p*_+h*i+v*u,r[6]=b*a+g*s+y*l,r[7]=b*n+g*o+y*c,r[8]=b*_+g*i+y*u,r},a.mul=a.multiply,a.translate=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3],o=e[4],i=e[5],l=e[6],c=e[7],u=e[8],d=t[0],f=t[1];return r[0]=a,r[1]=n,r[2]=_,r[3]=s,r[4]=o,r[5]=i,r[6]=d*a+f*s+l,r[7]=d*n+f*o+c,r[8]=d*_+f*i+u,r},a.rotate=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3],o=e[4],i=e[5],l=e[6],c=e[7],u=e[8],d=Math.sin(t),f=Math.cos(t);return r[0]=f*a+d*s,r[1]=f*n+d*o,r[2]=f*_+d*i,r[3]=f*s-d*a,r[4]=f*o-d*n,r[5]=f*i-d*_,r[6]=l,r[7]=c,r[8]=u,r},a.scale=function(e,t,r){var a=t[0],n=t[1];return r[0]=a*e[0],r[1]=a*e[1],r[2]=a*e[2],r[3]=n*e[3],r[4]=n*e[4],r[5]=n*e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r},a.fromTranslation=function(e,t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},a.fromRotation=function(e,t){var r=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=r,t[2]=0,t[3]=-r,t[4]=a,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.fromScaling=function(e,t){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.fromMat2d=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},a.fromQuat=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=r+r,o=a+a,i=n+n,l=r*s,c=a*s,u=a*o,d=n*s,f=n*o,m=n*i,p=_*s,h=_*o,v=_*i;return t[0]=1-u-m,t[3]=c-v,t[6]=d+h,t[1]=c+v,t[4]=1-l-m,t[7]=f-p,t[2]=d-h,t[5]=f+p,t[8]=1-l-u,t},a.normalFromMat4=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=e[4],o=e[5],i=e[6],l=e[7],c=e[8],u=e[9],d=e[10],f=e[11],m=e[12],p=e[13],h=e[14],v=e[15],b=r*o-a*s,g=r*i-n*s,y=r*l-_*s,E=a*i-n*o,w=a*l-_*o,A=n*l-_*i,T=c*p-u*m,x=c*h-d*m,O=c*v-f*m,R=u*h-d*p,k=u*v-f*p,N=d*v-f*h,M=b*N-g*k+y*R+E*O-w*x+A*T;return M?(M=1/M,t[0]=(o*N-i*k+l*R)*M,t[1]=(i*O-s*N-l*x)*M,t[2]=(s*k-o*O+l*T)*M,t[3]=(n*k-a*N-_*R)*M,t[4]=(r*N-n*O+_*x)*M,t[5]=(a*O-r*k-_*T)*M,t[6]=(p*A-h*w+v*E)*M,t[7]=(h*y-m*A-v*g)*M,t[8]=(m*w-p*y+v*b)*M,t):null},a.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},a.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))}}function n(e,t){var r=l(e),a=c(e),n=u(e),_="undefined"!=typeof Float32Array?Float32Array:Array,s=t;s.create=function(){var e=new _(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},s.rotationTo=function(){var e=r.create(),t=r.fromValues(1,0,0),a=r.fromValues(0,1,0);return function(n,_,o){var i=r.dot(n,_);return i<-.9999999?(r.cross(t,n,e),r.length(e)<1e-6&&r.cross(a,n,e),r.normalize(e,e),s.setAxisAngle(e,Math.PI,o),o):i>.9999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(r.cross(n,_,e),o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=1+i,s.normalize(o,o))}}(),s.setAxes=function(){var e=n.create();return function(t,r,a,n){return e[0]=r[0],e[3]=r[1],e[6]=r[2],e[1]=a[0],e[4]=a[1],e[7]=a[2],e[2]=-t[0],e[5]=-t[1],e[8]=-t[2],s.normalize(s.fromMat3(e,n),n)}}(),s.clone=a.clone,s.fromValues=a.fromValues,s.copy=a.copy,s.set=a.set,s.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},s.setAxisAngle=function(e,t,r){t*=.5;var a=Math.sin(t);return r[0]=a*e[0],r[1]=a*e[1],r[2]=a*e[2],r[3]=Math.cos(t),r},s.add=a.add,s.multiply=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3],o=t[0],i=t[1],l=t[2],c=t[3];return r[0]=a*c+s*o+n*l-_*i,r[1]=n*c+s*i+_*o-a*l,r[2]=_*c+s*l+a*i-n*o,r[3]=s*c-a*o-n*i-_*l,r},s.mul=s.multiply,s.scale=a.scale,s.rotateX=function(e,t,r){t*=.5;var a=e[0],n=e[1],_=e[2],s=e[3],o=Math.sin(t),i=Math.cos(t);return r[0]=a*i+s*o,r[1]=n*i+_*o,r[2]=_*i-n*o,r[3]=s*i-a*o,r},s.rotateY=function(e,t,r){t*=.5;var a=e[0],n=e[1],_=e[2],s=e[3],o=Math.sin(t),i=Math.cos(t);return r[0]=a*i-_*o,r[1]=n*i+s*o,r[2]=_*i+a*o,r[3]=s*i-n*o,r},s.rotateZ=function(e,t,r){t*=.5;var a=e[0],n=e[1],_=e[2],s=e[3],o=Math.sin(t),i=Math.cos(t);return r[0]=a*i+n*o,r[1]=n*i-a*o,r[2]=_*i+s*o,r[3]=s*i-_*o,r},s.calculateW=function(e,t){var r=e[0],a=e[1],n=e[2];return t[0]=r,t[1]=a,t[2]=n,t[3]=Math.sqrt(Math.abs(1-r*r-a*a-n*n)),t},s.dot=a.dot,s.lerp=a.lerp,s.slerp=function(e,t,r,a){var n,_,s,o,i,l=e[0],c=e[1],u=e[2],d=e[3],f=t[0],m=t[1],p=t[2],h=t[3];return(_=l*f+c*m+u*p+d*h)<0&&(_=-_,f=-f,m=-m,p=-p,h=-h),1-_>1e-6?(n=Math.acos(_),s=Math.sin(n),o=Math.sin((1-r)*n)/s,i=Math.sin(r*n)/s):(o=1-r,i=r),a[0]=o*l+i*f,a[1]=o*c+i*m,a[2]=o*u+i*p,a[3]=o*d+i*h,a},s.sqlerp=function(){var e=s.create(),t=s.create();return function(r,a,n,_,o,i){return s.slerp(r,_,o,e),s.slerp(a,n,o,t),s.slerp(e,t,2*o*(1-o),i),i}}(),s.invert=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3],s=r*r+a*a+n*n+_*_,o=s?1/s:0;return t[0]=-r*o,t[1]=-a*o,t[2]=-n*o,t[3]=_*o,t},s.conjugate=function(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},s.length=a.length,s.len=s.length,s.squaredLength=a.squaredLength,s.sqrLen=s.squaredLength,s.normalize=a.normalize,s.fromMat3=function(e,t){var r,a=e[0]+e[4]+e[8];if(a>0)r=Math.sqrt(a+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var n=0;e[4]>e[0]&&(n=1),e[8]>e[3*n+n]&&(n=2);var _=(n+1)%3,s=(n+2)%3;r=Math.sqrt(e[3*n+n]-e[3*_+_]-e[3*s+s]+1),t[n]=.5*r,r=.5/r,t[3]=(e[3*_+s]-e[3*s+_])*r,t[_]=(e[3*_+n]+e[3*n+_])*r,t[s]=(e[3*s+n]+e[3*n+s])*r}return t},s.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}}function _(e,t){function r(e,t){var r=[];e[0].indexOf("%c")>-1?r.push(e[0].replace("%c","%c"+t+": ")):r.push(t+": "+e[0]);for(var a=1;a<e.length;a++)r.push(e[a]);return r}function a(){o++;var e=r(arguments,"B4W ERROR");console.error.apply(console,e)}function n(e){e in l||(l[e]=e,a([e]))}function _(e,t){n(e+"() is deprecated, use "+t+"() instead.")}var s=!1,o=0,i=0,l={};t.set_verbose=function(e){s=e},t.log_raw=function(){console.log.apply(console,arguments)},t.log=function(){if(s){var e=r(arguments,"B4W LOG");console.log.apply(console,e)}},t.compose_args_prefix=r,t.error=a,t.error_once=n,t.error_deprecated=_,t.error_deprecated_arr=function(e,t){switch(t.length>1){case!0:n(e+"() is deprecated, use "+t.slice(0,-1).join("(), ")+"() or "+t[t.length-1]+"() instead.");break;case!1:_(e,t[0])}},t.error_deprecated_cfg=function(e,t){n(void 0===t?'Config option "'+e+'" is deprecated.':'Config option "'+e+'" is deprecated, use "'+t+'" instead.')},t.warn=function(){i++;var e=r(arguments,"B4W WARN");console.warn.apply(console,e)},t.info=function(){var e=r(arguments,"B4W INFO");console.info.apply(console,e)},t.export_error=function(){o++;var e=r(arguments,"B4W EXPORT ERROR");console.error.apply(console,e)},t.export_warn=function(){i++;var e=r(arguments,"B4W EXPORT WARNING");console.warn.apply(console,e)},t.time=function(){s&&console.time.apply(console,arguments)},t.timeEnd=function(){s&&console.timeEnd.apply(console,arguments)},t.group=function(){console.group.apply(console,arguments)},t.groupCollapsed=function(){console.groupCollapsed.apply(console,arguments)},t.groupEnd=function(){console.groupEnd.apply(console,arguments)},t.clear=function(){"function"==typeof console.clear&&console.clear.apply(console,arguments)},t.get_warning_count=function(){return i},t.get_error_count=function(){return o},t.clear_errors_warnings=function(){i=0,o=0}}var s={},o=function(e,t,r){if(console.log(e),void 0!==s[e])return s[e];var a={},n=s[e]=function(e,r){return void 0!==a[e]?a[e]:(a[e]={},t(e,a[e]),a[e])};return b4w._n_module[e]=n,n},i=o("mat4",e);o("__mat4",e);var l=o("vec3",t);o("__vec3",t);var c=o("vec4",r);o("__vec4",r);var u=o("mat3",a);o("__mat3",a);var d=o("quat",n);o("__quat",n);var f=o("__math",function(e,t){function r(e,t){for(var r=e[1],a=1,n=2;n<e.length;n++)4!=n&&8!=n&&Math.abs(e[n])>Math.abs(r)&&(r=e[n],a=n);for(var _=Math.floor(a/3),s=a%3,o=.5*Math.atan(2*r/(e[3*_+_]-e[3*s+s])),n=0;n<t.length;n++)t[n]=0==n||4==n||8==n?1:0;return t[s+3*_]=-Math.sin(o),t[_+3*s]=Math.sin(o),t[_+3*_]=Math.cos(o),t[s+3*s]=Math.cos(o),t}function a(e){return Math.sqrt(e[1]*e[1]+e[2]*e[2]+e[5]*e[5])}function n(e,t){for(var r=e.content[t];t>0;){var a=(t+1>>1)-1,n=e.content[a];if(!(e.score_function(r)<e.score_function(n)))break;e.content[a]=r,e.content[t]=n,t=a}}function _(e,t){for(var r=e.content.length,a=e.content[t],n=e.score_function(a);;){var _=t+1<<1,s=_-1,o=null;if(s<r){var i=e.content[s],l=e.score_function(i);l<n&&(o=s)}if(_<r){var c=e.content[_];e.score_function(c)<(null===o?n:l)&&(o=_)}if(null===o)break;e.content[t]=e.content[o],e.content[o]=a,t=o}}function s(e,t,r,a){return r-o(a-e,0,r,a)+t}function o(e,t,r,a){return(e/=a)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t}var i=u(e),c=l(e),d=new Float32Array(3),f=new Float32Array(9),m=new Float32Array(9),p=new Float32Array(9),h=new Float32Array(9);t.get_pline_directional_vec=function(e,t){return t=t||new Float32Array(3),t[0]=e[3],t[1]=e[4],t[2]=e[5],t},t.get_pline_initial_point=function(e,t){return t=t||new Float32Array(3),c.copy(e,t)},t.set_pline_initial_point=function(e,t){c.copy(t,e)},t.set_pline_directional_vec=function(e,t){c.normalize(t,d),e[3]=d[0],e[4]=d[1],e[5]=d[2]},t.calc_pline_point=function(e,t,r){return r=r||new Float32Array(3),r[0]=e[0]+e[3]*t,r[1]=e[1]+e[4]*t,r[2]=e[2]+e[5]*t,r},t.calk_average_position=function(e,t){t[0]=0,t[1]=0,t[2]=0;for(var r=0;r<e.length;r+=3)t[0]+=e[r],t[1]+=e[r+1],t[2]+=e[r+2];return c.scale(t,3/e.length,t)},t.calc_covariance_matrix=function(e,t,r){for(s=0;s<r.length;s++)r[s]=0;for(s=0;s<e.length;s+=3){var a=e[s]-t[0],n=e[s+1]-t[1],_=e[s+2]-t[2];r[0]+=a*a,r[1]+=a*n,r[2]+=a*_,r[4]+=n*n,r[5]+=n*_,r[8]+=_*_}r[3]=r[1],r[6]=r[2],r[7]=r[5];for(var s=0;s<r.length;s++)r[s]*=3/e.length;return r},t.find_eigenvectors=function(e,t,n){var _=i.copy(e,f);if(a(_)<t)return i.identity(n);var s=r(_,m),o=i.transpose(s,p);i.multiply(_,o,h),i.multiply(s,h,_);for(var l=i.copy(s,n),c=1;t<=a(_)&&c<100;)s=r(_,m),o=i.transpose(s,p),i.multiply(_,o,h),i.multiply(s,h,_),i.multiply(s,l,l),c++;return l},t.point_plane_dist=function(e,t){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]},t.binary_heap_new=function(e){return{content:[],score_function:e}},t.binary_heap_push=function(e,t){e.content.push(t),n(e,e.content.length-1)},t.binary_heap_pop=function(e){var t=e.content[0],r=e.content.pop();return e.content.length>0&&(e.content[0]=r,_(e,0)),t},t.binary_heap_remove=function(e,t){var r=e.content.indexOf(t),a=e.content.pop();r!==e.content.length-1&&(e.content[r]=a,e.score_function(a)<e.score_function(t)?n(r):_(r))},t.binary_heap_rescore_element=function(e,t){n(e,e.content.indexOf(t))},t.linear_tween=function(e,t,r,a){return r*e/a+t},t.ease_in_quad=function(e,t,r,a){return r*(e/=a)*e+t},t.ease_out_quad=function(e,t,r,a){return-r*(e/=a)*(e-2)+t},t.ease_in_out_quad=function(e,t,r,a){return(e/=a/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t},t.ease_in_cubic=function(e,t,r,a){return r*(e/=a)*e*e+t},t.ease_out_cubic=function(e,t,r,a){return r*((e=e/a-1)*e*e+1)+t},t.ease_in_out_cubic=function(e,t,r,a){return(e/=a/2)<1?r/2*e*e*e+t:r/2*((e-=2)*e*e+2)+t},t.ease_in_quart=function(e,t,r,a){return r*(e/=a)*e*e*e+t},t.ease_out_quart=function(e,t,r,a){return-r*((e=e/a-1)*e*e*e-1)+t},t.ease_in_out_quart=function(e,t,r,a){return(e/=a/2)<1?r/2*e*e*e*e+t:-r/2*((e-=2)*e*e*e-2)+t},t.ease_in_quint=function(e,t,r,a){return r*(e/=a)*e*e*e*e+t},t.ease_out_quint=function(e,t,r,a){return r*((e=e/a-1)*e*e*e*e+1)+t},t.ease_in_out_quint=function(e,t,r,a){return(e/=a/2)<1?r/2*e*e*e*e*e+t:r/2*((e-=2)*e*e*e*e+2)+t},t.ease_in_sine=function(e,t,r,a){return-r*Math.cos(e/a*(Math.PI/2))+r+t},t.ease_out_sine=function(e,t,r,a){return r*Math.sin(e/a*(Math.PI/2))+t},t.ease_in_out_sine=function(e,t,r,a){return-r/2*(Math.cos(Math.PI*e/a)-1)+t},t.ease_in_expo=function(e,t,r,a){return 0==e?t:r*Math.pow(2,10*(e/a-1))+t},t.ease_out_expo=function(e,t,r,a){return e==a?t+r:r*(1-Math.pow(2,-10*e/a))+t},t.ease_in_out_expo=function(e,t,r,a){return 0==e?t:e==a?t+r:(e/=a/2)<1?r/2*Math.pow(2,10*(e-1))+t:r/2*(2-Math.pow(2,-10*--e))+t},t.ease_in_circ=function(e,t,r,a){return-r*(Math.sqrt(1-(e/=a)*e)-1)+t},t.ease_out_circ=function(e,t,r,a){return r*Math.sqrt(1-(e=e/a-1)*e)+t},t.ease_in_out_circ=function(e,t,r,a){return(e/=a/2)<1?-r/2*(Math.sqrt(1-e*e)-1)+t:r/2*(Math.sqrt(1-(e-=2)*e)+1)+t},t.ease_in_elastic=function(e,t,r,a){var n=1.70158,_=0,s=r;return 0==e?t:1==(e/=a)?t+r:(_||(_=.3*a),s<Math.abs(r)?(s=r,n=_/4):n=_/(2*Math.PI)*Math.asin(r/s),-s*Math.pow(2,10*(e-=1))*Math.sin((e*a-n)*(2*Math.PI)/_)+t)},t.ease_out_elastic=function(e,t,r,a){var n=1.70158,_=0,s=r;return 0==e?t:1==(e/=a)?t+r:(_||(_=.3*a),s<Math.abs(r)?(s=r,n=_/4):n=_/(2*Math.PI)*Math.asin(r/s),s*Math.pow(2,-10*e)*Math.sin((e*a-n)*(2*Math.PI)/_)+r+t)},t.ease_in_out_elastic=function(e,t,r,a){var n=1.70158,_=0,s=r;return 0==e?t:2==(e/=a/2)?t+r:(_||(_=a*(.3*1.5)),s<Math.abs(r)?(s=r,n=_/4):n=_/(2*Math.PI)*Math.asin(r/s),e<1?s*Math.pow(2,10*(e-=1))*Math.sin((e*a-n)*(2*Math.PI)/_)*-.5+t:s*Math.pow(2,-10*(e-=1))*Math.sin((e*a-n)*(2*Math.PI)/_)*.5+r+t)},t.ease_in_back=function(e,t,r,a,n){return void 0==n&&(n=1.70158),r*(e/=a)*e*((n+1)*e-n)+t},t.ease_out_back=function(e,t,r,a,n){return void 0==n&&(n=1.70158),r*((e=e/a-1)*e*((n+1)*e+n)+1)+t},t.ease_in_out_back=function(e,t,r,a,n){return void 0==n&&(n=1.70158),(e/=a/2)<1?r/2*(e*e*((1+(n*=1.525))*e-n))+t:r/2*((e-=2)*e*((1+(n*=1.525))*e+n)+2)+t},t.ease_in_bounce=s,t.ease_out_bounce=o,t.ease_in_out_bounce=function(e,t,r,a){return e<a/2?.5*s(2*e,0,r,a)+t:.5*o(2*e-a,0,r,a)+.5*r+t}}),m=o("print",_);o("__print",_);var p=o("__tbn",function(e,t){function r(e,t,r){var a=u(e,t=t||0,r);return y.normalize(a,r),r}function a(e,t,r){var a=u(e,r=r||0,M),n=y.length(a),_=T.sign(a[3])*T.sign(t[3])||1;return y.scale(t,_*n,a),Math.abs(a[3])<b&&(a[3]>0?a[3]=b:a[3]=-b),f(e,a,r),e}function n(e,t){return t=t||0,T.sign(e[4*t+3])}function _(e,t,r){var a=u(e,r=r||0,M);return T.sign(a[3])*t<0&&y.scale(a,-1,a),f(e,a,r),e}function s(e,t,r){var a=u(e,r=r||0,M);return y.normalize(a,a),y.scale(a,t,a),Math.abs(a[3])<b&&(a[3]>0?a[3]+=b:a[3]-=b),f(e,a,r),e}function o(e,t){var r=u(e,t=t||0,M);return y.length(r)}function i(e){e=0!==e?e||1:0;for(var t=new Float32Array(4*e),r=0;r<e;r++)t[4*r+3]=g;return t}function u(e,t,r){return r[0]=e[4*t],r[1]=e[4*t+1],r[2]=e[4*t+2],r[3]=e[4*t+3],r}function f(e,t,r){return e[4*r]=t[0],e[4*r+1]=t[1],e[4*r+2]=t[2],e[4*r+3]=t[3],e}function m(e){return e.length/4}function p(e,t,i){for(var l=m(e),c=0;c<l;c++){var u=n(e,c),d=o(e,c),f=r(e,c,O);a(i,y.multiply(t,f,O),c),s(i,d,c),_(i,u,c)}}var b=31e-6,g=.5;t.TBN_NUM_COMP=4;var y=d(e),E=v(e),w=l(e),A=c(e),T=h(e),x=y.create(),O=y.create(),R=w.create(),k=w.create(),N=w.create(),M=A.create(),I=A.create();t.from_norm_tan=function(e,t,r){var n=!(!t||!t.length),o=e.length/3;r=r||i(o);for(var l=0;l<o;++l){var c=R;if(c[0]=e[3*l],c[1]=e[3*l+1],c[2]=e[3*l+2],w.normalize(c,c),n){var u=I;u[0]=t[4*l],u[1]=t[4*l+1],u[2]=t[4*l+2],u[3]=t[4*l+3],w.normalize(u,u);var d=w.cross(u,c,k);w.normalize(d,d);var f=y.rotationTo(T.AXIS_Z,d,x),m=w.transformQuat(T.AXIS_Y,f,N),p=y.rotationTo(m,c,O),h=y.multiply(p,f,x);y.normalize(h,h);var v=g,E=w.cross(c,d,N);(Math.abs(E[0]-u[0])>b||Math.abs(E[1]-u[1])>b||Math.abs(E[2]-u[2])>b)&&(v=Math.acos(w.dot(c,u))/Math.PI),a(r,h,l),_(r,T.sign(u[3]),l),s(r,v,l)}else a(r,h=y.rotationTo(T.AXIS_Y,c,x),l)}return r},t.copy=function(e,t,r,a){if(0!==r){t=4*t||0,r=r||e.length;for(var n=0,_=0;n<4*r;n+=4,_+=4)a[_]=e[t+n],a[_+1]=e[t+n+1],a[_+2]=e[t+n+2],a[_+3]=e[t+n+3]}},t.get_quat=r,t.set_quat=a,t.get_norm=function(e,t,a){var n=r(e,t,x);return w.transformQuat(T.AXIS_Y,n,a)},t.create=i,t.identity=function(e){for(var t=0;t<e.length;t+=4)e[t]=0,e[t+1]=0,e[t+2]=0,e[t+3]=g;return e},t.get_item=u,t.set_item=f,t.get_items_count=m,t.multiply_quat=p,t.multiply_tsr=function(e,t,r){return p(e,E.get_quat(t,x),r)},t.slerp=function(e,t,i,l){var c=n(t,0),u=r(e,0,x),d=r(t,0,O),f=o(e),m=o(t),p=y.slerp(u,d,i,O);return y.normalize(p,p),a(l,p,0),s(l,i*(f-m)+m),_(l,c,0),l},t.multiply_tbn=function(e,t,i){var l=n(t,0),c=r(e,0,x),u=r(t,0,O),d=o(e,0),f=o(t,0);return a(i,y.multiply(c,u,x),0),s(i,d+f-g),_(i,l,0),i},t.multiply_tbn_inv=function(e,t,i){var l=n(t,0),c=r(e,0,x),u=r(t,0,O),d=o(e),f=o(t),m=y.invert(u,O);return a(i,y.multiply(c,m,x),0),s(i,d-f+g),_(i,l,0),i}}),h=o("__util",function(e,t){function r(e){return e>0?1:e<0?-1:0}function a(e,t,r){var a=e[0],n=e[1],_=e[2],s=Math.cos(a/2),o=Math.cos(n/2),i=Math.cos(_/2),l=Math.sin(a/2),c=Math.sin(n/2),u=Math.sin(_/2);if(Ce.indexOf(t)>-1)var d=Math.cos((a+_)/2),f=Math.sin((a+_)/2),m=Math.cos((a-_)/2),p=Math.sin((a-_)/2),h=Math.cos((_-a)/2),v=Math.sin((_-a)/2);switch(t){case we:r[0]=o*f,r[1]=c*m,r[2]=c*p,r[3]=o*d;break;case Ae:r[0]=c*p,r[1]=o*f,r[2]=c*m,r[3]=o*d;break;case Te:r[0]=c*m,r[1]=c*p,r[2]=o*f,r[3]=o*d;break;case xe:r[0]=o*f,r[1]=c*v,r[2]=c*h,r[3]=o*d;break;case Oe:r[0]=c*h,r[1]=o*f,r[2]=c*v,r[3]=o*d;break;case Re:r[0]=c*v,r[1]=c*h,r[2]=o*f,r[3]=o*d;break;case ke:r[0]=l*o*i+s*c*u,r[1]=s*c*i-l*o*u,r[2]=s*o*u+l*c*i,r[3]=s*o*i-l*c*u;break;case Ne:r[0]=s*o*u+l*c*i,r[1]=l*o*i+s*c*u,r[2]=s*c*i-l*o*u,r[3]=s*o*i-l*c*u;break;case Me:r[0]=s*c*i-l*o*u,r[1]=s*o*u+l*c*i,r[2]=l*o*i+s*c*u,r[3]=s*o*i-l*c*u;break;case Ie:r[0]=l*o*i-s*c*u,r[1]=s*o*u-l*c*i,r[2]=s*c*i+l*o*u,r[3]=s*o*i+l*c*u;break;case Se:r[0]=s*c*i+l*o*u,r[1]=l*o*i-s*c*u,r[2]=s*o*u-l*c*i,r[3]=s*o*i+l*c*u;break;case Le:r[0]=s*o*u-l*c*i,r[1]=s*c*i+l*o*u,r[2]=l*o*i-s*c*u,r[3]=s*o*i+l*c*u}return r}function n(e,t,r){var a=e[0],n=e[1],_=e[2],s=e[3];switch(t){case we:r[0]=Math.atan2(a*n+_*s,n*s-a*_),r[1]=Math.acos(1-2*(n*n+_*_)),r[2]=Math.atan2(a*n-_*s,a*_+n*s);break;case Ae:r[0]=Math.atan2(a*s+n*_,_*s-a*n),r[1]=Math.acos(1-2*(a*a+_*_)),r[2]=Math.atan2(n*_-a*s,a*n+_*s);break;case Te:r[0]=Math.atan2(a*_+n*s,a*s-n*_),r[1]=Math.acos(1-2*(a*a+n*n)),r[2]=Math.atan2(a*_-n*s,a*s+n*_);break;case xe:r[0]=Math.atan2(a*_-n*s,a*n+_*s),r[1]=Math.acos(1-2*(n*n+_*_)),r[2]=Math.atan2(a*_+n*s,_*s-a*n);break;case Oe:r[0]=Math.atan2(a*n-_*s,a*s+n*_),r[1]=Math.acos(1-2*(a*a+_*_)),r[2]=Math.atan2(a*n+_*s,a*s-n*_);break;case Re:r[0]=Math.atan2(n*_-a*s,a*_+n*s),r[1]=Math.acos(1-2*(a*a+n*n)),r[2]=Math.atan2(a*s+n*_,n*s-a*_);break;case ke:r[0]=Math.atan2(2*(a*s-n*_),1-2*(a*a+n*n)),r[1]=Math.asin(2*(a*_+n*s)),r[2]=Math.atan2(2*(_*s-a*n),1-2*(n*n+_*_));break;case Ne:(o=a*n+_*s)>.499999?(r[0]=0,r[1]=Math.PI/2,r[2]=2*Math.atan2(a,s)):o<-.499999?(r[0]=0,r[1]=-Math.PI/2,r[2]=-2*Math.atan2(a,s)):(r[0]=Math.atan2(2*(n*s-a*_),1-2*(n*n+_*_)),r[1]=Math.asin(2*(a*n+_*s)),r[2]=Math.atan2(2*(a*s-n*_),1-2*(a*a+_*_)));break;case Me:r[0]=Math.atan2(2*(_*s-a*n),1-2*(a*a+_*_)),r[1]=Math.asin(2*(a*s+n*_)),r[2]=Math.atan2(2*(n*s-a*_),1-2*(a*a+n*n));break;case Ie:r[0]=Math.atan2(2*(a*s+n*_),1-2*(a*a+_*_)),r[1]=Math.asin(2*(_*s-a*n)),r[2]=Math.atan2(2*(a*_+n*s),1-2*(n*n+_*_));break;case Se:r[0]=Math.atan2(2*(a*_+n*s),1-2*(a*a+n*n)),r[1]=Math.asin(2*(a*s-n*_)),r[2]=Math.atan2(2*(a*n+_*s),1-2*(a*a+_*_));break;case Le:var o=n*s-a*_;o>.499999?(r[0]=0,r[1]=Math.PI/2,r[2]=-2*Math.atan2(_,s)):o<-.499999?(r[0]=0,r[1]=-Math.PI/2,r[2]=2*Math.atan2(_,s)):(r[0]=Math.atan2(2*(a*n+_*s),1-2*(n*n+_*_)),r[1]=Math.asin(2*(n*s-a*_)),r[2]=Math.atan2(2*(a*s+n*_),1-2*(a*a+n*n)))}return r}function _(e,t){var r=Math.cos(e[0]),a=Math.cos(e[1]),n=Math.cos(e[2]),_=Math.sin(e[0]),s=Math.sin(e[1]),o=Math.sin(e[2]),i=r*n,l=r*o,c=_*n,u=_*o;return t[0]=a*n,t[1]=a*o,t[2]=-s,t[3]=s*c-l,t[4]=s*u+i,t[5]=a*_,t[6]=s*i+u,t[7]=s*l-c,t[8]=a*r,t}function s(e,t,r){return r||(r=new Float32Array(3)),Y.transformQuat(t,e,r),r}function o(e,t){t||(t=new Float32Array(4)),D.fromMat4(e,ae);var r=ae[0],a=ae[3],n=ae[6],_=ae[1],s=ae[4],o=ae[7],i=ae[2],l=ae[5],c=ae[8],u=Math.sqrt(r*r+a*a+n*n)||1,d=Math.sqrt(_*_+s*s+o*o)||1,f=Math.sqrt(i*i+l*l+c*c)||1;return ae[0]/=u,ae[3]/=u,ae[6]/=u,ae[1]/=d,ae[4]/=d,ae[7]/=d,ae[2]/=f,ae[5]/=f,ae[8]/=f,z.fromMat3(ae,t),z.normalize(t,t),t}function h(e){var t=e[0],r=e[1],a=e[2],n=e[3],_=Math.sqrt(t*t+r*r+a*a);_=1/_,e[0]=t*_,e[1]=r*_,e[2]=a*_,e[3]=n*_}function b(e,t){var r=t;switch(typeof e){case"object":if(e)switch(e.constructor){case Object:for(var a in e)r=b(e[a],r);break;case Int8Array:case Uint8Array:case Uint8ClampedArray:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:for(n=0;n<e.length;n++)r=g(e[n],r);break;case Array:for(var n=0;n<e.length;n++)r=b(e[n],r);break;case WebGLUniformLocation:case WebGLProgram:case WebGLShader:case WebGLFramebuffer:case WebGLRenderbuffer:case WebGLTexture:case WebGLBuffer:r=g(0,r);break;default:R("Wrong object constructor:",e.constructor)}else r=g(0,r);return r;case"number":return g(e,r);case"boolean":return g(0|e,r);case"string":return y(e,r);case"function":case"undefined":return g(0,r)}}function g(e,t){var r=t;return ce[0]=e,r=(r<<5)-r+ue[0],r&=r,r=(r<<5)-r+ue[1],r&=r}function y(e,t){for(var r=t,a=0;a<e.length;a++)r=(r<<5)-r+e.charCodeAt(a),r&=r;return r}function E(e){return(e*=34*e+1)%289}function w(e){return e-Math.floor(e)}function A(e){return T((34*e+5)*e)}function T(e){return e-289*Math.floor(e/289)}function x(e){return e-7*Math.floor(e/7)}function O(e,t,r){return e<t&&(e=t),e>r&&(e=r),e}function R(e){throw e&&B.error.apply(B,arguments),"engine panic:\nThe engine tried to perform an invalid operation and halted.\nPlease copy the console contents above and submit it to the Blend4Web forum at\nhttps://www.blend4web.com/en/forums/forum/17/"}function k(e,t,r){var a=e-t,n=r-t;return t+(a-Math.floor(a/n)*n)}function N(e){return k(e,0,2*Math.PI)}function M(e,t){if(e&&t){var r=e instanceof Array;if(r!=t instanceof Array)return!1;var a=e.buffer instanceof ArrayBuffer&&"undefined"!==e.byteLength;if(a!=(t.buffer instanceof ArrayBuffer&&"undefined"!==t.byteLength))return!1;if(r){if(e.length!=t.length)return!1;for(n=0;n<e.length;n++)if(!I(e[n],t[n]))return!1}else if(a){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1}else{switch(e.constructor){case WebGLUniformLocation:case WebGLProgram:case WebGLShader:case WebGLFramebuffer:case WebGLRenderbuffer:case WebGLTexture:case WebGLBuffer:return e==t}for(var _ in e)if(!I(e[_],t[_]))return!1;for(var _ in t)if(!(_ in e))return!1}return!0}return!(e||t)}function I(e,t){if(typeof e!=typeof t)return!1;switch(typeof e){case"number":case"string":case"boolean":return e==t;case"object":return M(e,t);default:return!0}}function S(e,t,r){var a=V,n=Y.dot(e,t);return n<-.9999999?(Y.cross(he,e,a),Y.length(a)<1e-6&&Y.cross(ve,e,a),Y.normalize(a,a),z.setAxisAngle(a,Math.PI,r)):(Y.cross(e,t,a),r.set(a),r[3]=1+n,z.normalize(r,r)),r}function L(e){if(""==e)return".";var t=0==e.indexOf("/")|0;t&&0==e.indexOf("//")&&0!=e.indexOf("///")&&(t=2);for(var r=e.split("/"),a=[],n=0;n<r.length;n++){var _=r[n];""!=_&&"."!=_&&(".."!=_||!t&&!a.length||a.length&&".."==a[a.length-1]?a.push(_):a.length&&a.pop())}for(e=(r=a).join("/"),n=0;n<t;n++)e="/"+e;return e||"."}function C(e,t,r){var a=Math.sqrt(e[0]*e[0]+e[1]*e[1]);a>1e-6?(t[0]=Math.atan2(e[5],e[8]),t[1]=Math.atan2(-e[2],a),t[2]=Math.atan2(e[1],e[0]),r[0]=Math.atan2(-e[5],-e[8]),r[1]=Math.atan2(-e[2],-a),r[2]=Math.atan2(-e[1],-e[0])):(t[0]=Math.atan2(-e[7],e[4]),t[1]=Math.atan2(-e[2],a),t[2]=0,Y.copy(t,r))}function P(e,t){var r=V,a=X;C(e,r,a);var n=Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2])>Math.abs(a[0])+Math.abs(a[1])+Math.abs(a[2])?a:r;return Y.copy(n,t),t}var D=u(e),U=i(e),F=f(e),B=m(e),G=p(e),j=v(e),z=d(e),Y=l(e),H=c(e),W=0,q={},V=new Float32Array(3),X=new Float32Array(3),K=new Float32Array(3),Z=new Float32Array(3),Q=new Float32Array(3),J=new Float32Array(3),$=new Float32Array(3),ee=new Float32Array(3),te=new Float32Array(4),re=new Float32Array(4),ae=new Float32Array(9),ne=new Float32Array(9),_e=new Float32Array(9),se=new Float32Array(16),oe=new Float32Array(16),ie=z.create(),le=z.create(),ce=new Float64Array(1),ue=new Uint32Array(ce.buffer),de=new Float32Array([0,0,0]),fe=new Float32Array([0,0,0,1]),me=new Float32Array([0,0,0,1,0,0,0,1]),pe=new Float32Array([1,1,1]),he=new Float32Array([1,0,0]),ve=new Float32Array([0,1,0]),be=new Float32Array([0,0,1]),ge=new Float32Array([-1,0,0]),ye=new Float32Array([0,-1,0]),Ee=new Float32Array([0,0,-1]),we=0,Ae=1,Te=2,xe=3,Oe=4,Re=5,ke=6,Ne=7,Me=8,Ie=9,Se=10,Le=11,Ce=[we,Ae,Te,Oe,Re],Pe=Math.floor(2147483647/48271),De=[new Float32Array([0,0,-1,0,0,-1,0,0,-1,0,0,0,0,0,0,1]),new Float32Array([0,0,1,0,0,-1,0,0,1,0,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1]),new Float32Array([-1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1])];t.VEC3_IDENT=de,t.QUAT4_IDENT=fe,t.TSR8_IDENT=me,t.VEC3_UNIT=pe,t.AXIS_X=he,t.AXIS_Y=ve,t.AXIS_Z=be,t.AXIS_MX=ge,t.AXIS_MY=ye,t.AXIS_MZ=Ee,t.XYX=we,t.YZY=Ae,t.ZXZ=Te,t.XZX=xe,t.YXY=Oe,t.ZYZ=Re,t.XYZ=ke,t.YZX=Ne,t.ZXY=Me,t.XZY=Ie,t.YXZ=Se,t.ZYX=Le,t.INV_CUBE_VIEW_MATRS=De,t.BYTE_SIZE=1,t.SHORT_SIZE=2,t.FLOAT_SIZE=4,t.INT_SIZE=4,t.isdef=function(e){return void 0!==e},t.keyfind=function(e,t,r){for(var a=[],n=r.length,_=0;_<n;_++){var s=r[_];s[e]==t&&a.push(s)}return a},t.f32=function(e){return new Float32Array(e)},t.float32_concat=function(e,t){var r=e.length,a=new Float32Array(r+t.length);return a.set(e),a.set(t,r),a},t.uint32_concat=function(e,t){var r=e.length,a=new Uint32Array(r+t.length);return a.set(e),a.set(t,r),a},t.check_endians=function(){var e=new Uint16Array([255]);return 255==new DataView(e.buffer).getUint16(0,!0)},t.array_intersect=function(e,t){var r,a,n=[],_={},s=t.length;for(r=0;r<s;r++)_[t[r]]=!0;for(s=e.length,r=0;r<s;r++)(a=e[r])in _&&n.push(a);return n},t.sign=r,t.keycheck=function(e,t,r){for(var a=r.length,n=0;n<a;n++)if(r[n][e]==t)return!0;return!1},t.keysearch=function(e,t,r){for(var a=0;a<r.length;a++){var n=r[a];if(n[e]===t)return n}return null},t.key2search=function(e,t,r,a,n){for(var _=0;_<n.length;_++){var s=n[_];if(s[e]==t&&s[r]==a)return s}return null},t.get_index_for_key_value=function(e,t,r){for(var a=0;a<e.length;a++)if(e[a][t]==r)return a;return-1},t.append_unique=function(e,t){for(var r=0;r<e.length;r++)if(e[r]==t)return;e.push(t)},t.check_uniqueness=function(e){for(var t=0;t<e.length-1;t++)for(var r=e[t],a=t+1;a<e.length;a++)if(r==e[a])return!1;return!0},t.trans_matrix=function(e,t,r,a){return a||(a=new Float32Array(16)),U.identity(a),a[12]=e,a[13]=t,a[14]=r,a};var Ue=1;t.rand=function(){return Ue=(69069*Ue+5)%Math.pow(2,32),Math.round(Ue/65536)%32768/32767},t.srand=function(e){Ue=e},t.rand_r=function(e){var t=Math.floor(e[0]/Pe),r=e[0]%Pe*48271-3399*t;return e[0]=r>0?r:r+2147483647,(e[0]-1)/2147483646},t.init_rand_r_seed=function(e,t){return t||(t=[]),t[0]=5e4+Math.floor(e),t},t.euler_to_quat=function(e,t){var r=V;return r[0]=e[2],r[1]=e[1],r[2]=e[0],a(r,Le,t),t},t.ordered_angles_to_quat=a,t.quat_to_ordered_angles=n,t.euler_to_rotation_matrix=_,t.quat_to_euler=function(e,t){var r=n(e,Le,V);return t[0]=r[2],t[1]=r[1],t[2]=r[0],t},t.quat_to_dir=s,t.dir_to_quat=function(e,t,r){r||(r=new Float32Array(4)),e=Y.normalize(e,V);var a=Y.dot(t,e),n=Y.cross(t,e,X),_=Math.acos(a);return r[0]=n[0]*Math.sin(_/2),r[1]=n[1]*Math.sin(_/2),r[2]=n[2]*Math.sin(_/2),r[3]=Math.cos(_/2),r},t.trans_quat_to_plane=function(e,t,r,a){return a||(a=new Float32Array(4)),Y.transformQuat(r,t,a),a[3]=-Y.dot(e,a),a},t.dir_ground_proj_angle=function(e){var t=e.render,r=j.get_quat_view(t.world_tsr),a=V,n=X;switch(e.type){case"CAMERA":a[0]=0,a[1]=-1,a[2]=0,Y.transformQuat(a,r,a),n[0]=0,n[1]=0,n[2]=-1;break;case"MESH":a[0]=0,a[1]=0,a[2]=1,Y.transformQuat(a,r,a),n[0]=0,n[1]=0,n[2]=1;break;case"EMPTY":a[0]=0,a[1]=1,a[2]=0,Y.transformQuat(a,r,a),n[0]=0,n[1]=1,n[2]=0}a[1]=0,Y.normalize(a,a);var _=Y.dot(a,n),s=-a[0]*n[2]>0?-1:1;return Math.acos(_)*s},t.blend_arrays=function(e,t,r,a){if(0==r)return e;a=a||[];for(var n=0;n<e.length;n++)a[n]=(1-r)*e[n]+r*t[n];return a},t.unique_id=function(){return(++W).toString(10)},t.unique_name=function(e){q[e]||(q[e]=0);var t=e+q[e];return q[e]++,t},t.create_empty_va_frame=function(){return{a_position:new Float32Array(0),a_tbn:G.create(0)}},t.clone_object_r=function(e){if(!(e instanceof Object))return e;var r,a=e.constructor;switch(a){case Int8Array:case Uint8Array:case Uint8ClampedArray:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:r=new a(e);break;case Array:r=new a(e.length);for(var n=0;n<e.length;n++)r[n]=t.clone_object_r(e[n]);break;default:r=new a;for(var _ in e)e.hasOwnProperty(_)&&(r[_]=t.clone_object_r(e[_]))}return r},t.clone_object_nr=function(e){var t=e instanceof Array?[]:{};for(var r in e)if(e.hasOwnProperty(r))if(e[r]instanceof Object){var a=e[r].constructor;switch(a){case Int8Array:case Uint8Array:case Uint8ClampedArray:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:t[r]=new a(e[r]);break;case Array:t[r]=e[r].slice(0);break;default:t[r]=e[r]}}else t[r]=e[r];return t},t.matrix_to_quat=o,t.matrix_to_trans=function(e,t){return t||(t=new Float32Array(3)),t[0]=e[12],t[1]=e[13],t[2]=e[14],t},t.matrix_to_scale=function(e){return te[0]=.577350269189626,te[1]=.577350269189626,te[2]=.577350269189626,te[3]=0,H.transformMat4(te,e,te),H.length(te)},t.extract_frustum_planes=function(e,t){var r=t.left,a=t.right,n=t.top,_=t.bottom,s=t.near,o=t.far;return r[0]=e[3]+e[0],r[1]=e[7]+e[4],r[2]=e[11]+e[8],r[3]=e[15]+e[12],a[0]=e[3]-e[0],a[1]=e[7]-e[4],a[2]=e[11]-e[8],a[3]=e[15]-e[12],n[0]=e[3]-e[1],n[1]=e[7]-e[5],n[2]=e[11]-e[9],n[3]=e[15]-e[13],_[0]=e[3]+e[1],_[1]=e[7]+e[5],_[2]=e[11]+e[9],_[3]=e[15]+e[13],s[0]=e[3]+e[2],s[1]=e[7]+e[6],s[2]=e[11]+e[10],s[3]=e[15]+e[14],o[0]=e[3]-e[2],o[1]=e[7]-e[6],o[2]=e[11]-e[10],o[3]=e[15]-e[14],h(r),h(a),h(n),h(_),h(s),h(o),t},t.sphere_is_out_of_frustum=function(e,t,r){return r<-F.point_plane_dist(e,t.near)||r<-F.point_plane_dist(e,t.left)||r<-F.point_plane_dist(e,t.right)||r<-F.point_plane_dist(e,t.top)||r<-F.point_plane_dist(e,t.bottom)||r<-F.point_plane_dist(e,t.far)},t.ellipsoid_is_out_of_frustum=function(e,t,r,a,n){var _=Y.dot(r,t.far),s=Y.dot(a,t.far),o=Y.dot(n,t.far),i=Math.sqrt(_*_+s*s+o*o);return i<-F.point_plane_dist(e,t.near)||i<-F.point_plane_dist(e,t.far)||(_=Y.dot(r,t.left),s=Y.dot(a,t.left),o=Y.dot(n,t.left),Math.sqrt(_*_+s*s+o*o)<-F.point_plane_dist(e,t.left)||(_=Y.dot(r,t.right),s=Y.dot(a,t.right),o=Y.dot(n,t.right),Math.sqrt(_*_+s*s+o*o)<-F.point_plane_dist(e,t.right)||(_=Y.dot(r,t.top),s=Y.dot(a,t.top),o=Y.dot(n,t.top),Math.sqrt(_*_+s*s+o*o)<-F.point_plane_dist(e,t.top)||(_=Y.dot(r,t.bottom),s=Y.dot(a,t.bottom),o=Y.dot(n,t.bottom),Math.sqrt(_*_+s*s+o*o)<-F.point_plane_dist(e,t.bottom)))))},t.positions_multiply_matrix=function(e,t,r,a){a||(a=0);for(var n=e.length,_=0;_<n;_+=3){var s=e[_],o=e[_+1],i=e[_+2];r[a+_]=t[0]*s+t[4]*o+t[8]*i+t[12],r[a+_+1]=t[1]*s+t[5]*o+t[9]*i+t[13],r[a+_+2]=t[2]*s+t[6]*o+t[10]*i+t[14]}return r},t.vectors_multiply_matrix=function(e,t,r,a){a||(a=0);for(var n=e.length,_=0;_<n;_+=3){var s=e[_],o=e[_+1],i=e[_+2];r[a+_]=t[0]*s+t[4]*o+t[8]*i,r[a+_+1]=t[1]*s+t[5]*o+t[9]*i,r[a+_+2]=t[2]*s+t[6]*o+t[10]*i}return r},t.quats_multiply_quat=function(e,t,r,a){a=a||0;for(var n=e.length,_=ie,s=0;s<n;s+=4){_[0]=e[s],_[1]=e[s+1],_[2]=e[s+2],_[3]=e[s+3];var o=_[3]>0;z.multiply(t,_,_),(o&&_[3]<0||!o&&_[3]>0)&&H.scale(_,-1,_),r[a+s]=_[0],r[a+s+1]=_[1],r[a+s+2]=_[2],r[a+s+3]=_[3]}return r},t.vecdir_multiply_matrix=function(e,t,r){r||(r=new Float32Array(3));var a=te;a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=0,H.transformMat4(a,t,a),r[0]=a[0],r[1]=a[1],r[2]=a[2]},t.flatten=function(e,t){var r=e.length;r||R("flatten(): Wrong or empty array");var a=e[0].length;a||R("flatten(): Wrong or empty subarray"),t||(t=new Float32Array(r*a));for(var n=0;n<r;n++)for(var _=0;_<a;_++)t[n*a+_]=e[n][_];return t},t.vectorize=function(e,t){t||(t=[]);for(var r=0;r<e.length;r+=3){var a=new Float32Array([e[r],e[r+1],e[r+2]]);t[r/3]=a}return t},t.binary_search_max=function(e,r,a,n){if(n<a)return a;var _=a+Math.floor((n-a)/2);return e[_]>r?t.binary_search_max(e,r,a,_-1):e[_]<r?t.binary_search_max(e,r,_+1,n):_},t.cmp_arr=function(e,t){for(var r=0;r<e.length;r++)if(e[r]!=t[r])return!1;return!0},t.cmp_arr_float=function(e,t,r){for(var a=0;a<e.length;a++)if(Math.abs(e[a]-t[a])>r)return!1;return!0},t.scale_mat4=function(e,t,r){r||(r=new Float32Array(16));for(var a=0;a<12;a++)r[a]=e[a]*t;return r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r},t.transform_mat4=function(e,t,r,a,n){n||(n=new Float32Array(16));var _=U.fromRotationTranslation(r,a,se);return U.multiply(_,e,n),n},t.transform_vec3=function(e,t,r,a,n){n||(n=new Float32Array(3));var _=U.fromRotationTranslation(r,a,se);if(1!==t){var s=U.identity(oe),o=Y.set(t,t,t,V);U.scale(s,o,s),U.multiply(_,s,_)}return Y.transformMat4(e,_,n),n},t.transform_vec4=function(e,t,r,a,n){n||(n=new Float32Array(4));var _=U.fromRotationTranslation(r,a,se);return H.transformMat4(e,_,n),n},t.inverse_transform_vec3=function(e,t,r,a,n){n||(n=new Float32Array(3));var _=U.fromRotationTranslation(r,a,se);return U.invert(_,_),Y.transformMat4(e,_,n),n},t.transcale_quat_to_matrix=function(e,t,r){r||(r=new Float32Array(16)),U.fromRotationTranslation(t,e,r);for(var a=e[3],n=0;n<12;n++)r[n]*=a;return r},t.matrix_to_transcale_quat=function(e,r,a){t.matrix_to_trans(e,r),r[3]=t.matrix_to_scale(e),o(e,a)},t.array_stringify=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return JSON.stringify(t)},t.rotate_point_pivot=function(e,t,r,a){a||(a=new Float32Array(3));var n=V;Y.subtract(t,e,n),Y.transformQuat(n,r,n),Y.subtract(t,n,a)},t.generate_cubemap_matrices=function(){var e=V;e[0]=0,e[1]=0,e[2]=0;var t=new Float32Array(16),r=new Float32Array(16),a=new Float32Array(16),n=new Float32Array(16),_=new Float32Array(16),s=new Float32Array(16);return U.lookAt(e,[-1,0,0],[0,-1,0],t),U.scale(t,[-1,1,1],t),U.scale(t,[-1,1,-1],r),U.lookAt(e,[0,-1,0],[0,0,-1],a),U.scale(a,[1,1,-1],a),U.scale(a,[1,-1,-1],n),U.lookAt(e,[0,0,-1],[0,-1,0],_),U.scale(_,[-1,1,1],_),U.scale(_,[-1,1,-1],s),[t,r,a,n,_,s]},t.generate_inv_cubemap_matrices=function(){var e=V;e[0]=0,e[1]=0,e[2]=0;var t=new Float32Array(16),r=new Float32Array(16),a=new Float32Array(16),n=new Float32Array(16),_=new Float32Array(16),s=new Float32Array(16);return U.lookAt(e,[1,0,0],[0,-1,0],t),U.scale(t,[-1,1,-1],r),U.lookAt(e,[0,1,0],[0,0,1],a),U.scale(a,[1,-1,-1],n),U.lookAt(e,[0,0,1],[0,-1,0],_),U.scale(_,[-1,1,-1],s),[t,r,a,n,_,s]},t.calc_variable_id=function(e,t){return b(e,t)},t.hash_code=b,t.hash_code_string=y,t.mat3_to_mat4=function(e,t){return t[15]=1,t[14]=0,t[13]=0,t[12]=0,t[11]=0,t[10]=e[8],t[9]=e[7],t[8]=e[6],t[7]=0,t[6]=e[5],t[5]=e[4],t[4]=e[3],t[3]=0,t[2]=e[2],t[1]=e[1],t[0]=e[0],t},t.quat_to_angle_axis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var a=1/Math.sqrt(r);t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},t.trunc=function(e){return isNaN(e)||void 0===e?NaN:0|e},t.deg_to_rad=function(e){return e*Math.PI/180},t.rad_to_deg=function(e){return 180*e/Math.PI},t.snoise=function(e){var t=.211324865405187,r=.366025403784439,a=-.577350269189626,n=.024390243902439,_=e[0]*r+e[1]*r,s=Math.floor(e[0]+_),o=Math.floor(e[1]+_),i=s*t+o*t,l=e[0]-s+i,c=e[1]-o+i,u=l>c?1:0,d=1-u,f=l+t-u,m=c+t-d,p=l+a,h=c+a;s%=289;var v=E(E(o%=289)+s),b=E(E(o+d)+s+u),g=E(E(o+1)+s+1),y=Math.max(.5-(l*l+c*c),0),A=Math.max(.5-(f*f+m*m),0),T=Math.max(.5-(p*p+h*h),0);y*=y*y*y,A*=A*A*A,T*=T*T*T;var x=2*w(v*n)-1,O=2*w(b*n)-1,R=2*w(g*n)-1,k=Math.abs(x)-.5,N=Math.abs(O)-.5,M=Math.abs(R)-.5,I=x-Math.floor(x+.5),S=O-Math.floor(O+.5),L=R-Math.floor(R+.5);return 130*((y*=1.79284291400159-.85373472095314*(I*I+k*k))*(I*l+k*c)+(A*=1.79284291400159-.85373472095314*(S*S+N*N))*(S*f+N*m)+(T*=1.79284291400159-.85373472095314*(L*L+M*M))*(L*p+M*h))},t.cellular2x2=function(e){var t=1/7,r=t/2,a=T(Math.floor(e[0])),n=T(Math.floor(e[1])),_=w(e[0]),s=w(e[1]),o=_-.5,i=_-1.5,l=o,c=i,u=s-.5,d=u,f=s-1.5,m=f,p=A(a),h=A(a+1),v=p,b=h;p=A(p+n),h=A(h+n),v=A(v+n+1),b=A(b+n+1);var g=o+.7*(x(p)*t+r),y=i+.7*(x(h)*t+r),E=l+.7*(x(v)*t+r),O=c+.7*(x(b)*t+r),R=u+.7*(x(Math.floor(p*t))*t+r),k=d+.7*(x(Math.floor(h*t))*t+r),N=f+.7*(x(Math.floor(v*t))*t+r),M=m+.7*(x(Math.floor(b*t))*t+r),I=g*g+R*R,S=y*y+k*k,L=E*E+N*N,C=O*O+M*M;return Math.min(I,S,L,C)},t.quat_project=function(e,t,r,a,n){n||(n=new Float32Array(4));var _=Y.transformQuat(t,e,V),s=r[0],o=r[1],i=r[2],l=ae;return l[0]=o*o+i*i,l[1]=-o*s,l[2]=-i*s,l[3]=-s*o,l[4]=s*s+i*i,l[5]=-i*o,l[6]=-s*i,l[7]=-o*i,l[8]=s*s+o*o,Y.transformMat3(_,l,_),Y.normalize(_,_),z.rotationTo(a,_,n),n},t.cam_quat_to_mesh_quat=function(e,t){t||(t=new Float32Array(4));var r=te,a=re;return r=z.setAxisAngle([0,0,1],Math.PI,z.create()),a=z.setAxisAngle([1,0,0],Math.PI/2,z.create()),z.multiply(r,a,r),z.multiply(e,r,t),t},t.cleanup=function(){W=0,q={}},t.clamp=O,t.smooth=function(e,t,r,a){if(a){var n=Math.exp(-r/a);return(1-n)*e+n*t}return e},t.smooth_v=function(e,t,r,a,n){if(n||(n=new Float32Array(e.length)),a)for(var _=Math.exp(-r/a),s=0;s<n.length;s++)n[s]=(1-_)*e[s]+_*t[s];else Y.copy(e,n);return n},t.smooth_q=function(e,t,r,a,n){if(n||(n=new Float32Array(e.length)),a){var _=Math.exp(-r/a);z.slerp(e,t,_,n)}else z.copy(e,n);return n},t.is_arr_buf_view=function(e){return!!("object"==typeof e&&e.buffer&&e.buffer instanceof ArrayBuffer)},t.is_vector=function(e,t){return!(!(e instanceof Array||e.buffer&&e.buffer instanceof ArrayBuffer)||(!t||t!=e.length)&&t)},t.correct_cam_quat_up=function(e,t){var r=D.fromQuat(e,ae),a=V;a[0]=r[6],a[1]=r[7],a[2]=r[8];var n=Y.cross(be,a,a);Y.normalize(n,n);var _=r[4];!t&&_>0&&(n[0]*=-1,n[1]*=-1,n[2]*=-1);var s=X;s[0]=r[0],s[1]=r[1],s[2]=r[2],Y.normalize(s,s);var o=re;z.rotationTo(s,n,o),z.multiply(o,e,e)},t.get_array_smooth_value=function(e,t,r,a){var n=r*t-.5,_=a*t-.5,s=n-Math.floor(n),o=_-Math.floor(_);n=Math.floor(n);var i=t-1;return(e[(_=Math.floor(_))*t+n]*(1-s)+e[_*t+Math.min(n+1,i)]*s)*(1-o)+(e[Math.min(_+1,i)*t+n]*(1-s)+e[Math.min(_+1,i)*t+Math.min(n+1,i)]*s)*o},t.rgb_mask_get_channels_count=function(e){for(var t=0,r=0;r<3;r++)(e&1<<r)>0&&t++;return t},t.rgb_mask_get_channels_presence=function(e){for(var t=[0,0,0],r=0;r<3;r++)(e&1<<r)>0&&(t[2-r]=1);return t},t.rgb_mask_get_channel_presence_index=function(e,t){var r=0;return 1!=t&&2!=t||(4&e)>0&&r++,2==t&&(2&e)>0&&r++,r},t.gen_uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},t.get_dict_length=function(e){var t=0;for(var r in e)e.hasOwnProperty(r)&&t++;return t},t.random_from_array=function(e){return e.length?e[Math.floor(Math.random()*e.length)]:null},t.horizontal_direction=function(e,t,r){r||(r=new Float32Array(3)),r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=0,Y.normalize(r,r)},t.transformQuatFast=function(e,t,r){var a=e[0],n=e[1],_=e[2],s=t[0],o=t[1],i=t[2],l=t[3],c=o*_-i*n,u=i*a-s*_,d=s*n-o*a,f=o*d-i*u,m=i*c-s*d,p=s*u-o*c;return c*=2*l,u*=2*l,d*=2*l,f*=2,m*=2,p*=2,r[0]=a+c+f,r[1]=n+u+m,r[2]=_+d+p,r},t.assert=function(e){e||R("Assertion failed")},t.panic=R,t.angle_wrap_periodic=k,t.angle_wrap_0_2pi=N,t.get_file_extension=function(e){return/(?:\.([^.]+))?$/.exec(e)[1]},t.strict_objs_is_equal=function(e,t){for(var r in e){var a=!0,n=e[r],_=t[r];switch(typeof n){case"number":case"string":case"boolean":a=n==_;break;case"object":a=M(n,_)}if(!a)return!1}return!0},t.quat_bpy_b4w=function(e,t){var r=e[0],a=e[1],n=e[2],_=e[3];return t[0]=a,t[1]=n,t[2]=_,t[3]=r,t},t.gen_color_id=function(e){++e>132651&&B.error("Color ID pool depleted");var t=Math.floor(e/2601);e%=2601;var r=Math.floor(e/51),a=e%=51;return new Float32Array([t/51,r/51,a/51])},t.line_plane_intersect=function(e,t,r,a){var n=te;n.set(e),n[3]=t;var _=re;V[0]=r[3],V[1]=r[4],V[2]=r[5],_.set(V),_[3]=0;var s=H.dot(n,_);if(0==s)return null;var o=re;Y.copy(r,V),o.set(V),o[3]=1;var i=-H.dot(n,o)/s;return a[0]=r[0]+i*r[3],a[1]=r[1]+i*r[4],a[2]=r[2]+i*r[5],a},t.get_plane_normal=function(e,t,r,a){var n=t[0]-e[0],_=r[0]-e[0],s=t[1]-e[1],o=r[1]-e[1],i=t[2]-e[2],l=r[2]-e[2];return a[0]=s*l-i*o,a[1]=_*i-n*l,a[2]=n*o-s*_,a},t.copy_array=function(e,t){for(var r=0;r<e.length;r++)t[r]=e[r];return t},t.rotation_to_stable=S,t.calc_returning_angle=function(e,t,r){if(t==r)return r-e;e=N(e),t=N(t),r=N(r);var a=2*Math.PI-t;if(t=0,r+=a,r=N(r),e+=a,(e=N(e))>r){var n=r-e,_=2*Math.PI-e;return-n>_?_:n}return 0},t.smooth_step=function(e,t,r){return isFinite(t)&&isFinite(r)&&(e=O(e,t,r)),e*e*(3-2*e)},t.lerp=function(e,t,r){return t+e*(r-t)},t.arrays_have_common=function(e,t){for(var r=0;r<e.length;r++)for(var a=0;a<t.length;a++)if(t[a]==e[r])return!0;return!1},t.create_zero_array=function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=0;return t},t.version_cmp=function(e,t){for(var a=Math.max(e.length,t.length),n=0;n<a;n++){var _=r((n>=e.length?0:e[n])-(n>=t.length?0:t[n]));if(_)return _}return 0},t.version_to_str=function(e){return e.join(".")},t.str_to_version=function(e){return e.split(".").map(function(e){return 0|e})},t.srgb_to_lin=function(e,t){return t[0]=Math.pow(e[0],2.2),t[1]=Math.pow(e[1],2.2),t[2]=Math.pow(e[2],2.2),t},t.lin_to_srgb=function(e,t){return t[0]=Math.pow(e[0],1/2.2),t[1]=Math.pow(e[1],1/2.2),t[2]=Math.pow(e[2],1/2.2),t},t.normpath_preserve_protocol=function(e){var t=e.split("://",2);return t.length>1?(t[1]=L(t[1]),t.join("://")):L(e)},t.check_npot=function(e){return 0!=parseInt(e.toString(2).substr(1),2)},t.ellipsoid_axes_to_mat3=function(e,t,r,a){return a[0]=e[0],a[1]=t[0],a[2]=r[0],a[3]=e[1],a[4]=t[1],a[5]=r[1],a[6]=e[2],a[7]=t[2],a[8]=r[2],a},t.create_non_smi_array=function(){var e=[{}];return e.length=0,e},t.float_to_short=function(e){var t=Math.round(32767.5*(e+1)-32768);return O(t||0,-32768,32767)},t.short_to_float=function(e){return O((e+32768)/32767.5-1,-1,1)},t.ufloat_to_ubyte=function(e){return O(Math.round(255*e),0,255)},t.ubyte_to_ufloat=function(e){return O(e/255,0,1)},t.dist_to_triange=function(e,t,r,a){var n=Y.subtract(r,t,V),_=Y.subtract(a,r,X),s=Y.subtract(t,a,K),o=Y.subtract(e,t,Z),i=Y.subtract(e,r,Q),l=Y.subtract(e,a,J),c=Y.cross(n,_,$);if(Y.dot(Y.cross(c,n,ee),o)>=0&&Y.dot(Y.cross(c,_,ee),i)>=0&&Y.dot(Y.cross(c,s,ee),l)>=0){var u=Y.length(c),d=Y.dot(c,o);return Math.abs(d/u)}var f=Y.scale(n,O(Y.dot(n,o)/Y.length(n),0,1),ee),m=Y.length(Y.subtract(o,f,ee)),p=Y.scale(_,O(Y.dot(_,i)/Y.length(_),0,1),ee),h=Y.length(Y.subtract(i,p,ee)),v=Y.scale(s,O(Y.dot(s,l)/Y.length(s),0,1),ee),b=Y.length(Y.subtract(l,v,ee));return Math.min(Math.min(m,h),b)},t.rotate_quat=function(e,t,r,a,n){if(r||a){var _=z.identity(ie);if(r){var o=z.setAxisAngle(t,r,le);z.multiply(_,o,_)}var i=z.copy(e,n);if(a){var l=s(i,he,V),c=z.setAxisAngle(l,a,le);z.normalize(c,c),z.multiply(_,c,_)}z.multiply(_,i,i),z.normalize(i,i)}},t.quat_rotate_to_target=function(e,t,r,a){var n=X;s(t,a,n),Y.normalize(n,n);var _=K;Y.subtract(r,e,_),Y.normalize(_,_);var o=S(n,_,te);z.multiply(o,t,t),z.normalize(t,t)},t.quat_set_vertical_axis=function(e,t,r,a){var n=Y.transformQuat(t,e,X),_=Y.dot(a,r),s=Y.scale(a,_,K),o=Y.subtract(r,s,K),i=z.identity(ie);Y.normalize(o,o),Math.abs(Y.dot(n,o))<.999999&&S(n,o,i),z.normalize(i,i),z.multiply(i,e,e)},t.compatible_euler=function(e,t){for(var r=2*Math.PI,a=[],n=0;n<3;n++)a[n]=e[n]-t[n],a[n]>5.1?(e[n]-=a[n]/r*r,a[n]=e[n]-t[n]):a[n]<-5.1&&(e[n]+=-a[n]/r*r,a[n]=e[n]-t[n]);Math.abs(a[0])>3.2&&Math.abs(a[1])<1.6&&Math.abs(a[2])<1.6&&(a[0]>0?e[0]-=r:e[0]+=r),Math.abs(a[1])>3.2&&Math.abs(a[2])<1.6&&Math.abs(a[0])<1.6&&(a[1]>0?e[1]-=r:e[1]+=r),Math.abs(a[2])>3.2&&Math.abs(a[0])<1.6&&Math.abs(a[1])<1.6&&(a[2]>0?e[2]-=r:e[2]+=r)},t.rotate_eul=function(e,t,r){var a=_(t,ae),n=_(e,ne);return P(D.multiply(n,a,_e),r)},t.quat_to_eul_opt=function(e,t,r){var a=D.fromQuat(e,ae),n=V,_=X;C(a,n,_);var s=Math.abs(n[0]-t[0])+Math.abs(n[1]-t[1])+Math.abs(n[2]-t[2])>Math.abs(_[0]-t[0])+Math.abs(_[1]-t[1])+Math.abs(_[2]-t[2])?_:n;return Y.copy(s,r),r}}),v=o("__tsr",function(e,t){function r(){var e=new Float32Array(8);return e[3]=1,e[7]=1,e}function a(){var e=new Float32Array(9);return e[3]=1,e[7]=1,e}function n(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}function _(e,t,r,a){return a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=t,a[4]=r[0],a[5]=r[1],a[6]=r[2],a[7]=r[3],a}function s(e,t){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t}function o(e,t,r){var a=t[0],n=t[1],_=t[2],s=t[3],o=t[4],i=t[5],l=t[6],c=t[7],u=e[0]*s,d=e[1]*s,f=e[2]*s,m=c*u+i*f-l*d,p=c*d+l*u-o*f,h=c*f+o*d-i*u,v=-o*u-i*d-l*f;return r[0]=m*c+v*-o+p*-l-h*-i,r[1]=p*c+v*-i+h*-o-m*-l,r[2]=h*c+v*-l+m*-i-p*-o,r[0]+=a,r[1]+=n,r[2]+=_,r}function c(e,t,r){var a=t[0],n=t[1],_=t[2],s=e[4],o=e[5],i=e[6],l=e[7];r[4]=.5*(a*l+n*i-_*o),r[5]=.5*(n*l+_*s-a*i),r[6]=.5*(_*l+a*o-n*s),r[7]=.5*(-a*s-n*o-_*i)}function u(e,t){var r=e[4],a=e[5],n=e[6],_=e[7],s=r*r+a*a+n*n+_*_;s>0&&(s=1/Math.sqrt(s),t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s)}var f=i(e),m=d(e),p=h(e),v=l(e),b=Math.sin(-Math.PI/4),g=-b,y=new Float32Array(3),E=new Float32Array(4),w=new Float32Array(16);t.create=r,t.clone=function(e){var t=r();return n(e,t),t},t.from_values=function(e,t,a,n,_,s,o,i){var l=r();return l[0]=e,l[1]=t,l[2]=a,l[3]=n,l[4]=_,l[5]=s,l[6]=o,l[7]=i,l},t.create_ext=a,t.clone_ext=function(e){var t=a();return n(e,t),t},t.from_values_ext=function(e,t,r,n,_,s,o,i){var l=a();return l[0]=e,l[1]=t,l[2]=r,l[3]=n,l[4]=_,l[5]=s,l[6]=o,l[7]=i,l},t.copy=n,t.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=1,e},t.set_sep=_,t.set_trans=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},t.set_scale=function(e,t){return t[3]=e,t},t.set_transcale=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},t.set_quat=function(e,t){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},t.get_trans_view=function(e){return e.subarray(0,3)},t.get_trans=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},t.get_scale=function(e){return e[3]},t.get_transcale=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},t.get_quat_view=function(e){return e.subarray(4,8)},t.get_quat=s,t.invert=function(e,t){var r=1/e[3];if(!r)return null;var a=e[0],n=e[1],_=e[2];E[0]=e[4],E[1]=e[5],E[2]=e[6],E[3]=e[7],m.invert(E,E);var s=E[0],o=E[1],i=E[2],l=E[3],c=a*r,u=n*r,d=_*r,f=l*c+o*d-i*u,p=l*u+i*c-s*d,h=l*d+s*u-o*c,v=-s*c-o*u-i*d;return t[0]=-(f*l+v*-s+p*-i-h*-o),t[1]=-(p*l+v*-o+h*-s-f*-i),t[2]=-(h*l+v*-i+f*-o-p*-s),t[3]=r,t[4]=s,t[5]=o,t[6]=i,t[7]=l,t},t.to_mat4=function(e,t){var r=e.subarray(0,3),a=e[3],n=e.subarray(4,8);f.fromRotationTranslation(n,r,t);for(var _=0;_<12;_++)t[_]*=a;return t},t.from_mat4=function(e,t){return _(p.matrix_to_trans(e,y),p.matrix_to_scale(e),p.matrix_to_quat(e,E),t),t},t.multiply=function(e,t,r){o(t,e,r),r[3]=e[3]*t[3];var a=e[4],n=e[5],_=e[6],s=e[7],i=t[4],l=t[5],c=t[6],u=t[7];return r[4]=a*u+s*i+n*c-_*l,r[5]=n*u+s*l+_*i-a*c,r[6]=_*u+s*c+a*l-n*i,r[7]=s*u-a*i-n*l-_*c,r},t.transform_mat4=function(e,t,r){for(var a=t.subarray(0,3),n=t[3],_=t.subarray(4,8),s=f.fromRotationTranslation(_,a,w),o=0;o<12;o++)s[o]*=n;return f.multiply(s,e,r),r},t.transform_vec3=o,t.transform_vec3_inv=function(e,t,r){var a=t[0],n=t[1],_=t[2],s=t[3],o=e[0]-a,i=e[1]-n,l=e[2]-_,c=t[4],u=t[5],d=t[6],f=t[7],m=c*c+u*u+d*d+f*f,p=m?1/m:0,h=(f*=p)*o+(u=-u*p)*l-(d=-d*p)*i,v=f*i+d*o-(c=-c*p)*l,b=f*l+c*i-u*o,g=-c*o-u*i-d*l;return r[0]=h*f+g*-c+v*-d-b*-u,r[1]=v*f+g*-u+b*-c-h*-d,r[2]=b*f+g*-d+h*-u-v*-c,r[0]/=s,r[1]/=s,r[2]/=s,r},t.transform_vectors=function(e,t,r,a){a||(a=0);for(var n=e.length,_=t[0],s=t[1],o=t[2],i=t[3],l=t[4],c=t[5],u=t[6],d=t[7],f=0;f<n;f+=3){var m=e[f]*i,p=e[f+1]*i,h=e[f+2]*i,v=d*m+c*h-u*p,b=d*p+u*m-l*h,g=d*h+l*p-c*m,y=-l*m-c*p-u*h;r[a+f]=v*d+y*-l+b*-u-g*-c,r[a+f+1]=b*d+y*-c+g*-l-v*-u,r[a+f+2]=g*d+y*-u+v*-c-b*-l,r[a+f]+=_,r[a+f+1]+=s,r[a+f+2]+=o}return r},t.transform_dir_vectors=function(e,t,r,a){a||(a=0);for(var n=e.length,_=t[3],s=t[4],o=t[5],i=t[6],l=t[7],c=0;c<n;c+=3){var u=e[c]*_,d=e[c+1]*_,f=e[c+2]*_,m=l*u+o*f-i*d,p=l*d+i*u-s*f,h=l*f+s*d-o*u,v=-s*u-o*d-i*f;r[a+c]=m*l+v*-s+p*-i-h*-o,r[a+c+1]=p*l+v*-o+h*-s-m*-i,r[a+c+2]=h*l+v*-i+m*-o-p*-s}return r},t.transform_dir_vec3=function(e,t,r){var a=t[3],n=t[4],_=t[5],s=t[6],o=t[7],i=e[0]*a,l=e[1]*a,c=e[2]*a,u=o*i+_*c-s*l,d=o*l+s*i-n*c,f=o*c+n*l-_*i,m=-n*i-_*l-s*c;return r[0]=u*o+m*-n+d*-s-f*-_,r[1]=d*o+m*-_+f*-n-u*-s,r[2]=f*o+m*-s+u*-_-d*-n,r},t.transform_tangents=function(e,t,r,a){a||(a=0);for(var n=e.length,_=t[3],s=t[4],o=t[5],i=t[6],l=t[7],c=0;c<n;c+=4){var u=e[c]*_,d=e[c+1]*_,f=e[c+2]*_,m=l*u+o*f-i*d,p=l*d+i*u-s*f,h=l*f+s*d-o*u,v=-s*u-o*d-i*f;r[a+c]=m*l+v*-s+p*-i-h*-o,r[a+c+1]=p*l+v*-o+h*-s-m*-i,r[a+c+2]=h*l+v*-i+m*-o-p*-s,r[a+c+3]=e[c+3]}return r},t.transform_quat=function(e,t,r){var a=s(t,E);return m.multiply(a,e,r),r},t.transform_quats=function(e,t,r,a){a=a||0;var n=s(t,E);return p.quats_multiply_quat(e,n,r,a),r},t.translate=function(e,t,r){var a=e[3],n=e[4],_=e[5],s=e[6],o=e[7],i=t[0]*a,l=t[1]*a,c=t[2]*a,u=o*i+_*c-s*l,d=o*l+s*i-n*c,f=o*c+n*l-_*i,m=-n*i-_*l-s*c;return r[0]=e[0]+u*o+m*-n+d*-s-f*-_,r[1]=e[1]+d*o+m*-_+f*-n-u*-s,r[2]=e[2]+f*o+m*-s+u*-_-d*-n,r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r},t.interpolate=function(e,t,r,a){var n=e.subarray(0,3),_=t.subarray(0,3),s=a.subarray(0,3);v.lerp(n,_,r,s);var o=e[3],i=t[3];a[3]=o+r*(i-o);var l=e.subarray(4,8),c=t.subarray(4,8),u=a.subarray(4,8);return m.slerp(l,c,r,u),a},t.extrapolate=function(e,t,r,a){var n=e.subarray(0,3),_=t.subarray(0,3),s=a.subarray(0,3);s[0]=_[0]*(r+1)-n[0]*r,s[1]=_[1]*(r+1)-n[1]*r,s[2]=_[2]*(r+1)-n[2]*r;var o=e[3],i=t[3];a[3]=i*(r+1)-o*r;var l=e.subarray(4,8),c=t.subarray(4,8),u=a.subarray(4,8);return u[0]=c[0]*(r+1)-l[0]*r,u[1]=c[1]*(r+1)-l[1]*r,u[2]=c[2]*(r+1)-l[2]*r,u[3]=c[3]*(r+1)-l[3]*r,m.normalize(u,u),a},t.integrate=function(e,t,r,a,n){n[0]=e[0]+t*r[0],n[1]=e[1]+t*r[1],n[2]=e[2]+t*r[2],n[3]=e[3],c(e,a,n),n[4]=e[4]+n[4]*t,n[5]=e[5]+n[5]*t,n[6]=e[6]+n[6]*t,n[7]=e[7]+n[7]*t,u(n,n)},t.to_zup_view=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3];var r=e[4],a=e[5],n=e[6],_=e[7],s=b,o=g;t[4]=r*o+_*s,t[5]=a*o+n*s,t[6]=n*o-a*s,t[7]=_*o-r*s},t.to_zup_model=function(e,t){t[0]=e[0],t[1]=-e[2],t[2]=e[1],t[3]=e[3],t[4]=e[4],t[5]=-e[6],t[6]=e[5],t[7]=e[7]}}),b=o("__boundings",function(e,t){function r(){return{max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0}}function a(e,t){return t.min_x=e.min_x,t.max_x=e.max_x,t.min_y=e.min_y,t.max_y=e.max_y,t.min_z=e.min_z,t.max_z=e.max_z,t}function n(){return{center:new Float32Array(3),axis_x:new Float32Array(3),axis_y:new Float32Array(3),axis_z:new Float32Array(3)}}function _(e,t){var r=e.max_x,a=e.max_y,n=e.max_z,_=e.min_x,s=e.min_y,o=e.min_z;return e.max_x=Math.max(t.max_x,r),e.max_y=Math.max(t.max_y,a),e.max_z=Math.max(t.max_z,n),e.min_x=Math.min(t.min_x,_),e.min_y=Math.min(t.min_y,s),e.min_z=Math.min(t.min_z,o),e}function s(e,t,r,a){for(var n=e[t],_=e[t+1],s=e[t+2],o=e[t],i=e[t+1],l=e[t+2],c=t+3;c<r;c+=3){var u=e[c],d=e[c+1],f=e[c+2];n=Math.max(n,u),_=Math.max(_,d),s=Math.max(s,f),o=Math.min(o,u),i=Math.min(i,d),l=Math.min(l,f)}return a.max_x=n,a.max_y=_,a.max_z=s,a.min_x=o,a.min_y=i,a.min_z=l,a}function o(e,t){t||(t=new Float32Array(24));var r=e.max_x,a=e.max_y,n=e.max_z,_=e.min_x,s=e.min_y,o=e.min_z;return t[0]=_,t[1]=s,t[2]=o,t[3]=r,t[4]=s,t[5]=o,t[6]=r,t[7]=a,t[8]=o,t[9]=_,t[10]=a,t[11]=o,t[12]=_,t[13]=s,t[14]=n,t[15]=r,t[16]=s,t[17]=n,t[18]=r,t[19]=a,t[20]=n,t[21]=_,t[22]=a,t[23]=n,t}function i(){return{center:new Float32Array(3),radius:0}}function c(e,t){return t.center[0]=e.center[0],t.center[1]=e.center[1],t.center[2]=e.center[2],t.radius=e.radius,t}function d(){return{axis_x:new Float32Array(3),axis_y:new Float32Array(3),axis_z:new Float32Array(3),center:new Float32Array(3)}}function m(e,t){return k.copy(e.axis_x,t.axis_x),k.copy(e.axis_y,t.axis_y),k.copy(e.axis_z,t.axis_z),k.copy(e.center,t.center),t}function p(e,t,r,a){return{axis_x:new Float32Array(e),axis_y:new Float32Array(t),axis_z:new Float32Array(r),center:new Float32Array([a[0],a[1],a[2]])}}function b(e,t){var r=N.calk_average_position(e,P);if(t)a=N.calc_covariance_matrix(e,r,U);else var a=M.identity(U);var n=N.find_eigenvectors(a,G,D);k.copy(e,S),k.transformMat3(S,n,S);for(var _=S[0],s=_,o=S[1],i=o,l=S[2],c=l,u=0,d=0,f=0,m=0,h=0,v=0,b=3;b<e.length;b+=3){S[0]=e[b],S[1]=e[b+1],S[2]=e[b+2],k.transformMat3(S,n,S);var g=S[0],y=S[1],E=S[2];g>_&&(_=g),g<s&&(s=g),y>o&&(o=y),y<i&&(i=y),E>l&&(l=E),E<c&&(c=E)}var w=_-s,A=o-i,T=l-c;w=Math.max(w,B),A=Math.max(A,B),T=Math.max(T,B);var x=M.identity(U);for(x[0]=0!=w?1/w:1/j,x[4]=0!=A?1/A:1/j,x[8]=0!=T?1/T:1/j,M.transpose(n,F),S[0]=e[0],S[1]=e[1],S[2]=e[2],k.transformMat3(S,n,S),k.transformMat3(S,x,S),k.transformMat3(S,F,S),u=S[0],d=S[0],f=S[1],m=S[1],h=S[2],v=S[2],b=3;b<e.length;b+=3)S[0]=e[b],S[1]=e[b+1],S[2]=e[b+2],k.transformMat3(S,n,S),k.transformMat3(S,x,S),k.transformMat3(S,F,S),u=Math.max(u,S[0]),d=Math.min(d,S[0]),f=Math.max(f,S[1]),m=Math.min(m,S[1]),h=Math.max(h,S[2]),v=Math.min(v,S[2]);var O=Math.sqrt((u-d)*(u-d)+(f-m)*(f-m)+(h-v)*(h-v))/2;O=Math.min(O,1),C[0]=(u+d)/2,C[1]=(f+m)/2,C[2]=(h+v)/2;var R=C;(x=M.identity(U))[0]=w,x[4]=A,x[8]=T,k.transformMat3(R,n,R),k.transformMat3(R,x,R),k.transformMat3(R,F,R);var I=[n[0],n[3],n[6]],L=[n[1],n[4],n[7]],z=[n[2],n[5],n[8]];return k.scale(I,w*O,I),k.scale(L,A*O,L),k.scale(z,T*O,z),p(I,L,z,R)}function g(e,t){for(var r=k.normalize(t,k.create()),a=e[0],n=e[0],_=1;_<e.length;_++){var s=k.dot(e[_],r);s<k.dot(a,r)&&(a=e[_]),s>k.dot(n,r)&&(n=e[_])}return[a,n]}function y(){return{radius:0,height:0,center:new Float32Array(3)}}function E(e,t){t=T(t,e[0],e[1]);for(var r=2;r<e.length;r++)k.distance(t.center,e[r])>t.radius&&(t=w(t,e,e[r],r-1));return t}function w(e,t,r,a){e=T(e,r,t[0]);for(var n=1;n<=a;n++)k.distance(e.center,t[n])>e.radius&&(e=A(e,t,r,t[n],n-1));return e}function A(e,t,r,a,n){e=T(e,r,a);for(var _=0;_<=n;_++)k.distance(e.center,t[_])>e.radius&&(e=x(e,r,a,t[_]));return e}function T(e,t,r){return k.add(t,r,e.center),k.scale(e.center,.5,e.center),e.radius=k.distance(e.center,t),e}function x(e,t,r,a){var n=k.subtract(r,a,C),_=k.squaredLength(n),s=k.subtract(t,a,C),o=k.squaredLength(s),i=k.subtract(t,r,C),l=k.squaredLength(i),c=_*(o+l-_),u=o*(l+_-o),d=l*(_+o-l),f=c+u+d;return k.copy(t,e.center),k.scale(e.center,c/f,e.center),k.scaleAndAdd(e.center,r,u/f,e.center),k.scaleAndAdd(e.center,a,d/f,e.center),e.radius=k.distance(e.center,t),e}var O=v(e),R=h(e),k=l(e),N=f(e),M=u(e),I=new Float32Array(24),S=new Float32Array(3),L=new Float32Array(3),C=new Float32Array(3),P=new Float32Array(3),D=new Float32Array(9),U=new Float32Array(9),F=new Float32Array(9),B=.001,G=5e-4,j=B/2;t.init_boundings=function(){return{bb:{max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0},be:d(),bs:i()}},t.copy_boundings=function(e,t){return a(e.bb,t.bb),m(e.be,t.be),c(e.bs,t.bs),t},t.create_bb=r,t.copy_bb=a,t.create_rot_bb=n,t.copy_rot_bb=function(e,t){return k.copy(e.center,t.center),k.copy(e.axis_x,t.axis_x),k.copy(e.axis_y,t.axis_y),k.copy(e.axis_z,t.axis_z),t},t.big_bounding_box=function(){return{max_x:1e12,min_x:-1e12,max_y:1e12,min_y:-1e12,max_z:1e12,min_z:-1e12}},t.zero_bounding_box=function(e){return e.max_x=0,e.min_x=0,e.max_y=0,e.min_y=0,e.max_z=0,e.min_z=0,e},t.clone_bb=function(e){var t={max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0};return a(e,t),t},t.calc_min_bb_side=function(e){var t=e.max_x-e.min_x,r=e.max_y-e.min_y;r<t&&(t=r);var a=e.max_z-e.min_z;return a<t&&(t=a),t},t.expand_bounding_box=_,t.bb_from_coords=s,t.bounding_box_transform=function(e,t,r){r||(r={max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0});var a=o(e,I);return O.transform_vectors(a,t,a),s(a,0,a.length,r)},t.extract_bb_corners=o,t.shrink_bounding_box=function(e,t,r){r||(r={max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0});var a=t.min_x,n=t.max_x,_=t.min_y,s=t.max_y,o=t.min_z,i=t.max_z;return a>=e.max_x||n<=e.min_x||_>=e.max_y||s<=e.min_y||o>=e.max_z||i<=e.min_z?(r.min_x=-.1,r.max_x=.1,r.min_y=-.1,r.max_y=.1,r.min_z=-.2,r.max_z=-.1,r):(r.min_x=Math.max(e.min_x,a),r.max_x=Math.min(e.max_x,n),r.min_y=Math.max(e.min_y,_),r.max_y=Math.min(e.max_y,s),r.min_z=Math.max(e.min_z,o),r.max_z=Math.min(e.max_z,i),r)},t.stretch_bounding_box=function(e,t,r){r||(r={max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0});var a=e.max_x-e.min_x,n=e.max_y-e.min_y,_=e.max_z-e.min_z;return r.min_x=e.min_x-.5*(t-1)*a,r.max_x=e.max_x+.5*(t-1)*a,r.min_y=e.min_y-.5*(t-1)*n,r.max_y=e.max_y+.5*(t-1)*n,r.min_z=e.min_z-.5*(t-1)*_,r.max_z=e.max_z+.5*(t-1)*_,r},t.bounding_sphere_transform=function(e,t,r){r||(r=i()),O.transform_vec3(e.center,t,r.center);var a=O.get_scale(t);return r.radius=e.radius*(a<0?-a:a),r},t.bounding_ellipsoid_transform=function(e,t,r){return r||(r=d()),O.transform_vec3(e.center,t,r.center),k.copy(e.axis_x,r.axis_x),k.copy(e.axis_y,r.axis_y),k.copy(e.axis_z,r.axis_z),O.transform_dir_vec3(r.axis_x,t,r.axis_x),O.transform_dir_vec3(r.axis_y,t,r.axis_y),O.transform_dir_vec3(r.axis_z,t,r.axis_z),r},t.bounding_rot_box_transform=function(e,t,r){return r||(r=n()),O.transform_vec3(e.center,t,r.center),k.copy(e.axis_x,r.axis_x),k.copy(e.axis_y,r.axis_y),k.copy(e.axis_z,r.axis_z),O.transform_dir_vec3(r.axis_x,t,r.axis_x),O.transform_dir_vec3(r.axis_y,t,r.axis_y),O.transform_dir_vec3(r.axis_z,t,r.axis_z),r},t.bs_from_values=function(e,t){var r=i();return k.copy(t,r.center),r.radius=e,r},t.rot_bb_from_values=function(e,t,r,a,_){var s=n();return k.copy(e,s.center),k.copy(t,s.axis_x),k.copy(r,s.axis_y),k.copy(a,s.axis_z),k.scale(s.axis_x,_[0],s.axis_x),k.scale(s.axis_y,_[1],s.axis_y),k.scale(s.axis_z,_[2],s.axis_z),s},t.create_bs=i,t.copy_bs=c,t.create_be=d,t.copy_be=m,t.clone_be=function(e){var t=d();return m(e,t),t},t.clone_bs=function(e){var t=i();return c(e,t),t},t.be_from_values=p,t.big_bounding_sphere=function(e){return e||(e=i()),k.set(0,0,0,e.center),e.radius=1e12,e},t.expand_bounding_sphere=function(e,t){var r=k.subtract(t.center,e.center,k.create());0==k.length(r)&&k.set(1,0,0,r);var a=k.normalize(r,k.create()),n=k.scale(a,e.radius,k.create());k.add(n,e.center,n);var _=k.scale(a,-e.radius,k.create());k.add(_,e.center,_);var s=k.scale(a,t.radius,k.create());k.add(s,t.center,s);var o=k.scale(a,-t.radius,k.create());k.add(o,t.center,o);var i=g([n,_,s,o],a),l=i[0],c=i[1];e.center=k.scale(k.add(l,c,k.create()),.5,k.create()),e.radius=k.length(k.subtract(c,l,k.create()))/2},t.extract_rot_bb_corners=function(e,t){k.add(e.center,e.axis_y,S),k.add(S,e.axis_x,S),k.add(S,e.axis_z,S),t.push(S[0],S[1],S[2]),k.add(e.center,e.axis_y,S),k.add(S,e.axis_x,S),k.subtract(S,e.axis_z,S),t.push(S[0],S[1],S[2]),k.add(e.center,e.axis_y,S),k.subtract(S,e.axis_x,S),k.add(S,e.axis_z,S),t.push(S[0],S[1],S[2]),k.add(e.center,e.axis_y,S),k.subtract(S,e.axis_x,S),k.subtract(S,e.axis_z,S),t.push(S[0],S[1],S[2]),k.subtract(e.center,e.axis_y,S),k.add(S,e.axis_x,S),k.add(S,e.axis_z,S),t.push(S[0],S[1],S[2]),k.subtract(e.center,e.axis_y,S),k.add(S,e.axis_x,S),k.subtract(S,e.axis_z,S),t.push(S[0],S[1],S[2]),k.subtract(e.center,e.axis_y,S),k.subtract(S,e.axis_x,S),k.add(S,e.axis_z,S),t.push(S[0],S[1],S[2]),k.subtract(e.center,e.axis_y,S),k.subtract(S,e.axis_x,S),k.subtract(S,e.axis_z,S),t.push(S[0],S[1],S[2])},t.create_be_by_bb=b,t.create_bbr_by_be=function(e){var t=n();return k.copy(e.axis_x,t.axis_x),k.copy(e.axis_y,t.axis_y),k.copy(e.axis_z,t.axis_z),k.copy(e.center,t.center),t},t.create_bs_by_be=function(e){var t=i(),r=0,a=k.length(e.axis_x),n=k.length(e.axis_y),_=k.length(e.axis_z);return r=a>n?a:n,r=_>r?_:r,t.center=e.center,t.radius=r,t},t.is_be_optimized=function(e,t){var r=k.length(e.axis_x)*k.length(e.axis_y)*k.length(e.axis_z);return t.radius*t.radius*t.radius*.75>r},t.init_bcap=t.init_bcyl=t.init_bcon=y,t.bcap_from_values=function(e,t){var r=t.max_z,a=t.min_z,n=Math.max(0,r-a-2*e),_=y();return _.radius=e,_.height=n,_.center[0]=0,_.center[1]=0,_.center[2]=(r+a)/2,_},t.bcyl_from_values=function(e,t){var r=t.max_z,a=t.min_z,n=Math.max(0,r-a),_=y();return _.radius=e,_.height=n,_.center[0]=0,_.center[1]=0,_.center[2]=(r+a)/2,_},t.bcon_from_values=function(e,t){var r=t.max_z,a=t.min_z,n=Math.max(0,r-a),_=y();return _.radius=e,_.height=n,_.center[0]=0,_.center[1]=0,_.center[2]=(r+a)/2,_},t.copy_bcap=t.copy_bcyl=t.copy_bcon=function(e,t){return t.radius=e.radius,t.height=e.height,t.center.set(e.center),t},t.check_bb_intersection=function(e,t){return!(e.min_x>t.max_x||e.max_x<t.min_x||e.min_y>t.max_y||e.max_y<t.min_y||e.min_z>t.max_z||e.max_z<t.min_z)},t.recalculate_mesh_boundings=function(e){for(var t=0,r=0,n={max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0},i=0;i<e.submeshes.length;i++){for(var l=e.submeshes[i],c=l.position,u=0;u<c.length/3;u++){var d=c[3*u],f=c[3*u+1],m=c[3*u+2];t=Math.max(Math.sqrt(d*d+f*f+m*m),t),r=Math.max(Math.sqrt(d*d+f*f),r)}var p=l.boundings.bb,h=s(c,0,c.length,{max_x:0,min_x:0,max_y:0,min_y:0,max_z:0,min_z:0});p.max_x=h.max_x,p.min_x=h.min_x,p.max_y=h.max_y,p.min_y=h.min_y,p.max_z=h.max_z,p.min_z=h.min_z,E=b(y=o(h,I),!1),l.boundings.be_cen=E.center,l.boundings.be_ax=[E.axis_x[0],E.axis_y[1],E.axis_z[2]],0==i?a(h,n):_(n,h)}var v=e.b4w_boundings.bb;v.max_x=n.max_x,v.min_x=n.min_x,v.max_y=n.max_y,v.min_y=n.min_y,v.max_z=n.max_z,v.min_z=n.min_z;var g=e.b4w_boundings.bb_src;g.max_x=n.max_x,g.min_x=n.min_x,g.max_y=n.max_y,g.min_y=n.min_y,g.max_z=n.max_z,g.min_z=n.min_z,e.b4w_boundings.bs_rad=t,e.b4w_boundings.bc_rad=r;var y=o(n,I),E=b(y,!1);e.b4w_boundings.be_cen=E.center,e.b4w_boundings.be_ax=[E.axis_x[0],E.axis_y[1],E.axis_z[2]]},t.get_frustum_mec=function(e){var t=e.subarray(0,3),r=e.subarray(6,9),a=e.subarray(12,15),n=e.subarray(18,21),_=k.subtract(r,t,S);k.normalize(_,_);var s=R.get_plane_normal(t,r,a,L),o=k.cross(s,_,s);k.normalize(o,o);var l=k.create(),c=k.create();k.subtract(r,t,C),c[0]=k.dot(C,_),c[1]=k.dot(C,o);var u=k.create();k.subtract(a,t,C),u[0]=k.dot(C,_),u[1]=k.dot(C,o);var d=k.create();k.subtract(n,t,C),d[0]=k.dot(C,_),d[1]=k.dot(C,o);var f=i();f=E([l,c,u,d],f);var m=k.scale(_,f.center[0],C);return k.scaleAndAdd(m,o,f.center[1],m),k.add(m,t,f.center),f}}),g=o("__config",function(e,t){function r(){return b4w.module_check(t.paths.built_in_data_module)}function a(){return t.physics.use_wasm&&window.WebAssembly}function n(){for(var e=t.paths,r=null,a=document.getElementsByTagName("script"),n=0;n<a.length;n++){for(var s=a[n].src,o=0;o<e.js_src_search_paths.length;o++){var i=e.js_src_search_paths[o];if(s.indexOf(i)>=0){r=s;break}}if(null!==r)break}r||(_.warn("Couldn't determine path to ancillary resources, fallback to the current page directory"),r=document.location.href);var l=r.indexOf("?");return l>=0&&(r=r.substring(0,l)),r.substring(0,r.lastIndexOf("/"))}var _=m(e),s=h(e);t.P_LOW=1,t.P_HIGH=2,t.P_ULTRA=3,t.P_CUSTOM=4,t.P_AUTO=5,t.context={alpha:!0,antialias:!1,premultipliedAlpha:!0},t.context_save=s.clone_object_r(t.context),t.defaults={alpha_sort:!0,alpha_sort_threshold:.1,min_format_version:[6,3],max_fps:1e4,console_verbose:!1,do_not_load_resources:!1,use_min50:!1,enable_texture_cache:!0,fps_measurement_interval:1,fps_callback_interval:5,background_color:[0,0,0,0],canvas_resolution_factor:1,texture_min_filter:3,allow_cors:!1,force_low_quality_nodes:!1,anisotropic_available:!0,anisotropic_filtering:!0,texture_lod_available:!1,show_hud_debug_info:!1,depth_tex_available:!0,shadows:!0,stereo:"NONE",reflections:!0,refractions:!0,ssao:!0,dof:!0,god_rays:!0,bloom:!0,motion_blur:!0,compositing:!0,antialiasing:!0,smaa:!1,debug_view:!1,water_wireframe_debug:!1,foam:!0,parallax:!0,dynamic_grass:!0,water_dynamic:!0,shore_smoothing:!0,shore_distance:!0,use_compression:!0,precision:"highp",quality:t.P_HIGH,allow_vertex_textures:!0,lod_leap_smooth_threshold:3,assets_gzip_available:!1,no_phy_interp_hack:!1,shader_constants_hack:!1,disable_blend_shadows_hack:!1,vert_anim_mix_normals_hack:!1,is_mobile_device:!1,init_wa_context_hack:!1,clear_procedural_sky_hack:!1,sky_update_hack:!1,seq_video_fallback:!1,allow_hidpi:!1,shadows_color_slink_hack:!1,mobile_firefox_media_hack:!1,ipad_video_hack:!1,enable_selectable:!0,enable_outlining:!0,lod_smooth_transitions:!0,glow_materials:!0,ie11_edge_touchscreen_hack:!1,firefox_tex_reuse_hack:!1,loaded_data_version:[0,0],quality_aa_method:!0,skinning_hack:!1,url_params:null,webgl2:!0,msaa_samples:4,compared_mode_depth:!1,safari_canvas_alpha_hack:!1,safari_glow_hack:!1,resize_cubemap_canvas_hack:!1,resize_texture_canvas_hack:!1,chrome_html_bkg_music_hack:!1,ie_edge_anchors_floor_hack:!1,ie11_edge_mouseoffset_hack:!1,media_auto_activation:!0,max_cast_lamps:4,mac_os_shadow_hack:!1,gl_debug:!1,check_framebuffer_hack:!1,allow_instanced_arrays_ext:!1,allow_vao_ext:!1,compress_format:"dds",shadow_blur_samples:"",reflection_quality:"",srgb_type:"SRGB_SIMPLE",ios_copy_tex_hack:!1,rgba_fallback_shadows:!1,debug_loading:!1,mali_alpha_antialias_hack:!1,mali4_lamps_hack:!1,chrome_csm_blend_hack:!1,reuse_depth_optimization:!0},t.defaults_save=s.clone_object_r(t.defaults),t.animation={framerate:-1,frames_blending_hack:!1,frame_steps:1},t.controls={mouse_wheel_notch_multiplier:1/120},t.assets={path:"",path_default:"B4W_ASSETS_PATH=__JS__/../deploy/assets/",proj_path_default:"B4W_PROJ_ASSETS_PATH=__JS__/../projects/__NAME__/assets/",max_requests:15,prevent_caching:!0,min50_available:!1,dds_available:!1,pvr_available:!1},t.assets_save=s.clone_object_r(t.assets),t.paths={shaders_path:"",shaders_path_default:"../shaders/",shaders_include_dir:"include/",shaders_postp_dir:"postprocessing/",built_in_data_module:"built_in_data",js_src_search_paths:["b4w.min.js","b4w.full.min.js","b4w.simple.min.js","b4w.whitespace.min.js","src/b4w.js","B4W_MAIN_MODULE"],smaa_search_texture_path:"smaa_search_texture.png",smaa_area_texture_path:"smaa_area_texture.png"},t.hmd_params={webvr:{distortion_coefs:[.22,.28],chromatic_aberration_coefs:[-.015,.02,.025,.02]},nonwebvr:{distor_scale:.8,inter_lens_dist:.064,base_line_dist:.035,screen_to_lens_dist:.039,distortion_coefs:[.34,.55],chromatic_aberration_coefs:[0,0,0,0],width_dist:.11,height_dist:.062,bevel_size:.004}},t.physics={enabled:!0,max_fps:60,uranium_path:"",uranium_bin:"",uranium_path_default:"B4W_URANIUM_PATH=../deploy/apps/common/",asmjs_file:"uranium.js",wasmjs_file:"uranium_wasm.js",mem_file:"uranium.js.mem",wasm_file:"uranium_wasm.wasm",uranium_dir:"../deploy/apps/common/",calc_fps:!1,ping:!1,use_workers:!0,use_wasm:!0},t.physics_save=s.clone_object_r(t.physics),t.scenes={grass_tex_size:1024,cubemap_tex_size:256,cube_reflect_low:32,cube_reflect_medium:128,cube_reflect_high:256,plane_reflect_low:.25,plane_reflect_medium:.5,plane_reflect_high:1},t.scenes_save=s.clone_object_r(t.scenes),t.sfx={webaudio:!0,mix_mode:!1,audio_loading_hack:!1,clamp_playback_rate_hack:!1,disable_playback_rate_hack:!1},t.sfx_save=s.clone_object_r(t.sfx),t.outlining={outlining_overview_mode:!1,outline_color:[1,.4,.05],outline_duration:.2,outline_period:3.8,outline_relapses:1},t.debug_subs={enabled:!1,subs_type:39,subs_number:0,slink_type:"COLOR"},t.debug_subs_save=s.clone_object_r(t.debug_subs),t.context_limits={max_combined_texture_image_units:8,max_fragment_uniform_vectors:64,max_texture_image_units:8,max_varying_vectors:8,max_vertex_attribs:15,max_vertex_texture_image_units:0,max_vertex_uniform_vectors:128,max_cube_map_texture_size:1024,max_renderbuffer_size:4096,max_texture_size:4096,max_viewport_dims:[4096,4096],depth_bits:24},t.context_limits_save=s.clone_object_r(t.context_limits),t.apply_quality=function(){var e=t.defaults,r=t.physics,a=t.scenes;switch(e.quality){case t.P_ULTRA:e.shadows=!0,e.shore_smoothing=!0,e.ssao=!0,e.dof=!0,e.god_rays=!0,e.bloom=!0,e.reflections=!0,e.refractions=!0,e.foam=!0,e.parallax=!0,e.dynamic_grass=!0,a.grass_tex_size=2048,a.cubemap_tex_size=512,e.texture_min_filter=3,e.anisotropic_filtering=!0,e.use_min50=!1,e.water_dynamic=!0,e.shore_distance=!0,e.antialiasing=!0,e.smaa=!1,e.compositing=!0,e.motion_blur=!0,e.allow_hidpi=!0,e.enable_outlining=!0,e.glow_materials=!0,e.msaa_samples=16,e.srgb_type="SRGB_PROPER",r.max_fps=120,e.lod_smooth_transitions=!0;break;case t.P_HIGH:e.shadows=!0,e.shore_smoothing=!0,e.ssao=!0,e.dof=!0,e.god_rays=!0,e.bloom=!0,e.reflections=!0,e.refractions=!0,e.foam=!0,e.parallax=!0,e.dynamic_grass=!0,a.grass_tex_size=1024,a.cubemap_tex_size=256,e.texture_min_filter=3,e.anisotropic_filtering=!0,e.use_min50=!1,e.water_dynamic=!0,e.shore_distance=!0,e.antialiasing=!0,e.smaa=!1,e.compositing=!0,e.motion_blur=!0,e.allow_hidpi=!1,e.enable_outlining=!0,e.glow_materials=!0,e.srgb_type="SRGB_SIMPLE",e.msaa_samples=4,r.max_fps=60,e.lod_smooth_transitions=!0;break;case t.P_LOW:e.shadows=!1,e.shore_smoothing=!1,e.ssao=!1,e.dof=!1,e.god_rays=!1,e.bloom=!1,e.reflections=!1,e.refractions=!1,e.foam=!1,e.parallax=!1,e.dynamic_grass=!1,a.grass_tex_size=512,a.cubemap_tex_size=256,e.texture_min_filter=2,e.anisotropic_filtering=!1,e.use_min50=!0,e.water_dynamic=!1,e.shore_distance=!1,e.antialiasing=!1,e.smaa=!1,e.compositing=!1,e.motion_blur=!1,e.allow_hidpi=!1,e.enable_outlining=!1,e.glow_materials=!1,e.srgb_type="SRGB_SIMPLE",e.msaa_samples=1,r.max_fps=60,e.lod_smooth_transitions=!1;break;case t.P_CUSTOM:break;case t.P_AUTO:s.panic("Direct AUTO quality profile setting is forbidden")}},t.set=function(e,r){switch(e){case"allow_cors":t.defaults.allow_cors=r;break;case"allow_hidpi":t.defaults.allow_hidpi=r;break;case"alpha":t.context.alpha=r;break;case"alpha_sort":t.defaults.alpha_sort=r;break;case"alpha_sort_threshold":t.defaults.alpha_sort_threshold=r;break;case"anaglyph_use":_.error_deprecated_cfg("anaglyph_use","stereo"),t.defaults.stereo=r?"ANAGLYPH":t.defaults.stereo;break;case"animation_framerate":t.animation.framerate=r;break;case"anisotropic_filtering":t.defaults.anisotropic_filtering=r;break;case"antialiasing":t.defaults.antialiasing=r;break;case"assets_dir":case"assets_path":t.assets.path=r;break;case"assets_dds_available":t.assets.dds_available=r;break;case"assets_pvr_available":t.assets.pvr_available=r;break;case"assets_min50_available":t.assets.min50_available=r;break;case"audio":t.sfx.webaudio=r;break;case"background_color":t.defaults.background_color=r;break;case"bloom":t.defaults.bloom=r;break;case"built_in_module_name":t.paths.built_in_data_module=r;break;case"canvas_resolution_factor":t.defaults.canvas_resolution_factor=r;break;case"console_verbose":t.defaults.console_verbose=r;break;case"compositing":t.defaults.compositing=r;break;case"dof":t.defaults.dof=r;break;case"do_not_load_resources":t.defaults.do_not_load_resources=r;break;case"god_rays":t.defaults.god_rays=r;break;case"stereo":t.defaults.stereo=r;break;case"lod_leap_smooth_threshold":t.defaults.lod_leap_smooth_threshold=r;break;case"lod_smooth_transitions":t.defaults.lod_smooth_transitions=r;break;case"max_fps":t.defaults.max_fps=r;break;case"max_fps_physics":t.physics.max_fps=r;break;case"media_auto_activation":t.defaults.media_auto_activation=r;break;case"motion_blur":t.defaults.motion_blur=r;break;case"physics_enabled":t.physics.enabled=r;break;case"physics_uranium_path":a()?(t.physics.uranium_path=r+t.physics.wasmjs_file,t.physics.uranium_bin=r+t.physics.wasm_file):(t.physics.uranium_path=r+t.physics.asmjs_file,t.physics.uranium_bin=r+t.physics.mem_file),t.physics.uranium_dir=r;break;case"physics_use_wasm":t.physics.use_wasm=r;break;case"physics_calc_fps":t.physics.calc_fps=r;break;case"physics_use_workers":t.physics.use_workers=r;break;case"precision":t.defaults.precision=r;break;case"prevent_caching":t.assets.prevent_caching=r;break;case"quality":t.defaults.quality=r;break;case"reflections":t.defaults.reflections=r;break;case"refractions":t.defaults.refractions=r;break;case"sfx_mix_mode":t.sfx.mix_mode=r;break;case"shaders_dir":case"shaders_path":t.paths.shaders_path=r;break;case"shadows":t.defaults.shadows=r;break;case"show_hud_debug_info":t.defaults.show_hud_debug_info=r;break;case"smaa":_.error_deprecated_cfg("smaa"),t.defaults.smaa=r;break;case"smaa_search_texture_path":_.error_deprecated_cfg("smaa_search_texture_path"),t.paths.smaa_search_texture_path=r;break;case"smaa_area_texture_path":_.error_deprecated_cfg("smaa_area_texture_path"),t.paths.smaa_area_texture_path=r;break;case"ssao":t.defaults.ssao=r;break;case"debug_view":t.defaults.debug_view=r;break;case"enable_selectable":t.defaults.enable_selectable=r;break;case"enable_outlining":t.defaults.enable_outlining=r;break;case"outlining_overview_mode":t.outlining.outlining_overview_mode=r;break;case"glow_materials":t.defaults.glow_materials=r;break;case"url_params":t.defaults.url_params=r;break;case"use_min50":t.defaults.use_min50=r;break;case"enable_texture_cache":t.defaults.enable_texture_cache=r;break;case"gl_debug":t.defaults.gl_debug=r;break;case"srgb_type":t.defaults.srgb_type=r;break;case"shadow_blur_samples":t.defaults.shadow_blur_samples=r;break;case"reflection_quality":t.defaults.reflection_quality=r;break;case"assets_gzip_available":t.defaults.assets_gzip_available=r;break;case"debug_loading":t.defaults.debug_loading=r;break;case"msaa_samples":t.defaults.msaa_samples=r;break;default:_.error("Unknown config property: "+e)}},t.get=function(e){switch(e){case"allow_cors":return t.defaults.allow_cors;case"allow_hidpi":return t.defaults.allow_hidpi;case"alpha":return t.context.alpha;case"alpha_sort":return t.defaults.alpha_sort;case"alpha_sort_threshold":return t.defaults.alpha_sort_threshold;case"anaglyph_use":return"ANAGLYPH"==t.defaults.stereo;case"animation_framerate":return t.animation.framerate;case"anisotropic_filtering":return t.defaults.anisotropic_filtering;case"antialiasing":return t.defaults.antialiasing;case"assets_dir":case"assets_path":return t.assets.path;case"assets_dds_available":return t.assets.dds_available;case"assets_pvr_available":return t.assets.pvr_available;case"assets_min50_available":return t.assets.min50_available;case"audio":return t.sfx.webaudio;case"background_color":return t.defaults.background_color;case"bloom":return t.defaults.bloom;case"built_in_module_name":return t.paths.built_in_data_module;case"canvas_resolution_factor":return t.defaults.canvas_resolution_factor;case"console_verbose":return t.defaults.console_verbose;case"compositing":return t.defaults.compositing;case"dof":return t.defaults.dof;case"do_not_load_resources":return t.defaults.do_not_load_resources;case"is_mobile_device":return t.defaults.is_mobile_device;case"god_rays":return t.defaults.god_rays;case"stereo":return t.defaults.stereo;case"lod_leap_smooth_threshold":return t.defaults.lod_leap_smooth_threshold;case"lod_smooth_transitions":return t.defaults.lod_smooth_transitions;case"max_fps":return t.defaults.max_fps;case"max_fps_physics":return t.physics.max_fps;case"media_auto_activation":return t.defaults.media_auto_activation;case"motion_blur":return t.defaults.motion_blur;case"physics_enabled":return t.physics.enabled;case"physics_uranium_path":return t.physics.uranium_dir;case"physics_uranium_bin":return t.physics.uranium_bin;case"physics_use_wasm":return t.physics.use_wasm;case"physics_calc_fps":return t.physics.calc_fps;case"physics_use_workers":return t.physics.use_workers;case"precision":return t.defaults.precision;case"prevent_caching":return t.assets.prevent_caching;case"quality":return t.defaults.quality;case"reflections":return t.defaults.reflections;case"refractions":return t.defaults.refractions;case"sfx_mix_mode":return t.sfx.mix_mode;case"shaders_dir":case"shaders_path":return t.paths.shaders_path;case"shadows":return t.defaults.shadows;case"show_hud_debug_info":return t.defaults.show_hud_debug_info;case"smaa":return t.defaults.smaa;case"smaa_search_texture_path":return t.paths.smaa_search_texture_path;case"smaa_area_texture_path":return t.paths.smaa_area_texture_path;case"ssao":return t.defaults.ssao;case"debug_view":return t.defaults.debug_view;case"enable_selectable":return t.defaults.enable_selectable;case"enable_outlining":return t.defaults.enable_outlining;case"outlining_overview_mode":return t.outlining.outlining_overview_mode;case"glow_materials":return t.defaults.glow_materials;case"url_params":return t.defaults.url_params;case"use_min50":return t.defaults.use_min50;case"enable_texture_cache":return t.defaults.enable_texture_cache;case"gl_debug":return t.defaults.gl_debug;case"srgb_type":return t.defaults.srgb_type;case"shadow_blur_samples":return t.defaults.shadow_blur_samples;case"reflection_quality":return t.defaults.reflection_quality;case"assets_gzip_available":return t.defaults.assets_gzip_available;case"debug_loading":return t.defaults.debug_loading;case"msaa_samples":return t.defaults.msaa_samples;default:_.error("Unknown config property: "+e)}},t.reset=function(){for(var e in t.context_save)t.context[e]=t.context_save[e];for(var e in t.defaults_save)t.defaults[e]=t.defaults_save[e];for(var e in t.assets_save)t.assets[e]=t.assets_save[e];for(var e in t.physics_save)t.physics[e]=t.physics_save[e];for(var e in t.scenes_save)t.scenes[e]=t.scenes_save[e];for(var e in t.sfx_save)t.sfx[e]=t.sfx_save[e];for(var e in t.debug_subs_save)t.debug_subs[e]=t.debug_subs_save[e]},t.reset_limits=function(){var e=t.context_limits.depth_bits;for(var r in t.context_limits_save)t.context_limits[r]=t.context_limits_save[r];t.context_limits.depth_bits=e},t.is_built_in_data=r,t.set_paths=function(){var e=t.paths,_=t.physics;if(r()||""!=e.shaders_path||(e.shaders_path=n()+"/"+e.shaders_path_default),a())var s=_.uranium_path_default+_.wasmjs_file,o=_.uranium_path_default+_.wasm_file;else var s=_.uranium_path_default+_.asmjs_file,o=_.uranium_path_default+_.mem_file;_.enabled&&""==_.uranium_path&&(_.uranium_path=n()+"/"+s.replace("B4W_URANIUM_PATH=",""),_.uranium_bin=n()+"/"+o.replace("B4W_URANIUM_PATH=",""))},t.get_assets_path=function(e){console.log(this);var r=t.assets;if(r.path)return r.path;var a=r.path_default,_="B4W_ASSETS_PATH=";return e&&(_="B4W_PROJ_ASSETS_PATH=",a=(a=r.proj_path_default).replace("__NAME__",e)),a=a.replace(_,""),a=a.replace("__JS__",n())}}),y=o("__extensions",function(e,t){function r(e){if(e in i)return i[e];var t=o.getExtension(e)||null;if(i[e]=t,t)r="0a0";else var r="a00";return _.log("%cGET EXTENSION","color: #"+r,e),t}function a(e){if(e in i)return i[e];switch(e){case"WEBGL_depth_texture":case"OES_element_index_uint":case"OES_standard_derivatives":case"EXT_shader_texture_lod":t={};break;case"ANGLE_instanced_arrays":case"OES_vertex_array_object":t=o;break;default:var t=o.getExtension(e)||null}if(i[e]=t,t)r="0a0";else var r="a00";return _.log("%cGET EXTENSION (WebGL 2)","color: #"+r,e),t}var n=g(e),_=m(e),s=n.defaults,o=null,i={};t.setup_context=function(e){o=e},t.get_s3tc=function(){return r("WEBGL_compressed_texture_s3tc")||r("WEBKIT_WEBGL_compressed_texture_s3tc")},t.get_pvr=function(){return r("WEBKIT_WEBGL_compressed_texture_pvrtc")||r("WEBGL_compressed_texture_pvrtc")},t.get_depth_texture=function(){return s.webgl2?a("WEBGL_depth_texture"):r("WEBGL_depth_texture")||r("WEBKIT_WEBGL_depth_texture")},t.get_aniso=function(){return r("EXT_texture_filter_anisotropic")||r("WEBKIT_EXT_texture_filter_anisotropic")},t.get_texture_lod=function(){return s.webgl2?a("EXT_shader_texture_lod"):r("EXT_shader_texture_lod")},t.get_debug_shaders=function(){return r("WEBGL_debug_shaders")},t.get_renderer_info=function(){return r("WEBGL_debug_renderer_info")},t.get_elem_index_uint=function(){return s.webgl2?a("OES_element_index_uint"):r("OES_element_index_uint")},t.get_standard_derivatives=function(){return s.webgl2?a("OES_standard_derivatives"):r("OES_standard_derivatives")},t.get_disjoint_timer_query=function(){if(s.webgl2)e=a("EXT_disjoint_timer_query_webgl2");else var e=r("EXT_disjoint_timer_query");if(null==e)return e;if(e.createQueryEXT)t={createQuery:function(){return e.createQueryEXT()},beginQuery:function(t){e.beginQueryEXT(e.TIME_ELAPSED_EXT,t)},endQuery:function(){e.endQueryEXT(e.TIME_ELAPSED_EXT)},getQueryAvailable:function(t){return e.getQueryObjectEXT(t,e.QUERY_RESULT_AVAILABLE_EXT)},getQueryObject:function(t){return e.getQueryObjectEXT(t,e.QUERY_RESULT_EXT)},getDisjoint:function(){return e.GPU_DISJOINT_EXT}};else var t={createQuery:function(){return o.createQuery()},beginQuery:function(t){o.beginQuery(e.TIME_ELAPSED_EXT,t)},endQuery:function(){o.endQuery(e.TIME_ELAPSED_EXT)},getQueryAvailable:function(e){return o.getQueryParameter(e,o.QUERY_RESULT_AVAILABLE)},getQueryObject:function(e){return o.getQueryParameter(e,o.QUERY_RESULT)},getDisjoint:function(){return e.GPU_DISJOINT_EXT}};return t},t.get_instanced_arrays=function(){if(s.webgl2)return a("ANGLE_instanced_arrays");var e=r("ANGLE_instanced_arrays");return null==e?e:{drawElementsInstanced:function(t,r,a,n,_){e.drawElementsInstancedANGLE(t,r,a,n,_)},vertexAttribDivisor:function(t,r){e.vertexAttribDivisorANGLE(t,r)},drawArraysInstanced:function(t,r,a,n){e.drawArraysInstancedANGLE(t,r,a,n)}}},t.get_vertex_array_object=function(){if(s.webgl2)return a("OES_vertex_array_object");var e=r("OES_vertex_array_object");return null==e?e:{bindVertexArray:function(t){e.bindVertexArrayOES(t)},createVertexArray:function(){return e.createVertexArrayOES()},deleteVertexArray:function(t){e.deleteVertexArrayOES(t)},isVertexArray:function(t){return e.isVertexArrayOES(t)}}},t.cleanup=function(){i={}},t.reset=function(){o=null}}),E=o("__graph",function(e,t){function r(e,t,r){r||(r=null),a(e,t)?F.panic("Graph already has node with given ID"):e.nodes.push(t,r)}function a(e,t){for(var r=e.nodes,a=0;a<r.length;a+=2)if(r[a]==t)return!0;return!1}function n(e,t,r,n){n||(n=null),a(e,t)&&a(e,r)?e.edges.push(t,r,n):F.panic("Wrong node IDs")}function _(e,t){a(e,t)||F.panic("Node not found");for(var r=e.nodes,n=0;n<r.length;n+=2)r[n]==t&&(r.splice(n,2),n-=2)}function s(e,t,r,a){I(e,t,r)||F.panic("Edge not found");for(var n=e.edges,_=0,s=0;s<n.length;s+=3)if(n[s]==t&&n[s+1]==r){if(-1==a)n.splice(s,3);else{if(a==_){n.splice(s,3);break}_++}s-=3}}function o(e){for(var t=e.nodes,r=-1,a=0;a<t.length;a+=2)r=Math.max(r,t[a]);return++r}function i(e,t){for(var r=e.nodes,a=0;a<r.length;a+=2)if(r[a+1]==t)return r[a];return B}function l(e){var t=[],r={};c(e,r);for(var a=e.nodes,n=0;n<a.length;n+=2)0==k(e,a[n])&&u(e,a[n],r,t);return{nodes:t,edges:e.edges.slice(0)}}function c(e,t){for(var r=e.nodes,a=0;a<r.length;a+=2)t[r[a]]=!1}function u(e,t,r,a){if(!r[t]){r[t]=!0;for(var n=0;n<R(e,t);n++)u(e,N(e,t,n),r,a);a.unshift(t,O(e,t))}}function d(e,t,r,a){if(!r[t]){if(r[t]=!0,a==j||a==Y)for(n=0;n<R(e,t);n++)d(e,_=N(e,t,n),r,a);if(a==z||a==Y)for(var n=0;n<k(e,t);n++){var _=M(e,t,n);d(e,_,r,a)}}}function f(e){for(var t=e.edges,r=0;r<t.length;r+=3){var n=t[r],_=t[r+1];a(e,n)&&a(e,_)||(t.splice(r,3),r-=3)}}function m(e){for(var t=[],r=e.nodes,a=0;a<r.length;a+=2){var n=r[a];R(e,n)||t.push(n)}return t}function p(e){return e.nodes.length/2}function v(e){for(var t=e.nodes,r=e.edges,a=[],n=[],_=[],s=0;s<t.length;s++)_[t[2*s]]=s,a.push(s,t[2*s+1]);for(s=0;s<r.length;s+=3)n.push(_[r[s]],_[r[s+1]],r[s+2]);return{nodes:a,edges:n}}function b(e,t,r){if(g(r))return y(r,e,t),!0;if(E(r))return!1;for(var a=B,n=B,_=!1;!_&&w(r,H,a,n);)if(a=H[0],n=H[1],A(r,a,n)){var s=U(r);P(s,a,n),_=b(e,t,s),D(s)}return _}function g(e){return e.core_len==e.n1}function y(e,t,r){for(var a=0,n=0;a<e.n1;a++)e.core_1[a]!=B&&(t[n]=a,r[n]=e.core_1[a],n++)}function E(e){return e.n1>e.n2||e.t1both_len>e.t2both_len||e.t1out_len>e.t2out_len||e.t1in_len>e.t2in_len}function w(e,t,r,a){r==B&&(r=0),a==B?a=0:a++;var n=e.t1both_len,_=e.t2both_len,s=e.t1out_len,o=e.t2out_len,i=e.t1in_len,l=e.t2in_len,c=e.core_len,u=e.n1,d=e.n2,f=e.core_1,m=e.core_2,p=e.in_1,h=e.in_2,v=e.out_1,b=e.out_2;if(n>c&&_>c)for(;r<u&&(f[r]!=B||0==v[r]||0==p[r]);)r++,a=0;else if(s>c&&o>c)for(;r<u&&(f[r]!=B||0==v[r]);)r++,a=0;else if(i>c&&l>c)for(;r<u&&(f[r]!=B||0==p[r]);)r++,a=0;else if(0==r&&e.order!=G){for(var g=0;g<u&&f[r=e.order[g]]!=B;)g++;g==u&&(r=u)}else for(;r<u&&f[r]!=B;)r++,a=0;if(n>c&&_>c)for(;a<d&&(m[a]!=B||0==b[a]||0==h[a]);)a++;else if(s>c&&o>c)for(;a<d&&(m[a]!=B||0==b[a]);)a++;else if(i>c&&l>c)for(;a<d&&(m[a]!=B||0==h[a]);)a++;else for(;a<d&&m[a]!=B;)a++;return r<u&&a<d&&(t[0]=r,t[1]=a,!0)}function A(e,t,r){var a=e.g1,n=e.g2,_=e.n1,s=e.n2,o=e.core_1,i=e.core_2,l=e.in_1,c=e.in_2,u=e.out_1,d=e.out_2;if(T(t<_),T(r<s),T(o[t]==B),T(i[r]==B),!x(e.node_comp,a,t,n,r))return!1;for(var f=0,m=0,p=0,h=0,v=0,b=0,g=0;g<R(a,t);g++)if(o[E=N(a,t,g)]!=B){if(!I(n,r,y=o[E])||!S(e.edge_comp,a,t,E,n,r,y))return!1}else l[E]&&p++,u[E]&&f++,l[E]||u[E]||v++;for(g=0;g<k(a,t);g++)if(o[E=M(a,t,g)]!=B){if(!I(n,y=o[E],r)||!S(e.edge_comp,a,E,t,n,y,r))return!1}else l[E]&&p++,u[E]&&f++,l[E]||u[E]||v++;for(g=0;g<R(n,r);g++)if(i[y=N(n,r,g)]!=B){if(!I(a,t,E=i[y]))return!1}else c[y]&&h++,d[y]&&m++,c[y]||d[y]||b++;for(g=0;g<k(n,r);g++){var y=M(n,r,g);if(i[y]!=B){var E=i[y];if(!I(a,E,t))return!1}else c[y]&&h++,d[y]&&m++,c[y]||d[y]||b++}return p<=h&&f<=m&&v<=b}function T(e){e||F.panic("Assertion failed")}function x(e,t,r,a,n){return!!e(O(t,r),O(a,n))}function O(e,t){for(var r=e.nodes,a=0;a<r.length;a+=2)if(r[a]==t)return r[a+1];return null}function R(e,t){for(var r=e.edges,a=0,n=0;n<r.length;n+=3)r[n]==t&&a++;return a}function k(e,t){for(var r=e.edges,a=0,n=0;n<r.length;n+=3)r[n+1]==t&&a++;return a}function N(e,t,r){for(var a=e.edges,n=0,_=0;_<a.length;_+=3)if(a[_]==t){if(n==r)return a[_+1];n++}return B}function M(e,t,r){for(var a=e.edges,n=0,_=0;_<a.length;_+=3)if(a[_+1]==t){if(n==r)return a[_];n++}return B}function I(e,t,r){for(var a=e.edges,n=0;n<a.length;n+=3)if(a[n]==t&&a[n+1]==r)return!0;return!1}function S(e,t,r,a,n,_,s){for(var o=L(t,r,a),i=L(n,_,s),l=0;l<o;l++){for(var c=!1,u=0;u<i;u++)if(e(C(t,r,a,l),C(n,_,s,u))){c=!0;break}if(!c)return!1}return!0}function L(e,t,r){for(var a=0,n=e.edges,_=0;_<n.length;_+=3)n[_]==t&&n[_+1]==r&&a++;return a}function C(e,t,r,a){for(var n=e.edges,_=0,s=0;s<n.length;s+=3)if(n[s]==t&&n[s+1]==r){if(_==a)return n[s+2];_++}return null}function P(e,t,r){var a=e.g1,n=e.g2,_=e.n1,s=e.n2,o=e.core_1,i=e.core_2,l=e.in_1,c=e.in_2,u=e.out_1,d=e.out_2;T(t<_),T(r<s),T(e.core_len<_),T(e.core_len<s);var f=++e.core_len;for(e.added_node1=t,l[t]||(l[t]=f,e.t1in_len++,u[t]&&e.t1both_len++),u[t]||(u[t]=f,e.t1out_len++,l[t]&&e.t1both_len++),c[r]||(c[r]=f,e.t2in_len++,d[r]&&e.t2both_len++),d[r]||(d[r]=f,e.t2out_len++,c[r]&&e.t2both_len++),o[t]=r,i[r]=t,m=0;m<k(a,t);m++)l[p=M(a,t,m)]||(l[p]=f,e.t1in_len++,u[p]&&e.t1both_len++);for(m=0;m<R(a,t);m++)u[p=N(a,t,m)]||(u[p]=f,e.t1out_len++,l[p]&&e.t1both_len++);for(m=0;m<k(n,r);m++)c[p=M(n,r,m)]||(c[p]=f,e.t2in_len++,d[p]&&e.t2both_len++);for(var m=0;m<R(n,r);m++){var p=N(n,r,m);d[p]||(d[p]=f,e.t2out_len++,c[p]&&e.t2both_len++)}}function D(e){T(e.core_len-e.orig_core_len<=1),T(e.added_node1!=B);var t=e.g1,r=e.g2,a=e.core_len,n=e.added_node1,_=e.core_1,s=e.core_2,o=e.in_1,i=e.in_2,l=e.out_1,c=e.out_2;if(e.orig_core_len<a){for(o[n]==a&&(o[n]=0),d=0;d<k(t,n);d++)o[f=M(t,n,d)]==a&&(o[f]=0);for(l[n]==a&&(l[n]=0),d=0;d<R(t,n);d++)l[f=N(t,n,d)]==a&&(l[f]=0);var u=_[n];for(i[u]==a&&(i[u]=0),d=0;d<k(r,u);d++)i[f=M(r,u,d)]==a&&(i[f]=0);c[u]==a&&(c[u]=0);for(var d=0;d<R(r,u);d++){var f=N(r,u,d);c[f]==a&&(c[f]=0)}_[n]=B,s[u]=B,e.core_len=e.orig_core_len,e.added_node1=B}}function U(e){var t={};return t.g1=e.g1,t.g2=e.g2,t.node_comp=e.node_comp,t.edge_comp=e.edge_comp,t.n1=e.n1,t.n2=e.n2,t.order=e.order,t.core_len=t.orig_core_len=e.core_len,t.t1in_len=e.t1in_len,t.t1out_len=e.t1out_len,t.t1both_len=e.t1both_len,t.t2in_len=e.t2in_len,t.t2out_len=e.t2out_len,t.t2both_len=e.t2both_len,t.added_node1=B,t.core_1=e.core_1,t.core_2=e.core_2,t.in_1=e.in_1,t.in_2=e.in_2,t.out_1=e.out_1,t.out_2=e.out_2,t.share_count=e.share_count,e.share_count[0]+=1,t}var F=h(e),B=-1,G=0,j=10,z=20,Y=30,H=[B,B];t.NULL_NODE=B,t.FORWARD_DIR=j,t.BACKWARD_DIR=z,t.TWO_WAY=Y,t.create=function(){for(var e=arguments,t=[],r=[],a=0;a<e.length;a++){var n=e[a];switch(n.length){case 2:t.push(n[0],n[1]);break;case 3:r.push(n[0],n[1],n[2]);break;default:F.panic("Wrong graph constructor params")}}return{nodes:t,edges:r}},t.clone=function(e,t,r){if(t)for(var a=new Array(e.nodes.length),n=0;n<e.nodes.length;n+=2)a[n]=e.nodes[n],a[n+1]=t(e.nodes[n+1]);else a=F.clone_object_r(e.nodes);if(r)for(var _=new Array(e.edges.length),n=0;n<e.edges.length;n+=3)_[n]=e.edges[n],_[n+1]=e.edges[n+1],_[n+2]=r(e.edges[n+2]);else _=F.clone_object_r(e.edges);return e={nodes:a,edges:_}},t.create_node_edge_arr=function(e,t){for(var r=[],a=[],n=0;n<e.length;n++)r.push(e[n][0],e[n][1]);for(n=0;n<t.length;n++)a.push(t[n][0],t[n][1],t[n][2]);return{nodes:r,edges:a}},t.append_node=r,t.has_node=a,t.append_edge=n,t.remove_node=_,t.remove_edge=s,t.remove_edge_by_attr=function(e,t,r,a){I(e,t,r)||F.panic("Edge not found");for(var n=e.edges,_=0;_<n.length;_+=3)if(n[_]==t&&n[_+1]==r&&n[_+2][0]==a[0]&&n[_+2][1]==a[1]){n.splice(_,3);break}},t.append_node_attr=function(e,t){if(i(e,t)==B){var a=o(e);return r(e,a,t),a}F.panic("Non-unique attribute")},t.replace_edge_attr=function(e,t,r,a,n){for(var _=e.edges,s=0;s<_.length;s+=3)_[s]==t&&_[s+1]==r&&_[s+2]==a&&(_[s+2]=n)},t.append_subgraph=function(e,t,a,_){a=a||[],_=_||[];for(var s={},i=0;i<e.nodes.length;i+=2){var l=e.nodes[i],c=e.nodes[i+1],u=o(t);r(t,u,c),s[l]=u}for(i=0;i<e.edges.length;i+=3)n(t,d=s[e.edges[i]],m=s[e.edges[i+1]],p=e.edges[i+2]);for(i=0;i<a.length;i+=3){var d=s[a[i]];n(t,d,a[i+1],p=a[i+2])}for(i=0;i<_.length;i+=3){var f=_[i],m=s[_[i+1]],p=_[i+2];n(t,f,m,p)}},t.gen_node_id=o,t.node_by_attr=i,t.append_edge_attr=function(e,t,r,a){var _=i(e,t),s=i(e,r);_!=B&&s!=B?n(e,_,s,a):F.panic("Attributes not found")},t.traverse=function(e,t){for(var r=e.nodes,a=0;a<r.length&&!t(r[a],r[a+1]);a+=2);},t.traverse_edges=function(e,t){for(var r=e.edges,a=0;a<r.length&&!t(r[a],r[a+1],r[a+2]);a+=3);},t.traverse_inputs=function(e,t,r){for(var a=e.edges,n=0;n<a.length;n+=3)if(a[n+1]==t){var _=a[n];if(r(_,O(e,_),a[n+2]))return}},t.traverse_outputs=function(e,t,r){for(var a=e.edges,n=0;n<a.length;n+=3)if(a[n]==t){var _=a[n+1];if(r(_,O(e,_),a[n+2]))return}},t.topsort=l,t.topsort_attr=function(e){for(var t=l(e).nodes,r=[],a=0;a<t.length;a+=2)r.push(t[a+1]);return r},t.is_connected=function(e){},t.subgraph_node_conn=function(e,t,r){a(e,t)||F.panic("No such node");var n={};c(e,n),d(e,t,n,r);var _=[];for(var s in n)n[s]&&(s=Number(s),_.push(s,O(e,s)));var o={nodes:_,edges:e.edges.slice(0)};return f(o),o},t.cleanup_loose_edges=f,t.get_source_nodes=function(e){for(var t=[],r=e.nodes,a=0;a<r.length;a+=2){var n=r[a];k(e,n)||t.push(n)}return t},t.get_sink_nodes=m,t.match=function(e,t,r,a){var n={};n.g1=v(e),n.g2=v(t),n.node_comp=r||function(e,t){return e==t},n.edge_comp=a||function(e,t){return e==t};var _=p(e),s=p(t);for(n.n1=_,n.n2=s,n.order=G,n.core_len=n.orig_core_len=0,n.t1both_len=n.t1in_len=n.t1out_len=0,n.t2both_len=n.t2in_len=n.t2out_len=0,n.added_node1=B,n.core_1=Array(_),n.core_2=Array(s),n.in_1=new Array(_),n.in_2=new Array(s),n.out_1=new Array(_),n.out_2=new Array(s),n.share_count=[1],l=0;l<_;l++)n.core_1[l]=B,n.in_1[l]=0,n.out_1[l]=0;for(l=0;l<s;l++)n.core_2[l]=B,n.in_2[l]=0,n.out_2[l]=0;var o=new Array(_),i=new Array(_);if(b(o,i,n)){for(var l=0;l<o.length;l++)o[l]=e.nodes[2*o[l]],i[l]=t.nodes[2*i[l]];return[o,i]}return null},t.get_node_id=function(e,t){for(var r=e.nodes,a=1;a<r.length;a+=2)if(r[a]==t)return r[a-1];return null},t.get_node_attr=O,t.out_edge_count=R,t.in_edge_count=k,t.get_out_edge=N,t.get_in_edge=M,t.get_edge_count=L,t.get_edge_attr=C,t.replace=function(e,t,a){for(var n=e.edges,s=o(e),i=0;i<t.length;i++){var l=t[i];_(e,l);for(var c=0;c<n.length;c+=3)n[c]==l&&(n[c]=s),n[c+1]==l&&(n[c+1]=s),n[c]==n[c+1]&&(n.splice(c,3),c-=3)}r(e,s,a)},t.reconnect_edges=function(e,t,r,a,n){I(e,t,r)||F.panic("Edge not found");for(var _=e.edges,s=0;s<_.length;s+=3)_[s]==t&&_[s+1]==r&&(_[s]=a,_[s+1]=n)},t.enforce_acyclic=function(e,t){function r(e,t){if(-1!=i.indexOf(e)){var a=i.slice(i.indexOf(e));if(-1!=n[a[a.length-1]].indexOf(a[0]))return void l.push([e,a[a.length-1]])}i.push(e);for(var _=0;_<t.length;_++)t[_]in n&&r(t[_],n[t[_]])}t||(t=m(e)[0]);var a=e.edges;if(!a.length||-1==a.indexOf(t))return e;for(var n={},_=0,o=0;o<a.length;o+=3)a[o+1]in n?n[a[o+1]].push(a[o]):n[a[o+1]]=[a[o]],_++;var i=[],l=[];for(r(t,n[t]),o=0;o<l.length;o++){_=0;for(var c=0;c<a.length;c+=3)l[o][1]==a[c+1]&&l[o][0]==a[c]&&s(e,a[c],a[c+1],_),_++}return e},t.debug_dot=function(e,t,r){var a=e.nodes,n=e.edges,_="digraph debug {\n";for(_+="    ",_+="node [shape=box];\n",l=0;l<a.length;l+=2){var s=a[l],o=a[l+1],i=t?t(s,o):String(s);_+="    ",_+=String(s)+' [label="'+i.replace(/\"/g,'\\"')+'"];\n'}for(var l=0;l<n.length;l+=3){var c=n[l],u=n[l+1],o=n[l+2];_+="    ",_+=String(c)+" -> "+String(u),r&&(_+=' [label="'+r(c,u,o)+'"]'),_+=";\n"}return _+="}"}}),w=o("__geometry",function(e,t){function r(){return{length:0,frames:1,num_comp:0,offset:0,divisor:0}}function a(e,t){for(var r=t.a_tbn,a=t.a_position,n=a.length,_=1;_<e.shape_keys.length;_++)for(var s=e.shape_keys[_].geometry,o=e.shape_keys[_].init_value,i=s.a_position,l=0;l<n;l++)a[l]+=o*i[l];for(var c=Oe.get_items_count(r),_=0;_<c;_++){for(var u=Oe.identity(Me),l=1;l<e.shape_keys.length;l++){var d=e.shape_keys[l].geometry.a_tbn;if(o=e.shape_keys[l].init_value){var f=Oe.get_item(d,_,Ie),m=Oe.slerp(Oe.identity(Se),f,o,Ie);Oe.multiply_tbn(m,u,u)}}var p=Oe.get_item(r,_,Ie),h=Oe.multiply_tbn(u,p,Ie);Oe.set_item(r,h,_)}}function n(e){return e.base_length>Fe&&!Ae.get_elem_index_uint()}function _(e){return e.indices.length>0}function s(e,t,r){if(!_(e))return e;t=t||1,r||Te.log('%cDEBUG max vertices exceeded for indexed submesh "'+e.name+'": '+e.base_length*t+", will use drawArrays","color: #aa0");var a=e.indices,n=e.base_length,s=e.va_common,i=e.va_frames;for(var l in s)p=Y(m=s[l],n),s[l]=o(a,m,p);for(u=0;u<i.length;u++){var c=i[u];for(var l in c)p=Y(m=c[l],n),c[l]=o(a,m,p)}for(var u=0;u<e.shape_keys.length;u++){var d=e.shape_keys[u].geometry;for(var f in d){var m=d[f],p=Y(m,n);d[f]=o(a,m,p)}}return e.base_length=a.length,e.indices=new Uint16Array(0),e}function o(e,t,r){if(0==t.length)return new Float32Array(0);for(var a=e.length*r,n=new Float32Array(a),_=0;_<e.length;_++)for(var s=e[_],o=0;o<r;o++)n[r*_+o]=t[r*s+o];return n}function i(){return{ibo_array:null,vbo_source_data:ue(),ibo_type:0,count:0,pointers:{},usage:0,debug_ibo_bytes:0,debug_vbo_bytes:0,vbo_data:[],ibo:null,shape_keys:null,instance_count:1,cleanup_gl_data_on_unload:!0}}function c(e,t,a,n){if("a_normal"==t)return c(e,"a_tbn",a,Oe.from_norm_tan(n));var _=e.pointers,s=_[t],o=be(t);if(s)a&&s.num_comp!=a&&ke.panic('invalid num_comp for "'+t+'"'),ge(e.vbo_source_data,t,n,s.offset);else{var i=me(e.vbo_source_data,o);-1==i&&(e.vbo_source_data.push(de(o,0)),i=e.vbo_source_data.length-1);var l=e.vbo_source_data[i].vbo_source,u=new l.constructor(l.length+n.length);u.set(l),e.vbo_source_data[i].vbo_source=u,ge(e.vbo_source_data,t,n,l.length);var d=_[t]=r();d.num_comp=a,d.offset=l.length,d.length=n.length}return A(e),e}function u(e,t){if("a_normal"==t){for(var r=u(e,"a_tbn"),a=Oe.get_items_count(r),n=new Float32Array(3*a),_=0;_<a;_++){var s=Oe.get_norm(r,_,Le);n.set(s,3*_)}return n}var o=e.pointers[t];if(o){var i=be(t);return ye(t,he(e.vbo_source_data,i).subarray(o.offset,o.offset+o.length),new Float32Array(o.length))}ke.panic("extract_array_float() failed; invalid name: "+t)}function f(e,r){var a;switch(r){case t.DM_DEFAULT:case t.DM_TRIANGLES:a=qe.STATIC_DRAW;break;case t.DM_DYNAMIC_TRIANGLES:a=qe.DYNAMIC_DRAW;break;default:ke.panic("Wrong draw_mode")}e.usage=a}function g(e,t,a,n,_,s){if(t.length)if(l=t.length,_<=Fe)var o=new Uint16Array(t),i=qe.UNSIGNED_SHORT;else var o=new Uint32Array(t),i=qe.UNSIGNED_INT;else var l=_,o=null;for(var c=ue(w(a,n,s)),u={},d=0;d<c.length;d++)u[c[d].type]=0;var f={};for(var m in n)(b=(A=n[m]).length)&&(v=be(m),(y=f[m]=r()).length=b,y.num_comp=Y(A,_),y.offset=u[v],ge(c,m,A,u[v]),u[v]+=b);var p=a.length;for(var m in a[0]){var h=a[0][m],v=be(m),b=h.length,g=Y(h,_);if(b){var y=f[m]=r();for(y.length=b,y.frames=p,y.num_comp=g,y.offset=u[v],p>1&&((y=f[m+"_next"]=r()).length=b,y.frames=p,y.num_comp=g,y.offset=u[v]+b),d=0;d<p;d++){var A=a[d][m];ge(c,m,A,u[v=be(m)]),u[v]+=b}}}s&&(E(s,f,c,u),e.instance_count=s.tsr_array.length),e.count=l,e.ibo_array=o,e.vbo_source_data=c,e.ibo_type=i,e.pointers=f}function E(e,t,a,n){var _=e.tsr_array,s=e.stat_part_em_tsr,o=e.part_inh_attrs,i=e.submesh_params,l=e.static_hair,c={a_part_ts:{data:[],num_comp:4},a_part_r:{data:[],num_comp:4}};for(var u in o)c[u]={data:[],num_comp:o[u].num_comp};for(var u in i)c[u]={data:[],num_comp:1};for(var d=0;d<_.length;d++){var f=_[d];l&&s&&!e.dyn_grass&&(f=Re.multiply(s,_[d],Ue)),!l&&e.dyn_grass&&Ne.subtract(_[d],s,_[d]),c.a_part_ts.data.push(f[0],f[1],f[2],f[3]),c.a_part_r.data.push(f[4],f[5],f[6],f[7]);for(var u in o)for(var m=o[u].num_comp,p=0;p<m;p++)c[u].data.push(o[u].data[d*m+p]);for(var u in i)c[u].data.push(i[u][0])}for(var u in c){var h=be(u);ge(a,u,c[u].data,n[h]);var v=r();v.num_comp=c[u].num_comp,v.offset=n[h],v.divisor=1,v.length=c[u].data.length,t[u]=v,n[h]+=v.length}}function w(e,t,r){var a={},n=function(e,t){a[e]||(a[e]=0),a[e]+=t};for(var _ in e[0])s=e[0][_],n(i=be(_),s.length*e.length);for(var _ in t){var s=t[_];n(i=be(_),s.length)}if(r){var o=r.tsr_array.length,i=be("a_part_ts");n(i,4*o),n(i=be("a_part_r"),4*o);var l=r.part_inh_attrs;for(var _ in l)n(i=be(_),l[_].num_comp*o);var c=r.submesh_params;for(var _ in c)n(i=be(_),o)}return a}function A(e){e.ibo_array?(e.ibo||(e.ibo=qe.createBuffer()),qe.bindBuffer(qe.ELEMENT_ARRAY_BUFFER,e.ibo),qe.bufferData(qe.ELEMENT_ARRAY_BUFFER,e.ibo_array,e.usage),e.debug_ibo_bytes=e.ibo_array.byteLength):e.debug_ibo_bytes=0,e.debug_vbo_bytes=0;for(var t=0;t<e.vbo_source_data.length;t++){var r=e.vbo_source_data[t].type,a=me(e.vbo_data,r);-1==a&&(e.vbo_data.push({vbo:null,type:r,debug_id:ke.unique_id()}),a=e.vbo_data.length-1);var n=e.vbo_data[a];n.vbo||(n.vbo=qe.createBuffer()),qe.bindBuffer(qe.ARRAY_BUFFER,n.vbo),qe.bufferData(qe.ARRAY_BUFFER,e.vbo_source_data[t].vbo_source,e.usage),e.debug_vbo_bytes+=e.vbo_source_data[t].vbo_source.byteLength}}function T(e,t){e.bb_local=we.bounding_box_transform(e.bb_local,t),e.be_local=we.bounding_ellipsoid_transform(e.be_local,t),e.bs_local=we.bounding_sphere_transform(e.bs_local,t),e.bbr_local=we.bounding_rot_box_transform(e.bbr_local,t)}function x(e){var t=e[0],r=O(e),a=r.submesh_bd;a.bb_local=we.clone_bb(t.submesh_bd.bb_local);for(var n=0,_=0,s=[],o=0;o<e.length;o++){var i=e[o],l=i.indices,c=i.base_length,u=i.va_common,d=i.submesh_bd.bb_local,f=i.submesh_bd.bs_local;for(we.expand_bounding_box(a.bb_local,d),we.expand_bounding_sphere(a.bs_local,f),we.extract_rot_bb_corners(i.submesh_bd.bbr_local,s),A=0;A<l.length;A++){var m=l[A];r.indices[n+A]=m+_}n+=l.length;for(var p in u)g=_*Y(b=u[p],c),r.va_common[p].set(b,g);for(A=0;A<i.va_frames.length;A++){var h=i.va_frames[A],v=r.va_frames[A];for(var p in h){var b=h[p],g=_*Y(b,c);v[p].set(b,g)}}_+=c}if(a.be_local=we.create_be_by_bb(ke.f32(s),!0),r.shape_keys.length>0)for(o=0;o<r.shape_keys.length;o++)for(var y=r.shape_keys[o].geometry,E=0,w=0,A=0;A<e.length;A++){var T=e[A].shape_keys[o].geometry;y.a_position.set(T.a_position,E),y.a_tbn.set(T.a_tbn,w),E+=T.a_position.length,w+=T.a_tbn.length}return e[0].instanced_array_data&&(r.instanced_array_data={tsr_array:t.instanced_array_data.tsr_array,stat_part_em_tsr:t.instanced_array_data.stat_part_em_tsr,static_hair:!0,submesh_params:t.instanced_array_data.submesh_params,part_inh_attrs:t.instanced_array_data.part_inh_attrs,dyn_grass:t.instanced_array_data.dyn_grass}),r}function O(e){for(var t=e[0],r=ce("JOIN_"+e.length+"_SUBMESHES"),a=0,n=0;n<e.length;n++)a+=e[n].indices.length;r.indices=new Uint32Array(a);var _=0,s=0;if(e[0].shape_keys.length>0)for(var o=0;o<e[0].shape_keys.length;o++){for(n=0;n<e.length;n++)_+=e[n].shape_keys[o].geometry.a_position.length,s+=Oe.get_items_count(e[n].shape_keys[o].geometry.a_tbn);var i={a_position:new Float32Array(_),a_tbn:Oe.create(s)},l={init_value:e[0].shape_keys[o].init_value,geometry:i};r.shape_keys.push(l)}for(a=0,n=0;n<e.length;n++)a+=e[n].base_length;r.base_length=a;for(var c in t.va_common){for(a=0,n=0;n<e.length;n++)a+=e[n].va_common[c].length;r.va_common[c]=new Float32Array(a)}for(var c in t.va_frames[0]){for(a=0,n=0;n<e.length;n++)a+=e[n].va_frames[0][c].length;for(n=0;n<t.va_frames.length;n++)r.va_frames[n]=r.va_frames[n]||{},r.va_frames[n][c]=new Float32Array(a)}return r}function R(e,t,r){for(var a=t.submesh_bd,n=we.create_bb(),_=we.create_rot_bb(),s=[],o=0;o<r.length;o++)we.bounding_box_transform(e.submesh_bd.bb_local,r[o],n),we.expand_bounding_box(a.bb_local,n),we.bounding_rot_box_transform(e.submesh_bd.bbr_local,r[o],_),we.extract_rot_bb_corners(_,s);a.be_local=we.create_be_by_bb(ke.f32(s),!0),a.bbr_local=we.create_bbr_by_be(a.be_local),a.bs_local=we.create_bs_by_be(a.be_local)}function k(e,t,r,a,n,_){var o=e.submeshes[t],i=o.base_length,l=e.materials[t],c=ce("SUBMESH_"+e.name+"_"+l.name);c.base_length=i;var u=!1;if(B(r,"a_texcoord"))d=I(e,t);else var d=new Float32Array(0);if(B(r,"a_orco_tex_coord"))f=L(e,o);else var f=new Float32Array(0);var m=G(r,i,a,o.group);if(n)p=ke.clone_object_r(n);else var p={};p.a_color={generate_buffer:!0},B(r,"a_color")&&e.active_vcol_name?p.a_color.src=[{name:e.active_vcol_name,mask:7}]:p.a_color.src=[],c.va_common.a_texcoord=d,c.va_common.a_influence=m,c.va_common.a_orco_tex_coord=f,P(c.va_common,p,o.vertex_colors,o.color,i,e.name),F(o,e.name,_,c.va_common),c.indices=new Uint32Array(o.indices);var h=o.position.length/i/Ge;if(B(r,"a_tbn")&&o.tbn.length)v=!0;else var v=!1;if(B(r,"a_shade_tangs")&&o.shade_tangs.length)b=!0;else var b=!1;e.b4w_shape_keys.length>0&&(u=!0);for(var g=0;g<h;g++){if(w=M(o,i,v,b,g),u){var y={};if(y.name=e.b4w_shape_keys[g].name,c.shape_keys.push(y),0!=g){y.geometry=w,y.init_value=e.b4w_shape_keys[g].value;continue}y.geometry=M(o,i,v,b,g),y.init_value=1}c.va_frames.push(w)}if(h>1&&!u){var E=c.va_frames[0],w={};for(var A in E)w[A]=new Float32Array(E[A]);c.va_frames.push(w)}return B(r,"a_polyindex")&&(s(c,1,!0),c.va_common.a_polyindex=ae(c)),N(o.boundings,c.submesh_bd),c}function N(e,t){t.bb_local=we.create_bb(),t.bb_local.max_x=e.bb.max_x,t.bb_local.max_y=e.bb.max_y,t.bb_local.max_z=e.bb.max_z,t.bb_local.min_x=e.bb.min_x,t.bb_local.min_y=e.bb.min_y,t.bb_local.min_z=e.bb.min_z;var r=e.rbb,a=e.caxis_x,n=e.caxis_y,_=e.caxis_z,s=e.be_ax;t.be_local=we.be_from_values(a,n,_,e.be_cen),Ne.scale(t.be_local.axis_x,s[0],t.be_local.axis_x),Ne.scale(t.be_local.axis_y,s[1],t.be_local.axis_y),Ne.scale(t.be_local.axis_z,s[2],t.be_local.axis_z),t.bs_local=we.create_bs_by_be(t.be_local),Ne.copy(r.rbb_c,t.bbr_local.center),Ne.copy(a,t.bbr_local.axis_x),Ne.copy(n,t.bbr_local.axis_y),Ne.copy(_,t.bbr_local.axis_z);var o=r.rbb_s;Ne.scale(t.bbr_local.axis_x,o[0],t.bbr_local.axis_x),Ne.scale(t.bbr_local.axis_y,o[1],t.bbr_local.axis_y),Ne.scale(t.bbr_local.axis_z,o[2],t.bbr_local.axis_z)}function M(e,t,r,a,n){var _={},s=new Float32Array(t*Ge),o=Oe.create(r?t:0),i=n*t*Ge,l=i+t*Ge;if(s.set(e.position.subarray(i,l),0),r&&(i=n*t,Oe.copy(e.tbn,i,t,o)),a){var c=new Float32Array(t*He);l=t*He,c.set(e.shade_tangs.subarray(0,l),0),_.a_shade_tangs=c}return _.a_position=s,_.a_tbn=o,_}function I(e,t){var r=null,a=e.materials[t],n=e.submeshes[t];if(a.texture_slots.length){var _=a.texture_slots[0];switch(_.texture_coords){case"UV":r=S(n,_.uv_layer||e.active_uv_name,e.name);break;case"ORCO":r=C(e.b4w_boundings.bb_src,n)}}return null===r&&(r=new Float32Array(n.base_length*Ye)),r}function S(e,t,r){var a=e.base_length*Ye,n=e.uv_layers.indexOf(t);if(-1==n)return Te.warn('uv layer "'+t+'" for mesh "'+r+'" not found'),new Float32Array(a);var _=n*a,s=_+a;return e.texcoord.subarray(_,s)}function L(e,t){for(var r=e.b4w_boundings.bb_src,a=new Float32Array(3*t.base_length),n=t.position,_=r.max_x-r.min_x,s=r.max_y-r.min_y,o=r.max_z-r.min_z,i=0,l=0;l<n.length;l+=3)a[i++]=0==_?.5:ke.clamp(parseFloat(((n[l]-r.min_x)/_).toFixed(5)),0,1),a[i++]=0==s?.5:ke.clamp(parseFloat(((n[l+1]-r.min_y)/s).toFixed(5)),0,1),a[i++]=0==o?.5:ke.clamp(parseFloat(((n[l+2]-r.min_z)/o).toFixed(5)),0,1);return a}function C(e,t){for(var r=new Float32Array(t.base_length*Ye),a=(e.max_x+e.min_x)/2,n=(e.max_y+e.min_y)/2,_=e.max_x-e.min_x,s=e.max_y-e.min_y,o=0,i=0;i<t.position.length;i+=3)r[o++]=(t.position[i]-a)/_+.5,r[o++]=(t.position[i+1]-n)/s+.5;return r}function P(e,t,r,a,n,_){var s=D(r);for(var o in t){var i=t[o].src;if(i.length){for(var l=0,c=0;c<i.length;c++)l+=ke.rgb_mask_get_channels_count(i[c].mask);e[o]=new Float32Array(l*n);for(var u=0,c=0;c<i.length;c++){var d=i[c].name,f=i[c].mask,m=ke.rgb_mask_get_channels_presence(f),p=s.indexOf(d);if(-1==p)Te.warn('vertex color "'+d+'" for mesh "'+_+'" not found'),h=7;else var h=r[p].mask,v=U(r,p,n);var b=ke.rgb_mask_get_channels_count(h);(f&h)!==f&&Te.error("Wrong color extraction from "+d+" to "+o+' for the mesh "'+_+'".');for(var g=0;g<n;g++)for(var y=0;y<ze;y++)if(m[y]){var E=u+ke.rgb_mask_get_channel_presence_index(f,y),w=ke.rgb_mask_get_channel_presence_index(h,y);e[o][g*l+E]=-1==p?0:a[v+g*b+w]}u+=b}}else e[o]=new Float32Array(0)}}function D(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r].name);return t}function U(e,t,r){for(var a=0,n=0;n<t;n++)a+=ke.rgb_mask_get_channels_count(e[n].mask);return a*r}function F(e,t,r,a){if(r)for(var n in r)a[r[n]]=S(e,n,t)}function B(e,t){return e.indexOf(t)>-1}function G(e,t,r,a){if(B(e,"a_influence")&&r)for(var n=new Float32Array(t*We),_=a.length/t,s=j(r,_),o=_>3?_:4,i=new Float32Array(o),l=new Uint32Array(o),c=new Float32Array(We),u=new Float32Array(o),d=new Uint32Array(o),f=new Float32Array(We),m=0;m<t;m++)i.set(u),l.set(d),c.set(f),n.set(z(a,_,m,t,s,i,l,c),m*We);else n=new Float32Array(0);return n}function j(e,t){for(var r=new Float32Array(t),a=0;a<t;a++){r[a]=-1;for(var n in e){var _=e[n];if(_.vgroup_index===a){r[a]=_.deform_bone_index;break}}}return r}function z(e,r,a,n,_,s,o,i){for(var l=!0,c=0;c<r;c++){var u=e[c*n+a];if(-1!==u){var d=_[c];-1!==d&&(s[c]=u,o[c]=d,l=!1)}}if(l)return i;V(s,o,t.SORT_NUMERIC,!1);for(var f=0,c=0;c<We;c++)f+=s[c];if(f<.01)return i;for(c=0;c<We;c++)s[c]/=f;if(Math.abs(s[0]-1)<.01)i[0]=o[0]+1;else for(c=0;c<We;c++)i[c]=o[c]+s[c];return i}function Y(e,t){if(0==t)return 0;var r=e.length,a=r/t;return a!=Math.floor(a)&&ke.panic("Array size mismatch during geometry calculation: array length="+r+", base length="+t),a}function H(e,t,r){for(var a=e.length/3,n=0;n<a;n++){var _=e[3*n],s=e[3*n+1],o=e[3*n+2],i=t[3*_],l=t[3*_+1],c=t[3*_+2],u=t[3*s],d=t[3*s+1],f=t[3*s+2],m=t[3*o],p=t[3*o+1],h=t[3*o+2];r[3*n]=(i+u+m)/3,r[3*n+1]=(l+d+p)/3,r[3*n+2]=(c+f+h)/3}return r}function W(e,t,r){for(var a=e.length/3,n=0;n<a;n++){var _=e[3*n]-t[0],s=e[3*n+1]-t[1],o=e[3*n+2]-t[2];r[n]=_*_+s*s+o*o}return r}function q(e,t){var r=e.length;if(r<2)return t;for(var a,n=r,_=!1;n>1||_;){n>1&&(n=Math.floor(n/Be)),_=!1;for(var s=0;n+s<r;s++)e[s]-e[s+n]<0&&(a=e[s],e[s]=e[s+n],e[s+n]=a,X(t,s,s+n),_=!0)}return t}function V(e,r,a,n){for(var _,s=e.length,o=s,i=!1,l=n?-1:1;o>1||i;){o>1&&(o=Math.floor(o/Be)),i=!1;for(var c=0;o+c<s;c++){if(a==t.SORT_NUMERIC)u=l*(e[c]-e[c+o])<0;else var u=e[c]<e[c+o]&&n;u&&(_=e[c],e[c]=e[c+o],e[c+o]=_,_=r[c],r[c]=r[c+o],r[c+o]=_,i=!0)}}}function X(e,t,r){var a=e[3*t],n=e[3*t+1],_=e[3*t+2];e[3*t]=e[3*r],e[3*t+1]=e[3*r+1],e[3*t+2]=e[3*r+2],e[3*r]=a,e[3*r+1]=n,e[3*r+2]=_}function K(e,t,r){var a=[],n=[];Ne.subtract(t,e,a),Ne.subtract(r,e,n),Ne.normalize(a,a),Ne.normalize(n,n);var _=ke.clamp(Ne.dot(a,n),-1,1);return Math.acos(_)}function Z(e,t,r,a,n,_,s,o,i,l){for(var c=Q(a,n,_),u=0;u<je;u++){var d=je*t+u,f=je*r+u;l[je*e+u]=s*c[u],l[d]=o*c[u],l[f]=i*c[u]}}function Q(e,t,r){var a=[],n=[],_=[];return Ne.subtract(t,e,a),Ne.subtract(r,e,n),Ne.cross(a,n,_),Ne.normalize(_,_),_}function J(e,t){for(var r in e)for(var a=e[r],n=0;n<je;n++){for(var _=je*a[0]+n,s=1;s<a.length;s++){var o=je*a[s]+n;t[_]+=t[o]}for(s=1;s<a.length;s++)t[o=je*a[s]+n]=t[_]}}function $(e,t){for(var r=new Float32Array(je),a=0;a<je;a++){var n=je*e+a;r[a]=t[n]}for(Ne.normalize(r,r),a=0;a<je;a++)t[n=je*e+a]=r[a]}function ee(e,t){return t||(t=[]),re(e.va_frames[0].a_position,e,t)}function te(e,t){t||(t=[]);for(var r=e.va_frames[0].a_tbn,a=Oe.get_items_count(r),n=new Float32Array(3*a),_=0;_<a;_++){var s=Oe.get_quat(r,_,De),o=Ne.transformQuat(ke.AXIS_Y,s,Le);n[3*_]=o[0],n[3*_+1]=o[1],n[3*_+2]=o[2]}return re(n,e,t)}function re(e,t,r){if(_(t))for(var a=t.indices,n=a.length/3,s=0;s<n;s++){var o=new Float32Array(9),i=a[3*s];o[0]=e[3*i],o[1]=e[3*i+1],o[2]=e[3*i+2];var l=a[3*s+1];o[3]=e[3*l],o[4]=e[3*l+1],o[5]=e[3*l+2];var c=a[3*s+2];o[6]=e[3*c],o[7]=e[3*c+1],o[8]=e[3*c+2],r[s]=o}else for(var n=e.length/9,s=0;s<e.length;s++)(o=new Float32Array(9))[0]=e[9*s],o[1]=e[9*s+1],o[2]=e[9*s+2],o[3]=e[9*s+3],o[4]=e[9*s+4],o[5]=e[9*s+5],o[6]=e[9*s+6],o[7]=e[9*s+7],o[8]=e[9*s+8],r[s]=o;return r}function ae(e){for(var t=new Float32Array(e.base_length),r=0;r<e.base_length;r++)t[r]=r%3/2;return t}function ne(e,t,r){return Math.sqrt(_e(e,t,r))}function _e(e,t,r){var a=Ne.dist(e,t),n=Ne.dist(e,r),_=Ne.dist(t,r),s=(a+n+_)/2;return s*(s-a)*(s-n)*(s-_)}function se(e,t,r){r||(r=new Float32Array(3));var a=e[0],n=e[1],_=e[2],s=e[3],o=e[4],i=e[5],l=e[6],c=e[7],u=e[8],d=ke.rand_r(t),f=ke.rand_r(t);d+f>1&&(d=1-d,f=1-f);var m=1-d-f,p=m*a+d*s+f*l,h=m*n+d*o+f*c,v=m*_+d*i+f*u;return r[0]=p,r[1]=h,r[2]=v,r}function oe(e){for(var t=new Float32Array([0,0,0,1,1,1,1,0]),r=new Float32Array(8*e),a=0;a<e;a++)r.set(t,8*a);return r}function ie(e,t,r,a){if(e){for(var n=e.offset,_=e.length+n,s=t.bufs_data.shape_keys[0].geometry.a_position,o=n;o<_;o++)r[o]=s[o-n];for(o=1;o<t.bufs_data.shape_keys.length;o++){var i=t.bufs_data.shape_keys[o].geometry.a_position,l=a[o].value;if(l)for(var c=n;c<_;c++)r[c]+=l*i[c-n]}qe.bufferSubData(qe.ARRAY_BUFFER,ke.FLOAT_SIZE*n,r.subarray(n))}}function le(e,t,r,a){if(e){for(var n=e.offset,_=e.length+n,s=t.bufs_data.shape_keys,o=s[0].geometry.a_tbn,i=Oe.identity(Me),l=n;l<_;l+=Oe.TBN_NUM_COMP){for(var c=Oe.identity(Se),u=(l-n)/Oe.TBN_NUM_COMP,d=1;d<s.length;d++){var f=a[d].value;if(f){var m=s[d].geometry.a_tbn,p=Oe.get_item(m,u,Ie),h=Oe.slerp(i,p,f,Ie);Oe.multiply_tbn(h,i,c)}}var v=Oe.get_item(o,u,Ie),b=Oe.multiply_tbn(c,v,Ie);r[l]=ke.float_to_short(b[0]),r[l+1]=ke.float_to_short(b[1]),r[l+2]=ke.float_to_short(b[2]),r[l+3]=ke.float_to_short(b[3])}qe.bufferSubData(qe.ARRAY_BUFFER,ke.FLOAT_SIZE*n,r.subarray(n))}}function ce(e){return{name:e,base_length:0,indices:null,va_frames:[],va_common:{a_influence:new Float32Array(0),a_color:new Float32Array(0),a_texcoord:new Float32Array(0)},shape_keys:[],submesh_bd:{bb_local:we.create_bb(),be_local:we.create_be(),bs_local:we.create_bs(),bbr_local:we.create_rot_bb()},instanced_array_data:null}}function ue(e){var t=[];for(var r in e)t.push(de(r,e[r]));return t}function de(e,t){return{vbo_source:new(ve(e))(t),type:e}}function fe(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].vbo_source,n=e[r].type;t.push({vbo_source:new a.constructor(a),type:n})}return t}function me(e,t){for(var r=0;r<e.length;r++)if(e[r].type==t)return r;return-1}function pe(e,t){var r=me(e,t);return-1==r?null:e[r].vbo}function he(e,t){var r=me(e,t);return-1==r?null:e[r].vbo_source}function ve(e){switch(e){case Ve:return Float32Array;case Xe:return Int16Array;case Ke:return Uint8Array;default:return Float32Array}}function be(e){switch(e=e.replace(/_next$/,""),e=e.replace(/param_GEOMETRY_VC_a_\w+/,"param_GEOMETRY_VC_a")){case"a_tbn":case"a_shade_tangs":return Xe;case"a_color":case"a_bending_col_main":case"a_bending_col_detail":case"a_grass_size":case"a_grass_color":case"param_GEOMETRY_VC_a":case"a_polyindex":case"a_p_bb_vertex":case"a_halo_bb_vertex":case"a_bb_vertex":return Ke;default:return Ve}}function ge(e,t,r,a){Ee(t,r,e[me(e,be(t))].vbo_source.subarray(a))}function ye(e,t,r){switch(be(e)){case Ve:r.set(t);break;case Xe:for(a=0;a<t.length;a++)r[a]=ke.short_to_float(t[a]);break;case Ke:for(var a=0;a<t.length;a++)r[a]=ke.ubyte_to_ufloat(t[a])}return r}function Ee(e,t,r){switch(be(e)){case Ve:r.set(t);break;case Xe:for(a=0;a<t.length;a++)r[a]=ke.float_to_short(t[a]);break;case Ke:for(var a=0;a<t.length;a++)r[a]=ke.ufloat_to_ubyte(t[a])}return r}var we=b(e),Ae=y(e),Te=m(e),xe=d(e),Oe=p(e),Re=v(e),ke=h(e),Ne=l(e),Me=Oe.create(),Ie=Oe.create(),Se=Oe.create(),Le=new Float32Array(3),Ce=new Float32Array(3),Pe=new Float32Array(3),De=xe.create(),Ue=new Float32Array(8),Fe=65536,Be=1.247330950103979,Ge=3,je=3,ze=3,Ye=2,He=3,We=4;t.DM_TRIANGLES=10,t.DM_DYNAMIC_TRIANGLES=20,t.SORT_NUMERIC=0,t.SORT_STRING=1,t.DM_DEFAULT=t.DM_TRIANGLES;var qe=null,Ve="float",Xe="short",Ke="unsigned_byte";t.VBO_FLOAT=Ve,t.VBO_SHORT=Xe,t.VBO_UBYTE=Ke,t.setup_context=function(e){qe=e},t.submesh_to_bufs_data=function(e,t,r){n(e)&&s(e);var _=e.indices,o=e.base_length,l=e.va_frames,c={};for(var u in e.va_common)u in r&&!r[u].generate_buffer||(c[u]=e.va_common[u]);var d=i();return e.shape_keys.length>0&&a(e,l[0]),g(d,_,l,c,o,e.instanced_array_data),f(d,t),A(d),d.shape_keys=e.shape_keys,d},t.submesh_init_shape_keys=a,t.is_long_submesh=n,t.is_indexed=_,t.submesh_drop_indices=s,t.update_bufs_data_index_array=function(e,t,r){return f(e,t),e.count=r.length,e.ibo_array=r,r instanceof Uint16Array?e.ibo_type=qe.UNSIGNED_SHORT:e.ibo_type=qe.UNSIGNED_INT,e},t.update_bufs_data_array=c,t.extract_array_float=u,t.make_static=function(e){e.usage=qe.STATIC_DRAW},t.make_dynamic=function(e){e.usage=qe.DYNAMIC_DRAW},t.update_gl_buffers=A,t.update_gl_buffer_sub_data=function(e,t,r,a){var n=me(e.vbo_data,t),_=e.vbo_data[n];qe.bindBuffer(qe.ARRAY_BUFFER,_.vbo),qe.bufferSubData(qe.ARRAY_BUFFER,ke.FLOAT_SIZE*a,r)},t.cleanup_bufs_data=function(e){e.ibo&&qe.deleteBuffer(e.ibo);for(var t=0;t<e.vbo_data.length;t++)e.vbo_data[t].vbo&&qe.deleteBuffer(e.vbo_data[t].vbo);e.vbo_data.length=0},t.has_empty_submesh=function(e,t){return!e.submeshes[t].base_length},t.submesh_apply_transform=function(e,t){for(var r=0;r<e.va_frames.length;r++){var a=e.va_frames[r].a_position;Re.transform_vectors(a,t,a,0);var n=e.va_frames[r].a_tbn;Oe.multiply_tsr(n,t,n);var _=e.va_frames[r].a_shade_tangs;_&&_.length>0&&Re.transform_dir_vectors(_,t,_,0)}var s=e.va_common.au_center_pos;return s&&s.length&&Re.transform_vectors(s,t,s,0),T(e.submesh_bd,t),e},t.submesh_apply_particle_transform=function(e,t){var r=e.va_common.au_center_pos;if(r&&r.length){var a=new Float32Array(r);Re.transform_vectors(a,t,a,0);for(var n=0;n<e.va_frames.length;n++)for(var _=0;_<a.length;_++)e.va_frames[n].a_position[_]+=a[_]-r[_];r.set(a)}else ke.panic('Attribute "au_center_pos" is missing in particle submesh');return T(e.submesh_bd,t),e},t.bounding_data_apply_transform=T,t.submesh_apply_params=function(e,t){var r=e.base_length;for(var a in t){var n=t[a].length;e.va_common[a]=new Float32Array(n*r);for(var _=0;_<r;_++)for(var s=0;s<n;s++)e.va_common[a][_*n+s]=t[a][s]}return e},t.submesh_list_join=x,t.make_propagated_submesh=function(e,t,r){if(!e.base_length)return ce("EMPTY");var a=r.length;e.base_length*a>Fe&&!Ae.get_elem_index_uint()&&s(e,a);var n=e.indices,_=e.base_length,o=e.va_common,i=e.va_frames;for(var l in t){var c=t[l].length,u=c*_;for(o[l]=new Float32Array(u),g=0;g<_;g++)for(p=0;p<c;p++)o[l][g*c+p]=t[l][p]}var d=ce("CLONE_"+a+"_SUBMESHES");for(d.base_length=_*a,d.indices=new Uint32Array(n.length*a),g=0;g<a;g++)for(var f=n.length*g,m=_*g,p=0;p<n.length;p++){var h=n[p];d.indices[f+p]=h+m}for(var v in o){var u=(y=o[v]).length*a,b=Y(y,_);for(d.va_common[v]=new Float32Array(u),g=0;g<a;g++)m=_*b*g,d.va_common[v].set(y,m)}for(var v in i[0])for(var g=0;g<i.length;g++){var y=i[g][v],u=y.length*a,b=Y(y,_);for(d.va_frames[g]=d.va_frames[g]||{},d.va_frames[g][v]=new Float32Array(u),p=0;p<a;p++){var E=r[p],m=_*b*p;switch(v){case"a_position":Re.transform_vectors(y,E,d.va_frames[g][v],m);break;case"a_tbn":Re.transform_quats(y,E,d.va_frames[g][v],m);break;case"a_shade_tangs":Re.transform_tangents(y,E,d.va_frames[g][v],m);break;default:ke.panic("Wrong attribute name: "+v)}}}return R(e,d,r),d},t.calc_unit_boundings=R,t.extract_submesh=k,t.extract_halo_submesh=function(e){for(var t=e.base_length,r=e.va_frames[0].a_position,a=new Float32Array(12*t),n=new Uint32Array(4*e.indices.length),_=new Float32Array(4*t),s=0;s<t;s++){a[12*s]=r[3*s],a[12*s+1]=r[3*s+1],a[12*s+2]=r[3*s+2],a[12*s+3]=r[3*s],a[12*s+4]=r[3*s+1],a[12*s+5]=r[3*s+2],a[12*s+6]=r[3*s],a[12*s+7]=r[3*s+1],a[12*s+8]=r[3*s+2],a[12*s+9]=r[3*s],a[12*s+10]=r[3*s+1],a[12*s+11]=r[3*s+2],n[6*s]=4*s+2,n[6*s+1]=4*s+1,n[6*s+2]=4*s,n[6*s+3]=4*s+2,n[6*s+4]=4*s,n[6*s+5]=4*s+3;var o=Math.random();_[4*s]=o,_[4*s+1]=o,_[4*s+2]=o,_[4*s+3]=o}var i=ce("HALO");return i.va_frames[0]={},i.base_length=4*t,i.va_frames[0].a_position=a,i.va_common.a_halo_bb_vertex=oe(t),i.va_common.a_random_vals=_,i.indices=n,i},t.has_attr=B,t.extract_submesh_all_mats=function(e,t,r){for(var a=[],n=0;n<e.submeshes.length;n++){var _=k(e,n,t,null,r,null);_.base_length&&a.push(_)}if(0==a.length)s=ce("EMPTY");else if(1==a.length)s=a[0];else var s=x(a);return s},t.update_buffers_movable=function(e,t,r,a){var n=e.ibo_array,_=u(e,"a_position"),s=t.median_cache,o=t.median_world_cache,i=t.dist_cache;H(n,_,s),Re.transform_vectors(s,r,o),W(o,a,i),n=q(i,n),qe.bindBuffer(qe.ELEMENT_ARRAY_BUFFER,e.ibo),qe.bufferData(qe.ELEMENT_ARRAY_BUFFER,n,qe.DYNAMIC_DRAW)},t.sort_two_arrays=V,t.calc_normals=function(e,t,r){for(var a=t.length/Ge,n=e.length/3,_=[],s=new Array(3),o=new Array(3),i=new Array(3),l=0;l<n;l++){for(var c=e[3*l],u=e[3*l+1],d=e[3*l+2],f=0;f<Ge;f++)s[f]=t[Ge*c+f],o[f]=t[Ge*u+f],i[f]=t[Ge*d+f];if(r)var m=K(s,o,i),p=K(o,i,s),h=Math.PI-m-p;else var m=1,p=1,h=1;Z(c,u,d,s,o,i,m,p,h,_)}for(r&&J(r,_),l=0;l<a;l++)$(l,_);return _},t.calc_shared_indices=function(e,t,r){for(var a={},n=t.length/3,_=0;_<n;_++)a[i=String(t[3*_])+String(t[3*_+1])+String(t[3*_+2])]=[];for(var s=e.length,_=0;_<s;_++){var o=e[_],i=String(r[3*o])+String(r[3*o+1])+String(r[3*o+2]);i in a&&a[i].push(o)}return a},t.geometry_random_points=function(e,t,r,a){var n=ee(e,null);if(r)var _=te(e,null);for(var s=n.length,o=new Float32Array(s),i=Le,l=Ce,c=Pe,u=0;u<s;u++)v=n[u],i.set(v.subarray(0,3)),l.set(v.subarray(3,6)),c.set(v.subarray(6)),o[u]=ne(i,l,c);var d=new Float32Array(s);for(d[0]=o[0],u=1;u<s;u++)d[u]=d[u-1]+o[u];for(var f=d[o.length-1],m=[],u=0;u<t;u++){var p=f*ke.rand_r(a),h=ke.binary_search_max(d,p,0,d.length-1);if(r)v=_[h];else var v=n[h];var b=se(v,a,Le);if(r){m[u]=new Float32Array(4),Ne.normalize(b,b);var g=xe.rotationTo(ke.AXIS_Y,b,De);m[u][0]=g[0],m[u][1]=g[1],m[u][2]=g[2],m[u][3]=g[3]}else m[u]=new Float32Array(3),m[u][0]=b[0],m[u][1]=b[1],m[u][2]=b[2]}return m},t.extract_polyindices=ae,t.triangle_area_squared=_e,t.gen_bb_vertices=oe,t.scale_submesh_xyz=function(e,t,r){for(var a=e.va_frames[0].a_position,n=0;n<a.length;n+=3)a[n]=(a[n]-r[0])*t[0]+r[0],a[n+1]=(a[n+1]-r[1])*t[1]+r[1],a[n+2]=(a[n+2]-r[2])*t[2]+r[2]},t.apply_shape_key=function(e,t,r){for(var a=e.scenes_data[0].batches,n=e.render.shape_keys_values,_=1;_<n.length;_++)n[_].name==t&&(n[_].value=r);for(_=0;_<a.length;_++)if(!a[_].forked_batch&&a[_].use_shape_keys&&!a[_].debug_sphere){var s=a[_].bufs_data,o=be("a_position"),i=pe(s.vbo_data,o),l=he(s.vbo_source_data,o);qe.bindBuffer(qe.ARRAY_BUFFER,i),ie(s.pointers.a_position,a[_],l,n);var c=be("a_tbn"),u=pe(s.vbo_data,c),d=he(s.vbo_source_data,c);qe.bindBuffer(qe.ARRAY_BUFFER,u),le(s.pointers.a_tbn,a[_],d,n)}},t.check_shape_keys=function(e){return e.render.use_shape_keys},t.get_shape_keys_names=function(e){var t=[];if(e.render)for(var r=1;r<e.render.shape_keys_values.length;r++)t.push(e.render.shape_keys_values[r].name);return t},t.get_shape_key_value=function(e,t){if(e.render)for(var r=1;r<e.render.shape_keys_values.length;r++)if(t==e.render.shape_keys_values[r].name)return e.render.shape_keys_values[r].value;return 0},t.has_shape_key=function(e,t){var r=e.render.shape_keys_values;if(r)for(var a=1;a<r.length;a++)if(r[a].name==t)return!0;return!1},t.has_dyn_geom=function(e){return!!(e&&e.render&&e.render.dynamic_geometry)},t.draw_line=function(e,r,a){var n=e.bufs_data;if(n){if(a)_=r.length/3/2;else var _=r.length/3-1;for(var s=new Float32Array(4*_*3),o=new Float32Array(4*_*3),i=new Uint16Array(6*_),l=0;l<_;l++){if(a)var c=6*l,u=6*l+3;else var c=3*l,u=3*(l+1);var d=r[c],f=r[c+1],m=r[c+2],p=r[u],h=r[u+1],v=r[u+2],b=p-d,g=h-f,y=v-m;s[4*l*3]=d,s[4*l*3+1]=f,s[4*l*3+2]=m,o[4*l*3]=b,o[4*l*3+1]=g,o[4*l*3+2]=y,s[4*l*3+3]=p,s[4*l*3+4]=h,s[4*l*3+5]=v,o[4*l*3+3]=-b,o[4*l*3+4]=-g,o[4*l*3+5]=-y,s[4*l*3+6]=d,s[4*l*3+7]=f,s[4*l*3+8]=m,o[4*l*3+6]=-b,o[4*l*3+7]=-g,o[4*l*3+8]=-y,s[4*l*3+9]=p,s[4*l*3+10]=h,s[4*l*3+11]=v,o[4*l*3+9]=b,o[4*l*3+10]=g,o[4*l*3+11]=y,i[6*l]=4*l,i[6*l+1]=4*l+1,i[6*l+2]=4*l+2,i[6*l+3]=4*l,i[6*l+4]=4*l+3,i[6*l+5]=4*l+1}var E=0;for(var w in n.pointers)R=n.pointers[w],E+=s.length/3*R.num_comp;var T={};T[Ve]=E;var x=n.vbo_source_data=ue(T);t.update_bufs_data_index_array(n,e.draw_mode,i);var O=0;for(var w in n.pointers){var R=n.pointers[w];switch(w){case"a_position":ge(x,w,s,O),R.offset=O,R.length=s.length,O+=R.length;break;case"a_direction":ge(x,w,o,O),R.offset=O,R.length=o.length,O+=R.length;break;default:R.offset=O,R.length=s.length/3*R.num_comp,ge(x,w,new Float32Array(R.length),O),O+=R.length}}A(n)}},t.clone_bufs_data=function(e){if(e){if(t=i(),e.ibo_array)switch(e.ibo_type){case qe.UNSIGNED_SHORT:t.ibo_array=new Uint16Array(e.ibo_array);break;case qe.UNSIGNED_INT:t.ibo_array=new Uint32Array(e.ibo_array)}else t.ibo_array=null;t.vbo_source_data=fe(e.vbo_source_data),t.ibo_type=e.ibo_type,t.count=e.count,t.pointers=ke.clone_object_r(e.pointers),t.usage=e.usage,t.debug_ibo_bytes=e.debug_ibo_bytes,t.debug_vbo_bytes=e.debug_vbo_bytes,t.ibo=null,t.info_for_z_sort_updates=ke.clone_object_r(e.info_for_z_sort_updates),t.shape_keys=ke.clone_object_r(e.shape_keys),t.instance_count=e.instance_count,t.cleanup_gl_data_on_unload=e.cleanup_gl_data_on_unload}else var t=null;return t},t.init_submesh=ce,t.clone_submesh=function(e){var t=ce(e.name);return t.base_length=e.base_length,t.indices=ke.clone_object_r(e.indices),t.va_frames=ke.clone_object_r(e.va_frames),t.va_common=ke.clone_object_r(e.va_common),t.shape_keys=ke.clone_object_r(e.shape_keys),we.copy_bb(e.submesh_bd.bb_local,t.submesh_bd.bb_local),we.copy_be(e.submesh_bd.be_local,t.submesh_bd.be_local),we.copy_bs(e.submesh_bd.bs_local,t.submesh_bd.bs_local),we.copy_rot_bb(e.submesh_bd.bbr_local,t.submesh_bd.bbr_local),t.instanced_array_data=ke.clone_object_r(e.instanced_array_data),t},t.reset=function(){qe=null},t.init_vbo_source_data=ue,t.search_vbo_index_by_type=me,t.get_vbo_by_type=pe,t.get_vbo_source_by_type=he,t.get_constructor_by_type=ve,t.get_vbo_type_by_attr_name=be,t.get_type_size_by_attr_name=function(e){switch(be(e)){case Ve:return ke.FLOAT_SIZE;case Xe:return ke.SHORT_SIZE;case Ke:return ke.BYTE_SIZE;default:return ke.FLOAT_SIZE}},t.get_gl_type_by_attr_name=function(e){switch(be(e)){case Ve:return qe.FLOAT;case Xe:return qe.SHORT;case Ke:return qe.UNSIGNED_BYTE;default:return qe.FLOAT}},t.vbo_source_data_set_attr=ge,t.value_vbo_to_float=function(e,t){switch(be(e)){case Ve:return t;case Xe:return ke.short_to_float(t);case Ke:return ke.ubyte_to_ufloat(t)}return t},t.value_float_to_vbo=function(e,t){switch(be(e)){case Ve:return t;case Xe:return ke.float_to_short(t);case Ke:return ke.ufloat_to_ubyte(t)}return t},t.array_vbo_to_float=ye,t.array_float_to_vbo=Ee}),A=o("__subscene",function(e,t){function r(e,t){e.num_lights=t,e.light_directions=new Float32Array(3*t),e.light_positions=new Float32Array(4*t),e.light_color_intensities=new Float32Array(4*t)}function a(e){var t={type:e,subtype:"",force_do_not_render:!1,do_render:!1,enqueue:!1,clear_color:!1,clear_depth:!1,depth_test:!1,blend:!1,pack:!1,assign_texture:!1,need_fog_update:!1,need_perm_uniforms_update:!1,debug_render_calls:0,debug_render_time:0,debug_render_time_queries:[],debug_view_mode:0,debug_colors_seed:0,debug_render_time_threshold:1,do_not_debug:!1,time:0,camera:null,cube_view_matrices:null,cube_cam_frustums:[],draw_data:[],slinks_internal:[],textures_internal:[],wind:new Float32Array(3),grass_map_dim:new Float32Array(3),fog_color_density:new Float32Array(4),fog_params:new Float32Array(4),cube_fog:new Float32Array(16),sky_tex_default_value:0,environment_energy:0,num_lights:0,light_directions:null,light_positions:null,light_color_intensities:null,light_factors:null,horizon_color:new Float32Array(3),zenith_color:new Float32Array(3),sky_tex_fac:new Float32Array(4),sun_intensity:new Float32Array(3),sun_direction:new Float32Array([0,0,1]),sun_quaternion:new Float32Array(4),sky_tex_color:new Float32Array(3),sky_ngraph_proxy_id:"",bsdf_cube_sky_dim:0,outline_factor:0,draw_outline_flag:0,is_for_outline:!1,outline_color:new Float32Array(3),water:!1,cam_water_depth:0,water_fog_color_density:new Float32Array(4),water_level:0,caustics:!1,caust_scale:0,caust_speed:new Float32Array(2),caust_brightness:0,procedural_skydome:!1,use_as_environment_lighting:!1,mie_brightness:0,rayleigh_brightness:0,spot_brightness:0,mie_strength:0,rayleigh_strength:0,scatter_strength:0,mie_collection_power:0,rayleigh_collection_power:0,mie_distribution:0,sky_color:new Float32Array(3),ssao_hemisphere:!1,ssao_blur_depth:!1,ssao_blur_discard_value:0,ssao_radius_increase:0,ssao_influence:0,ssao_dist_factor:0,ssao_samples:0,ssao_only:!1,ssao_white:!1,brightness:0,contrast:0,exposure:0,saturation:0,god_rays_intensity:0,max_ray_length:0,radial_blur_step:0,steps_per_pass:0,csm_index:0,self_shadow_polygon_offset:0,self_shadow_normal_offset:0,v_light_ts:null,v_light_r:null,v_light_tsr:null,p_light_matrix:null,is_pp:!1,fxaa_quality:"",bloom_key:0,bloom_blur:0,bloom_edge_lum:0,adaptive_bloom:!0,average_luminance:0,blur_texel_size_mult:0,ext_texel_size_mult:0,mb_decay_threshold:0,mb_factor:0,motion_blur_exp:0,pp_effect:"",coc_type:"",jitter_projection_space:new Float32Array(2),last_mip_map_ind:0,bloom_blur_num:2,bloom_blur_scale:.5,small_glow_mask_width:0,large_glow_mask_width:0,small_glow_mask_coeff:0,large_glow_mask_coeff:0,texel_size_multiplier:0,texel_size:new Float32Array(2),texel_mask:new Float32Array(2),distortion_params:new Float32Array(4),chromatic_aberration_coefs:new Float32Array(4),enable_hmd_stereo:!1,shadow_lamp_index:0,need_draw_data_sort:!0,sky_invert:!1,sky_use_rgb_to_intensity:!1,sky_use_map_blend:!1,sky_use_map_horizon:!1,sky_use_map_zenith_up:!1,sky_use_map_zenith_down:!1,sky_blend_type:"",use_sky_blend:!1,use_sky_paper:!1,use_sky_real:!1};return t.do_render=!0,t.enqueue=!0,t.clear_color=!0,t.clear_depth=!0,t.depth_test=!0,t.need_perm_uniforms_update=!0,t.texel_size_multiplier=1,t.texel_mask[0]=1,t.texel_mask[1]=1,t.distortion_params[2]=.5,t.distortion_params[3]=.5,t.ssao_samples=8,t}function n(e,t,r){var a=t;a.fog_color_density&&e.water_fog_color_density.set(a.fog_color_density),e.water_level=a.water_level,a.caustics&&r&&(e.caustics=!0,e.caust_scale=a.caustic_scale,e.caust_brightness=a.caustic_brightness,e.caust_speed.set(a.caustic_speed))}function _(e,t,r,a,n){return{shader:e,bundles:[t],alpha_antialiasing:r,offset_z:a,is_sky:n,do_render:!0,z_index:1/0}}function s(e,t,r,a,n){for(var _=0;_<e.length;_++){var s=e[_];if(s.shader==t&&s.alpha_antialiasing==r&&s.offset_z==a&&s.is_sky==n)return s}return null}function o(e,t){return e==t?0:e>t?1:-1}function i(e,t){return o(e.alpha_antialiasing,t.alpha_antialiasing)||o(e.is_sky,t.is_sky)||o(e.offset_z,t.offset_z)||o(e.shader.has_discard,t.shader.has_discard)||o(e.z_index,t.z_index)}var l=ue(e),c=g(e),u=h(e),d=b(e),f=c.outlining;t.MAIN_OPAQUE=0,t.MAIN_BLEND=1,t.MAIN_XRAY=2,t.MAIN_PLANE_REFLECT=3,t.MAIN_CUBE_REFLECT=4,t.MAIN_PLANE_REFLECT_BLEND=5,t.MAIN_CUBE_REFLECT_BLEND=6,t.MAIN_GLOW=7,t.SHADOW_CAST=8,t.SHADOW_RECEIVE=9,t.GRASS_MAP=10,t.POSTPROCESSING=11,t.GLOW_COMBINE=13,t.RESOLVE=14,t.COLOR_PICKING=15,t.COLOR_PICKING_XRAY=16,t.DEBUG_VIEW=17,t.ANCHOR_VISIBILITY=18,t.DEPTH_PACK=19,t.SSAO=20,t.SSAO_BLUR=21,t.ANTIALIASING=22,t.SMAA_BLENDING_WEIGHT_CALCULATION=23,t.SMAA_EDGE_DETECTION=24,t.SMAA_RESOLVE=25,t.SMAA_NEIGHBORHOOD_BLENDING=26,t.COMPOSITING=27,t.MOTION_BLUR=28,t.COC=29,t.DOF=30,t.OUTLINE_MASK=31,t.OUTLINE=32,t.GOD_RAYS=33,t.GOD_RAYS_COMBINE=34,t.SKY=35,t.COPY=36,t.STEREO=37,t.LUMINANCE=38,t.AVERAGE_LUMINANCE=39,t.LUMINANCE_TRUNCED=40,t.BLOOM=41,t.VELOCITY=42,t.SINK=43,t.PERFORMANCE=44,t.RESIZE=45,t.IRRADIANCE=46,t.ROUGHNESS_CONVOLUTION=47,t.BRDF=48,t.create_subs_shadow_cast=function(e,t,n,_){var s=a(8);switch(s.csm_index=e,s.self_shadow_polygon_offset=n.self_shadow_polygon_offset,s.shadow_lamp_index=t,n.lamp_types[t]){case"SPOT":case"POINT":s.camera=l.create_camera(l.TYPE_PERSP);var o=n.spot_sizes[t],i=n.clip_start[t],c=n.clip_end[t];l.set_frustum(s.camera,o,i,c);break;default:s.camera=l.create_camera(l.TYPE_ORTHO_ASYMMETRIC)}return r(s,_),s},t.clone_subs=function(e){var t=a(e.type);return t.subtype=e.subtype,t.force_do_not_render=e.force_do_not_render,t.do_render=e.do_render,t.enqueue=e.enqueue,t.clear_color=e.clear_color,t.clear_depth=e.clear_depth,t.depth_test=e.depth_test,t.blend=e.blend,t.pack=e.pack,t.assign_texture=e.assign_texture,t.need_fog_update=e.need_fog_update,t.need_perm_uniforms_update=e.need_perm_uniforms_update,t.debug_render_calls=0,t.debug_render_time=0,t.debug_render_time_queries=[],t.debug_view_mode=e.debug_view_mode,t.debug_colors_seed=e.debug_colors_seed,t.debug_render_time_threshold=e.debug_render_time_threshold,t.do_not_debug=e.do_not_debug,t.time=e.time,t.camera=l.clone_camera(e.camera,!0),t.cube_view_matrices=u.clone_object_r(e.cube_view_matrices),t.cube_cam_frustums=u.clone_object_r(e.cube_cam_frustums),t.draw_data=u.clone_object_r(e.draw_data),t.slinks_internal=u.clone_object_r(e.slinks_internal),t.textures_internal=u.clone_object_r(e.textures_internal),t.wind.set(e.wind),t.grass_map_dim.set(e.grass_map_dim),t.fog_color_density.set(e.fog_color_density),t.fog_params.set(e.fog_params),t.cube_fog.set(e.cube_fog),t.sky_tex_default_value=e.sky_tex_default_value,t.environment_energy=e.environment_energy,t.num_lights=e.num_lights,t.light_directions=u.clone_object_r(e.light_directions),t.light_positions=u.clone_object_r(e.light_positions),t.light_color_intensities=u.clone_object_r(e.light_color_intensities),t.light_factors=u.clone_object_r(e.light_factors),t.horizon_color.set(e.horizon_color),t.zenith_color.set(e.zenith_color),t.sky_tex_fac.set(e.sky_tex_fac),t.sun_intensity.set(e.sun_intensity),t.sun_direction.set(e.sun_direction),t.sun_quaternion.set(e.sun_quaternion),t.sky_tex_color.set(e.sky_tex_color),t.sky_ngraph_proxy_id=e.sky_ngraph_proxy_id,t.bsdf_cube_sky_dim=e.bsdf_cube_sky_dim,t.outline_factor=e.outline_factor,t.draw_outline_flag=e.draw_outline_flag,t.is_for_outline=e.is_for_outline,t.outline_color.set(e.outline_color),t.water=e.water,t.cam_water_depth=e.cam_water_depth,t.water_fog_color_density.set(e.water_fog_color_density),t.water_level=e.water_level,t.caustics=e.caustics,t.caust_scale=e.caust_scale,t.caust_speed.set(e.caust_speed),t.caust_brightness=e.caust_brightness,t.procedural_skydome=e.procedural_skydome,t.use_as_environment_lighting=e.use_as_environment_lighting,t.mie_brightness=e.mie_brightness,t.rayleigh_brightness=e.rayleigh_brightness,t.spot_brightness=e.spot_brightness,t.mie_strength=e.mie_strength,t.rayleigh_strength=e.rayleigh_strength,t.scatter_strength=e.scatter_strength,t.mie_collection_power=e.mie_collection_power,t.rayleigh_collection_power=e.rayleigh_collection_power,t.mie_distribution=e.mie_distribution,t.sky_color.set(e.sky_color),t.ssao_hemisphere=e.ssao_hemisphere,t.ssao_blur_depth=e.ssao_blur_depth,t.ssao_blur_discard_value=e.ssao_blur_discard_value,t.ssao_radius_increase=e.ssao_radius_increase,t.ssao_influence=e.ssao_influence,t.ssao_dist_factor=e.ssao_dist_factor,t.ssao_samples=e.ssao_samples,t.ssao_only=e.ssao_only,t.ssao_white=e.ssao_white,t.brightness=e.brightness,t.contrast=e.contrast,t.exposure=e.exposure,t.saturation=e.saturation,t.god_rays_intensity=e.god_rays_intensity,t.max_ray_length=e.max_ray_length,t.radial_blur_step=e.radial_blur_step,t.steps_per_pass=e.steps_per_pass,t.csm_index=e.csm_index,t.self_shadow_polygon_offset=e.self_shadow_polygon_offset,t.self_shadow_normal_offset=e.self_shadow_normal_offset,t.v_light_ts=u.clone_object_r(e.v_light_ts),t.v_light_r=u.clone_object_r(e.v_light_r),t.v_light_tsr=u.clone_object_r(e.v_light_tsr),t.p_light_matrix=u.clone_object_r(e.p_light_matrix),t.is_pp=e.is_pp,t.fxaa_quality=e.fxaa_quality,t.bloom_key=e.bloom_key,t.bloom_blur=e.bloom_blur,t.bloom_edge_lum=e.bloom_edge_lum,t.adaptive_bloom=e.adaptive_bloom,t.average_luminance=e.average_luminance,t.blur_texel_size_mult=e.blur_texel_size_mult,t.ext_texel_size_mult=e.ext_texel_size_mult,t.mb_decay_threshold=e.mb_decay_threshold,t.mb_factor=e.mb_factor,t.motion_blur_exp=e.motion_blur_exp,t.pp_effect=e.pp_effect,t.coc_type=e.coc_type,t.jitter_projection_space.set(e.jitter_projection_space),t.last_mip_map_ind=e.last_mip_map_ind,t.bloom_blur_num=e.bloom_blur_num,t.bloom_blur_scale=e.bloom_blur_scale,t.small_glow_mask_width=e.small_glow_mask_width,t.large_glow_mask_width=e.large_glow_mask_width,t.small_glow_mask_coeff=e.small_glow_mask_coeff,t.large_glow_mask_coeff=e.large_glow_mask_coeff,t.texel_size_multiplier=e.texel_size_multiplier,t.texel_size.set(e.texel_size),t.texel_mask.set(e.texel_mask),t.distortion_params.set(e.distortion_params),t.chromatic_aberration_coefs.set(e.chromatic_aberration_coefs),t.enable_hmd_stereo=e.enable_hmd_stereo,t.shadow_lamp_index=e.shadow_lamp_index,t.need_draw_data_sort=e.need_draw_data_sort,t.sky_invert=e.sky_invert,t.sky_use_rgb_to_intensity=e.sky_use_rgb_to_intensity,t.sky_use_map_blend=e.sky_use_map_blend,t.sky_use_map_horizon=e.sky_use_map_horizon,t.sky_use_map_zenith_up=e.sky_use_map_zenith_up,t.sky_use_map_zenith_down=e.sky_use_map_zenith_down,t.sky_blend_type=e.sky_blend_type,t.use_sky_blend=e.use_sky_blend,t.use_sky_paper=e.use_sky_paper,t.use_sky_real=e.use_sky_real,t},t.create_subs_grass_map=function(){var e=a(10);return e.camera=l.create_camera(l.TYPE_ORTHO_ASPECT),e},t.create_subs_postprocessing=function(e){var t=a(11);switch(t.clear_color=!1,t.clear_depth=!1,t.depth_test=!1,t.is_pp=!0,t.camera=l.create_camera(l.TYPE_NONE),t.pp_effect=e,e){case"NONE":case"GRAYSCALE":t.texel_mask[0]=1,t.texel_mask[1]=1;break;case"X_BLUR":t.texel_mask[0]=1,t.texel_mask[1]=0;break;case"Y_BLUR":t.texel_mask[0]=0,t.texel_mask[1]=1;break;case"X_GLOW_BLUR":t.texel_mask[0]=1,t.texel_mask[1]=0;break;case"Y_GLOW_BLUR":t.texel_mask[0]=0,t.texel_mask[1]=1;break;case"X_BLOOM_BLUR":t.texel_mask[0]=1,t.texel_mask[1]=0;break;case"Y_BLOOM_BLUR":t.texel_mask[0]=0,t.texel_mask[1]=1;break;case"X_DOF_BLUR":case"Y_DOF_BLUR":t.texel_mask[0]=1,t.texel_mask[1]=1;break;case"X_ALPHA_BLUR":t.texel_mask[0]=1,t.texel_mask[1]=0,t.texel_size_multiplier=3;break;case"Y_ALPHA_BLUR":t.texel_mask[0]=0,t.texel_mask[1]=1,t.texel_size_multiplier=3;break;case"X_EXTEND":t.texel_mask[0]=1,t.texel_mask[1]=0;break;case"Y_EXTEND":t.texel_mask[0]=0,t.texel_mask[1]=1;break;default:u.panic("Wrong postprocessing effect: "+e)}return t},t.create_subs_glow_combine=function(e,t){var r=a(13);return r.clear_color=!1,r.clear_depth=!1,r.depth_test=!1,r.small_glow_mask_coeff=t.glow_params.small_glow_mask_coeff,r.large_glow_mask_coeff=t.glow_params.large_glow_mask_coeff,r.small_glow_mask_width=t.glow_params.small_glow_mask_width,r.large_glow_mask_width=t.glow_params.large_glow_mask_width,r.camera=e,r.is_pp=!0,r},t.create_subs_main=function(e,t,_,s,o,i,l,c,d){var f=a(e);0==e?(f.clear_color=!0,f.clear_depth=_,f.blend=!1):1==e?(f.clear_color=!1,f.clear_depth=!1,f.blend=!0):2==e?(f.clear_color=!1,f.clear_depth=!0,f.blend=!0):3==e||4==e?(f.clear_color=!0,f.clear_depth=!0,f.blend=!1):5==e||6==e?(f.clear_color=!1,f.clear_depth=!1,f.blend=!0):7==e?(f.clear_color=!0,f.clear_depth=!1,f.blend=!0):u.panic("wrong main subscene type"),f.blend&&c&&(f.self_shadow_normal_offset=c.self_shadow_normal_offset),f.camera=t;var m=l.sky_texture_param;return m&&(f.sky_tex_fac.set([m.blend_factor,m.horizon_factor,m.zenith_up_factor,m.zenith_down_factor]),f.sky_tex_color.set(m.color),f.sky_tex_default_value=m.default_value),f.horizon_color.set(l.horizon_color),f.zenith_color.set(l.zenith_color),f.environment_energy=l.environment_energy,f.fog_color_density=i.fog_color_density,f.fog_params=i.fog_params,s&&n(f,s,d),r(f,o),f},t.create_subs_resolve=function(){var e=a(14);return e.is_pp=!0,e.camera=l.create_camera(l.TYPE_NONE),e},t.create_subs_color_picking=function(e,t,n){var _=a(15);return t&&(_.type=16,_.clear_color=!1,_.clear_depth=!0),_.enqueue=!1,_.camera=e,r(_,n),_},t.create_subs_debug_view=function(e){var t=a(17);return t.do_render=!1,t.clear_color=!1,t.clear_depth=!1,t.camera=e,t},t.create_subs_anchor_visibility=function(e){var t=a(18);return t.clear_color=!0,t.clear_depth=!1,t.camera=e,t},t.create_subs_shadow_receive=function(e,t,n){var _=a(9);return _.camera=t,r(_,n),_},t.create_subs_depth_pack=function(e){var t=a(19);return t.clear_color=!1,t.clear_depth=!1,t.camera=e,t.is_pp=!0,t},t.create_subs_ssao=function(e,t,r){var n=a(20);return n.clear_color=!1,n.clear_depth=!1,n.depth_test=!1,n.camera=e,n.fog_color_density=t.fog_color_density,n.water_fog_color_density.set(t.fog_color_density),n.ssao_radius_increase=r.radius_increase,n.ssao_hemisphere=r.hemisphere,n.ssao_influence=r.influence,n.ssao_dist_factor=r.dist_factor,n.ssao_samples=r.samples,n.is_pp=!0,n},t.create_subs_ssao_blur=function(e,t){var r=a(21);return r.clear_color=!1,r.clear_depth=!1,r.depth_test=!1,r.camera=e,r.ssao_blur_depth=t.blur_depth,r.ssao_blur_discard_value=t.blur_discard_value,r.is_pp=!0,r},t.create_subs_aa=function(e){var t=a(22);return t.clear_color=!1,t.clear_depth=!1,t.depth_test=!1,t.texel_size_multiplier=1/e.resolution_factor,t.fxaa_quality=e.aa_quality,t.camera=l.create_camera(l.TYPE_NONE),t.is_pp=!0,t},t.create_subs_smaa=function(e,t){var r=a(e);return r.clear_color=23==e||24==e,r.clear_depth=!1,r.depth_test=!1,r.texel_size_multiplier=1/t.resolution_factor,r.camera=l.create_camera(l.TYPE_NONE),23==e&&(r.jitter_subsample_ind=new Float32Array(4)),r.is_pp=!0,r},t.create_subs_compositing=function(e,t,r,n){var _=a(27);return _.clear_color=!1,_.clear_depth=!1,_.depth_test=!1,_.camera=l.create_camera(l.TYPE_NONE),_.brightness=e,_.contrast=t,_.exposure=r,_.saturation=n,_.is_pp=!0,_},t.create_subs_motion_blur=function(e,t){var r=a(28);return r.clear_color=!1,r.clear_depth=!1,r.depth_test=!1,r.camera=l.create_camera(l.TYPE_NONE),r.assign_texture=!0,r.mb_decay_threshold=e,r.mb_factor=t,r.is_pp=!0,r},t.create_subs_coc=function(e,t){var r=a(29);return r.clear_color=!1,r.clear_depth=!1,r.depth_test=!1,r.camera=e,r.texel_size_multiplier=r.camera.dof_power,r.coc_type=t,r.is_pp=!0,r},t.create_subs_dof=function(e){var t=a(30);return t.clear_color=!1,t.clear_depth=!1,t.depth_test=!1,t.camera=e,t.texel_size_multiplier=t.camera.dof_power,t.is_pp=!0,t},t.create_subs_outline_mask=function(e,t){var n=a(31);return n.depth_test=!1,n.camera=e,r(n,t),n},t.create_subs_outline=function(e){var t=a(32);return f.outlining_overview_mode?t.outline_color.set(f.outline_color):t.outline_color.set(e.outline_color),t.outline_factor=e.outline_factor,t.ext_texel_size_mult=5,t.blur_texel_size_mult=3,t.depth_test=!1,t.camera=l.create_camera(l.TYPE_NONE),t.is_pp=!0,t},t.create_subs_god_rays=function(e,t,n,_,s,o,i){var l=a(33);return l.clear_color=!1,l.clear_depth=!1,l.depth_test=!1,l.horizon_color=new Float32Array([1,1,1]),l.zenith_color=new Float32Array([1,1,1]),l.environment_energy=1,l.pack=_,l.water=t,l.radial_blur_step=s,l.max_ray_length=n,l.steps_per_pass=i,l.camera=e,r(l,o),l},t.create_subs_god_rays_comb=function(e,t){var n=a(34);return n.clear_color=!1,n.clear_depth=!1,n.depth_test=!1,n.camera=l.create_camera(l.TYPE_NONE),n.god_rays_intensity=e,r(n,t),n.is_pp=!0,n},t.create_subs_sky=function(e,t,n,_){var s=a(35);s.enqueue=!1,s.clear_color=!1,s.clear_depth=!1,s.depth_test=!1;var o=l.create_camera(l.TYPE_NONE);if(o.width=_,o.height=_,s.camera=o,s.cube_view_matrices=u.generate_cubemap_matrices(),r(s,t),s.horizon_color=new Float32Array([1,1,1]),s.zenith_color=new Float32Array([1,1,1]),s.environment_energy=1,s.sky_color.set(n.sky_color),s.procedural_skydome=n.procedural_skydome,s.use_as_environment_lighting=n.use_as_environment_lighting,s.rayleigh_brightness=n.rayleigh_brightness,s.mie_brightness=n.mie_brightness,s.spot_brightness=n.spot_brightness,s.scatter_strength=n.scatter_strength,s.rayleigh_strength=n.rayleigh_strength,s.mie_strength=n.mie_strength,s.rayleigh_collection_power=n.rayleigh_collection_power,s.mie_collection_power=n.mie_collection_power,s.mie_distribution=n.mie_distribution,e){s.horizon_color.set(e.horizon_color),s.zenith_color.set(e.zenith_color),s.environment_energy=e.environment_energy;var i=e.sky_texture_param;i&&(s.sky_tex_fac.set([i.blend_factor,i.horizon_factor,i.zenith_up_factor,i.zenith_down_factor]),s.sky_tex_color.set(i.color),s.sky_tex_default_value=i.default_value,s.sky_invert=i.invert,s.sky_use_rgb_to_intensity=i.use_rgb_to_intensity,s.sky_use_map_blend=i.use_map_blend,s.sky_use_map_horizon=i.use_map_horizon,s.sky_use_map_zenith_up=i.use_map_zenith_up,s.sky_use_map_zenith_down=i.use_map_zenith_down,s.sky_blend_type=i.blend_type),s.use_sky_blend=e.use_sky_blend,s.use_sky_paper=e.use_sky_paper,s.use_sky_real=e.use_sky_real,s.sky_ngraph_proxy_id=e.ngraph_proxy_id}return s},t.create_subs_irradiance=function(e,t){var n=a(46);n.enqueue=!1,n.clear_color=!1,n.clear_depth=!1,n.depth_test=!1;var _=l.create_camera(l.TYPE_NONE);return _.width=t,_.height=t,n.camera=_,n.cube_view_matrices=u.generate_cubemap_matrices(),r(n,e),n},t.create_subs_rougness_convolution=function(e){var t=a(47);t.enqueue=!1,t.clear_color=!1,t.clear_depth=!1,t.depth_test=!1;var n=l.create_camera(l.TYPE_NONE);return n.width=128,n.height=128,t.camera=n,t.cube_view_matrices=u.generate_cubemap_matrices(),r(t,e),t},t.create_subs_brdf=function(){var e=a(48);e.enqueue=!1,e.clear_color=!1,e.clear_depth=!1,e.depth_test=!1;var t=l.create_camera(l.TYPE_NONE);return t.width=512,t.height=512,e.camera=t,e},t.create_subs_copy=function(){var e=a(36);return e.clear_color=!1,e.clear_depth=!1,e.camera=l.create_camera(l.TYPE_NONE),e.is_pp=!0,e},t.create_subs_stereo=function(e,t){var r=a(37);return r.clear_color=!1,r.clear_depth=!1,r.subtype=e?"HMD":t?"ANAGLYPH":"SIDEBYSIDE",r.camera=l.create_camera(l.TYPE_NONE),r.is_pp=!0,r},t.create_subs_luminance=function(){var e=a(38);return e.clear_color=!1,e.clear_depth=!1,e.camera=l.create_camera(l.TYPE_NONE),e.is_pp=!0,e},t.create_subs_av_luminance=function(){var e=a(39);return e.clear_color=!1,e.clear_depth=!1,e.camera=l.create_camera(l.TYPE_NONE),e.is_pp=!0,e},t.create_resize_subs=function(){var e=a(45);return e.clear_color=!1,e.clear_depth=!1,e.camera=l.create_camera(l.TYPE_NONE),e.is_pp=!0,e},t.create_subs_luminance_truncated=function(e,t,n,_){var s=a(40);return s.clear_color=!1,s.clear_depth=!1,s.bloom_key=e,s.bloom_edge_lum=t,s.camera=_,r(s,n),s.is_pp=!0,s},t.create_subs_bloom_combine=function(e,t){var r=a(41);return r.clear_color=!1,r.clear_depth=!1,r.camera=l.create_camera(l.TYPE_NONE),r.bloom_blur=e,r.bloom_blur_num=t,r.is_pp=!0,r},t.create_subs_veloctity=function(e){var t=a(42);return t.clear_color=!1,t.clear_depth=!1,t.camera=e,t.is_pp=!0,t},t.create_subs_sink=function(){var e=a(43);return e.enqueue=!1,e},t.create_subs_perf=function(){var e=a(44);return e.is_pp=!0,e},t.subs_label=function(e){switch(e.type){case 0:return"MAIN OPAQUE";case 1:return"MAIN BLEND";case 2:return"MAIN XRAY";case 3:return"MAIN PLANE REFLECT";case 4:return"MAIN CUBE REFLECT";case 5:return"MAIN PLANE REFLECT BLEND";case 6:return"MAIN CUBE REFLECT BLEND";case 7:return"MAIN GLOW";case 8:return"SHADOW CAST";case 9:return"SHADOW RECEIVE";case 10:return"GRASS MAP";case 11:return"POSTPROCESSING ("+e.pp_effect.replace(/_/g," ")+")";case 13:return"GLOW COMBINE";case 14:return"RESOLVE";case 15:return"COLOR PICKING";case 16:return"COLOR PICKING XRAY";case 17:return"DEBUG VIEW";case 18:return"ANCHOR VISIBILITY";case 19:return"DEPTH PACK";case 20:return"SSAO";case 21:return"SSAO BLUR";case 22:return"ANTIALIASING";case 23:return"SMAA BLENDING WEIGHT CALCULATION";case 24:return"SMAA EDGE DETECTION";case 25:return"SMAA RESOLVE";case 26:return"SMAA NEIGHBORHOOD BLENDING";case 27:return"COMPOSITING";case 28:return"MOTION BLUR";case 29:return"COC";case 30:return"DOF";case 31:return"OUTLINE MASK";case 32:return"OUTLINE";case 33:return"GOD RAYS";case 34:return"GOD RAYS COMBINE";case 35:return"SKY";case 46:return"IRRADIANCE";case 47:return"ROUGHNESS_CONVOLUTION";case 48:return"PRE-COMPUTE_BRDF";case 36:return"COPY";case 37:return"STEREO";case 38:return"LUMINANCE";case 39:return"AVERAGE LUMINANCE";case 40:return"LUMINANCE TRUNCED";case 41:return"BLOOM";case 42:return"VELOCITY";case 44:return"PERFORMANCE";case 43:return"SINK";case 45:return"RESIZE";default:return"UNKNOWN"}},t.append_draw_data=function(e,t){for(var r=t.batch,a=r.shader,n=r.alpha_antialiasing,o=0;o<e.draw_data.length;o++){var i=e.draw_data[o].bundles,l=i.indexOf(t);if(-1!=l&&(i.splice(l,1),!i.length)){e.draw_data.splice(o,1);break}}if(e.blend)c=r.offset_z;else var c=0;var u=s(e.draw_data,a,n,c,r.is_sky);if(u)u.bundles.push(t);else{var d=_(a,t,n,c,r.is_sky);e.draw_data.push(d),e.need_draw_data_sort=!0}},t.init_bundle=function(e,t,r){var a={do_render:!0,do_render_cube:[!0,!0,!0,!0,!0,!0],obj_render:t,batch:e,world_bounds:r||null,info_for_z_sort_updates:null,z_index:1/0};if(e.z_sort&&e.bufs_data.ibo_array){var n=e.bufs_data.ibo_array;a.info_for_z_sort_updates={median_cache:new Float32Array(n.length),median_world_cache:new Float32Array(n.length),dist_cache:new Float32Array(n.length/3),zsort_eye_last:new Float32Array(3),bb_min_side:d.calc_min_bb_side(e.bounds_local.bb)}}return a},t.sort_draw_data=function(e){e.draw_data.sort(i),e.need_draw_data_sort=!1}}),T=o("__texcomp",function(e,t){function r(e,t,r,a){for(var n=new Uint16Array(4),_=new Uint16Array(r*a),s=0,o=0,i=0,l=0,c=0,u=0,d=0,f=0,m=0,p=r/4,h=a/4,v=0;v<h;v++)for(var b=0;b<p;b++)i=t+4*(v*p+b),n[0]=e[i],n[1]=e[i+1],l=31&n[0],c=2016&n[0],u=63488&n[0],d=31&n[1],f=2016&n[1],m=63488&n[1],n[2]=5*l+3*d>>3|5*c+3*f>>3&2016|5*u+3*m>>3&63488,n[3]=5*d+3*l>>3|5*f+3*c>>3&2016|5*m+3*u>>3&63488,s=e[i+2],_[o=4*v*r+4*b]=n[3&s],_[o+1]=n[s>>2&3],_[o+2]=n[s>>4&3],_[o+3]=n[s>>6&3],_[o+=r]=n[s>>8&3],_[o+1]=n[s>>10&3],_[o+2]=n[s>>12&3],_[o+3]=n[s>>14],s=e[i+3],_[o+=r]=n[3&s],_[o+1]=n[s>>2&3],_[o+2]=n[s>>4&3],_[o+3]=n[s>>6&3],_[o+=r]=n[s>>8&3],_[o+1]=n[s>>10&3],_[o+2]=n[s>>12&3],_[o+3]=n[s>>14];return _}function a(e,t,a,n){var _,i,m,h,O,R,k,N,M,I,S,L=new Int32Array(a,0,v);if(L[b]!=l)return o.error("Invalid magic number in DDS header"),0;if(!L[T]&u)return o.error("Unsupported format, must contain a FourCC code"),0;switch(_=L[x]){case d:i=8,m=t?t.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case f:i=16,m=t?t.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case p:i=16,m=t?t.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:return o.error("Unsupported FourCC code:",s(_)),null}if(I=1,L[y]&c&&!1!==n&&(I=Math.max(1,L[A])),h=L[w],O=L[E],k=L[g]+4,t)for(S=0;S<I;++S)R=Math.max(4,h)/4*Math.max(4,O)/4*i,M=new Uint8Array(a,k,R),e.compressedTexImage2D(e.TEXTURE_2D,S,m,h,O,0,M),k+=R,h=Math.max(.5*h,1),O=Math.max(.5*O,1);else{if(_!=d)return o.error("No manual decoder for",s(_),"and no native support"),0;R=Math.max(4,h)/4*Math.max(4,O)/4*i,N=r(M=new Uint16Array(a),k/2,h,O),e.texImage2D(e.TEXTURE_2D,0,e.RGB,h,O,0,e.RGB,e.UNSIGNED_SHORT_5_6_5,N),n&&e.generateMipmap(e.TEXTURE_2D)}return I}function n(e,t,r,n,_,s){var o=new XMLHttpRequest;return o.open("GET",r,!0),o.responseType="arraybuffer",o.onload=function(){if(200==o.status){e.bindTexture(e.TEXTURE_2D,n);var r=a(e,t,o.response,_);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r>1?e.LINEAR_MIPMAP_LINEAR:e.LINEAR)}s&&s(n)},o.send(null),n}function _(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function s(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}var o=m(e),i=h(e),l=542327876,c=131072,u=4,d=_("DXT1"),f=_("DXT3"),p=_("DXT5"),v=31,b=0,g=1,y=2,E=3,w=4,A=7,T=20,x=21;t.upload_dds_levels=a,t.upload_pvr_levels=function(e,t,r){var a=new Uint32Array(r,0,13);if(55727696==a[0]){var n=a[7],_=a[6],s=a[11],o=52+a[12];switch(a[2]){case 0:var l=2,c=1;break;case 1:var l=2,c=3;break;case 2:var l=4,c=0;break;case 3:var l=4,c=2;break;default:i.panic("Unsupported PVR V3 format.")}}else if(559044176==a[11]){var n=a[2],_=a[1],s=a[3],o=a[0];s++;var u=255&a[4],d=a[10]>0;if(25==u)var l=4,c=d?2:0;else if(24==u)var l=2,c=d?3:1;else i.panic("Unsupported PVR V2 format.")}else i.panic("Unsupported PVR version.");if(2==l)var f=8,m=4;else var f=4,m=4;switch(c){case 0:p=t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 1:p=t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 2:p=t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 3:var p=t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}for(var h=f*m*l/8,v=0;v<s;v++){var b=Math.max(n>>v,1),g=Math.max(_>>v,1),y=b/f,E=g/m;y<2&&(y=2),E<2&&(E=2);var w=y*E*h,A=new Uint8Array(r,o,w);e.compressedTexImage2D(e.TEXTURE_2D,v,p,b,g,0,A),o+=w}},t.get_width_height=function(e,t){switch(t){case"dds":return{width:(r=new Int32Array(e,0,v))[w],height:r[E]};case"pvr":var r=new Uint32Array(e,0,13);if(55727696==r[0])var a=r[7],n=r[6];else var a=r[2],n=r[1];return{width:a,height:n}}},t.get_compress_ratio=function(e,t){var r=1;if("dds"==t){var a=(n=new Int32Array(e,0,v))[x];switch(a){case d:r=6;break;case f:case p:r=4;break;default:o.error("Unsupported FourCC code:",s(a))}}else if("pvr"==t){var n=new Uint32Array(e,0,13);if(55727696==n[0])switch(n[2]){case 0:r=12;break;case 1:r=16;break;case 2:r=6;break;case 3:r=8}else{var _=255&n[4],i=n[10]>0;25==_?r=i?8:6:24==_&&(r=i?16:12)}}return r},t.load_dds_texture=function(e,t,r,a){var _=e.createTexture();return n(e,t,r,_,!0,a),_}}),x=o("__time",function(e,t){function r(){return++l}function a(){return++c}function n(){return-1!==_.animation.framerate?_.animation.framerate:d}var _=g(e),s=0,o=0,i=[],l=0,c=0,u=[],d=-1,f=0;t.set_timeline=function(e){for(s=e,o=performance.now(),r=0;r<i.length;r++){var t=i[r];s>t.expire_time&&(i.splice(r,1),r--,t.callback())}for(var r=0;r<u.length;r++){var a=u[r],n=1-(a.expire_time-s)/a.duration;n=Math.min(n,1);var _=a.from+n*(a.to-a.from);a.callback(_),1==n&&(u.splice(r,1),r--)}},t.get_timeline=function(){return s},t.set_delta=function(e){f=e},t.get_delta=function(){return f},t.set_timeout=function(e,t){var a=r(),n={id:a,callback:e,expire_time:s+(performance.now()-o+t)/1e3};return i.push(n),a},t.clear_timeout=function(e){for(var t=0;t<i.length;t++)if(i[t].id==e){i.splice(t,1);break}},t.clear_animation=function(e){for(var t=u.length;t--;)if(u[t].id==e){u.splice(t,1);break}},t.animate=function(e,t,r,n){var _=r/1e3,o=a(),i={id:o,callback:n,from:e,to:t,expire_time:s+_,duration:_};return u.push(i),n(e),o},t.reset=function(e){s=0,o=0,i.length=0,u.length=0,l=0,c=0},t.get_framerate=n,t.set_framerate=function(e){d=e},t.get_frame=function(e){return e*n()}}),O=o("__armature",function(e,t){function r(){return{bone_index:0,vgroup_index:-1,parent_bone_ptr:null,descend_bones_ptrs:[],chain:[],constraint:null,tsr_bone_rest:s.create(),tsr_bone_pose:s.create(),tsr_local_rest:s.create(),tsr_local_rest_i:s.create(),tsr_local_pose:s.create(),tsr_local_pose_b:s.create(),tsr_local_pose_a:s.create(),tsr_basis:s.create(),tsr_channel_cache:s.create(),tsr_channel_cache_valid:!1,tail:new Float32Array(3)}}function a(e){for(var t=e.render,r=t.skinned_renders,a=t.mesh_to_arm_bone_maps,n=0;n<r.length;n++){for(var _=r[n],s=a[n],o=0;o<s.length;o+=2)for(var i=s[o],l=s[o+1],c=0;c<4;c++)_.quats_before[i+c]=t.quats_before[l+c],_.quats_after[i+c]=t.quats_after[l+c],_.trans_before[i+c]=t.trans_before[l+c],_.trans_after[i+c]=t.trans_after[l+c];_.frame_factor=t.frame_factor}}function n(e,t,r,a){var _=e.tsr_bone_pose,o=e.tsr_local_rest,i=e.tsr_local_pose,l=e.parent_bone_ptr;if(l){var c=l.tsr_local_pose;if(t)s.multiply(c,_,i);else{var u=m;s.invert(c,u),s.multiply(u,i,_)}}else t?s.copy(_,i):s.copy(i,_);var d=f;s.invert(o,d),s.multiply(i,d,d);var p=e.bone_index;r[4*p]=d[0],r[4*p+1]=d[1],r[4*p+2]=d[2],r[4*p+3]=d[3],a[4*p]=d[4],a[4*p+1]=d[5],a[4*p+2]=d[6],a[4*p+3]=d[7];for(var h=e.descend_bones_ptrs,v=0;v<h.length;v++){var b=h[v];b.constraint||n(b,!0,r,a)}}var _=h(e),s=v(e),o=d(e),c=i(e),u=l(e),f=s.create(),m=s.create(),p=new Float32Array(4),b=new Float32Array(4),g=new Float32Array(4);t.update_object=function(e,t){for(var a=e.data.bones,n=e.pose.bones,o={},i=0;i<n.length;i++){var l=(g=n[i]).bone,d=o[b=l.name]=r(),m=new Float32Array(l.matrix_local),p=new Float32Array(16);c.invert(m,p);var h=new Float32Array(g.matrix_basis),v=d.tail;u.subtract(_.f32(l.tail_local),_.f32(l.head_local),v),_.vecdir_multiply_matrix(v,p,v),s.from_mat4(m,d.tsr_local_rest),s.from_mat4(h,d.tsr_basis),s.copy(d.tsr_local_rest,d.tsr_local_pose),s.invert(d.tsr_local_rest,d.tsr_local_rest_i)}for(i=0;i<a.length;i++){var b=a[i].name,g=_.keysearch("name",b,n),d=o[b],y=g.parent_recursive;d.chain.push(d);for(var E=0;E<y.length;E++)T=o[A=(w=y[E]).name],d.chain.push(T);if(y.length){var w=y[0],A=w.name,T=o[A];d.parent_bone_ptr=T,s.invert(T.tsr_local_rest,f),s.multiply(f,d.tsr_local_rest,d.tsr_bone_rest),T.descend_bones_ptrs.push(d)}else s.copy(d.tsr_local_rest,d.tsr_bone_rest);d.bone_index=i,d.name=b,s.multiply(d.tsr_bone_rest,d.tsr_basis,d.tsr_bone_pose)}t.render.bone_pointers=o},t.get_bone_tsr=function(e,t,r,a,n){var _=e.render,i=_.frame_factor,l=_.bone_pointers[t],c=l.bone_index,u=l.tsr_local_rest,d=p,h=_.trans_before,v=_.trans_after,y=_.quats_before,E=_.quats_after,w=h[4*c],A=h[4*c+1],T=h[4*c+2],x=h[4*c+3],O=v[4*c],R=v[4*c+1],k=v[4*c+2],N=v[4*c+3];d[0]=(1-i)*w+i*O,d[1]=(1-i)*A+i*R,d[2]=(1-i)*T+i*k,d[3]=(1-i)*x+i*N;var M=b,I=g;M[0]=y[4*c],M[1]=y[4*c+1],M[2]=y[4*c+2],M[3]=y[4*c+3],I[0]=E[4*c],I[1]=E[4*c+1],I[2]=E[4*c+2],I[3]=E[4*c+3],o.slerp(M,I,i,M);var S=f;if(s.set_transcale(d,S),s.set_quat(M,S),r){var L=m;s.translate(u,l.tail,L),s.multiply(S,L,S)}else s.multiply(S,u,S);if(a){var C=l.parent_bone_ptr;if(C){var P=C.tsr_local_pose,D=m;s.invert(P,D),s.multiply(D,S,S)}var U=l.tsr_bone_rest,F=m;s.invert(U,F),s.multiply(F,S,S)}s.copy(S,n)},t.set_bone_tsr=function(e,t,r,_){var o=e.render,i=o.bone_pointers[t],l=o.trans_before,c=o.quats_before;_?s.multiply(i.tsr_bone_rest,r,i.tsr_bone_pose):s.copy(r,i.tsr_local_pose),n(i,_,l,c),o.frame_factor=0,a(e)},t.update_skinned_renders=a,t.update_bone_tsr_r=n,t.check_bone=function(e,t){return t in e.render.bone_pointers}}),R=o("__lights",function(e,t){function r(e){var t={name:"",type:e,use_diffuse:!1,use_specular:!1,prev_direction:new Float32Array(3),direction:new Float32Array(3),color:new Float32Array(3),color_intensity:new Float32Array(3),energy:0,default_energy:0,distance:0,use_sphere:!1,spot_size:0,spot_blend:0,clip_start:.1,clip_end:30,falloff_type:"",generate_shadows:!1,need_sun_fog_update:!1,dynamic_intensity:!1};return t.use_diffuse=!0,t.use_specular=!0,t.energy=1,t.distance=25,t.falloff_type="INVERSE_SQUARE",t}function a(e){s.scale(e.color,e.energy,e.color_intensity)}var n=v(e),_=h(e),s=l(e),o=new Float32Array(3);t.lamp_to_light=function(e,t){var i=e.data,l=t.light=r(i.type);l.name=t.name,l.use_diffuse=i.use_diffuse,l.use_specular=i.use_specular;var c=n.get_quat_view(t.render.world_tsr),u=_.quat_to_dir(c,_.AXIS_Z,o);s.normalize(u,u),l.direction.set(u),l.color[0]=i.color[0],l.color[1]=i.color[1],l.color[2]=i.color[2],l.energy=l.default_energy=i.energy,a(l),l.distance=i.distance,l.use_sphere=i.use_sphere,l.clip_start=i.clip_start,l.clip_end=i.clip_end,"POINT"!==l.type&&"SPOT"!==l.type||(l.distance=i.distance),"SPOT"===l.type?(l.spot_blend=i.spot_blend,l.spot_size=i.spot_size):"POINT"===l.type&&(l.spot_size=Math.PI/2),l.generate_shadows=i.b4w_generate_shadows,l.dynamic_intensity=i.b4w_dynamic_intensity},t.set_light_color=function(e,t){e.color[0]=t[0],e.color[1]=t[1],e.color[2]=t[2],a(e)},t.set_light_spot_blend=function(e,t){e.spot_blend=t},t.set_light_distance=function(e,t){e.distance=t},t.set_light_spot_size=function(e,t){e.spot_size=t},t.set_light_energy=function(e,t){e.energy=t,a(e)},t.update_light_transform=function(e){var t=e.light;if(t){var r=n.get_quat_view(e.render.world_tsr);if(_.quat_to_dir(r,_.AXIS_Z,t.direction),s.normalize(t.direction,t.direction),"SUN"==t.type){var a=Math.acos(s.dot(t.prev_direction,_.VEC3_UNIT)),o=Math.acos(s.dot(t.direction,_.VEC3_UNIT)),i=Math.floor(a/.025),l=Math.floor(o/.025);t.need_sun_fog_update=i!=l}s.copy(t.direction,t.prev_direction)}}}),k=o("__obj_util",function(e,t){function r(e){var t={type:e,data_id:0,world_tsr:w.create_ext(),world_tsr_inv:w.create_ext(),pivot:new Float32Array(3),hover_pivot:new Float32Array(3),init_dist:0,init_fov:0,is_copied:!1,is_copied_deep:!1,color_id:null,outline_intensity:0,target_cam_upside_down:!1,vertical_axis:T.create(),use_panning:!1,move_style:0,velocity_trans:1,velocity_rot:1,velocity_zoom:1,dof_distance:0,dof_front_start:0,dof_front_end:0,dof_rear_start:0,dof_rear_end:0,dof_power:0,dof_bokeh_intensity:0,dof_bokeh:!1,dof_foreground_blur:!1,dof_object:null,horizontal_limits:null,vertical_limits:null,distance_limits:null,hover_vert_trans_limits:null,hover_horiz_trans_limits:null,pivot_limits:null,enable_hover_hor_rotation:!0,outline_anim_settings_default:{outline_duration:1,outline_period:1,outline_relapses:0},cube_reflection_id:-1,plane_reflection_id:-1,reflection_plane:new Float32Array(4),friction:0,elasticity:0,is_lod:!1,lod_center:new Float32Array(3),main_lod_offset:new Float32Array(3),lod_dist_min:0,lod_dist_max:R,lod_lower_border_range:0,lod_upper_border_range:0,do_not_render:!1,shadow_cast:!1,shadow_receive:!1,shadow_cast_only:!1,reflexible:!1,reflexible_only:!1,reflective:!1,reflection_type:"",wind_bending:!1,dynamic_geometry:!1,dynamic_grass:!1,hide:!1,hide_children:!1,selectable:!1,origin_selectable:!1,outlining:!1,origin_outlining:!1,outline_on_select:!1,is_hair_particles:!1,is_visible:!1,force_zsort:!1,wind_bending_angle:0,wind_bending_amp:0,wind_bending_freq:0,detail_bending_freq:0,detail_bending_amp:0,branch_bending_amp:0,main_bend_col:"",detail_bend_col:{leaves_stiffness:"",leaves_phase:"",overall_stiffness:""},bend_center_only:!1,center_pos:new Float32Array(3),billboard:!1,billboard_pres_glob_orientation:!1,billboard_type:"",billboard_spherical:!1,frame_factor:0,va_frame:0,va_frame_factor:0,max_bones:0,frames_blending:!1,vertex_anim:!1,use_shape_keys:!1,shape_keys_values:[],is_skinning:!1,anim_mixing:!1,anim_mix_factor:1,anim_mix_factor_change_speed:0,anim_destination_mix_factor:1,anim_mix_cb:null,mix_with_current:!1,blend_skel_slots:new Int8Array([-1,-1]),skinned_renders:[],mesh_to_arm_bone_maps:[],skinning_data_cache:[],quats_before:null,quats_after:null,trans_before:null,trans_after:null,trans_curr:null,quats_curr:null,bone_pointers:null,bone_skinning_info:null,pose_data:null,arm_rel_trans:null,arm_rel_quat:null,bb_original:y.create_bb(),bb_local:y.create_bb(),bb_world:y.create_bb(),bs_local:y.create_bs(),bs_world:y.create_bs(),be_local:y.create_be(),be_world:y.create_be(),bbr_local:y.create_rot_bb(),bbr_world:y.create_rot_bb(),bcyl_local:y.init_bcyl(),bcap_local:y.init_bcap(),bcon_local:y.init_bcon(),pass_index:0};return T.copy(A.AXIS_Z,t.vertical_axis),t}function a(e){return{scene:e,is_active:!1,batches:[],batch_world_bounds:[],plane_refl_subs:[],cube_refl_subs:null,shadow_subscenes:[],light_index:0,obj_has_nla_on_scene:!1,cameras:[],shadow_cameras:[]}}function n(e){if(!(e instanceof Object))return e;var t=null,r=null,a=null,_=null,s=null,o=null;e.textures&&(t=e.textures,e.textures=null),e.texture_names&&(r=e.texture_names,e.texture_names=null),e.bpy_tex_names&&(a=e.bpy_tex_names,e.bpy_tex_names=null),e.shape_keys&&(_=e.shape_keys,e.shape_keys=null),e.shader&&(s=e.shader,e.shader=null),e.vaos&&(o=e.vaos,e.vaos=null);var i,l=e.constructor;switch(l){case Int8Array:case Uint8Array:case Uint8ClampedArray:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:i=new l(e);break;case Array:i=new l(e.length);for(var c=0;c<e.length;c++)i[c]=n(e[c]);break;case WebGLUniformLocation:case WebGLProgram:case WebGLShader:i=e;break;case WebGLFramebuffer:case WebGLRenderbuffer:case WebGLTexture:case WebGLBuffer:i=null;break;case Function:i=e;break;default:i=new l;for(var u in e)i[u]=n(e[u])}return t&&(i.textures=t,e.textures=t),r&&(i.texture_names=r,e.texture_names=r),a&&(i.bpy_tex_names=a,e.bpy_tex_names=a),_&&(i.shape_keys=_,e.shape_keys=_),s&&(i.shader=s,e.shader=s),o&&(i.vaos=A.create_non_smi_array(),e.vaos=o),i}function _(e){return e.is_dynamic}function s(e,t){y.copy_bb(t,e.bb_local),y.bounding_box_transform(e.bb_local,e.world_tsr,e.bb_world)}function o(e,t,r){e.bs_local=y.bs_from_values(t,r),y.bounding_sphere_transform(e.bs_local,e.world_tsr,e.bs_world)}function i(e,t,r,a,n,_){e.be_local=y.be_from_values(t,r,a,_),T.scale(e.be_local.axis_x,n[0],e.be_local.axis_x),T.scale(e.be_local.axis_y,n[1],e.be_local.axis_y),T.scale(e.be_local.axis_z,n[2],e.be_local.axis_z),y.bounding_ellipsoid_transform(e.be_local,e.world_tsr,e.be_world)}function u(e,t,r,a){e.bcyl_local=y.bcyl_from_values(t,a),e.bcap_local=y.bcap_from_values(r,a),e.bcon_local=y.bcon_from_values(t,a)}function d(e,t,r,a,n,_){e.bbr_local=y.rot_bb_from_values(_,t,r,a,n),y.bounding_rot_box_transform(e.bbr_local,e.world_tsr,e.bbr_world)}function f(e,t,r){y.bounding_box_transform(e.bounds_local.bb,t,r.bb),e.use_be&&y.bounding_ellipsoid_transform(e.bounds_local.be,t,r.be),y.bounding_sphere_transform(e.bounds_local.bs,t,r.bs)}function m(e,t){for(var r=e.scenes_data,a=0;a<r.length;a++){var n=r[a];if(n.scene==t)return n}return null}function p(e){return e.parent_is_dupli?e.parent:e.parent?p(e.parent):null}var y=b(e),E=g(e),w=v(e),A=h(e),T=l(e),x=c(e),O=E.defaults,R=1/0;t.LOD_DIST_MAX_INFINITY=R,t.create_render=r,t.clone_render=function(e){var t=r(e.type);return t.data_id=e.data_id,w.copy(e.world_tsr,t.world_tsr),w.copy(e.world_tsr_inv,t.world_tsr_inv),T.copy(e.pivot,t.pivot),T.copy(e.hover_pivot,t.hover_pivot),t.init_dist=e.init_dist,t.init_fov=e.init_fov,t.is_copied=e.is_copied,t.is_copied_deep=e.is_copied_deep,e.color_id&&(t.color_id=T.clone(e.color_id)),t.outline_intensity=e.outline_intensity,t.target_cam_upside_down=e.target_cam_upside_down,T.copy(e.vertical_axis,t.vertical_axis),t.use_panning=e.use_panning,t.move_style=e.move_style,t.velocity_trans=e.velocity_trans,t.velocity_rot=e.velocity_rot,t.velocity_zoom=e.velocity_zoom,t.dof_distance=e.dof_distance,t.dof_front_start=e.dof_front_start,t.dof_front_end=e.dof_front_end,t.dof_rear_start=e.dof_rear_start,t.dof_rear_end=e.dof_rear_end,t.dof_power=e.dof_power,t.dof_bokeh_intensity=e.dof_bokeh_intensity,t.dof_bokeh=e.dof_bokeh,t.dof_foreground_blur=e.dof_foreground_blur,t.dof_object=e.dof_object,t.horizontal_limits=A.clone_object_r(e.horizontal_limits),t.vertical_limits=A.clone_object_r(e.vertical_limits),t.distance_limits=A.clone_object_r(e.distance_limits),t.hover_vert_trans_limits=A.clone_object_r(e.hover_vert_trans_limits),t.hover_horiz_trans_limits=A.clone_object_r(e.hover_horiz_trans_limits),t.pivot_limits=e.pivot_limits,t.enable_hover_hor_rotation=e.enable_hover_hor_rotation,t.outline_anim_settings_default.outline_duration=e.outline_anim_settings_default.outline_duration,t.outline_anim_settings_default.outline_period=e.outline_anim_settings_default.outline_period,t.outline_anim_settings_default.outline_relapses=e.outline_anim_settings_default.outline_relapses,t.cube_reflection_id=e.cube_reflection_id,t.plane_reflection_id=e.plane_reflection_id,t.reflection_plane=e.reflection_plane,t.friction=e.friction,t.elasticity=e.elasticity,t.is_lod=e.is_lod,T.copy(e.lod_center,t.lod_center),T.copy(e.main_lod_offset,t.main_lod_offset),t.lod_dist_min=e.lod_dist_min,t.lod_dist_max=e.lod_dist_max,t.lod_lower_border_range=e.lod_lower_border_range,t.lod_upper_border_range=e.lod_upper_border_range,t.do_not_render=e.do_not_render,t.shadow_cast=e.shadow_cast,t.shadow_receive=e.shadow_receive,t.shadow_cast_only=e.shadow_cast_only,t.reflexible=e.reflexible,t.reflexible_only=e.reflexible_only,t.reflective=e.reflective,t.reflection_type=e.reflection_type,t.wind_bending=e.wind_bending,t.dynamic_geometry=e.dynamic_geometry,t.dynamic_grass=e.dynamic_grass,t.hide=e.hide,t.selectable=e.selectable,t.origin_selectable=e.origin_selectable,t.outlining=e.outlining,t.origin_outlining=e.origin_outlining,t.outline_on_select=e.outline_on_select,t.is_hair_particles=e.is_hair_particles,t.is_visible=e.is_visible,t.force_zsort=e.force_zsort,t.wind_bending_angle=e.wind_bending_angle,t.wind_bending_amp=e.wind_bending_amp,t.wind_bending_freq=e.wind_bending_freq,t.detail_bending_freq=e.detail_bending_freq,t.detail_bending_amp=e.detail_bending_amp,t.branch_bending_amp=e.branch_bending_amp,t.main_bend_col=e.main_bend_col,t.detail_bend_col=e.detail_bend_col,t.bend_center_only=e.bend_center_only,T.copy(e.center_pos,t.center_pos),t.billboard=e.billboard,t.billboard_pres_glob_orientation=e.billboard_pres_glob_orientation,t.billboard_type=e.billboard_type,t.billboard_spherical=e.billboard_spherical,t.frame_factor=e.frame_factor,t.va_frame=e.va_frame,t.va_frame_factor=e.va_frame_factor,t.max_bones=e.max_bones,t.frames_blending=e.frames_blending,t.vertex_anim=e.vertex_anim,t.use_shape_keys=e.use_shape_keys,t.shape_keys_values=A.clone_object_r(e.shape_keys_values),t.is_skinning=e.is_skinning,t.anim_mixing=e.anim_mixing,t.anim_mix_factor=e.anim_mix_factor,t.anim_mix_factor_change_speed=e.anim_mix_factor_change_speed,t.anim_destination_mix_factor=e.anim_destination_mix_factor,t.blend_skel_slots.set(e.blend_skel_slots),t.skinned_renders=A.clone_object_r(e.skinned_renders),t.mesh_to_arm_bone_maps=A.clone_object_r(e.mesh_to_arm_bone_maps),t.skinning_data_cache=A.clone_object_r(e.skinning_data_cache),t.quats_before=A.clone_object_r(e.quats_before),t.quats_after=A.clone_object_r(e.quats_after),t.trans_before=A.clone_object_r(e.trans_before),t.trans_after=A.clone_object_r(e.trans_after),t.bone_pointers=A.clone_object_r(e.bone_pointers),t.bone_skinning_info=A.clone_object_r(e.bone_skinning_info),t.pose_data=A.clone_object_r(e.pose_data),t.arm_rel_trans=A.clone_object_r(e.arm_rel_trans),t.arm_rel_quat=A.clone_object_r(e.arm_rel_quat),y.copy_bb(e.bb_original,t.bb_original),y.copy_bb(e.bb_local,t.bb_local),y.copy_bb(e.bb_world,t.bb_world),y.copy_bs(e.bs_local,t.bs_local),y.copy_bs(e.bs_world,t.bs_world),y.copy_be(e.be_local,t.be_local),y.copy_be(e.be_world,t.be_world),y.copy_bcap(e.bcap_local,t.bcap_local),y.copy_bcyl(e.bcyl_local,t.bcyl_local),y.copy_bcon(e.bcon_local,t.bcon_local),t.pass_index=e.pass_index,t},t.create_object=function(e,t,r){return r||(r=e),{name:e,uuid:A.gen_uuid(),origin_name:r,type:t,materials:[],is_meta:!0,_bpy_obj:null,mat_inheritance_data:{original_mat_names:[],is_disabled:[]},is_dynamic:!1,is_hair_dupli:!1,use_default_animation:!1,is_boundings_overridden:!1,render:null,constraint:null,sfx:null,light:null,armobj:null,anchor:null,field:null,metatags:null,custom_prop:null,scenes_data:[],vertex_anim:[],cons_descends:A.create_non_smi_array(),cons_armat_bone_descends:A.create_non_smi_array(),anim_slots:[],reflective_objs:[],nla_events:[],action_anim_cache:[],sensor_manifolds:null,sensor_manifolds_arr:[],parent:null,parent_is_dupli:!1,parent_bone:"",viewport_alignment:null,pinverse_tsr:null,use_obj_physics:!1,collision_id:"",correct_bounding_offset:"AUTO",is_vehicle:!1,is_character:!1,is_floating:!1,bob_synchronize_pos:!1,physics:null,vehicle:null,floater:null,vehicle_settings:null,floating_settings:null,character_settings:null,physics_constraints:[],physics_settings:{physics_type:"NO_COLLISION",use_ghost:!1,use_sleep:!1,mass:0,velocity_min:0,velocity_max:0,damping:0,rotation_damping:0,lock_location_x:!1,lock_location_y:!1,lock_location_z:!1,lock_rotation_x:!1,lock_rotation_y:!1,lock_rotation_z:!1,collision_margin:0,collision_group:0,collision_mask:0,use_collision_bounds:!1,collision_bounds_type:"BOX",use_collision_compound:!1},outline_animation:{time_start:0,outline_time:0,period:0,relapses:0},anim_behavior_def:0,def_action_slots:[],need_update_transform:!1,need_inv_zup_tsr:!1,meta_objects:[]}},t.init_scene_data=a,t.copy_bpy_object_props_by_link=function(e){return e instanceof Array?e.slice():e},t.copy_object_props_by_value=n,t.is_dynamic=_,t.is_dynamic_mesh=function(e){return"MESH"==e.type&&e.is_dynamic},t.append_scene_data=function(e,t){var r=a(t);e.scenes_data.push(r)},t.append_batch=function(e,t,r){var a=e.render,n=m(e,t);n.batches.push(r);var _=y.init_boundings();f(r,a.world_tsr,_),n.batch_world_bounds.push(_)},t.update_render_bounds_billboard=function(e,t){var r=e.render,a=Math.max(Math.abs(t.max_x),Math.abs(t.min_x)),n=Math.max(Math.abs(t.max_y),Math.abs(t.min_y)),l=Math.max(Math.abs(t.max_z),Math.abs(t.min_z)),c=Math.sqrt(a*a+n*n+l*l),f=Math.sqrt(a*a+n*n),m=y.create_bb();m.max_x=m.max_y=m.max_z=c,m.min_x=m.min_y=m.min_z=-c,s(r,m),o(r,c,[0,0,0]),i(r,[1,0,0],[0,1,0],[0,0,1],[c,c,c],[0,0,0]),_(e)?u(r,f,f,m):d(r,[1,0,0],[0,1,0],[0,0,1],[c,c,c],[0,0,0])},t.update_render_bounds_from_bpy=function(e,t,r){var a=e.render,n=r.bs_rad,l=r.bc_rad,c=r.bs_cen,f=r.be_cen,m=r.caxis_x,p=r.caxis_y,h=r.caxis_z,v=r.be_ax,b=r.rbb.rbb_c,g=r.rbb.rbb_s;s(a,t),o(a,n,c);var y=_(e);i(a,y?m:[1,0,0],y?p:[0,1,0],y?h:[0,0,1],v,f),_(e)?u(a,l,l,a.bb_local):d(a,m,p,h,g,b)},t.update_render_bounds_from_pos_arrays=function(e,t,r){for(var a=e.render,n=t.max_x-t.min_x,l=t.max_y-t.min_y,c=t.max_z-t.min_z,f=(t.max_x+t.min_x)/2,m=(t.max_y+t.min_y)/2,p=(t.max_z+t.min_z)/2,h=f,v=p,b=Math.max(n,Math.max(l,c))/2,g=Math.max(n,c)/2,y=[f/(n||1),m/(l||1),p/(c||1)],E=.5,w=0;w<r.length;w++)for(var A=r[w],T=0;T<A.length;T+=3){var x=A[T],O=A[T+1],R=A[T+2],k=Math.sqrt((f-x)*(f-x)+(m-O)*(m-O)+(p-R)*(p-R));k>b&&(f=((I=f-b*(x-f)/k)+x)/2,m=((S=m-b*(O-m)/k)+O)/2,p=((L=p-b*(R-p)/k)+R)/2,b=Math.sqrt((f-x)*(f-x)+(m-O)*(m-O)+(p-R)*(p-R)));var N=Math.sqrt((h-x)*(h-x)+(v-R)*(v-R));N>g&&(h=((I=h-g*(x-h)/N)+x)/2,v=((L=v-g*(R-v)/N)+R)/2,g=Math.sqrt((h-x)*(h-x)+(v-R)*(v-R))),x/=n||1,O/=l||1,R/=c||1;var M=Math.sqrt((y[0]-x)*(y[0]-x)+(y[1]-O)*(y[1]-O)+(y[2]-R)*(y[2]-R));if(M>E){var I=y[0]-E*(x-y[0])/M,S=y[1]-E*(O-y[1])/M,L=y[2]-E*(R-y[2])/M;y[0]=(I+x)/2,y[1]=(S+O)/2,y[2]=(L+R)/2,E=Math.sqrt((y[0]-x)*(y[0]-x)+(y[1]-O)*(y[1]-O)+(y[2]-R)*(y[2]-R))}}var C=n?n*y[0]:t.max_x,P=l?l*y[1]:t.max_y,D=c?c*y[2]:t.max_z,U=E*n,F=E*l,B=E*c;s(a,t),o(a,b,[f,m,p]),i(a,[1,0,0],[0,1,0],[0,0,1],[U,F,B],[C,P,D]),_(e)?u(a,g,g,a.bb_local):d(a,[(a.bb_local.max_x-a.bb_local.min_x)/2,0,0],[0,(a.bb_local.max_y-a.bb_local.min_y)/2,0],[0,0,(a.bb_local.max_z-a.bb_local.min_z)/2],[1,1,1],[(a.bb_local.max_x+a.bb_local.min_x)/2,(a.bb_local.max_y+a.bb_local.min_y)/2,(a.bb_local.max_z+a.bb_local.min_z)/2])},t.update_world_bounds_from_batch_tsr=f,t.remove_scene_data=function(e,t){for(var r=e.scenes_data,a=0;a<r.length;a++)if(r[a].scene==t){r.splice(a,1);break}},t.get_scene_data=m,t.update_refl_objects=function(e,t){for(var r=0;r<e.length;r++)x.copy(t,e[r].render.reflection_plane)},t.scene_data_set_active=function(e,t,r){for(var a=0;a<e.scenes_data.length;a++){var n=e.scenes_data[a];r&&n.scene!=r||(n.is_active=t)}},t.scene_data_remove_batch=function(e,t){e.batches.splice(t,1),e.batch_world_bounds.splice(t,1)},t.get_shadow_lamps=function(e,t){for(var r=[],a=t?O.max_cast_lamps-1:O.max_cast_lamps,n=0;n<e.length;n++){var _=e[n];_.light.generate_shadows&&r.length<a&&r.push(_)}return r.length?r:e[0]?[e[0]]:[]},t.meta_obj_append_render=function(e,t){w.identity(t.world_tsr),t.color_id=null,e.render=t},t.check_obj_soft_particles_accessibility=function(e,t){if(t.b4w_enable_soft_particles&&t.b4w_particles_softness>0){var r=t.material-1,a=e.materials;if(r>=0&&r<a.length&&("ADD"==a[r].blend_mode||"ALPHA"==a[r].blend_mode||"ALPHA_SORT"==a[r].blend_mode))return!0}return!1},t.check_inv_zup_tsr_is_needed=function(e){for(var t=e.scenes_data,r=0;r<t.length;r++)for(var a=t[r].batches,n=0;n<a.length;n++)for(var _=a[n].shaders_info.directives,s=0;s<_.length;s++){var o=_[s];if("USE_MODEL_TSR_INVERSE"==o[0]&&"1"==o[1])return!0}return!1},t.gen_dupli_name=function(e,t){return e+"*"+t},t.get_parent=function(e){return e.parent_is_dupli?null:e.parent},t.get_dg_parent=p,t.get_dg_objects=function(e,t){for(var r=[],a=0;a<t.length;a++){var n=t[a];p(n)==e&&r.push(n)}return r},t.get_object_data_id=function(e){return e.render.data_id},t.is_mesh=function(e){return"MESH"===e.type},t.is_armature=function(e){return"ARMATURE"===e.type},t.is_speaker=function(e){return"SPEAKER"===e.type},t.is_camera=function(e){return"CAMERA"===e.type},t.is_lamp=function(e){return"LAMP"===e.type},t.is_empty=function(e){return"EMPTY"===e.type},t.is_line=function(e){return"LINE"===e.type},t.is_world=function(e){return"WORLD"===e.type}}),N=o("__particles",function(e,t){function r(e,t){return{name:e,p_type:t,time:0,prev_time:-1,use_world_space:!1,count_factor:1,frame_start:0,frame_end:0,time_length:0,lifetime_frames:0,lifetime:0,cyclic:0,mass:0,nfactor:0,gravity:0,fade_in:0,fade_out:0,wind_factor:0,size:0,alpha_start:0,alpha_end:0,color_ramp_length:0,color_ramp:new Float32Array(16),need_buffers_update:!1,positions:null,positions_cache:null,tbn:null,tbn_cache:null,delay_attrs:null,delay_attrs_masked:null,emitter_tsr_snapshots:null,p_data:null,tilt:0,tilt_rand:0}}function a(e,t,r,a,n,_){for(var s=e.delay_attrs,o=e.emitter_tsr_snapshots,i=e.time,l=e.prev_time,c=0;c<s.length;c+=4){var u=s[c];if(i>l&&i>=u&&u>l||i<l&&(u>l||i>=u))for(m=0;m<8;m++)o[8*c+m]=a[m],C[m]=a[m];else for(m=0;m<8;m++)C[m]=o[8*c+m];var d=P;d[0]=t[3*c],d[1]=t[3*c+1],d[2]=t[3*c+2],k.transform_vec3(d,C,d),n[3*c]=d[0],n[3*c+1]=d[1],n[3*c+2]=d[2];var f=T.get_item(r,c,L);T.multiply_tsr(f,C,f),T.set_item(_,f,c);for(var m=1;m<4;m++)n[3*(c+m)]=n[3*c],n[3*(c+m)+1]=n[3*c+1],n[3*(c+m)+2]=n[3*c+2],T.set_item(_,f,c+m)}}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r],_=n.particles_data;if(_&&_.use_world_space&&!n.forked_batch){var s=_.positions_cache,o=_.tbn_cache;a(_,_.positions,_.tbn,e.render.world_tsr,s,o),_.need_buffers_update=!0}}}function _(e){e?(N.srand(e),U=function(){return N.rand()}):U=function(){return Math.random()}}function s(e){for(var t=[],r=0;r<e;r++)t.push(4*r,4*r+2,4*r+1,4*r,4*r+3,4*r+2);return new Uint16Array(t)}function o(e,t,r){switch(t){case"VERT":var a=r.va_frames[0].a_position,n=r.va_frames[0].a_tbn,_=i(e,a),s=c(_,a),o=u(_,n);break;case"FACE":var s=[],o=[],l=[];N.init_rand_r_seed(0,l);var d=A.geometry_random_points(r,e,!1,l);N.init_rand_r_seed(0,l);var f=A.geometry_random_points(r,e,!0,l);o=T.create(4*d.length);for(var m=0;m<d.length;m++)s.push(d[m][0],d[m][1],d[m][2]),s.push(d[m][0],d[m][1],d[m][2]),s.push(d[m][0],d[m][1],d[m][2]),s.push(d[m][0],d[m][1],d[m][2]),T.set_item(o,f[m],4*m),T.set_item(o,f[m],4*m+1),T.set_item(o,f[m],4*m+2),T.set_item(o,f[m],4*m+3);s=new Float32Array(s);break;case"VOLUME":N.panic("Particle emission from volume is not supported");break;default:N.panic("Wrong emit from option")}return[s,o]}function i(e,t){for(var r=t.length/3,a=[],n=0;n<e;n++){var _=Math.round((r-1)*U());a.push(_),a.push(_),a.push(_),a.push(_)}return a}function c(e,t){for(var r=[],a=0;a<e.length;a++)r.push(t[3*e[a]]),r.push(t[3*e[a]+1]),r.push(t[3*e[a]+2]);return new Float32Array(r)}function u(e,t){for(var r=T.create(e.length),a=0;a<e.length;a++){var n=T.get_item(t,e[a],L);T.set_item(r,n,a)}return r}function d(e,t,r,a,n){for(var _=[],s=(r-t)/e,o=0;o<e;o++){var i;i=a?s*o+I*s*(.5-U()):s*o,n||(i+=t),_.push(i),_.push(i),_.push(i),_.push(i)}return new Float32Array(_)}function f(e,t,r){for(var a=[],n=t*r,_=0;_<e;_++){var s=n*U();a.push(t-s),a.push(t-s),a.push(t-s),a.push(t-s)}return a}function m(e,t,r){for(var a=[],n=0;n<e;n++){var _=Math.random();a.push(t[4*n],r[4*n],_),a.push(t[4*n+1],r[4*n+1],_),a.push(t[4*n+2],r[4*n+2],_),a.push(t[4*n+3],r[4*n+3],_)}return new Float32Array(a)}function b(e,t,r,a){for(var n=[],_=0;_<e;_++){var s=[U()-.5,U()-.5,U()-.5];switch(M.normalize(s,s),n.push(t*s[0]),n.push(t*s[1]),n.push(t*s[2]),r){case"NONE":n.push(0);break;case"SPIN":case"VELOCITY":n.push(a);break;case"RAND":n.push(2*a*(U()-.5));break;default:N.panic("Undefined velocity factor")}for(var o=n.slice(-4),i=0;i<12;i++)n.push(o[i%4])}return new Float32Array(n)}var y=g(e),E=_e(e),A=w(e),T=p(e),O=ee(e),R=x(e),k=v(e),N=h(e),M=l(e),I=10,S=y.defaults,L=T.create(),C=new Float32Array(8),P=new Float32Array(3),D=[];t.clone_particles_data=function(e){var t=r(e.name,e.type);return t.time=e.time,t.prev_time=e.prev_time,t.use_world_space=e.use_world_space,t.count_factor=e.count_factor,t.frame_start=e.frame_start,t.frame_end=e.frame_end,t.time_length=e.time_length,t.lifetime_frames=e.lifetime_frames,t.lifetime=e.lifetime,t.cyclic=e.cyclic,t.mass=e.mass,t.nfactor=e.nfactor,t.gravity=e.gravity,t.fade_in=e.fade_in,t.fade_out=e.fade_out,t.wind_factor=e.wind_factor,t.size=e.size,t.alpha_start=e.alpha_start,t.alpha_end=e.alpha_end,t.color_ramp_length=e.color_ramp_length,t.color_ramp.set(e.color_ramp),t.need_buffers_update=e.need_buffers_update,t.positions=N.clone_object_r(e.positions),t.positions_cache=N.clone_object_r(e.positions_cache),t.tbn=N.clone_object_r(e.tbn),t.tbn_cache=N.clone_object_r(e.tbn_cache),t.delay_attrs=N.clone_object_r(e.delay_attrs),t.delay_attrs_masked=N.clone_object_r(e.delay_attrs_masked),t.emitter_tsr_snapshots=N.clone_object_r(e.emitter_tsr_snapshots),t.p_data=N.clone_object_r(e.p_data),t.tilt=e.tilt,t.tilt_rand=e.tilt_rand,t};var U=function(){N.panic("_rand() undefined")};t.update=function(){for(var e=0;e<D.length;e++)for(var t=D[e],r=t.scenes_data,a=0;a<r.length;a++)n(t,r[a].batches)},t.obj_has_particles=function(e){for(var t=e.scenes_data,r=0;r<t.length;r++)for(var a=t[r].batches,n=0;n<a.length;n++)if(a[n].particles_data)return!0;return!1},t.obj_has_psys=function(e,t){for(var r=e.scenes_data,a=0;a<r.length;a++)for(var n=r[a].batches,_=0;_<n.length;_++){var s=n[_].particles_data;if(s&&s.name==t)return!0}return!1},t.obj_has_anim_particles=function(e){for(var t=e.scenes_data,r=0;r<t.length;r++)for(var a=t[r].batches,n=0;n<a.length;n++){var _=a[n].particles_data;if(_&&"EMITTER"==_.p_type)return!0}return!1},t.bpy_obj_has_particles=function(e){return e.particle_systems.length>0},t.bpy_obj_has_anim_particles=function(e){for(var t=0;t<e.particle_systems.length;t++)if("EMITTER"==e.particle_systems[t].settings.type)return!0;return!1},t.has_dynamic_grass_particles=function(e){for(var t=0;t<e.particle_systems.length;t++){var r=e.particle_systems[t].settings;if("HAIR"==r.type&&r.b4w_dynamic_grass)return!0}return!1},t.create_particles_data=function(e,t,a){var n=e.particles_data=r(t.name,t.settings.type);n.frame_start=t.settings.frame_start,n.frame_end=t.settings.frame_end,n.time_length=(n.frame_end-n.frame_start)/R.get_framerate(),n.lifetime_frames=t.settings.lifetime,n.lifetime=n.lifetime_frames/R.get_framerate(),n.cyclic=t.settings.b4w_cyclic?1:0,n.mass=t.settings.mass,n.nfactor=t.settings.normal_factor,n.gravity=9.81*t.settings.effector_weights.gravity,n.fade_in=t.settings.b4w_fade_in/R.get_framerate(),n.fade_out=t.settings.b4w_fade_out/R.get_framerate(),n.wind_factor=t.settings.effector_weights.wind,n.use_world_space="WORLD"==t.settings.b4w_coordinate_system;var _,s,o;if(e.halo_particles){_=a.halo_settings.size;var i=a.halo_settings.hardness;i<30?(s=.5,o=.9):i<40?(s=.1,o=1):i<50?(s=0,o=.8):(s=0,o=.5)}else _=t.settings.particle_size,s=1,o=1;n.size=_,n.alpha_start=s,n.alpha_end=o,a.use_nodes&&"BILLBOARD"==t.settings.render_type&&(E.set_batch_directive(e,"NODES",1),E.set_batch_directive(e,"PARTICLE_BATCH",1),e.has_nodes=!0);var l=t.settings.texture_slots;if(l[0]&&l[0].use_map_size&&l[0].texture&&"BLEND"==l[0].texture.type&&l[0].texture.use_color_ramp&&S.allow_vertex_textures){var c=l[0].texture,u=[];O.calc_color_ramp_data(c.color_ramp,O.PART_COLORRAMP_TEXT_SIZE,u),u=new Uint8Array(u.map(function(e){return N.clamp(255*e,0,255)}));var d=O.create_color_ramp_texture(u,O.PART_COLORRAMP_TEXT_SIZE);E.append_texture(e,d,"u_color_ramp_tex",c.name),E.set_batch_directive(e,"USE_COLOR_RAMP",1)}var f=a.texture_slots,m=[-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0];if(f[0]&&"STRAND"==f[0].texture_coords&&f[0].texture&&"BLEND"==f[0].texture.type&&f[0].texture.use_color_ramp){for(var p=f[0].texture.color_ramp.elements,h=Math.min(4*p.length,m.length),v=0;v<h;v+=4){var b=p[v/4];m[v]=b.position,m[v+1]=b.color[0],m[v+2]=b.color[1],m[v+3]=b.color[2]}n.color_ramp_length=p.length}n.color_ramp.set(m)},t.generate_emitter_particles_submesh=function(e,t,r,n){var i=e.particles_data,l=n.world_tsr,c=r.settings.count,u=r.settings.frame_start/R.get_framerate(),p=r.settings.frame_end/R.get_framerate(),h=r.settings.lifetime/R.get_framerate(),v=r.settings.lifetime_random,g=r.settings.emit_from,y=r.settings.factor_random;if(r.settings.use_rotations)var E=r.settings.angular_velocity_mode,w=r.settings.angular_velocity_factor;else var E="NONE",w=0;var T=r.settings.b4w_randomize_emission,x=r.settings.b4w_cyclic;i.tilt=r.settings.billboard_tilt,i.tilt_rand=r.settings.billboard_tilt_random,_(r.seed);var O=o(c,g,A.extract_submesh_all_mats(t,["a_position","a_tbn"],null,n)),k=O[0],M=O[1];i.positions=new Float32Array(k),i.tbn=new Float32Array(M),i.positions_cache=new Float32Array(k.length),i.tbn_cache=new Float32Array(M.length);var I=d(c,u,p,T,x);if(i.delay_attrs=new Float32Array(I),i.delay_attrs_masked=new Float32Array(I),i.use_world_space){i.emitter_tsr_snapshots=new Float32Array(8*I.length);for(var S=0;S<8*I.length;S++)for(var L=0;L<8;L++)i.emitter_tsr_snapshots[8*S+L]=l[L];a(i,k,M,l,k,M)}var C=A.init_submesh("EMITTER_PARTICLES"),P=N.create_empty_va_frame();P.a_position=k,P.a_tbn=M,C.va_frames[0]=P,e.draw_mode=A.DM_DYNAMIC_TRIANGLES,C.indices=s(c),C.va_common.a_p_bb_vertex=A.gen_bb_vertices(c),C.base_length=k.length/3;var D=f(c,h,v);return C.va_common.a_p_data=m(c,D,I),C.va_common.a_p_vels=b(c,y,E,w),i.p_data=new Float32Array(C.va_common.a_p_data),C},t.set_time=function(e,t,r){for(var a=e.scenes_data,n=0;n<a.length;n++)for(var _=a[n].batches,s=0;s<_.length;s++){var o=_[s].particles_data;o&&o.name==t&&!_[s].forked_batch&&(o.prev_time=o.time,o.time=r)}},t.prepare_lens_flares=function(e){for(var t=e.base_length,r=e.va_frames[0].a_position,a=[],n=[],_=0;_<t;_++)n.push(r[3*_]),a.push(r[3*_+1]),n.push(r[3*_+2]);return a=new Float32Array(a),n=new Float32Array(n),e.va_common.a_lf_dist=a,e.va_common.a_lf_bb_vertex=n,e},t.set_size=function(e,t,r){for(var a=e.scenes_data,n=0;n<a.length;n++)for(var _=a[n].batches,s=0;s<_.length;s++){var o=_[s].particles_data;o&&o.name==t&&(o.size=r)}},t.set_normal_factor=function(e,t,r){for(var a=e.scenes_data,n=0;n<a.length;n++)for(var _=a[n].batches,s=0;s<_.length;s++){var o=_[s].particles_data;o&&o.name==t&&(o.nfactor=r)}},t.get_normal_factor=function(e,t){for(var r=e.scenes_data,a=0;a<r.length;a++)for(var n=r[a].batches,_=0;_<n.length;_++){var s=n[_].particles_data;if(s&&s.name==t)return s.nfactor}return 0},t.set_factor=function(e,t,r){for(var a=e.scenes_data,n=0;n<a.length;n++)for(var _=a[n].batches,s=0;s<_.length;s++){var o=_[s],i=o.particles_data;if(i&&i.name==t){i.count_factor=r;var l=i.delay_attrs;if(1==r)c=l;else if(0==r)for(var c=i.delay_attrs_masked,u=0;u<c.length;u+=4)c[u]=1e4,c[u+1]=c[u],c[u+2]=c[u],c[u+3]=c[u];else for(var d=4/r,c=i.delay_attrs_masked,f=0,u=0;u<c.length;u+=4)u>=f?(c[u]=l[u],f+=d):c[u]=1e4,c[u+1]=c[u],c[u+2]=c[u],c[u+3]=c[u];var m=o.bufs_data;if(m.pointers.a_p_data){for(var p=i.p_data,u=0;u<p.length;u+=3)p[u+1]=c[Math.round(u/3)];A.update_bufs_data_array(m,"a_p_data",3,p)}}}},t.update_start_pos=function(e,t,r){for(var a=e.scenes_data,n=0;n<a.length;n++)for(var _=a[n].batches,s=0;s<_.length;s++){var o=_[s].particles_data;if(o&&o.use_world_space)for(var i=0;i<8*o.delay_attrs.length;i++)o.emitter_tsr_snapshots[8*i]=t[0],o.emitter_tsr_snapshots[8*i+1]=t[1],o.emitter_tsr_snapshots[8*i+2]=t[2],o.emitter_tsr_snapshots[8*i+3]=t[3],o.emitter_tsr_snapshots[8*i+4]=r[0],o.emitter_tsr_snapshots[8*i+5]=r[1],o.emitter_tsr_snapshots[8*i+6]=r[2],o.emitter_tsr_snapshots[8*i+7]=r[3]}},t.update_particles_submesh=function(e,t,r){if(e.va_common.a_tbn=T.create(4*r),T.identity(e.va_common.a_tbn),t.part_node_data){for(var a=[],n=0;n<r;n++)a.push(n,n,n,n);e.va_common[t.part_node_data.name]=new Float32Array(a)}},t.update_particles_objs_cache=function(e){-1==D.indexOf(e)&&D.push(e)},t.remove_obj_from_cache=function(e){var t=D.indexOf(e);-1!=t&&D.splice(t,1)},t.cleanup=function(){D.length=0}}),M=o("__ipc",function(e,t){function r(e,t,r){for(var a=0;a<v.length;a+=2)v[a+1]==e&&(p[a+Number(!t)]=r)}function a(e,t){for(var r=0;r<v.length;r+=2)if(v[r+1]==e)return p[r+Number(!t)];return null}function n(e){for(var t=0;t<e.length;t++){var r=e[t],a=0;for(var n in r){var _=r[n];switch(_.constructor){case Float32Array:a+=_.length;break;case Number:a+=1}}a-=1,r.len=a}}var _=h(e),s=ce(e),o=!0;t.IN_LOADED=0,t.IN_COLLISION=1,t.IN_COLLISION_POS_NORM=2,t.IN_COLLISION_IMPULSE=3,t.IN_ERROR=4,t.IN_FBMSG=5,t.IN_FLOATER_BOB_TRANSFORM=6,t.IN_LOG=7,t.IN_PROP_OFFSET=8,t.IN_RAY_HIT=9,t.IN_RAY_HIT_POS_NORM=10,t.IN_REMOVE_RAY_TEST=11,t.IN_TRANSFORM=12,t.IN_VEHICLE_SPEED=13,t.IN_PING=14,t.IN_FPS=15,t.IN_DEBUG_STATS=16;var i=t.IN_COLLISION,l=t.IN_COLLISION_POS_NORM,c=t.IN_PROP_OFFSET,u=t.IN_RAY_HIT,d=t.IN_RAY_HIT_POS_NORM,f=t.IN_TRANSFORM;t.OUT_INIT=100,t.OUT_ACTIVATE=101,t.OUT_ADD_BOAT_BOB=102,t.OUT_ADD_CAR_WHEEL=103,t.OUT_ADD_FLOATER_BOB=104,t.OUT_APPEND_BOUNDING_BODY=105,t.OUT_APPEND_BOAT=106,t.OUT_APPEND_CAR=107,t.OUT_APPEND_CHARACTER=108,t.OUT_APPEND_COLLISION_TEST=109,t.OUT_APPEND_CONSTRAINT=110,t.OUT_APPEND_FLOATER=111,t.OUT_APPEND_GHOST_MESH_BODY=112,t.OUT_APPEND_STATIC_MESH_BODY=113,t.OUT_APPEND_WATER=114,t.OUT_REMOVE_BODY=115,t.OUT_APPLY_CENTRAL_FORCE=116,t.OUT_APPLY_COLLISION_IMPULSE_TEST=117,t.OUT_APPLY_TORQUE=118,t.OUT_CHARACTER_JUMP=119,t.OUT_CHARACTER_ROTATION_INCREMENT=120,t.OUT_CLEAR_COLLISION_IMPULSE_TEST=121,t.OUT_DISABLE_SIMULATION=122,t.OUT_ENABLE_SIMULATION=123,t.OUT_PAUSE=124,t.OUT_APPEND_RAY_TEST=125,t.OUT_REMOVE_RAY_TEST=126,t.OUT_CHANGE_RAY_TEST_FROM_TO=127,t.OUT_REMOVE_COLLISION_TEST=128,t.OUT_REMOVE_CONSTRAINT=129,t.OUT_RESUME=130,t.OUT_SET_CHARACTER_FLY_VELOCITY=131,t.OUT_SET_CHARACTER_HOR_ROTATION=132,t.OUT_SET_CHARACTER_MOVE_DIR=133,t.OUT_SET_CHARACTER_MOVE_TYPE=134,t.OUT_SET_CHARACTER_ROTATION=135,t.OUT_SET_CHARACTER_RUN_VELOCITY=136,t.OUT_SET_CHARACTER_VERT_ROTATION=137,t.OUT_SET_CHARACTER_WALK_VELOCITY=138,t.OUT_SET_GRAVITY=139,t.OUT_SET_LINEAR_VELOCITY=140,t.OUT_SET_TRANSFORM=141,t.OUT_SET_WATER_TIME=142,t.OUT_ADD_WATER_WRAPPER=143,t.OUT_UPDATE_BOAT_CONTROLS=144,t.OUT_UPDATE_CAR_CONTROLS=145,t.OUT_PING=146,t.OUT_DEBUG=147,t.OUT_UPDATE_WORLD=148,t.OUT_SET_ANGULAR_VELOCITY=149,t.OUT_SET_CHARACTER_VERT_MOVE_DIR_ANGLE=150;var m=t.OUT_SET_TRANSFORM,p=b4w.worker_listeners,v=b4w.worker_namespaces,b={msg_id:f,body_id:0,time:0,trans:new Float32Array(3),quat:new Float32Array(4),linvel:new Float32Array(3),angvel:new Float32Array(3),len:0},g={msg_id:c,chassis_hull_body_id:0,prop_ind:0,trans:new Float32Array(3),quat:new Float32Array(4),len:0},y={msg_id:u,id:0,body_id_hit:0,hit_fract:0,hit_time:0,len:0},E={msg_id:d,id:0,body_id_hit:0,hit_fract:0,hit_time:0,hit_pos:new Float32Array(3),hit_norm:new Float32Array(3),len:0},w={msg_id:i,body_id_a:0,body_id_b:0,result:0,len:0},A={msg_id:l,body_id_a:0,body_id_b:0,result:0,coll_point:new Float32Array(3),coll_norm:new Float32Array(3),coll_dist:0,len:0},T={msg_id:m,body_id:0,trans:new Float32Array(3),quat:new Float32Array(4),len:0},x=[b,g,y,E,w,A,T];t.create_worker=function(e,t){var n={is_main:!!e,web_worker:null,buf_arr:[],fb_worker_ns:""};if(t){var i={addEventListener:function(e,t,a){"message"!=e&&_.panic("Wrong web worker event"),r(n.fb_worker_ns,n.is_main,t)},removeEventListener:function(e,t,a){"message"!=e&&_.panic("Wrong web worker event"),r(n.fb_worker_ns,n.is_main,null)},postMessage:function(e,t){a(n.fb_worker_ns,!n.is_main)({data:e})},terminate:function(){for(var e=0;e<v.length;e+=2)if(v[e+1]==n.fb_worker_ns)return p.splice(e,2),void v.splice(e,2)}};if(n.web_worker=i,n.is_main){var l=b4w.get_namespace(require),c=_.unique_name(l+"_worker");v.push(l),v.push(c),p.push(null),p.push(null),n.fb_worker_ns=c;var u=s.find_script(e);u?o?u.addEventListener("load",function(){b4w.require("__bindings",n.fb_worker_ns)},!1):(b4w.cleanup("__bindings",n.fb_worker_ns),b4w.cleanup("__ipc",n.fb_worker_ns),b4w.require("__bindings",n.fb_worker_ns)):((u=document.createElement("script")).src=e,u.defer="defer",u.async="async",u.addEventListener("load",function(){o=!1,b4w.require("__bindings",n.fb_worker_ns)},!1),document.head.appendChild(u))}else n.fb_worker_ns=b4w.get_namespace(require)}else n.web_worker=e?new Worker(e):self;return n},t.attach_handler=function(e,t){n(x);var r=function(a){if(a.constructor==ArrayBuffer)a=new Float32Array(a);else if(a[0].constructor==ArrayBuffer){for(var n=0;n<a.length;n++)r(a[n]);return}var _=0|a[0];switch(_){case f:(s=b).body_id=0|a[1],s.time=a[2],s.trans[0]=a[3],s.trans[1]=a[4],s.trans[2]=a[5],s.quat[0]=a[6],s.quat[1]=a[7],s.quat[2]=a[8],s.quat[3]=a[9],s.linvel[0]=a[10],s.linvel[1]=a[11],s.linvel[2]=a[12],s.angvel[0]=a[13],s.angvel[1]=a[14],s.angvel[2]=a[15];break;case c:(s=g).chassis_hull_body_id=0|a[1],s.prop_ind=0|a[2],s.trans[0]=a[3],s.trans[1]=a[4],s.trans[2]=a[5],s.quat[0]=a[6],s.quat[1]=a[7],s.quat[2]=a[8],s.quat[3]=a[9];break;case u:(s=y).id=0|a[1],s.body_id_hit=0|a[2],s.hit_fract=a[3],s.hit_time=a[4];break;case d:(s=E).id=0|a[1],s.body_id_hit=0|a[2],s.hit_fract=a[3],s.hit_time=a[4],s.hit_pos[0]=a[5],s.hit_pos[1]=a[6],s.hit_pos[2]=a[7],s.hit_norm[0]=a[8],s.hit_norm[1]=a[9],s.hit_norm[2]=a[10];break;case i:(s=w).body_id_a=0|a[1],s.body_id_b=0|a[2],s.result=!!a[3];break;case l:(s=A).body_id_a=0|a[1],s.body_id_b=0|a[2],s.result=!!a[3],s.coll_point[0]=a[4],s.coll_point[1]=a[5],s.coll_point[2]=a[6],s.coll_norm[0]=a[7],s.coll_norm[1]=a[8],s.coll_norm[2]=a[9],s.coll_dist=a[10];break;case m:(s=T).body_id=0|a[1],s.trans[0]=a[2],s.trans[1]=a[3],s.trans[2]=a[4],s.quat[0]=a[5],s.quat[1]=a[6],s.quat[2]=a[7],s.quat[3]=a[8];break;default:var s=a}t(e,_,s)};e.web_worker.addEventListener("message",function(e){r(e.data)},!1)},t.cleanup=function(){},t.post_msg=function(e,t){if(e)switch(t){case f:r=b,(a=new Float32Array(r.len))[0]=r.msg_id,a[1]=r.body_id,a[2]=r.time,a[3]=r.trans[0],a[4]=r.trans[1],a[5]=r.trans[2],a[6]=r.quat[0],a[7]=r.quat[1],a[8]=r.quat[2],a[9]=r.quat[3],a[10]=r.linvel[0],a[11]=r.linvel[1],a[12]=r.linvel[2],a[13]=r.angvel[0],a[14]=r.angvel[1],a[15]=r.angvel[2],e.buf_arr.push(a.buffer);break;case c:r=g,(a=new Float32Array(r.len))[0]=r.msg_id,a[1]=r.chassis_hull_body_id,a[2]=r.prop_ind,a[3]=r.trans[0],a[4]=r.trans[1],a[5]=r.trans[2],a[6]=r.quat[0],a[7]=r.quat[1],a[8]=r.quat[2],a[9]=r.quat[3],e.buf_arr.push(a.buffer);break;case u:r=y,(a=new Float32Array(r.len))[0]=r.msg_id,a[1]=r.id,a[2]=r.body_id_hit,a[3]=r.hit_fract,a[4]=r.hit_time,e.buf_arr.push(a.buffer);break;case d:r=E,(a=new Float32Array(r.len))[0]=r.msg_id,a[1]=r.id,a[2]=r.body_id_hit,a[3]=r.hit_fract,a[4]=r.hit_time,a[5]=r.hit_pos[0],a[6]=r.hit_pos[1],a[7]=r.hit_pos[2],a[8]=r.hit_norm[0],a[9]=r.hit_norm[1],a[10]=r.hit_norm[2],e.buf_arr.push(a.buffer);break;case i:r=w,(a=new Float32Array(r.len))[0]=r.msg_id,a[1]=r.body_id_a,a[2]=r.body_id_b,a[3]=r.result,e.buf_arr.push(a.buffer);break;case l:r=A,(a=new Float32Array(r.len))[0]=r.msg_id,a[1]=r.body_id_a,a[2]=r.body_id_b,a[3]=r.result,a[4]=r.coll_point[0],a[5]=r.coll_point[1],a[6]=r.coll_point[2],a[7]=r.coll_norm[0],a[8]=r.coll_norm[1],a[9]=r.coll_norm[2],a[10]=r.coll_dist,e.buf_arr.push(a.buffer);break;case m:var r=T;(a=new Float32Array(r.len))[0]=r.msg_id,a[1]=r.body_id,a[2]=r.trans[0],a[3]=r.trans[1],a[4]=r.trans[2],a[5]=r.quat[0],a[6]=r.quat[1],a[7]=r.quat[2],a[8]=r.quat[3],e.buf_arr.push(a.buffer);break;default:for(var a=[],n=1;n<arguments.length;n++)a.push(arguments[n]);e.web_worker.postMessage(a)}},t.post_msg_arr=function(e){e&&e.buf_arr.length&&(e.web_worker.postMessage(e.buf_arr),e.buf_arr.length=0)},t.get_msg_cache=function(e){switch(e){case f:return b;case c:return g;case u:return y;case d:return E;case i:return w;case l:return A;case m:return T;default:return null}},t.terminate=function(e){e.web_worker.terminate(),e.web_worker=null},t.is_active=function(e){return!!e.web_worker},t.is_fallback=function(e){return!!e.fb_worker_ns}}),I=o("__hud",function(e,t){function r(e){e.font="bold 15px Courier New",e.textBaseline="middle",e.shadowBlur=0,e.shadowColor=null}function a(e){if(s(' SCENE "'+e.name+'"'),s(" Active                 Subscene   Lamps   Size   RenderCalls   Time"),e._render){var t=0,r=0,a=0,n=e._render.graph;return v.traverse(n,function(e,n){var _=n;if(_.type!=b.SINK){for(var o=Math.round(_.camera.width)+"x"+Math.round(_.camera.height),i=0,l=0;l<_.draw_data.length;l++)i+=_.draw_data[l].bundles.length;var c=_.debug_render_calls;_.type!=b.MAIN_CUBE_REFLECT&&_.type!=b.MAIN_CUBE_REFLECT_BLEND||(i*=6);var u=_.do_render&&!_.force_do_not_render,d=u?_.debug_render_time:0;_.enqueue||(_.debug_render_time=0),s(u?" ()":" ()",b.subs_label(_),_.num_lights,o,c,"of",i,"  ",d.toFixed(3)),_.debug_render_calls=0,t+=i,u&&(r+=c,a+=d)}}),[t,r,a]}s("No INFO")}function n(){O[0]=0,O[1]=0}function _(){O[0]++}function s(){for(var e=g,t=y+O[0]*w,r=arguments[0],a=1;a<arguments.length;a++){var n=arguments[a];r+=o(T[a]-String(n).length)+arguments[a]}_(),x.fillText(r,e,t)}function o(e){for(var t="",r=0;r<e;r++)t+=" ";return t}function i(){return{x:0,y:0,w:0,h:0}}function l(e,t,r,a,n){return n.x=e,n.y=t,n.w=r,n.h=a,n}function c(e,t,r,a){var n=e.w/r;return a.x=e.x+n*t,a.y=e.y,a.w=n,a.h=e.h,a}function u(e,t,r,a){var n=e.h/r;return a.x=e.x,a.y=e.y+n*t,a.w=e.w,a.h=n,a}function d(e,t,r){var a=e.w*t;return r.x=e.x+a,r.y=e.y,r.w=e.w-2*a,r.h=e.h,r}function f(e,t,r){var a=e.h*t;return r.x=e.x,r.y=e.y+a,r.w=e.w,r.h=e.h-2*a,r}function m(e){return e.x+e.w/2}function p(e){var t=x,r=i();return l(0,0,t.canvas.width,t.canvas.height,r),d(r,.01,r),f(r,.02,r),c(r,e,8,r),d(r,.02,r),r}function h(e,t,r,a,n){var _=a[0],s=a[1],o=a[2],i=a[3],l=a[4],c=a[5],u=(i-o)/l;if(u<1)d=Math.floor(1/u-1e-5).toFixed(0).length;else var d=0;if(c)f=Math.log(s/o)/Math.log(i/o);else var f=(s-o)/(i-o);if(e.textAlign="center",n?e.fillText("["+_+"]",m(r),r.y):e.fillText(_,m(r),r.y),e.strokeStyle="#00FF00",e.lineWidth=t?3:1,t?(e.textAlign="right",e.fillText(i.toFixed(d),m(r)-10,r.y+15),e.textAlign="right",e.fillText(o.toFixed(d),m(r)-10,r.y+r.h-15)):(e.textAlign="right",e.fillText(o.toFixed(d),r.x+28,r.y+15),e.textAlign="left",e.fillText(i.toFixed(d),r.x+r.w-28,r.y+15)),e.beginPath(),t){var p=r.y+15+(r.h-30)*(1-f);e.moveTo(m(r),r.y+15),e.lineTo(m(r),r.y+r.h-15),e.moveTo(m(r)-5,r.y+15),e.lineTo(m(r)+5,r.y+15),e.moveTo(m(r)-5,r.y+r.h-15),e.lineTo(m(r)+5,r.y+r.h-15),e.moveTo(m(r)-5,p),e.lineTo(m(r)+5,p)}else{var h=r.x+30+(r.w-60)*f;e.moveTo(r.x+30,r.y+15),e.lineTo(r.x+r.w-30,r.y+15),e.moveTo(r.x+30,r.y+15-5),e.lineTo(r.x+30,r.y+15+5),e.moveTo(r.x+r.w-30,r.y+15-5),e.lineTo(r.x+r.w-30,r.y+15+5),e.moveTo(h,r.y+15-5),e.lineTo(h,r.y+15+5)}if(e.stroke(),"EQ_Q"==_){var v=s,b=1+1/(2*v*v)+Math.sqrt((2+1/(v*v))*(2+1/(v*v))/4-1),g=Math.log(b)/Math.log(2);t?(e.textAlign="left",e.fillText(s.toFixed(d),m(r)+10,p),e.textAlign="left",e.fillText("("+g.toFixed(d+1)+")",m(r)+10,p+10)):(e.textAlign="right",e.fillText(s.toFixed(d),h,r.y+30),e.textAlign="left",e.fillText("("+g.toFixed(d+1)+")",h,r.y+30))}else t?(e.textAlign="left",e.fillText(s.toFixed(d),m(r)+10,p)):(e.textAlign="center",e.fillText(s.toFixed(d),h,r.y+30))}var v=E(e),b=A(e),g=30,y=80,w=20,T=[5,30,4,10,5,3,5],x=null,O=[0,0];t.init=function(e){var t=e.getContext("2d");return r(t),x=t,t},t.update_dim=function(){x&&r(x)},t.reset=function(){var e=x;e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="rgba(0,0,0,0.5)",e.fillRect(0,0,e.canvas.width,e.canvas.height),n())},t.show_debug_info=function(e,t){var r=x;if(r){r.textAlign="left",r.fillStyle="rgba(0,255,0,255)",s(" FPS",(1/t).toFixed(2)),_();for(var n=0,o=0,i=0,l=0;l<e.length;l++){var c=a(e[l]);n+=c[0],o+=c[1],i+=c[2],_()}s(" ----------------------------------------------------------------"),s("    ","TOTAL ACTIVE","","",o,"of",n,"  ",i.toFixed(3))}},t.print=function(){var e=x;e&&(e.textAlign="left",e.fillStyle="rgba(0,255,0,255)",s.apply(Math,arguments))},t.plot_array=function(e,t,r,a,n,_,s){var o=x;if(o){var i=p(t);if(u(i,4,5,i),o.textAlign="center",o.fillStyle="#00FF00",x.fillText(e,m(i),i.y-10),o.strokeStyle="#00FF00",o.lineWidth=.5,o.beginPath(),o.moveTo(i.x,i.y),o.lineTo(i.x+i.w,i.y),o.lineTo(i.x+i.w,i.y+i.h),o.lineTo(i.x,i.y+i.h),o.closePath(),o.stroke(),!_&&!s)for(_=1e6,s=-1e6,d=0;d<r.length;d++)_=Math.min(_,r[d]),s=Math.max(s,r[d]);o.textAlign="right",x.fillText(String(_),i.x-10,i.y+i.h),x.fillText(String(s),i.x-10,i.y),o.textAlign="center",x.fillText(String(a),i.x,i.y+i.h+15),x.fillText(String(n),i.x+i.w,i.y+i.h+15),o.strokeStyle="#FF0000",o.lineWidth=1.5,o.beginPath();for(var l=i.w/(r.length-1),c=i.h/(s-_),d=0;d<r.length;d++){var f=i.x+l*d,h=i.y+i.h-(r[d]-_)*c;0==d?o.moveTo(f,h):o.lineTo(f,h)}o.stroke()}},t.draw_mixer_strip=function(e,t,r,a,n,_,s){var o=x;if(o){o.textAlign="center",o.fillStyle="#00FF00",o.font="bold 12px Courier";var c=p(r),u=t?"["+e+"]":e;x.fillText(u,m(c),c.y),_>=0&&x.fillText(_?"[M]":"[ ]",m(c)-15,c.y+30),s>=0&&x.fillText(s?"[S]":"[ ]",m(c)+15,c.y+30);for(var d=i(),f=0;f<a.length;f++){var v=a[f],b="VOLUME"==v[0];b?l(c.x,c.y+350,c.w,250,d):l(c.x,c.y+50+50*f,c.w,c.h,d),h(o,b,d,v,f==n)}}}}),S=o("__input",function(e,t){function r(e){var t=Q.detect_mobile();return!(!(e!=pe||navigator.getVRDevices||navigator.getVRDisplays||t&&Z())||!(e!=me||t&&window.DeviceOrientationEvent))}function a(e,t){if(!r(e))return null;var a={type:e,registered:!1,orientation_quat_cb_list:[],orientation_angles_cb_list:[],mouse_down_which_cb_list:[],mouse_location_cb_list:[],mouse_up_which_cb_list:[],mouse_wheel_cb_list:[],keyboard_down_cb_list:[],keyboard_down_mod_cb_list:[],keyboard_up_cb_list:[],touch_start_cb_list:[],touch_move_cb_list:[],touch_end_cb_list:[],element:t,prevent_default:!0,registered_event_listeners:[],mouse_location:new Float32Array(2),mouse_which:0,distortion_coefs:new Float32Array(2),chromatic_aberration_coefs:new Float32Array(4),registered_cb:null,webvr_hmd_device:null,webvr_sensor_devices:null,webvr_display:null,orientation:ne.create(),position:se.create(),frame_data:window.VRFrameData?new VRFrameData:null,standing_tsr:ae.create(),fov_left:new Float32Array(4),fov_right:new Float32Array(4),inter_lens_dist:0,base_line_dist:0,screen_to_lens_dist:0,width_dist:0,height_dist:0,bevel_size:0,gamepad_btns:[],gamepad_axes:[0,0,0,0,0,0,0,0,0,0,0,0],gamepad_prev_axes:[0,0,0,0,0,0,0,0,0,0,0,0],gamepad_mapping:[]};return a.fov_left[0]=a.fov_left[1]=a.fov_left[2]=a.fov_left[3]=Math.PI/4,a.fov_right[0]=a.fov_right[1]=a.fov_right[2]=a.fov_right[3]=Math.PI/4,e==he||e==ve||e==be?(a.registered=Boolean(t),e==be?document.addEventListener("touchstart",function(){}):e==ve&&(a.prevent_default=!1)):e==me?a.registered=!0:e==pe&&_(a),a}function n(e,t){e==me||e==pe?t=window:t||(t=e==ve?document:J.get_container());for(var r=0;r<Ze.length;r++)if(Ze[r].type==e&&Ze[r].element==t)return Ze[r];var n=a(e,t);return e!=ge&&e!=ye&&e!=Ee&&e!=we||s(n),n&&Ze.push(n),n}function _(e){e.type==pe&&(navigator.getVRDisplays?navigator.getVRDisplays().then(function(t){t.length>0&&(e.webvr_display=t[0],e.registered=!0,e.webvr_display.getFrameData(e.frame_data),e.registered_cb&&e.registered_cb())},function(t){te.error_once("WebVR displays are not found."),e.registered=!1}):navigator.getVRDevices?(navigator.getVRDevices().then(function(t){p(e,t),t.length&&(e.registered=!0),e.registered_cb&&e.registered_cb()},function(t){te.error_once("WebVR devices are not found."),e.registered=!1}),u(e,le.webvr)):(o(e),e.registered=!0))}function s(e){e.gamepad_mapping.push(t.GMPD_BUTTON_0,t.GMPD_BUTTON_1,t.GMPD_BUTTON_2,t.GMPD_BUTTON_3,t.GMPD_BUTTON_4,t.GMPD_BUTTON_5,t.GMPD_BUTTON_6,t.GMPD_BUTTON_7,t.GMPD_BUTTON_8,t.GMPD_BUTTON_9,t.GMPD_BUTTON_10,t.GMPD_BUTTON_11,t.GMPD_BUTTON_12,t.GMPD_BUTTON_13,t.GMPD_BUTTON_14,t.GMPD_BUTTON_15,t.GMPD_BUTTON_16,t.GMPD_BUTTON_17,t.GMPD_BUTTON_18,t.GMPD_BUTTON_19,t.GMPD_BUTTON_20,t.GMPD_BUTTON_21,t.GMPD_BUTTON_22,t.GMPD_BUTTON_23,t.GMPD_BUTTON_24,t.GMPD_BUTTON_25,t.GMPD_AXIS_0,t.GMPD_AXIS_1,t.GMPD_AXIS_2,t.GMPD_AXIS_3,t.GMPD_AXIS_4,t.GMPD_AXIS_5,t.GMPD_AXIS_6,t.GMPD_AXIS_7,t.GMPD_AXIS_8,t.GMPD_AXIS_9,t.GMPD_AXIS_10,t.GMPD_AXIS_11)}function o(e){var t=le.nonwebvr;e.width_dist=t.width_dist,e.height_dist=t.height_dist,e.bevel_size=t.bevel_size,u(e,t),e.inter_lens_dist=t.inter_lens_dist,e.base_line_dist=t.base_line_dist,e.screen_to_lens_dist=t.screen_to_lens_dist,f(e)}function u(e,t){e.distortion_coefs[0]=t.distortion_coefs[0],e.distortion_coefs[1]=t.distortion_coefs[1],e.chromatic_aberration_coefs[0]=t.chromatic_aberration_coefs[0],e.chromatic_aberration_coefs[1]=t.chromatic_aberration_coefs[1],e.chromatic_aberration_coefs[2]=t.chromatic_aberration_coefs[2],e.chromatic_aberration_coefs[3]=t.chromatic_aberration_coefs[3]}function f(e){var t=e.inter_lens_dist/2/e.screen_to_lens_dist,r=Math.atan(t*le.nonwebvr.distor_scale),a=r,n=r,_=r;_&&(e.fov_left[0]=e.fov_right[0]=Math.min(_,Math.PI/3)),r&&(e.fov_left[1]=e.fov_right[3]=Math.min(r,Math.PI/3)),n&&(e.fov_left[2]=e.fov_right[2]=Math.min(n,Math.PI/3)),a&&(e.fov_left[3]=e.fov_right[1]=Math.min(a,Math.PI/3))}function p(e,t){var r=t.filter(function(e){return e instanceof HMDVRDevice}),a=null;r.length&&(a=r[0]);var n=null;a&&(n=t.filter(function(e){return-1!==e.deviceName.toLowerCase().indexOf("oculus")&&e.hardwareUnitId==a.hardwareUnitId&&e instanceof PositionSensorVRDevice})),e.webvr_hmd_device=a,e.webvr_sensor_devices=n}function b(e,t,r){switch(e.type){case pe:var a=E(e,ke);if(a&Ae){if("left"==t)n=e.fov_left;else var n=e.fov_right;oe.copy(n,r)}else{var _=e.webvr_display||e.webvr_hmd_device;if(_){var s=_.getEyeParameters(t);if(n=s.fieldOfView||s.currentFieldOfView)r[0]=_e.deg_to_rad(n.upDegrees),r[1]=_e.deg_to_rad(n.rightDegrees),r[2]=_e.deg_to_rad(n.downDegrees),r[3]=_e.deg_to_rad(n.leftDegrees);else if(a&Re){var o=fe;"left"==t?ee.copy(e.frame_data.leftProjectionMatrix,o):ee.copy(e.frame_data.rightProjectionMatrix,o),r[0]=Math.atan(-We[1]/We[2]),r[1]=Math.atan(-We[0]/We[2]),r[2]=Math.atan(We[1]/We[2]),r[3]=Math.atan(We[0]/We[2])}}}break;default:te.error("fov is undefined for device: ",e.type)}return r}function y(e,t,r){switch(e.type){case pe:e.webvr_display&&("left"==t?ee.copy(e.frame_data.leftProjectionMatrix,r):"right"==t?ee.copy(e.frame_data.rightProjectionMatrix,r):te.error("Unknown type of eye: ",t));break;default:te.error("Projection matrix is undefined for device: ",e.type)}return r}function E(e,t){switch(t){case ke:var r=0;return navigator.getVRDisplays&&(r|=Oe,e.frame_data&&(r|=Re)),navigator.getVRDevices&&(ie.is_mobile_device?r|=xe:r|=Te),r=r||Ae;case Ne:var a=e.webvr_display||e.webvr_hmd_device;if(a){var n=a.getEyeParameters("left"),_=a.getEyeParameters("right");return e.webvr_display?_.offset[0]-n.offset[0]:_.eyeTranslation.x-n.eyeTranslation.x}return e.inter_lens_dist}}function w(e,t){if(e.webvr_display){var r=e.webvr_display;if(e.frame_data&&r.getFrameData(e.frame_data)){var a=e.frame_data.pose,n=_e.matrix_to_trans(e.frame_data.leftViewMatrix,We);e.inter_lens_dist=2*se.length(n)}else a=r.getPose();if(a){var _=ne.setAxisAngle(_e.AXIS_X,Math.PI/2,Ye);if(r.stageParameters&&r.stageParameters.sittingToStandingTransform){o=ae.from_mat4(r.stageParameters.sittingToStandingTransform,ue),ae.identity(de);var s=ae.set_quat(_,de);o=ae.multiply(s,o,e.standing_tsr)}else{ae.identity(ue);var o=ae.set_quat(_,e.standing_tsr)}a.orientation&&ae.transform_quat(a.orientation,o,e.orientation),a.position&&ae.transform_vec3(a.position,o,e.position)}}}function A(e,t){if(e){for(r=0;r<e.buttons.length;r++)t.gamepad_btns[r]=e.buttons[r].value||+e.buttons[r].pressed;if(e.axes)for(var r=0;r<e.axes.length;r++)t.gamepad_axes[r]=e.axes[r];var a=e.pose;if(a){var _=n(pe).standing_tsr;a.position&&ae.transform_vec3(a.position,_,t.position),a.orientation&&ae.transform_quat(a.orientation,_,t.orientation)}}}function T(e){for(t=0;t<e.gamepad_btns;t++)e.gamepad_btns[t]=0;for(var t=0;t<e.gamepad_axes.length;t++)e.gamepad_prev_axes[t]=e.gamepad_axes[t],e.gamepad_axes[t]=0;e.position.set(_e.VEC3_IDENT),e.orientation.set(_e.QUAT4_IDENT)}function x(e,t){var r=e.indexOf(t);r>=0&&(e[r]=null)}function O(e){return null===e}function R(e,t,r,a){switch(t){case Ge:r&&x(e.orientation_quat_cb_list,r),(a||e.orientation_angles_cb_list.every(O)&&e.orientation_quat_cb_list.every(O))&&(e.orientation_quat_cb_list.length=0,e.orientation_angles_cb_list.length=0,t=ze,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("deviceorientation",L,!1)));break;case je:r&&x(e.orientation_angles_cb_list,r),(a||e.orientation_angles_cb_list.every(O)&&e.orientation_quat_cb_list.every(O))&&(e.orientation_quat_cb_list.length=0,e.orientation_angles_cb_list.length=0,t=ze,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("deviceorientation",L,!1)));break;case Se:r&&x(e.mouse_down_which_cb_list,r),(a||e.mouse_down_which_cb_list.every(O))&&(e.mouse_down_which_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("mousedown",U,!1)));break;case Me:r&&x(e.mouse_location_cb_list,r),(a||e.mouse_location_cb_list.every(O))&&(e.mouse_location_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("mousemove",P,!1)));break;case Ie:r&&x(e.mouse_location_cb_list,r),(a||e.mouse_location_cb_list.every(O))&&(e.mouse_location_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("mousemove",D,!1)));break;case Le:if(r&&x(e.mouse_up_which_cb_list,r),a||e.mouse_up_which_cb_list.every(O)){e.mouse_up_which_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("mouseout",F,!1),e.element.removeEventListener("mouseup",B,!1));break}break;case Ce:r&&x(e.mouse_wheel_cb_list,r),(a||e.mouse_wheel_cb_list.every(O))&&(e.mouse_wheel_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("wheel",j,!1)));break;case De:r&&x(e.keyboard_down_cb_list,r),(a||e.keyboard_down_cb_list.every(O))&&(e.keyboard_down_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("keydown",z,!1)));break;case Pe:r&&x(e.keyboard_up_cb_list,r),(a||e.keyboard_up_cb_list.every(O))&&(e.keyboard_up_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("keyup",Y,!1)));break;case Ue:r&&x(e.touch_start_cb_list,r),(a||e.touch_start_cb_list.every(O))&&(e.touch_start_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("touchstart",H,!1)));break;case Fe:r&&x(e.touch_move_cb_list,r),(a||e.touch_move_cb_list.every(O))&&(e.touch_move_cb_list.length=0,(n=e.registered_event_listeners.indexOf(t))>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("touchmove",W,!1)));break;case Be:if(r&&x(e.touch_end_cb_list,r),a||e.touch_end_cb_list.every(O)){e.touch_end_cb_list.length=0;var n=e.registered_event_listeners.indexOf(t);n>=0&&(e.registered_event_listeners.splice(n,1),e.element.removeEventListener("touchend",q,!1))}}}function k(){return/iPad|iPhone|iPod/.test(navigator.platform)}function N(e,t){switch(t){case Se:k()||e.element.addEventListener("mousedown",U,!1);break;case Me:e.element.addEventListener("mousemove",P,!1);break;case Ie:e.element.addEventListener("mousemove",D,!1);break;case Le:k()||(e.element!=window&&e.element.addEventListener("mouseout",F,!1),e.element.addEventListener("mouseup",B,!1));break;case Ce:e.element.addEventListener("wheel",j,!1);break;case De:e.element.addEventListener("keydown",z,!1);break;case Pe:e.element.addEventListener("keyup",Y,!1);break;case Ue:e.element.addEventListener("touchstart",H,!1);break;case Fe:e.element.addEventListener("touchmove",W,!1);break;case Be:e.element.addEventListener("touchend",q,!1);break;case ze:e.element.addEventListener("deviceorientation",L,!1)}}function M(e,t){switch(e.type){case pe:if(se.copy(_e.QUAT4_IDENT,t),e.webvr_display)t[0]=e.orientation[0],t[1]=e.orientation[1],t[2]=e.orientation[2],t[3]=e.orientation[3];else if(e.webvr_sensor_devices)for(var r=0;r<e.webvr_sensor_devices.length;r++){var a=e.webvr_sensor_devices[r],n=a.getState&&a.getState()||a.getImmediateState&&a.getImmediateState();n.orientation&&(t[0]=n.orientation.x,t[1]=n.orientation.y,t[2]=n.orientation.z,t[3]=n.orientation.w)}return t;default:return te.error("orientation_quat is undefined for device: ",e.type),t}}function I(e,t){switch(e.type){case pe:if(se.copy(_e.VEC3_UNIT,t),e.webvr_display)t[0]=e.position[0],t[1]=e.position[1],t[2]=e.position[2];else if(e.webvr_sensor_devices)for(var r=0;r<e.webvr_sensor_devices.length;r++){var a=e.webvr_sensor_devices[r],n=a.getState&&a.getState()||a.getImmediateState&&a.getImmediateState();n.position&&(t[0]=n.position.x,t[1]=-n.position.z,t[2]=n.position.y)}return t;default:return te.error("position is undefined for device: ",e.type),t}}function S(e,t){if(_e.ordered_angles_to_quat(e,_e.ZXY,t),"orientation"in window)r=_e.deg_to_rad(window.orientation);else if("orientation"in window.screen)r=_e.deg_to_rad(window.screen.orientation.angle);else var r=0;var a=ne.setAxisAngle(_e.AXIS_MZ,r,He);return ne.multiply(t,a,t),t}function L(e){var t=We;null===e.alpha||null===e.beta||null===e.gamma?t[0]=t[1]=t[2]=0:(t[0]=_e.deg_to_rad(e.alpha),t[1]=_e.deg_to_rad(e.beta),t[2]=_e.deg_to_rad(e.gamma));for(var r=n(me,e.currentTarget),a=0;a<r.orientation_angles_cb_list.length;a++)(s=r.orientation_angles_cb_list[a])&&(se.copy(t,Ve),s(Ve));if(r.orientation_quat_cb_list.length)for(var _=S(t,Ye),a=0;a<r.orientation_quat_cb_list.length;a++){var s=r.orientation_quat_cb_list[a];s&&(ne.copy(_,Xe),s(Xe))}for(a=0;a<r.orientation_quat_cb_list.length;a++)r.orientation_quat_cb_list[a]||r.orientation_quat_cb_list.splice(a,1);for(a=0;a<r.orientation_angles_cb_list.length;a++)r.orientation_angles_cb_list[a]||r.orientation_angles_cb_list.splice(a,1)}function C(e,t){switch(e.type){case he:e.mouse_location[0]=t.clientX,e.mouse_location[1]=t.clientY,e.mouse_which=t.which}}function P(e){if(Ke){if(e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents)return;if(5==e.mozInputSource)return}var t=n(he,e.currentTarget);for(C(t,e),a=0;a<t.mouse_location_cb_list.length;a++){var r=t.mouse_location_cb_list[a];r&&(qe[0]=e.clientX,qe[1]=e.clientY,r(qe))}t.prevent_default&&e.preventDefault();for(var a=0;a<t.mouse_location_cb_list.length;a++)t.mouse_location_cb_list[a]||t.mouse_location_cb_list.splice(a,1)}function D(e){if(Ke){if(e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents)return;if(5==e.mozInputSource)return}var t=n(he,e.currentTarget);for(C(t,e),s=0;s<t.mouse_location_cb_list.length;s++){var r=t.mouse_location_cb_list[s];if(r){if("number"==typeof e.movementX)var a=e.movementX,_=e.movementY;else if("number"==typeof e.webkitMovementX)var a=e.webkitMovementX,_=e.webkitMovementY;else if("number"==typeof e.mozMovementX)var a=e.mozMovementX,_=e.mozMovementY;else var a=0,_=0;qe[0]=a,qe[1]=_,r(qe)}}t.prevent_default&&e.preventDefault();for(var s=0;s<t.mouse_location_cb_list.length;s++)t.mouse_location_cb_list[s]||t.mouse_location_cb_list.splice(s,1)}function U(e){if(Ke){if(e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents)return;if(5==e.mozInputSource)return}var t=n(he,e.currentTarget);for(C(t,e),a=0;a<t.mouse_down_which_cb_list.length;a++){var r=t.mouse_down_which_cb_list[a];r&&r(e.which)}t.prevent_default&&(window.frameElement&&window.frameElement.focus(),e.preventDefault());for(var a=0;a<t.mouse_down_which_cb_list.length;a++)t.mouse_down_which_cb_list[a]||t.mouse_down_which_cb_list.splice(a,1)}function F(e){!J.is_child(e.relatedTarget)&&e.which&&B(e)}function B(e){if(Ke){if(e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents)return;if(5==e.mozInputSource)return}var t=n(he,e.currentTarget);for(C(t,e),a=0;a<t.mouse_up_which_cb_list.length;a++){var r=t.mouse_up_which_cb_list[a];r&&r(e.which)}t.prevent_default&&e.preventDefault();for(var a=0;a<t.mouse_up_which_cb_list.length;a++)t.mouse_up_which_cb_list[a]||t.mouse_up_which_cb_list.splice(a,1)}function G(e){var t=0;return e.wheelDelta?t=e.wheelDelta%120==0?e.wheelDelta/120:_e.sign(e.wheelDelta):e.deltaY&&(t=e.deltaY%3==0?-e.deltaY/3:-_e.sign(e.deltaY)),_e.clamp(Qe*t,-Je,Je)}function j(e){for(var t=n(he,e.currentTarget),r=0;r<t.mouse_wheel_cb_list.length;r++){var a=t.mouse_wheel_cb_list[r];a&&a(G(e))}for(t.prevent_default&&e.preventDefault(),r=0;r<t.mouse_wheel_cb_list.length;r++)t.mouse_wheel_cb_list[r]||t.mouse_wheel_cb_list.splice(r,1)}function z(e){for(var t=n(ve,e.currentTarget),r=e.ctrlKey||e.altKey||e.metaKey?t.keyboard_down_mod_cb_list:t.keyboard_down_cb_list,a=0;a<r.length;a++){var _=r[a];_?_(e.keyCode):r.splice(a--,1)}t.prevent_default&&e.preventDefault()}function Y(e){for(var t=n(ve,e.currentTarget),r=0;r<t.keyboard_up_cb_list.length;r++){var a=t.keyboard_up_cb_list[r];a&&a(e.keyCode)}for(t.prevent_default&&e.preventDefault(),r=0;r<t.keyboard_up_cb_list.length;r++)t.keyboard_up_cb_list[r]||t.keyboard_up_cb_list.splice(r,1)}function H(e){for(var t=n(be,e.currentTarget),r=0;r<t.touch_start_cb_list.length;r++){var a=t.touch_start_cb_list[r];a&&a(e.targetTouches)}for(r=0;r<t.touch_start_cb_list.length;r++)t.touch_start_cb_list[r]||t.touch_start_cb_list.splice(r,1)}function W(e){for(var t=n(be,e.currentTarget),r=0;r<t.touch_move_cb_list.length;r++){var a=t.touch_move_cb_list[r];a&&a(e.targetTouches)}for(t.prevent_default&&e.preventDefault(),r=0;r<t.touch_move_cb_list.length;r++)t.touch_move_cb_list[r]||t.touch_move_cb_list.splice(r,1)}function q(e){for(var t=n(be,e.currentTarget),r=0;r<t.touch_end_cb_list.length;r++){var a=t.touch_end_cb_list[r];a&&a(e.targetTouches)}for(r=0;r<t.touch_end_cb_list.length;r++)t.touch_end_cb_list[r]||t.touch_end_cb_list.splice(r,1)}function V(e){switch(e){case 0:t=ge;break;case 1:t=ye;break;case 2:t=Ee;break;case 3:t=we;break;default:var t=ge}return t}function X(e,t){return e.gamepad_mapping[t]}function K(e){var t=e.element,r=function(){document.pointerLockElement===t||document.webkitPointerLockElement===t||document.mozPointerLockElement===t?e.value=1:(e.value=0,document.removeEventListener("pointerlockchange",r,!1),document.removeEventListener("webkitpointerlockchange",r,!1),document.removeEventListener("mozpointerlockchange",r,!1))};document.addEventListener("pointerlockchange",r,!1),document.addEventListener("webkitpointerlockchange",r,!1),document.addEventListener("mozpointerlockchange",r,!1);var a=t.requestPointerLock||t.webkitRequestPointerLock||t.mozRequestPointerLock;"function"==typeof a&&a.apply(t)}function Z(){return!!(window.document.fullscreenEnabled||window.document.mozFullScreenEnabled||window.document.msFullscreenEnabled||window.document.webkitFullscreenEnabled)}var Q=re(e),J=ce(e),$=g(e),ee=i(e),te=m(e),ae=v(e),ne=d(e),_e=h(e),se=l(e),oe=c(e),ie=$.defaults,le=$.hmd_params,ue=ae.create(),de=ae.create(),fe=ee.create(),me=10,pe=20,he=30,ve=40,be=50,ge=60,ye=70,Ee=80,we=90;t.DEVICE_GYRO=me,t.DEVICE_HMD=pe,t.DEVICE_MOUSE=he,t.DEVICE_KEYBOARD=ve,t.DEVICE_TOUCH=be,t.DEVICE_GAMEPAD0=ge,t.DEVICE_GAMEPAD1=ye,t.DEVICE_GAMEPAD2=Ee,t.DEVICE_GAMEPAD3=we;var Ae=1,Te=2,xe=4,Oe=8,Re=16;t.HMD_WEBVR_DESKTOP=Te,t.HMD_WEBVR_MOBILE=xe,t.HMD_NON_WEBVR=Ae,t.HMD_WEBVR1=Oe,t.HMD_WEBVR1_1=Re;var ke=0,Ne=23,Me=40,Ie=41,Se=50,Le=60,Ce=70,Pe=80,De=90,Ue=100,Fe=110,Be=120,Ge=130,je=140,ze=141;t.HMD_WEBVR_TYPE=ke,t.HMD_ORIENTATION_QUAT=10,t.HMD_POSITION=20,t.HMD_FOV_LEFT=21,t.HMD_FOV_RIGHT=22,t.HMD_EYE_DISTANCE=Ne,t.HMD_DISTORTION=24,t.HMD_BASELINE_DIST=25,t.HMD_SCREEN_LENS_DIST=26,t.HMD_SCREEN_WIDTH=27,t.HMD_SCREEN_HEIGHT=28,t.HMD_BEVEL_SIZE=29,t.HMD_PROJ_LEFT=30,t.HMD_PROJ_RIGHT=31,t.MOUSE_LOCATION=Me,t.MOUSE_LOCATION_PL=Ie,t.MOUSE_DOWN_WHICH=Se,t.MOUSE_UP_WHICH=Le,t.MOUSE_WHEEL=Ce,t.KEYBOARD_UP=Pe,t.KEYBOARD_DOWN=De,t.KEYBOARD_DOWN_MODIFIED=91,t.TOUCH_START=Ue,t.TOUCH_MOVE=Fe,t.TOUCH_END=Be,t.GYRO_ORIENTATION_QUAT=Ge,t.GYRO_ORIENTATION_ANGLES=je,t.GMPD_BUTTON_0=300,t.GMPD_BUTTON_1=301,t.GMPD_BUTTON_2=302,t.GMPD_BUTTON_3=303,t.GMPD_BUTTON_4=304,t.GMPD_BUTTON_5=305,t.GMPD_BUTTON_6=306,t.GMPD_BUTTON_7=307,t.GMPD_BUTTON_8=308,t.GMPD_BUTTON_9=309,t.GMPD_BUTTON_10=310,t.GMPD_BUTTON_11=311,t.GMPD_BUTTON_12=312,t.GMPD_BUTTON_13=313,t.GMPD_BUTTON_14=314,t.GMPD_BUTTON_15=315,t.GMPD_BUTTON_16=316,t.GMPD_BUTTON_17=317,t.GMPD_BUTTON_18=318,t.GMPD_BUTTON_19=319,t.GMPD_BUTTON_20=320,t.GMPD_BUTTON_21=321,t.GMPD_BUTTON_22=322,t.GMPD_BUTTON_23=323,t.GMPD_BUTTON_24=324,t.GMPD_BUTTON_25=325,t.GMPD_TRACKPAD_BUTTON=300,t.GMPD_TRIGGER_BUTTON=301,t.GMPD_GRIPS_BUTTON=302,t.GMPD_MENU_BUTTON=303,t.GMPD_AXIS_0=326,t.GMPD_AXIS_1=327,t.GMPD_AXIS_2=328,t.GMPD_AXIS_3=329,t.GMPD_AXIS_4=330,t.GMPD_AXIS_5=331,t.GMPD_AXIS_6=332,t.GMPD_AXIS_7=333,t.GMPD_AXIS_8=334,t.GMPD_AXIS_9=335,t.GMPD_AXIS_10=336,t.GMPD_AXIS_11=337;var Ye=ne.create(),He=ne.create(),We=se.create(),qe=new Float32Array(2),Ve=se.create(),Xe=ne.create(),Ke="ontouchstart"in document.documentElement,Ze=[],Qe=100,Je=2e3;t.can_use_device=r,t.init=function(){if("HMD"==ie.stereo||"NONE"==ie.stereo&&ie.is_mobile_device){var e=n(pe);e&&document.addEventListener("onvrdisplayconnect",function(t){e.webvr_display=t.display,e.registered=!0,e.webvr_display.getFrameData(e.frame_data)})}},t.get_device_by_type_element=n,t.request_register_device=_,t.switch_prevent_default=function(e,t){e.prevent_default=t},t.reset_device=function(e){switch(e.type){case pe:if(e.registered)if(e.webvr_display)e.webvr_display.resetPose();else if(e.webvr_sensor_devices)for(var t=0;t<e.webvr_sensor_devices.length;t++)e.webvr_sensor_devices[t].resetSensor();break;default:return void te.error("reset_device() is undefined for device: ",e.type)}},t.get_vector_param=function(e,t,r){switch(t){case 10:return M(e,r);case 20:return I(e,r);case 21:return b(e,"left",r);case 22:return b(e,"right",r);case 30:return y(e,"left",r);case 31:return y(e,"right",r);case Me:case Ie:return r[0]=e.mouse_location[0],r[1]=e.mouse_location[1],r}},t.get_value_param=E,t.set_config=function(e,t,r){switch(e.type){case pe:if(E(e,ke)&Oe)break;switch(t){case 24:e.distortion_coefs[0]=r[0],e.distortion_coefs[1]=r[1];break;case Ne:e.inter_lens_dist=r,f(e);break;case 25:e.base_line_dist=r,f(e);break;case 26:e.screen_to_lens_dist=r,f(e);break;case 27:e.width_dist=r,f(e);break;case 28:e.height_dist=r,f(e);break;case 29:e.bevel_size=r,f(e)}break;case ge:case ye:case Ee:case we:e.gamepad_mapping[t]=r}},t.get_gamepad_btn_value=function(e,t){var r=t-300;return r<e.gamepad_btns.length&&e.gamepad_btns[X(e,r)-300]},t.get_gamepad_axis_value=function(e,t){var r=t-300;return t-326<e.gamepad_axes.length?e.gamepad_axes[X(e,r)-326]:0},t.get_gamepad_position=function(e,t){return t.set(e.position),t},t.get_gamepad_orientation=function(e,t){return t.set(e.orientation),t},t.update=function(e){for(var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],r=0;r<Ze.length;r++){var a=Ze[r];switch(a.type){case ge:T(a),A(t[0],a);break;case ye:T(a),A(t[1],a);break;case Ee:T(a),A(t[2],a);break;case we:T(a),A(t[3],a);break;case pe:w(a)}}},t.attach_param_cb=function(e,t,r){switch(t){case Ge:e.orientation_quat_cb_list.push(r),t=ze;break;case je:e.orientation_angles_cb_list.push(r),t=ze;break;case Se:e.mouse_down_which_cb_list.push(r);break;case Me:case Ie:e.mouse_location_cb_list.push(r);break;case Le:e.mouse_up_which_cb_list.push(r);break;case Ce:e.mouse_wheel_cb_list.push(r);break;case De:e.keyboard_down_cb_list.push(r);break;case 91:e.keyboard_down_mod_cb_list.push(r),t=De;break;case Pe:e.keyboard_up_cb_list.push(r);break;case Ue:e.touch_start_cb_list.push(r);break;case Fe:e.touch_move_cb_list.push(r);break;case Be:e.touch_end_cb_list.push(r)}-1==e.registered_event_listeners.indexOf(t)&&(e.registered_event_listeners.push(t),e.registered&&N(e,t))},t.detach_param_cb=function(e,t,r){R(e,t,r,!1)},t.gyro_angles_to_quat=S,t.cleanup=function(){for(var e=0;e<Ze.length;e++)for(var t=Ze[e],r=0;r<t.registered_event_listeners.length;r++)R(t,t.registered_event_listeners[r],null,!0);Ze.length=0},t.get_pressed_gmpd_btn=function(e){for(var t=n(V(e)),r=0;r<t.gamepad_btns.length;r++)if(t.gamepad_btns[r])return r+300;return-1},t.get_moved_gmpd_axis=function(e){for(var t=n(V(e)),r=0;r<t.gamepad_axes.length;r++)if(t.gamepad_prev_axes[r]-t.gamepad_axes[r])return r+326;return-1},t.get_first_gmpd_id=function(){for(var e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],t=0;t<e.length;t++)if(e[t])return t;return 0},t.get_webvr_display=function(){var e=n(pe);return e&&e.webvr_display},t.activate_pointerlock=function(e){e.element.addEventListener("mousedown",function(t){e.value||K(e)},!1)},t.add_click_listener=function(e,t){ie.is_mobile_device?e.addEventListener("touchend",t):e.addEventListener("mouseup",t)},t.remove_click_listener=function(e,t){ie.is_mobile_device?e.removeEventListener("touchend",t):e.removeEventListener("mouseup",t)},t.check_fullscreen=Z}),L=o("__prerender",function(e,t){function r(e){e.sort(a)}function a(e,t){return e.z_index-t.z_index}function n(e,t){if(e.world_bounds){var r=e.world_bounds.bs;return b.squaredDistance(r.center,t)+r.radius*r.radius}return 1/0}function _(e,t){var r=e.obj_render;if(r.is_visible=!1,r.hide)return!1;var a=t.camera;if(t.type==f.SHADOW_CAST)n=a.lod_eye;else var n=m.get_trans(a.world_tsr,E);var _=e.batch;return!!u.update_lod_visibility(_,r,n)&&(r.is_visible=!0,t.type==f.DEBUG_VIEW?t.debug_view_mode==i.DV_BOUNDINGS?_.debug_sphere:!_.debug_sphere:!(t.type==f.OUTLINE_MASK&&0==r.outline_intensity||!_.do_not_cull&&e.world_bounds&&g&&s(a.frustum_planes,e.world_bounds.bs,e.world_bounds.be,_.use_be)))}function s(e,t,r,a){var n=t.center;if(p.sphere_is_out_of_frustum(n,e,t.radius))return!0;if(!a)return!1;var _=r.axis_x,s=r.axis_y,o=r.axis_z;return n=r.center,p.ellipsoid_is_out_of_frustum(n,e,_,s,o)}function o(e){var t=e.particles_data;if(t&&t.need_buffers_update){var r=e.bufs_data;c.make_dynamic(r);var a=r.pointers,n=a.a_position.offset;c.vbo_source_data_set_attr(r.vbo_source_data,"a_position",t.positions_cache,n);var _=a.a_tbn.offset;c.vbo_source_data_set_attr(r.vbo_source_data,"a_tbn",t.tbn_cache,_),c.update_gl_buffers(r)}}var i=ae(e),c=w(e),u=$(e),d=te(e),f=A(e),m=v(e),p=h(e),b=l(e),g=!0,y=[f.MAIN_OPAQUE,f.MAIN_BLEND,f.MAIN_PLANE_REFLECT,f.MAIN_CUBE_REFLECT,f.MAIN_PLANE_REFLECT_BLEND,f.MAIN_CUBE_REFLECT_BLEND,f.MAIN_GLOW,f.MAIN_XRAY,f.SHADOW_CAST,f.SHADOW_RECEIVE,f.OUTLINE_MASK,f.DEBUG_VIEW,f.COLOR_PICKING,f.COLOR_PICKING_XRAY],E=new Float32Array(3);t.prerender_subs=function(e){if(y.indexOf(e.type)>-1){for(var t=!1,a=e.type==f.MAIN_CUBE_REFLECT||e.type==f.MAIN_CUBE_REFLECT_BLEND,s=e.draw_data,i=0;i<s.length;i++){for(var l=s[i],c=l.bundles,u=!1,p=0;p<c.length;p++){var h=(w=c[p]).batch;if(a)for(var v=0;v<6;v++)e.camera.frustum_planes=e.cube_cam_frustums[v],w.do_render_cube[v]=_(w,e),w.do_render_cube[v]&&(t=!0,u=!0,o(h));else w.do_render=_(w,e),w.do_render&&(t=!0,u=!0,o(h));if(e.need_perm_uniforms_update&&(h.shader.need_uniforms_update=!0),w.do_render){var b=e.camera,g=n(w,m.get_trans(b.world_tsr,E));w.z_index=g}else w.z_index=1/0}r(c),c.length>0&&(s.z_index=c[0]),l.do_render=u}switch(e.need_perm_uniforms_update=!1,e.type){case f.DEBUG_VIEW:break;default:e.type==f.MAIN_OPAQUE||e.type==f.SHADOW_RECEIVE||e.type==f.MAIN_GLOW||e.type==f.MAIN_PLANE_REFLECT||e.type==f.MAIN_CUBE_REFLECT||t?e.do_render=!0:(e.do_render&&d.clear(e),e.do_render=!1)}}else if(e.need_perm_uniforms_update){for(var s=e.draw_data,i=0;i<s.length;i++)for(var c=s[i].bundles,p=0;p<c.length;p++){var w=c[p];(h=w.batch).shader.need_uniforms_update=!0}e.need_perm_uniforms_update=!1}e.need_draw_data_sort&&f.sort_draw_data(e)}}),C=o("__primitives",function(e,t){function r(e,t,r,a){for(var n=[],_=[],s=[],c=e*t,u=2*r/(e-1),d=2*a/(t-1),f=0;f<e;f++)for(var m=f*u-r,p=0;p<t;p++){var h=p*d-a;if(_.push(m,h,0),s.push(f/(e-1),p/(t-1)),f&&p){var v=f*t+p,b=v-1,g=(f-1)*t+p,y=g-1;n.push(v,b,g),n.push(b,y,g)}}var E=l.create_empty_va_frame();E.a_position=new Float32Array(_),E.a_tbn=i.create(c);var w=o.init_submesh("GRID_PLANE");return w.va_frames[0]=E,w.va_common.a_texcoord=new Float32Array(s),w.indices=new Uint32Array(n),w.base_length=_.length/3,w}function a(e){var t=e.length;t%4&&l.panic("Wrong array");for(var r=[],a=[],n=0;n<t;n+=4){var s=e[n],c=e[n+1],u=e[n+2],d=e[n+3];_(s,a),_(c,a),_(u,a),_(d,a),r.push(n,n+1,n+2),r.push(n,n+2,n+3)}var f=l.create_empty_va_frame();f.a_position=new Float32Array(a),f.a_tbn=i.create(t/4);var m=o.init_submesh("FROM_QUADS");return m.va_frames[0]=f,m.indices=new Uint32Array(r),m.base_length=a.length/3,m}function n(e,t){var r=3*t;return[e[r],e[r+1],e[r+2]]}function _(e,t){t.push(e[0],e[1],e[2])}var s=g(e),o=w(e),i=p(e),l=h(e),c=s.defaults;t.generate_line=function(){var e=o.init_submesh("LINE"),t=l.create_empty_va_frame();return t.a_position=new Float32Array(3),t.a_direction=new Float32Array(3),e.va_frames[0]=t,e.indices=new Uint32Array(1),e.base_length=1,e},t.generate_plane=function(e,t){var a=r(2,2,e,t);return a.name="PLANE",a},t.generate_grid=r,t.generate_cascaded_grid=function(e,t,r){function a(e,t){return e%2==1&&(0==t||t==d-1)||t%2==1&&(0==e||e==u-1)}for(var n=r/Math.pow(2,e-1),_=n,s=n,u=t+1,d=t+1,f=[],m=[],p=0,h=0,v=0,b=-1,g=[],y=0;y<e;y++){for(var E=2*_/(u-1),w=2*s/(d-1),A=[],T=[],x=0;x<u;x++){for(var O=x*E-_,R=[],k=0;k<d;k++){var N=k*w-s;if(O>-h&&O<h&&N>-v&&N<v)R.push(-1);else{for(var M=null,I=0;I<g.length;I+=3)if(O==g[I]&&N==g[I+1]){M=g[I+2];break}if(F=null!==M?M:b+1,a(x,k))R.push(-2);else{if(null==M){if(0==k||k==d-1||0==x||x==u-1)S=y==e-1?E:2*E,A.push(O,N,F);else var S=E;m.push(O,N,S),p++,b++}R.push(F)}if(x&&k)if(1==x){if(a(x-1,k))if(k>1){var L=F-1,C=(P=T[x-1][k+1])-1;f.push(C,L,F),f.push(P,C,F)}else C=(P=T[x-1][k+1])-1,f.push(P,C,F);else if(!a(x,k)){var L=F-1,P=T[x-1][k];f.push(P,L,F)}}else if(x==u-1){if(!a(x,k))if(k==d-1){var L=F-1,P=T[x-1][k-1],C=T[x-2][k];f.push(P,L,F),f.push(C,P,F)}else{var L=F-1,C=(P=T[x-1][k])-1,D=P+1;f.push(C,L,F),f.push(P,C,F),f.push(D,P,F),2==k&&(D=T[x-2][k-2],f.push(C,D,L))}}else if(1==k)if(a(x,k-1)){var L=T[x-1][k],P=T[x-1][k-1];f.push(L,P,F)}else{var L=R[k-1],P=T[x-1][k],C=T[x-2][k-1];f.push(P,L,F),f.push(P,C,L)}else if(k==d-1){if(!a(x,k)){var L=R[k-1],P=T[x-1][k-1],C=T[x-2][k];f.push(P,L,F),f.push(C,P,F)}}else if(-1!=T[x-1][k]&&-1!=T[x-1][k-1]&&-1!=R[k-1]){var L=R[k-1],P=T[x-1][k],C=T[x-1][k-1];f.push(P,L,F),f.push(P,C,L),k==d-2&&a(x,k+1)&&(D=T[x-1][k+1],f.push(D,P,F))}else if(k==d-2&&a(x,k+1)){var P=T[x-1][k],D=T[x-1][k+1];f.push(D,P,F)}}}T.push(R)}g=A,h=_,v=s,_*=2,s*=2}if(h<2e4){var U=-2*h/(u-1);m.push(-2e4,-2e4,U),m.push(-2e4,2e4,U),m.push(-h,-v,U),m.push(-h,v,U),m.push(2e4,-2e4,U),m.push(2e4,2e4,U),m.push(h,-v,U),m.push(h,v,U);var F=b+1;f.push(F+1,F+2,F+3,F+1,F+0,F+2,F+2,F+4,F+6,F+2,F+0,F+4,F+1,F+7,F+5,F+1,F+3,F+7,F+7,F+4,F+5,F+6,F+4,F+7),p+=8}var B=l.create_empty_va_frame();B.a_position=new Float32Array(m),B.a_tbn=i.create(p),i.multiply_quat(B.a_tbn,[.707,0,0,.707],B.a_tbn);var G=o.init_submesh("MULTIGRID_PLANE");return G.va_frames[0]=B,G.indices=new Uint32Array(f),G.base_length=m.length/3,c.water_wireframe_debug&&(o.submesh_drop_indices(G,1,!0),B.a_polyindex=o.extract_polyindices(G)),G},t.generate_from_triangles=function(e){var t=e.length;t%3&&l.panic("Wrong array");for(var r=[],a=[],n=0;n<t;n+=3){var s=e[n],i=e[n+1],c=e[n+2];_(s,a),_(i,a),_(c,a),r.push(n,n+1,n+2)}var u=l.create_empty_va_frame();u.a_position=new Float32Array(a);var d=o.init_submesh("FROM_TRIANGLES");return d.va_frames[0]=u,d.indices=new Uint32Array(r),d.base_length=a.length/3,d},t.generate_from_quads=a,t.generate_frustum=function(e){e=l.vectorize(e,[]);var t=[];t.push(e[0],e[1],e[2],e[3]),t.push(e[0],e[3],e[5],e[4]),t.push(e[3],e[2],e[6],e[5]),t.push(e[1],e[7],e[6],e[2]),t.push(e[0],e[4],e[7],e[1]),t.push(e[4],e[5],e[6],e[7]);var r=a(t);return r.name="FRUSTUM",r},t.generate_fullscreen_tri=function(){var e=o.init_submesh("FULLSCREEN_TRI"),t=l.create_empty_va_frame();return t.a_position=new Float32Array([0,0,1,0,0,1]),e.va_frames[0]=t,e.indices=new Uint32Array([0,1,2]),e.base_length=3,e},t.generate_fullscreen_quad=function(){var e=o.init_submesh("FULLSCREEN_QUAD"),t=l.create_empty_va_frame();return t.a_position=new Float32Array([-1,1,1,1,-1,-1,1,-1]),e.va_frames[0]=t,e.indices=new Uint32Array([0,2,1,1,2,3]),e.base_length=4,e},t.generate_billboard=function(){var e=o.init_submesh("BILLBOARD"),t=l.create_empty_va_frame();return t.a_bb_vertex=o.gen_bb_vertices(1),e.va_frames[0]=t,e.indices=new Uint32Array([0,2,1,0,3,2]),e.base_length=4,e},t.generate_uv_sphere=function(e,t,r,a,s,l){var c,u,d=o.init_submesh("UV_SPHERE"),f=[],m=[],p=[];for(u=0;u<=t;u++)for(c=0;c<=e;c++){var h=c/e,v=u/t,b=-r*Math.cos(2*h*Math.PI)*Math.sin(v*Math.PI),g=r*Math.cos(v*Math.PI),y=r*Math.sin(2*h*Math.PI)*Math.sin(v*Math.PI);s&&(b=Math.abs(b)<1e-5?0:b,g=Math.abs(g)<1e-5?0:g,y=Math.abs(y)<1e-5?0:y),m.push(b+a[0],g+a[1],y+a[2])}var E=0;for(u=0;u<t;u++)for(c=0;c<e;c++){var w=n(m,(e+1)*u+c+1),A=n(m,(e+1)*u+c),T=n(m,(e+1)*(u+1)+c),x=n(m,(e+1)*(u+1)+c+1);Math.abs(w[1])==r+a[1]?(_(w,f),_(T,f),_(x,f),l?p.push(E,E+1,E+1,E+2,E+2,E):p.push(E,E+1,E+2),E+=3):Math.abs(T[1])==r+a[1]?(_(w,f),_(A,f),_(T,f),l?p.push(E,E+1,E+1,E+2,E+2,E):p.push(E,E+1,E+2),E+=3):(_(w,f),_(A,f),_(T,f),_(x,f),l?(p.push(E,E+1),p.push(E+1,E+2),p.push(E+2,E+3),p.push(E+3,E)):(p.push(E,E+1,E+2),p.push(E,E+2,E+3)),E+=4)}var O={};if(O.a_position=f,l)O.a_tbn=i.create();else{var R=o.calc_shared_indices(p,m,f),k=o.calc_normals(p,f,R);O.a_tbn=i.from_norm_tan(k)}return d.va_frames[0]=O,d.indices=p,d.base_length=f.length/3,d},t.generate_index=function(e){var t=o.init_submesh("INDEX"),r=l.create_empty_va_frame();r.a_index=new Float32Array(3*e);for(var a=new Uint16Array(3*e),n=0;n<3*e;n++)r.a_index[n]=n,a[n]=n;return t.va_frames[0]=r,t.indices=a,t.base_length=3*e,t}}),P=o("pako_inflate",function(e,t){var r;!function(e){("undefined"!=typeof window?window:"undefined"!=typeof self?self:this).pako=e()}(function(){return function e(t,a,n){function _(o,i){if(!a[o]){if(!t[o]){var l="function"==typeof r&&r;if(!i&&l)return l(o,!0);if(s)return s(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=a[o]={exports:{}};t[o][0].call(u.exports,function(e){var r=t[o][1][e];return _(r||e)},u,u.exports,e,t,a,n)}return a[o].exports}for(var s="function"==typeof r&&r,o=0;o<n.length;o++)_(n[o]);return _}({1:[function(e,t,r){var a="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;r.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var a in r)r.hasOwnProperty(a)&&(e[a]=r[a])}}return e},r.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var n={arraySet:function(e,t,r,a,n){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+a),n);else for(var _=0;_<a;_++)e[n+_]=t[r+_]},flattenChunks:function(e){var t,r,a,n,_,s;for(a=0,t=0,r=e.length;t<r;t++)a+=e[t].length;for(s=new Uint8Array(a),n=0,t=0,r=e.length;t<r;t++)_=e[t],s.set(_,n),n+=_.length;return s}},_={arraySet:function(e,t,r,a,n){for(var _=0;_<a;_++)e[n+_]=t[r+_]},flattenChunks:function(e){return[].concat.apply([],e)}};r.setTyped=function(e){e?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,n)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,_))},r.setTyped(a)},{}],2:[function(e,t,r){function a(e,t){if(t<65537&&(e.subarray&&s||!e.subarray&&_))return String.fromCharCode.apply(null,n.shrinkBuf(e,t));for(var r="",a=0;a<t;a++)r+=String.fromCharCode(e[a]);return r}var n=e("./common"),_=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch(e){_=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){s=!1}for(var o=new n.Buf8(256),i=0;i<256;i++)o[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1;o[254]=o[254]=1,r.string2buf=function(e){var t,r,a,_,s,o=e.length,i=0;for(_=0;_<o;_++)55296==(64512&(r=e.charCodeAt(_)))&&_+1<o&&56320==(64512&(a=e.charCodeAt(_+1)))&&(r=65536+(r-55296<<10)+(a-56320),_++),i+=r<128?1:r<2048?2:r<65536?3:4;for(t=new n.Buf8(i),s=0,_=0;s<i;_++)55296==(64512&(r=e.charCodeAt(_)))&&_+1<o&&56320==(64512&(a=e.charCodeAt(_+1)))&&(r=65536+(r-55296<<10)+(a-56320),_++),r<128?t[s++]=r:r<2048?(t[s++]=192|r>>>6,t[s++]=128|63&r):r<65536?(t[s++]=224|r>>>12,t[s++]=128|r>>>6&63,t[s++]=128|63&r):(t[s++]=240|r>>>18,t[s++]=128|r>>>12&63,t[s++]=128|r>>>6&63,t[s++]=128|63&r);return t},r.buf2binstring=function(e){return a(e,e.length)},r.binstring2buf=function(e){for(var t=new n.Buf8(e.length),r=0,a=t.length;r<a;r++)t[r]=e.charCodeAt(r);return t},r.buf2string=function(e,t){var r,n,_,s,i=t||e.length,l=new Array(2*i);for(n=0,r=0;r<i;)if((_=e[r++])<128)l[n++]=_;else if((s=o[_])>4)l[n++]=65533,r+=s-1;else{for(_&=2===s?31:3===s?15:7;s>1&&r<i;)_=_<<6|63&e[r++],s--;s>1?l[n++]=65533:_<65536?l[n++]=_:(_-=65536,l[n++]=55296|_>>10&1023,l[n++]=56320|1023&_)}return a(l,n)},r.utf8border=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;r>=0&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+o[e[r]]>t?r:t}},{"./common":1}],3:[function(e,t,r){t.exports=function(e,t,r,a){for(var n=65535&e|0,_=e>>>16&65535|0,s=0;0!==r;){r-=s=r>2e3?2e3:r;do{_=_+(n=n+t[a++]|0)|0}while(--s);n%=65521,_%=65521}return n|_<<16|0}},{}],4:[function(e,t,r){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],5:[function(e,t,r){var a=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var a=0;a<8;a++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function(e,t,r,n){var _=a,s=n+r;e^=-1;for(var o=n;o<s;o++)e=e>>>8^_[255&(e^t[o])];return-1^e}},{}],6:[function(e,t,r){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],7:[function(e,t,r){t.exports=function(e,t){var r,a,n,_,s,o,i,l,c,u,d,f,m,p,h,v,b,g,y,E,w,A,T,x,O;r=e.state,a=e.next_in,x=e.input,n=a+(e.avail_in-5),_=e.next_out,O=e.output,s=_-(t-e.avail_out),o=_+(e.avail_out-257),i=r.dmax,l=r.wsize,c=r.whave,u=r.wnext,d=r.window,f=r.hold,m=r.bits,p=r.lencode,h=r.distcode,v=(1<<r.lenbits)-1,b=(1<<r.distbits)-1;e:do{m<15&&(f+=x[a++]<<m,m+=8,f+=x[a++]<<m,m+=8),g=p[f&v];t:for(;;){if(y=g>>>24,f>>>=y,m-=y,0==(y=g>>>16&255))O[_++]=65535&g;else{if(!(16&y)){if(0==(64&y)){g=p[(65535&g)+(f&(1<<y)-1)];continue t}if(32&y){r.mode=12;break e}e.msg="invalid literal/length code",r.mode=30;break e}E=65535&g,(y&=15)&&(m<y&&(f+=x[a++]<<m,m+=8),E+=f&(1<<y)-1,f>>>=y,m-=y),m<15&&(f+=x[a++]<<m,m+=8,f+=x[a++]<<m,m+=8),g=h[f&b];r:for(;;){if(y=g>>>24,f>>>=y,m-=y,!(16&(y=g>>>16&255))){if(0==(64&y)){g=h[(65535&g)+(f&(1<<y)-1)];continue r}e.msg="invalid distance code",r.mode=30;break e}if(w=65535&g,y&=15,m<y&&(f+=x[a++]<<m,(m+=8)<y&&(f+=x[a++]<<m,m+=8)),(w+=f&(1<<y)-1)>i){e.msg="invalid distance too far back",r.mode=30;break e}if(f>>>=y,m-=y,y=_-s,w>y){if((y=w-y)>c&&r.sane){e.msg="invalid distance too far back",r.mode=30;break e}if(A=0,T=d,0===u){if(A+=l-y,y<E){E-=y;do{O[_++]=d[A++]}while(--y);A=_-w,T=O}}else if(u<y){if(A+=l+u-y,(y-=u)<E){E-=y;do{O[_++]=d[A++]}while(--y);if(A=0,u<E){E-=y=u;do{O[_++]=d[A++]}while(--y);A=_-w,T=O}}}else if(A+=u-y,y<E){E-=y;do{O[_++]=d[A++]}while(--y);A=_-w,T=O}for(;E>2;)O[_++]=T[A++],O[_++]=T[A++],O[_++]=T[A++],E-=3;E&&(O[_++]=T[A++],E>1&&(O[_++]=T[A++]))}else{A=_-w;do{O[_++]=O[A++],O[_++]=O[A++],O[_++]=O[A++],E-=3}while(E>2);E&&(O[_++]=O[A++],E>1&&(O[_++]=O[A++]))}break}}break}}while(a<n&&_<o);a-=E=m>>3,f&=(1<<(m-=E<<3))-1,e.next_in=a,e.next_out=_,e.avail_in=a<n?n-a+5:5-(a-n),e.avail_out=_<o?o-_+257:257-(_-o),r.hold=f,r.bits=m}},{}],8:[function(e,t,r){function a(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function n(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new f.Buf16(320),this.work=new f.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=S,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new f.Buf32(ce),t.distcode=t.distdyn=new f.Buf32(ue),t.sane=1,t.back=-1,T):R}function s(e){var t;return e&&e.state?(t=e.state,t.wsize=0,t.whave=0,t.wnext=0,_(e)):R}function o(e,t){var r,a;return e&&e.state?(a=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?R:(null!==a.window&&a.wbits!==t&&(a.window=null),a.wrap=r,a.wbits=t,s(e))):R}function i(e,t){var r,a;return e?(a=new n,e.state=a,a.window=null,(r=o(e,t))!==T&&(e.state=null),r):R}function l(e){if(fe){var t;for(u=new f.Buf32(512),d=new f.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(v(g,e.lens,0,288,u,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;v(y,e.lens,0,32,d,0,e.work,{bits:5}),fe=!1}e.lencode=u,e.lenbits=9,e.distcode=d,e.distbits=5}function c(e,t,r,a){var n,_=e.state;return null===_.window&&(_.wsize=1<<_.wbits,_.wnext=0,_.whave=0,_.window=new f.Buf8(_.wsize)),a>=_.wsize?(f.arraySet(_.window,t,r-_.wsize,_.wsize,0),_.wnext=0,_.whave=_.wsize):((n=_.wsize-_.wnext)>a&&(n=a),f.arraySet(_.window,t,r-a,n,_.wnext),(a-=n)?(f.arraySet(_.window,t,r-a,a,0),_.wnext=a,_.whave=_.wsize):(_.wnext+=n,_.wnext===_.wsize&&(_.wnext=0),_.whave<_.wsize&&(_.whave+=n))),0}var u,d,f=e("../utils/common"),m=e("./adler32"),p=e("./crc32"),h=e("./inffast"),v=e("./inftrees"),b=0,g=1,y=2,E=4,w=5,A=6,T=0,x=1,O=2,R=-2,k=-3,N=-4,M=-5,I=8,S=1,L=2,C=3,P=4,D=5,U=6,F=7,B=8,G=9,j=10,z=11,Y=12,H=13,W=14,q=15,V=16,X=17,K=18,Z=19,Q=20,J=21,$=22,ee=23,te=24,re=25,ae=26,ne=27,_e=28,se=29,oe=30,ie=31,le=32,ce=852,ue=592,de=15,fe=!0;r.inflateReset=s,r.inflateReset2=o,r.inflateResetKeep=_,r.inflateInit=function(e){return i(e,de)},r.inflateInit2=i,r.inflate=function(e,t){var r,n,_,s,o,i,u,d,ce,ue,de,fe,me,pe,he,ve,be,ge,ye,Ee,we,Ae,Te,xe,Oe=0,Re=new f.Buf8(4),ke=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return R;(r=e.state).mode===Y&&(r.mode=H),o=e.next_out,_=e.output,u=e.avail_out,s=e.next_in,n=e.input,i=e.avail_in,d=r.hold,ce=r.bits,ue=i,de=u,Ae=T;e:for(;;)switch(r.mode){case S:if(0===r.wrap){r.mode=H;break}for(;ce<16;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(2&r.wrap&&35615===d){r.check=0,Re[0]=255&d,Re[1]=d>>>8&255,r.check=p(r.check,Re,2,0),d=0,ce=0,r.mode=L;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check",r.mode=oe;break}if((15&d)!==I){e.msg="unknown compression method",r.mode=oe;break}if(d>>>=4,ce-=4,we=8+(15&d),0===r.wbits)r.wbits=we;else if(we>r.wbits){e.msg="invalid window size",r.mode=oe;break}r.dmax=1<<we,e.adler=r.check=1,r.mode=512&d?j:Y,d=0,ce=0;break;case L:for(;ce<16;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(r.flags=d,(255&r.flags)!==I){e.msg="unknown compression method",r.mode=oe;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=oe;break}r.head&&(r.head.text=d>>8&1),512&r.flags&&(Re[0]=255&d,Re[1]=d>>>8&255,r.check=p(r.check,Re,2,0)),d=0,ce=0,r.mode=C;case C:for(;ce<32;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}r.head&&(r.head.time=d),512&r.flags&&(Re[0]=255&d,Re[1]=d>>>8&255,Re[2]=d>>>16&255,Re[3]=d>>>24&255,r.check=p(r.check,Re,4,0)),d=0,ce=0,r.mode=P;case P:for(;ce<16;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}r.head&&(r.head.xflags=255&d,r.head.os=d>>8),512&r.flags&&(Re[0]=255&d,Re[1]=d>>>8&255,r.check=p(r.check,Re,2,0)),d=0,ce=0,r.mode=D;case D:if(1024&r.flags){for(;ce<16;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}r.length=d,r.head&&(r.head.extra_len=d),512&r.flags&&(Re[0]=255&d,Re[1]=d>>>8&255,r.check=p(r.check,Re,2,0)),d=0,ce=0}else r.head&&(r.head.extra=null);r.mode=U;case U:if(1024&r.flags&&((fe=r.length)>i&&(fe=i),fe&&(r.head&&(we=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),f.arraySet(r.head.extra,n,s,fe,we)),512&r.flags&&(r.check=p(r.check,n,fe,s)),i-=fe,s+=fe,r.length-=fe),r.length))break e;r.length=0,r.mode=F;case F:if(2048&r.flags){if(0===i)break e;fe=0;do{we=n[s+fe++],r.head&&we&&r.length<65536&&(r.head.name+=String.fromCharCode(we))}while(we&&fe<i);if(512&r.flags&&(r.check=p(r.check,n,fe,s)),i-=fe,s+=fe,we)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=B;case B:if(4096&r.flags){if(0===i)break e;fe=0;do{we=n[s+fe++],r.head&&we&&r.length<65536&&(r.head.comment+=String.fromCharCode(we))}while(we&&fe<i);if(512&r.flags&&(r.check=p(r.check,n,fe,s)),i-=fe,s+=fe,we)break e}else r.head&&(r.head.comment=null);r.mode=G;case G:if(512&r.flags){for(;ce<16;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(d!==(65535&r.check)){e.msg="header crc mismatch",r.mode=oe;break}d=0,ce=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=Y;break;case j:for(;ce<32;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}e.adler=r.check=a(d),d=0,ce=0,r.mode=z;case z:if(0===r.havedict)return e.next_out=o,e.avail_out=u,e.next_in=s,e.avail_in=i,r.hold=d,r.bits=ce,O;e.adler=r.check=1,r.mode=Y;case Y:if(t===w||t===A)break e;case H:if(r.last){d>>>=7&ce,ce-=7&ce,r.mode=ne;break}for(;ce<3;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}switch(r.last=1&d,d>>>=1,ce-=1,3&d){case 0:r.mode=W;break;case 1:if(l(r),r.mode=Q,t===A){d>>>=2,ce-=2;break e}break;case 2:r.mode=X;break;case 3:e.msg="invalid block type",r.mode=oe}d>>>=2,ce-=2;break;case W:for(d>>>=7&ce,ce-=7&ce;ce<32;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if((65535&d)!=(d>>>16^65535)){e.msg="invalid stored block lengths",r.mode=oe;break}if(r.length=65535&d,d=0,ce=0,r.mode=q,t===A)break e;case q:r.mode=V;case V:if(fe=r.length){if(fe>i&&(fe=i),fe>u&&(fe=u),0===fe)break e;f.arraySet(_,n,s,fe,o),i-=fe,s+=fe,u-=fe,o+=fe,r.length-=fe;break}r.mode=Y;break;case X:for(;ce<14;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(r.nlen=257+(31&d),d>>>=5,ce-=5,r.ndist=1+(31&d),d>>>=5,ce-=5,r.ncode=4+(15&d),d>>>=4,ce-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=oe;break}r.have=0,r.mode=K;case K:for(;r.have<r.ncode;){for(;ce<3;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}r.lens[ke[r.have++]]=7&d,d>>>=3,ce-=3}for(;r.have<19;)r.lens[ke[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,Te={bits:r.lenbits},Ae=v(b,r.lens,0,19,r.lencode,0,r.work,Te),r.lenbits=Te.bits,Ae){e.msg="invalid code lengths set",r.mode=oe;break}r.have=0,r.mode=Z;case Z:for(;r.have<r.nlen+r.ndist;){for(;Oe=r.lencode[d&(1<<r.lenbits)-1],he=Oe>>>24,ve=Oe>>>16&255,be=65535&Oe,!(he<=ce);){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(be<16)d>>>=he,ce-=he,r.lens[r.have++]=be;else{if(16===be){for(xe=he+2;ce<xe;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(d>>>=he,ce-=he,0===r.have){e.msg="invalid bit length repeat",r.mode=oe;break}we=r.lens[r.have-1],fe=3+(3&d),d>>>=2,ce-=2}else if(17===be){for(xe=he+3;ce<xe;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}ce-=he,we=0,fe=3+(7&(d>>>=he)),d>>>=3,ce-=3}else{for(xe=he+7;ce<xe;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}ce-=he,we=0,fe=11+(127&(d>>>=he)),d>>>=7,ce-=7}if(r.have+fe>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=oe;break}for(;fe--;)r.lens[r.have++]=we}}if(r.mode===oe)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=oe;break}if(r.lenbits=9,Te={bits:r.lenbits},Ae=v(g,r.lens,0,r.nlen,r.lencode,0,r.work,Te),r.lenbits=Te.bits,Ae){e.msg="invalid literal/lengths set",r.mode=oe;break}if(r.distbits=6,r.distcode=r.distdyn,Te={bits:r.distbits},Ae=v(y,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,Te),r.distbits=Te.bits,Ae){e.msg="invalid distances set",r.mode=oe;break}if(r.mode=Q,t===A)break e;case Q:r.mode=J;case J:if(i>=6&&u>=258){e.next_out=o,e.avail_out=u,e.next_in=s,e.avail_in=i,r.hold=d,r.bits=ce,h(e,de),o=e.next_out,_=e.output,u=e.avail_out,s=e.next_in,n=e.input,i=e.avail_in,d=r.hold,ce=r.bits,r.mode===Y&&(r.back=-1);break}for(r.back=0;Oe=r.lencode[d&(1<<r.lenbits)-1],he=Oe>>>24,ve=Oe>>>16&255,be=65535&Oe,!(he<=ce);){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(ve&&0==(240&ve)){for(ge=he,ye=ve,Ee=be;Oe=r.lencode[Ee+((d&(1<<ge+ye)-1)>>ge)],he=Oe>>>24,ve=Oe>>>16&255,be=65535&Oe,!(ge+he<=ce);){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}d>>>=ge,ce-=ge,r.back+=ge}if(d>>>=he,ce-=he,r.back+=he,r.length=be,0===ve){r.mode=ae;break}if(32&ve){r.back=-1,r.mode=Y;break}if(64&ve){e.msg="invalid literal/length code",r.mode=oe;break}r.extra=15&ve,r.mode=$;case $:if(r.extra){for(xe=r.extra;ce<xe;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}r.length+=d&(1<<r.extra)-1,d>>>=r.extra,ce-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=ee;case ee:for(;Oe=r.distcode[d&(1<<r.distbits)-1],he=Oe>>>24,ve=Oe>>>16&255,be=65535&Oe,!(he<=ce);){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(0==(240&ve)){for(ge=he,ye=ve,Ee=be;Oe=r.distcode[Ee+((d&(1<<ge+ye)-1)>>ge)],he=Oe>>>24,ve=Oe>>>16&255,be=65535&Oe,!(ge+he<=ce);){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}d>>>=ge,ce-=ge,r.back+=ge}if(d>>>=he,ce-=he,r.back+=he,64&ve){e.msg="invalid distance code",r.mode=oe;break}r.offset=be,r.extra=15&ve,r.mode=te;case te:if(r.extra){for(xe=r.extra;ce<xe;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}r.offset+=d&(1<<r.extra)-1,d>>>=r.extra,ce-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=oe;break}r.mode=re;case re:if(0===u)break e;if(fe=de-u,r.offset>fe){if((fe=r.offset-fe)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=oe;break}fe>r.wnext?(fe-=r.wnext,me=r.wsize-fe):me=r.wnext-fe,fe>r.length&&(fe=r.length),pe=r.window}else pe=_,me=o-r.offset,fe=r.length;fe>u&&(fe=u),u-=fe,r.length-=fe;do{_[o++]=pe[me++]}while(--fe);0===r.length&&(r.mode=J);break;case ae:if(0===u)break e;_[o++]=r.length,u--,r.mode=J;break;case ne:if(r.wrap){for(;ce<32;){if(0===i)break e;i--,d|=n[s++]<<ce,ce+=8}if(de-=u,e.total_out+=de,r.total+=de,de&&(e.adler=r.check=r.flags?p(r.check,_,de,o-de):m(r.check,_,de,o-de)),de=u,(r.flags?d:a(d))!==r.check){e.msg="incorrect data check",r.mode=oe;break}d=0,ce=0}r.mode=_e;case _e:if(r.wrap&&r.flags){for(;ce<32;){if(0===i)break e;i--,d+=n[s++]<<ce,ce+=8}if(d!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=oe;break}d=0,ce=0}r.mode=se;case se:Ae=x;break e;case oe:Ae=k;break e;case ie:return N;case le:default:return R}return e.next_out=o,e.avail_out=u,e.next_in=s,e.avail_in=i,r.hold=d,r.bits=ce,(r.wsize||de!==e.avail_out&&r.mode<oe&&(r.mode<ne||t!==E))&&c(e,e.output,e.next_out,de-e.avail_out)?(r.mode=ie,N):(ue-=e.avail_in,de-=e.avail_out,e.total_in+=ue,e.total_out+=de,r.total+=de,r.wrap&&de&&(e.adler=r.check=r.flags?p(r.check,_,de,e.next_out-de):m(r.check,_,de,e.next_out-de)),e.data_type=r.bits+(r.last?64:0)+(r.mode===Y?128:0)+(r.mode===Q||r.mode===q?256:0),(0===ue&&0===de||t===E)&&Ae===T&&(Ae=M),Ae)},r.inflateEnd=function(e){if(!e||!e.state)return R;var t=e.state;return t.window&&(t.window=null),e.state=null,T},r.inflateGetHeader=function(e,t){var r;return e&&e.state?0==(2&(r=e.state).wrap)?R:(r.head=t,t.done=!1,T):R},r.inflateSetDictionary=function(e,t){var r,a,n=t.length;return e&&e.state?0!==(r=e.state).wrap&&r.mode!==z?R:r.mode===z&&(a=1,(a=m(a,t,n,0))!==r.check)?k:c(e,t,n,n)?(r.mode=ie,N):(r.havedict=1,T):R},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":1,"./adler32":3,"./crc32":5,"./inffast":7,"./inftrees":9}],9:[function(e,t,r){var a=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],_=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],s=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,r,i,l,c,u,d){var f,m,p,h,v,b,g,y,E,w=d.bits,A=0,T=0,x=0,O=0,R=0,k=0,N=0,M=0,I=0,S=0,L=null,C=0,P=new a.Buf16(16),D=new a.Buf16(16),U=null,F=0;for(A=0;A<=15;A++)P[A]=0;for(T=0;T<i;T++)P[t[r+T]]++;for(R=w,O=15;O>=1&&0===P[O];O--);if(R>O&&(R=O),0===O)return l[c++]=20971520,l[c++]=20971520,d.bits=1,0;for(x=1;x<O&&0===P[x];x++);for(R<x&&(R=x),M=1,A=1;A<=15;A++)if(M<<=1,(M-=P[A])<0)return-1;if(M>0&&(0===e||1!==O))return-1;for(D[1]=0,A=1;A<15;A++)D[A+1]=D[A]+P[A];for(T=0;T<i;T++)0!==t[r+T]&&(u[D[t[r+T]]++]=T);if(0===e?(L=U=u,b=19):1===e?(L=n,C-=257,U=_,F-=257,b=256):(L=s,U=o,b=-1),S=0,T=0,A=x,v=c,k=R,N=0,p=-1,I=1<<R,h=I-1,1===e&&I>852||2===e&&I>592)return 1;for(;;){g=A-N,u[T]<b?(y=0,E=u[T]):u[T]>b?(y=U[F+u[T]],E=L[C+u[T]]):(y=96,E=0),f=1<<A-N,x=m=1<<k;do{l[v+(S>>N)+(m-=f)]=g<<24|y<<16|E|0}while(0!==m);for(f=1<<A-1;S&f;)f>>=1;if(0!==f?(S&=f-1,S+=f):S=0,T++,0==--P[A]){if(A===O)break;A=t[r+u[T]]}if(A>R&&(S&h)!==p){for(0===N&&(N=R),v+=x,M=1<<(k=A-N);k+N<O&&!((M-=P[k+N])<=0);)k++,M<<=1;if(I+=1<<k,1===e&&I>852||2===e&&I>592)return 1;l[p=S&h]=R<<24|k<<16|v-c|0}}return 0!==S&&(l[v+S]=A-N<<24|64<<16|0),d.bits=R,0}},{"../utils/common":1}],10:[function(e,t,r){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],11:[function(e,t,r){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],"/lib/inflate.js":[function(e,t,r){function a(e){if(!(this instanceof a))return new a(e);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var r=_.inflateInit2(this.strm,t.windowBits);if(r!==i.Z_OK)throw new Error(l[r]);this.header=new u,_.inflateGetHeader(this.strm,this.header)}function n(e,t){var r=new a(t);if(r.push(e,!0),r.err)throw r.msg||l[r.err];return r.result}var _=e("./zlib/inflate"),s=e("./utils/common"),o=e("./utils/strings"),i=e("./zlib/constants"),l=e("./zlib/messages"),c=e("./zlib/zstream"),u=e("./zlib/gzheader"),d=Object.prototype.toString;a.prototype.push=function(e,t){var r,a,n,l,c,u,f=this.strm,m=this.options.chunkSize,p=this.options.dictionary,h=!1;if(this.ended)return!1;a=t===~~t?t:!0===t?i.Z_FINISH:i.Z_NO_FLUSH,"string"==typeof e?f.input=o.binstring2buf(e):"[object ArrayBuffer]"===d.call(e)?f.input=new Uint8Array(e):f.input=e,f.next_in=0,f.avail_in=f.input.length;do{if(0===f.avail_out&&(f.output=new s.Buf8(m),f.next_out=0,f.avail_out=m),(r=_.inflate(f,i.Z_NO_FLUSH))===i.Z_NEED_DICT&&p&&(u="string"==typeof p?o.string2buf(p):"[object ArrayBuffer]"===d.call(p)?new Uint8Array(p):p,r=_.inflateSetDictionary(this.strm,u)),r===i.Z_BUF_ERROR&&!0===h&&(r=i.Z_OK,h=!1),r!==i.Z_STREAM_END&&r!==i.Z_OK)return this.onEnd(r),this.ended=!0,!1;f.next_out&&(0!==f.avail_out&&r!==i.Z_STREAM_END&&(0!==f.avail_in||a!==i.Z_FINISH&&a!==i.Z_SYNC_FLUSH)||("string"===this.options.to?(n=o.utf8border(f.output,f.next_out),l=f.next_out-n,c=o.buf2string(f.output,n),f.next_out=l,f.avail_out=m-l,l&&s.arraySet(f.output,f.output,n,l,0),this.onData(c)):this.onData(s.shrinkBuf(f.output,f.next_out)))),0===f.avail_in&&0===f.avail_out&&(h=!0)}while((f.avail_in>0||0===f.avail_out)&&r!==i.Z_STREAM_END);return r===i.Z_STREAM_END&&(a=i.Z_FINISH),a===i.Z_FINISH?(r=_.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===i.Z_OK):a!==i.Z_SYNC_FLUSH||(this.onEnd(i.Z_OK),f.avail_out=0,!0)},a.prototype.onData=function(e){this.chunks.push(e)},a.prototype.onEnd=function(e){e===i.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Inflate=a,r.inflate=n,r.inflateRaw=function(e,t){return t=t||{},t.raw=!0,n(e,t)},r.ungzip=n},{"./utils/common":1,"./utils/strings":2,"./zlib/constants":4,"./zlib/gzheader":6,"./zlib/inflate":8,"./zlib/messages":10,"./zlib/zstream":11}]},{},[])("/lib/inflate.js")}),t.inflate=window.pako.inflate}),D=o("__sfx",function(e,t){function r(){var e=window.AudioContext||window.webkitAudioContext;if(e){try{var t=new e}catch(e){return I.error('Unable to initialize AudioContext: "'+e+'". The audio is disabled.'),null}return t.createGain?t:(I.warn("deprecated WebAudio implementation"),null)}return I.warn("WebAudio is not supported"),null}function a(){return!!window.MediaElementAudioSourceNode||(I.warn("MediaElementAudioSourceNode not found"),!1)}function n(e,t){if(e.active>-1&&y(e.speakers[e.active]),-1==e.active&&e.random)a=Math.round(Math.random()*(e.speakers.length-1));else if(e.random)var r=1+Math.round(Math.random()*(e.speakers.length-2)),a=(e.active+r)%e.speakers.length;else a=(e.active+1)%e.speakers.length;o(e.speakers[a]),e.active=a,e.active_start_time=t}function _(e,t,r){var a=e.sfx;if("NONE"!=a.behavior){var n=a.loop,_=a.pitch;if(a.src&&(n||r>=0)){a.base_seed=Math.floor(5e4*Math.random());var o=Z.currentTime+t;o=Math.max(0,o),a.start_time=o,a.state=G;var l=Q._sfx;if("POSITIONAL"==a.behavior&&"none"==l.distance_model&&(a.behavior="BACKGROUND_SOUND"),s(e,Q._sfx),"POSITIONAL"==a.behavior||"BACKGROUND_SOUND"==a.behavior){var d=Z.createBufferSource();if(d.buffer=a.src,d.playbackRate.value=_,n){if(a.source_node&&a.source_node.disconnect(),a.source_node2&&a.source_node2.disconnect(),d.loop=!0,d.loopStart=a.loop_start,d.loopEnd=a.loop_end,a.loop_end){var m=Z.createBufferSource();m.buffer=a.src,m.playbackRate.value=_,a.source_node2=m,m.connect(a.proc_chain_in)}d.start(o),a.duration=0}else{var h=d.buffer?d.buffer.duration:0;if(r>h){var v=o+r+a.fade_out;d.loop=!0,d.start(o),d.stop(v),a.duration=r}else d.loop=!1,d.start(o),a.duration=h}d.connect(a.proc_chain_in),a.source_node=d,i(a),c(a),u(a)}else if("BACKGROUND_MUSIC"==a.behavior){L.clear_timeout(a.bgm_start_timeout),L.clear_timeout(a.bgm_stop_timeout);var b=function(){p(e)};if(0==t?b():a.bgm_start_timeout=L.set_timeout(b,1e3*t),n)a.duration=0;else{var g=N(e);a.duration=g}}f(a,o)}}}function s(e,t){var r=e.sfx;if(!r.proc_chain_in){var a=C.get_trans_view(e.render.world_tsr),n=C.get_quat_view(e.render.world_tsr);if(F.mix_mode)(_=Z.createBiquadFilter()).type="peaking";else var _=null;var s=Z.createGain();switch(r.behavior){case"POSITIONAL":"string"!=typeof(i=Z.createPanner()).panningModel?(i.panningModel=i.EQUALPOWER,i.distanceModel=i.INVERSE_DISTANCE):(i.panningModel="equalpower",i.distanceModel=t.distance_model),i.setPosition(a[0],a[1],a[2]),D.copy(a,r.last_position);var o=W;P.quat_to_dir(n,P.AXIS_MZ,o),i.setOrientation(o[0],o[1],o[2]),i.refDistance=r.dist_ref,i.maxDistance=r.dist_max,i.rolloffFactor=r.attenuation,i.coneInnerAngle=r.cone_angle_inner,i.coneOuterAngle=r.cone_angle_outer,i.coneOuterGain=r.cone_volume_outer,(c=Z.createGain()).gain.value=k(r),_?(i.connect(_),_.connect(c)):i.connect(c),c.connect(s),r.proc_chain_in=i,r.volume_random?(l=Z.createGain(),s.connect(l),l.connect(t.proc_chain_in)):(l=null,s.connect(t.proc_chain_in));break;case"BACKGROUND_SOUND":i=null,(c=Z.createGain()).gain.value=k(r),_?(r.proc_chain_in=_,_.connect(c)):r.proc_chain_in=c,c.connect(s),r.volume_random?(l=Z.createGain(),s.connect(l),l.connect(t.proc_chain_in)):(l=null,s.connect(t.proc_chain_in));break;case"BACKGROUND_MUSIC":var i=null,l=null,c=Z.createGain();c.gain.value=k(r),_?(r.proc_chain_in=_,_.connect(c)):r.proc_chain_in=c,c.connect(s),s.connect(t.proc_chain_in)}r.panner_node=i,r.filter_node=_,r.gain_node=c,r.fade_gain_node=s,r.rand_gain_node=l}}function o(e){var t=e.sfx,r=t.duration;_(e,t.delay+t.delay_random*Math.random(),r)}function i(e){var t=e.source_node2||e.source_node;P.isdef(t.onended)&&(t.onended=function(){e.state=Y})}function c(e){e.volume_random&&e.rand_gain_node.gain.cancelScheduledValues(e.start_time),e.pitch_random&&(e.source_node.playbackRate.cancelScheduledValues(e.start_time),e.source_node2&&e.source_node2.playbackRate.cancelScheduledValues(e.start_time)),e.vp_rand_end_time=e.start_time}function u(e){if(e.volume_random||e.pitch_random){var t=e.rand_gain_node,r=e.source_node,a=r.buffer?r.buffer.duration:0;if(a){var n=e.start_time;$[0]=e.base_seed;for(var _=0;_<H;){var s=e.pitch+e.pitch_random*P.rand_r($);if(n>=e.vp_rand_end_time){if(e.volume_random){var o=1-P.clamp(e.volume_random,0,1)*Math.random();t.gain.setValueAtTime(o,n)}e.pitch_random&&(r.playbackRate.setValueAtTime(s,n),e.source_node2&&e.source_node2.playbackRate.setValueAtTime(s,n)),_++}n+=a/s}e.vp_rand_end_time=n-.001}}}function f(e,t){if(e.fade_in||e.fade_out){var r=e.fade_gain_node;r.gain.cancelScheduledValues(t),e.fade_in?(r.gain.setValueAtTime(0,t),r.gain.linearRampToValueAtTime(1,t+e.fade_in)):r.gain.setValueAtTime(1,t),e.fade_out&&!e.loop&&(r.gain.setValueAtTime(1,t+e.duration),r.gain.linearRampToValueAtTime(0,t+e.duration+e.fade_out))}}function p(e){var t=e.sfx,r=t.src;r&&(r.volume=1,r.loop=t.loop,t.source_node=t.source_node||Z.createMediaElementSource(r),t.source_node.connect(t.proc_chain_in),t.state==G&&(r.currentTime&&(r.currentTime=0),r.play()))}function b(e){var t=e.sfx.src;t&&(t.currentTime&&(t.currentTime=0),t.pause())}function y(e){"SPEAKER"!=e.type&&P.panic("Wrong object type");var t=e.sfx;if(t.state!=Y){if(t.state==G||t.state==z){var r=t.fade_gain_node,a=Z.currentTime;if(t.fade_out&&(r.gain.setValueAtTime(r.gain.value,a),r.gain.linearRampToValueAtTime(0,a+t.fade_out)),"BACKGROUND_MUSIC"==t.behavior)t.src&&(L.clear_timeout(t.bgm_start_timeout),L.clear_timeout(t.bgm_stop_timeout),t.bgm_stop_timeout=L.set_timeout(function(){b(e)},1e3*t.fade_out));else{var n=t.source_node;n.onended=function(){},t.duration<n.buffer.duration?t.fade_out&&t.state==G?n.stop(a+t.fade_out):t.state==G&&(n.stop(0),n.disconnect()):n.disconnect(),t.start_time=0,t.pause_time=0,t.buf_offset=0}t.state=j}}else t.state=j}function E(e){var t=e.sfx;if(t.state==G){var r=Z.currentTime;if(t.pause_time=r,"BACKGROUND_MUSIC"==t.behavior){var a=t.src;a&&a.pause()}else r>t.start_time?t.buf_offset=w(t,r):t.buf_offset=0,t.source_node.onended=function(){},t.source_node.stop(0),t.source_node.disconnect(),c(t);t.state=z}}function w(e,t){$[0]=e.base_seed;for(var r,a=e.source_node.buffer.duration,n=e.start_time;n<t;)n+=a/(r=e.pitch+e.pitch_random*P.rand_r($));return(a/r-(n-t))*r}function A(e){var t=e.sfx;if(t.state==z){var r=Z.currentTime;if(t.start_time+=r-t.pause_time,"BACKGROUND_MUSIC"==t.behavior)t.src.play();else{T(e),t.vp_rand_end_time=r;var a=t.source_node;i(t),a.start(t.start_time,t.buf_offset),u(t)}f(t,t.start_time),t.state=G}}function T(e){var t=e.sfx,r=Z.createBufferSource();if(r.loop=t.source_node.loop,r.loopStart=t.source_node.loopStart,r.loopEnd=t.source_node.loopEnd,r.buffer=t.source_node.buffer,r.playbackRate.value=t.source_node.playbackRate.value,r.connect(t.proc_chain_in),t.source_node=r,t.source_node2){var a=Z.createBufferSource();a.loop=t.source_node2.loop,a.buffer=t.source_node2.buffer,a.playbackRate.value=t.source_node2.playbackRate.value,a.connect(t.proc_chain_in),t.source_node2=a}}function O(e,t,r){var a=1,n=t.doppler_factor;if(n>0){var _=t.speed_of_sound;if(0!=D.dot(e.velocity,e.velocity)||0!=D.dot(t.listener_velocity,t.listener_velocity)){var s=D.subtract(e.last_position,t.listener_last_eye,W),o=D.length(s),i=D.dot(s,t.listener_velocity)/o,l=D.dot(s,e.velocity)/o;i=-i,l=-l;var c=_/n;a=(_-n*(i=Math.min(i,c)))/(_-n*(l=Math.min(l,c))),isFinite(a)||(a=0),a=Math.min(a,16),a=Math.max(a,.125),a=P.smooth(a,e.last_doppler_shift,r,B),e.source_node.playbackRate.value=a,e.last_doppler_shift=a}}}function R(e){var t=e.sfx;return!(!t||t.state!=G&&t.state!=z&&t.state!=j&&t.state!=Y)}function k(e){return e.muted?0:e.volume}function N(e){var t=e.sfx;if("POSITIONAL"==t.behavior||"BACKGROUND_SOUND"==t.behavior){var r=t.src;return r?r.duration:0}var a=t.src;return a?a.duration:0}var M=g(e),I=m(e),S=d(e),L=x(e),C=v(e),P=h(e),D=l(e),U=M.defaults,F=M.sfx,B=.3,G=20,j=30,z=40,Y=50,H=5,W=new Float32Array(3),q=new Float32Array(3),V=S.create(),X=[],K=[],Z=null,Q=null,J=[],$=[1],ee=null;t.AST_NONE=10,t.AST_ARRAY_BUFFER=20,t.AST_HTML_ELEMENT=30,t.create_sfx=function(){return{uuid:-1,filepath:"",behavior:"NONE",muted:!1,volume:1,pitch:1,attenuation:1,dist_ref:1,dist_max:1e4,cone_angle_inner:360,cone_angle_outer:360,cone_volume_outer:1,autoplay:!1,cyclic:!1,loop:!1,loop_start:0,loop_end:0,delay:0,delay_random:0,volume_random:0,pitch_random:0,fade_in:0,fade_out:0,start_time:0,pause_time:0,buf_offset:0,duration:0,vp_rand_end_time:0,base_seed:1,src:null,state:10,last_position:new Float32Array(3),velocity:new Float32Array(3),enable_doppler:!1,last_doppler_shift:1,bgm_start_timeout:-1,bgm_stop_timeout:-1,duck_time:0,proc_chain_in:null,source_node:null,source_node2:null,panner_node:null,filter_node:null,gain_node:null,fade_gain_node:null,rand_gain_node:null,update_counter:0}},t.init=function(){var e=document.createElement("audio"),t=document.createElement("video");e.canPlayType&&(""!=e.canPlayType("audio/ogg")&&(X.push("ogg"),X.push("ogv"),X.push("oga")),""!=e.canPlayType("audio/mpeg")&&X.push("mp3"),""!=e.canPlayType("audio/mp4")&&(X.push("mp4"),X.push("m4v"),X.push("m4a")),""!=e.canPlayType("audio/webm")&&X.push("webm")),t.canPlayType&&(""!=t.canPlayType("video/ogg")&&(K.push("ogv"),K.push("ogg"),K.push("oga")),""!=t.canPlayType("video/mp4")&&(K.push("m4v"),K.push("mp4")),""!=t.canPlayType("video/webm")&&K.push("webm"),""!=t.canPlayType("video/mpeg")&&K.push("mp3"))},t.attach_scene_sfx=function(e){if(F.webaudio&&!Z&&(Z=r())&&I.log("%cINIT WEBAUDIO: "+Z.sampleRate+"Hz","color: #00a"),Z){var t={listener_last_eye:new Float32Array(3),listener_velocity:new Float32Array(3),update_counter:0},a=Z.createGain(),n=Z.createGain();if(t.gain_node=a,t.fade_gain_node=n,a.connect(n),n.connect(Z.destination),e.b4w_enable_dynamic_compressor){var _=Z.createDynamicsCompressor(),s=e.b4w_dynamic_compressor_settings;_.threshold.value=s.threshold,_.knee.value=s.knee,_.ratio.value=s.ratio,_.attack.value=s.attack,_.release.value=s.release,_.connect(a),t.compressor_node=_,t.proc_chain_in=_}else t.compressor_node=null,t.proc_chain_in=a;switch(e.audio_distance_model){case"INVERSE":case"INVERSE_CLAMPED":t.distance_model="inverse";break;case"LINEAR":case"LINEAR_CLAMPED":t.distance_model="linear";break;case"EXPONENT":case"EXPONENT_CLAMPED":t.distance_model="exponential";break;case"NONE":t.distance_model="none";break;default:P.panic("Wrong audio distance model")}t.doppler_factor=e.audio_doppler_factor,t.speed_of_sound=e.audio_doppler_speed,t.muted=!1,t.volume=e.audio_volume,a.gain.value=k(t),t.duck_time=0}else t=null;e._sfx=t},t.set_active_scene=function(e){Q=e},t.detect_audio_container=function(e){return e||(e="ogg"),X.indexOf(e)>-1?e:X.indexOf("m4a")>-1?"m4a":X.indexOf("oga")>-1?"oga":""},t.detect_video_container=function(e){return e||(e="webm"),K.indexOf(e)>-1?e:K.indexOf("m4v")>-1?"m4v":K.indexOf("webm")>-1?"webm":""},t.update_object=function(e,t){var r=e.data,n=t.sfx;if(e.data.sound){switch(n.uuid=e.data.sound.uuid,n.filepath=e.data.sound.filepath,r.b4w_behavior){case"POSITIONAL":case"BACKGROUND_SOUND":n.behavior=Z?r.b4w_behavior:"NONE";break;case"BACKGROUND_MUSIC":n.behavior=Z?a()&&!U.chrome_html_bkg_music_hack?"BACKGROUND_MUSIC":"BACKGROUND_SOUND":"NONE";break;default:P.panic("Wrong speaker behavior")}r.sound||(n.behavior="NONE"),n.enable_doppler=r.b4w_enable_doppler,n.muted=r.muted,n.volume=r.volume,n.pitch=r.pitch,n.attenuation=r.attenuation,n.dist_ref=r.distance_reference,n.dist_max=r.distance_max||1e4,n.cone_angle_inner=r.cone_angle_inner,n.cone_angle_outer=r.cone_angle_outer,n.cone_volume_outer=r.cone_volume_outer,n.autoplay=r.b4w_auto_play,n.cyclic=r.b4w_cyclic_play,n.loop=r.b4w_loop,n.loop_start=r.b4w_loop_start,n.loop_end=r.b4w_loop_end,n.delay=r.b4w_delay,n.delay_random=r.b4w_delay_random,n.volume_random=r.b4w_volume_random,n.pitch_random=r.b4w_pitch_random,n.fade_in=r.b4w_fade_in,n.fade_out=r.b4w_fade_out,J.push(t)}},t.source_type=function(e){switch("SPEAKER"!=e.type&&P.panic("Wrong object type"),e.sfx.behavior){case"POSITIONAL":case"BACKGROUND_SOUND":return t.AST_ARRAY_BUFFER;case"BACKGROUND_MUSIC":return t.AST_HTML_ELEMENT;case"NONE":return t.AST_NONE;default:P.panic("Wrong speaker behavior")}},t.update_spkobj=function(e,t){var r=e.sfx;switch(r.behavior){case"POSITIONAL":case"BACKGROUND_SOUND":case"BACKGROUND_MUSIC":r.src=t;break;case"NONE":break;default:P.panic("Wrong speaker behavior")}},t.play_empty_sound=function(){var e=Z.createBufferSource();e.buffer=Z.createBuffer(1,22050,22050),e.connect(Z.destination),e.start(0)},t.decode_audio_data=function(e,t,r){Z?Z.decodeAudioData(e,t,r):r()},t.speaker_remove=function(e){y(e),e.sfx=null,J.splice(J.indexOf(e),1)},t.cleanup=function(){for(var e=0;e<J.length;e++){var t=J[e].sfx;if("BACKGROUND_MUSIC"==t.behavior){var r=t.src;r&&r.pause()}else t.source_node&&t.source_node.disconnect(),t.source_node2&&t.source_node2.disconnect()}if(Q&&Q._sfx){var a=Q._sfx;a.listener_last_eye[0]=0,a.listener_last_eye[1]=0,a.listener_last_eye[2]=0,a.listener_velocity[0]=0,a.listener_velocity[1]=0,a.listener_velocity[2]=0}Q=null,J.splice(0),ee=null},t.update=function(e,t){if(Z&&0!=J.length){for(var r=0;r<J.length;r++){var a=J[r],_=a.sfx,s=_.source_node,i=Z.currentTime;!_.loop&&_.state==G&&_.duration&&_.start_time+_.duration<i&&("BACKGROUND_MUSIC"==_.behavior||s&&!P.isdef(s.onended))&&(_.state=Y),_.cyclic&&_.state==Y&&o(a),_.state==G&&_.vp_rand_end_time-i<3&&u(_)}ee&&ee.speakers.length&&(-1==ee.active||e>ee.active_start_time+ee.durations[ee.active])&&n(ee,e)}},t.play=_,t.play_def=o,t.stop=y,t.is_playing=function(e){return e.sfx.state==G},t.speaker_pause=E,t.speaker_resume=A,t.loop_stop=function(e,t,r){var a=e.sfx,n=a.source_node2;if(R(e)&&("POSITIONAL"==a.behavior||"BACKGROUND_SOUND"==a.behavior)&&n){var _=Z.currentTime+t;a.source_node.stop(_),n.start(_,a.loop_end)}},t.playrate=function(e,t){var r=e.sfx;r.pitch=t,!R(e)||"POSITIONAL"!=r.behavior&&"BACKGROUND_SOUND"!=r.behavior||(r.source_node.playbackRate.value=t,r.source_node2&&(r.source_node2.playbackRate.value=t),c(r),u(r))},t.get_playrate=function(e){return e.sfx.pitch},t.cyclic=function(e,t){e.sfx.cyclic=Boolean(t)},t.is_autoplay=function(e){return e.sfx.autoplay},t.is_cyclic=function(e){return e.sfx.cyclic},t.listener_update_transform=function(e,t,r,a,n){var _=e._sfx;if(_){var s=W;s[0]=0,s[1]=0,s[2]=-1,D.transformQuat(s,r,s);var o=q;o[0]=0,o[1]=1,o[2]=0,D.transformQuat(o,r,o);var i=Z.listener;if(i.setPosition(t[0],t[1],t[2]),i.setOrientation(s[0],s[1],s[2],o[0],o[1],o[2]),a&&_.update_counter!=n){if(_.listener_stride)_.listener_stride=!1,D.copy(t,_.listener_last_eye);else{var l=_.listener_velocity;l[0]=(t[0]-_.listener_last_eye[0])/a,l[1]=(t[1]-_.listener_last_eye[1])/a,l[2]=(t[2]-_.listener_last_eye[2])/a,D.copy(t,_.listener_last_eye);for(var c=0;c<J.length;c++){var u=J[c],d=u.sfx;R(u)&&"POSITIONAL"==d.behavior&&d.enable_doppler&&O(d,_,a)}}_.update_counter=n}else D.copy(t,_.listener_last_eye)}},t.listener_stride=function(){var e=Q._sfx;e&&(e.listener_stride=!0)},t.speaker_update_transform=function(e,t,r){var a=e.sfx;if(R(e)&&"POSITIONAL"==a.behavior){var n=C.get_trans(e.render.world_tsr,W),_=C.get_quat(e.render.world_tsr,V),s=a.panner_node;s.setPosition(n[0],n[1],n[2]);var o=q;if(P.quat_to_dir(_,P.AXIS_MZ,o),s.setOrientation(o[0],o[1],o[2]),a.enable_doppler){var i=a.last_position;if(t&&a.update_counter!=r){if(a.stride)D.copy(n,i),a.stride=!1;else{var l=a.velocity;l[0]=(n[0]-i[0])/t,l[1]=(n[1]-i[1])/t,l[2]=(n[2]-i[2])/t,D.copy(n,i),O(a,Q._sfx,t)}a.update_counter=r}else D.copy(n,i)}}},t.speaker_stride=function(e){var t=e.sfx;R(e)&&"POSITIONAL"==t.behavior&&t.enable_doppler&&(t.stride=!0)},t.get_spk_behavior=function(e){return e.sfx.behavior},t.check_active_speakers=function(){for(var e=0;e<J.length;e++)if(R(J[e]))return!0;return!1},t.set_master_volume=function(e){var t=Q._sfx;t&&(t.volume=e,Z&&(t.gain_node.gain.value=k(t)))},t.get_master_volume=function(){var e=Q._sfx;return e?e.volume:0},t.set_volume=function(e,t){var r=e.sfx;r.volume=t,R(e)&&(r.gain_node.gain.value=k(r))},t.get_volume=function(e){return e.sfx.volume},t.mute=function(e,t){e.sfx.muted=Boolean(t),R(e)&&(e.sfx.gain_node.gain.value=k(e.sfx))},t.is_muted=function(e){return e.sfx.muted},t.mute_master=function(e){var t=Q._sfx;t&&(t.muted=Boolean(e),Z&&(t.gain_node.gain.value=k(t)))},t.is_master_muted=function(){var e=Q._sfx;return!!e&&e.muted},t.get_speaker_objects=function(){return J},t.pause=function(){for(var e=0;e<J.length;e++)E(J[e])},t.resume=function(){for(var e=0;e<J.length;e++)A(J[e])},t.set_compressor_params=function(e,t){if(e._sfx&&e._sfx.compressor_node){var r=e._sfx.compressor_node;r.threshold.value=t.threshold,r.knee.value=t.knee,r.ratio.value=t.ratio,r.attack.value=t.attack,r.release.value=t.release}},t.get_compressor_params=function(e){if(!e._sfx||!e._sfx.compressor_node)return null;var t=e._sfx.compressor_node;return{threshold:t.threshold.value,knee:t.knee.value,ratio:t.ratio.value,attack:t.attack.value,release:t.release.value}},t.duck=function(e,t,r){if(R(e)){var a=e.sfx,n=a.fade_gain_node,_=Z.currentTime;n.gain.setValueAtTime(n.gain.value,_),n.gain.linearRampToValueAtTime(t,_+r),a.duck_time=r}},t.unduck=function(e){if(R(e)){var t=e.sfx,r=t.fade_gain_node,a=Z.currentTime;r.gain.setValueAtTime(r.gain.value,a),r.gain.linearRampToValueAtTime(1,a+t.duck_time),t.duck_time=0}},t.duck_master=function(e,t){if(Z){var r=Q._sfx,a=r.fade_gain_node,n=Z.currentTime;a.gain.setValueAtTime(a.gain.value,n),a.gain.linearRampToValueAtTime(e,n+t),r.duck_time=t}},t.unduck_master=function(){if(Z){var e=Q._sfx,t=e.fade_gain_node,r=Z.currentTime;t.gain.setValueAtTime(t.gain.value,r),t.gain.linearRampToValueAtTime(1,r+e.duck_time),e.duck_time=0}},t.apply_playlist=function(e,t,r){ee={active:-1,active_start_time:0,random:r,speakers:[],durations:[]};for(var a=0;a<e.length;a++){var n=e[a],_=N(n);0!=_?(y(n),n.sfx.cyclic=!1,ee.speakers.push(n),ee.durations.push(_+t)):I.warn("Ignoring speaker with zero duration: "+n.name)}},t.get_duration=N,t.clear_playlist=function(){if(ee)for(var e=ee.speakers,t=0;t<e.length;t++)y(e[t]);ee=null},t.get_positional_params=function(e){var t=e.sfx;return t&&"POSITIONAL"==t.behavior?{dist_ref:t.dist_ref,dist_max:t.dist_max,attenuation:t.attenuation}:null},t.set_positional_params=function(e,t){var r=e.sfx;if(r&&"POSITIONAL"==r.behavior){r.dist_ref=t.dist_ref,r.dist_max=t.dist_max,r.attenuation=t.attenuation;var a=r.panner_node;a&&(a.refDistance=r.dist_ref,a.maxDistance=r.dist_max,a.rolloffFactor=r.attenuation)}},t.set_filter_params=function(e,t){var r=e.sfx;r&&r.filter_node&&(r.filter_node.frequency.value=t.freq,r.filter_node.Q.value=t.Q,r.filter_node.gain.value=t.gain)},t.get_filter_params=function(e){var t=e.sfx;return t&&t.filter_node?{freq:t.filter_node.frequency.value,Q:t.filter_node.Q.value,gain:t.filter_node.gain.value}:null},t.get_filter_freq_response=function(e,t,r,a){var n=e.sfx;if(!n||!n.filter_node)return null;n.filter_node.getFrequencyResponse(t,r,a)},t.reset=function(){X.length=0,K.length=0,Z=null}}),U=o("__version",function(e,t){function r(){if("DEBUG"==_){var e=a();return[parseInt(String(e.getFullYear()).slice(-2),10),e.getMonth()+1]}return o}function a(){return"DEBUG"==_?new Date:s}function n(){var e=a(),t=e.getDate();t=t<10?"0"+String(t):String(t);var r=e.getMonth()+1;r=r<10?"0"+String(r):String(r);var n=String(e.getFullYear()),_=e.getHours();_=_<10?"0"+String(_):String(_);var s=e.getMinutes();s=s<10?"0"+String(s):String(s);var o=e.getSeconds();return t+"."+r+"."+n+" "+_+":"+s+":"+(o=o<10?"0"+String(o):String(o))}var _="DEBUG",s=null,o=null;t.version=r,t.version_str=function(){for(var e="",t=r(),a=0;a<t.length;a++)e+=1==a&&t[a]<10?"0"+t[a]:t[a],a!=t.length-1&&(e+=".");return e},t.type=function(){return _},t.date=a,t.date_str=n,t.get_build_version=function(){if("DEBUG"!=_)return"_b4w_ver_";var e=n();return e=e.split(" ").join("").split(":").join("").split(".").join("")}}),F=o("__assets",function(e,t){function r(){return b.is_built_in_data()?require(b.paths.built_in_data_module).data:null}function a(){var e={_source_url:null,_parse_response:function(t){switch(e.responseType){case"json":case"text":return t;case"arraybuffer":for(var r=atob(t),a=r.length,n=new Int8Array(a),_=0;_<a;_++)n[_]=r.charCodeAt(_);return n.buffer;default:return t}},status:0,readyState:0,response:"",responseType:"",onreadystatechange:null,overrideMimeType:function(){},addEventListener:function(){},open:function(t,r,a){e._source_url=r,e.readyState=1},send:function(){e.status=404,e.readyState=4;var t=r();t&&e._source_url in t&&(e.status=200,t[e._source_url]&&(e.response=e._parse_response(t[e._source_url]))),"[object Function]"==={}.toString.call(e.onreadystatechange)&&e.onreadystatechange()}};return e}function n(e){for(var r=0,a=0;a<e.length;a++){var n=e[a];if(n.state===N&&r++,r>=R.max_requests)break;if(n.state===k)switch(n.state=N,r++,n.type){case t.AT_JSON_ZIP:case t.AT_ARRAYBUFFER:case t.AT_ARRAYBUFFER_ZIP:_(n,"arraybuffer");break;case t.AT_JSON:_(n,"json");break;case t.AT_TEXT:_(n,"text");break;case t.AT_AUDIOBUFFER:s(n);break;case t.AT_IMAGE_ELEMENT:o(n);break;case t.AT_AUDIO_ELEMENT:i(n);break;case t.AT_VIDEO_ELEMENT:l(n);break;case t.AT_SEQ_VIDEO_ELEMENT:c(n);break;default:T.panic("Wrong asset type: "+n.type)}}}function _(e,n){var _=e.url.split("?v=")[0];if(_ in F)"json"==n?e.asset_cb(T.clone_object_r(F[_]),e.id,e.type,e.url,e.param):e.asset_cb(F[_],e.id,e.type,e.url,e.param);else{var s=r();if(s&&e.url in s)o=new a;else var o=new XMLHttpRequest;var i=null;if("GET"==e.request_method)o.open("GET",e.url,!0);else if("POST"==e.request_method)switch(o.open("POST",e.url,!0),e.type){case t.AT_TEXT:i="text/plain";break;case t.AT_JSON:i="application/json"}if(e.overwrite_header)for(var l in e.overwrite_header)"Content-Type"==l?i=e.overwrite_header[l]:o.setRequestHeader(l,e.overwrite_header[l]);i&&o.setRequestHeader("Content-Type",i),"text"==n?(o.overrideMimeType("text/plain"),o.responseType="text"):"json"==n?(o.overrideMimeType("application/json"),o.responseType="text"):o.responseType=n,o.onreadystatechange=function(){if(e.state!=I&&4==o.readyState){if(200==o.status||0==o.status){var r=o.response;if(!r||"arraybuffer"==n&&0==r.byteLength)w.error("empty responce when trying to get "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param);else{switch(e.type){case t.AT_JSON_ZIP:try{r=E.inflate(r,{to:"string"})}catch(t){return w.error(t+" (parsing gzipped file "+e.url+")"),void e.asset_cb(null,e.id,e.type,e.url,e.param)}case t.AT_JSON:try{r=JSON.parse(r,e.json_reviver)}catch(t){return w.error(t+" (parsing JSON "+e.url+")"),void e.asset_cb(null,e.id,e.type,e.url,e.param)}break;case t.AT_ARRAYBUFFER_ZIP:try{r=E.inflate(r).buffer}catch(t){return w.error(t+" (parsing gzipped file "+e.url+")"),void e.asset_cb(null,e.id,e.type,e.url,e.param)}}e.is_fetch&&(e.type==t.AT_JSON||e.type==t.AT_JSON_ZIP?F[_]=T.clone_object_r(r):F[_]=r),e.asset_cb(r,e.id,e.type,e.url,e.param)}}else w.error(o.status+" when trying to get "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param);e.state=M}},o.addEventListener("progress",function(t){t.lengthComputable&&e.progress_cb(t.loaded/t.total)},!1),o.send(e.post_data)}}function s(e){var t=e.url.split("?v=")[0];if(t in j)return e.asset_cb(j[t],e.id,e.type,e.url,e.param),void(e.state=M);"GET"!=e.request_method&&T.panic("Unsupported request type for audio buffer");var n=r();if(n&&e.url in n)_=new a;else var _=new XMLHttpRequest;_.open("GET",e.url,!0),_.responseType="arraybuffer",_.onreadystatechange=function(){if(e.state!=I&&4==_.readyState)if(200==_.status||0==_.status){var t=_.response;t?A.decode_audio_data(t,function(t){if(e.asset_cb(t,e.id,e.type,e.url,e.param),e.state=M,e.is_fetch){var r=e.url.split("?v=")[0];j[r]=t}},function(){w.error("failed to decode "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M}):(w.error("empty responce when trying to get "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M)}else w.error(_.status+" when trying to get "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M},_.send()}function o(e){var t=e.url.split("?v=")[0];if(t in B)return e.asset_cb(B[t],e.id,e.type,e.url,e.param),void(e.state=M);"GET"!=e.request_method&&T.panic("Unsupported request type for image element");var a=document.createElement("img");O.allow_cors&&(a.crossOrigin="Anonymous"),a.onload=function(){if(e.state!=I&&(e.asset_cb(a,e.id,e.type,e.url,e.param),e.state=M,e.is_fetch)){var t=e.url.split("?v=")[0];B[t]=a}},a.addEventListener("error",function(){e.state!=I&&(w.error("could not load image: "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M)},!1);var n=r();if(n&&e.url in n)if(n[e.url]){var _=d(e.url);a.src="data:"+_+";base64,"+n[e.url]}else{if(y.is_ie11())(s=document.createEvent("CustomEvent")).initCustomEvent("error",!1,!1,null);else var s=new CustomEvent("error");a.dispatchEvent(s)}else a.src=e.url}function i(e){var t=e.url.split("?v=")[0];if(t in G)return e.asset_cb(G[t],e.id,e.type,e.url,e.param),void(e.state=M);"GET"!=e.request_method&&T.panic("Unsupported request type for audio element");var a=document.createElement("audio");O.allow_cors&&(a.crossOrigin="Anonymous"),a.addEventListener("loadeddata",function(){if(e.state!=I&&(e.asset_cb(a,e.id,e.type,e.url,e.param),e.state=M,e.is_fetch)){var t=e.url.split("?v=")[0];G[t]=a}},!1),a.addEventListener("error",function(){e.state!=I&&(w.error("could not load sound: "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M)},!1),a.addEventListener("stalled",function(){e.state!=I&&(w.error("could not load sound: "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M)},!1);var n=r();if(n&&e.url in n)if(n[e.url]){var _=f(e.url);a.src="data:"+_+";base64,"+n[e.url],e.state!=I&&(e.asset_cb(a,e.id,e.type,e.url,e.param),e.state=M)}else{if(y.is_ie11())(s=document.createEvent("CustomEvent")).initCustomEvent("error",!1,!1,null);else var s=new CustomEvent("error");a.dispatchEvent(s)}else a.src=e.url,O.is_mobile_device&&a.load();O.mobile_firefox_media_hack&&(a.autoplay=!0,a.pause()),setTimeout(function(){a.some_prop_to_prevent_gc=1},5e3)}function l(e){function t(t){e.state!=I&&(w.error("could not load video: "+e.url,e.param),e.asset_cb(null,e.id,e.type,e.url),e.state=M)}var a=e.url.split("?v=")[0];if(a in B)return e.asset_cb(B[a],e.id,e.type,e.url,e.param),void(e.state=M);"GET"!=e.request_method&&T.panic("Unsupported request type for video element");var n=document.createElement("video");n.muted=!0,O.allow_cors&&(n.crossOrigin="Anonymous"),n.addEventListener("loadeddata",function(){if(n.removeEventListener("error",t,!1),e.state!=I&&(e.asset_cb(n,e.id,e.type,e.url,e.param),e.state=M,e.is_fetch)){var r=e.url.split("?v=")[0];B[r]=n}},!1),n.addEventListener("error",t,!1);var _=r();if(_&&e.url in _)if(_[e.url]){var s=p(e.url);n.src="data:"+s+";base64,"+_[e.url],e.state!=I&&n.addEventListener("loadeddata",function(){e.asset_cb(n,e.id,e.type,e.url,e.param),e.state=M},!1)}else{if(y.is_ie11())(o=document.createEvent("CustomEvent")).initCustomEvent("error",!1,!1,null);else var o=new CustomEvent("error");n.dispatchEvent(o)}else n.src=e.url,O.is_mobile_device&&n.load();(O.mobile_firefox_media_hack||O.ipad_video_hack)&&(n.autoplay=!0,n.pause()),setTimeout(function(){n.some_prop_to_prevent_gc=1},1e4)}function c(e){function t(t){if(e.asset_cb(t,e.id,e.type,e.url,e.param),e.state=M,e.is_fetch){var r=e.url.split("?v=")[0];B[r]=t}}var n=e.url.split("?v=")[0];if(n in B)return e.asset_cb(B[n],e.id,e.type,e.url,e.param),void(e.state=M);"GET"!=e.request_method&&T.panic("Unsupported request type for seq video element");var _=r();if(_&&e.url in _)s=new a;else var s=new XMLHttpRequest;s.open("GET",e.url,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){if(e.state!=I&&4==s.readyState)if(200==s.status||0==s.status){var r=s.response;r?u(r,t):(w.error("empty responce when trying to get "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M)}else w.error(s.status+" when trying to get "+e.url),e.asset_cb(null,e.id,e.type,e.url,e.param),e.state=M},s.addEventListener("progress",function(t){t.lengthComputable&&e.progress_cb(t.loaded/t.total)},!1),s.send()}function u(e,t){for(var r=new Int32Array(e),a=new Int8Array(e),n=r[3],_={images:[],blobs:[],fps:r[4]},s=20,o=0;o<n;o++){var i=r[s/4],l=a.subarray(s+4,s+4+i),c=new Blob([l],{type:"image/jpg"}),u=document.createElement("img");u.src=window.URL.createObjectURL(c),_.images.push(u),_.blobs.push(c),s+=i+8-i%4}u.onload=function(){for(var e=0;e<_.images.length;e++)window.URL.revokeObjectURL(_.images[e].src);delete _.blobs,t(_)}}function d(e){var t="image";switch(T.get_file_extension(e).toLowerCase()){case"jpeg":case"jpg":t+="/jpeg";break;case"png":t+="/png"}return t}function f(e){var t="audio";switch(T.get_file_extension(e).toLowerCase()){case"ogv":case"ogg":t+="/ogg";break;case"mp3":t+="/mpeg";break;case"m4v":case"mp4":t+="/mp4";break;case"webm":t+="/webm"}return t}function p(e){var t="video";switch(T.get_file_extension(e).toLowerCase()){case"ogv":t+="/ogg";break;case"webm":t+="/webm";break;case"m4v":case"mp4":t+="/mp4"}return t}function v(e){for(var t=0,r=!0,a=0;a<e.length;a++){var n=e[a],_=e[t];if(n.pack_index===_.pack_index)n.state!==M&&(r=!1);else{if(r){e[a-1].pack_cb();var s=a-t;e.splice(t,s),a-=s}t=a,r=e[a].state===M}if(a===e.length-1&&r){var o=e[a];e.splice(t),o.pack_cb()}}}var b=g(e),y=re(e),E=P(e),w=m(e),A=D(e),T=h(e),x=U(e),O=b.defaults,R=b.assets;t.AT_ARRAYBUFFER=10,t.AT_ARRAYBUFFER_ZIP=20,t.AT_JSON=30,t.AT_JSON_ZIP=40,t.AT_TEXT=50,t.AT_AUDIOBUFFER=60,t.AT_IMAGE_ELEMENT=70,t.AT_AUDIO_ELEMENT=80,t.AT_VIDEO_ELEMENT=90,t.AT_SEQ_VIDEO_ELEMENT=100;var k=10,N=20,M=30,I=40,S=[],L=0,C={},F={},B={},G={},j={};t.split_extension=function(e){var t=e.split("."),r=Array(2);return r[0]=t.slice(0,-1).join("."),r[1]=String(t.slice(-1)),r},t.get_text_sync=function(e){if(C[e])return C[e];if(R.prevent_caching)t=e+"?v="+x.get_build_version();else var t=e;var r=new XMLHttpRequest;if(r.overrideMimeType("text/plain"),r.open("GET",t,!1),r.send(null),200==r.status||0==r.status){var a=r.responseText;if(a.length)return C[e]=a,a;T.panic("Error XHR: responce is empty, GET "+e)}else T.panic("Error XHR: "+r.status+", GET "+e)},t.cleanup=function(){for(var e=0;e<S.length;e++)S[e].state=I;S=[],L=0,C={}},t.enqueue=function(e,t,a,_,s){for(var o=0;o<e.length;o++){var i=e[o],l={id:i.id,type:i.type,url:i.url,is_fetch:i.is_fetch,request_method:i.request_method?i.request_method:"GET",overwrite_header:i.overwrite_header?i.overwrite_header:null,post_data:i.post_data?i.post_data:null,param:i.param?i.param:null,state:k,asset_cb:t||function(){},pack_cb:a||function(){},progress_cb:_||function(){},json_reviver:s||null,pack_index:L};if(R.prevent_caching){var c=r();c&&l.url in c||(l.url+="?v="+x.get_build_version())}S.push(l)}n(S),L++},t.update=function(){n(S),v(S)},t.check_image_extension=function(e){return"png"==e||"jpg"==e||"jpeg"==e||"gif"==e||"bmp"==e||"dds"==e||"pvr"==e},t.clear_cache=function(){F={},B={},G={},j={}}}),B=o("__shaders",function(e,t){function r(){return{vert:"",frag:"",directives:[],node_elements:[],status:$,attribute_count:0,texture_count:0}}function a(e){var t=r();return t.vert=e.vert,t.frag=e.frag,t.directives=z.clone_object_r(e.directives),t.node_elements=z.clone_object_r(e.node_elements),t.status=e.status,t.attribute_count=e.attribute_count,t.texture_count=e.texture_count,t}function n(e,t,r){var a=e.directives;if("string"==typeof r){var n=_(e,r);n&&(r=n[1])}else r=String(r);for(var s=0;s<a.length;s++)if(a[s][0]==t)return void(a[s][1]=r);q&&j.error("Incompatible directive '"+t+"' was set for shaders "+e.vert+"/"+e.frag+".")}function _(e,t){for(var r=e.directives,a=0;a<r.length;a++)if(r[a][0]==t)return r[a];return!1}function s(e,t){var r=e+t;if(!(r in Z)){var a=A(W.shaders_path,e),n=A(W.shaders_path,t),_=R(a),s=R(n);for(var o in s)_[o]=s[o];var i=[];for(var o in _)i.push([o,_[o]]);Z[r]=i}return Z[r]}function o(e,t,r){var a=$,n=c(e,oe);r.texture_count=n,n>H.max_texture_image_units&&(a|=ee),i(),p(e,pe,H.max_fragment_uniform_vectors)||(a|=te),p(t,he,H.max_vertex_uniform_vectors)||(a|=re);var _=u(t);r.attribute_count=_,_>H.max_vertex_attribs&&(a|=ne),f(e)||(a|=_e),r.status=a}function i(){me||(me=new Uint32Array(H.max_varying_vectors)),pe||(pe=new Uint32Array(H.max_fragment_uniform_vectors)),he||(he=new Uint32Array(H.max_vertex_uniform_vectors))}function l(e,t){return e+t}function c(e,t){return(e.split(";").map(function(e){var r=e.match(t);return r&&(r[3]?parseInt(r[3],10):1)}).filter(function(e){return e})||[]).reduce(l,0)}function u(e){return Y.webgl2?(e.replace(/(.*?)\([^()]*?\)(.*?)/g,"$1$2").match(/(?:^|[^a-zA-Z_])in(?=\s)/g)||[]).length:(e.match(/(?:^|[^a-zA-Z_])attribute(?=\s)/g)||[]).length}function d(e,t){var r=w(e.type),a=w(t.type),n=e.array_size,_=t.array_size;return r>a?-1:r<a?1:n>_?-1:n<_?1:0}function f(e){if(Y.webgl2)e=e.replace(/(.*?)\([^()]*?\)(.*?)/g,"$1$2"),t=le;else var t=ce;return v(e.split(";").map(function(e){var r=e.match(t);return r&&{type:r[2],array_size:r[4]?parseInt(r[4],10):1}}).filter(function(e){return e}),me,H.max_varying_vectors)}function p(e,t,r){for(var a=e.split(";"),n=[],_=0;_<a.length;_++){var s=a[_].match(ie);s&&n.push({type:s[2],array_size:s[4]?parseInt(s[4],10):1})}return v(n,t,r)}function v(e,t,r){if(!e.length)return!0;for(var a=0;a<r;a++)t[a]=0;be=r,e.sort(d);var n=0,_=0,s=0;return function(){for(;s<e.length;){var r=e[s];if(4!=w(r.type))break;_+=E(r.type)*r.array_size,s++}return!(_>be||(ve=_,y(t,0,_,0,4),0))}()&&function(){for(var r=0;s<e.length;){var a=e[s];if(3!=w(a.type))break;r+=E(a.type)*a.array_size,s++}return!((n=_+r)>be||(y(t,_,r,0,3),0))}()&&function(){for(var r=be-n,a=r,_=r;s<e.length;){var o=e[s];if(2!=w(o.type))break;var i=E(o.type)*o.array_size;if(i<=a)a-=i;else{if(!(i<=_))return!1;_-=i}s++}var l=r-_;return y(t,n,r-a,0,2),y(t,be-l,l,2,2),!0}()&&function(){for(;s<e.length;){for(var a=e[s],n=E(a.type)*a.array_size,_=-1,o=r+1,i=-1,l=0;l<4;l++){var c=fe;c[0]=0,c[1]=1,b(t,l,n,c)&&c[1]<o&&(i=c[0],o=c[1],_=l)}if(_<0)return!1;y(t,i,n,_,1),s++}return!0}()}function b(e,t,r,a){for(;ve<e.length&&e[ve]===de;)ve++;for(;be>0&&e[be]===de;)be--;if(be-ve<r)return!1;for(var n=1<<t,_=0,s=-1,o=e.length+1,i=!1,l=ve;l<=be;l++)if(l<be&&!(e[l]&n))i||(_=l,i=!0);else{if(i){var c=l-_;c>=r&&c<o&&(o=c,s=_)}i=!1}return!(s<0||(a[0]=s,a[1]=o,0))}function y(e,t,r,a,n){for(var _=0,s=0;s<n;s++)_|=1<<a+s;for(s=0;s<r;s++)e[t+s]|=_}function E(e){var t=0;switch(e){case"mat4":t=4;break;case"mat3":t=3;break;case"mat2":t=2;break;default:t=1}return t}function w(e){var t=0;switch(e){case"mat4":case"vec4":case"ivec4":case"bvec4":case"mat2":t=4;break;case"mat3":case"vec3":case"ivec3":case"bvec3":t=3;break;case"vec2":case"ivec2":case"bvec2":t=2;break;default:t=1}return t}function A(e,t){var r=e+t;if(X[r])return X[r];if(K){var a=K[t];if(!a)return null;var n=T().parse(a)}else if(!(n=require("shader_texts")[t]))return null;return X[r]=n,n}function T(){return require("__gpp_parser").parser}function x(e,t){K||(K={}),K[e]=t}function O(e,t){for(var r={},a=t.directives||[],n=0;n<a.length;n++)r[a[n][0]]=[a[n][1]];for(n=0;n<t.node_elements.length;n++)r["USE_NODE_"+t.node_elements[n].id]=["1"];Y.webgl2?(r.GLSL1=["0"],r.GLSL3=["1"],r.GLSL_VERSION=["300 es"],r.GLSL_IN=["in"],r.GLSL_OUT=["out"],r.GLSL_OUT_FRAG_COLOR=["glsl_out_frag_color"],r.GLSL_TEXTURE=["texture"],r.GLSL_TEXTURE_CUBE=["texture"],r.GLSL_TEXTURE_PROJ=["textureProj"],r.GLSL_TEXTURE_LOD=["textureLod"],r.GLSL_TEXTURE_CUBE_LOD=["textureLod"]):(r.GLSL1=["1"],r.GLSL3=["0"],r.GLSL_VERSION=["100"],r.GLSL_IN="vert"==e?["attribute"]:["varying"],r.GLSL_OUT="vert"==e?["varying"]:[""],r.GLSL_OUT_FRAG_COLOR=["gl_FragColor"],r.GLSL_TEXTURE=["texture2D"],r.GLSL_TEXTURE_CUBE=["textureCube"],r.GLSL_TEXTURE_PROJ=["texture2DProj"],r.GLSL_TEXTURE_LOD=["textureLod"],Y.texture_lod_available?(r.GLSL_TEXTURE_LOD=["texture2DLodEXT"],r.GLSL_TEXTURE_CUBE_LOD=["textureCubeLodEXT"]):(r.GLSL_TEXTURE_LOD=["texture2D"],r.GLSL_TEXTURE_CUBE_LOD=["textureCube"])),Y.compared_mode_depth&&!Y.rgba_fallback_shadows?r.GLSL_SMPLR2D_SHDW=["sampler2DShadow"]:r.GLSL_SMPLR2D_SHDW=["sampler2D"];for(var _ in r)r[_][0].constructor!=String&&j.warn("Warning! The value of a directive '"+_+"' is not of type string.");return r}function R(e){function t(e,t,n){e instanceof Array?r(e,t,n):e instanceof Object&&e&&a(e,t,n)}function r(e,r,a){for(var n=0;n<e.length;n++)t(e[n],r,a)}function a(e,r,a){r&&r(e);for(var n in e)t(e[n],r,a);a&&a(e)}var n={},_=function(e){"var"==e.TYPE?n[e.NAME]=e.TOKENS.join(""):"include"==e.TYPE&&t(A(W.shaders_path,W.shaders_include_dir+e.FILE),_)};return t(e,_),n}function k(e,t,r){function a(e){for(var t=e.PARTS,r=0;r<t.length;r++){var a=t[r];switch(a.TYPE){case"cond":n(a);break;case"include":o(a);break;case"var":break;case"define":i(a);break;case"error":l(a);break;case"line":break;case"pragma":c(a);break;case"undef":u(a);break;case"warning":d(a);break;case"extension":f(a);break;case"version":m(a);case"#":break;case"node":p(a);break;case"nodes_global":v(I);break;case"nodes_main":y(I);break;case"txt":R(a.TOKENS);break;default:z.panic("Unknown element type: "+a.TYPE)}}}function n(e){for(var t=e.PARTS,r=0;r<t.length;r++){var n=t[r];switch(n.TYPE){case"if":case"elif":if(_(n.EXPRESSION))return void a(n.GROUP);break;case"else":return void a(n.GROUP);case"ifdef":n.NAME in L&&a(n.GROUP);break;case"ifndef":n.NAME in L||a(n.GROUP)}}}function _(e,t){return s(N(e,L,C,!0,t))}function s(e){for(var t=[],r=0;r<e.length;r++)if(e[r]instanceof Object)switch(e[r].TYPE){case"conditional_expr":var a=t.pop(),n=t.pop();t.pop()?t.push(n):t.push(a);break;case"logical_or_expr":for(var _=t.pop(),s=0;s<e[r].PLACES-1;s++)l=t.pop(),_=_||l;t.push(_);break;case"logical_and_expr":for(var _=t.pop(),s=0;s<e[r].PLACES-1;s++)l=t.pop(),_=_&&l;t.push(_);break;case"logical_bitor_expr":for(var _=t.pop(),s=0;s<e[r].PLACES-1;s++)_|=t.pop();t.push(_);break;case"logical_bitxor_expr":for(var _=t.pop(),s=0;s<e[r].PLACES-1;s++)_^=t.pop();t.push(_);break;case"logical_bitand_expr":for(var _=t.pop(),s=0;s<e[r].PLACES-1;s++)_&=t.pop();t.push(_);break;case"equal_expr":var o=t.pop(),i=t.pop();t.push(i==o);break;case"non_equal_expr":var o=t.pop(),i=t.pop();t.push(i!=o);break;case"le_expr":var o=t.pop(),i=t.pop();t.push(i<=o);break;case"ge_expr":var o=t.pop(),i=t.pop();t.push(i>=o);break;case"l_expr":var o=t.pop(),i=t.pop();t.push(i<o);break;case"g_expr":var o=t.pop(),i=t.pop();t.push(i>o);break;case"left_shift_expr":var i=t.pop(),o=t.pop();t.push(i<<o);break;case"right_shift_expr":var i=t.pop(),o=t.pop();t.push(i>>o);break;case"add_expr":var i=t.pop(),o=t.pop();t.push(i+o);break;case"sub_expr":var i=t.pop(),o=t.pop();t.push(i-o);break;case"mul_expr":var i=t.pop(),o=t.pop();t.push(i*o);break;case"div_expr":var i=t.pop(),o=t.pop();t.push(i/o);break;case"mod_expr":var i=t.pop(),o=t.pop();t.push(i%o);break;case"pre_inc_expr":case"post_inc_expr":l=t.pop(),t.push(++l);break;case"pre_dec_expr":case"post_dec_expr":l=t.pop(),t.push(--l);break;case"positive_expr":l=t.pop(),t.push(+l);break;case"negative_expr":l=t.pop(),t.push(-l);break;case"one_compl_expr":l=t.pop(),t.push(~l);break;case"logic_negative_expr":l=t.pop(),t.push(!l);break;default:z.panic("Unknown operation type: "+e[r].TYPE)}else{var l=e[r];if(/^[a-zA-Z_$][a-zA-Z_$0-9]*$/.test(l)){if(t.push(0),0!=l.indexOf("USE_NODE_")){var c=P[P.length-1];c in U||(U[c]=[]),-1==U[c].indexOf(l)&&(U[c].push(l),j.error("Undefined directive '"+l+"' in shader '"+c+"'. Should it be defined with #var/#node_var or #define?"))}}else t.push(parseFloat(e[r]))}if(1==t.length)return t[0];z.panic("Incorrect expression: "+e.join(" "))}function o(e){var t=e.FILE,r=A(W.shaders_path,W.shaders_include_dir+t);P.push("include/"+t),a(r),P.pop()}function i(e){var t=e.NAME,r=e.TOKENS;L[t]=r}function l(e){var t=e.TOKENS;z.panic("Shader error: #error "+t.join(" "))}function c(e){var t=e.NAME,r=e.TOKENS;S.push("#pragma "+t+" "+r.join(" "))}function u(e){var t=e.NAME;delete L[t]}function d(e){var t=e.TOKENS;j.warn("Shader warning: #warning "+t.join(" "))}function f(e){var t=N(e.TOKENS,L,C,!1);S.push("#extension "+t.join(" "))}function m(e){var t=N(e.TOKENS,L,C,!1);S.push("#version "+t.join(" "))}function p(e){F[e.NAME]=e}function h(e,t,r){if("PARTICLE_INFO"==e.id&&t.IS_OPTIONAL){if(1==L.PARTICLE_BATCH){var a=!1;switch(r){case 0:a=D(e.dirs,"PART_INFO_IND")||D(e.dirs,"PART_INFO_AGE")||D(e.dirs,"PART_INFO_LT")||D(e.dirs,"PART_INFO_SIZE");break;case 1:a=D(e.dirs,"PART_INFO_LOC");break;case 2:a=D(e.dirs,"PART_INFO_VEL");break;case 3:a=D(e.dirs,"PART_INFO_A_VEL");break;case 4:a=D(e.dirs,"PART_INFO_IND")}return a}return!1}return!0}function v(t){for(var r=0;r<t.length;r++){var a=t[r],n=F[a.id];if(n)for(var _=0,s=0;s<n.DECLARATIONS.length;s++){var o=n.DECLARATIONS[s];if("node_param"==o.TYPE){if(h(a,o,_)){var i=o.QUALIFIER.join(" ")+" ";"vert"==e?i+=a.vparams[_]:"frag"==e&&(i+=a.params[_],null!==a.param_values[_]&&(i+="="+a.param_values[_])),R(x(i+=";"))}_++}}}}function b(e,t){for(var r=P[P.length-1],a=g(e),n=0;n<t.dirs.length;n++){var _=t.dirs[n][0];_ in a?a[_]=[t.dirs[n][1]]:q&&j.error("Incompatible node directive '"+_+"' was set for node "+t.id+" in shader "+r+".")}for(var s=0,n=0;n<e.DECLARATIONS.length;n++){var o=e.DECLARATIONS[n];if("node_out"==o.TYPE){var i=t.outputs[s],l=B.indexOf(i)>-1|0;a["USE_OUT_"+o.NAME]=[l],s++}}return a}function g(e){for(var t={},r=0;r<e.NODE_VARS.length;r++){var a=e.NODE_VARS[r];t[a.NAME]=[a.TOKENS.join("")]}return t}function y(e){for(var t=0;t<e.length;t++){var r=e[t],a=F[r.id];if(a){var n={};X=0,K=0,Z=0;var _=b(a,r);E(r,a.DECLARATIONS,n,_),S.push("{"),w(r,a.STATEMENTS,n,_),S.push("}")}}}function E(t,r,a,n){for(var _=0;_<r.length;_++){var s=r[_];switch(s.TYPE){case"node_in":if(i=t.inputs[X],null!==t.input_values[X]){if(("MATERIAL_BEGIN"==t.id&&3===X||!n.MATERIAL_EXT&&("MATERIAL_BEGIN"==t.id&&4===X||"MATERIAL_END"==t.id&&3===X||"MATERIAL_END"==t.id&&4===X||"MATERIAL_END"==t.id&&5===X)||"TEXTURE_COLOR"==t.id||"TEXTURE_NORMAL"==t.id)&&s.IS_OPTIONAL){a[s.NAME]=t.input_values[X],X++;continue}o=s.QUALIFIER.join(" ")+" ",R(x(o+=i+"="+t.input_values[X]+";"))}a[s.NAME]=i,X++;break;case"node_out":if(i=t.outputs[K],!s.IS_OPTIONAL||B.indexOf(i)>-1){var o=s.QUALIFIER.join(" ")+" ";R(x(o+=i+";")),a[s.NAME]=i}K++;break;case"node_param":if("vert"==e)i=t.vparams[Z];else if("frag"==e)var i=t.params[Z];a[s.NAME]=i,Z++}}return a}function w(e,t,r,a){for(var n=0;n<t.length;n++){var _=t[n];switch(_.TYPE){case"node_cond":T(e,_.PARTS,r,a);break;case"txt":for(var s=[],o=0;o<_.TOKENS.length;o++){var i=_.TOKENS[o];i in r?s.push(r[i]):s.push(i)}R(s,a)}}}function T(e,t,r,a){for(var n=0;n<t.length;n++){var s=t[n];switch(s.TYPE){case"node_if":case"node_elif":if(_(s.EXPRESSION,a))return void w(e,s.STATEMENTS,r,a);break;case"node_else":return void w(e,s.STATEMENTS,r,a);case"node_ifdef":(s.NAME in L||s.NAME in a)&&w(e,s.STATEMENTS,r,a);break;case"node_ifndef":s.NAME in L||s.NAME in a||w(e,s.STATEMENTS,r,a)}}}function x(e){return e.match(/([\d]+\.[\d]+|[\w]+|[^\s])/g)}function R(t,r){if((t=k(t,e)).length){var a=N(t,L,C,!1,r);S.push(a.join(" "))}}function k(e,t){if(!Y.webgl2&&"frag"==t){var r=e.join(" ");V&&(r.match(/[^;]*;/)?(r=r.replace(/[^;]*;/,""),V=!1):r=""),(r=r.replace(/GLSL_OUT [^;]*;/g,"")).match(/GLSL_OUT(?:$| [^;]*)/)&&(r=r.replace(/GLSL_OUT(?:$| [^;]*)/,""),V=!0),e=(r=(r=r.replace(/ {2,}/g," ")).trim())?r.split(" "):[]}return e}function N(e,t,r,a,n){var _=[];return M(e,t,r,a,_,n),_}function M(e,t,r,a,n,_){for(var s=0;s<e.length;s++){var o=e[s];if(_&&o in _)i=_[o];else{if(!(o in t)){n.push(o);continue}var i=t[o]}0==i.length&&a?n.push(0):M(i,t,r,a,n,_)}}var I=r.node_elements,S=[],L=O(e,r),C={},P=[r[e]],U={},F={},B=[];for(var G in I)for(var H in I[G].inputs)B.push(I[G].inputs[H]);var V=!1;a(t);var X=0,K=0,Z=0;return S.join("\n")}function N(e,t,r,n,_){var s=S(e,n,t,e.VERTEX_SHADER,_),o=S(e,n,r,e.FRAGMENT_SHADER,_),i=e.createProgram();e.attachShader(i,s),e.attachShader(i,o),e.linkProgram(i);for(var l={vshader:s,fshader:o,program:i,attributes:{},uniforms:{},permanent_uniform_setters:z.create_non_smi_array(),permanent_sc_uniform_setters:z.create_non_smi_array(),permanent_uniform_setters_table:{},need_uniforms_update:!0,no_permanent_uniforms:!1,transient_uniform_setters:z.create_non_smi_array(),transient_sc_uniform_setters:z.create_non_smi_array(),shaders_info:a(_),shader_id:n,has_discard:M(r),cleanup_gl_data_on_unload:!0},c=e.getProgramParameter(i,e.ACTIVE_ATTRIBUTES),u=0;u<c;u++){var d=e.getActiveAttrib(i,u).name,f=e.getAttribLocation(i,d);l.attributes[d]=f}for(var m=e.getProgramParameter(i,e.ACTIVE_UNIFORMS),u=0;u<m;u++){var p=e.getActiveUniform(i,u).name.split("[0]").join(""),h=e.getUniformLocation(i,p);l.uniforms[p]=h}return l}function M(e){return Boolean(e.match(ue))}function I(e,t,r,a){if(r==ye.VERTEX_SHADER)n=a.vert;else var n=a.frag;var _=z.hash_code_string(t,0),s=ge[_];s?s.count++:(s={count:1,shader_filename:n,hc:_},ge[_]=s)}function S(e,t,r,a,n){J&&I(t,r,a,n);var _=e.createShader(a);return e.shaderSource(_,r),e.compileShader(_),_}function L(e){ye.deleteProgram(e.program),ye.deleteShader(e.vshader),ye.deleteShader(e.fshader),delete V[e.shader_id]}function C(e,t){switch(!t&&e.length?t=e.length:t||(t=1),t){case 1:return P(e);case 2:return"vec2("+P(e[0])+","+P(e[1])+")";case 3:return"vec3("+P(e[0])+","+P(e[1])+","+P(e[2])+")";case 4:return"vec4("+P(e[0])+","+P(e[1])+","+P(e[2])+","+P(e[3])+")";case 9:return"mat3("+P(e[0])+","+P(e[1])+","+P(e[2])+","+P(e[3])+","+P(e[4])+","+P(e[5])+","+P(e[6])+","+P(e[7])+","+P(e[8])+")";case 16:return"mat4("+P(e[0])+","+P(e[1])+","+P(e[2])+","+P(e[3])+","+P(e[4])+","+P(e[5])+","+P(e[6])+","+P(e[7])+","+P(e[8])+","+P(e[9])+","+P(e[10])+","+P(e[11])+","+P(e[12])+","+P(e[13])+","+P(e[14])+","+P(e[15])+")";default:z.panic("Wrong glsl value dimension")}}function P(e){return e%1?String(e):String(e)+".0"}function D(e,t){for(var r=0;r<e.length;r++)if(e[r][0]==t)return!0;return!1}var U=F(e),B=g(e),G=ae(e),j=m(e),z=h(e),Y=B.defaults,H=B.context_limits,W=B.paths,q=!1,V={},X={},K=null,Z={},Q=["anchors.glslf","anchors.glslv","color_id.glslf","color_id.glslv","shadow.glslf","shadow.glslv","error.glslf","error.glslv","grass_map.glslf","grass_map.glslv","halo.glslf","halo.glslv","line.glslf","line.glslv","main.glslf","main.glslv","main_stack.glslf","particle_system.glslf","particle_system_stack.glslf","particle_system.glslv","proc_skybox.glslf","skybox.glslv","lens_flares.glslf","lens_flares.glslv","sky.glslf","sky.glslv","water.glslf","water.glslv","tex_skybox.glslf","debug_view.glslf","debug_view.glslv","node_skybox.glslf","irradiance_skybox.glslf","r_convolution_skybox.glslf","postprocessing/antialiasing.glslf","postprocessing/bloom_combine.glslf","postprocessing/coc.glslf","postprocessing/compositing.glslf","postprocessing/depth_pack.glslf","postprocessing/dof.glslf","postprocessing/glow.glslf","postprocessing/god_rays.glslf","postprocessing/god_rays.glslv","postprocessing/god_rays_combine.glslf","postprocessing/luminance.glslf","postprocessing/luminance_av.glslf","postprocessing/luminance_truncated.glslf","postprocessing/motion_blur.glslf","postprocessing/outline.glslf","postprocessing/performance.glslf","postprocessing/postprocessing.glslf","postprocessing/postprocessing.glslv","postprocessing/smaa.glslf","postprocessing/smaa.glslv","postprocessing/ssao.glslf","postprocessing/ssao_blur.glslf","postprocessing/stereo.glslf","postprocessing/precompute_brdf.glslf","include/blending.glslf","include/caustics.glslf","include/color_util.glslf","include/coverage.glslf","include/depth_fetch.glslf","include/dynamic_grass.glslv","include/environment.glslf","include/fog.glslf","include/fxaa.glslf","include/halo_color.glslf","include/lighting_nodes.glslf","include/math.glslv","include/mirror.glslf","include/nodes.glslf","include/nodes.glslv","include/pack.glslf","include/particles.glslv","include/particles_nodes.glslf","include/particles_nodes.glslv","include/precision_statement.glslf","include/procedural.glslf","include/refraction.glslf","include/scale_texcoord.glslv","include/shadow.glslf","include/shadow.glslv","include/skin.glslv","include/sky_blending.glslf","include/std.glsl","include/to_world.glslv","include/wind_bending.glslv"],J=!1,$=0,ee=1,te=2,re=4,ne=8,_e=16,se=32;t.VALID=$,t.INVALID_TEX_IMAGE_UNITS=ee,t.INVALID_F_UNIFORM_VECTORS=te,t.INVALID_V_UNIFORM_VECTORS=re,t.INVALID_VERTEX_ATTRIBS=ne,t.INVALID_VARYING_VECTORS=_e,t.COMPILATION_ERROR=se;var oe=/(?:^|[^a-zA-Z_])uniform.*?(sampler2D|samplerCube)(?=\s)(.*?\[\s*([0-9]*)\s*\])?/,ie=/(?:^|[^a-zA-Z_])(uniform)(?=\s)\s*(float|vec2|vec3|vec4|ivec2|ivec3|ivec4|bvec2|bvec3|bvec4|mat2|mat3|mat4|sampler2D|samplerCube)\s*(.*?\[\s*([0-9]*)\s*\])?/,le=/(?:^|[^a-zA-Z_])(in)(?=\s)\s*(float|vec2|vec3|vec4|mat2|mat3|mat4)\s*(.*?\[\s*([0-9]*)\s*\])?/,ce=/(?:^|[^a-zA-Z_])(varying)(?=\s)\s*(float|vec2|vec3|vec4|mat2|mat3|mat4)\s*(.*?\[\s*([0-9]*)\s*\])?/,ue=/(?:\W|^)discard(\W|$)/,de=15,fe=new Int16Array(2),me=null,pe=null,he=null,ve=0,be=0,ge=[],ye=null,Ee=!1;t.setup_context=function(e){ye=e},t.init_shaders_info=r,t.clone_shaders_info=a,t.set_directive=n,t.get_directive=_,t.set_default_directives=function(e){e.directives=z.clone_object_r(s(e.vert,e.frag)),n(e,"PRECISION",B.defaults.precision),"highp"==B.defaults.precision?n(e,"EPSILON",C(1e-6)):n(e,"EPSILON",C(1e-4)),n(e,"CONSTANTS_HACK",0|Y.shader_constants_hack),n(e,"SRGB",Y.srgb_type),n(e,"COMPARED_MODE",0|Y.compared_mode_depth)},t.get_vname=function(e){return e.vert},t.get_fname=function(e){return e.frag},t.get_compiled_shader=function(e){var t=JSON.stringify(e.vert)+JSON.stringify(e.frag)+JSON.stringify(e.directives)+JSON.stringify(e.node_elements),r=V[t];if(r)return r;var a=e.vert,n=e.frag,_=A(W.shaders_path,a),s=A(W.shaders_path,n);if(!_||!s)return null;var i=k("vert",_,e),l=k("frag",s,e);if(o(l,i,e),e.status===$){V[t]=r=N(ye,i,l,t,e);var c=!ye.getShaderParameter(r.fshader,ye.COMPILE_STATUS),u=!ye.getShaderParameter(r.vshader,ye.COMPILE_STATUS),d=!ye.getProgramParameter(r.program,ye.LINK_STATUS);c?G.report_shader_compiling_error(r.fshader,t,l):u?G.report_shader_compiling_error(r.vshader,t,i):d&&G.report_shader_linking_error(r.program,t,i,l),(c||u||d)&&(e.status|=se,r=null)}else r=null;return r},t.load_shaders=function(){if(Ee=!1,b4w.module_check("shader_texts"))Ee=!0;else{for(var e=[],t=U.AT_TEXT,r=0;r<Q.length;r++){var a=z.normpath_preserve_protocol(W.shaders_path+Q[r]);e.push({id:Q[r],type:t,url:a})}e.length?U.enqueue(e,function(e,t,r,a){x(t,e)},function(){Ee=!0}):j.error("Shaders have not been found.")}},t.check_shaders_loaded=function(){return Ee},t.debug_get_compilation_stats=function(){return ge},t.get_compiled_shaders=function(){return V},t.cleanup=function(){for(var e in V)L(V[e]);for(var t in X)delete X[t];for(var r in ge)delete ge[r];me=null,pe=null,he=null,Z={}},t.cleanup_shader=L,t.debug_shaders_info=function(e){var t=e.directives;j.log("Shader: "+e.vert+" "+e.frag+", "+String(t.length)+" directives: ");for(var r=0;r<t.length;r++)j.log("  "+t[r][0],t[r][1])},t.glsl_value=C,t.check_uniform=function(e,t){return t in e.uniforms},t.reset=function(){ye=null}}),G=o("__scenegraph",function(e,t){function r(e,t){var r=[];F.traverse_edges(e,function(t,a,n){var _=n;r.indexOf(_)>-1?F.replace_edge_attr(e,t,a,_,T(_)):r.push(_)}),F.traverse(e,function(e,a){for(var n=a,_=0;_<n.slinks_internal.length;_++){var s=n.slinks_internal[_];t||n.type!=z.MAIN_PLANE_REFLECT&&n.type!=z.MAIN_CUBE_REFLECT&&n.type!=z.MAIN_XRAY||(s.use_renderbuffer=!0),r.indexOf(s)>-1?n.slinks_internal[_]=T(s):r.push(s)}})}function a(e,t){F.traverse(e,function(r,a){a.type==z.ANTIALIASING&&F.traverse_inputs(e,r,function(e,t,r){var a=t;if(a.type==z.MOTION_BLUR)for(var n=0;n<a.slinks_internal.length;n++){var _=a.slinks_internal[n];_.min_filter=Y.TF_LINEAR,_.mag_filter=Y.TF_LINEAR}}),t||F.traverse_inputs(e,r,function(e,t,r){var a=r;"DEPTH"==a.from&&(a.use_renderbuffer=!0)})}),F.traverse(e,function(t,r){var a={};n(e,t,a);for(var _ in a){for(var s=a[_],o=s[0],i=0;i<s.length;i++)if(s[i].min_filter==Y.TF_LINEAR){o=s[i];break}for(var l=s[0],i=0;i<s.length;i++)if(s[i].mag_filter==Y.TF_LINEAR){l=s[i];break}for(var c=s[0],i=0;i<s.length;i++)if(!s[i].use_renderbuffer){c=s[i];break}for(i=0;i<s.length;i++)s[i].min_filter=o.min_filter,s[i].mag_filter=l.mag_filter,s[i].use_renderbuffer=c.use_renderbuffer}})}function n(e,t,r){F.traverse_inputs(e,t,function(t,a,_){var s=_;s.active&&s.from==s.to&&(r[s.from]=r[s.from]||[],-1==r[s.from].indexOf(s)&&r[s.from].push(s),n(e,t,r))}),F.traverse_outputs(e,t,function(e,t,a){var n=a;n.active&&(r[n.from]=r[n.from]||[],-1==r[n.from].indexOf(n)&&r[n.from].push(n))});var a=F.get_node_attr(e,t);if(a.type==z.MOTION_BLUR)for(var _=0;_<a.slinks_internal.length;_++){var s=a.slinks_internal[_];r[s.from].push(s)}}function _(e){var t=[z.MOTION_BLUR,z.SMAA_RESOLVE,z.SMAA_NEIGHBORHOOD_BLENDING,z.MAIN_PLANE_REFLECT,z.MAIN_CUBE_REFLECT,z.PERFORMANCE];q.webgl2||t.push(z.AVERAGE_LUMINANCE);var r=F.topsort(e),a=[];F.traverse(r,function(e,n){for(var _=n,u=0;u<_.slinks_internal.length;u++){var d=_.slinks_internal[u];t.indexOf(_.type)>-1&&(d.unique_texture=!0),f=c(a,d,s(d)),d.texture=f,_.textures_internal[u]=f}for(u=0;u<_.textures_internal.length;u++){var f=_.textures_internal[u];l(a,f)}F.traverse_outputs(r,e,function(n,l,u){var d=u;if(!d.texture){if(t.indexOf(_.type)>-1)d.unique_texture=!0;else{var f=o(r,e,d.from);if(f&&d.active&&!d.texture)return i(a,f),void(d.texture=f)}f=c(a,d,s(d)),d.texture=f}}),F.traverse_inputs(r,e,function(e,t,r){l(a,r.texture)}),F.traverse_outputs(r,e,function(e,t,r){var n=r;n.texture&&"NONE"==n.to&&l(a,n.texture)})})}function s(e){var t=e.to,r=e.active,a=e.texture;e.to="",e.active=!1,e.texture=null;var n=H.calc_variable_id(e,0);return e.to=t,e.active=r,e.texture=a,n}function o(e,t,r){var a=null;return F.traverse_inputs(e,t,function(e,t,n){var _=n;if(_.active&&_.from==_.to&&_.from==r&&_.texture)return a=_.texture,!0}),F.traverse_outputs(e,t,function(e,t,n){var _=n;if(_.active&&_.from==r&&_.texture)return a=_.texture,!0}),a}function i(e,t){for(var r=0;r<e.length;r++){var a=e[r];a.tex===t&&a.ref++}}function l(e,t){for(var r=0;r<e.length;r++){var a=e[r];a.tex===t&&a.ref&&a.ref--}}function c(e,t,r){if(t.parent_slink)return i(e,t.parent_slink.texture),t.parent_slink.texture;if(t.unique_texture)return u(t);for(var a=null,n=0;n<e.length;n++){var _=e[n];if(_.id==r&&0===_.ref){a=_;break}}if(!a||X||q.firefox_tex_reuse_hack){var s=u(t);return e.push({id:r,ref:1,tex:s}),s}return a.ref++,a.tex}function u(e){var t=e.size_mult_x*e.size,r=e.size_mult_y*e.size,a=e.use_comparison,n=e.use_mipmap;switch(e.from){case"COLOR":return e.use_renderbuffer?(_=Y.create_texture(e.multisample?Y.TT_RB_RGBA_MS:Y.TT_RB_RGBA,a,n),Y.resize(_,t,r)):(_=Y.create_texture(Y.TT_RGBA_INT,a,n),Y.resize(_,t,r),Y.set_filters(_,e.min_filter,e.mag_filter)),_;case"DEPTH":if(e.use_renderbuffer)_=Y.create_texture(e.multisample?Y.TT_RB_DEPTH_MS:Y.TT_RB_DEPTH,a,n),Y.resize(_,t,r);else{var _=Y.create_texture(Y.TT_DEPTH,a,n);Y.resize(_,t,r),Y.set_filters(_,e.min_filter,e.mag_filter)}return _;case"CUBEMAP":return _=Y.create_cubemap_texture(t,n);case"SCREEN":case"NONE":return null;default:H.panic("Wrong slink param: "+e.from)}}function d(e,t){var r=!1;F.traverse_edges(e,function(a,n,_){var s=_;if(s){var o=F.get_node_attr(e,a),i=F.get_node_attr(e,n);return t(s,!1,o,i)?(r=!0,!0):void 0}}),r||F.traverse(e,function(e,r){for(var a=r,n=0;n<a.slinks_internal.length;n++){var _=a.slinks_internal[n];if(t(_,!0,a,null))return!0}})}function f(e){F.traverse(e,function(t,r){if(r.type!=z.SINK){var a=r.camera;F.traverse_outputs(e,t,function(e,t,r){r.texture&&r.active&&r.texture&&(P.set_attachment(a,r.from,r.texture),r.from==r.to&&t.camera&&P.set_attachment(t.camera,r.from,r.texture))});for(var n=0;n<r.slinks_internal.length;n++){var _=r.slinks_internal[n];if(_.active&&_.from==_.to){var s=r.textures_internal[n];P.set_attachment(a,_.from,s)}}!a.color_attachment&&!a.depth_attachment||a.framebuffer||(a.framebuffer=G.render_target_create(a.color_attachment,a.depth_attachment))}}),F.traverse(e,function(t,r){if(r.type==z.RESOLVE||r.type==z.COPY){var a=k(e,r);r.camera.framebuffer_prev=a[0].camera.framebuffer}})}function m(e){var t=null,r=0;return F.traverse(e,function(e,a){if(a.type==W.subs_type){if(r==W.subs_number)return t=a,!0;r++}}),t}function p(e,t){var r=F.node_by_attr(e,t),a=z.create_subs_postprocessing("NONE"),n=F.append_node_attr(e,a),_=F.get_sink_nodes(e)[0];F.traverse_edges(e,function(t,r,a){r==_&&F.reconnect_edges(e,t,_,t,n)});var s=v(t,e);F.traverse_edges(e,function(n,_,o){if(n==r){if(s){var i=z.create_subs_resolve();F.append_node_attr(e,i);var l=w("COLOR","RESOLVE",1,1,1,!0,!0);l.multisample=!0,l.use_renderbuffer=!0;var c=w("DEPTH","RESOLVE",1,1,1,!0,!0);c.multisample=!0,c.use_renderbuffer=!0,F.append_edge_attr(e,t,i,l),F.append_edge_attr(e,t,i,c),t=i}return F.append_edge_attr(e,t,a,w(W.slink_type,"u_color",o.size,o.size_mult_x,o.size_mult_y,o.update_dim,o.apply_resolution_factors)),!0}}),F.append_edge(e,n,_,w("SCREEN","NONE",.5,.5,.5,!0,!0))}function v(e,t){var r=!1,a=F.node_by_attr(t,e);if(F.out_edge_count(t,a)){var n=F.get_out_edge(t,a,0),_=F.get_edge_attr(t,a,n,0);r="COLOR"==_.from&&"COLOR"==_.to||"DEPTH"==_.from&&"DEPTH"==_.to?v(F.get_node_attr(t,n),t):"RESOLVE"==_.to}return r}function b(e,t,r,a){var n=r.cameras,_=t.hmd_stereo_use,s=t.anaglyph_use,o=t.reflection_params.plane_refl_subs,i=t.reflection_params.plane_refl_subs_blend,l=F.get_node_id(e,a),c=a,u=F.subgraph_node_conn(e,l,F.BACKWARD_DIR),d=[],f=[],m=[];for(u=F.clone(u,function(t){var a;if(K.indexOf(t.type)>-1)f.push(t),a=t;else{if((a=z.clone_subs(t)).type==z.MAIN_PLANE_REFLECT)for(c=0;c<o.length;c++)if(o[c][0]==t){o[c]=[t,a],a.camera.reflection_plane=t.camera.reflection_plane,r.cameras.push(a.camera);break}if(t.type==z.MAIN_PLANE_REFLECT_BLEND){for(c=0;c<o.length;c++)if(i[c][0]==t){i[c]=[t,a],a.camera=o[c][1].camera;break}}else n.indexOf(t.camera)>-1&&(_?(P.make_stereo(t.camera,P.TYPE_HMD_LEFT),P.make_stereo(a.camera,P.TYPE_HMD_RIGHT),a.force_do_not_render=!0):(P.make_stereo(t.camera,P.TYPE_STEREO_LEFT),P.make_stereo(a.camera,P.TYPE_STEREO_RIGHT)),n.push(a.camera));var s=F.node_by_attr(e,t);if(F.traverse_inputs(e,s,function(e,t,r){K.indexOf(t.type)>-1&&d.push([t,a,r])}),t.type!==z.MOTION_BLUR)for(c=0;c<t.slinks_internal.length;c++)a.slinks_internal[c].parent_slink=t.slinks_internal[c];for(var l=!0,c=0;c<F.in_edge_count(e,s);c++){var u=F.get_in_edge(e,s,c),p=F.get_node_attr(e,u);-1==K.indexOf(p.type)&&(l=!1)}l&&m.push(a)}return a},function(e){var t=T(e,!0);return t.parent_slink=e,t}),I=0;I<f.length;I++)F.remove_node(u,F.node_by_attr(u,f[I]));F.cleanup_loose_edges(u);var p=z.create_subs_stereo(_,s),h=F.append_node_attr(e,p);if(q.ios_copy_tex_hack)var v=z.create_subs_postprocessing("NONE"),b=w("COLOR","u_color",1,1,1,!0,!0);else var v=z.create_subs_copy(),b=w("COLOR","COPY",1,1,1,!0,!0);b.min_filter=Y.TF_LINEAR,b.mag_filter=Y.TF_LINEAR,F.append_node_attr(e,v),F.append_edge_attr(e,c,v,b);var g=w("COLOR","u_sampler_left",1,1,1,!0,!0);if(g.unique_texture=!0,g.min_filter=Y.TF_LINEAR,g.mag_filter=Y.TF_LINEAR,F.append_edge_attr(e,v,p,g),!c.is_pp){if(q.ios_copy_tex_hack)var y=z.create_subs_postprocessing("NONE"),E=w("COLOR","u_color",1,1,1,!0,!0);else var y=z.create_subs_copy(),E=w("COLOR","COPY",1,1,1,!0,!0);F.append_node_attr(u,y),E.parent_slink=b;var A=F.get_sink_nodes(u)[0],x=F.get_node_attr(u,A);F.append_edge_attr(u,x,y,E)}var O=w("COLOR","u_sampler_right",1,1,1,!0,!0);for(c.is_pp&&(O.parent_slink=b),O.min_filter=Y.TF_LINEAR,O.mag_filter=Y.TF_LINEAR,F.append_subgraph(u,e,[F.get_sink_nodes(u)[0],h,O]),I=0;I<d.length;I++){var R=d[I][0],k=d[I][1],N=d[I][2];F.append_edge_attr(e,R,k,N)}for(var M=w("SCREEN","NONE",0,0,0,!1,!1),I=0;I<m.length;I++)F.append_edge_attr(e,v,m[I],M);return F.traverse_edges(e,function(t,r,a){F.get_node_attr(e,t).type===z.MOTION_BLUR&&(a.parent_slink=null)}),p}function y(e,t){e.texel_size_multiplier=t}function w(e,t,r,a,n,_,s){return{from:e,to:t,size:r,size_mult_x:a,size_mult_y:n,update_dim:_,apply_resolution_factors:s,active:!0,texture:null,multisample:!1,use_renderbuffer:!1,min_filter:Y.TF_NEAREST,mag_filter:Y.TF_NEAREST,unique_texture:!1,use_comparison:!1,use_mipmap:!1}}function T(e,t){var r=w(e.from,e.to,e.size,e.size_mult_x,e.size_mult_y,e.update_dim,e.apply_resolution_factors);return r.active=e.active,!t&&e.texture&&H.panic("Failed to clone slink with attached texture"),r.texture=e.texture,r.multisample=e.multisample,r.use_renderbuffer=e.use_renderbuffer,r.min_filter=e.min_filter,r.mag_filter=e.mag_filter,r.unique_texture=e.unique_texture,r.use_comparison=e.use_comparison,r.use_mipmap=e.use_mipmap,r}function x(e,t){for(var r=0,a=k(e,t),n=0,_=0;_<a.length;_++){var s=a[_];if(s.type==z.SHADOW_CAST){n++,t.p_light_matrix=t.p_light_matrix||new Array;var o=s.shadow_lamp_index>0?s.shadow_lamp_index:r;t.p_light_matrix[o]=s.camera.proj_matrix,r++}}t.v_light_ts&&t.v_light_r||(q.mac_os_shadow_hack?t.v_light_tsr=new Float32Array(9*n):(t.v_light_ts=new Float32Array(4*n),t.v_light_r=new Float32Array(4*n)))}function O(e,t,r){if(t.type==r)return!0;for(var a=N(e,t),n=0;n<a.length;n++)if(O(e,a[n],r))return!0;return!1}function R(e,t,r){if(t.type==r)return!0;for(var a=k(e,t),n=0;n<a.length;n++)if(R(e,a[n],r))return!0;return!1}function k(e,t){var r=F.node_by_attr(e,t);r==F.NULL_NODE&&H.panic("Subscene not in graph");for(var a=[],n=F.in_edge_count(e,r),_=0;_<n;_++){var s=F.get_in_edge(e,r,_);s!=r&&a.push(F.get_node_attr(e,s))}return a}function N(e,t){var r=F.node_by_attr(e,t);r==F.NULL_NODE&&H.panic("Subscene not in graph");for(var a=[],n=F.out_edge_count(e,r),_=0;_<n;_++){var s=F.get_out_edge(e,r,_);s!=r&&a.push(F.get_node_attr(e,s))}return a}function M(e){var t=[],r=[];return d(e,function(e,a,n,_){e.texture&&-1==t.indexOf(e.texture)&&(t.push(e.texture),r.push(e.texture,t.length-1))}),r}function I(e,t,r){var a=z.subs_label(t);if(t.camera){for(a+="\\n",s=0;s<r.length;s+=2){var n=t.camera.color_attachment;r[s]==n&&(Y.is_renderbuffer(n)?a+="CR"+r[s+1]+" ":a+="C"+r[s+1]+" ")}for(s=0;s<r.length;s+=2){var _=t.camera.depth_attachment;r[s]==_&&(Y.is_renderbuffer(_)?a+="DR"+r[s+1]:a+="D"+r[s+1])}}t.slinks_internal.length&&(a+="\\n-----\\n");for(var s=0;s<t.slinks_internal.length;s++)a+=L(t.slinks_internal[s],0,0,r);if(t.type==z.SINK)o="dotted";else if(t.enqueue)o="solid";else var o="dashed";return o+=",bold",String(e)+' [label="'+a+'" color="black" style="'+o+'"];\n'}function S(e,t,r,a){var n=L(r,0,0,a);if(r.active)_="solid";else var _="dotted";return String(e)+" -> "+String(t)+' [label="'+n+'" style="'+_+'"];\n'}function L(e,t,r,a){var n="";if(n+=e.from+"\\n",n+="NONE"!=e.to?e.to+"\\n":"",n+="(",e.update_dim){var _=e.size_mult_x,s=e.size_mult_y;Math.round(_)!=_&&(_=_.toFixed(2)),Math.round(s)!=s&&(s=s.toFixed(2)),n+=(1==_?"":_)+"Sx"+(1==s?"":s)+"S",n+=e.apply_resolution_factors?" FACT":" VIEW"}else{var _=e.size_mult_x,s=e.size_mult_y;n+=e.size*_+"x"+e.size*s}if("SCREEN"!=e.from){n+=" ",e.use_renderbuffer?n+="RR":n+=function(e){var t="";return e.min==Y.TF_LINEAR?t+="L":e.min==Y.TF_NEAREST&&(t+="N"),e.mag==Y.TF_LINEAR?t+="L":e.mag==Y.TF_NEAREST&&(t+="N"),t}({min:e.min_filter,mag:e.mag_filter});for(var o=0;o<a.length;o+=2)a[o]==e.texture&&(n+=" "+a[o+1])}return n+=")\\n"}var C=_e(e),P=ue(e),D=g(e),U=ae(e),F=E(e),G=te(e),j=B(e),z=A(e),Y=ee(e),H=h(e),W=D.debug_subs,q=D.defaults,V=D.scenes,X=!1,K=[z.GRASS_MAP,z.SHADOW_CAST,z.MAIN_CUBE_REFLECT,z.MAIN_CUBE_REFLECT_BLEND];t.check_slink_tex_conn=function(e){switch(e.to){case"COLOR":case"CUBEMAP":case"DEPTH":case"SCREEN":case"OFFSCREEN":case"RESOLVE":case"COPY":case"NONE":return!1;default:return!0}},t.traverse_slinks=d,t.create_rendering_graph=function(e,t,n,s){var o=F.create(),i=[],l=[],c=[],u=[],d=[],h=[],v=[],g=[],E=[],A=e.lamps_number,O=e.water_params,R=e.shore_smoothing,k=e.soft_particles,M=e.ssao,I=e.god_rays,S=e.reflection_params,L=e.materials_params,C=e.bloom_params,D=e.motion_blur,B=e.compositing,G=e.antialiasing,j=e.world_light_set,X=e.world_fog_set,K=e.shadow_params,Z=e.mb_params,Q=e.cc_params,J=e.god_rays_params,$=e.outline_params,ee=e.dof,te=e.depth_tex,re=e.refractions,ae=Boolean(s.length),ne=q.msaa_samples>1;q.reuse_depth_optimization=q.reuse_depth_optimization&&Boolean(K)&&!(ne&&M);var _e=q.reuse_depth_optimization,se=w("COLOR","COLOR",1,1,1,!0,!0),oe=w("DEPTH","DEPTH",1,1,1,!0,!0);if(ne){var ie=T(oe);se.multisample=!0,se.use_renderbuffer=!0,oe.multisample=!0,oe.use_renderbuffer=!0}var le=t.cameras[0];if(e.dynamic_grass)ce=z.create_subs_grass_map(),F.append_node_attr(o,ce),pe=V.grass_tex_size,ce.camera.width=pe,ce.camera.height=pe,ue=w("DEPTH","u_grass_map_depth",pe,1,1,!1,!1),q.webgl2||(ue.min_filter=Y.TF_LINEAR,ue.mag_filter=Y.TF_LINEAR),(de=w("COLOR","u_grass_map_color",pe,1,1,!1,!1)).min_filter=Y.TF_LINEAR,de.mag_filter=Y.TF_LINEAR;else var ce=null,ue=null,de=null;if(K)for(P.update_camera_shadows(le,K),Ze=0;Ze<K.lamp_types.length;Ze++)for(var fe=K.csm_num,me=0;me<fe;me++){ke=z.create_subs_shadow_cast(me,Ze,K,A),F.append_node_attr(o,ke),c.push(ke);var pe=K.csm_resolution,he=ke.camera;t.shadow_cameras.push(he),he.width=pe,he.height=pe,ke.clear_color=!0;var ve=Ze>0?Ze:me;if(q.rgba_fallback_shadows){var be=w("COLOR","u_shadow_map"+ve,pe,1,1,!1,!1);u.push(be);var ge=w("DEPTH","DEPTH",pe,1,1,!1,!1);ge.use_renderbuffer=!0,ke.slinks_internal.push(ge)}else Le=w("DEPTH","u_shadow_map"+ve,pe,1,1,!1,!1),q.compared_mode_depth&&(Le.min_filter=Y.TF_LINEAR,Le.mag_filter=Y.TF_LINEAR,Le.use_comparison=!0),u.push(Le),(U.check_depth_only_issue()||q.shadows_color_slink_hack)&&ke.slinks_internal.push(w("COLOR","COLOR",pe,1,1,!1,!1));ce&&(F.append_edge_attr(o,ce,ke,ue),F.append_edge_attr(o,ce,ke,de))}if(S&&S.num_cube_refl&&!ae)for(me=0;me<S.num_cube_refl;me++){for((he=P.create_camera(P.TYPE_PERSP)).width=e.cubemap_refl_size,he.height=e.cubemap_refl_size,P.set_frustum(he,Math.PI/2,.1,100),P.set_projection(he,!1),(Ae=z.create_subs_main(z.MAIN_CUBE_REFLECT,he,!1,O,A,X,j,null,e.sun_exist)).cube_view_matrices=H.generate_inv_cubemap_matrices(),Ze=0;Ze<6;Ze++)Ae.cube_cam_frustums.push(P.create_frustum_planes());if(F.append_node_attr(o,Ae),(Te=w("CUBEMAP","u_cube_reflection",e.cubemap_refl_size,1,1,!1,!1)).min_filter=Y.TF_LINEAR,Te.mag_filter=Y.TF_LINEAR,g.push(Te),!S.has_reflexible){var ye=w("CUBEMAP","u_sky_reflection",e.cubemap_refl_size,1,1,!1);ye.use_mipmap=!0,ye.min_filter=Y.TF_LINEAR_MIPMAP_LINEAR,ye.mag_filter=Y.TF_LINEAR,E.push(ye)}if(ce&&(F.append_edge_attr(o,ce,Ae,ue),F.append_edge_attr(o,ce,Ae,de)),S.has_blend_reflexible){(xe=z.create_subs_main(z.MAIN_CUBE_REFLECT_BLEND,he,!1,O,A,X,j,null,e.sun_exist)).cube_view_matrices=Ae.cube_view_matrices,xe.cube_cam_frustums=Ae.cube_cam_frustums,F.append_node_attr(o,xe);var Ee=w("DEPTH","DEPTH",e.cubemap_refl_size,1,1,!1,!1),we=w("COLOR","COLOR",e.cubemap_refl_size,1,1,!1,!1);F.append_edge_attr(o,Ae,xe,Ee),F.append_edge_attr(o,Ae,xe,we),v.push(xe),S.cube_refl_subs_blend.push(xe),ce&&(F.append_edge_attr(o,ce,xe,ue),F.append_edge_attr(o,ce,xe,de))}else Oe=w("DEPTH","DEPTH",e.cubemap_refl_size,1,1,!1,!1),Ae.slinks_internal.push(Oe),v.push(Ae);S.cube_refl_subs.push(Ae)}if(S&&S.refl_plane_objs.length>0&&!ae)for(Ze=0;Ze<S.refl_plane_objs.length;Ze++){(he=P.clone_camera(le,!0)).reflection_plane=new Float32Array(4),t.cameras.push(he);var Ae=z.create_subs_main(z.MAIN_PLANE_REFLECT,he,!1,O,A,X,j,null,e.sun_exist);F.append_node_attr(o,Ae);var Te=w("COLOR","u_plane_reflection",1,e.plane_refl_size,e.plane_refl_size,!0,!0);if(Te.min_filter=Y.TF_LINEAR,Te.mag_filter=Y.TF_LINEAR,h.push(Te),ce&&(F.append_edge_attr(o,ce,Ae,ue),F.append_edge_attr(o,ce,Ae,de)),S.has_blend_reflexible){var xe=z.create_subs_main(z.MAIN_PLANE_REFLECT_BLEND,he,!1,O,A,X,j,null,e.sun_exist);F.append_node_attr(o,xe),Ee=w("DEPTH","DEPTH",1,e.plane_refl_size,e.plane_refl_size,!0,!0),(we=w("COLOR","COLOR",1,e.plane_refl_size,e.plane_refl_size,!0,!0)).min_filter=Y.TF_NEAREST,we.mag_filter=Y.TF_NEAREST,F.append_edge_attr(o,Ae,xe,Ee),F.append_edge_attr(o,Ae,xe,we),S.plane_refl_subs_blend.push([xe]),d.push(xe),ce&&(F.append_edge_attr(o,ce,xe,ue),F.append_edge_attr(o,ce,xe,de))}else{var Oe=w("DEPTH","DEPTH",1,e.plane_refl_size,e.plane_refl_size,!0,!0);Ae.slinks_internal.push(Oe),d.push(Ae)}S.plane_refl_subs.push([Ae])}if(K){var Re=P.clone_camera(le,!0);for(t.cameras.push(Re),Ye=z.create_subs_shadow_receive(o,Re,A),F.append_node_attr(o,Ye),Ye.self_shadow_normal_offset=K.self_shadow_normal_offset,me=0;me<c.length;me++){var ke=c[me],Ne=u[me];F.append_edge_attr(o,ke,Ye,Ne)}if(_e){if(Le=w("DEPTH","DEPTH",1,1,1,!0,!0),ne){Le.multisample=!0,Le.use_renderbuffer=!0;var Me=z.create_subs_resolve();F.append_node_attr(o,Me);var Ie=w("COLOR","RESOLVE",1,1,1,!0,!0);Ie.multisample=!0,Ie.use_renderbuffer=!0;var Se=w("DEPTH","RESOLVE",1,1,1,!0,!0);Se.multisample=!0,Se.use_renderbuffer=!0,F.append_edge_attr(o,Ye,Me,Ie),F.append_edge_attr(o,Ye,Me,Se)}}else if(ne)Le=w("DEPTH","DEPTH",1,1,1,!0,!0);else if(q.rgba_fallback_shadows)(Le=w("DEPTH","DEPTH",1,1,1,!0,!0)).use_renderbuffer=!0;else var Le=oe;if(M){var Ce=w("COLOR","u_color",1,1,1,!0,!0),Pe=w("DEPTH","u_depth",1,1,1,!0,!0),De=P.clone_camera(le,!0);t.cameras.push(De);var Ue=e.ssao_params,Fe=z.create_subs_ssao(De,X,Ue);F.append_node_attr(o,Fe);var Be=w("COLOR","u_ssao_mask",1,1,1,!0,!0);F.append_edge_attr(o,Ye,Fe,Ce),F.append_edge_attr(o,Ye,Fe,Pe);var Ge=P.clone_camera(le,!0);t.cameras.push(Ge);var je=z.create_subs_ssao_blur(Ge,Ue);F.append_node_attr(o,je);var ze=w("COLOR","u_shadow_mask",1,1,1,!0,!0);F.append_edge_attr(o,Fe,je,Be),F.append_edge_attr(o,Ye,je,Pe)}ce&&(F.append_edge_attr(o,ce,Ye,ue),F.append_edge_attr(o,ce,Ye,de))}else var Ye=null;var He=z.create_subs_main(z.MAIN_OPAQUE,le,!_e,O,A,X,j,null,e.sun_exist);if(F.append_node_attr(o,He),K&&(_e?F.append_edge_attr(o,Ye,He,Le):Ye.slinks_internal.push(Le)),ne){var We=z.create_subs_resolve();F.append_node_attr(o,We),l.push(We);var qe=w("COLOR","RESOLVE",1,1,1,!0,!0);qe.multisample=!0,qe.use_renderbuffer=!0;var Ve=w("DEPTH","RESOLVE",1,1,1,!0,!0);Ve.multisample=!0,Ve.use_renderbuffer=!0,F.append_edge_attr(o,He,We,qe),F.append_edge_attr(o,He,We,Ve)}else l.push(He);if(Ye)if(Be)F.append_edge_attr(o,je,He,ze);else{var Xe=w("COLOR","u_shadow_mask",1,1,1,!0,!0);F.append_edge_attr(o,_e&&ne?Me:Ye,He,Xe)}if(ce&&(F.append_edge_attr(o,ce,He,ue),F.append_edge_attr(o,ce,He,de)),d.length)for(var Ke=d.length,Ze=0;Ze<Ke;Ze++)F.append_edge_attr(o,d[Ze],He,h[Ze]);if(v.length)for(Ze=0;Ze<v.length;Ze++)F.append_edge_attr(o,v[Ze],He,g[Ze]);if(i=l,l=[],!ae&&e.color_picking){var Qe=W.enabled&&(W.subs_type===z.COLOR_PICKING||W.subs_type===z.COLOR_PICKING_XRAY),he=P.clone_camera(le,!0);if(Qe||(he.width=he.height=1),t.cameras.push(he),tt=z.create_subs_color_picking(he,!1,A),F.append_node_attr(o,tt),e.xray){he=P.clone_camera(le,!0),Qe||(he.width=he.height=1),t.cameras.push(he);var Je=z.create_subs_color_picking(he,!0,A);F.append_node_attr(o,Je);var $e=w("COLOR","COLOR",1,1,1,Qe,!0);F.append_edge_attr(o,tt,Je,$e);var et=w("DEPTH","DEPTH",1,1,1,Qe,!0);F.append_edge_attr(o,tt,Je,et)}}else var tt=null;if(!L.refractions&&!re||ae)rt=null;else{if(ne)rt=We;else{if(q.ios_copy_tex_hack)var rt=z.create_subs_postprocessing("NONE"),at=w("COLOR","u_color",1,1,1,!0,!0);else var rt=z.create_subs_copy(),at=w("COLOR","COPY",1,1,1,!0,!0);F.append_node_attr(o,rt),F.append_edge_attr(o,i[0],rt,at)}var nt=w("COLOR","u_refractmap",1,1,1,!0,!0)}if(te&&(re||R||k)){var _t=P.clone_camera(le,!0);t.cameras.push(_t),it=z.create_subs_depth_pack(_t),F.append_node_attr(o,it);var st=w("DEPTH","u_depth",1,1,1,!0,!0);F.append_edge_attr(o,ne?We:He,it,st);var ot=w("COLOR","u_scene_depth",1,1,1,!0,!0);ot.min_filter=Y.TF_NEAREST,ot.mag_filter=Y.TF_NEAREST}else var it=null;var lt=function(r){var a=P.clone_camera(le,!0);t.cameras.push(a);var n=z.create_subs_main(r,a,!1,O,A,X,j,K,e.sun_exist);if(F.append_node_attr(o,n),r==z.MAIN_XRAY){var _=w("COLOR","COLOR",1,1,1,!0,!0);F.append_edge_attr(o,i[0],n,_);var s=w("DEPTH","DEPTH",1,1,1,!0,!0);n.slinks_internal.push(s)}else{if(ne&&i[0].type==z.RESOLVE)l=He;else var l=i[0];F.append_edge_attr(o,He,n,oe),F.append_edge_attr(o,l,n,se)}for(ce&&(F.append_edge_attr(o,ce,n,ue),F.append_edge_attr(o,ce,n,de)),b=0;b<c.length;b++){var f=c[b],m=u[b];F.append_edge_attr(o,f,n,m)}if(it&&F.append_edge_attr(o,it,n,ot),d.length)for(var p=d.length,b=0;b<p;b++)F.append_edge_attr(o,d[b],n,h[b]);if(v.length)for(b=0;b<v.length;b++)F.append_edge_attr(o,v[b],n,g[b]);return rt&&F.append_edge_attr(o,rt,n,nt),n};if(e.glow_over_blend&&(Et=lt(z.MAIN_BLEND),l.push(Et),i=l,l=[]),e.glow_materials){var ct=P.clone_camera(le,!0);t.cameras.push(ct);var ut=z.create_subs_main(z.MAIN_GLOW,ct,!1,O,A,X,j);if(F.append_node_attr(o,ut),it&&F.append_edge_attr(o,it,ut,ot),rt&&F.append_edge_attr(o,rt,ut,nt),ce&&(F.append_edge_attr(o,ce,ut,ue),F.append_edge_attr(o,ce,ut,de)),d.length)for(var Ke=d.length,Ze=0;Ze<Ke;Ze++)F.append_edge_attr(o,d[Ze],ut,h[Ze]);if(v.length)for(Ze=0;Ze<v.length;Ze++)F.append_edge_attr(o,v[Ze],ut,g[Ze]);e.glow_over_blend&&F.append_edge_attr(o,ut,Et,w("SCREEN","NONE",0,0,0,!1,!1)),F.append_edge_attr(o,ne?We:He,ut,ne?ie:oe),(rr=z.create_subs_postprocessing("X_GLOW_BLUR")).subtype="GLOW_MASK_SMALL",y(rr,e.glow_params.small_glow_mask_width),(ar=w("COLOR","u_color",1,1,1,!0,!0)).min_filter=Y.TF_LINEAR,ar.mag_filter=Y.TF_LINEAR,F.append_node_attr(o,rr),F.append_edge_attr(o,ut,rr,ar),(or=z.create_subs_postprocessing("Y_GLOW_BLUR")).subtype="GLOW_MASK_SMALL",y(or,e.glow_params.small_glow_mask_width),(nr=w("COLOR","u_color",1,.5,.5,!0,!0)).min_filter=Y.TF_LINEAR,nr.mag_filter=Y.TF_LINEAR,F.append_node_attr(o,or),F.append_edge_attr(o,rr,or,nr);var dt=z.create_subs_postprocessing("X_GLOW_BLUR");dt.subtype="GLOW_MASK_LARGE",y(dt,e.glow_params.large_glow_mask_width);var ft=w("COLOR","u_color",1,.5,.5,!0,!0);ft.min_filter=Y.TF_LINEAR,ft.mag_filter=Y.TF_LINEAR,F.append_node_attr(o,dt),F.append_edge_attr(o,or,dt,ft);var mt=z.create_subs_postprocessing("Y_GLOW_BLUR");mt.subtype="GLOW_MASK_LARGE",y(mt,e.glow_params.large_glow_mask_width);var pt=w("COLOR","u_color",1,.25,.25,!0,!0);pt.min_filter=Y.TF_LINEAR,pt.mag_filter=Y.TF_LINEAR,F.append_node_attr(o,mt),F.append_edge_attr(o,dt,mt,pt);var ht=P.clone_camera(le,!0);t.cameras.push(ht);var vt=z.create_subs_glow_combine(ht,e);F.append_node_attr(o,vt);var bt=w("COLOR","u_src_color",1,1,1,!0,!0);if(bt.min_filter=Y.TF_LINEAR,bt.mag_filter=Y.TF_LINEAR,e.glow_over_blend)if(ne){var gt=z.create_subs_resolve();F.append_node_attr(o,gt),F.append_edge_attr(o,Et,gt,qe),F.append_edge_attr(o,Et,gt,Ve),F.append_edge_attr(o,gt,vt,bt)}else F.append_edge_attr(o,Et,vt,bt);else F.append_edge_attr(o,ne?We:He,vt,bt);(lr=w("COLOR","u_glow_mask_small",1,.5,.5,!0,!0)).min_filter=Y.TF_LINEAR,lr.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,or,vt,lr);var yt=w("COLOR","u_glow_mask_large",1,.25,.25,!0,!0);yt.min_filter=Y.TF_LINEAR,yt.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,mt,vt,yt),i=[vt],l=[]}if(!e.glow_over_blend){var Et=lt(z.MAIN_BLEND);l.push(Et),i=l,l=[]}if(q.debug_view){he=P.clone_camera(le,!0),t.cameras.push(he);var wt=z.create_subs_debug_view(he);l.push(wt),F.append_node_attr(o,wt),F.append_edge_attr(o,i[0],wt,se),F.append_edge_attr(o,i[0],wt,oe),ce&&(F.append_edge_attr(o,ce,wt,ue),F.append_edge_attr(o,ce,wt,de)),U.set_debug_view_subs(wt),i=l,l=[]}if(ne){var At=z.create_subs_resolve();F.append_node_attr(o,At),l.push(At),F.append_edge_attr(o,i[0],At,qe),F.append_edge_attr(o,i[0],At,Ve),i=l,l=[]}var Tt=i.slice(0);if(!ae&&e.anchor_visibility){he=P.clone_camera(le,!0),t.cameras.push(he);var xt=z.create_subs_anchor_visibility(he);F.append_node_attr(o,xt),F.append_edge_attr(o,i[0],xt,ne?ie:oe)}if(I&&te&&!ae){var Ot=J.max_ray_length,Rt=J.intensity,kt=J.steps_per_pass,Nt=i[0],Mt=!!O,It=w("DEPTH","u_input",1,1,1,!0,!0),St=w("COLOR","u_input",1,.25,.25,!0,!0);St.min_filter=Y.TF_LINEAR,St.mag_filter=Y.TF_LINEAR;var Lt=Ot/kt,Ct=P.clone_camera(le,!0);t.cameras.push(Ct);var Pt=z.create_subs_god_rays(Ct,Mt,Ot,!0,Lt,A,kt);F.append_node_attr(o,Pt),F.append_edge_attr(o,Nt,Pt,It),Lt=Ot/kt*.5;var Dt=P.clone_camera(le,!0);t.cameras.push(Dt);var Ut=z.create_subs_god_rays(Dt,Mt,Ot,!1,Lt,A,kt);F.append_node_attr(o,Ut),F.append_edge_attr(o,Pt,Ut,St),Lt=Ot/kt*.25;var Ft=P.clone_camera(le,!0);t.cameras.push(Ft);var Bt=z.create_subs_god_rays(Ft,Mt,Ot,!1,Lt,A,kt);F.append_node_attr(o,Bt),F.append_edge_attr(o,Ut,Bt,St);var Gt=z.create_subs_god_rays_comb(Rt,A);l.push(Gt),F.append_node_attr(o,Gt),(Yt=w("COLOR","u_main",1,1,1,!0,!0)).min_filter=Y.TF_LINEAR,Yt.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,Nt,Gt,Yt);var jt=w("COLOR","u_god_rays",1,1,1,!0,!0);jt.min_filter=Y.TF_LINEAR,jt.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,Bt,Gt,jt),i=l,l=[]}if(C&&!ae){var Nt=i[0],zt=z.create_subs_luminance();F.append_node_attr(o,zt);var Yt=w("COLOR","u_input",1,1,1,!0,!0);Yt.min_filter=Y.TF_LINEAR,Yt.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,Nt,zt,Yt);var Ht=C.key,Wt=C.edge_lum,qt=P.clone_camera(le,!0);t.cameras.push(qt);var Vt=z.create_subs_luminance_truncated(Ht,Wt,A,qt);F.append_node_attr(o,Vt);var Xt=w("COLOR","u_luminance",1,.25,.25,!0,!0);if(Xt.min_filter=Y.TF_LINEAR,Xt.mag_filter=Y.TF_LINEAR,C.adaptive){var Kt=z.create_subs_av_luminance();F.append_node_attr(o,Kt),Kt.camera.width=1,Kt.camera.height=1;var Zt=w("COLOR","u_input",1,.25,.25,!0,!0);if(Zt.use_mipmap=!0,Zt.min_filter=Y.TF_LINEAR_MIPMAP_LINEAR,Zt.mag_filter=Y.TF_LINEAR,q.webgl2)Xt.use_mipmap=!0,Xt.min_filter=Y.TF_LINEAR_MIPMAP_LINEAR,F.append_edge_attr(o,zt,Kt,Zt);else{var Qt=z.create_resize_subs(),Jt=w("COLOR","u_color",1,.25,.25,!0,!0);F.append_node_attr(o,Qt),F.append_edge_attr(o,zt,Qt,Jt),F.append_edge_attr(o,Qt,Kt,Zt)}F.append_edge_attr(o,Kt,Vt,w("COLOR","u_average_lum",1,1,1,!1,!1)),Vt.adaptive_bloom=!0}else Vt.adaptive_bloom=!1,Vt.average_luminance=C.average_luminance;F.append_edge_attr(o,Nt,Vt,w("COLOR","u_main",1,1,1,!0,!0)),F.append_edge_attr(o,zt,Vt,Xt);for(var $t=Vt,er=1,tr=[],me=0;me<5;me++){var rr=z.create_subs_postprocessing("X_BLOOM_BLUR");y(rr,e.glow_params.small_glow_mask_width);var ar=w("COLOR","u_color",1,er,er,!0,!0);ar.min_filter=Y.TF_LINEAR,ar.mag_filter=Y.TF_LINEAR,F.append_node_attr(o,rr),F.append_edge_attr(o,$t,rr,ar),er/=2,y(or=z.create_subs_postprocessing("Y_BLOOM_BLUR"),e.glow_params.small_glow_mask_width);var nr=w("COLOR","u_color",1,er,er,!0,!0);nr.min_filter=Y.TF_LINEAR,nr.mag_filter=Y.TF_LINEAR,F.append_node_attr(o,or),F.append_edge_attr(o,rr,or,nr),$t=or,or.bloom_blur_scale=er,rr.bloom_blur_scale=er,tr.push(or,er)}var _r=C.blur,sr=z.create_subs_bloom_combine(_r,5);for(F.append_node_attr(o,sr),me=0;me<tr.length;me+=2){var or=tr[me],ir=tr[me+1],lr=w("COLOR","u_bloom_level_"+(me/2).toString(),1,ir,ir,!0,!0);lr.min_filter=Y.TF_LINEAR,lr.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,or,sr,lr)}F.append_edge_attr(o,Nt,sr,w("COLOR","u_main",1,1,1,!0,!0)),l.push(sr),i=l,l=[]}if(ee&&te&&!ae){var Nt=i[0],cr=P.clone_camera(le,!0);if(t.cameras.push(cr),n.dof_bokeh){var ur=w("COLOR","u_color",1,1,1,!0,!0);ur.min_filter=Y.TF_LINEAR,ur.mag_filter=Y.TF_LINEAR;var dr=w("DEPTH","u_depth",1,1,1,!0,!0),fr=w("COLOR","u_color",1,.5,.5,!0,!0);fr.min_filter=Y.TF_NEAREST,fr.mag_filter=Y.TF_NEAREST;var mr=w("COLOR","u_color",1,.5,.5,!0,!0);mr.min_filter=Y.TF_NEAREST,mr.mag_filter=Y.TF_NEAREST;var pr=w("COLOR","u_blurred1",1,.5,.5,!0,!0);pr.min_filter=Y.TF_LINEAR,pr.mag_filter=Y.TF_LINEAR;var hr=w("COLOR","u_blurred2",1,.5,.5,!0,!0);hr.min_filter=Y.TF_LINEAR,hr.mag_filter=Y.TF_LINEAR;var vr=Tt[0];if(n.dof_foreground_blur){var br=P.clone_camera(le,!0);t.cameras.push(br);var gr=z.create_subs_coc(br,"COC_FOREGROUND");br.dof_distance=n.dof_distance,br.dof_object=n.dof_object,br.dof_front_start=n.dof_front_start,br.dof_front_end=n.dof_front_end,br.dof_rear_start=n.dof_rear_start,br.dof_rear_end=n.dof_rear_end,br.dof_power=n.dof_power,br.dof_bokeh=n.dof_bokeh,br.dof_bokeh_intensity=n.dof_bokeh_intensity,br.dof_foreground_blur=n.dof_foreground_blur,br.dof_on=!0,F.append_node_attr(o,gr),F.append_edge_attr(o,Nt,gr,ur),F.append_edge_attr(o,vr,gr,dr);var yr=z.create_subs_postprocessing("X_ALPHA_BLUR");F.append_node_attr(o,yr),F.append_edge_attr(o,gr,yr,fr);var Er=z.create_subs_postprocessing("Y_ALPHA_BLUR");F.append_node_attr(o,Er),F.append_edge_attr(o,yr,Er,mr);var wr=P.clone_camera(le,!0),Ar=z.create_subs_coc(wr,"COC_COMBINE");t.cameras.push(wr),wr.dof_distance=n.dof_distance,wr.dof_object=n.dof_object,wr.dof_front_start=n.dof_front_start,wr.dof_front_end=n.dof_front_end,wr.dof_rear_start=n.dof_rear_start,wr.dof_rear_end=n.dof_rear_end,wr.dof_power=n.dof_power,wr.dof_bokeh=n.dof_bokeh,wr.dof_bokeh_intensity=n.dof_bokeh_intensity,wr.dof_foreground_blur=n.dof_foreground_blur,wr.dof_on=!0,F.append_node_attr(o,Ar),F.append_edge_attr(o,Nt,Ar,ur),F.append_edge_attr(o,vr,Ar,dr),F.append_edge_attr(o,Er,Ar,w("COLOR","u_coc_fg",1,.5,.5,!0,!0))}else wr=P.clone_camera(le,!0),t.cameras.push(wr),Ar=z.create_subs_coc(wr,"COC_ALL"),wr.dof_distance=n.dof_distance,wr.dof_object=n.dof_object,wr.dof_front_start=n.dof_front_start,wr.dof_front_end=n.dof_front_end,wr.dof_rear_start=n.dof_rear_start,wr.dof_rear_end=n.dof_rear_end,wr.dof_power=n.dof_power,wr.dof_bokeh=n.dof_bokeh,wr.dof_bokeh_intensity=n.dof_bokeh_intensity,wr.dof_foreground_blur=n.dof_foreground_blur,wr.dof_on=!0,F.append_node_attr(o,Ar),F.append_edge_attr(o,Nt,Ar,ur),F.append_edge_attr(o,vr,Ar,dr);(kr=z.create_subs_postprocessing("X_DOF_BLUR")).camera.dof_bokeh_intensity=n.dof_bokeh_intensity,F.append_node_attr(o,kr),F.append_edge_attr(o,Ar,kr,fr);var Tr=z.create_subs_postprocessing("Y_DOF_BLUR");Tr.camera.dof_bokeh_intensity=n.dof_bokeh_intensity,F.append_node_attr(o,Tr),F.append_edge_attr(o,kr,Tr,mr);var xr=z.create_subs_postprocessing("Y_DOF_BLUR");xr.camera.dof_bokeh_intensity=n.dof_bokeh_intensity,F.append_node_attr(o,xr),F.append_edge_attr(o,kr,xr,mr),Ir=z.create_subs_dof(cr),cr.dof_distance=n.dof_distance,cr.dof_object=n.dof_object,cr.dof_front_start=n.dof_front_start,cr.dof_front_end=n.dof_front_end,cr.dof_rear_start=n.dof_rear_start,cr.dof_rear_end=n.dof_rear_end,cr.dof_power=n.dof_power,cr.dof_bokeh=n.dof_bokeh,cr.dof_bokeh_intensity=n.dof_bokeh_intensity,cr.dof_foreground_blur=n.dof_foreground_blur,cr.dof_on=!0,l.push(Ir),F.append_node_attr(o,Ir),F.append_edge_attr(o,Nt,Ir,w("COLOR","u_sharp",1,1,1,!0,!0)),F.append_edge_attr(o,Tr,Ir,pr),F.append_edge_attr(o,xr,Ir,hr)}else{var Or=w("COLOR","u_color",1,1,1,!0,!0);Or.min_filter=Y.TF_LINEAR,Or.mag_filter=Y.TF_LINEAR;var Rr=w("COLOR","u_color",1,1,1,!0,!0);Rr.min_filter=Y.TF_LINEAR,Rr.mag_filter=Y.TF_LINEAR;var kr=z.create_subs_postprocessing("X_BLUR");F.append_node_attr(o,kr),F.append_edge_attr(o,Nt,kr,Or);var Nr=z.create_subs_postprocessing("Y_BLUR");F.append_node_attr(o,Nr),F.append_edge_attr(o,kr,Nr,Rr);var Mr=Tt[0],Ir=z.create_subs_dof(cr);cr.dof_distance=n.dof_distance,cr.dof_object=n.dof_object,cr.dof_front_start=n.dof_front_start,cr.dof_front_end=n.dof_front_end,cr.dof_rear_start=n.dof_rear_start,cr.dof_rear_end=n.dof_rear_end,cr.dof_power=n.dof_power,cr.dof_bokeh=n.dof_bokeh,cr.dof_bokeh_intensity=n.dof_bokeh_intensity,cr.dof_foreground_blur=n.dof_foreground_blur,cr.dof_on=!0,l.push(Ir),F.append_node_attr(o,Ir),F.append_edge_attr(o,Nt,Ir,w("COLOR","u_sharp",1,1,1,!0,!0)),F.append_edge_attr(o,Nr,Ir,w("COLOR","u_blurred",1,1,1,!0,!0)),F.append_edge_attr(o,Mr,Ir,w("DEPTH","u_depth",1,1,1,!0,!0))}i=l,l=[]}if(e.xray){var Sr=lt(z.MAIN_XRAY);l.push(Sr),i=l,l=[]}if(D&&!ae){var Lr=i[0],Cr=z.create_subs_motion_blur(Z.mb_decay_threshold,Z.mb_factor);l.push(Cr),F.append_node_attr(o,Cr);var Pr=w("COLOR","u_mb_tex_curr",1,1,1,!0,!0);F.append_edge_attr(o,Lr,Cr,Pr);var Dr=w("COLOR","u_mb_tex_accum",1,1,1,!0,!0);Cr.slinks_internal.push(Dr),i=l,l=[]}if(!ae&&e.outline){var Nt=i[0],Ur=P.clone_camera(le,!0);t.cameras.push(Ur);var Fr=z.create_subs_outline_mask(Ur,A);F.append_node_attr(o,Fr);var Br=z.create_subs_postprocessing("X_EXTEND"),Gr=w("COLOR","u_color",1,1,1,!0,!0),jr=w("COLOR","u_outline_mask",1,1,1,!0,!0);jr.min_filter=Y.TF_LINEAR,jr.mag_filter=Y.TF_LINEAR,Br.is_for_outline=!0,F.append_node_attr(o,Br),F.append_edge_attr(o,Fr,Br,Gr);var zr=w("COLOR","u_color",1,.5,.5,!0,!0);zr.min_filter=Y.TF_LINEAR,zr.mag_filter=Y.TF_LINEAR;var Yr=z.create_subs_postprocessing("Y_EXTEND");Yr.is_for_outline=!0,F.append_node_attr(o,Yr),F.append_edge_attr(o,Br,Yr,zr),(kr=z.create_subs_postprocessing("X_BLUR")).is_for_outline=!0,F.append_node_attr(o,kr),F.append_edge_attr(o,Yr,kr,zr);var Hr=w("COLOR","u_color",1,.25,.25,!0,!0);Hr.min_filter=Y.TF_LINEAR,Hr.mag_filter=Y.TF_LINEAR;var Wr=w("COLOR","u_outline_mask_blurred",1,.25,.25,!0,!0);Wr.min_filter=Y.TF_LINEAR,Wr.mag_filter=Y.TF_LINEAR,(Nr=z.create_subs_postprocessing("Y_BLUR")).is_for_outline=!0,F.append_node_attr(o,Nr),F.append_edge_attr(o,kr,Nr,Hr);var qr=z.create_subs_outline($);F.append_node_attr(o,qr);var Vr=w("COLOR","u_outline_src",1,1,1,!0,!0);Vr.min_filter=Y.TF_LINEAR,Vr.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,Nt,qr,Vr),F.append_edge_attr(o,Fr,qr,jr),F.append_edge_attr(o,Nr,qr,Wr),l.push(qr),i=l,l=[]}if(r(o,te),(e.anaglyph_use||e.hmd_stereo_use||e.sidebyside_use)&&!ae){var Xr=b(o,e,t,i[0]);l.push(Xr),i=l,l=[]}if(B&&!ae){var Nt=i[0],Kr=Q.brightness,Zr=Q.contrast,Qr=Q.exposure,Jr=Q.saturation,$r=z.create_subs_compositing(Kr,Zr,Qr,Jr),ea=w("COLOR","u_color",1,1,1,!0,!0);ea.min_filter=Y.TF_LINEAR,ea.mag_filter=Y.TF_LINEAR,(e.anaglyph_use||e.hmd_stereo_use||e.sidebyside_use)&&!ae&&(ea.unique_texture=!0),F.append_node_attr(o,$r),F.append_edge_attr(o,Nt,$r,ea),l.push($r),i=l,l=[]}if(!i[0].is_pp||i[0].type==z.MOTION_BLUR||i[0].type==z.RESOLVE){var ta=z.create_subs_postprocessing("NONE");F.append_node_attr(o,ta);var ra=w("COLOR","u_color",1,1,1,!0,!0);ra.min_filter=Y.TF_LINEAR,ra.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,i[0],ta,ra),l.push(ta),i=l,l=[]}if(G){if(Nt=i[0],q.smaa){var aa=w("COLOR","u_color",1,1,1,!0,!1);aa.min_filter=Y.TF_LINEAR,aa.mag_filter=Y.TF_LINEAR;var na=z.create_subs_smaa(z.SMAA_EDGE_DETECTION,e);F.append_node_attr(o,na),F.append_edge_attr(o,Nt,na,aa);var _a=z.create_subs_smaa(z.SMAA_BLENDING_WEIGHT_CALCULATION,e);F.append_node_attr(o,_a),F.append_edge_attr(o,na,_a,aa);var sa=w("COLOR","u_search_tex",1,1,1,!1,!1),oa=w("COLOR","u_area_tex",1,1,1,!1,!1);sa.min_filter=Y.TF_LINEAR,sa.mag_filter=Y.TF_LINEAR,oa.min_filter=Y.TF_LINEAR,oa.mag_filter=Y.TF_LINEAR,_a.slinks_internal.push(sa),_a.slinks_internal.push(oa);var ia=z.create_subs_smaa(z.SMAA_NEIGHBORHOOD_BLENDING,e);F.append_node_attr(o,ia),F.append_edge_attr(o,Nt,ia,aa);var la=w("COLOR","u_blend",1,1,1,!0,!1);la.min_filter=Y.TF_LINEAR,la.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,_a,ia,la),l.push(ia)}else{var ca=z.create_subs_aa(e);F.append_node_attr(o,ca);var ua=w("COLOR","u_color",1,1,1,!0,!1);ua.min_filter=Y.TF_LINEAR,ua.mag_filter=Y.TF_LINEAR,(e.anaglyph_use||e.hmd_stereo_use||e.sidebyside_use)&&!ae&&(ua.unique_texture=!0),F.append_edge_attr(o,Nt,ca,ua),l.push(ca)}i=l,l=[]}if(l.push(i[0]),tt&&(Je?l.push(Je):l.push(tt)),xt&&l.push(xt),pe=1,e.sky_params.render_sky){var da=e.sky_params,fa=e.world_light_set,ma=fa.sky_texture_param;pe=ma?ma.tex_size:pe;var pa=z.create_subs_sky(fa,A,da,pe);if(F.append_node_attr(o,pa),l.push(pa),E.length){var ha=z.create_subs_irradiance(A,pe);F.append_node_attr(o,ha),F.append_edge_attr(o,pa,ha,E[0]);var va=w("CUBEMAP","u_irradiance",e.cubemap_refl_size,1,1,!1);va.use_mipmap=!1,va.min_filter=Y.TF_LINEAR,va.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,ha,He,va),Et&&F.append_edge_attr(o,ha,Et,va),ut&&F.append_edge_attr(o,ha,ut,va),Sr&&F.append_edge_attr(o,ha,Sr,va),l.push(ha);var ba=z.create_subs_rougness_convolution(A);F.append_node_attr(o,ba),F.append_edge_attr(o,pa,ba,E[0]);var ga=w("CUBEMAP","u_cube_r_convolution",e.cubemap_refl_size,1,1,!1);ga.use_mipmap=!1,ga.min_filter=Y.TF_LINEAR_MIPMAP_LINEAR,ga.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,ba,He,ga),Et&&F.append_edge_attr(o,ba,Et,ga),ut&&F.append_edge_attr(o,ba,ut,ga),Sr&&F.append_edge_attr(o,ba,Sr,ga);var ya=z.create_subs_brdf();F.append_node_attr(o,ya);var Ea=w("COLOR","u_brdf",512,1,1,!1);Ea.min_filter=Y.TF_LINEAR,Ea.mag_filter=Y.TF_LINEAR,F.append_edge_attr(o,ya,He,Ea),Et&&F.append_edge_attr(o,ya,Et,Ea),ut&&F.append_edge_attr(o,ya,ut,Ea),Sr&&F.append_edge_attr(o,ya,Sr,Ea)}}var wa=z.create_subs_sink();for(F.append_node_attr(o,wa),me=0;me<l.length;me++){var Aa=l[me];switch(Aa.type){case z.COLOR_PICKING:case z.COLOR_PICKING_XRAY:F.append_edge_attr(o,Aa,wa,w("COLOR","NONE",1,1,1,Qe,!1)),F.append_edge_attr(o,Aa,wa,w("DEPTH","NONE",1,1,1,Qe,!1));break;case z.SKY:var Ta=w("CUBEMAP","u_sky",pe,1,1,!1);F.append_edge_attr(o,Aa,wa,Ta);break;case z.IRRADIANCE:var xa=w("CUBEMAP","u_irradiance",pe,1,1,!1);xa.use_mipmap=!0,xa.min_filter=Y.TF_NEAREST,xa.mag_filter=Y.TF_NEAREST,F.append_edge_attr(o,ha,wa,xa);break;case z.ANCHOR_VISIBILITY:var Oa=w("COLOR","NONE",1,1,1,!0,!1);F.append_edge_attr(o,Aa,wa,Oa);break;default:if(ae){var Ra=s[0],ka=w("COLOR","OFFSCREEN",1,1,1,!0,!0);for(ka.texture=Ra,F.append_edge_attr(o,l[me],wa,ka),Ze=1;Ze<s.length;Ze++){var Na=s[Ze],Ma=z.create_subs_postprocessing("NONE");F.append_node_attr(o,Ma);var Ia=w("COLOR","SCALE",1,1,1,!0,!0);F.append_edge_attr(o,l[me],Ma,Ia);var Sa=Na.source_size/Ra.source_size;(ka=w("COLOR","OFFSCREEN",1,Sa,Sa,!0,!0)).texture=Na,F.append_edge_attr(o,Ma,wa,ka)}}else F.append_edge_attr(o,l[me],wa,w("SCREEN","NONE",1,1,1,!0,!1))}}if(We&&!N(o,We).length&&(F.remove_node(o,F.node_by_attr(o,We)),F.cleanup_loose_edges(o)),r(o,te),a(o,te),W.enabled){var La=m(o);La&&p(o,La)}if(_(o),f(o),K&&F.traverse(o,function(e,t){t.type!=z.SHADOW_RECEIVE&&t.type!=z.MAIN_BLEND&&t.type!=z.MAIN_XRAY||x(o,t)}),!S.has_reflexible)for(me=0;me<g.length;me++)g[me].active=!1;return o},t.multiply_size_mult_by_graph=function(e,t,r){var a=[];F.traverse(e,function(t,r){if(-1==K.indexOf(r.type)&&r.slinks_internal.length&&O(e,r,z.STEREO))for(var n=0;n<r.slinks_internal.length;n++){var _=r.slinks_internal[n];-1==a.indexOf(_)&&a.push(_)}}),F.traverse_edges(e,function(t,r,n){var _=F.get_node_attr(e,t),s=F.get_node_attr(e,r);-1==K.indexOf(_.type)&&O(e,s,z.STEREO)&&-1==a.indexOf(n)&&a.push(n)});for(var n=0;n<a.length;n++)a[n].size_mult_x*=t,a[n].size_mult_y*=r},t.set_texel_size=function(e,t,r){var a=e.texel_size_multiplier;e.texel_size[0]=t*e.texel_mask[0]*a,e.texel_size[1]=r*e.texel_mask[1]*a},t.set_texel_size_mult=y,t.create_performance_graph=function(){var e=F.create(),t=z.create_subs_perf(),r=P.create_camera(P.TYPE_NONE);r.width=512,r.height=512,t.camera=r,F.append_node_attr(e,t),t.slinks_internal.push(w("COLOR","u_color",512,1,1,!1,!1));var a=z.create_subs_sink();return F.append_node_attr(e,a),F.append_edge_attr(e,t,a,w("COLOR","NONE",512,1,1,!1,!1)),_(e),f(e),e},t.find_on_screen=function(e){var t=null;return F.traverse(e,function(e,r){return!(!r.camera||null!==r.camera.framebuffer||(t=r,0))}),t},t.find_input=function(e,t,r){for(var a=k(e,t),n=0;n<a.length;n++)if(a[n].type==r)return a[n];return null},t.get_inputs_by_type=function(e,t,r){for(var a=k(e,t),n=[],_=0;_<a.length;_++)a[_].type==r&&n.push(a[_]);return n},t.has_lower_subs=O,t.has_upper_subs=R,t.get_inputs=k,t.get_outputs=N,t.find_subs=function(e,t){var r=null;return F.traverse(e,function(e,a){return a.type==t&&(r=a,!0)}),r},t.debug_convert_to_dot=function(e){var t="digraph scenegraph {\n";t+="    ",t+='size="11.7,16.5";\n',t+="    ",t+='ratio="fill";\n',t+="    ",t+='node [shape=box margin="0.25,0.055"];\n';var r=M(e);return F.traverse(e,function(e,a){t+="    ",t+=I(e,a,r)}),F.traverse_edges(e,function(e,a,n){t+="    ",t+=S(e,a,n,r)}),t+="}"},t.create_rendering_queue=function(e){for(var t=F.topsort_attr(e),r=[],a=0;a<t.length;a++){var n=t[a];n.enqueue&&r.push(n)}return r},t.connect_render_targets_batch=function(e,t,r,a){var n=F.node_by_attr(e,t);F.traverse_inputs(e,n,function(e,t,n){var _=n,s=t;if(_.active){switch(_.from){case"COLOR":case"CUBEMAP":o=s.camera.color_attachment;break;case"DEPTH":o=s.camera.depth_attachment;break;case"SCREEN":var o=null;break;case z.MAIN_CUBE_REFLECT:return;default:H.panic("Wrong slink")}switch(_.to){case"COLOR":case"CUBEMAP":case"DEPTH":case"NONE":case"SCREEN":case"OFFSCREEN":case"RESOLVE":case"COPY":case"u_cube_reflection":case"u_plane_reflection":break;default:if(!o){if(a)return;H.panic("Connection of SCREEN is forbidden")}o.w_renderbuffer&&H.panic("Batch texture can't use renderbuffer"),j.check_uniform(r.shader,_.to)&&(a?C.replace_texture(r,o,_.to):C.append_texture(r,o,_.to))}}});for(var _=0;_<t.slinks_internal.length;_++){var s=t.slinks_internal[_],o=t.textures_internal[_];switch(s.to){case"COLOR":case"CUBEMAP":case"DEPTH":case"NONE":case"SCREEN":case"OFFSCREEN":case"RESOLVE":case"COPY":break;default:o.w_renderbuffer&&H.panic("Batch texture can't use renderbuffer"),j.check_uniform(r.shader,s.to)&&(a?C.replace_texture(r,o,s.to):C.append_texture(r,o,s.to))}}}}),j=o("__scenes",function(e,t){function r(){return Qt||(Qt=a($t)),Qt}function a(e){for(var t=0;t<e.length;t++){var r=e[t];if(!r._render_to_textures||!r._render_to_textures.length)return r}return null}function n(){return Jt||Dt.panic("No active scene available"),Jt}function _(){return $t}function s(e,t,r){if(!o(e,t,r))return null;var a=e.b4w_shadow_settings,n={};a.csm_resolution>zt.max_texture_size?(n.csm_resolution=zt.max_texture_size,Rt.error("Shadow map texture has unsupported size. Changed to "+zt.max_texture_size+".")):n.csm_resolution=a.csm_resolution,jt.shadow_blur_samples=jt.shadow_blur_samples?jt.shadow_blur_samples:a.blur_samples,n.soft_shadows=a.soft_shadows;var _=jt.ssao&&e.b4w_enable_ssao,s=At.get_shadow_lamps(t,_);n.self_shadow_polygon_offset=a.self_shadow_polygon_offset,n.self_shadow_normal_offset=a.self_shadow_normal_offset,n.enable_csm=a.b4w_enable_csm&&1==s.length,a.b4w_enable_csm&&a.csm_num>1&&s.length>1&&Rt.warn("Disabling Cascaded Shadow Maps because of multiple shadow casting lamps."),n.lamp_types=[],n.spot_sizes=[],n.clip_start=[],n.clip_end=[];for(var i=0;i<s.length;i++)n.lamp_types.push(s[i].light.type),n.spot_sizes.push(s[i].light.spot_size),n.clip_start.push(s[i].light.clip_start),n.clip_end.push(s[i].light.clip_end),"SPOT"!=n.lamp_types[i]&&"POINT"!=n.lamp_types[i]||!n.enable_csm||(Rt.warn("Generating shadows for SPOT or POINT light. Disabling Cascaded Shadow Maps"),n.enable_csm=!1);return n.enable_csm?(n.csm_num=a.csm_num,n.csm_first_cascade_border=a.csm_first_cascade_border,n.first_cascade_blur_radius=a.first_cascade_blur_radius,n.csm_last_cascade_border=a.csm_last_cascade_border,n.last_cascade_blur_radius=a.last_cascade_blur_radius,n.fade_last_cascade=a.fade_last_cascade,n.blend_between_cascades=a.blend_between_cascades):(n.csm_num=1,n.csm_first_cascade_border=a.csm_first_cascade_border,n.first_cascade_blur_radius=a.first_cascade_blur_radius,n.csm_last_cascade_border=a.csm_last_cascade_border,n.last_cascade_blur_radius=a.last_cascade_blur_radius,n.fade_last_cascade=!1,n.blend_between_cascades=!1),n}function o(e,t,r){if(0==t.length)return!1;if(!jt.shadows)return!1;switch(e.b4w_render_shadows){case"OFF":return!1;case"ON":return!0}var a=!1,n=!1,_=jt.ssao&&e.b4w_enable_ssao;if(0==t.length&&!_)return!1;for(var s=0;s<r.length;s++){var o=r[s];if(o.b4w_shadow_cast&&(a=!0),o.b4w_shadow_receive&&(n=!0),(_||a)&&n)return!0}return!1}function u(e){for(var t=0;t<e.length;t++)if("SUN"==e[t].light.type)return!0;return!1}function f(e){if(!jt.shore_smoothing)return!1;for(var t=ze(e),r=0;r<t.length;r++){var a=t[r];if(a.water_settings.is_water&&a.water_settings.shore_smoothing)return!0}return!1}function p(e){for(var t=0;t<e.length;t++)for(var r=e[t].particle_systems,a=0;a<r.length;a++){var n=r[a].settings;if(At.check_obj_soft_particles_accessibility(e[t]._object,n))return!0}return!1}function y(e){for(var t=ze(e),r=[],a=0;a<t.length;a++){var n=t[a];if(n.water_settings.is_water){for(var _={},s=0;s<e.length;s++)for(var o=e[s],i=o._object.materials,l=0;l<i.length;l++)i[l]==n&&(_.water_level=o.location[2]);_.fog_color_density=new Float32Array(4),_.fog_color_density.set(n.water_settings.fog_color),_.fog_color_density[3]=n.water_settings.fog_density,n.water_settings.is_dynamic?(_.dynamic=!0,_.waves_height=n.water_settings.waves_height,_.waves_length=n.water_settings.waves_length,_.dst_noise_scale0=n.water_settings.dst_noise_scale0,_.dst_noise_scale1=n.water_settings.dst_noise_scale1,_.dst_noise_freq0=n.water_settings.dst_noise_freq0,_.dst_noise_freq1=n.water_settings.dst_noise_freq1,_.dir_min_shore_fac=n.water_settings.dir_min_shore_fac,_.dir_freq=n.water_settings.dir_freq,_.dir_noise_scale=n.water_settings.dir_noise_scale,_.dir_noise_freq=n.water_settings.dir_noise_freq,_.dir_min_noise_fac=n.water_settings.dir_min_noise_fac,_.dst_min_fac=n.water_settings.dst_min_fac,_.waves_hor_fac=n.water_settings.waves_hor_fac):(_.dynamic=!1,_.waves_height=0,_.waves_length=0),_.caustics=n.water_settings.enable_caust,_.caustic_scale=n.water_settings.caust_scale,_.caustic_brightness=n.water_settings.caust_brightness,_.caustic_speed=new Float32Array([.3,.7]),_.shoremap_image=null;for(var c=n.texture_slots,s=0;s<c.length;s++){var u=c[s].texture;if(!0===u.b4w_shore_dist_map&&"FILE"==u.image.source){_.shoremap_image=u.image,_.shoremap_tex_size=u.image.size[0],_.max_shore_dist=u.b4w_max_shore_dist;var d=u.b4w_shore_boundings;_.shoremap_center=[(d[0]+d[1])/2,(d[2]+d[3])/2],_.shoremap_size=[d[0]-d[1],d[2]-d[3]]}}r.push(_)}}if(r.length>0){if(!(_=r[0]).dynamic)for(a=0;a<r.length;a++)r[a].dynamic&&(_=r[a]);return _}return null}function w(e){for(var t={refractions:!1},r=ze(e),a=function(e){if(e)for(var r=e.nodes,n=0;n<r.length;n++){var _=r[n];"GROUP"==_.type&&_.node_group&&a(_.node_group.node_tree),"GROUP"==_.type&&"B4W_REFRACTION"==_.node_tree_name&&(t.refractions=!0),"BSDF_TRANSPARENT"==_.type&&(t.refractions=!0)}},n=0;n<r.length;n++){var _=r[n];_.is_refractive&&(t.refractions=!0),_.node_tree&&a(_.node_tree)}return t}function T(e){return e.cameras[0].type!=dt.TYPE_PERSP&&"ANAGLYPH"==jt.stereo?(Rt.warn("Anaglyph stereo is disabled for the non-perspective camera"),jt.stereo="NONE",!1):"ANAGLYPH"==jt.stereo}function x(e){return e.cameras[0].type!=dt.TYPE_PERSP&&"SIDEBYSIDE"==jt.stereo?(Rt.warn("Side-by-side stereo is disabled for the non-perspective camera"),jt.stereo="NONE",!1):"SIDEBYSIDE"==jt.stereo}function O(e){if("HMD"==jt.stereo){if(e.cameras[0].type!=dt.TYPE_PERSP)return Rt.warn("Head-mounted display stereo is disabled for the non-perspective camera"),jt.stereo="NONE",!1;if(!bt.can_use_device(bt.DEVICE_HMD))return Rt.warn("Head-mounted display stereo is disabled for the non-WebVR and non-mobile devices"),jt.stereo="NONE",!1}return"HMD"==jt.stereo}function R(e,t,r){if(!jt.reflections)return!1;switch(e.b4w_render_reflections){case"OFF":return!1}for(var a=[],n=0,_=!1,s=!1,o=0;o<t.length;o++){var i=t[o];if(i.render.reflective&&"CUBE"==i.render.reflection_type&&n++,i.reflective_objs.length){for(var l=null,c=0;c<a.length;c++)if(a[c]==i){l=c;break}null==l&&a.push(i)}}for(o=0;o<r.length;o++){var u=r[o];u.b4w_reflexible&&(_=!0),N(u)&&(s=!0)}return{refl_plane_objs:a,num_cube_refl:n,cube_refl_subs:[],cube_refl_subs_blend:[],plane_refl_subs:[],plane_refl_subs_blend:[],has_reflexible:_,has_blend_reflexible:s}}function N(e){if(e.b4w_reflexible){for(var t=e._object.materials,r=0;r<t.length;r++){var a=t[r].blend_mode;if("OPAQUE"!=a&&"CLIP"!=a&&"ALPHA_ANTIALIASING"!=a)return!0}return!1}}function M(e,t){var r=e.b4w_sky_settings,a={};return a.render_sky=r.render_sky||r.procedural_skydome,a.procedural_skydome=r.procedural_skydome,a.use_as_environment_lighting=r.use_as_environment_lighting,a.sky_color=r.color,a.rayleigh_brightness=r.rayleigh_brightness,a.mie_brightness=r.mie_brightness,a.spot_brightness=r.spot_brightness,a.scatter_strength=r.scatter_strength,a.rayleigh_strength=r.rayleigh_strength,a.mie_strength=r.mie_strength,a.rayleigh_collection_power=r.rayleigh_collection_power,a.mie_collection_power=r.mie_collection_power,a.mie_distribution=r.mie_distribution,a.reflexible=r.reflexible,a.reflexible_only=r.reflexible_only,!t&&r.procedural_skydome&&Rt.warn("There is no sun on the scene. Procedural sky will use a default sun position."),a}function P(e){var t={},r=e.b4w_ssao_settings;return t.radius_increase=r.radius_increase,t.hemisphere=r.hemisphere,t.blur_depth=r.blur_depth,t.blur_discard_value=r.blur_discard_value,t.influence=r.influence,t.dist_factor=r.dist_factor,t.samples=r.samples,t}function F(e){if(!jt.bloom||!e.b4w_enable_bloom)return null;var t={},r=e.b4w_bloom_settings;return t.blur=r.blur,t.edge_lum=r.edge_lum,t.key=r.key,t.adaptive=r.adaptive,t.average_luminance=r.average_luminance,t}function j(e){var t={},r=e.b4w_motion_blur_settings;return t.mb_decay_threshold=r.motion_blur_decay_threshold,t.mb_factor=r.motion_blur_factor,t}function z(e){var t={},r=e.b4w_color_correction_settings;return t.brightness=r.brightness,t.contrast=r.contrast,t.exposure=r.exposure,t.saturation=r.saturation,t}function Y(e){var t={},r=e.b4w_god_rays_settings;return t.intensity=r.intensity,t.max_ray_length=r.max_ray_length,t.steps_per_pass=r.steps_per_pass,t}function H(e){var t={};return t.outline_color=e.b4w_outline_color,t.outline_factor=e.b4w_outline_factor,t}function q(e){var t={},r=e.b4w_glow_settings;return t.small_glow_mask_coeff=r.small_glow_mask_coeff,t.large_glow_mask_coeff=r.large_glow_mask_coeff,t.small_glow_mask_width=r.small_glow_mask_width,t.large_glow_mask_width=r.large_glow_mask_width,t}function V(e,t){var r=e.light_settings,a={};if(a.environment_energy=r.environment_energy,a.use_environment_light=r.use_environment_light,a.environment_color=r.environment_color,a.horizon_color=e.horizon_color.slice(0),a.zenith_color=e.zenith_color.slice(0),a.use_sky_paper=e.use_sky_paper,a.use_sky_blend=e.use_sky_blend,a.use_sky_real=e.use_sky_real,a.sky_texture_slot=null,a.sky_texture_param=null,a.environment_texture_slot=null,a.ngraph_proxy_id="",t.render_sky&&e.use_nodes&&e.node_tree){var n=e.node_tree,_=e.uuid,s=e.name,o=yt.compose_ngraph_proxy(n,_,!1,e.name+"(World)",s,"MAIN",null);a.ngraph_proxy_id=o.id}var i=!0;if(a.use_environment_light&&"SKY_TEXTURE"==a.environment_color&&(!t.procedural_skydome||!t.use_as_environment_lighting)){for(var l=null,c=0;c<e.texture_slots.length;c++)if(e.texture_slots[c].texture.b4w_use_as_environment_lighting&&!e.texture_slots[c].texture.b4w_use_as_skydome){l=e.texture_slots[c];break}l?a.environment_texture_slot=l:i=!1}for(c=0;c<e.texture_slots.length;c++)if(e.texture_slots[c].texture.b4w_use_as_skydome){var u=e.texture_slots[c];if(u.texture.image){i=!0,a.sky_texture_slot=u;var d=Math.min(zt.max_cube_map_texture_size,Ct.calc_pot_size(u.texture.image.size[0]/3));a.sky_texture_param={tex_size:d,blend_factor:u.blend_factor,horizon_factor:u.horizon_factor,zenith_up_factor:u.zenith_up_factor,zenith_down_factor:u.zenith_down_factor,color:u.color,default_value:u.default_value,invert:u.invert,use_rgb_to_intensity:u.use_rgb_to_intensity,blend_type:u.blend_type,use_map_blend:u.use_map_blend,use_map_horizon:u.use_map_horizon,use_map_zenith_up:u.use_map_zenith_up,use_map_zenith_down:u.use_map_zenith_down}}break}return a.use_environment_light=!!a.use_environment_light&&i,a}function X(e){var t=e.fog_settings,r={};r.use_fog=t.use_fog,r.intensity=t.intensity,r.depth=t.depth,r.start=t.start,r.height=t.height,r.falloff=t.falloff,t.use_custom_color?r.color=t.color.slice(0):r.color=e.horizon_color.slice(0);var a=r.color,n=1/r.depth;return r.fog_color_density=new Float32Array([a[0],a[1],a[2],n]),r.fog_params=new Float32Array([r.intensity,r.depth,r.start,r.height]),r}function K(e,t){if(!jt.dynamic_grass)return!1;switch(e.b4w_render_dynamic_grass){case"OFF":return!1;case"ON":return!0}for(var r=!1,a=!1,n=0;n<t.length;n++){for(var _=t[n],s=_._object.materials,o=0;o<s.length;o++)s[o].terrain_settings.is_terrain&&(r=!0);for(var i=_.particle_systems,o=0;o<i.length;o++){var l=i[o].settings;"HAIR"==l.type&&l.b4w_dynamic_grass&&(a=!0)}if(r&&a)return!0}return!1}function Z(e,t){if(Yt.outlining_overview_mode)return!0;if(!jt.enable_selectable)return!1;switch(e.b4w_enable_object_selection){case"OFF":return!1;case"ON":return!0;case"AUTO":for(var r=0;r<t.length;r++)if(t[r]._object.render.selectable)return!0;return!1}}function Q(e,t){if(Yt.outlining_overview_mode)return!0;if(!jt.enable_outlining)return!1;switch(e.b4w_enable_outlining){case"OFF":return!1;case"ON":return!0;case"AUTO":for(var r=0;r<t.length;r++)if(t[r]._object.render.outlining)return!0;return!1}}function J(e,t){if(!jt.glow_materials)return!1;switch(e.b4w_enable_glow_materials){case"OFF":return!1;case"ON":return!0;case"AUTO":for(var r=0;r<t.length;r++)for(var a=t[r]._object.materials,n=0;n<a.length;n++)if(yt.check_material_glow_output(a[n]))return!0;return!1}}function re(e,t){if(!jt.refractions)return!1;switch(e.b4w_render_refractions){case"OFF":return!1;case"ON":return!0;case"AUTO":return t.refractions}}function se(e){for(var t=0;t<e.length;t++)for(var r=e[t]._object.materials,a=0;a<r.length;a++){var n=r[a];if(n.render_above_all&&"OPAQUE"!=n.blend_mode&&"CLIP"!=n.blend_mode&&"ALPHA_ANTIALIASING"!=n.blend_mode)return!0}return!1}function oe(e,t){switch(e.b4w_enable_anchors_visibility){case"OFF":return!1;case"ON":return!0;case"AUTO":for(var r=0;r<t.length;r++){var a=t[r]._object;if(a.anchor&&a.anchor.detect_visibility)return!0}return!1}}function ie(e,t){for(var r=Ve(e,[Lt.MAIN_OPAQUE,Lt.MAIN_BLEND,Lt.MAIN_GLOW]),a=0;a<r.length;a++)r[a].bsdf_cube_sky_dim=t}function le(e,t,r,a,n){switch(e.type){case Lt.MAIN_OPAQUE:de(e,t,r,"OPAQUE",a,n);break;case Lt.MAIN_BLEND:de(e,t,r,"BLEND",a,n);break;case Lt.MAIN_XRAY:de(e,t,r,"XRAY",a,n);break;case Lt.MAIN_GLOW:de(e,t,r,"GLOW",a,n);break;case Lt.MAIN_PLANE_REFLECT:case Lt.MAIN_CUBE_REFLECT:ye(e,t,r,!1,a,n);break;case Lt.MAIN_PLANE_REFLECT_BLEND:case Lt.MAIN_CUBE_REFLECT_BLEND:ye(e,t,r,!0,a,n);break;case Lt.SHADOW_RECEIVE:be(e,t,r,a,n);break;case Lt.SHADOW_CAST:ge(e,t,r,a,n);break;case Lt.COLOR_PICKING:case Lt.COLOR_PICKING_XRAY:ke(e,t,r,a,n);break;case Lt.OUTLINE_MASK:Ie(e,t,r,a,n);break;case Lt.GRASS_MAP:Me(e,t,a,n);break;case Lt.DEBUG_VIEW:Ne(e,t,r,a,n)}}function de(e,t,r,a,n,_){for(var s=t.render,o=At.get_scene_data(t,n),i=o.batches,l=0;l<i.length;l++){var c=i[l];if(!c.shadow_cast_only&&!c.reflexible_only&&("MAIN"==c.type||"NODES_GLOW"==c.type||"PARTICLES"==c.type||"LINE"==c.type)&&("OPAQUE"==c.subtype&&"OPAQUE"==a||"BLEND"==c.subtype&&"BLEND"==a||"XRAY"==c.subtype&&"XRAY"==a||"NODES_GLOW"==c.type&&"GLOW"==a)){if(!_&&(me(c,e,t,r,a,n),!ct.update_shader(c))){if("DEBUG"!==Bt.type())continue;ct.apply_shader(c,"error.glslv","error.glslf"),ct.update_shader(c)}var u=Lt.init_bundle(c,s,o.batch_world_bounds[l]);Lt.append_draw_data(e,u),Mt.connect_render_targets_batch(r,e,c,!1),he(c)}}}function fe(e){e.lod_settings.use_smoothing&&ct.set_batch_directive(e,"USE_LOD_SMOOTHING",1)}function me(e,t,r,a,n,_){var s=r.render,o=_._render,i=At.get_scene_data(r,_),l="NO_SHADOWS",c=Ve(_,[Lt.SHADOW_CAST]);if(c.length&&e.shadow_receive){switch(n){case"OPAQUE":l="SHADOW_MAPPING_OPAQUE";break;case"BLEND":case"XRAY":l="SHADOW_MAPPING_BLEND";break;case"COLOR_ID":case"REFLECT":case"GLOW":l="NO_SHADOWS";break;case"SHADOW":l="SHADOW_MASK_GENERATION";break;default:Dt.panic("Wrong subscene type")}for(y=0;y<c.length;y++)ct.assign_shadow_receive_dirs(e,_._render.shadow_params,c[y])}var u="NO_SOFT_SHADOWS";if(o.shadow_params&&o.shadow_params.soft_shadows)switch(jt.shadow_blur_samples){case"16x":u="POISSON_X_16";break;case"8x":u="POISSON_X_8";break;case"4x":u="POISSON_X_4"}var d=e.shaders_info;if(St.set_directive(d,"SHADOW_USAGE",l),St.set_directive(d,"POISSON_DISK_NUM",u),fe(e),e.dynamic_grass){var f=Mt.find_subs(a,Lt.GRASS_MAP);f&&ve(e,f,s)}if(pe(d,t.camera),"SHADOW"!=e.type&&"COLOR_ID"!=n||e.has_nodes){var m=t.num_lights;St.set_directive(d,"NUM_LIGHTS",m);var p=m%2==0?m/2:Math.floor(m/2)+1;St.set_directive(d,"NUM_LFACTORS",p),St.set_directive(d,"REFLECTION_PASS","REFL_PASS_NONE"),St.set_directive(d,"SSAO_ONLY",0);var h=o.water_params;if(h&&(St.set_directive(d,"WATER_EFFECTS",1),St.set_directive(d,"WAVES_HEIGHT",St.glsl_value(h.waves_height)),St.set_directive(d,"WAVES_LENGTH",St.glsl_value(h.waves_length)),St.set_directive(d,"WATER_LEVEL",St.glsl_value(h.water_level))),t.caustics&&e.caustics){St.set_directive(d,"CAUSTICS",1);var v=o.shadow_params;if(v){for(var b=v.lamp_types,g=0,y=0;y<b.length;y++)"SUN"==b[y]&&(g=y);St.set_directive(d,"SUN_NUM",g)}St.set_directive(d,"CAUST_SCALE",St.glsl_value(t.caust_scale)),St.set_directive(d,"CAUST_SPEED",St.glsl_value(t.caust_speed,2)),St.set_directive(d,"CAUST_BRIGHT",St.glsl_value(t.caust_brightness))}var E=i.cube_refl_subs,w=i.plane_refl_subs,A=Mt.find_subs(a,Lt.SKY);if(-1!==e.texture_names.indexOf("u_mirrormap"))St.set_directive(d,"REFLECTION_TYPE","REFL_MIRRORMAP");else if(e.reflective&&E)if(o.reflection_params.has_reflexible){var T=E.camera.color_attachment;ct.append_texture(e,T,"u_cube_reflection"),St.set_directive(d,"REFLECTION_TYPE","REFL_CUBE")}else{E.force_do_not_render=!0;var x=Mt.find_subs(a,Lt.IRRADIANCE),O=Mt.find_subs(a,Lt.ROUGHNESS_CONVOLUTION);if(x&&O){var R=x.camera.color_attachment;ct.append_texture(e,R,"u_cube_irradiance");var k=O.camera.color_attachment;ct.append_texture(e,k,"u_cube_r_convolution"),St.set_directive(d,"REFLECTION_TYPE","REFL_PBR")}else I=(A=Mt.find_subs(a,Lt.SKY))?A.camera.color_attachment:E.camera.color_attachment,ct.append_texture(e,I,"u_cube_reflection"),St.set_directive(d,"REFLECTION_TYPE","REFL_CUBE")}else if(e.reflective&&w)for(y=0;y<w.length;y++)I=w[y].camera.color_attachment,ct.append_texture(e,I,"u_plane_reflection"),St.set_directive(d,"REFLECTION_TYPE","REFL_PLANE");else St.set_directive(d,"REFLECTION_TYPE","REFL_NONE");A?e.draw_proc_sky?(I=A.camera.color_attachment,ct.append_texture(e,I,"u_sky")):A.procedural_skydome&&(e.cube_fog=A.cube_fog,St.set_directive(d,"PROCEDURAL_FOG",1)):St.set_directive(d,"PROCEDURAL_FOG",0);var N=o.world_light_set;if(N.use_environment_light)if(St.set_directive(d,"USE_ENVIRONMENT_LIGHT",1),"SKY_TEXTURE"==N.environment_color){if(N.environment_texture_slot){var M=N.environment_texture_slot.texture,I=Ct.get_batch_texture(N.environment_texture_slot);ct.append_texture(e,I,"u_sky_texture",M.name)}else A&&(I=A.camera.color_attachment,ct.append_texture(e,I,"u_sky_texture"));St.set_directive(d,"SKY_TEXTURE",1)}else"SKY_COLOR"==N.environment_color&&St.set_directive(d,"SKY_COLOR",1);var S=o.world_fog_set;if(S.use_fog&&(St.set_directive(d,"USE_FOG",1),St.set_directive(d,"FOG_TYPE",S.falloff)),e.refractive&&e.blend?(jt.depth_tex_available&&St.set_directive(d,"USE_REFRACTION_CORRECTION",1),"MAIN"==e.type&&e.has_nodes||"NODES_GLOW"==e.type?(St.set_directive(d,"REFRACTIVE",1),o.refractions?St.set_directive(d,"USE_REFRACTION",1):St.set_directive(d,"USE_REFRACTION",0)):o.refractions?St.set_directive(d,"REFRACTIVE",1):St.set_directive(d,"REFRACTIVE",0),(o.materials_params.refractions||o.refractions)&&St.set_directive(d,"HAS_REFRACT_TEXTURE",1)):(St.set_directive(d,"REFRACTIVE",0),St.set_directive(d,"USE_REFRACTION",0),St.set_directive(d,"USE_REFRACTION_CORRECTION",0)),e.water&&(jt.shore_smoothing&&e.water_shore_smoothing&&Mt.find_subs(a,Lt.DEPTH_PACK)?St.set_directive(d,"SHORE_SMOOTHING",1):St.set_directive(d,"SHORE_SMOOTHING",0),e.water_dynamic&&h&&h.waves_height?St.set_directive(d,"DYNAMIC",1):St.set_directive(d,"DYNAMIC",0)),"PARTICLES"==e.type&&St.set_directive(d,"COLOR_RAMP_LENGTH",e.particles_data.color_ramp_length),!e.forked_batch)for(var L=e.textures,C=0;C<L.length;C++)if("SCENE"==(I=L[C]).source)for(var P=0;P<$t.length;P++)for(var D=$t[P],U=$t[P]._render_to_textures,F=0;F<U.length;F++)U[F]==I&&ht.append_edge_attr(er,D,_,null)}}function pe(e,t){t.type==dt.TYPE_ORTHO||t.type==dt.TYPE_ORTHO_ASPECT||t.type==dt.TYPE_ORTHO_ASYMMETRIC?St.set_directive(e,"CAMERA_TYPE","CAM_TYPE_ORTHO"):St.set_directive(e,"CAMERA_TYPE","CAM_TYPE_PERSP")}function he(e){e.textures.length>Zt&&Rt.warn(e.type,"too many textures used - "+e.textures.length+" (max "+Zt+'), materials "'+e.material_names.join(", ")+'"')}function ve(e,t,r){e.grass_map_dim=t.grass_map_dim;var a=t.grass_map_dim[0],n=t.grass_map_dim[1],_=t.grass_map_dim[2],s=r.bb_local,o=Math.max(s.max_x-s.min_x,s.max_y-s.min_y);_=0==_?o:Math.max(_,o),t.grass_map_dim[2]=_;var i=t.camera;dt.set_frustum2(i,_/2,_/2,-n,-a),dt.set_projection(i,!1);var l=e.grass_size||0;l=0==l?o:Math.max(l,o),e.grass_size=l}function be(e,t,r,a,n){for(var _=At.get_scene_data(t,a),s=_.batches,o=0;o<s.length;o++){var i=s[o];if("SHADOW"==i.type&&"RECEIVE"==i.subtype&&i.shadow_receive&&(n||(me(i,e,t,r,"SHADOW",a),ct.update_shader(i)))){var l=Lt.init_bundle(i,t.render,_.batch_world_bounds[o]);Lt.append_draw_data(e,l),Mt.connect_render_targets_batch(r,e,i,!1),he(i)}}}function ge(e,t,r,a,n){for(var _=!1,s=t.render,o=At.get_scene_data(t,a),i=o.batches,l=Mt.find_subs(r,Lt.GRASS_MAP),c=0;c<i.length;c++){var u=i[c];if("SHADOW"==u.type&&"CAST"==u.subtype){if(_=!0,!n){fe(u);var d=e.num_lights;ct.set_batch_directive(u,"NUM_LIGHTS",d);var f=d%2==0?d/2:Math.floor(d/2)+1;if(ct.set_batch_directive(u,"NUM_LFACTORS",f),pe(u.shaders_info,e.camera),St.set_directive(u.shaders_info,"SHADOW_USAGE","SHADOW_CASTING"),u.dynamic_grass&&l&&ve(u,l,s),ct.set_batch_directive(u,"SHADOW_TEX_RES",St.glsl_value(a._render.shadow_params.csm_resolution)),!ct.update_shader(u))continue}u.dynamic_grass&&(a._render.shadow_params.dynamic_grass_cast=!0);var m=Lt.init_bundle(u,s,o.batch_world_bounds[c]);Lt.append_draw_data(e,m),Mt.connect_render_targets_batch(r,e,u,!1),he(u)}}if(_){var p=a._render.shadow_params;Ae(e,a,Mt.find_subs(r,Lt.MAIN_OPAQUE).camera,p,!0)}}function ye(e,t,r,a,n,_){for(var s=t.render,o=At.get_scene_data(t,n),i=o.batches,l=0;l<i.length;l++){var c=i[l];if(("MAIN"==c.type||"PARTICLES"==c.type||"LINE"==c.type)&&"REFLECT"==c.subtype&&c.blend==a){if(e.type==Lt.MAIN_PLANE_REFLECT||e.type==Lt.MAIN_PLANE_REFLECT_BLEND){if((u=it(n,e))==s.plane_reflection_id)continue}else{var u=lt(n,e);if(u==s.cube_reflection_id)continue}if(!_){me(c,e,t,r,"REFLECT",n);var d=c.shaders_info;if(St.set_directive(d,"WATER_EFFECTS",0),e.type==Lt.MAIN_PLANE_REFLECT||e.type==Lt.MAIN_PLANE_REFLECT_BLEND?St.set_directive(d,"REFLECTION_PASS","REFL_PASS_PLANE"):St.set_directive(d,"REFLECTION_PASS","REFL_PASS_CUBE"),St.set_directive(d,"TEXTURE_NORM",0),!ct.update_shader(c)){if("DEBUG"!==Bt.type())continue;ct.apply_shader(c,"error.glslv","error.glslf"),ct.update_shader(c)}}var f=Lt.init_bundle(c,s,o.batch_world_bounds[l]);Lt.append_draw_data(e,f),Mt.connect_render_targets_batch(r,e,c,!1),he(c)}}}function Ee(e){Ue(e);var t=Xe(e,Lt.MAIN_OPAQUE),r=e._render.graph,a=!0,n=e._render.shadow_params;ht.traverse(r,function(r,_){var s=_;s.type===Lt.SHADOW_CAST&&(Ae(s,e,t.camera,n,a),a=!1)})}function we(e){var t=e._render.graph;ht.traverse(t,function(e,t){t.type===Lt.OUTLINE&&(t.draw_outline_flag=1)})}function Ae(e,t,r,a,n){if(0!=e.draw_data.length){var _=e.camera;if(Pt.copy(r.world_tsr,_.world_tsr),Pt.copy(r.view_tsr,_.shadow_cast_billboard_view_tsr),"SUN"===a.lamp_types[e.shadow_lamp_index]||"HEMI"===a.lamp_types[e.shadow_lamp_index]){var s=Re(e,r.world_tsr,hr),o=ut.extract_bb_corners(s,mr);if(Dt.positions_multiply_matrix(o,_.view_matrix,o),a.enable_csm){var i=Ut.copy(r.csm_centers[e.csm_index],lr),l=gt.invert(r.view_matrix,fr);Dt.positions_multiply_matrix(i,l,i),Dt.positions_multiply_matrix(i,_.view_matrix,i);var c=r.csm_radii[e.csm_index];if(n){br=0,gr=-1/0;for(var u=2;u<o.length;u+=3)br=Math.min(br,o[u]),gr=Math.max(gr,o[u])}(d=hr).max_x=i[0]+c,d.max_y=i[1]+c,d.max_z=gr,d.min_x=i[0]-c,d.min_y=i[1]-c,d.min_z=br}else{var d=hr,f=xe(o,d);if(f>0){var m=gt.identity(fr);gt.rotate(m,f,Dt.AXIS_MZ,m),gt.multiply(m,_.view_matrix,_.view_matrix),Pt.from_mat4(_.view_matrix,_.view_tsr)}d=Oe(d),Te(e,t._render.graph)}dt.set_frustum_asymmetric(_,d.min_x,d.max_x,d.min_y,d.max_y,-d.max_z,-d.min_z),dt.set_projection(_,!1)}else"SPOT"!==a.lamp_types[e.shadow_lamp_index]&&"POINT"!==a.lamp_types[e.shadow_lamp_index]||dt.set_projection(_,!1)}}function Te(e,t){for(var r=e.camera,a=Mt.get_outputs(t,e),n=0;n<a.length;n++){var _=a[n];if(_.type==Lt.MAIN_OPAQUE||_.type==Lt.SHADOW_RECEIVE||_.type==Lt.MAIN_BLEND||_.type==Lt.MAIN_XRAY)if(jt.mac_os_shadow_hack)_.v_light_tsr.set(r.view_tsr,9*e.shadow_lamp_index);else{var s=Pt.get_trans_view(r.view_tsr),o=Pt.get_scale(r.view_tsr),i=Pt.get_quat_view(r.view_tsr);Ft.set(s[0],s[1],s[2],o,dr),_.v_light_ts.set(dr,4*e.shadow_lamp_index),_.v_light_r.set(i,4*e.shadow_lamp_index)}}}function xe(e,t){var r=pr;r.set(e);var a=ar/(nr-1),n=gt.identity(fr);gt.rotate(n,a,Dt.AXIS_MZ,n);for(var _=-1,s=-1,o=0;o<nr;o++){var i=ut.bb_from_coords(r,0,r.length,vr),l=(i.max_x-i.min_x)*(i.max_y-i.min_y);(-1==_||_-l>_r)&&(_=l,s=o,ut.copy_bb(i,t)),Dt.positions_multiply_matrix(r,n,r)}return s*a}function Oe(e){var t=e.max_x-e.min_x,r=e.max_y-e.min_y;if(t&&r){var a=Math.abs(t-r)/2;t/r>rr?(e.max_y+=a,e.min_y-=a):r/t>rr&&(e.max_x+=a,e.min_x-=a)}return e.max_x+=sr,e.max_y+=sr,e.max_z+=or,e.min_x-=sr,e.min_y-=sr,e.min_z-=or,e}function Re(e,t,r){ut.zero_bounding_box(r);for(var a=0;a<e.draw_data.length;a++)for(var n=e.draw_data[a].bundles,_=0;_<n.length;_++){var s=n[_].batch,o=n[_].obj_render;if(s.dynamic_grass){var i=Pt.get_quat(t,ur),l=Ut.transformQuat(Dt.AXIS_MZ,i,cr),c=-l[0],u=l[1],d=Pt.get_trans(t,cr),f=d[0]-s.grass_size*(1+c)/2,m=d[1]-s.grass_size*(1-u)/2,p=ut.bounding_box_transform(s.bounds_local.bb,o.world_tsr,vr),h=p.max_z-p.min_z;(v=vr).min_x=f,v.min_y=m,v.min_z=s.grass_map_dim[0]-h,v.max_x=f+s.grass_size,v.max_y=m+s.grass_size,v.max_z=s.grass_map_dim[1]+h}else var v=o.bb_world;0==a&&0==_?ut.copy_bb(v,r):ut.expand_bounding_box(r,v)}return r}function ke(e,t,r,a,n){for(var _=t.render,s=At.get_scene_data(t,a),o=s.batches,i=0;i<o.length;i++){var l=o[i];if("COLOR_ID"==l.type&&(e.type==Lt.COLOR_PICKING&&"COLOR_ID"==l.subtype||e.type==Lt.COLOR_PICKING_XRAY&&"COLOR_ID_XRAY"==l.subtype)&&(n||(me(l,e,t,r,"COLOR_ID",a),ct.set_batch_directive(l,"USE_OUTLINE",0),ct.update_shader(l)))){var c=Lt.init_bundle(l,_,s.batch_world_bounds[i]);Lt.append_draw_data(e,c)}}}function Ne(e,t,r,a,n){for(var _=t.render,s=At.get_scene_data(t,a),o=s.batches,i=0;i<o.length;i++){var l=o[i];if("DEBUG_VIEW"==l.type){if(!n){if(l.dynamic_grass){var c=Mt.find_subs(r,Lt.GRASS_MAP);c&&ve(l,c,_)}if(!ct.update_shader(l)){if("DEBUG"!==Bt.type())return;ct.apply_shader(l,"error.glslv","error.glslf"),ct.update_shader(l)}}var u=Lt.init_bundle(l,_,s.batch_world_bounds[i]);Lt.append_draw_data(e,u),Mt.connect_render_targets_batch(r,e,l,!1),he(l)}}}function Me(e,t,r,a){for(var n=t.render,_=At.get_scene_data(t,r),s=_.batches,o=0;o<s.length;o++){var i=s[o];if("GRASS_MAP"==i.type){if(!a&&!ct.update_shader(i)){if("DEBUG"!==Bt.type())continue;ct.apply_shader(i,"error.glslv","error.glslf"),ct.update_shader(i)}var l=Lt.init_bundle(i,n,_.batch_world_bounds[o]);Lt.append_draw_data(e,l);var c=e.camera,u=n.bb_world,d=e.grass_map_dim[0],f=e.grass_map_dim[1],m=e.grass_map_dim[2];0==d&&0==f?(d=u.min_z,f=u.max_z):(d=Math.min(d,u.min_z),f=Math.max(f,u.max_z));var p=(f-d)*tr;d-=p,f+=p,e.grass_map_dim[0]=d,e.grass_map_dim[1]=f,dt.set_frustum2(c,m/2,m/2,-f,-d),dt.set_projection(c,!1)}}}function Ie(e,t,r,a,n){for(var _=t.render,s=At.get_scene_data(t,a),o=s.batches,i=0;i<o.length;i++){var l=o[i];if("COLOR_ID"==l.type&&"OUTLINE"==l.subtype&&(n||(me(l,e,t,r,"COLOR_ID",a),ct.set_batch_directive(l,"USE_OUTLINE",1),ct.update_shader(l)))){var c=Lt.init_bundle(l,_,s.batch_world_bounds[i]);Lt.append_draw_data(e,c)}}}function Se(e,t){Le(e,t);for(var r=0;r<e.cons_descends.length;r++)e.cons_descends[r].parent==e&&Se(e.cons_descends[r],t)}function Le(e,t){if(e.render.hide=t,At.is_lamp(e))for(var r=0;r<e.scenes_data.length;r++)for(var a=e.scenes_data[r],n=Ve(a.scene,qt),_=0;_<n.length;_++)De(e,a,n[_])}function Ce(e,t){for(var r=Ve(t,qt),a=e.light,n=e.render,_=At.get_scene_data(e,t),s=Pt.get_trans_view(n.world_tsr),o=Pt.get_quat_view(n.world_tsr),i=0;i<r.length;i++){switch(Pe(e,_,v=r[i]),a.type){case"SUN":v.sun_quaternion.set(o),v.sun_intensity=a.color_intensity,Ut.copy(a.direction,v.sun_direction),v.type==Lt.SKY&&v.procedural_skydome&&(v.need_fog_update=a.need_sun_fog_update,Be(t,v));break;case"HEMI":case"POINT":case"SPOT":break;default:Rt.error("Unknown light type: "+a.type+'".')}for(var l=v.draw_data,c=0;c<l.length;c++)for(var u=l[c].bundles,d=0;d<u.length;d++){var f=u[d].batch;f.lamp_uuid_indexes&&ct.set_lamp_data(f,e)}}for(var m=Xe(t,Lt.MAIN_OPAQUE).camera,p=_.shadow_subscenes,h=t._render.shadow_params,i=0;i<p.length;i++){var v=p[i],b=v.camera;dt.set_view_trans_quat(b,s,o),Ae(v,t,m,h,!0),Te(v,t._render.graph)}}function Pe(e,t,r){var a=e.render,n=e.light,_=t.light_index,s=Pt.get_trans_view(e.render.world_tsr),o=n.color_intensity;r.light_directions.set(n.direction,3*_),dr[0]=s[0],dr[1]=s[1],dr[2]=s[2],dr[3]=n.use_diffuse&&!a.hide?1:0,r.light_positions.set(dr,4*_),dr[0]=o[0],dr[1]=o[1],dr[2]=o[2],dr[3]=n.use_specular&&!a.hide?1:0,r.light_color_intensities.set(dr,4*_),r.need_perm_uniforms_update=!0}function De(e,t,r){var a=e.render,n=e.light,_=t.light_index,s=n.use_diffuse&&!a.hide?1:0;r.light_positions[4*_+3]=s,s=n.use_specular&&!a.hide?1:0,r.light_color_intensities[4*_+3]=s,r.need_perm_uniforms_update=!0}function Ue(e){var t=Et.get_scene_objs(e,"LAMP",Et.DATA_ID_ALL),r=jt.ssao&&e.b4w_enable_ssao,a=At.get_shadow_lamps(t,r);if(a.length)for(var n=0;n<a.length;n++)for(var _=a[n],s=_.render,o=Pt.get_trans(s.world_tsr,lr),i=Pt.get_quat(s.world_tsr,ur),l=0;l<_.scenes_data.length;l++){var c=_.scenes_data[l],u=c.shadow_subscenes;if(c.scene==e)for(var d=0;d<u.length;d++){var f=u[d].camera;dt.set_view_trans_quat(f,o,i)}}}function Fe(e){var t=Xe(e,Lt.SKY);t&&Be(e,t)}function Be(e,t){if(xt.prerender_subs(t),Nt.draw(t),t.need_fog_update)for(var r=Ve(e,Vt),a=0;a<r.length;a++)for(var n=r[a].draw_data,_=0;_<n.length;_++)for(var s=n[_].bundles,o=0;o<s.length;o++){var i=s[o];if(i.do_render){var l=i.batch;ct.check_batch_perm_uniform(l,"u_cube_fog")&&Nt.update_batch_permanent_uniform(l,"u_cube_fog")}}Ge(e)}function Ge(e){var t=Xe(e,Lt.IRRADIANCE);t&&(xt.prerender_subs(t),Nt.draw(t));var r=Xe(e,Lt.ROUGHNESS_CONVOLUTION);r&&(xt.prerender_subs(r),Nt.draw(r));var a=Xe(e,Lt.BRDF);a&&(xt.prerender_subs(a),Nt.draw(a))}function je(e){var t=e.camera;Nt.render_target_cleanup(t.framebuffer,t.color_attachment,t.depth_attachment,t.width,t.height);for(var r=e.draw_data,a=0;a<r.length;a++)for(var n=r[a].bundles,_=0;_<n.length;_++){var s=n[_].batch;s&&ct.clear_batch(s)}}function ze(e){for(var t=[],r=0;r<e.length;r++)for(var a=e[r]._object.materials,n=0;n<a.length;n++){var _=a[n];-1==t.indexOf(_)&&t.push(_)}return t}function Ye(e,t,a,n){var _=t,s=a;mt.is_hidpi()&&(_*=window.devicePixelRatio,s*=window.devicePixelRatio);var o=r();if(o){var i=o._render;_*=i.resolution_factor,s*=i.resolution_factor}return _*=e.size_mult_x,s*=e.size_mult_y,n[0]=Math.floor(_),n[1]=Math.floor(s),n}function He(e,t,r){var a=Ye(e,t,r,ir);return a[0]>zt.max_texture_size||a[1]>zt.max_texture_size?(Rt.warn("Texture size exceeds platform limits, downscaling"),Math.min(zt.max_texture_size/a[0],zt.max_texture_size/a[0])):1}function We(e,t,r){var a=e._render,n=At.get_scene_data(e._camera,e).cameras;if(0!=r)_=t/r;else var _=1;for(i=0;i<n.length;i++){var s=n[i];dt.set_aspect(s,_),dt.set_projection(s,!1),a.shadow_params&&dt.update_camera_shadows(s,a.shadow_params)}if(a.shadow_params){a.need_shadow_update=!0;for(var o=Ve(e,[Lt.SHADOW_RECEIVE]),i=0;i<o.length;i++)o[i].need_perm_uniforms_update=!0;for(var l=Ve(e,[Lt.MAIN_BLEND]),i=0;i<l.length;i++)l[i].need_perm_uniforms_update=!0}qe(e,t,r)}function qe(e,t,r){var a=e._render.graph,n=1/0;Mt.traverse_slinks(a,function(e,a,_,s){e.update_dim&&(n=Math.min(n,He(e,t,r)))}),Mt.traverse_slinks(a,function(_,s,o,i){if(_.update_dim){var l,c,u;if(i&&i.type==Lt.SINK||o.is_pp&&!_.apply_resolution_factors?(l=t*_.size_mult_x,c=r*_.size_mult_y):(l=(u=Ye(_,t,r,ir))[0]*n,c=u[1]*n),s)for(var d=0;d<o.slinks_internal.length;d++)o.slinks_internal[d]==_&&Ct.resize(_.texture,l,c);else{Ct.is_texture(_.texture)&&(Ct.resize(_.texture,l,c),_.texture.use_mipmap&&(i.last_mip_map_ind=_.texture.mipmap_count));var f=o.camera;switch(f.width=l,f.height=c,o.type){case Lt.DOF:Ze(e,{dof_power:o.camera.dof_power});break;case Lt.GLOW_COMBINE:$e(e,{small_glow_mask_width:o.small_glow_mask_width,large_glow_mask_width:o.large_glow_mask_width});break;case Lt.BLOOM:Je(e,{blur:o.bloom_blur});break;case Lt.RESIZE:f.width=f.color_attachment.width,f.height=f.color_attachment.height;break;case Lt.OUTLINE:var m=Mt.find_input(a,o,Lt.POSTPROCESSING),p=Mt.find_input(a,m,Lt.POSTPROCESSING),h=Mt.find_input(a,p,Lt.POSTPROCESSING),v=Mt.find_input(a,h,Lt.POSTPROCESSING);Mt.set_texel_size(m,1/l,1/l),Mt.set_texel_size(p,1/l,1/l),Mt.set_texel_size(h,1/l,1/l),Mt.set_texel_size(v,1/l,1/l);break;default:Mt.set_texel_size(o,1/l,1/c)}}}})}function Ve(e,t){for(var r=[],a=0;a<t.length;a++){var n=t[a];e._render.graph&&ht.traverse(e._render.graph,function(e,t){var a=t;a.type==n&&r.push(a)})}return r}function Xe(e,t){var r=e._render.graph;return Mt.find_subs(r,t)}function Ke(e){var t=r();if(t){var a=t._render.graph;ht.traverse(a,function(t,r){var a=r,n=a.camera;n&&n.type==dt.TYPE_HMD_RIGHT&&(a.force_do_not_render=e)})}}function Ze(e,t){var r=Ve(e,[Lt.DOF]);if(!r.length)return Rt.error("DOF is not enabled on the scene. Check camera settings"),0;for(var a=0;a<r.length;a++)Qe(r[a],t,e)}function Qe(e,t,r){var a=e.camera.dof_bokeh,n=a?Ve(r,[Lt.COC]):[],_=r._render.graph;if("boolean"==typeof t.dof_on&&(e.camera.dof_on=t.dof_on,a))for(s=0;s<n.length;s++)n[s].camera.dof_on=t.dof_on;if("number"==typeof t.dof_distance&&(e.camera.dof_distance=t.dof_distance,a))for(s=0;s<n.length;s++)n[s].camera.dof_distance=t.dof_distance;if("number"==typeof t.dof_front_start&&(e.camera.dof_front_start=t.dof_front_start,a))for(s=0;s<n.length;s++)n[s].camera.dof_front_start=t.dof_front_start;if("number"==typeof t.dof_front_end&&(e.camera.dof_front_end=t.dof_front_end,a))for(s=0;s<n.length;s++)n[s].camera.dof_front_end=t.dof_front_end;if("number"==typeof t.dof_rear_start&&(e.camera.dof_rear_start=t.dof_rear_start,a))for(s=0;s<n.length;s++)n[s].camera.dof_rear_start=t.dof_rear_start;if("number"==typeof t.dof_rear_end&&(e.camera.dof_rear_end=t.dof_rear_end,a))for(var s=0;s<n.length;s++)n[s].camera.dof_rear_end=t.dof_rear_end;if("number"==typeof t.dof_bokeh_intensity&&(e.camera.dof_bokeh_intensity=t.dof_bokeh_intensity,a&&((f=Mt.get_inputs_by_type(_,e,Lt.POSTPROCESSING))[0].camera.dof_bokeh_intensity=t.dof_bokeh_intensity,f[1].camera.dof_bokeh_intensity=t.dof_bokeh_intensity,f[0]=Mt.find_input(_,f[0],Lt.POSTPROCESSING),f[0].camera.dof_bokeh_intensity=t.dof_bokeh_intensity)),"number"==typeof t.dof_power)if(a){var o=t.dof_power;e.camera.dof_power=o,o/=2;var i=e.camera.width,l=e.camera.height,c=[1/i,0],u=[1/i*.5,1/l*.866],d=[-1/i*.5,1/l*.866],f=Mt.get_inputs_by_type(_,e,Lt.POSTPROCESSING);Mt.set_texel_size_mult(f[0],o),Mt.set_texel_size(f[0],d[0],d[1]),Mt.set_texel_size_mult(f[1],o),Mt.set_texel_size(f[1],u[0],u[1]),f[0]=Mt.find_input(_,f[0],Lt.POSTPROCESSING),Mt.set_texel_size_mult(f[0],o),Mt.set_texel_size(f[0],c[0],c[1]),e.camera.dof_foreground_blur&&(f[0]=Mt.find_input(_,f[0],Lt.COC),f[0]=Mt.find_input(_,f[0],Lt.POSTPROCESSING),Mt.set_texel_size(f[0],1/i,1/l),f[0]=Mt.find_input(_,f[0],Lt.POSTPROCESSING),Mt.set_texel_size(f[0],1/i,1/l))}else{e.camera.dof_power=t.dof_power;var m=Mt.find_input(_,e,Lt.POSTPROCESSING),p=Mt.find_input(_,m,Lt.POSTPROCESSING);Mt.set_texel_size_mult(m,e.camera.dof_power),Mt.set_texel_size(m,1/e.camera.width,1/e.camera.height),Mt.set_texel_size_mult(p,e.camera.dof_power),Mt.set_texel_size(p,1/e.camera.width,1/e.camera.height)}}function Je(e,t){var r=Ve(e,[Lt.LUMINANCE_TRUNCED]),a=Ve(e,[Lt.BLOOM]);if(!r.length||!a.length)return Rt.error("Bloom is not enabled on the scene"),0;if("number"==typeof t.key)for(f=0;f<r.length;f++)r[f].bloom_key=t.key,r[f].need_perm_uniforms_update=!0;if("number"==typeof t.edge_lum)for(f=0;f<r.length;f++)r[f].bloom_edge_lum=t.edge_lum,r[f].need_perm_uniforms_update=!0;if("number"==typeof t.blur)for(f=0;f<a.length;f++){a[f].bloom_blur=t.blur;for(var n=e._render.graph,_=a[f].camera.width/.5,s=a[f].camera.height/.5,o=Mt.get_inputs_by_type(n,a[f],Lt.POSTPROCESSING),i=0;i<o.length;++i){var l=o[i],c=Mt.find_input(n,l,Lt.POSTPROCESSING),u=_*l.bloom_blur_scale,d=s*l.bloom_blur_scale;Mt.set_texel_size_mult(l,t.blur),Mt.set_texel_size(l,1/u,1/d),Mt.set_texel_size_mult(c,t.blur),Mt.set_texel_size(c,1/u,1/d)}}if("number"==typeof t.average_luminance)for(var f=0;f<r.length;f++)r[f].adaptive_bloom||(r[f].average_luminance=t.average_luminance,r[f].need_perm_uniforms_update=!0)}function $e(e,t){var r=Ve(e,[Lt.GLOW_COMBINE]);if(!r.length)return Rt.error("Glow is not enabled on the scene"),null;for(var a=0;a<r.length;a++)et(r[a],t,e)}function et(e,t,r){for(var a=r._render.graph,n=Mt.get_inputs(a,e),_=0;_<n.length;++_){var s=n[_];if(s.type==Lt.POSTPROCESSING&&"GLOW_MASK_LARGE"==s.subtype)var o=s;if(s.type==Lt.POSTPROCESSING&&"GLOW_MASK_SMALL"==s.subtype)var i=s}var l=Mt.find_input(a,o,Lt.POSTPROCESSING),c=Mt.find_input(a,i,Lt.POSTPROCESSING);"number"==typeof t.small_glow_mask_coeff&&(e.small_glow_mask_coeff=t.small_glow_mask_coeff,e.need_perm_uniforms_update=!0),"number"==typeof t.large_glow_mask_coeff&&(e.large_glow_mask_coeff=t.large_glow_mask_coeff,e.need_perm_uniforms_update=!0),"number"==typeof t.small_glow_mask_width&&(e.small_glow_mask_width=t.small_glow_mask_width,Mt.set_texel_size_mult(i,t.small_glow_mask_width),Mt.set_texel_size(i,1/e.camera.width,1/e.camera.height),i.need_perm_uniforms_update=!0,Mt.set_texel_size_mult(c,t.small_glow_mask_width),Mt.set_texel_size(c,1/e.camera.width,1/e.camera.height),c.need_perm_uniforms_update=!0),"number"==typeof t.large_glow_mask_width&&(e.large_glow_mask_width=t.large_glow_mask_width,Mt.set_texel_size_mult(o,t.large_glow_mask_width),Mt.set_texel_size(o,1/e.camera.width,1/e.camera.height),o.need_perm_uniforms_update=!0,Mt.set_texel_size_mult(l,t.large_glow_mask_width),Mt.set_texel_size(l,1/e.camera.width,1/e.camera.height),l.need_perm_uniforms_update=!0)}function tt(e,t,r){var a=e._render,n=a.water_params;if(!n.dynamic)return n.water_level;var _=n.waves_height,s=n.waves_length,o=n.water_level,i=Ut.length(a.wind)||1,l=Xe(e,Lt.MAIN_OPAQUE).time;l*=i;var c=ir;c[0]=20/s*(t-.25*l),c[1]=20/s*(r-.25*l);var u=Dt.cellular2x2(c);c[0]=17/s*(r+.1*l),c[1]=17/s*(t+.1*l);var d=u+Dt.cellular2x2(c)-1,f=n.dst_noise_scale0,m=n.dst_noise_scale1,p=n.dst_noise_freq0,h=n.dst_noise_freq1,v=ir;v[0]=f*(t+p*l),v[1]=f*(r+p*l);var b=Dt.snoise(v);v[0]=m*(r-h*l),v[1]=m*(t-h*l);var g=_*b*Dt.snoise(v);if(n.shoremap_image){var y=n.shoremap_size[0],E=n.shoremap_size[1],w=(t-n.shoremap_center[0])/y,A=(n.shoremap_center[1]+r)/E;if(w+=.5,A+=.5,w>1||w<0||A>1||A<0)F=g;else{var T=n.shoremap_tex_size,x=a.shore_distances,O=Dt.get_array_smooth_value(x,T,w,A),R=n.dir_min_shore_fac,k=n.dir_freq,N=n.dir_noise_scale,M=n.dir_noise_freq,I=n.dir_min_noise_fac,S=n.dst_min_fac,L=s/n.max_shore_dist/Math.PI,C=[N/s*(t+M*l),N/s*(r+M*l)],P=Math.sqrt(O),D=_*Math.max(O,R)*Math.sin(P/L+k*l)*Math.max(Dt.snoise(C),I),U=Math.max(P,S),F=D*(1-U)+g*U;d*=O}}else F=g;return o+(F+=.05*d)}function rt(e,t,r){t.is_for_outline&&t.type==Lt.POSTPROCESSING&&r.do_render!=t.do_render&&(t.do_render=r.do_render),r.do_render||t.type!=Lt.OUTLINE||(t.draw_outline_flag=0)}function at(e,t,r,a){var n=ht.get_node_attr(e,t);dt.set_attachment(n.camera,r,a),n.assign_texture=!0,ht.traverse_outputs(e,t,function(t,n,_){var s=_;s.active&&s.from==r&&Mt.check_slink_tex_conn(s)&&nt(e,t,s.to,a)}),ht.traverse_inputs(e,t,function(t,n,_){var s=_;s.active&&s.from==r&&s.from==s.to&&at(e,t,r,a)})}function nt(e,t,r,a){for(var n=ht.get_node_attr(e,t).draw_data,_=0;_<n.length;_++)for(var s=n[_].bundles,o=0;o<s.length;o++){var i=s[o].batch;ct.replace_texture(i,a,r)}}function _t(e){for(var t=Ve(e,[Lt.GRASS_MAP]),r=0;r<t.length;r++){var a=t[r],n=a.camera,_=e._camera.render,s=Pt.get_trans(_.world_tsr,lr),o=cr;o[0]=0,o[1]=0,o[2]=-a.grass_map_dim[2]/2;var i=Pt.get_quat(_.world_tsr,ur);Ut.transformQuat(o,i,o),o[0]+=s[0],o[1]+=s[1],o[2]=0,kt.identity(i),dt.set_view_trans_quat(n,o,i)}}function st(e,t){ht.traverse(e,function(r,a){var n=a;if(n.type==Lt.MOTION_BLUR){n.slinks_internal[0]&&n.textures_internal[0]||Dt.panic("Wrong MOTION_BLUR subscene");var _=n.slinks_internal[0],s=n.textures_internal[0];n.textures_internal[0]=n.camera.color_attachment,ht.traverse_outputs(e,r,function(t,r,a){var n=a;n.active&&nt(e,t,n.to,s)}),at(e,r,_.from,s),nt(e,r,_.to,n.textures_internal[0]),n.motion_blur_exp=Math.exp(-t/n.mb_factor)}})}function ot(e){return e._render.wind}function it(e,t){for(var r=e._render.reflection_params.plane_refl_subs,a=0;a<r.length;a++)for(_=0;_<r[a].length;_++)if(r[a][_]==t)return a;for(var n=e._render.reflection_params.plane_refl_subs_blend,a=0;a<n.length;a++)for(var _=0;_<n[a].length;_++)if(n[a][_]==t)return a;return null}function lt(e,t){if(!e._render.reflection_params)return null;for(var r=e._render.reflection_params.cube_refl_subs,a=0;a<r.length;a++)if(r[a]==t)return a;for(var n=e._render.reflection_params.cube_refl_subs_blend,a=0;a<n.length;a++)if(n[a]==t)return a;return null}var ct=_e(e),ut=b(e),dt=ue(e),ft=g(e),mt=ce(e),pt=ae(e),ht=E(e),vt=I(e),bt=S(e),gt=i(e),yt=ne(e),Et=$(e),wt=ee(e),At=k(e),Tt=W(e),xt=L(e),Ot=C(e),Rt=m(e),kt=d(e),Nt=te(e),Mt=G(e),It=D(e),St=B(e),Lt=A(e),Ct=ee(e),Pt=v(e),Dt=h(e),Ut=l(e),Ft=c(e),Bt=U(e),Gt=ft.debug_subs,jt=ft.defaults,zt=ft.context_limits,Yt=ft.outlining,Ht=ft.scenes,Wt=[Lt.GRASS_MAP,Lt.SHADOW_CAST,Lt.MAIN_OPAQUE,Lt.MAIN_BLEND,Lt.MAIN_XRAY,Lt.MAIN_GLOW,Lt.MAIN_PLANE_REFLECT,Lt.MAIN_CUBE_REFLECT,Lt.MAIN_PLANE_REFLECT_BLEND,Lt.MAIN_CUBE_REFLECT_BLEND,Lt.COLOR_PICKING,Lt.COLOR_PICKING_XRAY,Lt.SHADOW_RECEIVE,Lt.OUTLINE_MASK,Lt.DEBUG_VIEW];t.OBJECT_SUBSCENE_TYPES=Wt;var qt=[Lt.MAIN_OPAQUE,Lt.MAIN_BLEND,Lt.MAIN_XRAY,Lt.MAIN_GLOW,Lt.MAIN_PLANE_REFLECT,Lt.MAIN_CUBE_REFLECT,Lt.GOD_RAYS,Lt.GOD_RAYS_COMBINE,Lt.SKY,Lt.MAIN_PLANE_REFLECT_BLEND,Lt.MAIN_CUBE_REFLECT_BLEND,Lt.LUMINANCE_TRUNCED,Lt.SHADOW_RECEIVE,Lt.SHADOW_CAST,Lt.COLOR_PICKING,Lt.COLOR_PICKING_XRAY,Lt.OUTLINE_MASK],Vt=[Lt.MAIN_OPAQUE,Lt.SSAO,Lt.MAIN_BLEND,Lt.MAIN_XRAY,Lt.MAIN_GLOW,Lt.MAIN_PLANE_REFLECT,Lt.MAIN_CUBE_REFLECT,Lt.MAIN_PLANE_REFLECT_BLEND,Lt.MAIN_CUBE_REFLECT_BLEND],Xt=[Lt.SHADOW_CAST,Lt.MAIN_OPAQUE,Lt.MAIN_BLEND,Lt.MAIN_XRAY,Lt.MAIN_GLOW,Lt.MAIN_PLANE_REFLECT,Lt.MAIN_CUBE_REFLECT,Lt.MAIN_PLANE_REFLECT_BLEND,Lt.MAIN_CUBE_REFLECT_BLEND,Lt.COLOR_PICKING,Lt.COLOR_PICKING_XRAY,Lt.SHADOW_RECEIVE,Lt.GOD_RAYS,Lt.OUTLINE_MASK,Lt.DEBUG_VIEW],Kt=[Lt.MAIN_OPAQUE,Lt.MAIN_BLEND,Lt.MAIN_XRAY,Lt.MAIN_GLOW,Lt.MAIN_PLANE_REFLECT,Lt.MAIN_CUBE_REFLECT,Lt.MAIN_PLANE_REFLECT_BLEND,Lt.MAIN_CUBE_REFLECT_BLEND],Zt=8,Qt=null,Jt=null,$t=[],er=null,tr=1e-4,rr=2,ar=Math.PI/2,nr=10,_r=.1,sr=.005,or=.005,ir=new Float32Array(2),lr=new Float32Array(3),cr=new Float32Array(3),ur=new Float32Array(4),dr=new Float32Array(4),fr=new Float32Array(16),mr=new Float32Array(24),pr=new Float32Array(24),hr=ut.create_bb(),vr=ut.create_bb(),br=0,gr=-1/0,yr=new Uint8Array(4);t.create_scene_render=function(){return{}},t.set_active=function(e){Jt=e,It.set_active_scene(e)},t.prepare_rendering=function(e,t){var r=e._render,a=Mt.create_rendering_queue(r.graph);if(e==t)for(We(e,mt.get_viewport_width(),mt.get_viewport_height()),o=0;o<a.length;o++)e._render.queue.push(a[o]);else{var n=e._render_to_textures[0];for(We(e,n.source_size,n.source_size),o=0;o<a.length;o++)t._render.queue.push(a[o])}for(var _=Ve(e,Xt),s=0;s<_.length;s++)_[s].wind.set(r.wind);for(var o=0;o<r.queue.length;o++)r.queue[o].type==Lt.SHADOW_CAST&&Nt.draw(r.queue[o])},t.get_main=r,t.find_main_scene=a,t.get_active=n,t.check_active=function(){return!!Jt},t.get_camera=function(e){return e._camera},t.get_all_scenes=_,t.get_rendered_scenes=function(){if(1==$t.length)return $t;for(t=0;t<$t.length;t++)n=$t[t]._render.graph,ht.traverse(n,function(e,r){for(var a=r,n=a.draw_data,_=0;_<n.length;_++)for(var s=n[_].bundles,o=0;o<s.length;o++){for(var i=s[o],l=i.batch.textures,c=i.batch.bpy_tex_names,u=null,d=0;d<l.length;d++)if("SCENE"==l[d].source&&l[d].source_id==$t[t].name&&a.type!=Lt.COPY){Rt.error('Texture-scene loop detected. A scene is rendered to texture "'+c[d]+'" yet this texture belongs to the same scene.'),u=i.batch;break}if(u){var f=u.textures;for(u.textures=[],u.texture_names=[],ct.update_batch_material_error(u,null),ct.update_shader(u),Lt.append_draw_data(a,i),d=0;d<f.length;d++){var m=f[d];wt.cleanup_unused(m)}}}});for(var e=[],t=0;t<$t.length;t++){var r=$t[t];if(!r._render_to_textures.length){var a=ht.node_by_attr(er,r);ht.enforce_acyclic(er,a);var n=ht.subgraph_node_conn(er,a,ht.BACKWARD_DIR);n=ht.topsort(n),ht.traverse(n,function(t,r){e.push(r)});break}}return e},t.append_scene=function(e,t,r,a,n){e._render_to_textures=e._render_to_textures||[],e._nla=null;var _=e._render,o=At.get_scene_data(e._camera,e),i=e._camera.render;_.video_textures=[];var l=e.world;_.lamps_number=r.length,_.sun_exist=u(r),_.sky_params=M(l,_.sun_exist),_.world_light_set=V(l,_.sky_params),_.world_fog_set=X(l),_.hmd_stereo_use=!e._render_to_textures.length&&O(o),_.anaglyph_use=!e._render_to_textures.length&&T(o),_.sidebyside_use=!e._render_to_textures.length&&x(o),_.anchor_visibility=!_.anaglyph_use&&!_.sidebyside_use&&oe(e,n),_.reflection_params=R(e,t,a),_.bloom_params=F(e),_.mb_params=j(e),_.cc_params=z(e),_.god_rays_params=Y(e),_.outline_params=H(e),_.glow_params=q(e),_.dof=jt.dof&&(i.dof_distance>0||i.dof_object),_.motion_blur=jt.motion_blur&&e.b4w_enable_motion_blur,_.compositing=jt.compositing&&e.b4w_enable_color_correction,_.antialiasing=jt.antialiasing&&1==jt.msaa_samples&&"NONE"!=e.b4w_antialiasing_quality,_.ssao=jt.ssao&&e.b4w_enable_ssao,_.god_rays=jt.god_rays&&e.b4w_enable_god_rays&&_.sun_exist,_.depth_tex=jt.depth_tex_available,_.glow_over_blend=e.b4w_glow_settings.render_glow_over_blend,_.ssao_params=P(e);var c=w(a);switch(_.materials_params=c,_.refractions=re(e,c),_.shadow_params=s(e,r,a),_.water_params=y(a),_.xray=se(a),_.soft_particles=p(a),_.shore_smoothing=f(a),_.dynamic_grass=K(e,a),_.color_picking=Z(e,a),_.outline=Q(e,a),_.glow_materials=J(e,a),_.lod_smooth_type=e.b4w_lod_smooth_type,_.lod_hyst_interval=e.b4w_lod_hyst_interval,jt.reflection_quality?jt.reflection_quality:e.b4w_reflection_quality){case"LOW":_.cubemap_refl_size=Ht.cube_reflect_low,_.plane_refl_size=Ht.plane_reflect_low;break;case"MEDIUM":_.cubemap_refl_size=Ht.cube_reflect_medium,_.plane_refl_size=Ht.plane_reflect_medium;break;case"HIGH":_.cubemap_refl_size=Ht.cube_reflect_high,_.plane_refl_size=Ht.plane_reflect_high;break;default:_.cubemap_refl_size=Ht.cube_reflect_low,_.plane_refl_size=Ht.plane_reflect_low}mt.is_hidpi()?(Rt.log("%cENABLE HIDPI MODE","color: #00a"),_.aa_quality="AA_QUALITY_LOW",_.resolution_factor=1,jt.msaa_samples=1):jt.msaa_samples>1?(Rt.log("%cENABLE MSAA RENDERING: "+jt.msaa_samples+"x","color: #00a"),_.resolution_factor=1):(_.aa_quality="AA_QUALITY_"+e.b4w_antialiasing_quality,jt.quality===ft.P_ULTRA?_.resolution_factor=1.33:_.resolution_factor=1);var d=e._render_to_textures.sort(function(e,t){return t.source_size-e.source_size});_.graph=Mt.create_rendering_graph(_,o,i,d),_.queue=[],_.need_shadow_update=!1,_.need_grass_map_update=!1,_.need_outline=!1,_.wind=new Float32Array(3),$t.push(e),er||(er=ht.create()),ht.append_node_attr(er,e);for(var m=0;m<t.length;m++)At.scene_data_set_active(t[m],!0,e);var h=mt.get_container();mt.resize(h.clientWidth,h.clientHeight,!0)},t.append_scene_vtex=function(e,t,r){for(var a=0;a<t.length;a++){var n=t[a]._render;n&&n.is_movie&&(n.vtex_data_id=r,e._render.video_textures.push(t[a]))}},t.get_graph=function(e){return e._render.graph},t.generate_auxiliary_batches=function(e,t){ht.traverse(t,function(r,a){var n=a,_=null;switch(n.type){case Lt.POSTPROCESSING:_=ct.create_postprocessing_batch(n.pp_effect);break;case Lt.SSAO:_=ct.create_ssao_batch(n);break;case Lt.SSAO_BLUR:_=ct.create_ssao_blur_batch(n);break;case Lt.DEPTH_PACK:_=ct.create_depth_pack_batch();break;case Lt.GOD_RAYS:var s=n.water,o=n.steps_per_pass;_=ct.create_god_rays_batch(n.pack,s,o);break;case Lt.GOD_RAYS_COMBINE:_=ct.create_god_rays_combine_batch();break;case Lt.MOTION_BLUR:_=ct.create_motion_blur_batch(n.mb_decay_threshold);break;case Lt.COC:_=ct.create_coc_batch(n.coc_type);break;case Lt.DOF:_=ct.create_dof_batch(n);var i=n.camera.dof_power;if(n.camera.dof_bokeh){i/=2;var l=Mt.get_inputs_by_type(t,n,Lt.POSTPROCESSING);Mt.set_texel_size_mult(l[0],i),Mt.set_texel_size_mult(l[1],i),l[0]=Mt.find_input(t,l[0],Lt.POSTPROCESSING),Mt.set_texel_size_mult(l[0],i)}else{var c=Mt.find_input(t,n,Lt.POSTPROCESSING),u=Mt.find_input(t,c,Lt.POSTPROCESSING);Mt.set_texel_size_mult(c,i),Mt.set_texel_size_mult(u,i)}break;case Lt.OUTLINE:_=ct.create_outline_batch();var d=Mt.find_input(t,n,Lt.POSTPROCESSING),f=Mt.find_input(t,d,Lt.POSTPROCESSING),m=Mt.find_input(t,f,Lt.POSTPROCESSING),p=Mt.find_input(t,m,Lt.POSTPROCESSING);Mt.set_texel_size_mult(f,n.blur_texel_size_mult),Mt.set_texel_size_mult(d,n.blur_texel_size_mult),Mt.set_texel_size_mult(p,n.ext_texel_size_mult*n.outline_factor),Mt.set_texel_size_mult(m,n.ext_texel_size_mult*n.outline_factor);break;case Lt.GLOW_COMBINE:_=ct.create_glow_combine_batch();break;case Lt.COMPOSITING:_=ct.create_compositing_batch();break;case Lt.ANTIALIASING:_=ct.create_antialiasing_batch(n);break;case Lt.SMAA_RESOLVE:case Lt.SMAA_EDGE_DETECTION:case Lt.SMAA_BLENDING_WEIGHT_CALCULATION:case Lt.SMAA_NEIGHBORHOOD_BLENDING:_=ct.create_smaa_batch(n.type);break;case Lt.STEREO:_=ct.create_stereo_batch(n.subtype);break;case Lt.SKY:_=ct.create_cube_sky_batch(e,n);break;case Lt.IRRADIANCE:_=ct.create_cube_irradiance_batch(e,n);break;case Lt.ROUGHNESS_CONVOLUTION:_=ct.create_cube_roughness_convolution_batch(e,n);break;case Lt.BRDF:_=ct.create_brdf_batch(e,n);break;case Lt.LUMINANCE:_=ct.create_luminance_batch();break;case Lt.AVERAGE_LUMINANCE:_=ct.create_average_luminance_batch();break;case Lt.LUMINANCE_TRUNCED:_=ct.create_luminance_truncated_batch(n.adaptive_bloom);break;case Lt.BLOOM:_=ct.create_bloom_combine_batch(n.bloom_blur_num);break;case Lt.RESIZE:_=ct.create_postprocessing_batch("NONE");break;case Lt.VELOCITY:_=ct.create_velocity_batch();break;case Lt.ANCHOR_VISIBILITY:_=ct.create_anchor_visibility_batch();break;case Lt.PERFORMANCE:_=ct.create_performance_batch()}if(_){var h=Lt.init_bundle(_,At.create_render("NONE"));Lt.append_draw_data(n,h),Mt.connect_render_targets_batch(t,n,_,!1),he(_)}})},t.append_object=function(e,t,r,a){switch(t.type){case"MESH":case"LINE":case"WORLD":var n=e._render.graph,_=t.render;!Mt.find_subs(n,Lt.SHADOW_CAST)&&_.shadow_receive&&(_.shadow_receive=!1);var s=Ve(e,Wt);(r||a)&&Tt.append_object(t,e);for(var o=0;o<s.length;o++)le(s[o],t,n,e,r);break;case"LAMP":Ce(t,e)}for(var i=At.get_scene_data(t,e),l=i.batches,c=0;c<l.length;c++)null==l[c].shader&&"PHYSICS"!=l[c].type&&(At.scene_data_remove_batch(i,c),c--);At.scene_data_set_active(t,!0,e)},t.init_cube_sky_dim=function(e,t){if(e&&e._render&&e._render.graph){var r=e._render.graph,a=Mt.find_subs(e._render.graph,Lt.SKY);if(a){var n=null;if(Mt.traverse_slinks(r,function(e,t,r,a){if("CUBEMAP"==e.from&&r.type==Lt.SKY&&a.type==Lt.SINK)return n=e.texture,!0}),n){var _=Ht.cubemap_tex_size,s=ct.get_batch_by_type(t,"SKY",e);if(s&&s.has_nodes){var o=yt.get_ngraph_proxy_cached(s.ngraph_proxy_id).graph,i=yt.get_max_env_texture_height(o);-1!=i&&(_=wt.calc_pot_size(i/2))}else{var l=e._render.world_light_set.sky_texture_param;l&&(_=l.tex_size)}_=Math.min(_,zt.max_cube_map_texture_size),a.camera.width=_,a.camera.height=_,Ct.set_cubemap_tex_size(n,_),ie(e,_);var c=Mt.find_subs(e._render.graph,Lt.IRRADIANCE);if(c){c.camera.width=_,c.camera.height=_;var u=null;Mt.traverse_slinks(r,function(e,t,r,a){if("CUBEMAP"==e.from&&r.type==Lt.IRRADIANCE&&a.type==Lt.MAIN_OPAQUE)return u=e.texture,!0}),u&&Ct.set_cubemap_tex_size(u,_)}var d=Mt.find_subs(e._render.graph,Lt.ROUGHNESS_CONVOLUTION);if(d){d.camera.width=128,d.camera.height=128;var f=null;Mt.traverse_slinks(r,function(e,t,r,a){if("CUBEMAP"==e.from&&r.type==Lt.ROUGHNESS_CONVOLUTION&&a.type==Lt.MAIN_OPAQUE)return f=e.texture,!0}),f&&Ct.set_cubemap_tex_size(f,128)}}}}},t.update_cube_sky_dim=function(e,t){for(var r=e.scenes_data,a=0;a<r.length;a++){var n=r[a].scene,_=n._render.graph,s=Mt.find_subs(n._render.graph,Lt.SKY);if(s){var o=null;if(Mt.traverse_slinks(_,function(e,t,r,a){if("CUBEMAP"==e.from&&r.type==Lt.SKY&&a.type==Lt.IRRADIANCE)return o=e.texture,!0}),o){var i=wt.calc_pot_size(t.height/2);i=Math.min(i,zt.max_cube_map_texture_size),s.camera.width=i,s.camera.height=i,Ct.set_cubemap_tex_size(o,i),ie(n,i)}}}},t.schedule_shadow_update=function(e){e._render.need_shadow_update=!0},t.update_shadow_billboard_view=function(e,t){ht.traverse(t,function(t,r){var a=r;a.type===Lt.SHADOW_CAST&&(Pt.copy(e.world_tsr,a.camera.world_tsr),Pt.copy(e.view_tsr,a.camera.shadow_cast_billboard_view_tsr))})},t.update_shadow_receive_subs=Te,t.get_csm_borders=function(e,t){for(var r=e._render.shadow_params,a=new Float32Array(r.csm_num),n=0;n<r.csm_num;n++)a[n]=dt.csm_far_plane(r,t,n);return a},t.change_visibility_rec=Se,t.change_visibility=Le,t.is_hidden=function(e){return e.render.hide},t.remove_object_bundles=function(e,t){for(var r=0;r<e.scenes_data.length;r++)for(var a=Ve(e.scenes_data[r].scene,Wt),n=0;n<a.length;n++)for(var _=a[n].draw_data,s=0;s<_.length;s++)for(var o=_[s].bundles,i=o.length-1;i>=0;i--){var l=o[i];l.obj_render==e.render&&(l.batch?void 0!==t&&-1==l.batch.material_names.indexOf(t)&&0!=l.batch.material_names.length||(ct.clear_batch(l.batch),o.splice(i,1)):o.splice(i,1))}},t.update_lamp_scene_color_intensity=function(e,t){for(var r=e.light,a=At.get_scene_data(e,t).light_index,n=Ve(t,qt),_=0;_<n.length;_++){var s=n[_];s.light_color_intensities.set(r.color_intensity,4*a),s.need_perm_uniforms_update=!0}},t.update_lamp_scene=Ce,t.update_sky_texture=function(e){for(var t=e.scenes_data,r=0;r<t.length;r++)Fe(t[r].scene)},t.update_world_texture=Fe,t.update_sky=Be,t.cleanup=function(){for(var e=0;e<$t.length;e++){var t=$t[e],r=t._render.graph;ht.traverse(r,function(e,t){t.type!=Lt.SINK&&je(t)}),t._render.graph=null,t._render.queue=[]}Qt=null,Jt=null,$t.length=0,er=null},t.make_frustum_shot=function(e,t,r){var a=dt.extract_frustum_corners(e,e.near,e.far,null,!0),n=Ot.generate_frustum(a),_=At.create_render("DYNAMIC");_.bb_world=_.bb_local=ut.big_bounding_box(),_.bs_world=_.bs_local=ut.big_bounding_sphere();var s=_.bs_world.radius;_.be_world=_.be_local=ut.be_from_values([s,0,0],[0,s,0],[0,0,s],_.bs_world.center);var o=ct.create_shadeless_batch(n,r,.5);o.do_not_cull=!0;var i=Lt.init_bundle(o,_);Lt.append_draw_data(t,i)},t.get_scene_timeline=function(e){return[e.frame_start,e.frame_end]},t.setup_dim=function(e,t,r){mt.setup_viewport_dim(e,t,r),Jt&&We(Jt,e,t)},t.subs_array=Ve,t.get_subs=Xe,t.render_both_eyes=function(){Ke(!1)},t.render_one_eye=function(){Ke(!0)},t.get_environment_colors=function(e){var t=Xe(e,Lt.MAIN_OPAQUE),r=t.horizon_color,a=t.zenith_color,n=[],_=[];return n[0]=r[0],n[1]=r[1],n[2]=r[2],_[0]=a[0],_[1]=a[1],_[2]=a[2],[t.environment_energy,n,_]},t.set_environment_colors=function(e,t,r,a){for(var n=Ve(e,qt),_=0;_<n.length;_++){var s=n[_];s.horizon_color.set(r),s.zenith_color.set(a),s.environment_energy=t,s.need_perm_uniforms_update=!0}var o=Mt.find_subs(e._render.graph,Lt.SKY);o&&Be(e,o)},t.get_sky_params=function(e){var t=Xe(e,Lt.SKY);if(t&&t.procedural_skydome){var r={};return r.color=new Array(3),Ut.copy(t.sky_color,r.color),r.procedural_skydome=t.procedural_skydome,r.use_as_environment_lighting=t.use_as_environment_lighting,r.rayleigh_brightness=t.rayleigh_brightness,r.mie_brightness=t.mie_brightness,r.spot_brightness=t.spot_brightness,r.scatter_strength=t.scatter_strength,r.rayleigh_strength=t.rayleigh_strength,r.mie_strength=t.mie_strength,r.rayleigh_collection_power=t.rayleigh_collection_power,r.mie_collection_power=t.mie_collection_power,r.mie_distribution=t.mie_distribution,r}return null},t.get_fog_intensity=function(e){return Ve(e,Vt)[0].fog_params[0]},t.get_fog_depth=function(e){return Ve(e,Vt)[0].fog_params[1]},t.get_fog_start=function(e){return Ve(e,Vt)[0].fog_params[2]},t.get_fog_height=function(e){return Ve(e,Vt)[0].fog_params[3]},t.set_fog_intensity=function(e,t){for(var r=Ve(e,Vt),a=0;a<r.length;a++){var n=r[a];n.fog_params[0]=t,n.need_perm_uniforms_update=!0}},t.set_fog_depth=function(e,t){for(var r=Ve(e,Vt),a=0;a<r.length;a++){var n=r[a];n.fog_params[1]=t,n.need_perm_uniforms_update=!0}},t.set_fog_start=function(e,t){for(var r=Ve(e,Vt),a=0;a<r.length;a++){var n=r[a];n.fog_params[2]=t,n.need_perm_uniforms_update=!0}},t.set_fog_height=function(e,t){for(var r=Ve(e,Vt),a=0;a<r.length;a++){var n=r[a];n.fog_params[3]=t,n.need_perm_uniforms_update=!0}},t.get_fog_color_density=function(e,t){var r=t||[],a=Ve(e,Vt)[0].fog_color_density;return r[0]=a[0],r[1]=a[1],r[2]=a[2],r[3]=a[3],r},t.set_fog_color_density=function(e,t){for(var r=Ve(e,Vt),a=0;a<r.length;a++){var n=r[a];n.fog_color_density.set(t),n.need_perm_uniforms_update=!0}},t.get_ssao_params=function(e){var t=Xe(e,Lt.SSAO),r=Xe(e,Lt.SSAO_BLUR),a=Xe(e,Lt.MAIN_OPAQUE);if(!t)return null;var n={};return n.quality=t.ssao_samples,n.use_hemisphere=t.ssao_hemisphere,n.use_blur_depth=r.ssao_blur_depth,n.blur_discard_value=r.ssao_blur_discard_value,n.radius_increase=t.ssao_radius_increase,n.influence=t.ssao_influence,n.dist_factor=t.ssao_dist_factor,n.ssao_only=a.ssao_only,n.ssao_white=t.ssao_white,n},t.get_dof_params=function(e){var t=Xe(e,Lt.DOF);if(!t)return null;var r={};return r.dof_on=t.camera.dof_on,r.dof_distance=t.camera.dof_distance,r.dof_front_start=t.camera.dof_front_start,r.dof_front_end=t.camera.dof_front_end,r.dof_rear_start=t.camera.dof_rear_start,r.dof_rear_end=t.camera.dof_rear_end,r.dof_power=t.camera.dof_power,r.dof_bokeh=t.camera.dof_bokeh,r.dof_bokeh_intensity=t.camera.dof_bokeh_intensity,r.dof_object=t.camera.dof_object,r},t.set_dof_params=Ze,t.get_god_rays_params=function(e){var t=Ve(e,[Lt.GOD_RAYS]),r=Xe(e,Lt.GOD_RAYS_COMBINE);if(!t||!r)return null;var a={};a.god_rays_max_ray_length=t[0].max_ray_length,a.god_rays_intensity=r.god_rays_intensity;var n=t[0].draw_data[0].bundles[0].batch;return a.god_rays_steps=ct.get_batch_directive(n,"STEPS_PER_PASS")[1],a},t.set_god_rays_params=function(e,t){var r=Ve(e,[Lt.GOD_RAYS]),a=Ve(e,[Lt.GOD_RAYS_COMBINE]);if(!r.length||!a.length)return Rt.error("God Rays are not enabled on the scene"),0;if("number"==typeof t.god_rays_intensity)for(_=0;_<a.length;_++)a[_].god_rays_intensity=t.god_rays_intensity;if("number"==typeof t.god_rays_max_ray_length)for(var n=t.god_rays_max_ray_length,_=0;_<r.length;_++)r[_].max_ray_length=n,r[_].radial_blur_step=n/r[_].steps_per_pass/(_+1),r[_].need_perm_uniforms_update=!0;if("number"==typeof t.god_rays_steps)for(var s=St.glsl_value(t.god_rays_steps,1),n=r[0].max_ray_length,_=0;_<r.length;_++){r[_].steps_per_pass=s,r[_].radial_blur_step=n/s/(_+1),r[_].need_perm_uniforms_update=!0;var o=r[_].draw_data[0].bundles[0],i=o.batch;ct.set_batch_directive(i,"STEPS_PER_PASS",s),ct.update_shader(i),Lt.append_draw_data(r[_],o)}for(_=0;_<a.length;_++)a.need_perm_uniforms_update=!0},t.get_bloom_params=function(e){var t=Xe(e,Lt.LUMINANCE_TRUNCED),r=Xe(e,Lt.BLOOM);if(!t||!r)return null;var a={};return a.key=t.bloom_key,a.edge_lum=t.bloom_edge_lum,a.blur=r.bloom_blur,a.adaptive=t.adaptive_bloom,a.average_luminance=t.average_luminance,a},t.set_bloom_params=Je,t.get_glow_material_params=function(e){var t=Xe(e,Lt.GLOW_COMBINE);if(!t)return null;var r={};return r.small_glow_mask_coeff=t.small_glow_mask_coeff,r.large_glow_mask_coeff=t.large_glow_mask_coeff,r.small_glow_mask_width=t.small_glow_mask_width,r.large_glow_mask_width=t.large_glow_mask_width,r},t.set_glow_material_params=$e,t.get_wind_params=function(e){var t=ot(e),r=Ut.length(t);if(0==r)return null;var a=Dt.rad_to_deg(Math.atan2(t[0],-t[1])),n={};return n.wind_dir=a,n.wind_strength=r,n},t.schedule_grass_map_update=function(e){e._render.need_grass_map_update=!0},t.get_water_surface_level=tt,t.get_water_mat_params=function(e,t){var r=e._render.water_params,a=Xe(e,Lt.MAIN_OPAQUE);if(a&&r){t.waves_height=r.waves_height,t.waves_length=r.waves_length,t.water_fog_density=a.water_fog_color_density[3];var n=t.water_fog_color=[];n[0]=a.water_fog_color_density[0],n[1]=a.water_fog_color_density[1],n[2]=a.water_fog_color_density[2]}},t.set_water_params=function(e,t){var r=e._render.water_params;if(!r)return Rt.error("set_water_params() - no water parameters on the scene"),null;"number"==typeof t.dst_noise_scale0&&(r.dst_noise_scale0=t.dst_noise_scale0),"number"==typeof t.dst_noise_scale1&&(r.dst_noise_scale1=t.dst_noise_scale1),"number"==typeof t.dst_noise_freq0&&(r.dst_noise_freq0=t.dst_noise_freq0),"number"==typeof t.dst_noise_freq1&&(r.dst_noise_freq1=t.dst_noise_freq1),"number"==typeof t.dir_min_shore_fac&&(r.dir_min_shore_fac=t.dir_min_shore_fac),"number"==typeof t.dir_freq&&(r.dir_freq=t.dir_freq),"number"==typeof t.dir_noise_scale&&(r.dir_noise_scale=t.dir_noise_scale),"number"==typeof t.dir_noise_freq&&(r.dir_noise_freq=t.dir_noise_freq),"number"==typeof t.dir_min_noise_fac&&(r.dir_min_noise_fac=t.dir_min_noise_fac),"number"==typeof t.dst_min_fac&&(r.dst_min_fac=t.dst_min_fac),"number"==typeof t.waves_hor_fac&&(r.waves_hor_fac=t.waves_hor_fac),"number"==typeof t.water_dynamic&&(r.dynamic=t.water_dynamic);for(var a=Ve(e,Kt),n=0;n<a.length;n++){var _=a[n];"number"==typeof t.water_fog_density&&r.fog_color_density&&(_.water_fog_color_density[3]=t.water_fog_density),"object"==typeof t.water_fog_color&&r.fog_color_density&&_.water_fog_color_density.set(t.water_fog_color),_.need_perm_uniforms_update=!0}},t.get_shore_dist=function(e,t,r){var a=e._render.water_params;if(!a.shoremap_image)return 100;var n=a.shoremap_size[0],_=a.shoremap_size[1],s=a.shoremap_center[0],o=a.shoremap_center[1],i=a.max_shore_dist,l=a.water_level,c=(t[0]-s)/n,u=(o+t[1])/_;if(c+=.5,u+=.5,!(c>1||c<0||u>1||u<0)){var d=a.shoremap_tex_size,f=Jt._render.shore_distances,m=i*Dt.get_array_smooth_value(f,d,c,u),p=(l-t[2])*r;return Math.sqrt(m*m+p*p)}},t.update=function(e,t){for(var r=n()._camera.render,a=0;a<$t.length;a++){if(h=(m=$t[a])._render.graph,(p=m._render).water_params)var _=Pt.get_trans_view(r.world_tsr),s=_[2]-tt(m,_[0],_[1]);for(g=0;g<p.video_textures.length;g++){var o=p.video_textures[g]._render,i=o.video_file,l=o.seq_video;if((!m.b4w_use_nla||!o.use_nla)&&(i||l)&&Ct.video_is_played(o)){var c=Ct.video_get_current_frame(o),u=Ct.video_get_start_frame(o);i&&jt.is_mobile_device&&(u-=5);var d=Ct.video_get_end_frame(o);if(c>=d&&o.use_cyclic||c<u)Ct.reset_video(o),l&&(o.seq_last_discrete_mark=Ct.seq_video_get_discrete_timemark(o,e));else if(c>=d&&!o.use_cyclic)Ct.pause_video(o);else if(Ct.video_update_is_available(o))if(i)Ct.update_video_texture(o);else{var f=Ct.seq_video_get_discrete_timemark(o,e);f!=o.seq_last_discrete_mark&&(Ct.update_seq_video_texture(o),o.seq_cur_frame++),o.seq_last_discrete_mark=f}}}ht.traverse(h,function(t,r){var a=r;Xt.indexOf(a.type)>-1&&(a.time=e),p.water_params&&(a.cam_water_depth=s)})}for(a=0;a<$t.length;a++){var m=$t[a],p=m._render,h=p.graph,v=p.queue;if(v.length){p.need_shadow_update&&(Ee(m),p.need_shadow_update=!1),p.need_grass_map_update&&(_t(m),p.need_grass_map_update=!1),p.need_outline&&(we(m),p.need_outline=!1),p.motion_blur&&st(h,t);for(var b=Mt.find_subs(h,Lt.OUTLINE_MASK),g=0;g<v.length;g++){var y=v[g];xt.prerender_subs(y),b&&rt(0,y,b),Nt.draw(y)}}}jt.show_hud_debug_info&&vt.show_debug_info($t,t)},t.request_outline=function(e){e._render.need_outline=!0},t.get_all_subscenes=function(e){var t=e._render.graph,r=[];return ht.traverse(t,function(e,t){r.push(t)}),r},t.get_cam_water_depth=function(){var e=Xe(Jt,Lt.MAIN_BLEND);return e||Jt._render.water_params?e.cam_water_depth:null},t.update_scene_permanent_uniforms=function(e){var t=e._render.graph;ht.traverse(t,function(e,t){t.need_perm_uniforms_update=!0})},t.set_debug_view_mode=function(e,t){e.debug_view_mode=t,e.do_render=t!=pt.DV_NONE,e.blend=t==pt.DV_TRANSPARENT_WIREFRAME,e.need_perm_uniforms_update=!0;for(var r=n(),a=0;a<Kt.length;a++)for(var _=Ve(r,[Kt[a]]),s=0;s<_.length;s++)_[s].do_not_debug=t==pt.DV_RENDER_TIME},t.set_debug_colors_seed=function(e,t){e.debug_colors_seed=t,e.need_perm_uniforms_update=!0},t.set_render_time_threshold=function(e,t){e.debug_render_time_threshold=t,e.need_perm_uniforms_update=!0},t.set_wireframe_edge_color=function(e,t){for(var r=e.draw_data,a=0;a<r.length;a++)for(var n=r[a].bundles,_=0;_<n.length;_++){var s=n[_].batch;Ut.copy(t,s.wireframe_edge_color),s.shader.need_uniforms_update=!0}},t.update_force_scene=function(e,t){var r=t.field,a=e._render.wind;if(r&&"WIND"==r.type&&a){var n=t.render,_=Pt.get_quat_view(n.world_tsr);Ut.transformQuat(Dt.AXIS_Z,_,a),Ut.normalize(a,a),Ut.scale(a,r.strength,a);for(var s=Ve(e,Xt),o=0;o<s.length;o++)s[o].wind.set(a);return!0}return!1},t.pick_color=function(e,t,r){var a=Xe(e,Lt.COLOR_PICKING);if(a){var n=Gt.enabled&&(Gt.subs_type===Lt.COLOR_PICKING||Gt.subs_type===Lt.COLOR_PICKING_XRAY);if(n)var _=mt.canvas_to_viewport_coords(t,r,ir,a.camera);else{var s=mt.get_canvas(),o=s.clientHeight,i=s.clientWidth;dt.set_color_pick_proj(a.camera,t,r,i,o)}xt.prerender_subs(a),a.do_render&&Nt.draw(a);var l=Xe(e,Lt.COLOR_PICKING_XRAY);if(l)gt.copy(a.camera.proj_matrix,l.camera.proj_matrix),gt.copy(a.camera.view_proj_matrix,l.camera.view_proj_matrix),Dt.extract_frustum_planes(l.camera.view_proj_matrix,l.camera.frustum_planes),xt.prerender_subs(l),l.do_render&&Nt.draw(l),c=l.camera;else var c=a.camera;return a.do_render||l&&l.do_render?n?(_[1]=c.height-_[1],Nt.read_pixels(c.framebuffer,_[0],_[1],1,1,yr)):Nt.read_pixels(l?l.camera.framebuffer:a.camera.framebuffer,0,0,1,1,yr):null}return Rt.error("Object Selection is not available on the scene"),null},t.set_outline_color=function(e){for(var t=Ve(n(),[Lt.OUTLINE]),r=0;r<t.length;r++){var a=t[r];a.outline_color.set(e),a.need_perm_uniforms_update=!0}},t.get_wind=ot,t.get_meta_tags=function(e){var t={title:"",description:""};return e.b4w_tags&&(t.title=e.b4w_tags.title,t.description=e.b4w_tags.description),t},t.get_custom_prop=function(e){return e.b4w_custom_prop},t.update_cube_reflect_subs=function(e,t){var r=lr;Ut.negate(t,r);for(var a=0;a<6;a++){var n=e.cube_view_matrices[a],_=e.cube_cam_frustums[a],s=e.camera;gt.translate(Dt.INV_CUBE_VIEW_MATRS[a],r,n),gt.multiply(s.proj_matrix,n,s.view_proj_matrix),Dt.extract_frustum_planes(s.view_proj_matrix,_)}},t.update_plane_reflect_subs=function(e,t,r){var a=e.camera;Dt.trans_quat_to_plane(t,r,Dt.AXIS_Z,a.reflection_plane)},t.assign_scene_data_subs=function(e,t,r){var a=e._render.reflection_params;if(a&&t)for(m=0;m<t.length;m++){var n=t[m],_=At.get_scene_data(n,e);if(-1!=n.render.plane_reflection_id){var s=a.plane_refl_subs,o=a.plane_refl_subs_blend,i=n.render.plane_reflection_id;o.length&&i<o.length?_.plane_refl_subs=o[i]:s.length&&i<s.length&&(_.plane_refl_subs=s[i])}else if(-1!=n.render.cube_reflection_id){var l=a.cube_refl_subs,c=a.cube_refl_subs_blend,i=n.render.cube_reflection_id;c.length?_.cube_refl_subs=c[i]:l.length&&(_.cube_refl_subs=l[i])}}if(r)for(var u=jt.ssao&&e.b4w_enable_ssao,d=At.get_shadow_lamps(r,u),f=e._render.shadow_params,m=0;m<d.length;m++)if(_=At.get_scene_data(d[m],e),f)for(var p=Ve(e,[Lt.SHADOW_CAST]),h=0;h<p.length;h++)m==p[h].shadow_lamp_index&&_.shadow_subscenes.push(p[h])},t.marker_frame=function(e,t){return e.timeline_markers[t]},t.set_hmd_params=function(e){var t=Xe(n(),Lt.STEREO);t&&(e.distortion_coefs&&(t.distortion_params[0]=e.distortion_coefs[0],t.distortion_params[1]=e.distortion_coefs[1],t.need_perm_uniforms_update=!0),e.chromatic_aberration_coefs&&(t.chromatic_aberration_coefs[0]=e.chromatic_aberration_coefs[0],t.chromatic_aberration_coefs[1]=e.chromatic_aberration_coefs[1],t.chromatic_aberration_coefs[2]=e.chromatic_aberration_coefs[2],t.chromatic_aberration_coefs[3]=e.chromatic_aberration_coefs[3],t.need_perm_uniforms_update=!0),e.base_line_factor&&(t.distortion_params[2]=e.base_line_factor,t.need_perm_uniforms_update=!0),e.inter_lens_factor&&(t.distortion_params[3]=e.inter_lens_factor,t.need_perm_uniforms_update=!0),null!=e.enable_hmd_stereo&&(t.enable_hmd_stereo=e.enable_hmd_stereo,t.need_perm_uniforms_update=!0))},t.multiply_size_mult=function(e,r){for(var a=_(),n=0;n<a.length;n++){var s=a[n],o=t.get_graph(s);Mt.multiply_size_mult_by_graph(o,e,r)}},t.update_all_mesh_shaders=function(e){for(var t=Et.get_scene_objs(e,"LAMP",Et.DATA_ID_ALL),r=Ve(e,Wt),a=0;a<r.length;a++)for(var n=r[a],_=n.draw_data,s=0;s<_.length;s++)for(var o=_[s].bundles,i=0;i<o.length;i++){var l=o[i],c=l.batch;"MAIN"==c.type&&(ct.update_batch_lights(c,t,e),ct.update_shader(c),Lt.append_draw_data(n,l))}},t.recalculate_draw_data=function(e){for(var t=0;t<$t.length;t++){var r=$t[t]._render.graph;ht.traverse(r,function(t,r){for(var a=r,n=a.draw_data,_=0;_<n.length;_++)for(var s=n[_].bundles,o=0;o<s.length;o++){var i=s[o];i.batch==e&&Lt.append_draw_data(a,i)}})}}}),z=o("__constraints",function(e,t){function r(e){return{type:e,obj_parent:null,target:null,use_offset:!1,tsr_restore:null,tsr_offset:null,euler_offset:null,axes:null,track_axis:null,vertical_axis:null,use_target_z:!1,influence:0,bone_name:"",softness:0,clamp_left:0,clamp_right:0,clamp_up:0,clamp_down:0,dist_min:0,dist_max:0,left_edge:!1,left_right_dist:0,top_edge:!1,top_bottom_dist:0,distance:0,hor_units:"",vert_units:""}}function a(e,t){e.constraint&&e.constraint.obj_parent&&_(e.constraint.obj_parent,e),t.obj_parent&&n(t.obj_parent,e),e.constraint=t}function n(e,t){-1==e.cons_descends.indexOf(t)?e.cons_descends.push(t):N.panic("Descendant object override is forbidden")}function _(e,t){var r=e.cons_descends.indexOf(t);-1!=r?e.cons_descends.splice(r,1):N.panic("No descendant object")}function s(e,t,n,_,s,o){var i=r(C);i.obj_parent=t,i.track_axis=new Float32Array(n),i.vertical_axis=new Float32Array(_),i.use_target_z=s,i.tsr_restore=new Float32Array(e.render.world_tsr),i.influence=o,a(e,i),p(e,i,0)}function o(e,t,n,_,s,o){var i=r(U);i.obj_parent=t,i.tsr_offset=k.create(),k.set_trans(n,i.tsr_offset),i.axes=new Float32Array(_),i.influence=o,i.use_offset=s,i.tsr_restore=new Float32Array(e.render.world_tsr),a(e,i),p(e,i,0)}function i(e,t,n,_,s){var o=r(F);o.obj_parent=t;var i=k.get_quat(e.render.world_tsr,$);o.euler_offset=N.quat_to_euler(i,new Float32Array(3)),o.axes=new Float32Array(n),o.influence=s,o.use_offset=_,o.tsr_restore=new Float32Array(e.render.world_tsr),a(e,o),p(e,o,0)}function c(e,t,n){var _=r(B);_.obj_parent=t,_.tsr_offset=k.create(),k.copy(e.render.world_tsr,_.tsr_offset),_.tsr_restore=new Float32Array(e.render.world_tsr),_.influence=n,a(e,_),p(e,_,0)}function u(e,t,n){var _=r(j);_.obj_parent=t,_.tsr_offset=new Float32Array(n),a(e,_),p(e,_,0)}function f(e,t,n,_){var s=r(z);s.obj_parent=t,s.bone_name=n,s.tsr_offset=new Float32Array(_),a(e,s),p(e,s,0)}function m(e,t,n){var _=r(q);if(_.obj_parent=t,_.tsr_restore=new Float32Array(e.render.world_tsr),_.tsr_offset=k.create(),N.isdef(n.right)?(_.left_edge=!1,_.left_right_dist=n.right):N.isdef(n.left)?(_.left_edge=!0,_.left_right_dist=n.left):(_.left_edge=!0,_.left_right_dist=0),N.isdef(n.bottom)?(_.top_edge=!1,_.top_bottom_dist=n.bottom):N.isdef(n.top)?(_.top_edge=!0,_.top_bottom_dist=n.top):(_.top_edge=!0,_.top_bottom_dist=0),N.isdef(n.distance)?_.distance=n.distance:_.distance=0,N.isdef(n.rotation))s=new Float32Array(n.rotation);else var s=M.create();k.set_quat(s,_.tsr_offset),N.isdef(n.hor_units)?_.hor_units=n.hor_units:_.hor_units="widths",N.isdef(n.vert_units)?_.vert_units=n.vert_units:_.vert_units="heights",a(e,_),p(e,_,0)}function p(e,t,r){switch(t.type){case S:k.multiply(t.obj_parent.render.world_tsr,t.tsr_offset,e.render.world_tsr);break;case G:var a=k.get_trans_view(e.render.world_tsr),n=k.get_quat_view(e.render.world_tsr),_=k.get_trans(t.tsr_offset,Z),s=t.obj_parent.render.world_tsr,o=k.get_quat_view(t.obj_parent.render.world_tsr);M.multiply(M.invert(t.parent_prev_rotation,t.parent_prev_rotation),n,n),M.multiply(o,n,n),k.transform_vec3(_,s,a),M.copy(o,t.parent_prev_rotation),w(e,t);break;case Y:var a=k.get_trans_view(e.render.world_tsr),n=k.get_quat_view(e.render.world_tsr),s=t.obj_parent.render.world_tsr,i=k.get_trans_view(s),l=t.softness,c=Z,u=M.copy(n,J),_=k.get_trans(t.tsr_offset,Q);k.transform_vec3(_,s,c),N.smooth_v(c,a,r,l,a),N.quat_rotate_to_target(a,u,i,N.AXIS_MZ),N.smooth_q(u,n,r,.16*l,n);break;case L:var n=k.get_quat_view(e.render.world_tsr),d=ee,_=k.get_trans(t.tsr_offset,Q),f=k.get_scale(t.tsr_offset),m=k.get_quat(t.tsr_offset,J);x.get_bone_tsr(t.obj_parent,t.bone_name,!0,!1,d),k.multiply(t.obj_parent.render.world_tsr,d,d),n[0]=d[4],n[1]=d[5],n[2]=d[6],n[3]=d[7],M.multiply(n,m,n),k.set_scale(f*d[3],e.render.world_tsr),a=k.get_trans_view(e.render.world_tsr),k.transform_vec3(_,d,a);break;case C:var a=k.get_trans_view(e.render.world_tsr),n=k.get_quat_view(e.render.world_tsr),p=k.get_trans_view(t.obj_parent.render.world_tsr),h=t.influence;if(t.use_target_z)var v=k.get_quat(t.obj_parent.render.world_tsr,J),b=I.transformQuat(N.AXIS_Z,v,Z);else b=N.AXIS_Z;N.quat_rotate_to_target(a,n,p,t.track_axis);var g=I.subtract(p,a,Q);I.normalize(g,g),N.quat_set_vertical_axis(n,t.vertical_axis,b,g),re=k.get_quat(t.tsr_restore,J),M.slerp(re,n,h,n),k.set_trans(a,t.tsr_restore);break;case P:var a=k.get_trans_view(e.render.world_tsr),n=k.get_quat_view(e.render.world_tsr),p=k.get_trans_view(t.obj_parent.render.world_tsr);N.quat_rotate_to_target(a,n,p,N.AXIS_MZ);var y=I.dist(a,p);if(y>t.dist_max)E=y-t.dist_max;else if(y<t.dist_min)E=y-t.dist_min;else var E=0;E&&(I.sub(p,a,Z),I.normalize(Z,Z),I.scale(Z,E,Z),I.add(a,Z,a));break;case D:var s=t.obj_parent.render.world_tsr,a=k.get_trans_view(e.render.world_tsr),_=k.get_trans(t.tsr_offset,Z);k.transform_vec3(_,s,a),k.set_quat(k.get_quat_view(e.render.world_tsr),t.tsr_restore);break;case U:var i=k.get_trans_view(t.obj_parent.render.world_tsr),a=k.get_trans_view(e.render.world_tsr),A=t.axes,T=k.get_trans(t.tsr_offset,Z),_=I.set(0,0,0,Q);t.use_offset&&I.add(_,T,_),h=t.influence,A[0]&&(a[0]=(1-h)*T[0]+h*(N.sign(A[0])*i[0]+_[0])),A[1]&&(a[1]=(1-h)*T[1]+h*(N.sign(A[1])*i[1]+_[1])),A[2]&&(a[2]=(1-h)*T[2]+h*(N.sign(A[2])*i[2]+_[2])),k.set_quat(k.get_quat_view(e.render.world_tsr),t.tsr_restore);break;case F:var A=t.axes,o=k.get_quat(t.obj_parent.render.world_tsr,J),O=N.quat_to_eul_opt(o,t.euler_offset,Q);if(N.compatible_euler(O,t.euler_offset),A[0]?(t.use_offset&&(W=I.set(t.euler_offset[0],0,0,Z),N.rotate_eul(O,W,O)),O[0]=N.sign(A[0])*O[0]):O[0]=t.euler_offset[0],A[1]?(t.use_offset&&(W=I.set(0,t.euler_offset[1],0,Z),N.rotate_eul(O,W,O)),O[1]=N.sign(A[1])*O[1]):O[1]=t.euler_offset[1],A[2]){if(t.use_offset){var W=I.set(0,0,t.euler_offset[2],Z);N.rotate_eul(O,W,O)}O[2]=N.sign(A[2])*O[2]}else O[2]=t.euler_offset[2];N.compatible_euler(O,t.euler_offset);var h=t.influence,V=N.euler_to_quat(O,J),X=k.get_quat(t.tsr_restore,$);M.slerp(X,V,h,k.get_quat_view(e.render.world_tsr)),k.set_trans(k.get_trans_view(e.render.world_tsr),t.tsr_restore);break;case B:var h=t.influence,i=k.get_trans(t.obj_parent.render.world_tsr,Z),o=k.get_quat(t.obj_parent.render.world_tsr,J),K=k.get_trans(t.tsr_offset,Q),re=k.get_quat(t.tsr_offset,$);N.blend_arrays(K,i,h,k.get_trans_view(e.render.world_tsr)),M.slerp(re,o,h,k.get_quat_view(e.render.world_tsr)),k.set_trans(k.get_trans_view(e.render.world_tsr),t.tsr_restore);break;case H:var n=k.get_quat_view(e.render.world_tsr),s=t.obj_parent.render.world_tsr,o=k.get_quat_view(t.obj_parent.render.world_tsr),_=k.get_trans(t.tsr_offset,Q),m=k.get_quat(t.tsr_offset,J);M.multiply(o,m,n),a=k.get_trans_view(e.render.world_tsr),k.transform_vec3(_,s,a);break;case j:var ae=t.obj_parent.render,ne=e.render;k.multiply(ae.world_tsr,t.tsr_offset,ne.world_tsr);break;case z:var _e=t.tsr_offset,d=ee;x.get_bone_tsr(t.obj_parent,t.bone_name,!0,!1,d),k.multiply(t.obj_parent.render.world_tsr,d,d),k.multiply(d,_e,e.render.world_tsr);break;case q:var se=t.obj_parent,oe=R.get_first_cam(se),a=k.get_trans_view(e.render.world_tsr),ie=R.get_edge(oe,"LEFT"),le=R.get_edge(oe,"RIGHT"),ce=R.get_edge(oe,"TOP"),ue=R.get_edge(oe,"BOTTOM");if("heights"==t.hor_units)de=ce-ue;else var de=le-ie;if(t.left_edge?a[0]=ie+de*t.left_right_dist:a[0]=le-de*t.left_right_dist,"heights"==t.vert_units)fe=ce-ue;else var fe=le-ie;if(t.top_edge?a[1]=ce-fe*t.top_bottom_dist:a[1]=ue+fe*t.top_bottom_dist,R.is_ortho(oe))a[2]=-t.distance;else{a[2]=-1,I.normalize(a,a);var me=t.distance/Math.abs(a[2]);I.scale(a,me,a)}k.transform_dir_vec3(a,se.render.world_tsr,a);var pe=k.get_trans_view(se.render.world_tsr);I.add(pe,a,a);var X=k.get_quat_view(e.render.world_tsr),he=k.get_quat_view(se.render.world_tsr),m=k.get_quat(t.tsr_offset,$);M.multiply(he,m,X)}if("CAMERA"==e.render.type&&e.render.move_style!=R.MS_STATIC){var ve=e.render.vertical_axis;t.type==G&&(o=k.get_quat_view(t.obj_parent.render.world_tsr),ve=I.transformQuat(ve,o,te)),R.update_camera_upside_down(e),R.correct_up(e,ve)}}function b(e,t,a,n,_,s){var o=r(V);o.bone_name=a,o.target=t,o.tsr_offset=k.create(),k.set_trans(new Float32Array(n),o.tsr_offset),k.set_quat(new Float32Array(_),o.tsr_offset),k.set_scale(s,o.tsr_offset),g(e,o),E(e,o)}function g(e,t){var r=t.target,a=t.bone_name,n=e.render.bone_pointers[a];y(r,e,a),r.cons_armat_bone_descends.push([e,a]),n.constraint=t}function y(e,t,r){for(var a=e.cons_armat_bone_descends,n=0;n<a;n++){var _=a[n];if(_[0]==t&&_[1]==r)return void a.splice(n,1)}}function E(e,t){switch(t.type){case V:var r=t.target.render.world_tsr,a=e.render.world_tsr,n=ee;k.invert(a,n),k.multiply(n,r,n),x.set_bone_tsr(e,t.bone_name,n,!1)}e.need_update_transform=!0}function w(e,t){var r=k.get_quat_view(e.render.world_tsr),a=k.get_quat_view(t.obj_parent.render.world_tsr),n=k.get_quat(t.tsr_offset,$),_=M.multiply(a,n,J),s=R.get_camera_angles_from_quat(_,X),o=R.get_camera_angles_from_quat(r,K),i=N.calc_returning_angle(o[0],s[0]+t.clamp_right,s[0]+t.clamp_left),l=N.calc_returning_angle(o[1],s[1]+t.clamp_down,s[1]+t.clamp_up);N.rotate_quat(r,e.render.vertical_axis,i,l,r)}function A(e,t){for(var r=0;r<e.length;r++){var a=e[r];if(!A(a.cons_descends,t)||a.name==t.name)return!1}return!0}var T=W(e),x=O(e),R=ue(e),k=v(e),N=h(e),M=d(e),I=l(e),S=1,L=2,C=3,P=5,D=7,U=8,F=9,B=11,G=12,j=13,z=14,Y=15,H=16,q=17,V=18;t.CONS_TYPE_STIFF_OBJ=S,t.CONS_TYPE_STIFF_BONE=L,t.CONS_TYPE_TRACK_OBJ=C,t.CONS_TYPE_FOLLOW_OBJ=P,t.CONS_TYPE_STIFF_TRANS_OBJ=D,t.CONS_TYPE_COPY_LOC_OBJ=U,t.CONS_TYPE_SEMI_STIFF_OBJ=G,t.CONS_TYPE_CHILD_OF=j,t.CONS_TYPE_CHILD_OF_BONE=z,t.CONS_TYPE_SEMI_SOFT_OBJ=Y,t.CONS_TYPE_STIFF_TRANS_ROT_OBJ=H,t.CONS_TYPE_STIFF_VIEWPORT=q,t.BONE_CONS_TYPE_STIFF_OBJ=V;var X=new Float32Array(2),K=new Float32Array(2),Z=new Float32Array(3),Q=new Float32Array(3),J=new Float32Array(4),$=new Float32Array(4),ee=k.create(),te=new Float32Array(3);t.append_stiff_obj=function(e,t,n,_,s){var o=r(S);o.obj_parent=t,o.tsr_offset=k.create(),_=_||M.create(),k.set_trans(n,o.tsr_offset),k.set_scale(s,o.tsr_offset),k.set_quat(_,o.tsr_offset),o.tsr_restore=new Float32Array(e.render.world_tsr),a(e,o),p(e,o,0)},t.append_stiff_bone=function(e,t,n,_,s,o){var i=r(L);i.obj_parent=t,i.bone_name=n,i.tsr_restore=new Float32Array(e.render.world_tsr),i.tsr_offset=k.create(),k.set_trans(new Float32Array(_),i.tsr_offset),k.set_quat(new Float32Array(s),i.tsr_offset),k.set_scale(o,i.tsr_offset),a(e,i),p(e,i,0)},t.append_semi_stiff_obj=function(e,t,n,_,s,o,i,l){var c=r(G),u=k.get_quat_view(e.render.world_tsr),d=k.get_quat_view(t.render.world_tsr);_?(M.copy(_,u),M.multiply(d,u,u)):_=M.create(),c.obj_parent=t,c.tsr_offset=k.create(),k.set_trans(n,c.tsr_offset),k.set_quat(_,c.tsr_offset),c.parent_prev_rotation=new Float32Array(d),c.clamp_left=N.angle_wrap_0_2pi(s),c.clamp_right=N.angle_wrap_0_2pi(o),c.clamp_up=N.angle_wrap_periodic(i,-Math.PI,Math.PI),c.clamp_down=N.angle_wrap_periodic(l,-Math.PI,Math.PI),c.tsr_restore=new Float32Array(e.render.world_tsr),a(e,c),p(e,c,0)},t.append_semi_soft_obj=function(e,t,n,_){var s=r(Y);s.obj_parent=t,s.softness=_,s.tsr_restore=new Float32Array(e.render.world_tsr),s.tsr_offset=k.create(),k.set_trans(new Float32Array(n),s.tsr_offset),a(e,s),p(e,s,0)},t.append_stiff_trans_rot_obj=function(e,t,n,_,s){var o=r(H);o.obj_parent=t,o.tsr_restore=new Float32Array(e.render.world_tsr),o.tsr_offset=k.create(),k.set_trans(new Float32Array(n),o.tsr_offset),k.set_quat(new Float32Array(_),o.tsr_offset),k.set_scale(s,o.tsr_offset),a(e,o),p(e,o,0)},t.remove_parent_descendant=_,t.append_track_obj=s,t.append_follow_obj=function(e,t,n,_){var s=r(P);s.obj_parent=t,s.dist_min=n,s.dist_max=_,s.tsr_restore=new Float32Array(e.render.world_tsr),a(e,s),p(e,s,0)},t.append_stiff_trans_obj=function(e,t,n){var _=r(D);_.obj_parent=t,_.tsr_offset=k.create(),_.tsr_restore=new Float32Array(e.render.world_tsr),k.set_trans(new Float32Array(n),_.tsr_offset),a(e,_),p(e,_,0)},t.append_copy_loc_obj=o,t.append_copy_rot_obj=i,t.append_copy_trans_obj=c,t.append_child_of=u,t.append_child_of_bone=f,t.append_stiff_viewport=m,t.update_constraint=function(e,t){e.constraint&&p(e,e.constraint,t)},t.update_bone_constraint=function(e,t){var r=e.render.bone_pointers[t];r.constraint&&E(e,r.constraint)},t.check_constraint=function(e){return!!e.constraint},t.remove=function(e,t){e.constraint.obj_parent&&_(e.constraint.obj_parent,e),t&&k.copy(e.constraint.tsr_restore,e.render.world_tsr),e.constraint=null},t.get_type=function(e){return e.constraint?e.constraint.type:null},t.has_child_of=function(e){var t=e.constraint;return!(!t||t.type!=j&&t.type!=z)},t.get_child_of_parent_tsr=function(e){var t=e.constraint;if(t&&t.type==j)return t.obj_parent.render.world_tsr;if(t&&t.type==z){var r=ee;return x.get_bone_tsr(t.obj_parent,t.bone_name,!0,!1,r),k.multiply(t.obj_parent.render.world_tsr,r,r),r}return null},t.get_child_of_offset=function(e){var t=e.constraint;return!t||t.type!=j&&t.type!=z?null:t.tsr_offset},t.prepare_object_relations=function(e,t){for(var r=t.render,a=0;a<e.constraints.length;a++){var n=e.constraints[a],_=n.type;if(n.target){var l=n.target._object;if("COPY_LOCATION"==_)o(t,l,new Float32Array(k.get_trans_view(t.render.world_tsr)),d=new Float32Array(n.axes),n.use_offset,n.influence);else if("COPY_ROTATION"==_){var d=new Float32Array(n.axes);i(t,l,d,n.use_offset,n.influence)}else if("COPY_TRANSFORMS"==_)c(t,l,n.influence);else if("TRACK_TO"==_){var p=n.track_axis;if("TRACK_Y"==p)h=N.AXIS_Y;else if("TRACK_NEGATIVE_Y"==p)h=N.AXIS_MY;else if("TRACK_X"==p)h=N.AXIS_X;else if("TRACK_NEGATIVE_X"==p)h=N.AXIS_MX;else if("TRACK_Z"==p)h=N.AXIS_Z;else if("TRACK_NEGATIVE_Z"==p)var h=N.AXIS_MZ;var v=n.up_axis;if("UP_X"==v)g=N.AXIS_X;else if("UP_Y"==v)g=N.AXIS_Y;else if("UP_Z"==v)var g=N.AXIS_Z;s(t,l,h,g,n.use_target_z,n.influence)}}}if(t.parent){!t.parent_is_dupli&&t.physics_settings.use_collision_compound&&t.parent.physics_settings.use_collision_compound&&(t.use_obj_physics=!1);for(var y=!1,a=0;a<t.scenes_data.length;a++)if(t.scenes_data[a].scene._physics){y=!0;break}if(y&&T.has_dynamic_settings(t))w=t.parent_is_dupli?k.copy(r.world_tsr,k.create()):r.world_tsr,k.multiply(t.parent.render.world_tsr,w,r.world_tsr);else if(t.parent_is_dupli||!t.parent_bone)if(w=k.copy(r.world_tsr,k.create()),t.viewport_alignment&&"CAMERA"==t.parent.type){var E={distance:t.viewport_alignment.distance,rotation:k.get_quat_view(w)};switch(t.viewport_alignment.alignment){case"TOP_LEFT":E.top=0,E.left=0;break;case"TOP":E.top=0,E.left=.5;break;case"TOP_RIGHT":E.top=0,E.right=0;break;case"LEFT":E.top=.5,E.left=0;break;case"CENTER":E.top=.5,E.left=.5;break;case"RIGHT":E.top=.5,E.right=0;break;case"BOTTOM_LEFT":E.bottom=0,E.left=0;break;case"BOTTOM":E.bottom=0,E.left=.5;break;case"BOTTOM_RIGHT":E.bottom=0,E.right=0}m(t,t.parent,E)}else u(t,t.parent,w);else{var w=k.copy(r.world_tsr,k.create());f(t,t.parent,t.parent_bone,w)}}if("ARMATURE"==t.type)for(var A=e.pose.bones,a=0;a<A.length;a++){var x=A[a],O=x.constraints;if(O)for(var R=0;R<O.length;R++){var M=O[R];"COPY_TRANSFORMS"!=M.type||M.subtarget||M.mute||b(t,l=M.target._object,x.name,N.VEC3_IDENT,N.QUAT4_IDENT,1)}}},t.check_compatibility=function(e,t){return A(e.cons_descends,t)},t.check_self_applying=function(e,t){return e.name!=t.name}}),Y=o("__transform",function(e,t){function r(e,t){if(f.has_child_of(e)){var r=f.get_child_of_offset(e);w.set_trans(t,r)}else{var a=e.render;w.set_trans(t,a.world_tsr)}}function a(e,t){var r=e.render;if(f.has_child_of(e)){w.set_quat(t,r.world_tsr);var a=f.get_child_of_parent_tsr(e),n=w.invert(a,M),_=f.get_child_of_offset(e);w.multiply(n,r.world_tsr,_)}else w.set_quat(t,r.world_tsr)}function n(e,t){if(f.has_child_of(e)){var r=f.get_child_of_offset(e);w.set_quat(t,r)}else w.set_quat(t,e.render.world_tsr)}function _(e,t){return w.get_quat(e.render.world_tsr,t),t}function s(e,t){if(f.has_child_of(e)){var r=f.get_child_of_offset(e);w.get_quat(r,t)}else w.get_quat(e.render.world_tsr,t);return t}function o(e,t){if(f.has_child_of(e)){var r=f.get_child_of_offset(e);w.copy(t,r)}else w.copy(t,e.render.world_tsr)}function i(e,t){if(f.has_child_of(e)){var r=f.get_child_of_offset(e);w.copy(r,t)}else w.copy(e.render.world_tsr,t);return t}function c(e){var t=e.render,r=e.scenes_data,a=e.type;for("CAMERA"==a&&d.update_camera_upside_down(e),f.update_constraint(e,S),"CAMERA"==a&&d.update_camera(e),u.bounding_box_transform(t.bb_local,t.world_tsr,t.bb_world),u.bounding_sphere_transform(t.bs_local,t.world_tsr,t.bs_world),v=0;v<r.length;v++)for(var n=r[v].batches,_=0;_<n.length;_++){var s=n[_],o=r[v].batch_world_bounds[_];g.update_world_bounds_from_batch_tsr(s,t.world_tsr,o)}switch(a){case"MESH":if(e.need_inv_zup_tsr&&w.invert(e.render.world_tsr,e.render.world_tsr_inv),F=e.armobj){var i=F.render.world_tsr;w.invert(i,M),w.multiply(M,t.world_tsr,M),w.get_transcale(M,t.arm_rel_trans),w.get_quat(M,t.arm_rel_quat)}t.force_zsort=!0;break;case"CAMERA":for(v=0;v<r.length;v++)d.update_camera_transform(e,r[v]);break;case"SPEAKER":E.speaker_update_transform(e,S,L);break;case"LAMP":m.update_light_transform(e)}for(var l=w.get_trans(t.world_tsr,x),h=w.get_quat(t.world_tsr,N),v=0;v<r.length;v++){var b=r[v];if(b.is_active){var A=b.scene,T=A._render,n=b.batches;switch(a){case"MESH":t.shadow_cast&&y.schedule_shadow_update(A);var O=b.cube_refl_subs;null!=t.cube_reflection_id&&O&&y.update_cube_reflect_subs(O,l);break;case"EMPTY":p.update_force(e);break;case"CAMERA":if(y.get_active()==A&&y.get_camera(A)==e){if(y.schedule_grass_map_update(A),T.shadow_params){(T.shadow_params.enable_csm||T.shadow_params.dynamic_grass_cast)&&y.schedule_shadow_update(A);var R=g.get_scene_data(e,A).cameras[0];y.update_shadow_billboard_view(R,T.graph)}E.listener_update_transform(A,l,h,S,L)}break;case"LAMP":y.update_lamp_scene(e,A)}var k=b.plane_refl_subs,I=e.reflective_objs;if(I.length)for(_=0;_<k.length;_++){var C=k[_].camera;y.update_plane_reflect_subs(k[_],l,h),g.update_refl_objects(I,C.reflection_plane),d.set_view(C,y.get_camera(A))}}}for(var P=e.cons_descends,v=0;v<P.length;v++)c(P[v]);for(var D=e.cons_armat_bone_descends,v=0;v<D.length;v++){var U=D[v],F=U[0],B=U[1];f.update_bone_constraint(F,B)}}var u=b(e),d=ue(e),f=z(e),m=R(e),p=$(e),g=k(e),y=j(e),E=D(e),w=v(e),A=h(e),T=l(e),x=new Float32Array(3),O=new Float32Array(3),N=new Float32Array(4),M=w.create(),I=w.create(),S=0,L=0;t.update=function(e){S=e,L++},t.set_translation=function(e,t){var r=e.render;if(f.has_child_of(e)){w.set_trans(t,r.world_tsr);var a=f.get_child_of_parent_tsr(e),n=w.invert(a,M),_=f.get_child_of_offset(e);w.multiply(n,r.world_tsr,_)}else w.set_trans(t,r.world_tsr)},t.set_translation_rel=r,t.get_translation=function(e,t){return w.get_trans(e.render.world_tsr,t),t},t.get_translation_rel=function(e,t){if(f.has_child_of(e)){var r=f.get_child_of_offset(e);w.get_trans(r,t)}else w.get_trans(e.render.world_tsr,t);return t},t.set_rotation=a,t.set_rotation_rel=n,t.get_rotation=_,t.get_rotation_rel=s,t.set_rotation_euler=function(e,t){a(e,A.euler_to_quat(t,N))},t.set_rotation_euler_rel=function(e,t){n(e,A.euler_to_quat(t,N))},t.get_rotation_euler=function(e,t){var r=_(e,N);return t=A.quat_to_euler(r,t)},t.get_rotation_euler_rel=function(e,t){var r=s(e,N);return t=A.quat_to_euler(r,t)},t.set_scale=function(e,t){var r=e.render;if(f.has_child_of(e)){var a=f.get_child_of_offset(e),n=w.get_scale(f.get_child_of_parent_tsr(e));w.set_scale(t/n,a)}else w.set_scale(t,r.world_tsr)},t.set_scale_rel=function(e,t){var r=e.render;if(f.has_child_of(e)){var a=f.get_child_of_offset(e);w.set_scale(t,a)}else w.set_scale(t,r.world_tsr)},t.get_scale=function(e){return w.get_scale(e.render.world_tsr)},t.get_scale_rel=function(e){if(f.has_child_of(e)){var t=f.get_child_of_offset(e);return w.get_scale(t)}return w.get_scale(e.render.world_tsr)},t.set_tsr=function(e,t){if(w.copy(t,e.render.world_tsr),f.has_child_of(e)){var r=f.get_child_of_parent_tsr(e),a=w.invert(r,M),n=f.get_child_of_offset(e);w.multiply(a,e.render.world_tsr,n)}},t.set_tsr_rel=o,t.get_tsr=function(e,t){return w.copy(e.render.world_tsr,t)},t.get_tsr_rel=i,t.get_object_size=function(e){var t=e.render,r=t.bb_original,a=w.get_scale(t.world_tsr),n=a*(r.max_x-r.min_x),_=a*(r.max_y-r.min_y),s=a*(r.max_z-r.min_z);return.5*Math.sqrt(n*n+_*_+s*s)},t.get_object_center=function(e,t,r){if(t){var a=e.render;T.copy(a.bs_world.center,r)}else{var n=(a=e.render).bb_original;r[0]=(n.max_x+n.min_x)/2,r[1]=(n.max_y+n.min_y)/2,r[2]=(n.max_z+n.min_z)/2,w.transform_vec3(r,a.world_tsr,r)}return r},t.move_local=function(e,t,a,n){var _=i(e,M),s=x;s[0]=t,s[1]=a,s[2]=n,w.transform_vec3(s,_,s),r(e,s)},t.rotate_local=function(e,t){var r=i(e,M),a=w.set_quat(t,w.identity(I));w.multiply(r,a,a),o(e,a)},t.update_transform=c,t.distance=function(e,t){var r=w.get_trans(e.render.world_tsr,x),a=w.get_trans(t.render.world_tsr,O);return T.dist(r,a)},t.obj_point_distance=function(e,t){var r=w.get_trans(e.render.world_tsr,x);return T.dist(r,t)}}),H=o("__navmesh",function(e,t){function r(e){var t,r,a,n,_,s,o={},i=[],l=[],c=Math.pow(10,4);for(a=0,n=e.vertices.length;a<n;a++)t=e.vertices[a],void 0===o[r=Math.round(t[0]*c)+"_"+Math.round(t[1]*c)+"_"+Math.round(t[2]*c)]?(o[r]=a,i.push(t),l[a]=i.length-1):l[a]=l[o[r]];var u=[];for(a=0,n=e.faces.length;a<n;a++){(_=e.faces[a]).indices[0]=l[_.indices[0]],_.indices[1]=l[_.indices[1]],_.indices[2]=l[_.indices[2]],s=[_.indices[0],_.indices[1],_.indices[2]];for(var d=0;d<3;d++)if(s[d]==s[(d+1)%3]){u.push(a);break}}for(a=u.length-1;a>=0;a--){var f=u[a];e.faces.splice(f,1)}var m=e.vertices.length-i.length;for(e.vertices.length=0,a=0;a<i.length;a++)e.vertices.push(i[a]);return m}function a(e,t){return e>t?t+"-"+e:e+"-"+t}function n(e){for(var t=[],r=e.vertices,n=0,_=0;_<e.faces.length;_++){var s=e.faces[_];t.push({id:n++,vertex_ids:s.indices,centroid:s.centroid,normal:s.normal,neighbours:[]})}for(var o={polygons:t,vertices:r},i={},_=0;_<t.length;_++)for(d=0;d<3;d++)(u=a(t[_].vertex_ids[d],t[_].vertex_ids[(d+1)%3]))in i||(i[u]=[]),i[u].push(t[_]);for(var l=Object.keys(i),_=0,c=l.length;_<c;_++)for(var u=l[_],d=0;d<i[u].length;d++)for(var f=d+1;f<i[u].length;f++)i[u][d].neighbours.push(i[u][f]),i[u][f].neighbours.push(i[u][d]);return o}function _(e){var t,r;for(t=0;t<e.faces.length;t++)r=e.faces[t],U.add(e.vertices[r.indices[0]],e.vertices[r.indices[1]],B),U.add(B,e.vertices[r.indices[2]],B),U.scale(B,1/3,r.centroid)}function s(e){for(var t=0;t<e.faces.length;t++){var r=e.faces[t],a=U.subtract(e.vertices[r.indices[1]],e.vertices[r.indices[0]],B),n=U.subtract(e.vertices[r.indices[2]],e.vertices[r.indices[0]],G),_=U.cross(a,n,B);U.normalize(_,_),U.copy(_,r.normal)}}function o(e){return _(e),s(e),r(e),n(e)}function u(e,t){return parseFloat(e.toFixed(t))}function d(e){for(var t=e.polygons,r=[],a=0,n=function(e){for(var t=e.neighbours,r=0;r<t.length;r++){var a=t[r];void 0==a.island&&(a.island=e.island,n(a))}},_=0;_<t.length;_++){var s=t[_];void 0==s.island&&(s.island=a++,n(s)),r[s.island]||(r[s.island]=[]),r[s.island].push(t[_])}return r}function m(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0;r<e.length;r++)if(e[r]==t)return r;return-1}function p(e){for(var t={},r=e.vertices,a=0;a<r.length;a++)r[a][0]=u(r[a][0],2),r[a][1]=u(r[a][1],2),r[a][2]=u(r[a][2],2);t.vertices=e.vertices;var n=d(e);t.islands=[];for(var _=function(e,t){for(var r=0;r<e.length;r++)if(t===e[r])return r},a=0;a<n.length;a++){for(var s=[],o=n[a],i=0;i<o.length;i++){for(var l=[],c=o[i],f=0;f<c.neighbours.length;f++)l.push(_(o,c.neighbours[f]));for(var m=[],f=0;f<c.neighbours.length;f++)m.push(J(c,c.neighbours[f]));c.centroid[0]=u(c.centroid[0],2),c.centroid[1]=u(c.centroid[1],2),c.centroid[2]=u(c.centroid[2],2),s.push({id:_(o,c),neighbours:l,vertex_ids:c.vertex_ids,centroid:c.centroid,normal:c.normal,portals:m,f:0,g:0,h:0,cost:1,visited:!1,closed:!1,parent:null})}t.islands.push(s)}return t}function v(e,t,r,a,n,_){function s(e,t){return U.subtract(e,t,B),U.dot(B,B)}!function(e){for(var t=0;t<e.length;t++){var r=e[t];r.f=0,r.g=0,r.h=0,r.cost=1,r.visited=!1,r.closed=!1,r.parent=null}}(e);var o=C.binary_heap_new(function(e){return e.f});for(C.binary_heap_push(o,t);o.content.length>0;){var i=C.binary_heap_pop(o);if(i===r){for(var l=i,c=[];l.parent;)c.push(l),l=l.parent;return c.push(t),c.reverse()}i.closed=!0;for(var u=function(e,t){for(var r=[],a=0;a<t.neighbours.length;a++)r.push(e[t.neighbours[a]]);return r}(e,i),d=0,f=u.length;d<f;d++){var m=u[d];if(!m.closed){var p=i.g+U.dist(m.centroid,i.centroid),h=m.visited;(!h||p<m.g)&&(m.visited=!0,m.parent=i,m.h=m.h||s(m.centroid,n)+s(m.centroid,a),m.g=p,m.f=m.g+m.h,h?C.binary_heap_rescore_element(o,m):C.binary_heap_push(o,m))}}}return[]}function b(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function g(e,t,r,a){var n=U.subtract(t,e,B),_=U.subtract(r,e,G),s=U.cross(n,_,B);return D.sign(U.dot(a,s))}function y(e,t){return U.subtract(e,t,B),U.dot(B,B)<1e-5}function E(e,t,r){var a=U.subtract(t.right,t.left,B),n=r.normal,_=t.normal,s=Math.acos(U.dot(n,_));s*=-D.sign(U.dot(a,U.cross(n,_,G)));var o=P.identity(q);return P.translate(o,t.left,o),P.rotate(o,s,a,o),P.translate(o,U.scale(t.left,-1,G),o),P.multiply(e,o,e),e}function A(e,t,r,a,n,_,s){var o=U.transformMat4(r,_,j);o[3]=1;var i=U.transformMat4(a,_,B),l=U.subtract(i,o,z),c=U.subtract(t,e,B),u=U.cross(n,c,Y);if(Math.abs(U.dot(u,l))<.01)d=.5;else{U.normalize(u,u),u[3]=-U.dot(u,t);var d=-F.dot(u,o)/F.dot(u,l)}var f=U.subtract(a,r,B);return U.scaleAndAdd(r,f,d,s)}function T(e,t,r,a,n,_,s,o,i){for(var l=P.identity(H),c=n;c<r;c++)e[c].is_crucial&&(c>n||!c)&&(b(s,A(t,a,e[c].left,e[c].right,_,l,U.create())),o&&b(i,e[c].normal),c&&E(l,e[c],e[c-1]))}function x(e,t){function r(t,r){d=u=r,f=u,n=a=t,_=a,U.copy(t,s),U.copy(t,o),U.copy(e[u].normal,i)}var a,n,_,s,o,i,l=[],c=[],u=0,d=0,f=0;a=e[0].right,n=e[0].left,_=e[0].right,s=U.copy(n,V),o=U.copy(_,X),i=U.copy(e[0].normal,Q),b(l,a),t&&b(c,e[0].normal);for(var m=P.identity(W),p=1;p<e.length;p++){var h=e[p].left,v=e[p].right,w=U.transformMat4(h,m,K),A=U.transformMat4(v,m,Z);if(e[p].is_crucial&&E(m,e[p],e[p-1]),g(a,o,A,i)<=0){if(!((O=y(a,_))||g(a,s,A,i)>0)){var x=y(s,a);x||T(e,s,d,a,u,i,l,t,c),m=P.identity(m),r(n,d),p=u,x||(b(l,a),t&&b(c,e[p].normal));continue}_=v,U.copy(A,o),f=p}if(g(a,s,w,i)>=0){var O=y(a,n);if(!(O||g(a,o,w,i)<0)){var R=y(o,a);R||T(e,o,f,a,u,i,l,t,c),m=P.identity(m),r(_,f),p=u,R||(b(l,a),t&&b(c,e[p].normal));continue}n=h,U.copy(w,s),d=p}}var k=e.length-1,N=e[k].left,M=y(a,N);return M||T(e,s,k,a,u,i,l,t,c),M&&u||b(l,N),t?(b(c,e[k].normal),{positions:new Float32Array(l),normals:new Float32Array(c)}):{positions:new Float32Array(l),normals:null}}function O(e,t){for(var r=!1,a=-1,n=e.length,_=n-1;++a<n;_=a)(e[a][1]<=t[1]&&t[1]<e[_][1]||e[_][1]<=t[1]&&t[1]<e[a][1])&&t[0]<(e[_][0]-e[a][0])*(t[1]-e[a][1])/(e[_][1]-e[a][1])+e[a][0]&&(r=!r);return r}function R(e,t,r,a,n){for(var _=null,s=Number.MAX_VALUE,o=0;o<e.length;o++){var i=e[o],l=n(r,i.centroid,i.vertex_ids,t,s);l<s&&(_=i,s=l)}return a>0&&s>a?null:_}function k(e,t){for(var r=0;r<e.neighbours.length;r++)if(e.neighbours[r]===t.id)return e.portals[r]}function N(e,t,r,a,n){e.push({left:t,right:r,is_crucial:a,normal:n})}function M(e,t,r,a,n){var _=[];N(_,t,t,!1,e[0]&&e[0].normal||D.AXIS_Z);for(var s=0;s<e.length;s++){var o=e[s],i=e[s+1];if(i){var l=Math.abs(U.dot(o.normal,i.normal))<.999,c=k(o,i);N(_,a[c[0]],a[c[1]],l,i.normal)}}return N(_,r,r,!1,_[_.length-1].normal),x(_,n)}function I(e,t){if(t){for(var r=new Float32Array(3*e.length),a=0;a<e.length;a++)r.set(e[a].centroid,3*a);return{positions:r,normals:null}}for(var n=new Float32Array(3*e.length),_=new Float32Array(3*e.length),a=0;a<e.length;a++)n.set(e[a].centroid,3*a),_.set(e[a].normal,3*a);return{positions:n,normals:_}}function S(e,t,r,a){var n=a.island,_=e.islands[n],s=e.vertices,o=R(_,s,t,a.allowed_distance,a.distance_to_closest);if(!o)return null;var i=R(_,s,r,a.allowed_distance,a.distance_to_farthest);return i?v(_,o,i,t,r,s):null}var L=w(e),C=f(e),P=i(e),D=h(e),U=l(e),F=c(e),B=U.create(),G=U.create(),j=F.create(),z=F.create(),Y=F.create(),H=P.create(),W=P.create(),q=P.create(),V=U.create(),X=U.create(),K=U.create(),Z=U.create(),Q=U.create(),J=function(e,t){function r(e){var t=e[0];e[0]=e[1],e[1]=e[2],e[2]=t}for(var a=e.vertex_ids,n=t.vertex_ids,_=[],s=0;s<a.length;s++)m(n,a[s])>=0&&_.push(a[s]);if(_.length<2)return[];for(m(_,a[0])>=0&&m(_,a[a.length-1])>=0&&r(a),m(_,n[0])>=0&&m(_,n[n.length-1])>=0&&r(n),_=[],s=0;s<a.length;s++)m(n,a[s])>=0&&_.push(a[s]);return _};t.navmesh_build_from_bufs_data=function(e){for(var t=L.get_vbo_source_by_type(e.vbo_source_data,L.VBO_FLOAT),r=e.ibo_array,a=[],n=0;n<r.length;n+=3)a.push({indices:new Uint32Array([r[n],r[n+1],r[n+2]]),centroid:new Float32Array(3),normal:new Float32Array(3)});for(var _=[],n=0;n<t.length;n+=3){var s=new Float32Array(3);s[0]=t[n],s[1]=t[n+1],s[2]=t[n+2],_.push(s)}return p(o({vertices:_,faces:a}))},t.navmesh_get_island=function(e,t,r){for(var a=null,n=Number.MAX_VALUE,_=e.islands,s=0;s<_.length;s++)for(var o=0;o<_[s].length;o++){var i=_[s][o];U.subtract(i.centroid,t,B);var l=r(t,i.centroid,i.vertex_ids,e.vertices,n);l<n&&(a=s,n=l)}return a},t.is_vector_in_poly=function(e,t,r){for(var a=[],n=0;n<t.length;n++){var _=t[n];a.push(r[_])}return!!O(a,e)},t.navmesh_find_path=function(e,t,r,a){var n=S(e,t,r,a);return n&&n.length?a.do_not_pull_string?I(n,a.return_normals):M(n,t,r,e.vertices,a.return_normals):null}}),W=o("__physics",function(e,t){function r(e,t){for(var a=e.cons_descends,n=0;n<a.length;n++)a[n].physics_settings.use_collision_compound&&t.push(a[n]),r(a[n],t);return null}function a(e,t,r){for(var a=e._physics.bundles,n=0;n<a.length;n++)for(var _=a[n].physics,s=0;s<_.collision_tests.length;s++){var o=_.collision_tests[s];"ANY"!=o.collision_id&&r!=o.collision_id||oe(o,e,t)}}function n(e,t){for(var r=e._physics.bundles,a=0;a<r.length;a++){var n=r[a].batch;if(n&&n.id==t.id)return!0}return!1}function _(e,t,r){if(ke.is_active(e))switch(t){case ke.IN_LOADED:(d=s(e))._physics.worker_loaded=!0;var a=Date.now()-performance.now();ke.post_msg(e,ke.OUT_INIT,a,Ge.max_fps,Ge.calc_fps?je.fps_measurement_interval:0);break;case ke.IN_LOG:Me.log_raw("URANIUM:",r.slice(1));break;case ke.IN_ERROR:Me.error(r);break;case ke.IN_FBMSG:Re.fbmsg.apply(this,r.slice(1));break;case ke.IN_TRANSFORM:(o=i(r.body_id))&&c(o,r.time,r.trans,r.quat,r.linvel,r.angvel);break;case ke.IN_PROP_OFFSET:var n=i(r.chassis_hull_body_id);n&&u(n,r.prop_ind,r.trans,r.quat);break;case ke.IN_FLOATER_BOB_TRANSFORM:var _=i(r[1]);_&&f(_,r[2],r[3],r[4]);break;case ke.IN_VEHICLE_SPEED:(o=i(r[1]))&&(o.vehicle.speed=r[2]);break;case ke.IN_COLLISION:p(d=s(e),r.body_id_a,r.body_id_b,r.result,null,null,0);break;case ke.IN_COLLISION_POS_NORM:p(d=s(e),r.body_id_a,r.body_id_b,r.result,r.coll_point,r.coll_norm,r.coll_dist);break;case ke.IN_COLLISION_IMPULSE:var o=i(r[1]);if(o){var l=o.physics;l.col_imp_test_cb&&l.col_imp_test_cb(r[2])}break;case ke.IN_RAY_HIT:case ke.IN_RAY_HIT_POS_NORM:var d=s(e),m=d._physics.ray_tests[r.id];if(m){var h=i(r.body_id_hit);t==ke.IN_RAY_HIT?E(m,r.hit_fract,h,r.hit_time,null,null):E(m,r.hit_fract,h,r.hit_time,r.hit_pos,r.hit_norm)}break;case ke.IN_REMOVE_RAY_TEST:pe(r.id);break;case ke.IN_PING:var v=He.indexOf(e),b=(r[2]-r[1]).toFixed(3),g=(performance.now()-r[2]).toFixed(3),y=(performance.now()-r[1]).toFixed(3);Me.log("Physics #"+v+" Ping: OUT "+b+" ms, IN "+g+" ms, ALL "+y+" ms");break;case ke.IN_FPS:Ye=r[1];break;case ke.IN_DEBUG_STATS:v=He.indexOf(e),Me.log("Worker: #"+String(v)),Me.log(r[1]);break;default:Me.error("Wrong message: "+t)}}function s(e){for(var t=0;t<He.length;t++)if(He[t]==e)return We[t]}function o(e){for(var t=0;t<We.length;t++)if(We[t]==e)return He[t]}function i(e){return qe[e]||null}function c(e,t,r,a,n,_){var s=e.physics;s.curr_time=t;var o=Pe.get_scale(e.render.world_tsr);Pe.set_sep(r,o,a,s.curr_tsr),Ue.copy(n,s.linvel),Ue.copy(_,s.angvel)}function u(e,t,r,a){var n=e.vehicle.prop_offsets[t];Pe.set_sep(r,1,a,n)}function f(e,t,r,a){var n=e.floater.bobs[t];Ce.set_translation(n,r),Ce.set_rotation(n,a),Ce.update_transform(n)}function p(e,t,r,a,n,_,s){for(var o=e._physics.bundles,l=0;l<o.length;l++)for(var c=o[l].physics,u=0;u<c.collision_tests.length;u++){for(var d=c.collision_tests[u],f=d.pairs,m=!1,p=0;p<f.length;p++){var h=f[p];if(h[0]===t&&h[1]===r){d.pair_results[p]=a,m=!0;break}}if(m){var v=b(d);if(n&&d.body_id_src!=t&&y(n,_,s),v)g=i(d.body_id_src==t?r:t);else var g=null;d.callback(v,g,n,_,s)}}}function b(e){for(var t=e.pair_results,r=!1,a=0;a<t.length;a++)r=r||t[a];return r}function y(e,t,r){e[0]=e[0]+t[0]*r,e[1]=e[1]+t[1]*r,e[2]=e[2]+t[2]*r,t[0]*=-1,t[1]*=-1,t[2]*=-1}function E(e,t,r,a,n,_){var s=e.callback;n?s(e.id,t,r,a,n,_):s(e.id,t,r,a)}function w(e,t,r){e&&ke.is_fallback(e)&&ke.post_msg(e,ke.OUT_UPDATE_WORLD,t,r);for(var a=0;a<Ve.length;a++){var n=Ve[a],_=n.physics;if(_.simulated&&_.curr_time){if(ke.is_fallback(e))s=t-_.curr_time;else var s=performance.now()/1e3-_.curr_time;s=Math.min(s,10/Ge.max_fps),s-=1/Ge.max_fps,je.no_phy_interp_hack&&(s=0);var o=Je;Pe.integrate(_.curr_tsr,s,_.linvel,_.angvel,Je),Ce.set_tsr(n,o),Ce.update_transform(n),re(n),n.vehicle&&T(n),n.vehicle&&n.vehicle.steering_wheel&&ge(n),n.vehicle&&n.vehicle.speedometer&&ye(n),n.vehicle&&n.vehicle.tachometer&&Ee(n)}}ke.post_msg_arr(e)}function T(e){for(var t=e.vehicle.props,r=e.render.world_tsr,a=Je,n=0;n<t.length;n++){var _=t[n],s=e.vehicle.prop_offsets[n];Pe.multiply(r,s,a),Ce.set_tsr(_,a),Ce.update_transform(_)}}function x(){return Ke.body++,Ke.body}function O(e,t,r){var a=t._render.water_params;if(ke.post_msg(r,ke.OUT_APPEND_WATER,a.water_level),e.water_dynamics){var n={};n.dst_noise_scale0=e.dst_noise_scale0,n.dst_noise_scale1=e.dst_noise_scale1,n.dst_noise_freq0=e.dst_noise_freq0,n.dst_noise_freq1=e.dst_noise_freq1,n.dir_min_shore_fac=e.dir_min_shore_fac,n.dir_freq=e.dir_freq,n.dir_noise_scale=e.dir_noise_scale,n.dir_noise_freq=e.dir_noise_freq,n.dir_min_noise_fac=e.dir_min_noise_fac,n.dst_min_fac=e.dst_min_fac,n.waves_hor_fac=e.waves_hor_fac;var _=a.waves_height,s=a.waves_length;if(a.shoremap_image){var o=a.shoremap_size[0],i=a.shoremap_size[1],l=a.shoremap_center[0],c=a.shoremap_center[1],u=a.max_shore_dist,d=a.shoremap_tex_size;ke.post_msg(r,ke.OUT_ADD_WATER_WRAPPER,n,o,i,l,c,u,_,s,d,t._render.shore_distances)}else ke.post_msg(r,ke.OUT_ADD_WATER_WRAPPER,n,0,0,0,0,0,_,s,0,null)}}function R(e,t,r){var a=x(),n=t.submesh,_=n.va_frames[0].a_position,s=n.indices||null,o=Pe.get_trans_view(e.render.world_tsr),i=t.friction,l=t.elasticity,c=t.collision_id,u=N(c),d=t.collision_margin,f=t.collision_group,m=t.collision_mask;ke.post_msg(r,ke.OUT_APPEND_STATIC_MESH_BODY,a,_,s,o,i,l,u,d,f,m);var p=I(a,"STATIC_MESH");return p.collision_id=c,p.collision_id_num=u,p}function N(e){var t=Xe.indexOf(e);return-1==t?(Xe.push(e),Xe.length-1):t}function I(e,t){return{body_id:e,type:t,mass:0,is_ghost:!1,simulated:!0,is_vehicle:!1,is_character:!1,is_floater:!1,cons_id:null,collision_id:"",collision_id_num:0,collision_callbacks:{},collision_tests:[],col_imp_test_cb:null,curr_time:0,curr_tsr:new Float32Array([0,0,0,1,0,0,0,1]),linvel:new Float32Array(3),angvel:new Float32Array(3),cached_trans:new Float32Array(3),cached_quat:new Float32Array(4),navmesh:null}}function S(e,t,r){var a=x(),n=t.submesh,_=n.va_frames[0].a_position,s=n.indices||null,o=t.collision_id,i=N(o),l=t.collision_margin,c=t.collision_group,u=t.collision_mask,d=Pe.get_trans_view(e.render.world_tsr);ke.post_msg(r,ke.OUT_APPEND_GHOST_MESH_BODY,a,_,s,d,i,l,c,u);var f=I(a,"STATIC_MESH");return f.is_ghost=!0,f.collision_id=o,f.collision_id_num=i,f}function L(e,t,r){var a=e.render,n=e.physics_settings,_=n.physics_type,s=x();if("CAMERA"==e.type)var o=D(c=n.use_collision_bounds?n.collision_bounds_type:"BOX",a),i=.5,l=0;else if("EMPTY"==e.type)var c="EMPTY",o=null,i=0,l=0;else{var o=D(c=n.use_collision_bounds?n.collision_bounds_type:"BOX",a),u=Pe.get_scale(a.world_tsr);1!=u&&F(o,c,u);var i=a.friction,l=a.elasticity}var d=Pe.get_trans_view(a.world_tsr),f=Pe.get_quat_view(a.world_tsr),m=n.use_ghost,p=n.use_sleep,h=n.mass,v=n.velocity_min,b=n.velocity_max,g=n.damping,y=n.rotation_damping,E=e.collision_id,w=N(E),A=n.collision_margin,T=n.collision_group,O=n.collision_mask,R=a.bs_local.radius,k=B(o),M=e.correct_bounding_offset,S=P(a,t,c,k);ke.post_msg(r,ke.OUT_APPEND_BOUNDING_BODY,s,d,f,_,m,p,h,v,b,g,y,w,A,T,O,c,k,R,i,l,S,M),qe[s]=e,Ve.push(e);var L=I(s,"BOUNDING");return L.type=_,L.mass=h,L.is_ghost=m,L.collision_id=E,L.collision_id_num=w,L}function C(e,t){var r=I(x(),"NAVMESH"),a=Ne.get_scene_data(e,t).batches;r.navmesh=null;for(var n=0;n<a.length;n++){var _=a[n];if("PHYSICS"==_.type){r.navmesh=Be.navmesh_build_from_bufs_data(_.bufs_data);break}}return r}function P(e,t,r,a){if(!t.length)return[];var n=[],_={};_.quat=new Float32Array([0,0,0,1]),_.trans=new Float32Array(3),_.worker_bounding=a,_.bounding_type=r,n.push(_);var s=Pe.invert(e.world_tsr,Je),o=Qe,i=Pe.get_quat_view(e.world_tsr);Ie.invert(i,o);for(var l=0;l<t.length;l++){var c={},u=t[l],d=u.physics_settings.collision_bounds_type,f=new Float32Array(4),m=new Float32Array(3),p=Pe.get_trans_view(u.render.world_tsr),h=Pe.get_quat_view(u.render.world_tsr);Pe.transform_vec3(p,s,m),Ie.multiply(o,h,f),c.trans=m,c.quat=f,c.bounding_type=d,c.worker_bounding=B(D(d,u.render)),n.push(c)}return n}function D(e,t){switch(e){case"BOX":r=t.bb_local;break;case"CYLINDER":r=t.bcyl_local;break;case"CONE":r=t.bcon_local;break;case"SPHERE":r=t.bs_local;break;case"CAPSULE":var r=t.bcap_local}return r}function F(e,t,r){switch(t){case"BOX":e.min_x*=r,e.max_x*=r,e.min_y*=r,e.max_y*=r,e.min_z*=r,e.max_z*=r;break;case"CYLINDER":case"CONE":case"CAPSULE":e.height*=r,e.radius*=r;break;case"SPHERE":e.radius*=r}}function B(e){if(!e)return null;var t=e,r={};return"number"==typeof t.min_x&&(r.min_x=t.min_x),"number"==typeof t.min_y&&(r.min_y=t.min_y),"number"==typeof t.min_z&&(r.min_z=t.min_z),"number"==typeof t.max_x&&(r.max_x=t.max_x),"number"==typeof t.max_y&&(r.max_y=t.max_y),"number"==typeof t.max_z&&(r.max_z=t.max_z),"object"==typeof t.center&&(r.center=t.center),"number"==typeof t.radius&&(r.radius=t.radius),"number"==typeof t.height&&(r.height=t.height),r}function G(e,t){var r=e.physics.body_id;if(we(e)){e.vehicle.type=et;var a=e.vehicle.suspension_compression,n=e.vehicle.suspension_stiffness,_=e.vehicle.suspension_damping,s=e.vehicle.wheel_friction,o=e.vehicle.max_suspension_travel_cm;ke.post_msg(t,ke.OUT_APPEND_CAR,r,a,n,_,s,o)}else if(Ae(e)){e.vehicle.type=tt;var i=e.vehicle.floating_factor,l=e.vehicle.water_lin_damp,c=e.vehicle.water_rot_damp;ke.post_msg(t,ke.OUT_APPEND_BOAT,r,i,l,c)}if(e.vehicle.props){var u=e.vehicle.props;switch(e.vehicle.type){case et:z(u[0],e,r,!0,t),z(u[1],e,r,!0,t),z(u[2],e,r,!1,t),z(u[3],e,r,!1,t);break;case tt:for(var d=0;d<u.length;d++)z(u[d],e,r,!1,t)}}}function z(e,t,r,a,n){var _=Pe.get_trans_view(e.render.world_tsr),s=Pe.invert(t.render.world_tsr,Je),o=new Float32Array(3);switch(Pe.transform_vec3(_,s,o),t.vehicle.type){case et:var i=t.vehicle_settings,l=i.suspension_rest_length,c=i.roll_influence,u=e.render.bb_local,d=(u.max_z-u.min_z)/2;ke.post_msg(n,ke.OUT_ADD_CAR_WHEEL,r,o,l,c,d,a);break;case tt:ke.post_msg(n,ke.OUT_ADD_BOAT_BOB,r,o,e.bob_synchronize_pos)}}function W(e,t){var r=e.render,a=e.physics,n=r.bb_local.max_z-r.bb_local.min_z,_=a.body_id,s=e.character_settings,o=s.walk_speed,i=s.run_speed,l=s.step_height,c=s.jump_strength,u=s.waterline,d=De.dir_ground_proj_angle(e);ke.post_msg(t,ke.OUT_APPEND_CHARACTER,_,d,n,o,i,l,c,u),a.is_character=!0}function q(e,t){var r=e.floater.floating_factor,a=e.floater.water_lin_damp,n=e.floater.water_rot_damp,_=e.physics.body_id;if(ke.post_msg(t,ke.OUT_APPEND_FLOATER,_,r,a,n),e.floater.bobs)for(var s=e.floater.bobs,o=0;o<s.length;o++){var i=s[o],l=Pe.get_trans_view(i.render.world_tsr),c=Pe.invert(e.render.world_tsr,Je),u=new Float32Array(3);Pe.transform_vec3(l,c,u),ke.post_msg(t,ke.OUT_ADD_FLOATER_BOB,_,u,i.bob_synchronize_pos)}e.physics.is_floater=!0}function V(e){return Boolean(e._physics)}function X(e){if(!K(e))for(var t=0;t<e.physics_constraints.length;t++){var r=e.physics_constraints[t],a=r.target,n=r.pivot_type;if(a.physics){var _=Z(r),s=Q(r);"HINGE"==n&&Ie.rotateY(s,Math.PI/2,s);var o=Pe.identity(Je);o=Pe.set_trans(_,o),o=Pe.set_quat(s,o);var i=Pe.multiply(e.render.world_tsr,o,Je),l=Pe.invert(a.render.world_tsr,$e),c=Pe.multiply(l,i,l);$(n,e,_,s,a,Pe.get_trans_view(c),Pe.get_quat_view(c),J(r),null,null)}}}function K(e){return e.physics&&e.physics.cons_id}function Z(e){return new Float32Array([e.pivot_x,e.pivot_y,e.pivot_z])}function Q(e){var t=new Float32Array([e.axis_x,e.axis_y,e.axis_z]);return De.euler_to_quat(t,new Float32Array(4))}function J(e){var t={};return t.use_limit_x=e.use_limit_x,t.use_limit_y=e.use_limit_y,t.use_limit_z=e.use_limit_z,t.use_angular_limit_x=e.use_angular_limit_x,t.use_angular_limit_y=e.use_angular_limit_y,t.use_angular_limit_z=e.use_angular_limit_z,t.limit_max_x=e.limit_max_x,t.limit_min_x=e.limit_min_x,t.limit_max_y=e.limit_max_y,t.limit_min_y=e.limit_min_y,t.limit_max_z=e.limit_max_z,t.limit_min_z=e.limit_min_z,t.limit_angle_max_x=e.limit_angle_max_x,t.limit_angle_min_x=e.limit_angle_min_x,t.limit_angle_max_y=e.limit_angle_max_y,t.limit_angle_min_y=e.limit_angle_min_y,t.limit_angle_max_z=e.limit_angle_max_z,t.limit_angle_min_z=e.limit_angle_min_z,t}function $(e,t,r,a,n,_,s,o,i,l){var c=te(),u=t.physics.body_id,d=n.physics.body_id,f=ee(u);ke.post_msg(f,ke.OUT_APPEND_CONSTRAINT,c,e,o,u,r,a,d,_,s,i,l),t.physics.cons_id=c}function ee(e){for(var t=0;t<We.length;t++)for(var r=We[t]._physics.bundles,a=0;a<r.length;a++)if(r[a].physics.body_id==e)return He[t];return null}function te(){return Ke.constraint++,Ke.constraint.toString(16)}function re(e){if(ne(e)&&_e(e)){var t=e.physics,r=e.render,a=ke.get_msg_cache(ke.OUT_SET_TRANSFORM);a.body_id=t.body_id;var n=Pe.get_trans(r.world_tsr,a.trans),_=Pe.get_quat(r.world_tsr,a.quat);Ue.copy(n,t.cached_trans),Ie.copy(_,t.cached_quat),"DYNAMIC"==t.type&&Ie.identity(a.quat);var s=ee(t.body_id);ke.post_msg(s,ke.OUT_SET_TRANSFORM)}for(var o=e.cons_descends,i=0;i<o.length;i++)re(o[i])}function ne(e){var t=e.physics;return!!t&&(0===t.mass||!0===t.is_ghost||!1===t.simulated||"RIGID_BODY"!==t.type&&"DYNAMIC"!==t.type)}function _e(e){var t=Pe.get_trans(e.render.world_tsr,Ze),r=Pe.get_quat(e.render.world_tsr,Qe);return t[0]!=e.physics.cached_trans[0]||t[1]!=e.physics.cached_trans[1]||t[2]!=e.physics.cached_trans[2]||r[0]!=e.physics.cached_quat[0]||r[1]!=e.physics.cached_quat[1]||r[2]!=e.physics.cached_quat[2]||r[3]!=e.physics.cached_quat[3]}function se(e,t,r,a,n){var _=n||new Float32Array(3),s=Pe.get_quat_view(e.render.world_tsr);return _[0]=t,_[1]=r,_[2]=a,Ue.transformQuat(_,s,_)}function oe(e,t,r){var a=e.pairs,n=e.pair_results,_=e.body_id_src,s=[];me(e.collision_id,t,s,null);for(var o=0;o<s.length;o++){var i=s[o];_<i&&!ie(a,_,i)?(a.push([_,i]),n.push(!1)):_>i&&!ie(a,i,_)&&(a.push([i,_]),n.push(!1))}ke.post_msg(r,ke.OUT_ACTIVATE,_),ke.post_msg(r,ke.OUT_APPEND_COLLISION_TEST,a,e.calc_pos_norm)}function ie(e,t,r){for(var a=0;a<e.length;a++)if(e[a][0]==t&&e[a][1]==r)return!0;return!1}function le(e,t,r){for(var a=e._physics.bundles,n=r,_=0;_<a.length;_++)for(var s=a[_].physics,o=0;o<s.collision_tests.length;o++)for(var i=s.collision_tests[o],l=0;l<i.pairs.length;l++)for(var c=i.pairs[l],u=0;u<n.length;u++){var d=n[u];c[0]==d[0]&&c[1]==d[1]&&(n.splice(u,1),u--)}n.length&&ke.post_msg(t,ke.OUT_REMOVE_COLLISION_TEST,n)}function ce(e,t,r){for(var a=e._physics.bundles,n=[],_=0;_<a.length;_++)for(var s=a[_].physics,o=0;o<s.collision_tests.length;o++)for(var i=s.collision_tests[o],l=0;l<i.pairs.length;l++){var c=i.pairs[l],u=i.pair_results[l];if(c[0]==r||c[1]==r){if(i.pairs.splice(l,1),i.pair_results.splice(l,1),l--,u&&!b(i)){var d=Ue.set(0,0,0,Ze);i.callback(!1,null,d,d,0)}n.push(c)}}n.length&&ke.post_msg(t,ke.OUT_REMOVE_COLLISION_TEST,n)}function ue(e){if(de(e)){var t=e.physics,r=ee(t.body_id);ke.post_msg(r,ke.OUT_CLEAR_COLLISION_IMPULSE_TEST,t.body_id),t.col_imp_test_cb=null}}function de(e){return!(!e.physics||!e.physics.col_imp_test_cb)}function fe(){return Ke.ray_test++,Ke.ray_test}function me(e,t,r,a){r||a||De.panic("At least one destination required");for(var n=0;n<t._physics.bundles.length;n++){var _=t._physics.bundles[n];if("ANY"==e||_.physics.collision_id==e&&"NAVMESH"!=_.physics.type){var s=_.physics.body_id;r&&-1==r.indexOf(s)&&r.push(s),a&&(a[s]=0)}}}function pe(e){var t=he(e),r=ve(e),a=t._physics;a.ray_tests[e]&&(delete a.ray_tests[e],a.ray_tests_arr.splice(a.ray_tests_arr.indexOf,1),ke.post_msg(r,ke.OUT_REMOVE_RAY_TEST,e))}function he(e){for(var t=0;t<We.length;t++){var r=We[t];if(r._physics.ray_tests[e])return r}return null}function ve(e){for(var t=0;t<We.length;t++)if(We[t]._physics.ray_tests[e])return He[t];return null}function be(e,t,r){if(t.steering_wheel){var a=e.physics.body_id,n=t.engine_force*t.force_max,_=t.brake_force*t.brake_max,s=-t.steering*t.steering_max*2*Math.PI/t.steering_ratio;switch(t.inverse_control&&(s*=-1),t.type){case et:ke.post_msg(r,ke.OUT_UPDATE_CAR_CONTROLS,a,n,_,s);break;case tt:ke.post_msg(r,ke.OUT_UPDATE_BOAT_CONTROLS,a,n,_,s)}}}function ge(e){var t=e.vehicle,r=t.steering_wheel;if(r){var a=e.vehicle.steering_wheel_tsr,n=e.vehicle.steering_wheel_axis;Pe.multiply(e.render.world_tsr,a,r.render.world_tsr);var _=Ze;Pe.transform_dir_vec3(n,e.render.world_tsr,_);var s=Qe;Ie.setAxisAngle(_,-t.steering*t.steering_max*2*Math.PI,s);var o=Pe.get_quat_view(r.render.world_tsr);Ie.multiply(s,o,o),Ce.update_transform(r)}}function ye(e){var t=e.vehicle,r=t.speedometer;if(r){var a=e.vehicle.speedometer_tsr,n=e.vehicle.speedometer_axis;Pe.multiply(e.render.world_tsr,a,r.render.world_tsr);var _=Ze;Pe.transform_dir_vec3(n,e.render.world_tsr,_);var s=Qe,o=Math.abs(t.speed)*t.speed_ratio;o>t.max_speed_angle&&(o=t.max_speed_angle),Ie.setAxisAngle(_,-o,s);var i=Pe.get_quat_view(r.render.world_tsr);Ie.multiply(s,i,i),Ie.normalize(i,i),Ce.update_transform(r)}}function Ee(e){var t=e.vehicle,r=t.tachometer;if(r){var a=e.vehicle.tachometer_tsr,n=e.vehicle.tachometer_axis;Pe.multiply(e.render.world_tsr,a,r.render.world_tsr);var _=Ze;Pe.transform_dir_vec3(n,e.render.world_tsr,_);var s=Qe;Ie.setAxisAngle(_,-Math.abs(t.engine_force)*t.delta_tach_angle,s);var o=Pe.get_quat_view(r.render.world_tsr);Ie.multiply(s,o,o),Ie.normalize(o,o),Ce.update_transform(r)}}function we(e){return e.is_vehicle&&"CHASSIS"==e.vehicle_settings.part}function Ae(e){return e.is_vehicle&&"HULL"==e.vehicle_settings.part}function Te(e){return"NAVMESH"==e.physics_settings.physics_type}function xe(e){return e.is_floating&&"MAIN_BODY"==e.floating_settings.part}var Oe=g(e),Re=ae(e),ke=M(e),Ne=k(e),Me=m(e),Ie=d(e),Se=j(e),Le=A(e),Ce=Y(e),Pe=v(e),De=h(e),Ue=l(e),Fe=U(e),Be=H(e),Ge=Oe.physics,je=Oe.defaults,ze=Oe.assets,Ye=0,He=[],We=[],qe={},Ve=[],Xe=["ANY"],Ke={body:0,constraint:0,ray_test:0},Ze=new Float32Array(3),Qe=new Float32Array(4),Je=Pe.create(),$e=Pe.create(),et=10,tt=20;t.init_scene_physics=function(e){e._physics={worker_loaded:!1,bundles:[],ray_tests:{},ray_tests_arr:[]};var t=Ge.uranium_path;ze.prevent_caching&&(t+="?v="+Fe.get_build_version()),Me.log("%cLOAD PHYSICS","color: #0a0",Ge.use_workers?"Using Separate Worker Thread,":"Using Same Thread,","Max FPS: "+Ge.max_fps),Me.log("%cPHYSICS PATH","color: #0a0",t);var r=ke.create_worker(t,!Ge.use_workers);ke.attach_handler(r,_),He.push(r),We.push(e),Ge.ping&&setInterval(function(){ke.post_msg(r,ke.OUT_PING,performance.now())},1e3)},t.check_worker_loaded=function(e){return!e._physics||e._physics.worker_loaded},t.cleanup=function(){for(var e=0;e<He.length;e++)ke.terminate(He[e]);He.length=0,We.length=0,qe={},Ve.length=0,Xe=["ANY"];for(var t in Ke)Ke[t]=0},t.append_object=function(e,t){if(V(t)){var _=e.physics_settings,s=o(t),i=[];_.use_collision_compound&&r(e,i);var l=t._physics.bundles;if(we(e)||Ae(e)||e.is_character||xe(e)||e.use_obj_physics){var c=Te(e);m=c?C(e,t):L(e,i,s),e.physics=m,p={batch:null,physics:m},c||(l.push(p),a(t,s,m.collision_id))}else for(var u=Ne.get_scene_data(e,t).batches,d=0;d<u.length;d++){var f=u[d];if("PHYSICS"==f.type&&!n(t,f))if(f.submesh.base_length)if(f.water&&t._render.water_params)O(f,t,s);else{if(f.use_ghost)m=S(e,f,s);else var m=R(e,f,s);e.physics=m;var p={batch:f,physics:m};l.push(p),a(t,s,m.collision_id)}else Me.error("Object "+e.name+" has collision material with no assigned vertices")}for(we(e)||Ae(e)?(G(e,s),be(e,e.vehicle,s)):e.is_character?W(e,s):xe(e)&&q(e,s),d=0;d<Ve.length;d++){var h=Ve[d];h.physics&&X(h)}}},t.find_obj_by_body_id=i,t.update=function(e,t){for(var r=0;r<He.length;r++){w(He[r],e,t);var a=We[r],n=a._render.water_params;if(n&&n.waves_height>0){var _=Se.get_subs(a,Le.MAIN_OPAQUE),s=Ue.length(_.wind)||1;ke.post_msg(He[r],ke.OUT_SET_WATER_TIME,_.time*s)}}},t.get_active_scene=function(){return We[0]},t.pause=function(){for(var e=0;e<He.length;e++)ke.post_msg(He[e],ke.OUT_PAUSE)},t.resume=function(){for(var e=0;e<He.length;e++)ke.post_msg(He[e],ke.OUT_RESUME)},t.enable_simulation=function(e){var t=e.physics;if(t||De.panic("No object physics"),!t.simulated){var r=t.body_id,a=ee(r);t.simulated=!0,ke.post_msg(a,ke.OUT_ENABLE_SIMULATION,r)}},t.disable_simulation=function(e){var t=e.physics;if(t||De.panic("No object physics"),t.simulated){var r=t.body_id,a=ee(r);t.simulated=!1,ke.post_msg(a,ke.OUT_DISABLE_SIMULATION,r)}},t.scene_has_physics=V,t.obj_has_physics=function(e){return Boolean(e.physics)},t.has_dynamic_physics=function(e){var t=e.physics;return!!(t&&t.simulated&&("RIGID_BODY"==t.type||"DYNAMIC"==t.type)&&t.mass>0&&0==t.is_ghost)},t.has_simulated_physics=function(e){var t=e.physics;return!(!t||!t.simulated)},t.set_gravity=function(e,t,r,a){var n=e.physics.body_id,_=ee(n);ke.post_msg(_,ke.OUT_SET_GRAVITY,n,t,r,a)},t.has_constraint=K,t.apply_constraint=$,t.clear_constraint=function(e){var t=e.physics,r=t.cons_id,a=ee(t.body_id);ke.post_msg(a,ke.OUT_REMOVE_CONSTRAINT,r),t.cons_id=null},t.pull_to_constraint_pivot=function(e,r,a,n,_,s){var o=Pe.set_sep(r,1,a,Je),i=Pe.set_sep(_,1,s,$e);Pe.invert(o,o),Pe.multiply(i,o,o),Ce.get_tsr(n,i),Pe.multiply(i,o,o),Ce.set_tsr(e,o),Ce.update_transform(e);var l=Pe.get_trans_view(e.render.world_tsr),c=Pe.get_quat_view(e.render.world_tsr);t.set_transform(e,l,c)},t.set_transform=function(e,t,r){var a=e.physics,n=ke.get_msg_cache(ke.OUT_SET_TRANSFORM),_=Pe.get_trans(e.render.world_tsr,n.trans),s=Pe.get_quat(e.render.world_tsr,n.quat);Pe.set_sep(_,1,s,a.curr_tsr),n.body_id=a.body_id,Ue.copy(t,n.trans),Ie.copy(r,n.quat);var o=ee(a.body_id);ke.post_msg(o,ke.OUT_SET_TRANSFORM)},t.sync_transform=re,t.apply_velocity=function(e,t,r,a){var n=Ze;se(e,t,r,a,n);var _=e.physics.body_id,s=Math.abs(0),o=Math.abs(0),i=Math.abs(0),l=Math.abs(n[0]),c=Math.abs(n[1]),u=Math.abs(n[2]);n[0]=l?n[0]/l*Math.max(l,s):0,n[1]=c?n[1]/c*Math.max(c,o):0,n[2]=u?n[2]/u*Math.max(u,i):0;var d=ee(_);ke.post_msg(d,ke.OUT_SET_LINEAR_VELOCITY,_,n[0],n[1],n[2])},t.apply_velocity_world=function(e,t,r,a){var n=e.physics.body_id,_=ee(n);ke.post_msg(_,ke.OUT_SET_LINEAR_VELOCITY,n,t,r,a)},t.apply_force=function(e,t,r,a,n){var _=Ze;n?(_[0]=t,_[1]=r,_[2]=a):se(e,t,r,a,_);var s=e.physics.body_id,o=ee(s);ke.post_msg(o,ke.OUT_APPLY_CENTRAL_FORCE,s,_[0],_[1],_[2])},t.apply_torque=function(e,t,r,a){var n=Ze;se(e,t,r,a,n);var _=e.physics.body_id,s=ee(_);ke.post_msg(s,ke.OUT_APPLY_TORQUE,_,n[0],n[1],n[2])},t.set_angular_velocity=function(e,t,r,a){var n=e.physics.body_id,_=ee(n);ke.post_msg(_,ke.OUT_SET_ANGULAR_VELOCITY,n,t,r,a)},t.set_character_move_dir=function(e,t,r){var a=e.physics.body_id,n=ee(a);ke.post_msg(n,ke.OUT_SET_CHARACTER_MOVE_DIR,a,t,r)},t.set_character_move_type=function(e,t){var r=e.physics.body_id,a=ee(r);ke.post_msg(a,ke.OUT_SET_CHARACTER_MOVE_TYPE,r,t)},t.set_character_walk_velocity=function(e,t){var r=e.physics.body_id,a=ee(r);ke.post_msg(a,ke.OUT_SET_CHARACTER_WALK_VELOCITY,r,t)},t.set_character_run_velocity=function(e,t){var r=e.physics.body_id,a=ee(r);ke.post_msg(a,ke.OUT_SET_CHARACTER_RUN_VELOCITY,r,t)},t.set_character_fly_velocity=function(e,t){var r=e.physics.body_id,a=ee(r);ke.post_msg(a,ke.OUT_SET_CHARACTER_FLY_VELOCITY,r,t)},t.character_jump=function(e){var t=e.physics.body_id,r=ee(t);ke.post_msg(r,ke.OUT_CHARACTER_JUMP,t)},t.character_rotation_inc=function(e,t,r){var a=e.physics.body_id,n=ee(a);ke.post_msg(n,ke.OUT_CHARACTER_ROTATION_INCREMENT,a,t,r)},t.set_character_rotation=function(e,t,r){var a=e.physics.body_id,n=ee(a);ke.post_msg(n,ke.OUT_SET_CHARACTER_ROTATION,a,t,r)},t.set_character_rotation_h=function(e,t){var r=e.physics.body_id,a=ee(r);ke.post_msg(a,ke.OUT_SET_CHARACTER_HOR_ROTATION,r,t)},t.set_character_rotation_v=function(e,t){var r=e.physics.body_id,a=ee(r);ke.post_msg(a,ke.OUT_SET_CHARACTER_VERT_ROTATION,r,t)},t.set_character_vert_move_dir_angle=function(e,t){var r=e.physics.body_id,a=ee(r);ke.post_msg(a,ke.OUT_SET_CHARACTER_VERT_MOVE_DIR_ANGLE,r,t)},t.append_collision_test=function(e,t,r,a){var n=e.physics;if(!n.navmesh){for(var _=n.body_id,o=0;o<n.collision_tests.length;o++)if((i=n.collision_tests[o]).collision_id==t&&i.callback==r)return;var i={body_id_src:_,calc_pos_norm:a||!1,collision_id:t,callback:r,pairs:[],pair_results:[]};n.collision_tests.push(i);var l=ee(_);oe(i,s(l),l)}},t.remove_collision_test=function(e,t,r){for(var a=e.physics,n=ee(a.body_id),_=s(n),o=0;o<a.collision_tests.length;o++){var i=a.collision_tests[o];if(i.collision_id==t&&i.callback==r){if(b(i)){var l=Ue.set(0,0,0,Ze);i.callback(!1,null,l,l,0)}a.collision_tests.splice(o,1),o--,le(_,n,i.pairs)}}},t.apply_collision_impulse_test=function(e,t){de(e)&&ue(e);var r=e.physics,a=ee(r.body_id);ke.post_msg(a,ke.OUT_APPLY_COLLISION_IMPULSE_TEST,r.body_id),r.col_imp_test_cb=t},t.clear_collision_impulse_test=ue,t.append_ray_test=function(e,t,r,a,n,_,o,i,l){var c=fe(),u={id:c,body_id:e?e.physics.body_id:0,from:new Float32Array(t),to:new Float32Array(r),collision_id:a,collision_id_num:N(a),autoremove:_,calc_all_hits:o,calc_pos_norm:i,ign_src_rot:l,callback:n},d=ee(u.body_id)||He[0],f=s(d)._physics;return f.ray_tests[c]=u,f.ray_tests_arr.push(u),ke.post_msg(d,ke.OUT_APPEND_RAY_TEST,u.id,u.body_id,u.from,u.to,u.collision_id_num,u.autoremove,u.calc_all_hits,u.calc_pos_norm,u.ign_src_rot),c},t.remove_ray_test=pe,t.change_ray_test_from_to=function(e,t,r){var a=he(e),n=ve(e),_=a._physics.ray_tests[e];_&&!_.autoremove&&(_.from.set(t),_.to.set(r),ke.post_msg(n,ke.OUT_CHANGE_RAY_TEST_FROM_TO,e,t,r))},t.is_ray_test=function(e){return!!he(e)._physics.ray_tests[e]},t.vehicle_throttle=function(e,t){var r=e.vehicle;r.engine_force=t,be(e,r,ee(e.physics.body_id))},t.vehicle_steer=function(e,t){var r=e.vehicle;r.steering=t,be(e,r,ee(e.physics.body_id))},t.vehicle_brake=function(e,t){var r=e.vehicle;r.brake_force=t,be(e,r,ee(e.physics.body_id))},t.is_vehicle_chassis=we,t.is_vehicle_hull=Ae,t.is_navigation_mesh=Te,t.is_car_wheel=function(e){if(!e.is_vehicle)return!1;var t=e.vehicle_settings.part;return"WHEEL_FRONT_LEFT"==t||"WHEEL_FRONT_RIGHT"==t||"WHEEL_BACK_LEFT"==t||"WHEEL_BACK_RIGHT"==t},t.is_boat_bob=function(e){return!!e.is_vehicle&&"BOB"==e.vehicle_settings.part},t.is_floater_bob=function(e){return!!e.is_floating&&"BOB"==e.floating_settings.part},t.is_vehicle_steering_wheel=function(e){return!(!e.is_vehicle||"STEERING_WHEEL"!=e.vehicle_settings.part)},t.is_vehicle_speedometer=function(e){return!(!e.is_vehicle||"SPEEDOMETER"!=e.vehicle_settings.part)},t.is_vehicle_tachometer=function(e){return!(!e.is_vehicle||"TACHOMETER"!=e.vehicle_settings.part)},t.get_vehicle_speed=function(e){return e.vehicle.speed},t.wheel_index=function(e){switch(e){case"WHEEL_FRONT_RIGHT":return 0;case"WHEEL_FRONT_LEFT":return 1;case"WHEEL_BACK_LEFT":return 2;case"WHEEL_BACK_RIGHT":return 3}},t.has_character_physics=function(e){return e.physics&&e.physics.is_character},t.is_floater_main=xe,t.get_fps=function(){return Ye},t.debug_workers=function(){for(var e=0;e<He.length;e++){var t=He[e];ke.post_msg(t,ke.OUT_DEBUG)}},t.remove_object=function(e){var t=e.physics.body_id;if("BOUNDING"==e.physics.type){var r=Ve.indexOf(e);-1==r&&Me.error("Object "+e.name+" doesn't have bounding physics"),delete qe[t],Ve.splice(r,1)}var a=ee(t),n=s(a);ce(n,a,t),de(e)&&ue(e);for(var _=n._physics.bundles,o=0;o<_.length;o++)_[o].physics.body_id==t&&(_.splice(o,1),o--);ke.post_msg(a,ke.OUT_REMOVE_BODY,t)},t.has_dynamic_settings=function(e){var t=e.physics_settings;return e.is_vehicle||e.is_floating||e.is_character||e.use_obj_physics&&!t.use_ghost&&t.mass>0&&("DYNAMIC"==t.physics_type||"RIGID_BODY"==t.physics_type)}}),q=o("__curve",function(e,t){function r(e,t,r){r||(r=[]);var a=e+t,n=e+2;r[0]=0;for(var _=2;_<=a;_++)r[_-1]=_>t&&_<n?r[_-2]+1:r[_-2];return r}function a(e,t,r,a,n){var _=a.length;n||(n=new Float32Array(_));for(var s=_+e,o=new Float32Array(s),i=1;i<=s-1;i++)t>=r[i-1]&&t<r[i+1-1]?o[i-1]=1:o[i-1]=0;for(var l=2;l<=e;l++)for(i=1;i<=s-l;i++){if(0!=o[i-1])c=(t-r[i-1])*o[i-1]/(r[i+l-1-1]-r[i-1]);else var c=0;if(0!=o[i+1-1])u=(r[i+l-1]-t)*o[i+1-1]/(r[i+l-1]-r[i+1-1]);else var u=0;o[i-1]=c+u}t==r[s-1]&&(o[_-1]=1);for(var d=0,i=1;i<=_;i++)d+=o[i-1]*a[i-1];for(i=1;i<=_;i++)n[i-1]=0!=d?o[i-1]*a[i-1]/d:0;return n}function n(e,t,r,a,n){var s=a.length;n||(n=new Float32Array(s));var o=new Float32Array(s),i=new Float32Array(s);_(s,e,t,r,o,i);for(var l=0,c=1;c<=s;c++)l+=o[c-1]*a[c-1];for(var u=0,c=1;c<=s;c++)u+=i[c-1]*a[c-1];for(c=1;c<=s;c++)if(0!=l){var d=i[c-1]*a[c-1]/l,f=o[c-1]*a[c-1]*u/(l*l);n[c-1]=d+f}else n[c-1]=0;return n}function _(e,t,r,a,n,_){n||(n=new Float32Array(e)),_||(_=new Float32Array(e));for(var s=e+t,o=new Float32Array(s),i=new Float32Array(s),l=1;l<=s-1;l++)r>=a[l-1]&&r<a[l+1-1]?o[l-1]=1:o[l-1]=0;r==a[s-1]&&(o[e-1]=1);for(var c=2;c<=t;c++)for(l=1;l<=s-c;l++){if(0!=o[l-1])u=(r-a[l-1])*o[l-1]/(a[l+c-1-1]-a[l-1]);else var u=0;if(0!=o[l+1-1])d=(a[l+c-1]-r)*o[l+1-1]/(a[l+c-1]-a[l+1-1]);else var d=0;if(0!=o[l-1])f=o[l-1]/(a[l+c-1-1]-a[l-1]);else var f=0;if(0!=o[l+1-1])m=-o[l+1-1]/(a[l+c-1]-a[l+1-1]);else var m=0;if(0!=i[l-1])p=(r-a[l-1])*i[l-1]/(a[l+c-1-1]-a[l-1]);else var p=0;if(0!=i[l+1-1])h=(a[l+c-1]-r)*i[l+1-1]/(a[l+c-1]-a[l+1-1]);else var h=0;o[l-1]=u+d,i[l-1]=f+m+p+h}for(l=1;l<=e;l++)n[l-1]=o[l-1],_[l-1]=i[l-1];return n}function s(e,t,r){r||(r=[]);for(var n=e.cpoints,_=e.is_3d?4:3,s=e.weights,o=e.knot,i=e.order,l=n.length/_,c=l+i,u=0,d=o[c-1]/(t-1),f=0;f<t;f++){o[c-1]-u<5e-6&&(u=o[c-1]);for(var m=a(i,u,o,s),p=0;p<_;p++){r[_*f+p]=0;for(var h=0;h<l;h++){var v=m[h]*n[_*h+p];r[_*f+p]+=v}}u+=d}return r}function o(e,t){Math.max(t,0);var r=i(e);return Math.min(t,r)}function i(e){var t=e.knot;return t[t.length-1]}function c(e){var t=e.cumulative_length;return t[t.length-1]}function u(e,t,r,a,n,_,s,o){var i=e+(t-e)/2,l=d(i,a,n,_,s)-r;return o=o||.01,Math.abs(l)<o?i:l>0?u(e,i,r,a,n,_,s,o):u(i,t,r,a,n,_,s,o)}function d(e,t,r,a,n){var _=1-e;return t*_*_*_+3*r*_*_*e+3*a*_*e*e+n*e*e*e}var f=h(e),m=l(e);t.create_spline=function(e){var t={},a=e.data,n=a.splines[0];if(!n||"NURBS"!=n.type||!n.use_endpoint_u)return null;var _=n.order_u;t.order=_;var o=n.points,i=r(o.length/5,_,[]);t.knot=i,"2D"==a.dimensions?t.is_3d=!1:"3D"==a.dimensions?t.is_3d=!0:f.panic("Wrong curve dimensions");for(var l=[],c=[],u=0;u<o.length;u+=5)l.push(o[u]),l.push(o[u+1]),l.push(o[u+2]),t.is_3d&&l.push(o[u+3]),c.push(o[u+4]);t.cpoints=l,t.weights=c,o=s(t,1e3,[]);var d=t.is_3d?4:3,m=new Float32Array(1e3);for(m[0]=0,u=1;u<1e3;u+=1){var p=o[(u-1)*d],h=o[(u-1)*d+1],v=o[(u-1)*d+2],b=o[u*d],g=o[u*d+1],y=o[u*d+2],E=Math.sqrt((b-p)*(b-p)+(g-h)*(g-h)+(y-v)*(y-v));m[u]=m[u-1]+E}return t.cumulative_length=m,t},t.spline_point=function(e,t,r){r||(r=[]),t=o(e,t);var n=e.cpoints,_=e.is_3d?4:3,s=e.weights,i=e.knot,l=e.order,c=n.length/_,u=c+l;i[u-1]-t<5e-6&&(t=i[u-1]);var d=new Float32Array(c);a(l,t,i,s,d);for(var f=0;f<_;f++){r[f]=0;for(var m=0;m<c;m++)r[f]+=d[m]*n[_*m+f]}return r},t.spline_derivative=function(e,t,r){r||(r=[]);var a=e.cpoints,_=e.is_3d?4:3,s=e.weights,o=e.knot,i=e.order,l=a.length/_,c=l+i;o[c-1]-t<5e-6&&(t=o[c-1]);var u=new Float32Array(l);n(i,t,o,s,u);for(var d=0;d<_;d++){r[d]=0;for(var f=0;f<l;f++)r[d]+=u[f]*a[_*f+d]}return r},t.spline_max_t=i,t.spline_length=c,t.spline_len_to_t=function(e,t){if(t<=0)return 0;var r=i(e);if(t>=c(e))return r;var a=e.cumulative_length,n=f.binary_search_max(a,t,0,a.length-1);return r*(n+(t-a[n])/(a[n+1]-a[n]))/1e3},t.linear_interpolation=function(e,t,r,a,n){return r+(n-a)*(e-r)/(t-a)},t.linear=function(e,t,r){var a=t[0],n=t[1],_=r[0],s=(r[1]-n)/(_-a);return s*e+(n-s*a)},t.bezier=function(e,t,r,a,n,_){return d(u(0,1,e,t[0],r[0],a[0],n[0],_),t[1],r[1],a[1],n[1])},t.calchandle_curvemap=function(e,t,r,a,n){var _=new Float32Array(3),s=new Float32Array(3),o=new Float32Array(3),i=new Float32Array(3),l=new Float32Array(3),c=new Float32Array(3);m.copy(e[1],s),null==t?(m.copy(r[1],o),_[0]=2*s[0]-o[0],_[1]=2*s[1]-o[1]):m.copy(t[1],_),null==r?(m.copy(t[1],_),o[0]=2*s[0]-_[0],o[1]=2*s[1]-_[1]):m.copy(r[1],o),m.subtract(s,_,i),m.subtract(o,s,l);var u=m.length(i),d=m.length(l);if(0==u&&(u=1),0==d&&(d=1),"AUTO"==a||"AUTO"==n){c[0]=l[0]/d+i[0]/u,c[1]=l[1]/d+i[1]/u;var f=2.5614*m.length(c);0!=f&&("AUTO"==a&&(u/=f,m.scaleAndAdd(s,c,-u,e[0])),"AUTO"==n&&(d/=f,m.scaleAndAdd(s,c,d,e[2])))}"VECTOR"==a&&m.scaleAndAdd(s,i,-1/3,e[0]),"VECTOR"==n&&m.scaleAndAdd(s,l,1/3,e[2])},t.correct_bezpart=function(e,t,r,a){var n,_,s,o,i=[],l=[];i[0]=e[0]-t[0],i[1]=e[1]-t[1],l[0]=a[0]-r[0],l[1]=a[1]-r[1],s=a[0]-e[0],(n=Math.abs(i[0]))+(_=Math.abs(l[0]))!=0&&n+_>s&&(o=s/(n+_),t[0]=e[0]-o*i[0],t[1]=e[1]-o*i[1],r[0]=a[0]-o*l[0],r[1]=a[1]-o*l[1])}}),V=o("__nla",function(e,t){function r(e){for(var t=null,r=e.scenes_data.length-1;r>=0;r--){var a=e.scenes_data[r];if(a.scene.b4w_use_nla&&(t=a,a.scene._is_main))break}return t}function a(e,t,r){for(var a=0;a<e.length;a++){var n=e[a];if(t.frame_start>n.frame_end||t.frame_end<n.frame_start){var _=r+" ["+n.frame_start+":"+n.frame_end+"]";L.warn("NLA: Strip is out of scene range: "+_),e.splice(a,1),a--}else n.anim_name||"CLIP"!=n.type||(L.warn('NLA: no action in strip for object "'+r+'".'),e.splice(a,1),a--)}}function n(e,t){for(var r=0;r<e.length;r++){for(var a=e[r],n=t.frame_start,s=t.frame_end+1,o=0;o<e.length;o++){var i=e[o];a.anim_slot==i.anim_slot&&(i.frame_end<=a.frame_start&&(n=a.frame_start),i.frame_start>=a.frame_end&&(s=Math.min(s,i.frame_start)))}a.ext_frame_start=n,a.ext_frame_end=s,_(a)}}function _(e){e.repeat%1==0?e.action_frame_final=e.action_frame_end:e.action_frame_final=e.action_frame_start+(e.action_frame_end-e.action_frame_start)*(e.repeat%1)}function s(e,t){for(var r=M.get_all_actions(),a=[],n=0,_=0;_<e.length;_++){var s=e[_];if(""!=s.anim_uuid)i=B.keysearch("uuid",s.anim_uuid,r);else var o=s.anim_name,i=B.keysearch("name",o,r)||B.keysearch("name",o+"_B4W_BAKED",r);if(i){var l=i.fcurves,c=[];for(var u in l)c.push(u);a.push(c)}}for(_=0;_<a.length;_++){for(var d=!1,f=0;f<_;f++)if(B.arrays_have_common(a[_],a[f])){e[_].anim_slot=e[f].anim_slot,d=!0;break}d||(e[_].anim_slot=t+n++)}return n}function o(){return{type:"CLIP",frame_start:0,frame_end:0,scheduled:!1,paused:!1,anim_name:"",anim_uuid:"",anim_slot:0,name_list:null,action_frame_start:0,action_frame_end:0,ext_frame_start:0,ext_frame_end:0,use_reverse:!1,scale:1,repeat:1,action_frame_final:0}}function i(e,t,r){if(e.animation_data){var a=e.animation_data.nla_tracks;if(a)for(_=0;_<a.length;_++)a[_].name_list=r,t.push(a[_])}for(var n=e.nodes,_=0;_<n.length;_++){var s=n[_];if(s.node_group){var o=s.node_group.node_tree;if(o){var l=r.slice();l.push(s.name),i(o,t,l)}}}}function l(e,t){e.is_stopped=!0,e.frame_offset-=t-e.range_end,e.user_callback&&e.user_callback()}function c(e,t){return e.user_callback&&e.user_callback(),N(e.range_start,t),e.rewinded_to_start=!0,b(e,t)}function u(e,t,r){for(l=0;l<e.objects.length;l++){var a=e.objects[l];if(a)for(var n=0;n<a.length;n++){for(var _=a[n],s=_.nla_events,o=0;o<s.length;o++)"SOUND"==(i=s[o]).type&&t<e.last_frame-Y&&(i.scheduled=!1);for(o=0;o<s.length;o++){var i=s[o];switch(i.type){case"CLIP":if(i.ext_frame_start<=t&&t<i.ext_frame_end&&!i.scheduled){g(_,i);for(var l=0;l<s.length;l++)s[l]!=i&&s[l].anim_slot==i.anim_slot&&(s[l].scheduled=!1);i.scheduled=!0}i.scheduled&&y(_,i,t);break;case"SOUND":(t<e.last_frame-Y||e.last_frame<i.frame_start)&&i.frame_start<=t&&t<i.frame_end&&(i.scheduled||(w(_,i,t),i.scheduled=!0)),e.last_frame<i.frame_end&&i.frame_end<=t&&i.scheduled&&(i.scheduled=!1)}}}}}function d(e,t,r){for(var a=0;a<t.textures.length;a++){var n=t.textures[a];if(n.video_file||n.seq_video){var _=U.video_get_current_frame(n),s=p(r,n),o=U.video_get_start_frame(n),i=!1,l=!1;if((t.force_update||t.rewinded_to_start)&&(l=!0),!t.is_stopped){var c=v(r,n),u=U.video_is_played(n);n.use_cyclic&&s==o&&(l=!0),u||_==s||(l=!0),c&&!u?U.play_video(n):c&&u?i=!0:!c&&u&&(n.video_file&&_<s?i=!0:U.pause_video(n))}if(l)U.set_frame_video(n.video_tex_name,s,n.vtex_data_id),n.seq_video&&(n.seq_last_discrete_mark=U.seq_video_get_discrete_timemark(n,e));else if(i&&U.video_update_is_available(n))if(n.video_file)U.update_video_texture(n);else{var d=U.seq_video_get_discrete_timemark(n,e);d!=n.seq_last_discrete_mark&&(n.seq_cur_frame=s,U.update_seq_video_texture(n)),n.seq_last_discrete_mark=d}}}}function f(e,t){var r=Math.round(e)-t.frame_start;return t.use_cyclic&&(r%=t.frame_duration)<0&&(r+=t.frame_duration),t.frame_offset+r}function p(e,t){var r=f(e,t),a=B.clamp(r,t.frame_offset,t.frame_offset+U.video_get_duration(t)-1);return t.seq_video&&(a=U.video_frame_to_seq_frame(t,a))==t.seq_movie_length&&a--,a}function v(e,t){var r=f(e,t);return t.frame_offset<=r&&r<=t.frame_offset+U.video_get_duration(t)}function b(e,t){var r=(t-z)*F.get_framerate()+e.frame_offset;return r>e.frame_start?(r-=e.frame_start,e.cyclic&&(r%=e.frame_end-e.frame_start+1),r+=e.frame_start):r=e.frame_start,r}function g(e,t,r,a){var n=t.name_list;""!=t.anim_uuid?M.apply_by_uuid(e,n,t.anim_uuid,t.anim_slot):M.apply(e,n,t.anim_name,t.anim_slot),M.set_behavior(e,M.AB_FINISH_STOP,t.anim_slot);var _=E(t.frame_start,t);M.set_frame(e,_,t.anim_slot)}function y(e,t,r,a){var n=E(r,t),_=M.get_current_frame_float(e,t.anim_slot);Math.abs(n-_)>Y&&M.set_frame(e,n,t.anim_slot)}function E(e,t){if((e=B.clamp(e,t.frame_start,t.frame_end))==t.frame_end)a=t.action_frame_final;else var r=(e-t.frame_start)/t.scale%(t.action_frame_end-t.action_frame_start),a=t.action_frame_start+r;return t.use_reverse&&(a=t.action_frame_end-a+t.action_frame_start),a}function w(e,t,r){var a=(t.frame_start-r)/F.get_framerate(),n=(t.frame_end-t.frame_start)/F.get_framerate();P.play(e,a,n)}function A(e,t){for(var r=[],a=0;a<e.length;a++){var n=e[a],_=n.strips;if(_)for(var s=0;s<_.length;s++){var i=_[s],l=o();l.type=i.type,l.frame_start=i.frame_start,l.frame_end=i.frame_end,l.anim_slot=t,l.action_frame_start=i.action_frame_start,l.action_frame_end=i.action_frame_end,l.use_reverse=i.use_reverse,l.scale=i.scale,l.repeat=i.repeat,i.action&&(l.anim_name=i.action.name,l.anim_uuid=i.action.uuid,l.name_list=n.name_list),r.push(l)}}return r}function T(e){return!("SPEAKER"!=e.type&&"LAMP"!=e.type||!e.data.animation_data||!e.data.animation_data.nla_tracks.length)}function O(e){if("MESH"!=e.type||!e.data)return!1;var t=e.data.materials;if(!t)return!1;for(var r=0;r<t.length;r++){var a=t[r],n=a.node_tree;if(a.use_nodes&&n&&R(n))return!0}return!1}function R(e,t){if(e.animation_data){var r=e.animation_data.nla_tracks;if(r&&r.length)return!0}for(var a=e.nodes,n=0;n<a.length;n++){var _=a[n];if(_.node_group){var s=_.node_group.node_tree;s&&R(s,t)}}return!1}function N(e,t){var r=C.get_active();if(r._nla){var a=b(r._nla,t);r._nla.frame_offset-=a-e,r._nla.force_update=!0}}var M=Q(e),I=$(e),S=k(e),L=m(e),C=j(e),P=D(e),U=ee(e),F=x(e),B=h(e),G=[],z=-1,Y=1e-6;t.update_object=function(e,t){var a=r(t);if(a){a.obj_has_nla_on_scene=!0;var n=0,_=e.animation_data;if(_&&_.nla_tracks.length&&(d=_.nla_tracks,(S.is_armature(t)||S.is_camera(t)||S.is_mesh(t)||S.is_empty(t)||S.is_line(t)||S.is_lamp(t)||S.is_speaker(t)||S.is_world(t))&&(f=A(d,n)).length&&(t.nla_events=t.nla_events.concat(f),n++)),T(e)&&(f=A(d=e.data.animation_data.nla_tracks,n)).length&&(t.nla_events=t.nla_events.concat(f),n++),S.is_mesh(t))for(var l=t.materials,c=0;c<l.length;c++){var u=l[c];u.use_nodes&&u.node_tree&&(d=[],i(u.node_tree,d,[u.name]),(f=A(d,n)).length&&(n+=s(f,n),t.nla_events=t.nla_events.concat(f)))}if(S.is_world(t)){if(e.use_nodes&&e.node_tree){var d=[];i(e.node_tree,d,[e.name]);var f=A(d,n);f.length&&(n+=s(f,n),t.nla_events=t.nla_events.concat(f))}}else{for(c=0;c<e.particle_systems.length;c++){var m=e.particle_systems[c],p=m.settings;"EMITTER"==p.type&&p.b4w_allow_nla&&((b=o()).type="CLIP",b.frame_start=a.scene.frame_start,b.frame_end=a.scene.frame_end+1,b.anim_name=m.name,b.anim_slot=n,b.action_frame_start=b.frame_start,b.action_frame_end=b.frame_end,t.nla_events.push(b),n++)}for(var h=n+1,c=0;c<t.vertex_anim.length;c++){var v=t.vertex_anim[c];if(v.allow_nla){n=h;var b=o();b.type="CLIP",b.frame_start=v.frame_start,b.frame_end=v.frame_end,b.anim_name=v.name,b.anim_slot=n,b.action_frame_start=b.frame_start,b.action_frame_end=b.frame_end,t.nla_events.push(b)}}}}},t.update_scene=function(e,t,r){e._nla||(e._nla={frame_start:e.frame_start,frame_end:e.frame_end,frame_offset:0,last_frame:-1,range_end:e.frame_end,range_start:e.frame_start,user_callback:null,cyclic:t,objects:[],textures:[],scene_name:e.name,is_stopped:!1,force_update:!1,rewinded_to_start:!0},G.push(e._nla));for(var _=e._nla,s=I.get_scene_objs_derived(e,"ALL",r),i=0;i<s.length;i++){var l=s[i];if(l.nla_events.length){_.objects[r]||(_.objects[r]=[]);for(var c=0;c<l.scenes_data.length;c++){var u=l.scenes_data[c];u.scene==e&&u.obj_has_nla_on_scene&&_.objects[r].push(l)}a(l.nla_events,_,l.name),n(l.nla_events,_)}}for(var d=e._render.video_textures,i=0;i<d.length;i++){var f=d[i]._render;if(f.use_nla&&(f.video_file||f.seq_video)&&f.vtex_data_id==r){var m=o();m.type="VIDEO",f.use_cyclic?(m.frame_start=0,m.frame_end=_.frame_end):(m.frame_start=B.clamp(f.frame_start,0,_.frame_end),m.frame_end=B.clamp(f.frame_start+f.frame_duration,0,_.frame_end)),m.anim_name=d[i].name,_.textures.push(f)}}},t.prepare=function(){for(a=0;a<G.length;a++)for(var e=G[a],t=0;t<e.objects.length;t++){var r=e.objects[t];if(r)for(var a=0;a<r.length;a++)for(var n=r[a],_=n.nla_events,s=0;s<_.length;s++){var o=_[s];M.init_action_cache(n,o.name_list,o.uuid,o.anim_name,o.anim_slot)}}},t.start=function(){z=0},t.get_start_time=function(){return z},t.get_frame_offset=function(e){return e._nla?e._nla.frame_offset:null},t.set_frame_offset=function(e,t){return!!e._nla&&(e._nla.frame_offset=t,!0)},t.update=function(e,t){if(!(z<0)){0==z&&(z=e);for(var r=0;r<G.length;r++){var a=G[r];a.is_stopped&&(a.frame_offset-=F.get_framerate()*t);var n=b(a,e);(!a.is_stopped||a.force_update)&&n>=a.range_end&&(a.cyclic?n=c(a,e):l(a,n)),a.is_stopped&&!a.force_update||(u(a,n,t),d(e,a,n),a.last_frame=n),a.force_update=!1,a.rewinded_to_start=!1}}},t.cleanup=function(e){if(0==e)G.length=0,z=-1;else for(var t=0;t<G.length;t++)G[t].objects[e]=null},t.bpy_obj_has_nla=function(e){var t=e.animation_data;return!!(t&&t.nla_tracks.length||T(e)||O(e))},t.set_frame=N,t.get_frame=function(e){var t=C.get_active();return t._nla?b(t._nla,e):-1},t.stop_nla=function(){var e=C.get_active();if(e._nla){e._nla.is_stopped=!0;for(var t=e._nla.textures,r=0;r<t.length;r++){var a=t[r];U.pause_video(a)}}},t.play_nla=function(e){var t=C.get_active();t._nla&&(t._nla.is_stopped=!1,t._nla.user_callback=e||null)},t.get_frame_start=function(){var e=C.get_active();return e._nla?e._nla.frame_start:-1},t.get_frame_end=function(){var e=C.get_active();return e._nla?e._nla.frame_end:-1},t.is_play=function(){var e=C.get_active();return!!e._nla&&!e._nla.is_stopped},t.check_nla=function(){var e=C.get_active();return!!e._nla&&e.b4w_use_nla},t.check_logic_nodes=function(){var e=C.get_active();return!!e._nla&&e.b4w_logic_nodes.length>0},t.set_range=function(e,t){var r=C.get_active();if(!r._nla)return!1;r._nla.range_start=e,r._nla.range_end=t},t.set_range_end=function(e){var t=C.get_active();if(!t._nla)return!1;t._nla.range_end=e},t.set_range_start=function(e){var t=C.get_active();if(!t._nla)return!1;t._nla.range_start=e},t.reset_range=function(){var e=C.get_active();if(!e._nla)return!1;var t=e._nla;t.range_start=t.frame_start,t.range_end=t.frame_end},t.set_cyclic=function(e){var t=C.get_active();if(!t._nla)return!1;t._nla.cyclic=e},t.clear_callback=function(){var e=C.get_active();e._nla&&(e._nla.user_callback=null)},t.set_offset_from_range_start=function(e){var t=C.get_active()._nla;t&&(t.frame_offset=-(e-z)*F.get_framerate()+t.range_start,t.force_update=!0)},t.get_frame_end=function(){var e=C.get_active()._nla;return e?e.frame_end:null}}),X=o("__controls",function(e,t){function r(e,t){return t||(t=M.get_container()),{type:e,value:0,payload:null,element:t,do_activation:!1,key:0,collision_id:"",calc_pos_norm:!1,collision_obj:null,collision_cb:function(){},col_imp_obj:null,col_imp_cb:function(){},source_object:null,from:new Float32Array(3),to:new Float32Array(3),is_binary_value:!1,ign_src_rot:!1,ray_test_id:0,ray_test_cb:function(){},axis:"",time_last:0,trans_last:new Float32Array(3),quat_last:new Float32Array(4),threshold:0,quat_temp:new Float32Array(4),avg_linear_vel:0,avg_angular_vel:0,rotation_threshold:0,avg_vertical_vel:0,period:0,repeat:!1,enable_toggle_switch:!1,gamepad_id:0,position:G.create(),orientation:D.create(),callback:function(){}}}function a(e){e.mouse_select_data.is_updated||(e.mouse_select_data.obj=L.pick_object(e.mouse_select_data.coord[0],e.mouse_select_data.coord[1]),e.mouse_select_data.is_updated=!0,e.global_selected_obj=e.mouse_select_data.obj);for(var t=0;t<Ge;++t){var r=e.touch_select_dlist[t];r.is_updated||(r.obj=L.pick_object(r.coord[0],r.coord[1]),r.is_updated=!0,e.global_selected_obj=r.obj)}}function n(e){if(!e.is_updated_keyboard){for(var t=0;t<e.downed_keys.length;t++)e.downed_keys[t]==De?e.downed_keys[t]=Ue:e.downed_keys[t]==Fe&&(e.downed_keys[t]=Pe);e.is_updated_keyboard=!0}e.mouse_state==De?e.mouse_state=Ue:e.mouse_state==Fe&&(e.mouse_state=Pe);for(var r=0;r<e.touch_select_dlist.length;r++){var a=e.touch_select_dlist[r];a.touch_state==De?a.touch_state=Ue:a.touch_state==Fe&&(a.touch_state=Pe)}e.wheel_delta=0,e.mouse_last_x=e.mouse_curr_x,e.mouse_last_y=e.mouse_curr_y,e.downed_keys[0]=Pe,e.touches_last_x.set(e.touches_curr_x),e.touches_last_y.set(e.touches_curr_y),e.touch_zoom_last_dist=e.touch_zoom_curr_dist,e.gyro_gamma_last=e.gyro_gamma_new,e.gyro_beta_last=e.gyro_beta_new,e.gyro_alpha_last=e.gyro_alpha_new,e.is_updated_gyro_quat=!1}function _(e){function t(){return{coord:new Float32Array(2),is_updated:!0,obj:null,identifier:-1,touch_state:Pe}}for(e||(e=M.get_container()),a=0;a<X.length;a++)if(e==(r=X[a]).element)return r;for(var r={element:e,is_updated_keyboard:!0,mouse_state:Pe,is_touch_ended:!0,mouse_last_x:0,mouse_last_y:0,mouse_curr_x:0,mouse_curr_y:0,pointerlock_dx:0,pointerlock_dy:0,touches_last_x:new Float32Array(2),touches_curr_x:new Float32Array(2),touches_last_y:new Float32Array(2),touches_curr_y:new Float32Array(2),touch_zoom_curr_dist:0,touch_zoom_last_dist:0,touch_start_rot:0,downed_keys:new Uint8Array(256),wheel_delta:0,global_selected_obj:null,mouse_select_data:t(),touch_select_dlist:new Array(Ge),is_updated_gyro_quat:!1,gyro_quat:D.create(),gyro_gamma_new:0,gyro_beta_new:0,gyro_alpha_new:0,gyro_gamma_last:0,gyro_beta_last:0,gyro_alpha_last:1/0,orientation_quat_cb:null,orientation_angles_cb:null,mouse_wheel_cb:null,mouse_down_which_cb:null,mouse_select_cb:null,touch_select_start_cb:null,touch_select_end_cb:null,mouse_up_which_cb:null,mouse_location_cb:null,pointerlock_cb:null,keyboard_downed_keys_cb:null,touch_start_cb:null,touch_move_cb:null,touch_end_cb:null,registered_accum_values:{}},a=0;a<Ge;++a)r.touch_select_dlist[a]=t();return r.orientation_quat_cb=function(e){r.is_updated_gyro_quat||(I.gyro_angles_to_quat(e,r.gyro_quat),r.is_updated_gyro_quat=!0)},r.orientation_angles_cb=function(e){var t=G.copy(e,Q);r.gyro_alpha_new=t[0],r.gyro_beta_new=t[1],r.gyro_gamma_new=t[2],r.gyro_alpha_last==1/0&&(r.gyro_alpha_last=t[0],r.gyro_beta_last=t[1],r.gyro_gamma_last=t[2])},r.mouse_wheel_cb=function(e){r.wheel_delta+=e*j.mouse_wheel_notch_multiplier},r.mouse_down_which_cb=function(e){var t=I.get_device_by_type_element(I.DEVICE_MOUSE,r.element),a=I.get_vector_param(t,I.MOUSE_LOCATION,K);r.mouse_last_x=a[0],r.mouse_last_y=a[1],r.mouse_curr_x=a[0],r.mouse_curr_y=a[1],r.mouse_state!=Fe&&r.mouse_state!=Pe||(r.mouse_state=De),r.which=e},r.mouse_select_cb=function(e){var t=I.get_device_by_type_element(I.DEVICE_MOUSE,r.element),a=I.get_vector_param(t,I.MOUSE_LOCATION,K),n=M.client_to_canvas_coords(a[0],a[1],K);r.mouse_select_data.is_updated=!1,r.mouse_select_data.coord[0]=n[0],r.mouse_select_data.coord[1]=n[1]},r.touch_select_start_cb=function(e){for(var t=0;t<e.length;++t){for(var a=e[t],n=null,_=null,s=0;s<r.touch_select_dlist.length;s++){var o=r.touch_select_dlist[s],i=o.touch_state==Fe||o.touch_state==Pe;if(o.identifier==a.identifier){i&&(_=o);break}!n&&i&&((n=o).identifier=a.identifier)}var l=_||n;if(l){var c=M.client_to_canvas_coords(e[t].clientX,e[t].clientY,K);l.is_updated=!1,l.touch_state=De,l.coord[0]=c[0],l.coord[1]=c[1]}}},r.touch_select_end_cb=function(e){for(var t=0;t<r.touch_select_dlist.length;++t){for(var a=r.touch_select_dlist[t],n=!1,_=0;_<e.length;++_)if(e[_].identifier==a.identifier){n=!0;break}n||(a.touch_state!=Pe&&(a.touch_state=Fe),a.obj=null)}},r.mouse_up_which_cb=function(e){var t=I.get_device_by_type_element(I.DEVICE_MOUSE,r.element),a=I.get_vector_param(t,I.MOUSE_LOCATION,K);r.mouse_last_x=a[0],r.mouse_last_y=a[1],r.mouse_curr_x=a[0],r.mouse_curr_y=a[1],r.mouse_state!=Pe&&(r.mouse_state=Fe),r.which=e},r.mouse_location_cb=function(e){z.ie11_edge_touchscreen_hack&&r.mouse_state==Pe||(r.mouse_curr_x=e[0],r.mouse_curr_y=e[1])},r.pointerlock_cb=function(e){r.pointerlock_dx+=e[0],r.pointerlock_dy+=e[1]},r.keyboard_down_keys_cb=function(e){r.downed_keys[e]!=Ue&&(r.downed_keys[e]=De,r.is_updated_keyboard=!1)},r.keyboard_down_mod_keys_cb=function(e){for(var t=0;t<r.downed_keys.length;t++)r.downed_keys[t]!=Pe&&(r.downed_keys[t]=Fe,r.is_updated_keyboard=!1)},r.keyboard_up_keys_cb=function(e){r.is_updated_keyboard=!1,r.downed_keys[e]=Fe},r.touch_start_cb=function(e){if(r.is_touch_ended=!1,1==e.length)r.touches_last_x[0]=e[0].clientX,r.touches_last_x[1]=-1,r.touches_last_y[0]=e[0].clientY,r.touches_last_y[1]=-1;else if(e.length>1){var t=T(e);r.touch_zoom_curr_dist=r.touch_zoom_last_dist=t,r.touches_last_x[0]=e[0].clientX,r.touches_last_x[1]=e[1].clientX,r.touches_last_y[0]=e[0].clientY,r.touches_last_y[1]=e[1].clientY,r.touch_start_rot=O(e)}r.touches_curr_x.set(r.touches_last_x),r.touches_curr_y.set(r.touches_last_y)},r.touch_move_cb=function(e){if(1===e.length)r.touches_curr_x[0]=e[0].clientX,r.touches_curr_x[1]=-1,r.touches_curr_y[0]=e[0].clientY,r.touches_curr_y[1]=-1;else if(e.length>1){r.touches_curr_x[0]=e[0].clientX,r.touches_curr_x[1]=e[1].clientX,r.touches_curr_y[0]=e[0].clientY,r.touches_curr_y[1]=e[1].clientY;var t=T(e);r.touch_zoom_curr_dist=t}},r.touch_end_cb=function(e){0==e.length&&(r.is_touch_ended=!0)},X.push(r),r}function s(e,t){if(t in e.registered_accum_values&&e.registered_accum_values[t]>0)e.registered_accum_values[t]+=1;else switch(e.registered_accum_values[t]=1,t){case"orientation_quat":(r=I.get_device_by_type_element(I.DEVICE_GYRO))&&I.attach_param_cb(r,I.GYRO_ORIENTATION_ANGLES,e.orientation_quat_cb);break;case"orientation_angles":(r=I.get_device_by_type_element(I.DEVICE_GYRO))&&I.attach_param_cb(r,I.GYRO_ORIENTATION_ANGLES,e.orientation_angles_cb);break;case"mouse_wheel":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.attach_param_cb(r,I.MOUSE_WHEEL,e.mouse_wheel_cb);break;case"mouse_down_which":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.attach_param_cb(r,I.MOUSE_DOWN_WHICH,e.mouse_down_which_cb);break;case"mouse_select":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.attach_param_cb(r,I.MOUSE_DOWN_WHICH,e.mouse_select_cb);break;case"touch_select":(r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element))&&(I.attach_param_cb(r,I.TOUCH_START,e.touch_select_start_cb),I.attach_param_cb(r,I.TOUCH_END,e.touch_select_end_cb));break;case"mouse_up_which":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.attach_param_cb(r,I.MOUSE_UP_WHICH,e.mouse_up_which_cb);break;case"mouse_location":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.attach_param_cb(r,I.MOUSE_LOCATION,e.mouse_location_cb);break;case"mouse_pointerlock":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.attach_param_cb(r,I.MOUSE_LOCATION_PL,e.pointerlock_cb);break;case"keyboard_downed_keys":(r=I.get_device_by_type_element(I.DEVICE_KEYBOARD,e.element))&&(I.attach_param_cb(r,I.KEYBOARD_DOWN,e.keyboard_down_keys_cb),I.attach_param_cb(r,I.KEYBOARD_DOWN_MODIFIED,e.keyboard_down_mod_keys_cb),I.attach_param_cb(r,I.KEYBOARD_UP,e.keyboard_up_keys_cb));break;case"touch_start":(r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element))&&I.attach_param_cb(r,I.TOUCH_START,e.touch_start_cb);break;case"touch_move":(r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element))&&I.attach_param_cb(r,I.TOUCH_MOVE,e.touch_move_cb);break;case"touch_end":var r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element);r&&I.attach_param_cb(r,I.TOUCH_END,e.touch_end_cb)}}function o(e,t){if(t in e.registered_accum_values&&e.registered_accum_values[t]>0&&(e.registered_accum_values[t]-=1,!e.registered_accum_values[t]))switch(t){case"orientation_quat":(r=I.get_device_by_type_element(I.DEVICE_GYRO))&&I.detach_param_cb(r,I.GYRO_ORIENTATION_QUAT,e.orientation_quat_cb);break;case"orientation_angles":(r=I.get_device_by_type_element(I.DEVICE_GYRO))&&I.detach_param_cb(r,I.GYRO_ORIENTATION_ANGLES,e.orientation_angles_cb);break;case"mouse_wheel":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.detach_param_cb(r,I.MOUSE_WHEEL,e.mouse_wheel_cb);break;case"mouse_down_which":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.detach_param_cb(r,I.MOUSE_DOWN_WHICH,e.mouse_down_which_cb);break;case"mouse_select":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.detach_param_cb(r,I.MOUSE_DOWN_WHICH,e.mouse_select_cb);break;case"touch_select":(r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element))&&(I.detach_param_cb(r,I.TOUCH_START,e.touch_select_start_cb),I.detach_param_cb(r,I.TOUCH_END,e.touch_select_end_cb));break;case"mouse_up_which":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.detach_param_cb(r,I.MOUSE_UP_WHICH,e.mouse_up_which_cb);break;case"mouse_location":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.detach_param_cb(r,I.MOUSE_LOCATION,e.mouse_location_cb);break;case"mouse_pointerlock":(r=I.get_device_by_type_element(I.DEVICE_MOUSE,e.element))&&I.detach_param_cb(r,I.MOUSE_LOCATION_PL,e.pointerlock_cb);break;case"keyboard_downed_keys":(r=I.get_device_by_type_element(I.DEVICE_KEYBOARD,e.element))&&(I.detach_param_cb(r,I.KEYBOARD_DOWN,e.keyboard_down_keys_cb),I.detach_param_cb(r,I.KEYBOARD_DOWN_MODIFIED,e.keyboard_down_mod_keys_cb),I.detach_param_cb(r,I.KEYBOARD_UP,e.keyboard_up_keys_cb));break;case"touch_start":(r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element))&&I.detach_param_cb(r,I.TOUCH_START,e.touch_start_cb);break;case"touch_move":(r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element))&&I.detach_param_cb(r,I.TOUCH_MOVE,e.touch_move_cb);break;case"touch_end":var r=I.get_device_by_type_element(I.DEVICE_TOUCH,e.element);r&&I.detach_param_cb(r,I.TOUCH_END,e.touch_end_cb)}}function i(e,t){e.value=Number(t)}function c(e){for(var t=e.sensors,r=e.sensor_values,a=0;a<t.length;a++)r[a]=t[a].value;return e.logic_fun(r)}function u(e,r,a){if(a)switch(e.type){case me:var n=e.source_object,s=F.get_trans(n.render.world_tsr,Q),o=F.get_quat(n.render.world_tsr,J),l=G.dist(e.trans_last,s),c=e.quat_temp;D.invert(e.quat_last,c),D.multiply(o,c,c),D.normalize(c,c);var u=Math.abs(2*Math.acos(c[3])),d=l/a;e.avg_linear_vel=B.smooth(d,e.avg_linear_vel,a,Se),e.payload[0]=d;var f=u/a;e.avg_angular_vel=B.smooth(f,e.avg_angular_vel,a,Se),e.payload[1]=f,e.avg_linear_vel>=e.threshold||e.avg_angular_vel>=e.rotation_threshold?i(e,1):i(e,0),G.copy(s,e.trans_last),D.copy(o,e.quat_last),e.time_last=r;break;case pe:var n=e.source_object,s=F.get_trans(n.render.world_tsr,Q),m=Math.abs(s[1]-e.trans_last[1])/a;e.avg_vertical_vel=B.smooth(m,e.avg_vertical_vel,a,Se),e.payload=m,e.avg_vertical_vel>=e.threshold?i(e,1):i(e,0),G.copy(s,e.trans_last),e.time_last=r;break;case he:!e.do_activation&&e.period>=0&&r-e.time_last>=e.period&&(i(e,1),e.repeat?e.time_last=r:e.period=-e.period);break;case ve:e.time_last||(e.time_last=r),i(e,r-e.time_last),e.time_last=r;break;case be:i(e,r);break;case ye:P=_(e.element),e.payload[0]=P.gyro_gamma_new-P.gyro_gamma_last,e.payload[1]=P.gyro_beta_new-P.gyro_beta_last,e.payload[2]=P.gyro_alpha_new-P.gyro_alpha_last;break;case Ee:P=_(e.element),e.payload[0]=P.gyro_gamma_new,e.payload[1]=P.gyro_beta_new,e.payload[2]=P.gyro_alpha_new;break;case we:P=_(e.element),D.copy(P.gyro_quat,e.payload);break;case Ae:p=I.get_device_by_type_element(I.DEVICE_HMD),I.get_vector_param(p,I.HMD_ORIENTATION_QUAT,e.payload);break;case Te:p=I.get_device_by_type_element(I.DEVICE_HMD),I.get_vector_param(p,I.HMD_POSITION,e.payload);break;case Oe:p=R(e.gamepad_id),e.value=I.get_gamepad_btn_value(p,e.key);break;case Re:p=R(e.gamepad_id),e.value=I.get_gamepad_axis_value(p,e.key);break;case ke:p=R(e.gamepad_id),I.get_gamepad_position(p,e.payload),i(e,1);break;case Ne:var p=R(e.gamepad_id);I.get_gamepad_orientation(p,e.payload),i(e,1);break;case xe:i(e,e.callback());break;case ae:i(e,(P=_(e.element)).wheel_delta);break;case ne:if(P=_(e.element),!z.ie11_edge_touchscreen_hack||P.mouse_state==De||P.mouse_state==Ue){var h=P.mouse_curr_x-P.mouse_last_x,v=P.mouse_curr_y-P.mouse_last_y;switch(e.payload.coords[0]=P.mouse_curr_x,e.payload.coords[1]=P.mouse_curr_y,e.axis){case"X":i(e,h);break;case"Y":i(e,v);break;case"XY":i(e,w=Math.sqrt(h*h+v*v))}}break;case Me:var h=(P=_(e.element)).pointerlock_dx,v=P.pointerlock_dy,b=B.smooth(h,0,a,k()),g=B.smooth(v,0,a,k());Math.abs(h)>Ce||Math.abs(v)>Ce?(P.pointerlock_dx-=b,P.pointerlock_dy-=g,e.payload.coords[0]=b,e.payload.coords[1]=g):(e.payload.coords[0]=0,e.payload.coords[1]=0),i(e,Math.sqrt(h*h+v*v));break;case _e:i(e,(P=_(e.element)).mouse_state!=Pe|0),e.payload.which=P.which,e.payload.coords[0]=P.mouse_curr_x,e.payload.coords[1]=P.mouse_curr_y;break;case ge:if(P=_(e.element),i(e,0),e.enable_toggle_switch)P.global_selected_obj==e.source_object&&i(e,1);else if(P.mouse_state!=Pe&&P.mouse_select_data.obj==e.source_object)i(e,1);else for(var y=0;y<Ge;++y){var E=P.touch_select_dlist[y];if(E.touch_state!=Pe&&E.obj==e.source_object){i(e,1);break}}break;case re:P=_(e.element),e.payload=P.downed_keys[e.key],1==e.payload||P.downed_keys[0]&&e.key==Be?i(e,1):e.payload||i(e,0);break;case se:if(-1==(P=_(e.element)).touches_curr_x[1]&&-1==P.touches_curr_y[1]){var h=P.touches_curr_x[0]-P.touches_last_x[0],v=P.touches_curr_y[0]-P.touches_last_y[0],w=Math.sqrt(h*h+v*v);if(-1!=P.touches_last_x[1]&&-1!=P.touches_last_y[1]){var A=P.touches_curr_x[0]-P.touches_last_x[1],T=P.touches_curr_y[0]-P.touches_last_y[1],x=Math.sqrt(A*A+T*T);x<w&&(h=A,v=T,w=x)}e.payload.gesture=t.PL_SINGLE_TOUCH_MOVE}else{var O=K;O[0]=(P.touches_curr_x[0]+P.touches_curr_x[1])/2,O[1]=(P.touches_curr_y[0]+P.touches_curr_y[1])/2;var N=Z;N[0]=(P.touches_last_x[0]+P.touches_last_x[1])/2,N[1]=(P.touches_last_y[0]+P.touches_last_y[1])/2;var h=O[0]-N[0],v=O[1]-N[1],w=Math.sqrt(h*h+v*v);e.payload.gesture=t.PL_MULTITOUCH_MOVE_PAN}switch(e.payload.coords[0]=P.touches_curr_x[0],e.payload.coords[1]=P.touches_curr_y[0],e.axis){case"X":i(e,h);break;case"Y":i(e,v);break;case"XY":i(e,w)}break;case oe:var M=(P=_(e.element)).touch_zoom_curr_dist-P.touch_zoom_last_dist;e.payload=t.PL_MULTITOUCH_MOVE_ZOOM,i(e,M);break;case ie:if(-1!=(P=_(e.element)).touches_curr_x[1]){var S=P.touches_curr_x[0]-P.touches_curr_x[1],L=P.touches_curr_y[0]-P.touches_curr_y[1],C=Math.atan2(L,S);e.payload=t.PL_MULTITOUCH_MOVE_ROTATE,i(e,C-P.touch_start_rot)}break;case le:var P=_(e.element);e.payload.coords[0]=P.touches_curr_x[0],e.payload.coords[1]=P.touches_curr_y[0],P.is_touch_ended?i(e,0):i(e,1)}}function f(e){var r=0;switch(e.type){case t.CT_POSITIVE:r=(n=c(e))?1:0;break;case t.CT_CONTINUOUS:a=e.last_pulse,(n=c(e))?(r=1,e.last_pulse=1):1==a?(r=-1,e.last_pulse=-1):r=0;break;case t.CT_TRIGGER:a=e.last_pulse,(n=c(e))&&-1==a?(r=1,e.last_pulse=1):n||1!=a?r=0:(r=-1,e.last_pulse=-1);break;case t.CT_SHOT:var a=e.last_pulse;(n=c(e))&&-1==a?(r=1,e.last_pulse=1):n||1!=a?r=0:(r=0,e.last_pulse=-1);break;case t.CT_LEVEL:var n=c(e);e.last_logic_result!=n?(r=1,e.last_logic_result=n):r=0;break;case t.CT_CHANGE:for(var _=e.sensors,s=e.last_sensor_values,o=0;o<_.length;o++){var i=_[o].value;r||i==s[o]||(r=1),s[o]=i}break;default:B.panic("Wrong sensor manifold type: "+e.type)}return r}function p(e){for(var t=0;t<e.length;t++){var r=e[t];switch(r.type){case ae:case ne:case se:case oe:case ie:case le:case he:i(r,0)}}}function b(e){if(e.do_activation){switch(e.type){case ue:P.append_collision_test(e.collision_obj,e.collision_id,e.collision_cb,e.calc_pos_norm);break;case de:P.apply_collision_impulse_test(e.col_imp_obj,e.col_imp_cb);break;case fe:e.ray_test_id=P.append_ray_test(e.source_object,e.from,e.to,e.collision_id,e.ray_test_cb,!1,!1,e.calc_pos_norm,e.ign_src_rot),e.payload.ray_test_id=e.ray_test_id;break;case he:e.time_last=U.get_timeline(),e.period<0&&(e.period=-e.period);break;case re:s(t=_(e.element),"keyboard_downed_keys");break;case ae:s(t=_(e.element),"mouse_wheel");break;case ne:s(t=_(e.element),"mouse_down_which"),s(t,"mouse_up_which"),s(t,"mouse_location");break;case Me:s(t=_(e.element),"mouse_pointerlock");break;case Ie:I.activate_pointerlock(e);break;case _e:s(t=_(e.element),"mouse_down_which"),s(t,"mouse_up_which");break;case se:s(t=_(e.element),"touch_start"),s(t,"touch_move"),s(t,"touch_end");break;case oe:case ie:s(t=_(e.element),"touch_start"),s(t,"touch_move");break;case le:s(t=_(e.element),"touch_start"),s(t,"touch_end");break;case ge:s(t=_(e.element),"mouse_select"),s(t,"touch_select"),s(t,"touch_start"),s(t,"touch_end"),s(t,"mouse_down_which"),s(t,"mouse_up_which");break;case ye:case Ee:s(t=_(e.element),"orientation_angles");break;case we:var t=_(e.element);s(t,"orientation_quat");break;case Oe:case ke:case Ne:0==e.gamepad_id?I.get_device_by_type_element(I.DEVICE_GAMEPAD0):1==e.gamepad_id?I.get_device_by_type_element(I.DEVICE_GAMEPAD1):2==e.gamepad_id?I.get_device_by_type_element(I.DEVICE_GAMEPAD2):I.get_device_by_type_element(I.DEVICE_GAMEPAD3)}e.do_activation=!1}}function y(e,t){var r=(e=e||H).sensor_manifolds;if(r){var a=e.sensor_manifolds_arr;if(t){var n=r[t];if(n){for(var _=n.sensors,s=0;s<_.length;s++){var o=_[s],i=w(o,q,V);if(1==i.length){A(o);var l=q.indexOf(o);l>-1?(q.splice(l,1),V.splice(l,1)):B.panic("Sensors cache is corrupted")}else i.length>1&&i.splice(i.indexOf(n),1)}delete r[t];var c=a.indexOf(n);c>-1?a.splice(c,1):B.panic("Incorrect manifolds array"),Object.getOwnPropertyNames(r).length||E(e)}}else{var u=[];for(var d in r)u.push(d);for(s=0;s<u.length;s++)y(e,u[s])}ee=!0}}function E(e){var t=Y.indexOf(e);t>-1?Y.splice(t,1):C.error("Wrong object")}function w(e,t,r){var a=t.indexOf(e);return a>-1?r[a]:[]}function A(e){switch(e.type){case ue:P.remove_collision_test(e.collision_obj,e.collision_id,e.collision_cb),e.do_activation=!0;break;case de:P.clear_collision_impulse_test(e.col_imp_obj),e.do_activation=!0;break;case fe:P.remove_ray_test(e.ray_test_id),e.do_activation=!0;break;case he:e.do_activation=!0;break;case re:o(t=_(e.element),"keyboard_downed_keys"),e.do_activation=!0;break;case ae:o(t=_(e.element),"mouse_wheel"),e.do_activation=!0;break;case ne:o(t=_(e.element),"mouse_down_which"),o(t,"mouse_up_which"),o(t,"mouse_location"),e.do_activation=!0;break;case Me:o(t=_(e.element),"mouse_pointerlock"),e.do_activation=!0;break;case _e:o(t=_(e.element),"mouse_down_which"),o(t,"mouse_up_which"),e.do_activation=!0;break;case se:o(t=_(e.element),"touch_start"),o(t,"touch_move"),o(t,"touch_end"),e.do_activation=!0;break;case oe:case ie:o(t=_(e.element),"touch_start"),o(t,"touch_move"),e.do_activation=!0;break;case le:o(t=_(e.element),"touch_start"),o(t,"touch_end"),e.do_activation=!0;break;case ge:o(t=_(e.element),"mouse_select"),o(t,"touch_select"),o(t,"touch_start"),o(t,"touch_end"),o(t,"mouse_down_which"),o(t,"mouse_up_which"),e.do_activation=!0;break;case ye:case Ee:o(t=_(e.element),"orientation_angles"),e.do_activation=!0;break;case we:var t=_(e.element);o(t,"orientation_quat"),e.do_activation=!0;break;case Ae:case Te:e.do_activation=!0}}function T(e){var t=e[0],r=e[1],a=t.clientX-r.clientX,n=t.clientY-r.clientY;return Math.sqrt(a*a+n*n)}function O(e){var t=e[0],r=e[1],a=t.clientX-r.clientX,n=t.clientY-r.clientY;return Math.atan2(n,a)}function R(e){if(0==e)t=I.get_device_by_type_element(I.DEVICE_GAMEPAD0);else if(1==e)t=I.get_device_by_type_element(I.DEVICE_GAMEPAD1);else if(2==e)t=I.get_device_by_type_element(I.DEVICE_GAMEPAD2);else var t=I.get_device_by_type_element(I.DEVICE_GAMEPAD3);return t}function k(){return Le*je}var N=g(e),M=ce(e),I=S(e),L=$(e),C=m(e),P=W(e),D=d(e),U=x(e),F=v(e),B=h(e),G=l(e),j=N.controls,z=N.defaults,Y=[],H={},q=[],V=[],X=[],K=new Float32Array(2),Z=new Float32Array(2),Q=G.create(),J=D.create(),ee=!1,te=0,re=20,ae=30,ne=40,_e=50,se=60,oe=70,ie=75,le=80,ue=90,de=100,fe=110,me=120,pe=130,he=140,ve=150,be=160,ge=170,ye=180,Ee=190,we=200,Ae=210,Te=220,xe=230,Oe=240,Re=250,ke=260,Ne=270,Me=280,Ie=290;t.CT_POSITIVE=10,t.CT_CONTINUOUS=20,t.CT_TRIGGER=30,t.CT_SHOT=40,t.CT_LEVEL=50,t.CT_CHANGE=60,t.PL_SINGLE_TOUCH_MOVE=0,t.PL_MULTITOUCH_MOVE_ZOOM=1,t.PL_MULTITOUCH_MOVE_PAN=2,t.PL_MULTITOUCH_MOVE_ROTATE=3;var Se=.3,Le=.1,Ce=.01,Pe=0,De=1,Ue=2,Fe=3,Be=16,Ge=10,je=1;t.update=function(e,t){for(c=0;c<X.length;c++)a(d=X[c]);for(c=0;c<q.length;c++)u(q[c],e,t);for(c=0;c<Y.length;c++)for(var r=(i=Y[c]).sensor_manifolds_arr,_=0;_<r.length;_++)if((l=r[_]).update_counter!=te){l.update_counter=te;var s=f(l);if(s){var o=i==H?null:i;if(ee=!1,l.callback(o,l.id,s,l.callback_param),ee){c=-1;break}}}for(c=0;c<Y.length;c++)for(var i=Y[c],r=i.sensor_manifolds_arr,_=0;_<r.length;_++){var l=r[_];p(l.sensors)}for(var c=0;c<X.length;c++){var d=X[c];n(d)}te++},t.create_custom_sensor=function(e){var t=r(10);return i(t,e),t},t.create_keyboard_sensor=function(e){var t=document,a=r(re,t);return a.key=e,a.do_activation=!0,a},t.create_gamepad_btn_sensor=function(e,t){var a=document,n=r(Oe,a);return t=t||I.get_first_gmpd_id(),n.gamepad_id=t,n.key=e,n.do_activation=!0,n},t.create_gamepad_axis_sensor=function(e,t){var a=document,n=r(Re,a);return t=void 0==t?I.get_first_gmpd_id():t,n.gamepad_id=t,n.key=e,n.do_activation=!0,n},t.create_gamepad_position_sensor=function(e){var t=document,a=r(ke,t);return e=void 0===e?I.get_first_gmpd_id():e,a.gamepad_id=e,a.do_activation=!0,a.payload=G.create(),a},t.create_gamepad_orientation_sensor=function(e){var t=document,a=r(Ne,t);return e=void 0===e?I.get_first_gmpd_id():e,a.gamepad_id=e,a.do_activation=!0,a.payload=D.create(),a},t.create_collision_sensor=function(e,t,a){if(!e||!P.obj_has_physics(e))return C.error("Wrong collision object"),null;var n=r(ue);return n.collision_obj=e,n.collision_id=t,n.calc_pos_norm=a,n.payload={coll_obj:null,coll_pos:a?new Float32Array(3):null,coll_norm:a?new Float32Array(3):null,coll_dist:0},n.collision_cb=function(e,t,r,a,_){i(n,e);var s=n.payload;s.coll_obj=t,n.calc_pos_norm&&(s.coll_pos.set(r),s.coll_norm.set(a),s.coll_dist=_)},n.do_activation=!0,n},t.create_collision_impulse_sensor=function(e){if(!e||!e.physics)return C.error("Wrong collision impulse object"),null;var t=r(de);return t.col_imp_obj=e,t.col_imp_cb=function(e){i(t,e)},t.do_activation=!0,t},t.create_ray_sensor=function(e,t,a,n,_,s,o){var l=r(fe);return l.source_object=e,l.from=t,l.to=a,l.collision_id=n,l.is_binary_value=_,l.calc_pos_norm=s,l.ign_src_rot=o,l.payload={hit_fract:0,obj_hit:null,hit_time:0,hit_pos:new Float32Array(3),hit_norm:new Float32Array(3),ray_test_id:0},l.ray_test_cb=function(e,t,r,a,n,_){l.is_binary_value?i(l,-1==t?0:1):i(l,t),l.payload.hit_fract=t,l.payload.obj_hit=r,l.payload.hit_time=a,l.calc_pos_norm&&(l.payload.hit_pos.set(n),l.payload.hit_norm.set(_))},l.do_activation=!0,l},t.create_mouse_click_sensor=function(e){var t=r(_e,e);return t.do_activation=!0,t.payload={coords:new Float32Array(2),which:null},t},t.create_mouse_wheel_sensor=function(e){var t=r(ae,e);return t.do_activation=!0,t},t.create_mouse_move_sensor=function(e,t){var a=r(ne,t);return a.axis=e||"XY",a.payload={coords:new Float32Array(2)},a.do_activation=!0,a},t.create_touch_move_sensor=function(e,t){var a=r(se,t);return a.axis=e||"XY",a.payload={coords:new Float32Array(2),gesture:0},a.do_activation=!0,a},t.create_touch_zoom_sensor=function(e){var t=r(oe,e);return t.payload=0,t.do_activation=!0,t},t.create_touch_rotate_sensor=function(e){var t=r(ie,e);return t.payload=0,t.do_activation=!0,t},t.create_touch_click_sensor=function(e){var t=r(le,e);return t.payload={coords:new Float32Array(2)},t.do_activation=!0,t},t.create_motion_sensor=function(e,t,a){if(!e)return C.error("Wrong collision object"),null;var n=r(me);n.source_object=e;var _=F.get_trans_view(e.render.world_tsr),s=F.get_quat_view(e.render.world_tsr);return n.quat_temp=new Float32Array(4),n.trans_last=new Float32Array(_),n.quat_last=new Float32Array(s),n.avg_linear_vel=0,n.avg_angular_vel=0,n.threshold=t||.1,n.rotation_threshold=a||.1,n.time_last=0,n.payload=new Float32Array([0,0]),n},t.create_vertical_velocity_sensor=function(e,t){if(!e)return C.error("Wrong collision object"),null;var a=r(pe);a.source_object=e;var n=F.get_trans_view(e.render.world_tsr),_=F.get_quat_view(e.render.world_tsr);return a.trans_last=new Float32Array(n),a.quat_last=new Float32Array(_),a.avg_vertical_vel=0,a.threshold=t||1,a.time_last=0,a.payload=0,a},t.create_timer_sensor=function(e,t){var a=r(he);return a.period=e,a.repeat=t,a.do_activation=!0,a},t.reset_timer_sensor=function(e,t,r,a){var n=(e=e||H).sensor_manifolds;if(!n||!n[t])return C.error("reset_timer_sensor(): wrong object"),null;var _=n[t].sensors[r];if(!_)return C.error("reset_timer_sensor(): sensor not found"),null;_.time_last=U.get_timeline(),_.period=a},t.create_elapsed_sensor=function(){var e=r(ve);return e.time_last=0,e},t.create_gyro_delta_sensor=function(){var e=r(ye,window);return e.payload=new Float32Array(3),I.get_device_by_type_element(I.DEVICE_GYRO)?i(e,1):i(e,0),e.do_activation=!0,e},t.create_gyro_angles_sensor=function(){var e=r(Ee,window);return e.payload=new Float32Array(3),I.get_device_by_type_element(I.DEVICE_GYRO)?i(e,1):i(e,0),e.do_activation=!0,e},t.create_gyro_quat_sensor=function(){var e=r(we,window);return e.payload=D.create(),I.get_device_by_type_element(I.DEVICE_GYRO)?i(e,1):i(e,0),e.do_activation=!0,e},t.create_hmd_quat_sensor=function(){var e=r(Ae,window);return e.payload=D.create(),I.get_device_by_type_element(I.DEVICE_HMD)?i(e,1):i(e,0),e.do_activation=!0,e},t.create_hmd_position_sensor=function(){var e=r(Te,window);return e.payload=G.create(),I.get_device_by_type_element(I.DEVICE_HMD)?i(e,1):i(e,0),e.do_activation=!0,e},t.create_timeline_sensor=function(){return r(be)},t.create_selection_sensor=function(e,t){var a=r(ge);return a.source_object=e,a.enable_toggle_switch=t,a.do_activation=!0,a},t.create_callback_sensor=function(e,t){var a=r(xe);return a.callback=e,i(a,t),a},t.create_plock_mouse_sensor=function(e){var t=r(Me,e);return t.payload={coords:new Float32Array(2)},t.do_activation=!0,t},t.create_plock_sensor=function(e){var t=r(Ie,e);return t.do_activation=!0,t},t.sensor_set_value=i,t.get_sensor_value=function(e,t,r){var a=(e=e||H).sensor_manifolds;if(!a||!a[t])return C.error("get_sensor_value(): wrong object"),null;var n=a[t].sensors[r];return n?n.value:(C.error("get_sensor_value(): sensor not found"),null)},t.get_sensor_payload=function(e,t,r){var a=(e=e||H).sensor_manifolds;if(!a||!a[t])return C.error("get_sensor_payload(): wrong object"),null;var n=a[t].sensors[r];return n?n.payload:(C.error("get_sensor_payload(): sensor not found"),null)},t.cleanup=function(){Y=[],H={};for(var e=0;e<q.length;e++)A(q[e]);q.length=0,V.length=0},t.check_sensor_manifold=function(e,t){if(!(e=e||H).sensor_manifolds)return!1;if(t&&e.sensor_manifolds[t])return!0;if(t)return!1;for(var r in e.sensor_manifolds)return!0;return!1},t.create_sensor_manifold=function(e,t,r,a,n,_,s){(e=e||H).sensor_manifolds_arr=e.sensor_manifolds_arr||[],e.sensor_manifolds=e.sensor_manifolds||{};var o=e.sensor_manifolds,i=e.sensor_manifolds_arr;o[t]&&y(e,t);var l={id:t,type:r,sensors:a.slice(0),logic_fun:n,sensor_values:new Array(a.length),callback:_,callback_param:s,last_pulse:-1,last_logic_result:0,last_sensor_values:new Array(a.length),update_counter:-1};o[t]=l,i.push(l),-1==Y.indexOf(e)&&Y.push(e);for(var c=0;c<l.sensors.length;c++){var u=l.sensors[c];b(u);var d=q.indexOf(u);-1==d?(q.push(u),V.push([l])):V[d].push(l)}ee=!0},t.default_AND_logic_fun=function(e){for(var t=0;t<e.length;t++)if(!e[t])return e[t];return e[e.length-1]},t.default_OR_logic_fun=function(e){for(var t=0;t<e.length;t++)if(e[t])return e[t];return e[e.length-1]},t.remove_sensor_manifold=y,t.reset=function(){for(n=0;n<Y.length;n++){var e=Y[n],t=e.sensor_manifolds,r=e.sensor_manifolds_arr;for(var a in t)delete t[a];r.length=0}for(var n=0;n<q.length;n++)A(q[n]);Y.length=0,q.length=0,V.length=0},t.debug=function(){C.log(String(Y.length)+" objects with manifolds",Y),C.log(String(q.length)+" sensors",q);for(var e=[],t=[],r=0;r<q.length;r++){var a=q[r];a.type==ue&&e.push(a),a.type==fe&&t.push(a)}C.log(String(e.length)+" collision sensors",e),C.log(String(t.length)+" ray sensors",t)},t.set_plock_smooth_factor=function(e){je=e}}),K=o("__logic_nodes",function(e,t){function r(e,t){return{name:e.name,type:e.type,label:e.label,slot_idx_order:e.slot_idx_order,slot_idx_jump:e.slot_idx_jump,frame_start:e.frame_range[0],frame_end:e.frame_range[1],frame_start_mask:!e.frame_range_mask||e.frame_range_mask[0],frame_end_mask:!e.frame_range_mask||e.frame_range_mask[1],param_name:e.param_name,op:e.operation,mute:e.mute,dupli_name_list:e.object,anim_name:e.anim_name,parse_json_vars:e.parse_json_vars,parse_json_paths:e.parse_json_paths,objects_paths:e.objects_paths,nodes_paths:e.nodes_paths,floats:e.floats,bools:e.bools,vars:e.variables,strings:e.strings,logic_functions:e.logic_functions,logic_node_trees:e.logic_node_trees,materials_names:e.materials_names,shader_nd_type:e.shader_nd_type,common_usage_names:e.common_usage_names,encode_json_vars:e.encode_json_vars,encode_json_paths:e.encode_json_paths,thread:t,process_node:vt[e.type]?vt[e.type]:o,processed:!1,links_dict:e.links,instances:[],func_id:-1,links_keys:null,select_object_idx:-1}}function a(e,t,r){var a=t.thread_index+1-e.instances.length;if(a>0){for(var n=0;n<a;n++)n==a-1?e.instances.push({objects:{},slot_idx_jump:-1,state:Ee,sel_obj_idxs:[],timer:-1,camera_state:{},anim_slot:L.SLOT_ALL,obj_state:null}):e.instances.push(0);r&&r(e,e.instances[t.thread_index],t)}return e.instances[t.thread_index]}function n(e,t,r){return e[0]?t[e[1]]:r[e[1]]}function _(e,t,r,a){e[0]?t[e[1]]=a:r[e[1]]=a}function s(e,t,r,a,n,_){switch(t.state){case be:break;case ge:r.curr_node=e.slot_idx_order}}function o(e,t,r,a,n,_){switch(t.state){case be:G.error("Unknown node type: "+e.type);break;case ge:r.curr_node=e.slot_idx_order}}function c(e){var t=e.thread_state.callstack,r=t.length,n=[];for(r<=1&&n.push(e.nodes),_=1;_<r;_++)n.push(t[_].logic_func.func.nodes);for(var _=0;_<n.length;_++)for(var s=0;s<n[_].length;s++){var o=n[_][s];"PLAY"==o.type&&(a(o,e.thread_state).state=Ee)}}function f(e,t){for(var r=e.nodes,n=0;n<r.length;n++){var _=r[n];"SWITCH_SELECT"==_.type&&_!=t&&(a(_,e.thread_state).state=Te)}}function p(e,t,r,a){for(var n=bt[e],_=0;_<bt[e].logic_threads.length;_++)n.curr_thread=bt[e].logic_threads[_],O(bt[e].logic_threads[_],n,t,r,a)}function b(e,t,r){var a=H.get("url_params");if(a&&e in a)return Number(a[e]);var n=r?location.hash:location.search;if(!n)return 0;for(var _=n.slice(1).split("&"),s=0;s<_.length;s++){var o=_[s].split("=");if(o.length>1&&o[0]==e)return N(o[1],t)}return 0}function y(e){return B.get_world_by_name(e.dupli_name_list[0],0)}function E(e,t,r){var _=B.get_selectable_objects(),s=a(e,r.thread_state);s.sel_obj_idxs=[],s.links_idxs=[];for(var o in e.objects_paths){var i=e.bools[o]?n(e.vars[o],t.variables,r.thread_state.variables):B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths[o],0),l=_.indexOf(i);if(-1==l)return G.error("logic script error: non-selectable object:",e.objects_paths[o][e.objects_paths[o].length-1]),-1;s.sel_obj_idxs.push(l),s.links_idxs.push(e.links_dict[o])}s.sel_objs_len=_.length;for(var c=[],u=0;u<_.length;u++)c.push(q.create_selection_sensor(_[u],!1));var d=Et();q.create_sensor_manifold(null,"LOGIC_NODES_SWITCH_SELECT_"+I(e.label),q.CT_SHOT,c,q.default_OR_logic_fun,d,[e,t,r])}function A(e,t,r,a,_){return r?n(e.vars[t],a,_):B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths[t],0)}function T(e){var t=e.thread_state.callstack;if(t.length<=1)r=e.nodes;else var r=t[t.length-1].logic_func.func.nodes;return r}function O(e,t,r,a,n){e.thread_state.update_script_cycle=!1;var _=e.thread_state.callstack;if(_.length<=1)s=e.nodes;else var s=_[_.length-1].logic_func.func.nodes;if(s.length){for(o=0;o<s.length;o++)s[o].processed=!1;for(var o=0;o<s.length;o++){if(!(e.thread_state.curr_node>=0)){if(e.thread_state.callstack.length>1){var i=e.thread_state.callstack.pop().caller_node,l=_[_.length-1];if(l.logic_func)c=l.logic_func.func.nodes;else var c=e.nodes;e.thread_state.curr_node=i.slot_idx_order;var u=c[i.slot_idx_order],d=e.thread_state.variables;e.thread_state.variables=l.variables;for(var f in e.thread_state.variables_references){var m=e.thread_state.variables_references[f];e.thread_state.variables[f]=d[m]}return}return}if((u=s[e.thread_state.curr_node]).processed)return;if(u.mute){if("ENTRYPOINT"==u.type)return;e.thread_state.curr_node=u.slot_idx_order,u.processed=!0}else if(u.process_node(u,t,e.thread_state,r,a,n),u.processed=!0,e.thread_state.update_script_cycle)return}}}function R(e,t){var a=e.b4w_logic_nodes,n=t.logic_threads,_=t.logic_functions;t.state=be;for(var s=-1,o=0;o<a.length;o++){for(var i={nodes:[],thread_state:{scene:e,curr_node:0,in_progress:!1,update_script_cycle:!1,thread_index:o,callstack:[],variables:{R1:0,R2:0,R3:0,R4:0,R5:0,R6:0,R7:0,R8:0}}},l=a[o],c=0;c<l.length;c++){var u=r(l[c],i);i.nodes.push(u)}switch(i.nodes[0].type){case"ENTRYPOINT":s++,i.thread_state.thread_index=s,n.push(i);break;case"DEF_FUNC":var d=i.nodes[0];i.thread_state=null;var f={id:[d.logic_node_trees.id0,d.logic_functions.id0],func:i};_.push(f)}}for(o=0;o<n.length;o++)for(var i=n[o],m=0;m<i.nodes.length;m++)(u=i.nodes[m]).mute||u.process_node(u,t,i.thread_state,0,0);for(o=0;o<_.length;o++)for(var p=_[o].func,m=0;m<p.nodes.length;m++)(u=p.nodes[m]).mute||u.process_node(u,t,0,0,0);var h=e.timeline_markers;for(var v in h)t.sorted_markers_values.push(h[v]);t.sorted_markers_values.sort(function(e,t){return e-t}),t.state=ge,bt.push(t)}function N(e,t){switch(t){case Se:return Number(e)?Number(e):0;case Le:return String(e);case Ce:return e;default:return null}}function M(e){switch(typeof e){case"string":return N(e,Le);case"number":return N(e,Se);default:return N(e,Le)}}function I(e){yt[e]||(yt[e]=0);var t=e+"_"+yt[e];return t=t.replace(/ /g,"_").replace(/\//g,"_"),yt[e]++,t}function S(e,t){switch(t){case Se:return e.floats;case Le:return e.strings;case Ce:return e.objects_paths}}var L=Q(e),C=F(e),P=ue(e),U=V(e),B=$(e),G=m(e),z=j(e),H=g(e),q=X(e),K=_e(e),Z=w(e),J=u(e),ee=i(e),te=W(e),re=d(e),ae=D(e),ne=x(e),se=Y(e),oe=v(e),ie=h(e),le=l(e),ce=k(e),de=new Float32Array(4),fe=new Float32Array(3),me=new Float32Array(3),pe=new Float32Array(2),he=new Float32Array(9),ve=new Float32Array(16),be=1,ge=2,ye=3,Ee=-1,we=0,Ae=1,Te=-3,xe=-2,Oe=-1,Re=0,ke=1,Ne=-1,Me=0,Ie=1,Se=0,Le=1,Ce=2;t.NT_NUMBER=Se,t.NT_STRING=Le,t.NT_OBJECT=Ce;var Pe=0,De=1,Ue=2,Fe=3,Be=4,Ge=5,je=6,ze=7,Ye=8,He=9,We=10,qe=11,Ve=12,Xe=13,Ke=14,Ze=15,Qe=16;t.NMO_DIV=Pe,t.NMO_SUB=De,t.NMO_MUL=Ue,t.NMO_ADD=Fe,t.NMO_RAND=Be,t.NMO_SIN=Ge,t.NMO_COS=je,t.NMO_TAN=ze,t.NMO_ARCSIN=Ye,t.NMO_ARCCOS=He,t.NMO_ARCTAN=We,t.NMO_LOG=qe,t.NMO_MIN=Ve,t.NMO_MAX=Xe,t.NMO_ROUND=Ke,t.NMO_MOD=Ze,t.NMO_ABS=Qe;var Je=0,$e=1,et=2,tt=3,rt=4;t.NSO_JOIN=Je,t.NSO_FIND=$e,t.NSO_REPLACE=et,t.NSO_SPLIT=tt,t.NSO_COMPARE=rt;var at=0,nt=1,_t=2,st=3,ot=4,it=5;t.NC_GEQUAL=at,t.NC_LEQUAL=nt,t.NC_GREATER=_t,t.NC_LESS=st,t.NC_NOTEQUAL=ot,t.NC_EQUAL=it;var lt=0,ct=1,ut=2;t.NST_WORLD=lt,t.NST_PARENT=ct,t.NST_LOCAL=ut;var dt=0,ft=1,mt=2,pt=3;t.NCMS_STATIC=dt,t.NCMS_TARGET=ft,t.NCMS_EYE=mt,t.NCMS_HOVER=pt;var ht=0;t.NCPT_OBJECT=ht,t.NCPT_VARIABLE=1;var vt={ENTRYPOINT:function(e,t,r,a,n,_){switch(t.state){case ge:r.callstack.push({caller_node:null,variables:r.variables,logic_func:null}),r.curr_node=e.slot_idx_order}},HIDE:function(e,t,r,_,s,o){var i=e.bools.id0;switch(t.state){case be:break;case ge:var l=a(e,r,function(e,t,r){i||(t.obj=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0),t.obj||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0))}),c=i?n(e.vars.id0,t.variables,r.variables):l.obj;e.bools.ch?z.change_visibility_rec(c,!0):z.change_visibility(c,!0),r.curr_node=e.slot_idx_order}},SHOW:function(e,t,r,_,s,o){var i=e.bools.id0;switch(t.state){case be:break;case ge:var l=a(e,r,function(e,t,r){i||(t.obj=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0),t.obj||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0))}),c=i?n(e.vars.id0,t.variables,r.variables):l.obj;e.bools.ch?z.change_visibility_rec(c,!1):z.change_visibility(c,!1),r.curr_node=e.slot_idx_order}},PAGEPARAM:function(e,t,r,a,n,s){switch(t.state){case ge:_(e.vars.vd,t.variables,r.variables,b(e.param_name,e.floats.ptp,e.bools.hsh)),r.curr_node=e.slot_idx_order}},SWITCH_SELECT:function(e,t,r,n,s,o){switch(t.state){case be:break;case ge:var i=a(e,r,function(e,t,r){t.state=Te});if(i.state==Te)i.state=xe,f(t.logic_threads[r.thread_index],e),E(e,t,t.logic_threads[r.thread_index]);else if(i.state==xe)i.state=Oe;else if(i.state==Re||i.state==ke){if(e.vars.vd&&e.vars.vd[1]){var l=B.get_selectable_objects();_(e.vars.vd,t.variables,r.variables,l[i.select_object_idx])}r.curr_node=i.state?i.slot_idx_jump:e.slot_idx_order,i.state=Te,q.remove_sensor_manifold(null,"LOGIC_NODES_SWITCH_SELECT_"+I(e.label));break}}},SELECT:function(e,t,r,a,n,_){switch(t.state){case be:G.error("Logic script error: node is deprecated. Node: ",e.name),e.mute=!0}},PLAY:function(e,t,r,n,_,s){switch(t.state){case be:U.stop_nla(),e.bools.not_wait||(e.bools.not_wait=!1);break;case ge:var o=a(e,r);switch(o.state){case Ee:if(U.is_play(t._nla)){if(t.curr_thread==t.nla_thread&&r.in_progress)break;var i=t.nla_thread;if(i){var l=T(i)[i.thread_state.curr_node];i.thread_state.curr_node=l.slot_idx_order,c(t.nla_thread)}}if(r.in_progress=!e.bools.not_wait,t.nla_thread=t.curr_thread,o.state=we,e.frame_start_mask&&(U.set_range_start(e.frame_start),U.set_offset_from_range_start(n)),e.frame_end_mask)U.set_range_end(e.frame_end);else{var u=U.get_frame(n),d=-1;for(var f in t.sorted_markers_values)if(u<t.sorted_markers_values[f]){d=f;break}d>=0?U.set_range_end(t.sorted_markers_values[d]):U.set_range_end(U.get_frame_end())}U.play_nla(null),e.bools.not_wait&&(r.curr_node=e.slot_idx_order,o.state=Ee,r.in_progress=!1);break;case we:U.is_play()||(r.curr_node=e.slot_idx_order,o.state=Ee,r.in_progress=!1);break;case Ae:r.curr_node=e.slot_idx_order,o.state=Ee,t.nla_thread=null,r.in_progress=!1;break;default:ie.panic("Unknown state of "+e.name),o.state=Ee}}},REDIRECT:function(e,t,r,a,_,s){switch(t.state){case ge:var o=e.bools.url?N(n(e.vars.url,t.variables,r.variables),Le):e.strings.url;window.location.href=o,t.state=ye}},MATH:function(e,t,r,a,s,o){switch(t.state){case ge:var i=-1==e.vars.id0[1]?e.floats.inp1:N(n(e.vars.id0,t.variables,r.variables),Se),l=-1==e.vars.id1[1]?e.floats.inp2:N(n(e.vars.id1,t.variables,r.variables),Se),c=0;switch(e.op){case Fe:c=i+l;break;case Ue:c=i*l;break;case De:c=i-l;break;case Pe:0==l&&ie.panic("Division by zero in Logic script"),c=i/l;break;case Be:c=Math.random()*(l-i)+i;break;case Ge:c=Math.sin(i);break;case je:c=Math.cos(i);break;case ze:c=Math.tan(i);break;case Ye:c=Math.asin(i);break;case He:c=Math.acos(i);break;case We:c=Math.atan(i);break;case qe:c=Math.log(i);break;case Ve:c=Math.min(i,l);break;case Xe:c=Math.max(i,l);break;case Ke:c=Math.round(i);break;case Ze:c=i%l;break;case Qe:c=Math.abs(i)}_(e.vars.vd,t.variables,r.variables,c),r.curr_node=e.slot_idx_order}},CONDJUMP:function(e,t,r,a,_,s){switch(t.state){case ge:var o=e.common_usage_names.variable_type,i=S(e,o),l=!1;if(o==Ce){var c=e.bools.id0?n(e.vars.id0,t.variables,r.variables):B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0),u=e.bools.id1?n(e.vars.id1,t.variables,r.variables):B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id1,0);switch(e.common_usage_names.condition){case it:c==u&&(l=!0);break;case ot:c!=u&&(l=!0)}}else{var c=-1==e.vars.id0[1]?i.inp1:N(n(e.vars.id0,t.variables,r.variables),o),u=-1==e.vars.id1[1]?i.inp2:N(n(e.vars.id1,t.variables,r.variables),o);switch(e.common_usage_names.condition){case it:c==u&&(l=!0);break;case ot:c!=u&&(l=!0);break;case st:c<u&&(l=!0);break;case _t:c>u&&(l=!0);break;case nt:c<=u&&(l=!0);break;case at:c>=u&&(l=!0)}}r.curr_node=l?e.slot_idx_jump:e.slot_idx_order}},REGSTORE:function(e,t,r,a,s,o){switch(t.state){case ge:if(e.bools.vs)c=n(e.vars.vs,t.variables,r.variables);else{var i=e.common_usage_names.variable_type,l=S(e,i);if(i==Ce)c=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,l.id0,0);else var c=l.inp1}_([e.bools.new&&e.bools.gl||e.vars.vd[0],e.vars.vd[1]],t.variables,r.variables,c),r.curr_node=e.slot_idx_order}},PLAY_ANIM:function(e,t,r,_,s,o){var i=e.bools.id0,l=e.bools.env;switch(t.state){case be:break;case ge:var c=a(e,r,function(e,r,a){r.obj=l?y(e):A(e,"id0",i,t.variables,a.variables),r.obj||i||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0)});switch(l||(c.obj=i?n(e.vars.id0,t.variables,r.variables):c.obj),c.state!=we||L.is_play(c.obj,c.anim_slot)||(c.state=Ae),c.state){case Ee:for(var u in t.logic_threads){var d=t.logic_threads[u],f=T(d),m=d.thread_state.curr_node;if(-1!=m){var p=f[m],h=a(p,d.thread_state);"PLAY_ANIM"==p.type&&p!=e&&h.state==we&&h.obj==c.obj&&(h.state=Ae)}}var v=e.common_usage_names.param_anim_behavior;if(""==e.anim_name)L.apply_def(c.obj),L.set_behavior(c.obj,v,L.SLOT_ALL);else{var b=function(e,t){for(var r=-1,a=0;a<8;a++){var n=e.anim_slots[a];if(n&&n.animation_name&&L.strip_baked_suffix(n.animation_name)==L.strip_baked_suffix(t)){if(-1==r)return-1;r=a}}return r}(c.obj,e.anim_name);-1==b?(c.anim_slot=L.slot_by_anim_type(c.obj,e.anim_name),L.apply(c.obj,null,e.anim_name,c.anim_slot)):c.anim_slot=b,L.set_behavior(c.obj,v,c.anim_slot)}e.bools.not_wait||(r.in_progress=!0),L.play(c.obj,null,c.anim_slot),c.state=we,e.bools.not_wait&&(r.curr_node=e.slot_idx_order,c.state=Ee);break;case we:break;case Ae:e.bools.not_wait||(r.in_progress=!1),r.curr_node=e.slot_idx_order,c.state=Ee;break;default:ie.panic("Unknown state of "+e.name),c.state=Ee}}},SELECT_PLAY:s,SEND_REQ:function(e,t,r,s,o,i){function l(e,r,n,s,o){var i=JSON.stringify(e),l=o[0],c=o[1],u=a(l,c);_(o[0].vars.dst,t.variables,c.variables,i),u.state=1}var c=a(e,r);switch(t.state){case ge:switch(c.state){case Ne:c.state=Me;var u=e.bools.url?N(n(e.vars.url,t.variables,r.variables),Le):e.strings.url,d={};if(e.bools.ct&&(d["Content-Type"]=e.strings.ct),"GET"==e.common_usage_names.request_type)C.enqueue([{id:u,type:C.AT_JSON,url:u,overwrite_header:d,param:[e,r]}],l,null,null,null);else if("POST"==e.common_usage_names.request_type){var f=N(n(e.vars.dst1,t.variables,r.variables),Le);C.enqueue([{id:u,type:C.AT_JSON,url:u,overwrite_header:d,request_method:"POST",post_data:f,param:[e,r]}],l,null,null,null)}break;case Me:break;case Ie:c.state=Ne,r.curr_node=e.slot_idx_order}}},INHERIT_MAT:function(e,t,r,n,_,s){switch(t.state){case be:break;case ge:var o=a(e,r,function(e,t,r){for(var a=0;a<2;a++)t.objects["id"+a]=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths["id"+a],0),t.objects["id"+a]||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0)});B.inherit_material(o.objects.id0,e.materials_names.id0,o.objects.id1,e.materials_names.id1),r.curr_node=e.slot_idx_order}},SET_SHADER_NODE_PARAM:function(e,t,r,_,s,o){switch(t.state){case be:break;case ge:var i=a(e,r,function(e,t,r){e.objects_paths.id0&&(t.objects.id0=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0),e.objects_paths.id0||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),e.nodes_paths.id0.unshift(e.materials_names.id0))}).objects.id0,l=e.nodes_paths.id0,c=l[0],u=K.find_batch_material(i,c,"MAIN");if(r.curr_node=e.slot_idx_order,null===u)return void G.error('Material "'+c+'" was not found in the object "'+i.name+'".');if("ShaderNodeRGB"==e.shader_nd_type&&(d=B.get_node_rgb_ind_by_name_list(u.node_rgb_inds,l,1),B.set_nodemat_rgb(i,c,d,e.bools.id0?N(n(e.vars.id0,t.variables,r.variables),Se):e.floats.id0,e.bools.id1?N(n(e.vars.id1,t.variables,r.variables),Se):e.floats.id1,e.bools.id2?N(n(e.vars.id2,t.variables,r.variables),Se):e.floats.id2)),"ShaderNodeValue"==e.shader_nd_type){var d=B.get_node_val_ind_by_name_list(u.node_value_inds,l,1);B.set_nodemat_value(i,c,d,e.bools.id0?N(n(e.vars.id0,t.variables,r.variables),Se):e.floats.id0)}}},DELAY:function(e,t,r,_,s,o){var i=a(e,r);switch(t.state){case be:break;case ge:if(i.state==Ee)return i.state=we,i.timer=0,void(r.in_progress=!0);i.state==we&&(i.timer+=s,(e.bools.dl?N(n(e.vars.dl,t.variables,r.variables),Se):e.floats.dl)<i.timer&&(i.state=Ee,r.curr_node=e.slot_idx_order,r.in_progress=!1))}},APPLY_SHAPE_KEY:function(e,t,r,_,s,o){switch(t.state){case be:break;case ge:var i=a(e,r,function(e,t,r){var a=t.objects.id0=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0);a||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0);var n=e.common_usage_names.sk;Z.check_shape_keys(a)?Z.has_shape_key(a,n)||(G.error("Wrong key name:",n),e.mute=!0):(G.error("No shape keys in object:",a.name),e.mute=!0)});Z.apply_shape_key(i.objects.id0,e.common_usage_names.sk,e.bools.skv?N(n(e.vars.skv,t.variables,r.variables),Se):e.floats.skv),r.curr_node=e.slot_idx_order}},OUTLINE:function(e,t,r,_,s,o){var i=e.bools.id0;switch(t.state){case be:break;case ge:var l=a(e,r,function(e,t,r){i||(t.obj=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0),t.obj||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),t.obj&&t.obj.render&&t.obj.render.outlining||(G.error("Can't evaluate 'Outline' logic node: wrong object"),e.mute=!0))}),c=i?n(e.vars.id0,t.variables,r.variables):l.obj;switch(e.common_usage_names.outline_operation){case"PLAY":var u=c.render.outline_anim_settings_default;B.apply_outline_anim(c,u.outline_duration,u.outline_period,u.outline_relapses);break;case"STOP":B.clear_outline_anim(c);break;case"INTENSITY":B.set_outline_intensity(c,e.bools.in?N(n(e.vars.in,t.variables,r.variables),Se):e.floats.in)}r.curr_node=e.slot_idx_order}},MOVE_CAMERA:function(e,t,r,_,s,o){function i(e,t,r,a){switch(P.get_move_style(e)){case P.MS_TARGET_CONTROLS:P.set_trans_pivot(e,t,r);break;case P.MS_EYE_CONTROLS:case P.MS_STATIC:se.set_tsr(e,a);break;case P.MS_HOVER_CONTROLS:le.sub(r,t,fe),le.normalize(fe,fe),P.set_hover_pivot(e,r);var n=0,_=0;me[0]=fe[0],me[1]=0,me[2]=fe[2];var s=le.dot(me,fe);_=Math.acos(s/(le.length(me)*le.length(fe))),n=fe[2]?Math.atan(fe[0]/fe[2]):fe[0]>0?0:Math.PI,fe[2]>0&&fe[0]>0?pe[1]=-(Math.PI+pe[1]):fe[2]>0&&fe[0]<0?pe[1]=-(Math.PI+pe[1]):fe[2]<0&&fe[0]<0?(pe[0]+=Math.PI,n=-(Math.PI-n)):fe[2]<0&&fe[0]>0&&(pe[0]+=Math.PI,n-=Math.PI),P.set_rotation_hover_angles(e,n+Math.PI,-_)}se.update_transform(e),te.sync_transform(e)}function l(e,t,r,a){ee.lookAt(t,r,ie.AXIS_Z,ve),ee.invert(ve,ve);var n=he;J.fromMat4(ve,n),re.fromMat3(n,de),re.normalize(de,de);var _=oe.get_scale(e.render.world_tsr);oe.set_sep(t,_,de,a)}var c=e.bools.id0,u=e.bools.id1,d=e.bools.id2;switch(t.state){case be:break;case ge:var f=a(e,r,function(e,r,a){(r.objects.ca=A(e,"id0",c,t.variables,a.variables))||c||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),r.objects.tr=A(e,"id1",u,t.variables,a.variables),r.objects.tr||u||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),r.objects.ta=A(e,"id2",d,t.variables,a.variables),r.objects.ta||d||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),r.state=Ee,r.camera_state={trans_start:new Float32Array(3),trans_end:new Float32Array(3),interp_trans:new Float32Array(3),target_start:new Float32Array(3),target_end:new Float32Array(3),interp_target:new Float32Array(3),tsr_start:new Float32Array(8),tsr_end:new Float32Array(8),interp_tsr:new Float32Array(8)}}),m=c?n(e.vars.id0,t.variables,r.variables):f.objects.ca,p=u?n(e.vars.id1,t.variables,r.variables):f.objects.tr,h=d?n(e.vars.id2,t.variables,r.variables):f.objects.ta,v=oe.get_trans_view(p.render.world_tsr),b=oe.get_trans_view(h.render.world_tsr);switch(f.state){case Ee:var g=e.bools.dur?N(n(e.vars.dur,t.variables,r.variables),Se):e.floats.dur;if(0==g)return l(m,v,b,f.camera_state.tsr_end),i(m,v,b,f.camera_state.tsr_end),void(r.curr_node=e.slot_idx_order);var y=oe.get_trans_view(m.render.world_tsr);le.copy(y,f.camera_state.trans_start);var E=P.get_move_style(m);E==P.MS_HOVER_CONTROLS?le.copy(m.render.hover_pivot,f.camera_state.target_start):E==P.MS_STATIC||E==P.MS_EYE_CONTROLS?(oe.copy(m.render.world_tsr,f.camera_state.tsr_start),l(m,v,b,f.camera_state.tsr_end)):le.copy(m.render.pivot,f.camera_state.target_start),le.copy(v,f.camera_state.trans_end),le.copy(b,f.camera_state.target_end),f.state=we;var w=ne.animate(0,1,1e3*g,function(e){z.check_active()&&(E==P.MS_STATIC||E==P.MS_EYE_CONTROLS?oe.interpolate(f.camera_state.tsr_start,f.camera_state.tsr_end,ie.smooth_step(e),f.camera_state.interp_tsr):(f.camera_state.interp_target=le.lerp(f.camera_state.target_start,f.camera_state.target_end,ie.smooth_step(e),f.camera_state.interp_target),f.camera_state.interp_trans=le.lerp(f.camera_state.trans_start,f.camera_state.trans_end,ie.smooth_step(e),f.camera_state.interp_trans)),i(m,f.camera_state.interp_trans,f.camera_state.interp_target,f.camera_state.interp_tsr),1==e&&(f.state=Ae))});break;case we:break;case Ae:ne.clear_animation(w),f.state=Ee,r.curr_node=e.slot_idx_order}}},SET_CAMERA_MOVE_STYLE:function(e,t,r,_,s,o){var i=e.bools;switch(t.state){case be:break;case ge:var l=a(e,r,function(e,t,r){i.id0||(t.objects.id0=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0))||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),i.pvo&&!i.id1&&(t.objects.id1=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id1,0))}),c=i.id0?n(e.vars.id0,t.variables,r.variables):l.objects.id0,u=c.render;if(l.cam_state={target_cam_upside_down:u.target_cam_upside_down,use_panning:u.use_panning,horizontal_limits:u.horizontal_limits,vertical_limits:u.vertical_limits,distance_limits:u.distance_limits,hover_horiz_trans_limits:u.hover_horiz_trans_limits,hover_vert_trans_limits:u.hover_vert_trans_limits,pivot_limits:u.pivot_limits,enable_hover_hor_rotation:u.enable_hover_hor_rotation},ce.is_camera(c)){var d=c.render,f=l.cam_state;switch(P.wipe_move_style(c),e.common_usage_names.camera_move_style){case dt:d.move_style=P.MS_STATIC;break;case mt:d.move_style=P.MS_EYE_CONTROLS,m=oe.get_trans_view(d.world_tsr),P.setup_eye_model(c,m,null,f.horizontal_limits,f.vertical_limits);break;case pt:d.move_style=P.MS_HOVER_CONTROLS;var m=oe.get_trans_view(d.world_tsr),p=fe;e.bools.pvo?(h=i.id1?n(e.vars.id1,t.variables,r.variables):l.objects.id1,p=oe.get_trans_view(h.render.world_tsr)):(p[0]=e.bools.pvx?N(n(e.vars.pvx,t.variables,r.variables),Se):e.floats.pvx,p[1]=e.bools.pvy?N(n(e.vars.pvy,t.variables,r.variables),Se):e.floats.pvy,p[2]=e.bools.pvz?N(n(e.vars.pvz,t.variables,r.variables),Se):e.floats.pvz),P.setup_hover_model(c,m,p,f.distance_limits,f.vertical_limits,f.hover_horiz_trans_limits,f.hover_vert_trans_limits,f.enable_hover_hor_rotation);break;case ft:d.move_style=P.MS_TARGET_CONTROLS;var m=oe.get_trans_view(d.world_tsr),p=fe;if(e.bools.pvo){var h=i.id1?n(e.vars.id1,t.variables,r.variables):l.objects.id1;p=oe.get_trans_view(h.render.world_tsr)}else p[0]=e.bools.pvx?N(n(e.vars.pvx,t.variables,r.variables),Se):e.floats.pvx,p[1]=e.bools.pvy?N(n(e.vars.pvy,t.variables,r.variables),Se):e.floats.pvy,p[2]=e.bools.pvz?N(n(e.vars.pvz,t.variables,r.variables),Se):e.floats.pvz;P.setup_target_model(c,m,p,f.horizontal_limits,f.vertical_limits,f.distance_limits,f.pivot_limits,f.use_panning)}var v=me;v[0]=e.bools.vtr?N(n(e.vars.vtr,t.variables,r.variables),Se):e.floats.vtr,v[1]=e.bools.vro?N(n(e.vars.vro,t.variables,r.variables),Se):e.floats.vro,v[2]=e.bools.vzo?N(n(e.vars.vzo,t.variables,r.variables),Se):e.floats.vzo,v[0]=ie.clamp(v[0],0,1/0),v[1]=ie.clamp(v[1],0,1/0),v[2]=ie.clamp(v[2],0,.99),d.velocity_trans=v[0],d.velocity_rot=v[1],d.velocity_zoom=v[2],se.update_transform(c),te.sync_transform(c),P.init_ortho_props(c)}else G.error("Logic script error: object is not a Camera. Node: ",e.name);r.curr_node=e.slot_idx_order}},SET_CAMERA_LIMITS:function(e,t,r,_,s,o){var i=e.bools;switch(t.state){case be:break;case ge:var l=a(e,r,function(e,t,r){i.id0||(t.objects.id0=B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths.id0,0))||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0)}),c=i.id0?n(e.vars.id0,t.variables,r.variables):l.objects.id0;if(ce.is_camera(c)){switch(c.render.move_style){case P.MS_TARGET_CONTROLS:if(e.bools.dsl){var u=e.bools.dslmin?N(n(e.vars.dslmin,t.variables,r.variables),Se):e.floats.dslmin,d=e.bools.dslmax?N(n(e.vars.dslmax,t.variables,r.variables),Se):e.floats.dslmax;(A={}).min=Math.max(u,0),A.max=Math.max(d,0),P.set_distance_limits(c,A)}if(e.bools.vrl){var f=e.bools.vrldown?N(n(e.vars.vrldown,t.variables,r.variables),Se):e.floats.vrldown,m=e.bools.vrlup?N(n(e.vars.vrlup,t.variables,r.variables),Se):e.floats.vrlup;(A={}).down=f,A.up=m,A.camera_space="CAMERA"==e.common_usage_names.cam_lim_vert_rot_space_type,P.set_vertical_rot_limits(c,A)}if(e.bools.hrl){var p=e.bools.hrlleft?N(n(e.vars.hrlleft,t.variables,r.variables),Se):e.floats.hrlleft,h=e.bools.hrlright?N(n(e.vars.hrlright,t.variables,r.variables),Se):e.floats.hrlright;(A={}).left=p,A.right=h,A.camera_space="CAMERA"==e.common_usage_names.cam_lim_hor_rot_space_type,P.set_horizontal_rot_limits(c,A)}if(e.bools.pvl){var v=e.bools.pvlmin?N(n(e.vars.pvlmin,t.variables,r.variables),Se):e.floats.pvlmin,b=e.bools.pvlmax?N(n(e.vars.pvlmax,t.variables,r.variables),Se):e.floats.pvlmax;(A={}).min_z=v,A.max_z=b,P.set_pivot_limits(c,A)}break;case P.MS_HOVER_CONTROLS:if(e.bools.htl){var g=e.bools.htlmin?N(n(e.vars.htlmin,t.variables,r.variables),Se):e.floats.htlmin,y=e.bools.htlmax?N(n(e.vars.htlmax,t.variables,r.variables),Se):e.floats.htlmax;(A={}).min=g,A.max=y,P.set_hor_trans_limits(c,A)}if(e.bools.vtl){var E=e.bools.vtlmin?N(n(e.vars.vtlmin,t.variables,r.variables),Se):e.floats.vtlmin,w=e.bools.vtlmax?N(n(e.vars.vtlmax,t.variables,r.variables),Se):e.floats.vtlmax;(A={}).min=E,A.max=w,P.set_vert_trans_limits(c,A)}if(e.bools.vrl){var f=e.bools.vrldown?N(n(e.vars.vrldown,t.variables,r.variables),Se):e.floats.vrldown,m=e.bools.vrlup?N(n(e.vars.vrlup,t.variables,r.variables),Se):e.floats.vrlup;(A={}).down=f,A.up=m,A.camera_space="CAMERA"==e.common_usage_names.cam_lim_vert_rot_space_type,P.hover_set_vertical_limits(c,A)}if(e.bools.dsl){var u=e.bools.dslmin?N(n(e.vars.dslmin,t.variables,r.variables),Se):e.floats.dslmin,d=e.bools.dslmax?N(n(e.vars.dslmax,t.variables,r.variables),Se):e.floats.dslmax;(A={}).min=Math.max(u,0),A.max=Math.max(d,0),P.hover_set_distance_limits(c,A)}break;case P.MS_EYE_CONTROLS:if(e.bools.vrl){var f=e.bools.vrldown?N(n(e.vars.vrldown,t.variables,r.variables),Se):e.floats.vrldown,m=e.bools.vrlup?N(n(e.vars.vrlup,t.variables,r.variables),Se):e.floats.vrlup;(A={}).down=f,A.up=m,A.camera_space="CAMERA"==e.common_usage_names.cam_lim_vert_rot_space_type,P.set_vertical_rot_limits(c,A)}if(e.bools.hrl){var p=e.bools.hrlleft?N(n(e.vars.hrlleft,t.variables,r.variables),Se):e.floats.hrlleft,h=e.bools.hrlright?N(n(e.vars.hrlright,t.variables,r.variables),Se):e.floats.hrlright,A={};A.left=p,A.right=h,A.camera_space="CAMERA"==e.common_usage_names.cam_lim_hor_rot_space_type,P.set_horizontal_rot_limits(c,A)}break;case P.MS_STATIC:}se.update_transform(c),te.sync_transform(c)}else G.error("Logic script error: object is not a Camera. Node: ",e.name);r.curr_node=e.slot_idx_order}},MOVE_TO:function(e,t,r,_,s,o){function i(e,t){se.set_tsr(e,t),se.update_transform(e),te.sync_transform(e)}var l=e.bools,c=l.id0,u=l.id1;switch(t.state){case be:break;case ge:var d=a(e,r,function(e,r,a){r.objects.id0=A(e,"id0",c,t.variables,a.variables),r.objects.id0||c||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),r.objects.id1=A(e,"id1",u,t.variables,a.variables),r.objects.id1||u||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),r.state=Ee,r.obj_state={dest_tsr_start:new Float32Array(8),dest_tsr_end:new Float32Array(8),interp_tsr_dest:new Float32Array(8)}}),f=l.id0?n(e.vars.id0,t.variables,r.variables):d.objects.id0;if(f.is_dynamic){oe.copy(f.render.world_tsr,d.obj_state.dest_tsr_start);var m=l.id1?n(e.vars.id1,t.variables,r.variables):d.objects.id1;switch(oe.copy(m.render.world_tsr,d.obj_state.dest_tsr_end),d.state){case Ee:var p=e.bools.dur?N(n(e.vars.dur,t.variables,r.variables),Se):e.floats.dur;if(0==p)return i(f,d.obj_state.dest_tsr_end),void(r.curr_node=e.slot_idx_order);d.state=we;var h=ne.animate(0,1,1e3*p,function(e){z.check_active()&&(d.obj_state.interp_dest=oe.interpolate(d.obj_state.dest_tsr_start,d.obj_state.dest_tsr_end,ie.smooth_step(e),d.obj_state.interp_tsr_dest),i(f,d.obj_state.interp_tsr_dest),1==e&&(d.state=Ae))});break;case we:break;case Ae:ne.clear_animation(h),d.state=Ee,r.curr_node=e.slot_idx_order}break}G.error("Logic script error: object '"+f.name+"' must be dynamic. Node: ",e.name),r.curr_node=e.slot_idx_order}},TRANSFORM_OBJECT:function(e,t,r,_,s,o){function i(e,t,r){r==lt?se.set_tsr(e,t):se.set_tsr_rel(e,t),se.update_transform(e),te.sync_transform(e)}var l=e.bools.id0,c=a(e,r,function(e,r,a){r.obj=A(e,"id0",l,t.variables,a.variables),r.obj||l||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0),r.state=Ee,r.obj_state={space:lt,tsr_start:new Float32Array(8),tsr_end:new Float32Array(8),interp_tsr:new Float32Array(8)}});switch(t.state){case be:break;case ge:var u=l?n(e.vars.id0,t.variables,r.variables):c.obj;switch(c.state){case Ee:var d=me;d[0]=e.bools.trx?N(n(e.vars.trx,t.variables,r.variables),Se):e.floats.trx,d[1]=e.bools.try?N(n(e.vars.try,t.variables,r.variables),Se):e.floats.try,d[2]=e.bools.trz?N(n(e.vars.trz,t.variables,r.variables),Se):e.floats.trz;var f=fe;f[0]=e.bools.rox?N(n(e.vars.rox,t.variables,r.variables),Se)*Math.PI/180:e.floats.rox,f[1]=e.bools.roy?N(n(e.vars.roy,t.variables,r.variables),Se)*Math.PI/180:e.floats.roy,f[2]=e.bools.roz?N(n(e.vars.roz,t.variables,r.variables),Se)*Math.PI/180:e.floats.roz;var m=e.bools.sc?n(e.vars.sc,t.variables,r.variables):e.floats.sc;switch(ie.euler_to_quat(f,de),oe.set_sep(d,m,de,c.obj_state.tsr_end),c.obj_state.space=e.common_usage_names.space_type,c.obj_state.space){case lt:se.get_tsr(u,c.obj_state.tsr_start);break;case ct:se.get_tsr_rel(u,c.obj_state.tsr_start);break;case ut:se.get_tsr_rel(u,c.obj_state.tsr_start),oe.multiply(c.obj_state.tsr_start,c.obj_state.tsr_end,c.obj_state.tsr_end)}var p=e.bools.dur?N(n(e.vars.dur,t.variables,r.variables),Se):e.floats.dur;if(0==p)return i(u,c.obj_state.tsr_end,c.obj_state.space),void(r.curr_node=e.slot_idx_order);c.state=we;var h=ne.animate(0,1,1e3*p,function(e){z.check_active()&&(oe.interpolate(c.obj_state.tsr_start,c.obj_state.tsr_end,ie.smooth_step(e),c.obj_state.interp_tsr),i(u,c.obj_state.interp_tsr,c.obj_state.space),1==e&&(c.state=Ae))});break;case we:break;case Ae:ne.clear_animation(h),c.state=Ee,r.curr_node=e.slot_idx_order}}},SPEAKER_PLAY:function(e,t,r,_,s,o){var i=e.bools.id0;switch(t.state){case be:void 0==e.bools.not_wait&&(e.bools.not_wait=!0);break;case ge:var l=a(e,r,function(e,r,a){r.obj=A(e,"id0",i,t.variables,a.variables),r.obj||i||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0)});switch(l.obj=i?n(e.vars.id0,t.variables,r.variables):l.obj,ae.is_playing(l.obj)||l.state==we&&(l.state=Ae),l.state){case Ee:for(var c in t.logic_threads){var u=t.logic_threads[c].thread_state.curr_node;if(-1!=u){var d=t.logic_threads[c].nodes[u];"SPEAKER_PLAY"==d.type&&d!=e&&l.state==we&&d.obj==e.obj&&(d.state=Ae)}}e.bools.not_wait||(r.in_progress=!0),ae.play_def(l.obj),l.state=we;break;case we:e.bools.not_wait&&(r.curr_node=e.slot_idx_order,l.state=Ee);break;case Ae:e.bools.not_wait||(r.in_progress=!1),r.curr_node=e.slot_idx_order,l.state=Ee;break;default:ie.panic("Unknown state of "+e.name),l.state=Ee}}},SPEAKER_STOP:function(e,t,r,_,s,o){var i=e.bools.id0;switch(t.state){case be:break;case ge:var l=a(e,r,function(e,r,a){r.obj=A(e,"id0",i,t.variables,a.variables),r.obj||i||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0)}),c=i?n(e.vars.id0,t.variables,r.variables):l.obj;ae.stop(c),r.curr_node=e.slot_idx_order}},STOP_ANIM:function(e,t,r,_,s,o){var i=e.bools.id0,l=e.bools.env;switch(t.state){case be:break;case ge:var c=a(e,r,function(e,r,a){r.obj=l?y(e):A(e,"id0",i,t.variables,a.variables),r.obj||i||(G.error("Logic script error: object not found. Node: ",e.name),e.mute=!0)});c.obj=i?n(e.vars.id0,t.variables,r.variables):c.obj,L.stop(c.obj,L.SLOT_ALL),e.bools.rst&&L.set_first_frame(c.obj,L.SLOT_ALL),r.curr_node=e.slot_idx_order}},STOP_TIMELINE:function(e,t,r,a,n,_){switch(t.state){case ge:e.bools.rst&&U.set_offset_from_range_start(a),U.stop_nla(),r.curr_node=e.slot_idx_order}},CONSOLE_PRINT:function(e,t,r,a,_,s){switch(t.state){case ge:var o=0,i="{";for(var l in e.vars){o>0&&(i+=", ");var c=e.vars[l][1],u=n(e.vars[l],t.variables,r.variables);i+='"'+c+'": ';try{i+=JSON.stringify(u)}catch(e){i+=u?'{"name": "'+u.name+'", "type": "'+u.type+'"}':"Object"}++o}i+="}",G.log(e.common_usage_names.msg,i),r.curr_node=e.slot_idx_order}},STRING:function(e,t,r,a,s,o){switch(t.state){case ge:var i=e.bools.id0?N(n(e.vars.id0,t.variables,r.variables),Le):e.strings.id0,l=e.bools.id1?N(n(e.vars.id1,t.variables,r.variables),Le):e.strings.id1,c=0;switch(e.common_usage_names.string_operation){case Je:c=i+l;break;case $e:c=i.indexOf(l);break;case et:var u=e.bools.id2?N(n(e.vars.id2,t.variables,r.variables),Le):e.strings.id2;c=i.replace(l,u);break;case tt:var d=e.vars;c=i.substring(0,i.indexOf(l)),_(d.dst1,t.variables,r.variables,i.substring(i.indexOf(l)+1,i.length)),""==n(d.dst,t.variables,r.variables)&&(c=n(d.dst1,t.variables,r.variables),_(d.dst1,t.variables,r.variables,""));break;case rt:switch(e.common_usage_names.condition){case it:c=i==l?1:0;break;case ot:c=i!=l?1:0;break;case st:c=i<l?1:0;break;case _t:c=i>l?1:0;break;case nt:c=i<=l?1:0;break;case at:c=i>=l?1:0}}_(e.vars.dst,t.variables,r.variables,c),r.curr_node=e.slot_idx_order}},GET_TIMELINE:function(e,t,r,a,n,s){switch(t.state){case ge:var o=e.bools.nla?N(U.get_frame(a),Se):N(ne.get_frame(a),Se);_(e.vars.vd,t.variables,r.variables,o),r.curr_node=e.slot_idx_order}},JSON:function(e,t,r,a,s,o){switch(t.state){case ge:switch(e.common_usage_names.json_operation){case"PARSE":try{var i=N(n(e.vars.jsn,t.variables,r.variables),Le);!function(e,t,r,a){for(var n=0;n<t.length;n++){for(var _=t[n].split("."),s=e,o=r[n],i=0;i<_.length&&void 0!==(s=s[_[i]])&&null!==s;i++);s=M(s),a[o]=s}}(JSON.parse(i),e.parse_json_paths,e.parse_json_vars,r.variables)}catch(e){G.error("logic script error: non valid JSON string")}break;case"ENCODE":var l={};!function(e,t,r,a){a||(a={});for(var n=0;n<t.length;n++){var _=t[n].split("."),s=a,o=r[n];if(o in e){for(var i=0;i<_.length-1;i++)void 0===s[_[i]]&&(isNaN(_[i+1])?s[_[i]]={}:s[_[i]]=[]),s=s[_[i]];s[_[_.length-1]]=M(e[o])}}}(r.variables,e.encode_json_paths,e.encode_json_vars,l);var c=N(JSON.stringify(l),Le);_(e.vars.jsn,t.variables,r.variables,c)}r.curr_node=e.slot_idx_order}},JS_CALLBACK:function(e,t,r,a,s,o){switch(t.state){case ge:for(var i,l=e.bools.cb?N(n(e.vars.cb,t.variables,r.variables),Le):e.strings.cb,c=[],u=0,d="id"+u,f=e.common_usage_names.js_cb_params;d in f;)i=f[d]==ht?B.get_object(B.GET_OBJECT_BY_DUPLI_NAME_LIST,e.objects_paths[d],0):n(e.vars[d],t.variables,r.variables),c.push(i),d="id"+ ++u;var m=[];for(d="out"+(u=0);d in e.vars;)i=n(e.vars[d],t.variables,r.variables),m.push(i),d="out"+ ++u;var p=1;if(l in gt){if(p=!gt[l](c,m))for(var h=0;h<m.length;h++)(d="out"+h)in e.vars&&_(e.vars[d],t.variables,r.variables,M(m[h]))}else G.error("logic script error: no custom callback with id "+l);p&&(r.curr_node=e.slot_idx_order)}},EMPTY:s,DATE_TIME:function(e,t,r,a,n,s){switch(t.state){case ge:var o,i,l,c,u,d,f=e.common_usage_names.time_type,m=new Date;"L"==f?(o=m.getFullYear(),i=m.getMonth(),l=m.getDate(),c=m.getHours(),u=m.getMinutes(),d=m.getSeconds()):(o=m.getUTCFullYear(),i=m.getUTCMonth(),l=m.getUTCDate(),c=m.getUTCHours(),u=m.getUTCMinutes(),d=m.getUTCSeconds()),e.bools.y&&_(e.vars.y,t.variables,r.variables,o),e.bools.M&&_(e.vars.M,t.variables,r.variables,i),e.bools.d&&_(e.vars.d,t.variables,r.variables,l),e.bools.h&&_(e.vars.h,t.variables,r.variables,c),e.bools.m&&_(e.vars.m,t.variables,r.variables,u),e.bools.s&&_(e.vars.s,t.variables,r.variables,d),r.curr_node=e.slot_idx_order}},ELAPSED:function(e,t,r,a,n,s){switch(t.state){case ge:_(e.vars.s,t.variables,r.variables,n),r.curr_node=e.slot_idx_order}},CALL_FUNC:function(e,t,r,a,n,_){switch(t.state){case be:for(var s=e.logic_node_trees.id0,o=e.logic_functions.id0,i=0;i<t.logic_functions.length;i++){var l=t.logic_functions[i];if(l.id[0][0]==s[0]&&l.id[0][1]==s[1]&&l.id[1]==o){e.func_id=i;break}}break;case ge:var c={};r.variables_references={};for(var u in e.vars){var d=e.vars[u][1],f=e.strings[u];c[f]=r.variables[d],u.startsWith("out")&&(r.variables_references[d]=f)}r.callstack.push({caller_node:e,variables:c,logic_func:t.logic_functions[e.func_id]}),r.variables=c,r.update_script_cycle=!0,r.curr_node=t.logic_functions[e.func_id].func.nodes[0].slot_idx_order}},DEF_FUNC:s,SWITCH:function(e,t,r,a,_,s){switch(t.state){case be:var o=Object.keys(e.vars);for(var i in o)o[i].startsWith("id")||o.splice(i,1);e.links_keys=o;break;case ge:var l=n(e.vars.v,t.variables,r.variables);for(var i in e.links_keys)if(l==n(e.vars[e.links_keys[i]],t.variables,r.variables))return void(r.curr_node=e.links_dict[e.links_keys[i]]);r.curr_node=e.slot_idx_order}}},bt=[],gt={},yt={};t.init_logic=function(e,t){var r={data_id:t,scene_name:e.name,state:0,nla_thread:null,scene:e,curr_thread:null,logic_threads:[],logic_functions:[],sorted_markers_values:[],variables:{},variables_references:{}};e._logic=r,R(e,r)},t.update=function(e,t){var r=U.get_start_time();if(!(r<=0))for(var a=0;a<bt.length;a++)p(a,e,t,r)},t.append_custom_cb=function(e,t){gt[e]=t},t.remove_custom_cb=function(e){delete gt[e]},t.run_ep=function(e,t){for(var r=0;r<bt.length;r++)if(bt[r].scene_name==e){for(var a=bt[r],n=0;n<a.logic_threads.length;n++){var _=a.logic_threads[n].nodes[0];if(_.name==t){_.bools.js&&(_.mute=!1),a.logic_threads[n].thread_state.curr_node=0;break}}break}};var Et=function(){return function(e,t,r,n){var _=n[0],s=n[1],o=n[2],i=a(_,o.thread_state);if(i.state==Oe){for(var l=0;l<i.sel_objs_len;l++)if(q.get_sensor_value(e,t,l)){for(var c=0;c<i.sel_obj_idxs.length;c++)if(i.sel_obj_idxs[c]==l)return s.nla_thread==i.thread?(U.is_play(s._nla)&&(i.state=Te),o.thread_state.in_progress||(i.state=ke,i.slot_idx_jump=i.links_idxs[c])):(i.state=ke,i.slot_idx_jump=i.links_idxs[c]),void(i.select_object_idx=l);i.select_object_idx=l}i.state=Re}}};t.cleanup=function(){bt.length=0,gt={},yt={}}}),Z=o("__reformer",function(e,t){function r(e){switch(e.type){case"VALTORGB":e.color_ramp||(e.color_ramp={elements:[{position:.5,color:[1,1,1,1]}]},o("node Color Ramp",e,"color_ramp"));break;case"CURVE_RGB":e.curve_mapping||(e.curve_mapping={curves_data:[[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]],curves_handle_types:["EXTRAPOLATED","EXTRAPOLATED","EXTRAPOLATED","EXTRAPOLATED"],curve_extend:[["AUTO","AUTO"],["AUTO","AUTO"],["AUTO","AUTO"],["AUTO","AUTO"]]},o("node RGB Curves",e,"curve_mapping"));break;case"CURVE_VEC":e.curve_mapping||(e.curve_mapping={curves_data:[[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]],curves_handle_types:["EXTRAPOLATED","EXTRAPOLATED","EXTRAPOLATED"],curve_extend:[["AUTO","AUTO"],["AUTO","AUTO"],["AUTO","AUTO"]]},o("node Vector Curves",e,"curve_mapping"));break;case"MAPPING":e.vector_type||(e.vector_type="POINT",o("node Mapping",e,"vector_type"));break;case"MATERIAL":case"MATERIAL_EXT":"alpha"in e||(e.alpha=1,o("node material",e,"alpha")),"darkness"in e||(e.darkness=1,o("node material",e,"darkness")),"diffuse_toon_size"in e||(e.diffuse_toon_size=.5,o("node material",e,"diffuse_toon_size")),"diffuse_toon_smooth"in e||(e.diffuse_toon_smooth=.1,o("node material",e,"diffuse_toon_smooth")),"diffuse_intensity"in e||(e.diffuse_intensity=1,o("node material",e,"diffuse_intensity")),"use_tangent_shading"in e||(e.use_tangent_shading=!1,o("node material",e,"use_tangent_shading")),"specular_shader"in e||(e.specular_shader="COOKTORR",o("node material",e,"specular_shader")),"specular_ior"in e||(e.specular_ior=4,o("node material",e,"specular_ior")),"specular_hardness"in e||(e.specular_hardness=50,o("node material",e,"specular_hardness")),"specular_slope"in e||(e.specular_slope=.1,o("node material",e,"specular_slope")),"specular_toon_size"in e||(e.specular_toon_size=.5,o("node material",e,"specular_toon_size")),"specular_toon_smooth"in e||(e.specular_toon_smooth=.1,o("node material",e,"specular_toon_smooth")),"specular_intensity"in e||(e.specular_intensity=.5,o("node material",e,"specular_intensity")),"diffuse_shader"in e||(e.diffuse_shader="LAMBERT",o("node material",e,"diffuse_shader")),"roughness"in e||(e.roughness=.5,o("node material",e,"roughness")),"diffuse_fresnel"in e||(e.diffuse_fresnel=.1,o("node material",e,"diffuse_fresnel")),"diffuse_fresnel_factor"in e||(e.diffuse_fresnel_factor=.5,o("node material",e,"diffuse_fresnel_factor"));break;case"MATH":case"MIX_RGB":"use_clamp"in e||(e.use_clamp=!1,o("node "+e.type,e,"use_clamp"));break;case"GROUP":switch(e.node_tree_name=e.node_tree_name.replace(/\.[0-9]{3,}$/g,""),e.node_tree_name){case"CLAMP":case"LEVELS_OF_QUALITY":case"LINEAR_TO_SRGB":case"NORMAL_VIEW":case"PARALLAX":case"REFLECT":case"REFRACTION":case"REPLACE":case"SMOOTHSTEP":case"SRGB_TO_LINEAR":case"TIME":case"TRANSLUCENCY":case"VECTOR_VIEW":e.node_tree_name="B4W_"+e.node_tree_name}break;case"VECT_TRANSFORM":"convert_from"in e||(e.convert_from="WORLD",o("node "+e.type,e,"convert_from")),"convert_to"in e||(e.convert_to="WORLD",o("node "+e.type,e,"convert_to")),"vector_type"in e||(e.vector_type="POINT",o("node "+e.type,e,"vector_type"))}}function a(e){var t=e.nla_tracks;if(t)for(var r=0;r<t.length;r++)for(var a=t[r],n=0;n<a.strips.length;n++){var _=a.strips[n];"action"in _||(_.action=null,o("strip",_,"action")),"action_frame_start"in _||(_.action_frame_start=0,o("strip",_,"action_frame_start")),"action_frame_end"in _||(_.action_frame_end=_.frame_end-_.frame_start,o("strip",_,"action_frame_end")),"repeat"in _||(_.repeat=1,o("strip",_,"repeat")),"use_reverse"in _||(_.use_reverse=!1,o("strip",_,"use_reverse")),"scale"in _||(_.scale=1,o("strip",_,"scale"))}}function n(e){for(var t=["b4w_apply_scale","b4w_apply_modifiers","b4w_export_edited_normals","b4w_loc_export_vertex_anim","b4w_shape_keys"],r=null,a=0;a<t.length;a++)e[t[a]]&&(r?(e[t[a]]=!1,P.warn('WARNING property "'+t[a]+'" of object "'+e.name+'" has been set to "false". Foreground property "'+r+'" already exists.')):r=t[a])}function _(e){var t=e.game,r=t.collision_bounds_type;t.use_collision_bounds&&"BOX"!=r&&"CYLINDER"!=r&&"CONE"!=r&&"SPHERE"!=r&&"CAPSULE"!=r&&"EMPTY"!=r&&(P.error("Wrong collision bounds type "+r+". Disable physics for object "+e.name),e.b4w_collision=!1,e.b4w_floating=!1,e.b4w_vehicle=!1,e.b4w_character=!1)}function s(e,t){var r=e[0],a=e[1],n=e[2],_=e[3];return t[0]=_,t[1]=r,t[2]=a,t[3]=n,t}function o(e,t,r){if(H){var a=r+">>"+e;a in X||(X[a]={storage:[],report_type:"undefined",type:e}),X[a].storage.push(t.name)}else V=!0}function c(e,t){H?P.warn("WARNING Datablock "+e+' is missing, reexport "'+t+'" scene'):V=!0}function f(e,t,r){if(H){var a=r+">>"+e;a in X||(X[a]={storage:[],report_type:"deprecated",type:e}),X[a].storage.push(t.name)}else V=!0}function v(e,t,r){H?P.error("WARNING Incomplete modifier "+String(e)+' for "'+t.name+'", reexport "'+r+'" scene'):V=!0}function y(e){H?P.warn(e):V=!0}function E(e){var t=e.scale;if(0==t[0]&&0==t[1]&&0==t[2])return!0;var r=Math.abs((t[0]-t[1])/t[0]),a=Math.abs((t[1]-t[2])/t[1]);return r<.005&&a<.005}function w(e){return e.scale[0]<0||e.scale[1]<0||e.scale[2]<0}function A(e){for(var t=e.modifiers,r=0;r<t.length;r++){var a=t[r].type;if("ARRAY"==a||"CURVE"==a)return!0}return!1}function T(e,t){for(var r=0,a=0,n=0,_=new Float32Array(16),s=[],o=1;o<t.count;o++){if(t.use_constant_offset&&(r+=t.constant_offset_displace[0],a+=t.constant_offset_displace[1],n+=t.constant_offset_displace[2]),t.use_relative_offset){var i=e.b4w_boundings.bb;r+=(i.max_x-i.min_x)*t.relative_offset_displace[0],a+=(i.max_y-i.min_y)*t.relative_offset_displace[1],n+=(i.max_z-i.min_z)*t.relative_offset_displace[2]}F.trans_matrix(r,a,n,_);var l=R(e);M(l,_),s.push(l)}for(o=0;o<s.length;o++)k(e,s[o])}function x(e,t){for(var r=t.object,a=L.create_spline(r),n=new Float32Array(16),_=a.is_3d?4:3,s=new Float32Array(_),o=new Float32Array(_),i=new Float32Array(3),l=new Float32Array(4),c=new Float32Array(4),u=new Float32Array(3),d=new Float32Array(3),f=new Float32Array(3),m=0;m<e.submeshes.length;m++){var p=e.submeshes[m],h=p.position,v=p.tbn,b=O(t.deform_axis);u[0]=0,u[1]=0,u[2]=0,u[b]=1;for(var g=L.spline_length(a),y=0;y<h.length/3;y++){f[0]=h[3*y],f[1]=h[3*y+1],f[2]=h[3*y+2];var E=f[b],w=L.spline_len_to_t(a,E);if(L.spline_point(a,w,s),i[0]=s[0],i[1]=s[1],i[2]=s[2],L.spline_derivative(a,w,o),d[0]=o[0],d[1]=0,d[2]=o[2],B.normalize(d,d),D.rotationTo(u,d,l),E<0?(s[0]=d[0],s[1]=d[1],s[2]=d[2],B.scale(s,E,s),B.add(i,s,i)):E>g&&(s[0]=d[0],s[1]=d[1],s[2]=d[2],B.scale(s,E-g,s),B.add(i,s,i)),C.fromRotationTranslation(l,i,n),a.is_3d){var A=s[3];D.setAxisAngle(u,A,c),B.transformQuat(f,c,f)}f[b]=0,B.transformMat4(f,n,f),h[3*y]=f[0],h[3*y+1]=f[1],h[3*y+2]=f[2];var T=U.get_item(v,y,J);U.multiply_quat(T,l,T),U.set_item(v,T,y)}}}function O(e){switch(e){case"POS_X":case"NEG_X":return 0;case"POS_Y":case"NEG_Y":return 1;case"POS_Z":case"NEG_Z":return 2;default:F.panic("Wrong deform axis value "+e)}}function R(e,t){t||(t=e.name+"_COPY");var r=e.materials,a=e.submeshes;e.materials=null,e.submeshes=null;var n=F.clone_object_r(e);e.materials=r,e.submeshes=a,n.name=t,n.materials=e.materials.slice(0),n.submeshes=[];for(var _=0;_<a.length;_++){var s=a[_],o=F.clone_object_nr(s);n.submeshes.push(o)}return n}function k(e,t){for(var r=0;r<e.submeshes.length;r++){var a=e.submeshes[r],n=t.submeshes[r],_=a.base_length,s=a.indices.length;if(_)for(var o in a)switch(o){case"base_length":a[o]+=n[o];break;case"boundings":break;case"indices":a[o]=F.uint32_concat(a[o],n[o]);for(var i=s;i<a[o].length;i++)a[o][i]+=_;break;case"position":a[o]=N(a[o],n[o],a[o].length/_/3);break;case"tbn":a[o]=N(a[o],n[o],a[o].length/_/4);break;case"shade_tangs":a[o]=N(a[o],n[o],a[o].length/_/3);break;case"group":a[o]=N(a[o],n[o],a[o].length/_);break;case"texcoord":a[o]=N(a[o],n[o],a.uv_layers.length);break;case"color":a[o]=N(a[o],n[o],a.vertex_colors.length);break;case"uv_layers":case"vertex_colors":break;default:P.warn('array_mesh_join(): unknown submesh property "'+o+'"'),a[o]=F.float32_concat(a[o],n[o])}}return e}function N(e,t,r){if(r>1){for(var a=e.length/r,n=t.length/r,_=new Float32Array(e.length+t.length),s=0,o=0;o<r;o++)_.set(e.subarray(a*o,a*(o+1)),s),s+=a,_.set(t.subarray(n*o,n*(o+1)),s),s+=n;return _}return F.float32_concat(e,t)}function M(e,t){for(var r=G.fromMat4(t,Z),a=D.fromMat3(r,$),n=0;n<e.submeshes.length;n++){var _=e.submeshes[n];F.positions_multiply_matrix(_.position,t,_.position,0),U.multiply_quat(_.tbn,a,_.tbn)}}var I=b(e),S=g(e),L=q(e),C=i(e),P=m(e),D=d(e),U=p(e),F=h(e),B=l(e),G=u(e),j=K(e),z=Q(e),Y=S.defaults,H=!0,W=[5,4],V=!1,X={},Z=G.create(),J=U.create(),$=D.create();t.check_particles_bin_format=function(e){return-1!=F.version_cmp(e,W)},t.check_bpy_data=function(e){X={};var t=e.worlds;if(0==t.length){c("world",e.b4w_filepath_blend);var i={name:"DEFAULT",horizon_color:new Float32Array([0,0,0]),zenith_color:new Float32Array([0,0,0]),light_settings:{use_environment_light:!1,environment_energy:1,environment_color:"PLAIN"},fog_settings:{use_fog:!1,intensity:0,depth:25,start:5,height:0,falloff:"INVERSE_QUADRATIC",use_custom_color:!0,color:[.5,.5,.5]},use_sky_paper:!1,use_sky_blend:!1,use_sky_real:!1,use_nodes:!1,node_tree:null,texture_slots:[]};t.push(i)}for(m=0;m<t.length;m++){"use_sky_blend"in(i=t[m])||(o("world",i,"use_sky_blend"),i.use_sky_blend=!1),"use_sky_paper"in i||(o("world",i,"use_sky_paper"),i.use_sky_paper=!1),"use_sky_real"in i||(o("world",i,"use_sky_real"),i.use_sky_real=!1),"b4w_sky_settings"in i&&"rayleigh_brightness"in i.b4w_sky_settings||(o("world",i,"rayleigh_brightness"),i.b4w_sky_settings={render_sky:!1,procedural_skydome:!1,use_as_enviroment_map:!1,color:[.24,.43,.75],rayleigh_brightness:3.3,mie_brightness:.1,spot_brightness:10,scatter_strength:.2,rayleigh_strength:.2,mie_strength:.006,rayleigh_collection_power:.5,mie_collection_power:.5,mie_distribution:.4}),"fog_settings"in i||(o("world",i,"fog_settings"),i.fog_settings={use_fog:!1,intensity:0,depth:25,start:0,height:0,falloff:"QUADRATIC",use_custom_color:!0,color:[.5,.5,.5]},"b4w_fog_color"in i&&(i.fog_settings.use_custom_color=!0,i.fog_settings.color=i.b4w_fog_color),"b4w_fog_density"in i&&i.b4w_fog_density>0&&(i.fog_settings.depth=1/i.b4w_fog_density)),"render_sky"in i.b4w_sky_settings||(o("world",i,"render_sky"),i.b4w_sky_settings.render_sky=!1);for(var l=i.texture_slots,u=0;u<l.length;u++)"blend_type"in(ne=l[u])||(ne.blend_type="MIX",o("world_texture_slot",ne,"blend_type")),"use_map_blend"in ne||(ne.use_map_blend=!1,o("world_texture_slot",ne,"use_map_blend")),"use_map_horizon"in ne||(ne.use_map_horizon=!0,o("world_texture_slot",ne,"use_map_horizon")),"use_map_zenith_up"in ne||(ne.use_map_zenith_up=!1,o("world_texture_slot",ne,"use_map_zenith_up")),"use_rgb_to_intensity"in ne||(ne.use_rgb_to_intensity=!1,o("world_texture_slot",ne,"use_rgb_to_intensity")),"invert"in ne||(ne.invert=!1,o("world_texture_slot",ne,"invert")),"color"in ne||(ne.color=[1,0,1],o("world_texture_slot",ne,"color")),"blend_factor"in ne||(ne.blend_factor=0,o("world_texture_slot",ne,"blend_factor")),"horizon_factor"in ne||(ne.horizon_factor=1,o("world_texture_slot",ne,"horizon_factor")),"zenith_up_factor"in ne||(ne.zenith_up_factor=0,o("world_texture_slot",ne,"zenith_up_factor")),"zenith_down_factor"in ne||(ne.zenith_down_factor=0,o("world_texture_slot",ne,"zenith_down_factor")),"default_value"in ne||(ne.default_value=1,o("world_texture_slot",ne,"default_value"));"b4w_use_default_animation"in i||(o("world",i,"b4w_use_default_animation"),i.b4w_use_default_animation=!1),"b4w_anim_behavior"in i||(o("world",i,"b4w_anim_behavior"),i.b4w_anim_behavior="CYCLIC")}for(var d=e.scenes,m=0;m<d.length;m++){var p=d[m],h=p.world;if("timeline_markers"in p||(p.timeline_markers=null,o("scene",p,"timeline_markers")),"boolean"==typeof p.b4w_enable_physics&&(p.b4w_enable_physics="AUTO"),"b4w_reflection_quality"in p||(p.b4w_reflection_quality="MEDIUM",o("scene",p,"b4w_reflection_quality")),"b4w_use_nla"in p||(p.b4w_use_nla=!1,o("scene",p,"b4w_use_nla")),"fps"in p||(p.fps=24,o("scene",p,"fps")),"b4w_nla_cyclic"in p||(p.b4w_nla_cyclic=!1,o("scene",p,"b4w_nla_cyclic")),"b4w_logic_nodes"in p||(p.b4w_logic_nodes=[],o("scene",p,"b4w_logic_nodes")),"b4w_detect_collisions"in p&&(f("scene",p,"b4w_detect_collisions"),delete p.b4w_detect_collisions),"audio_doppler_speed"in p||(p.audio_doppler_speed=343.3),"audio_doppler_factor"in p||(p.audio_doppler_factor=1),"b4w_dynamic_compressor_settings"in p||(p.b4w_dynamic_compressor_settings={threshold:-24,knee:30,ratio:12,attack:.003,release:.25},o("scene",p,"b4w_dynamic_compressor_settings")),"b4w_enable_convolution_engine"in p||(p.b4w_enable_convolution_engine=!1),"b4w_enable_bloom"in p||(p.b4w_enable_bloom=!1,o("scene",p,"b4w_enable_bloom")),"b4w_enable_motion_blur"in p||(p.b4w_enable_motion_blur=!1,o("scene",p,"b4w_enable_motion_blur")),"b4w_enable_color_correction"in p||(p.b4w_enable_color_correction=!1,o("scene",p,"b4w_enable_color_correction")),"b4w_antialiasing_quality"in p||(p.b4w_antialiasing_quality="MEDIUM",o("scene",p,"b4w_antialiasing_quality")),"b4w_tags"in p||(p.b4w_tags={title:"",description:""},o("scene",p,"b4w_tags")),"b4w_lod_smooth_type"in p||(p.b4w_lod_smooth_type="OFF",o("scene",p,"b4w_lod_smooth_type")),"b4w_lod_hyst_interval"in p||(p.b4w_lod_hyst_interval=0,o("scene",p,"b4w_lod_hyst_interval")),"b4w_enable_object_selection"in p||(p.b4w_enable_object_selection="AUTO",o("scene",p,"b4w_enable_object_selection")),"b4w_enable_outlining"in p||(p.b4w_enable_outlining="AUTO",o("scene",p,"b4w_enable_outlining")),"b4w_enable_glow_materials"in p||(p.b4w_enable_glow_materials="AUTO",o("scene",p,"b4w_enable_glow_materials")),"b4w_enable_anchors_visibility"in p||(p.b4w_enable_anchors_visibility="AUTO",o("scene",p,"b4w_enable_anchors_visibility")),"b4w_outline_color"in p||(p.b4w_outline_color=[1,1,1],o("scene",p,"b4w_outline_color")),"b4w_outline_factor"in p||(p.b4w_outline_factor="b4w_glow_factor"in p?p.b4w_glow_factor:1,o("scene",p,"b4w_outline_factor")),!("b4w_shadow_settings"in p)){o("scene",p,"b4w_shadow_settings");var b=h.b4w_shadow_settings;p.b4w_shadow_settings=b||{csm_resolution:2048,blur_samples:"16x",self_shadow_polygon_offset:1,b4w_enable_csm:!1,csm_num:1,csm_first_cascade_border:10,first_cascade_blur_radius:3,csm_last_cascade_border:100,last_cascade_blur_radius:1.5,fade_last_cascade:!0,blend_between_cascades:!0}}var g=p.b4w_shadow_settings;if("csm_resolution"in g||(o("scene",p,"b4w_shadow_settings.csm_resolution"),g.csm_resolution=2048),"blur_samples"in g||(o("scene",p,"b4w_shadow_settings.blur_samples"),g.blur_samples="16x"),"soft_shadows"in g||(o("scene",p,"b4w_shadow_settings.soft_shadows"),g.soft_shadows=!0),"self_shadow_polygon_offset"in g||(o("scene",p,"b4w_shadow_settings.self_shadow_polygon_offset"),g.self_shadow_polygon_offset=1),"self_shadow_normal_offset"in g||(o("scene",p,"b4w_shadow_settings.self_shadow_normal_offset"),g.self_shadow_normal_offset=.01),"b4w_enable_csm"in g||(o("scene",p,"b4w_shadow_settings.b4w_enable_csm"),g.b4w_enable_csm=!1),"csm_num"in g||(o("scene",p,"b4w_shadow_settings.csm_num"),g.csm_num=1),"csm_first_cascade_border"in g||(o("scene",p,"b4w_shadow_settings.csm_first_cascade_border"),g.csm_first_cascade_border=10),"first_cascade_blur_radius"in g||(o("scene",p,"b4w_shadow_settings.first_cascade_blur_radius"),g.first_cascade_blur_radius=3),"csm_last_cascade_border"in g||(o("scene",p,"b4w_shadow_settings.csm_last_cascade_border"),g.csm_last_cascade_border=100),"last_cascade_blur_radius"in g||(o("scene",p,"b4w_shadow_settings.last_cascade_blur_radius"),g.last_cascade_blur_radius=1.5),"fade_last_cascade"in g||(o("scene",p,"b4w_shadow_settings.fade_last_cascade"),g.fade_last_cascade=!0),"blend_between_cascades"in g||(o("scene",p,"b4w_shadow_settings.blend_between_cascades"),g.blend_between_cascades=!0),!("b4w_ssao_settings"in p)){o("scene",p,"b4w_ssao_settings");var A=h.b4w_ssao_settings;p.b4w_ssao_settings=A||{dist_factor:0,samples:16,hemisphere:!1,blur_depth:!1,blur_discard_value:1}}var T=p.b4w_ssao_settings;if("dist_factor"in T||(o("scene",p,"b4w_ssao_settings.dist_factor"),T.dist_factor=0),"samples"in T||(o("scene",p,"b4w_ssao_settings.samples"),T.samples=16),"hemisphere"in T||(o("scene",p,"b4w_ssao_settings.hemisphere"),T.hemisphere=!1),"blur_depth"in T||(o("scene",p,"b4w_ssao_settings.blur_depth"),T.blur_depth=!1),"blur_discard_value"in T||(o("scene",p,"b4w_ssao_settings.blur_discard_value"),T.blur_discard_value=1),!("b4w_bloom_settings"in p)){o("scene",p,"b4w_bloom_settings");var x=h.b4w_bloom_settings;p.b4w_bloom_settings=x||{key:.2,blur:4,edge_lum:1}}if("key"in p.b4w_bloom_settings||(o("scene",p,"b4w_bloom_settings.key"),p.b4w_bloom_settings.key=.2),"blur"in p.b4w_bloom_settings||(o("scene",p,"b4w_bloom_settings.blur"),p.b4w_bloom_settings.blur=4),"edge_lum"in p.b4w_bloom_settings||(o("scene",p,"b4w_bloom_settings.edge_lum"),p.b4w_bloom_settings.edge_lum=1),"adaptive"in p.b4w_bloom_settings||(o("scene",p,"b4w_bloom_settings.adaptive"),p.b4w_bloom_settings.adaptive=!0),"average_luminance"in p.b4w_bloom_settings||(o("scene",p,"b4w_bloom_settings.average_luminance"),p.b4w_bloom_settings.average_luminance=.5),!("b4w_motion_blur_settings"in p)){o("scene",p,"b4w_motion_blur_settings");var O=h.b4w_motion_blur_settings;p.b4w_motion_blur_settings=O||{motion_blur_factor:.01,motion_blur_decay_threshold:.01}}if("motion_blur_factor"in p.b4w_motion_blur_settings||(o("scene",p,"b4w_motion_blur_settings.motion_blur_factor"),p.b4w_motion_blur_settings.motion_blur_factor=.01),"motion_blur_decay_threshold"in p.b4w_motion_blur_settings||(o("scene",p,"b4w_motion_blur_settings.motion_blur_decay_threshold"),p.b4w_motion_blur_settings.motion_blur_decay_threshold=.01),!("b4w_color_correction_settings"in p)){o("scene",p,"b4w_color_correction_settings");var R=h.b4w_color_correction_settings;p.b4w_color_correction_settings=R||{brightness:0,contrast:0,exposure:1,saturation:1}}if(!("b4w_god_rays_settings"in p)){o("scene",p,"b4w_god_rays_settings");var k=h.b4w_god_rays_settings;p.b4w_god_rays_settings=k||{intensity:.7,max_ray_length:1,steps_per_pass:10}}if("steps_per_pass"in p.b4w_god_rays_settings||(o("scene",p,"b4w_god_rays_settings.steps_per_pass"),p.b4w_god_rays_settings.steps_per_pass=10),!("b4w_glow_settings"in p)){o("scene",p,"b4w_glow_settings"),p.b4w_glow_settings={render_glow_over_blend:!1,small_glow_mask_coeff:2,large_glow_mask_coeff:2,small_glow_mask_width:2,large_glow_mask_width:6};var N=p.b4w_glow_settings;"b4w_render_glow_over_blend"in h&&(N.render_glow_over_blend=h.b4w_render_glow_over_blend),"b4w_small_glow_mask_coeff"in h&&(N.small_glow_mask_coeff=h.b4w_small_glow_mask_coeff),"b4w_large_glow_mask_coeff"in h&&(N.large_glow_mask_coeff=h.b4w_large_glow_mask_coeff),"b4w_small_glow_mask_width"in h&&(N.small_glow_mask_width=h.b4w_small_glow_mask_width),"b4w_large_glow_mask_width"in h&&(N.large_glow_mask_width=h.b4w_large_glow_mask_width)}var M=p.b4w_render_shadows;"AUTO"!=M&&"OFF"!=M&&"ON"!=M&&(p.b4w_render_shadows=M?"ON":"OFF");var I=p.b4w_render_reflections;"OFF"!=I&&"ON"!=I&&(p.b4w_render_reflections=I?"ON":"OFF");var S=p.b4w_render_refractions;"AUTO"!=S&&"OFF"!=S&&"ON"!=S&&(p.b4w_render_refractions=S?"ON":"OFF"),"b4w_render_dynamic_grass"in p||(o("scene",p,"b4w_render_dynamic_grass"),p.b4w_render_dynamic_grass="AUTO"),p.b4w_nla_script&&f("scene",p,"b4w_nla_script"),"audio_distance_model"in p||(o("scene",p,"audio_distance_model"),p.audio_distance_model="INVERSE_CLAMPED"),"b4w_custom_prop"in p||(o("scene",p,"b4w_custom_prop"),p.b4w_custom_prop=null)}for(var L=e.meshes,m=0;m<L.length;m++){var C=L[m];if(!C.b4w_boundings){o("mesh",C,"b4w_boundings"),C.b4w_boundings={};var D=C.b4w_boundings;C.b4w_bounding_box?D.bb=C.b4w_bounding_box:D.bb={max_x:0,max_y:0,max_z:0,min_x:0,min_y:0,min_z:0},C.b4w_bounding_box_source?D.bb_src=C.b4w_bounding_box_source:D.bb_src=C.b4w_bounding_box,C.b4w_bounding_sphere_center?D.bs_cen=C.b4w_bounding_sphere_center:D.bs_cen=[0,0,0],C.b4w_bounding_cylinder_center?D.bc_cen=C.b4w_bounding_cylinder_center:D.bc_cen=[0,0,0],C.b4w_bounding_ellipsoid_center?D.be_cen=C.b4w_bounding_ellipsoid_center:D.be_cen=[0,0,0],C.b4w_bounding_ellipsoid_axes?D.be_ax=C.b4w_bounding_ellipsoid_axes:(j=D.bb,D.be_ax=[(j.max_x-j.min_x)/2,(j.max_y-j.min_y)/2,(j.max_z-j.min_z)/2]),C.b4w_rotated_bounding_box?D.rbb=C.b4w_rotated_bounding_box:(j=D.bb,D.rbb={rbb_c:[(j.max_x+j.min_x)/2,(j.max_y+j.min_y)/2,(j.max_z+j.min_z)/2],rbb_s:[1,1,1]}),C.b4w_cov_axis_x?D.caxis_x=C.b4w_cov_axis_x:D.caxis_x=[1,0,0],C.b4w_cov_axis_y?D.caxis_y=C.b4w_cov_axis_y:D.caxis_y=[0,1,0],C.b4w_cov_axis_z?D.caxis_z=C.b4w_cov_axis_z:D.caxis_z=[0,0,1]}"is_boundings_overridden"in C||(o("mesh",C,"is_boundings_overridden"),C.is_boundings_overridden=!1),"b4w_shape_keys"in C||(C.b4w_shape_keys=[],o("mesh",C,"b4w_shape_keys"));for(var U=!0,B=0;B<C.submeshes.length;B++){var G=C.submeshes[B];if("boundings"in G||(U=!1,G.boundings={be_ax:C.b4w_bounding_ellipsoid_axes,be_cen:C.b4w_bounding_ellipsoid_center,bb:{max_x:C.b4w_bounding_box.max_x,max_y:C.b4w_bounding_box.max_y,max_z:C.b4w_bounding_box.max_z,min_x:C.b4w_bounding_box.min_x,min_y:C.b4w_bounding_box.min_y,min_z:C.b4w_bounding_box.min_z}}),"uv_layers"in G||(o("submesh",C,"uv_layers"),G.uv_layers=C.uv_textures),"be_ax"in G.boundings||(G.boundings.be_ax=C.b4w_bounding_ellipsoid_axes),"be_cen"in G.boundings||(G.boundings.be_cen=C.b4w_bounding_ellipsoid_center),"bb"in G.boundings||(G.boundings.bb=C.b4w_bounding_box),!("rbb"in G.boundings)){var j=C.b4w_bounding_box;G.boundings.rbb={rbb_c:[(j.max_x+j.min_x)/2,(j.max_y+j.min_y)/2,(j.max_z+j.min_z)/2],rbb_s:[1,1,1]}}"caxis_x"in G.boundings||(G.boundings.caxis_x=[1,0,0]),"caxis_y"in G.boundings||(G.boundings.caxis_y=[0,1,0]),"caxis_z"in G.boundings||(G.boundings.caxis_z=[0,0,1])}for(U||o("mesh",C,"submesh_bd"),n(C),u=0;u<C.b4w_vertex_anim.length;u++){var z=C.b4w_vertex_anim[u];"allow_nla"in z||(o('mesh["b4w_vertex_anim"]',C,"allow_nla"),z.allow_nla=!0)}"active_uv_name"in C||(o("mesh",C,"active_uv_name"),C.active_uv_name="")}for(var H=e.cameras,m=0;m<H.length;m++){var W=H[m];W.type||(W.type="PERSP",o("camera",W,"type")),"b4w_eye_target_dist"in W&&(delete W.b4w_eye_target_dist,f("camera",W,"b4w_eye_target_dist")),"b4w_hover_zero_level"in W||(W.b4w_hover_zero_level=0,o("camera",W,"b4w_hover_zero_level")),"b4w_trans_velocity"in W||(W.b4w_trans_velocity=1,o("camera",W,"b4w_trans_velocity")),"b4w_rot_velocity"in W||(W.b4w_rot_velocity=1,o("camera",W,"b4w_rot_velocity")),"b4w_zoom_velocity"in W||(W.b4w_zoom_velocity=.1,o("camera",W,"b4w_zoom_velocity")),"b4w_use_target_distance_limits"in W||(W.b4w_use_target_distance_limits=W.b4w_use_distance_limits||!1,o("camera",W,"b4w_use_target_distance_limits")),"b4w_use_zooming"in W||(W.b4w_use_zooming=W.b4w_use_distance_limits||!1,o("camera",W,"b4w_use_zooming")),"b4w_distance_min"in W||(W.b4w_distance_min=1,o("camera",W,"b4w_distance_min")),"b4w_distance_max"in W||(W.b4w_distance_max=100,o("camera",W,"b4w_distance_max")),"b4w_horizontal_translation_min"in W||(W.b4w_horizontal_translation_min=-100,o("camera",W,"b4w_horizontal_translation_min")),"b4w_horizontal_translation_max"in W||(W.b4w_horizontal_translation_max=100,o("camera",W,"b4w_horizontal_translation_max")),"b4w_vertical_translation_min"in W||(W.b4w_vertical_translation_min=-100,o("camera",W,"b4w_vertical_translation_min")),"b4w_vertical_translation_max"in W||(W.b4w_vertical_translation_max=100,o("camera",W,"b4w_vertical_translation_max")),"b4w_use_horizontal_clamping"in W||(W.b4w_use_horizontal_clamping=!1,o("camera",W,"b4w_use_horizontal_clamping")),"b4w_rotation_left_limit"in W||(W.b4w_rotation_left_limit=-Math.PI,o("camera",W,"b4w_rotation_left_limit")),"b4w_rotation_right_limit"in W||(W.b4w_rotation_right_limit=Math.PI,o("camera",W,"b4w_rotation_right_limit")),"b4w_horizontal_clamping_type"in W||(W.b4w_horizontal_clamping_type="LOCAL",o("camera",W,"b4w_horizontal_clamping_type")),"b4w_use_vertical_clamping"in W||(W.b4w_use_vertical_clamping=!1,o("camera",W,"b4w_use_vertical_clamping")),"b4w_rotation_down_limit"in W||(W.b4w_rotation_down_limit=-Math.PI/2,o("camera",W,"b4w_rotation_down_limit")),"b4w_rotation_up_limit"in W||(W.b4w_rotation_up_limit=Math.PI/2,o("camera",W,"b4w_rotation_up_limit")),"b4w_vertical_clamping_type"in W||(W.b4w_vertical_clamping_type="LOCAL",o("camera",W,"b4w_vertical_clamping_type")),"b4w_hover_angle_min"in W||(W.b4w_hover_angle_min=Math.PI/6,o("camera",W,"b4w_hover_angle_min")),"b4w_hover_angle_max"in W||(W.b4w_hover_angle_max=Math.PI/6,o("camera",W,"b4w_hover_angle_max")),"b4w_enable_hover_hor_rotation"in W||(W.b4w_enable_hover_hor_rotation=!0,o("camera",W,"b4w_enable_hover_hor_rotation")),"b4w_use_panning"in W||(W.b4w_use_panning=!0,o("camera",W,"b4w_use_panning")),"b4w_use_pivot_limits"in W||(W.b4w_use_pivot_limits=!1,W.b4w_pivot_z_min=0,W.b4w_pivot_z_max=10,o("camera",W,"b4w_use_pivot_limits")),"b4w_dof_bokeh"in W||(W.b4w_dof_bokeh=!1,o("camera",W,"b4w_dof_bokeh")),"b4w_dof_bokeh_intensity"in W||(W.b4w_dof_bokeh_intensity=.3,o("camera",W,"b4w_dof_bokeh_intensity")),"b4w_dof_foreground_blur"in W||(W.b4w_dof_foreground_blur=!1,o("camera",W,"b4w_dof_foreground_blur")),"b4w_dof_front_start"in W||(W.b4w_dof_front_start=0,o("camera",W,"b4w_dof_front_start")),"b4w_dof_front_end"in W||(W.b4w_dof_front_end=W.b4w_dof_front,o("camera",W,"b4w_dof_front_end")),"b4w_dof_rear_start"in W||(W.b4w_dof_rear_start=0,o("camera",W,"b4w_dof_rear_start")),"b4w_dof_rear_end"in W||(W.b4w_dof_rear_end=W.b4w_dof_rear,o("camera",W,"b4w_dof_rear_end")),"sensor_fit"in W||(W.sensor_fit="VERTICAL",o("camera",W,"sensor_fit"))}for(var q=e.lamps,m=0;m<q.length;m++){var K=q[m];"b4w_generate_shadows"in K||(K.b4w_generate_shadows=!1,o("lamp",K,"b4w_generate_shadows")),"b4w_dynamic_intensity"in K||(K.b4w_dynamic_intensity=!1,o("lamp",K,"b4w_dynamic_intensity")),"use_diffuse"in K||(K.use_diffuse=!0,o("lamp",K,"use_diffuse")),"use_specular"in K||(K.use_specular=!0,o("lamp",K,"use_specular")),"clip_start"in K||(K.clip_start=.1,o("lamp",K,"clip_start")),"clip_end"in K||(K.clip_end=30,o("lamp",K,"clip_end")),"POINT"!=K.type&&"SPOT"!=K.type||("use_sphere"in K||(K.use_sphere=!1,o("lamp",K,"use_sphere")),Y.mali4_lamps_hack&&(K.type="SUN"))}for(var Z=e.speakers,m=0;m<Z.length;m++){var Q=Z[m];"b4w_behavior"in Q||(Q.b4w_background_music?Q.b4w_behavior="BACKGROUND_SOUND":Q.b4w_behavior="POSITIONAL"),"b4w_auto_play"in Q||(Q.b4w_auto_play=!1,o("speaker",Q,"b4w_auto_play")),"b4w_enable_doppler"in Q||(Q.b4w_enable_doppler=!1,o("speaker",Q,"b4w_enable_doppler")),"b4w_delay"in Q||(Q.b4w_delay=0),"b4w_delay_random"in Q||(Q.b4w_delay_random=0),"b4w_volume_random"in Q||(Q.b4w_volume_random=0),"b4w_pitch_random"in Q||(Q.b4w_pitch_random=0),"b4w_fade_in"in Q||(Q.b4w_fade_in=0),"b4w_fade_out"in Q||(Q.b4w_fade_out=0),"b4w_loop"in Q||(Q.b4w_loop=!1),"b4w_loop_start"in Q||(Q.b4w_loop_start=0,o("speaker",Q,"b4w_loop_start")),"b4w_loop_end"in Q||(Q.b4w_loop_end=0,o("speaker",Q,"b4w_loop_end")),Q.animation_data&&a(Q.animation_data)}for(var J=e.textures,m=0;m<J.length;m++){var $=J[m];"b4w_anisotropic_filtering"in $||($.b4w_anisotropic_filtering="OFF",o("texture",$,"b4w_anisotropic_filtering")),"b4w_water_foam"in $||($.b4w_water_foam=!1,o("texture",$,"b4w_water_foam")),"b4w_foam_uv_freq"in $||($.b4w_foam_uv_freq=[1,1],o("texture",$,"b4w_foam_uv_freq")),"b4w_foam_uv_magnitude"in $||($.b4w_foam_uv_magnitude=[1,1],o("texture",$,"b4w_foam_uv_magnitude")),"b4w_parallax_steps"in $||($.b4w_parallax_steps=5,o("material",$,"b4w_parallax_steps")),"b4w_parallax_lod_dist"in $||($.b4w_parallax_lod_dist=10,o("material",$,"b4w_parallax_lod_dist")),"b4w_shore_dist_map"in $||($.b4w_shore_dist_map=!1,o("texture",$,"b4w_shore_dist_map")),"b4w_shore_boundings"in $||($.b4w_shore_boundings=[1e3,-1e3,1e3,-1e3],o("texture",$,"b4w_shore_boundings")),"b4w_max_shore_dist"in $||($.b4w_max_shore_dist=100,o("texture",$,"b4w_max_shore_dist")),"b4w_disable_compression"in $||($.b4w_disable_compression=!1,o("texture",$,"b4w_disable_compression")),"b4w_source_type"in $||($.b4w_source_type="",o("texture",$,"b4w_source_type")),"b4w_source_id"in $||($.b4w_source_id="",o("texture",$,"b4w_source_id")),"b4w_source_size"in $||($.b4w_source_size=1024,o("texture",$,"b4w_source_size")),"b4w_enable_canvas_mipmapping"in $||($.b4w_enable_canvas_mipmapping=!0,o("texture",$,"b4w_enable_canvas_mipmapping")),"b4w_nla_video"in $||($.b4w_nla_video=!1,o("texture",$,"b4w_nla_video"))}for(var ee=e.images,m=0;m<ee.length;m++){var te=ee[m];"colorspace_settings_name"in te||(te.colorspace_settings_name="sRGB",o("image",te,"colorspace_settings_name"))}for(var re=e.materials,m=0;m<re.length;m++){var ae=re[m];"ALPHA_ANTIALIASING"==ae.game_settings.alpha_blend&&(Y.mali_alpha_antialias_hack?ae.game_settings.alpha_blend="CLIP":Y.msaa_samples<2&&(P.warn('Material "'+ae.name+'" has the "Alpha Anti-Aliasing" transparency type, but multisampling is disabled. Changed to "Alpha Clip".'),ae.game_settings.alpha_blend="CLIP")),"use_tangent_shading"in ae||(ae.use_tangent_shading=!1,o("material",ae,"use_tangent_shading")),"b4w_node_mat_type"in ae&&f("material",ae,"b4w_node_mat_type"),"b4w_skydome"in ae&&f("material",ae,"b4w_skydome"),"b4w_procedural_skydome"in ae&&f("material",ae,"b4w_procedural_skydome"),"b4w_lens_flares"in ae||(ae.b4w_lens_flares=!1,o("material",ae,"b4w_lens_flares")),"LENS_FLARES"===ae.name&&(ae.b4w_lens_flares||P.warn('"LENS_FLARES" material name has been found. Enable the "Lens Flare" property for this material.'),ae.b4w_lens_flares=!0),ae.b4w_water&&("b4w_water_shore_smoothing"in ae||(ae.b4w_water_shore_smoothing=!1,o("material",ae,"b4w_water_shore_smoothing")),"b4w_water_dynamic"in ae||(ae.b4w_water_dynamic=!1,o("material",ae,"b4w_water_dynamic")),"b4w_waves_height"in ae||(ae.b4w_waves_height=1,o("material",ae,"b4w_waves_height")),"b4w_waves_length"in ae||(ae.b4w_waves_length=1,o("material",ae,"b4w_waves_length")),"b4w_water_dst_noise_scale0"in ae||(ae.b4w_water_dst_noise_scale0=.05,o("material",ae,"b4w_water_dst_noise_scale0")),"b4w_water_dst_noise_scale1"in ae||(ae.b4w_water_dst_noise_scale1=.03,o("material",ae,"b4w_water_dst_noise_scale1")),"b4w_water_dst_noise_freq0"in ae||(ae.b4w_water_dst_noise_freq0=1.3,o("material",ae,"b4w_water_dst_noise_freq0")),"b4w_water_dst_noise_freq1"in ae||(ae.b4w_water_dst_noise_freq1=1,o("material",ae,"b4w_water_dst_noise_freq1")),"b4w_water_dir_min_shore_fac"in ae||(ae.b4w_water_dir_min_shore_fac=.4,o("material",ae,"b4w_water_dir_min_shore_fac")),"b4w_water_dir_freq"in ae||(ae.b4w_water_dir_freq=.5,o("material",ae,"b4w_water_dir_freq")),"b4w_water_dir_noise_scale"in ae||(ae.b4w_water_dir_noise_scale=.05,o("material",ae,"b4w_water_dir_noise_scale")),"b4w_water_dir_noise_freq"in ae||(ae.b4w_water_dir_noise_freq=.07,o("material",ae,"b4w_water_dir_noise_freq")),"b4w_water_dir_min_noise_fac"in ae||(ae.b4w_water_dir_min_noise_fac=.5,o("material",ae,"b4w_water_dir_min_noise_fac")),"b4w_water_dst_min_fac"in ae||(ae.b4w_water_dst_min_fac=.2,o("material",ae,"b4w_water_dst_min_fac")),"b4w_water_waves_hor_fac"in ae||(ae.b4w_water_waves_hor_fac=5,o("material",ae,"b4w_water_waves_hor_fac")),"b4w_water_absorb_factor"in ae||(ae.b4w_water_absorb_factor=6,o("material",ae,"b4w_water_absorb_factor")),"b4w_water_fog_color"in ae||(ae.b4w_water_fog_color=[.5,.7,.7],o("material",ae,"b4w_water_fog_color")),"b4w_foam_factor"in ae||(ae.b4w_foam_factor=5,o("material",ae,"b4w_foam_factor")),"b4w_generated_mesh"in ae||(ae.b4w_generated_mesh=!1,o("material",ae,"b4w_generated_mesh")),"b4w_water_num_cascads"in ae||(ae.b4w_water_num_cascads=5,o("material",ae,"b4w_water_num_cascads")),"b4w_water_subdivs"in ae||(ae.b4w_water_subdivs=64,o("material",ae,"b4w_water_subdivs")),"b4w_water_detailed_dist"in ae||(ae.b4w_water_detailed_dist=1e3,o("material",ae,"b4w_water_detailed_dist")),"b4w_water_enable_caust"in ae||(ae.b4w_water_enable_caust=!1,o("material",ae,"b4w_water_enable_caust")),"b4w_water_caust_scale"in ae||(ae.b4w_water_caust_scale=.25,o("material",ae,"b4w_water_caust_scale")),"b4w_water_caust_brightness"in ae||(ae.b4w_water_caust_brightness=.5,o("material",ae,"b4w_water_caust_brightness"))),"b4w_dynamic_grass_size"in ae||(ae.b4w_dynamic_grass_size=""),"b4w_dynamic_grass_color"in ae||(ae.b4w_dynamic_grass_color=""),"diffuse_intensity"in ae||(ae.diffuse_intensity=1,o("material",ae,"diffuse_intensity")),"b4w_use_ghost"in ae||(ae.b4w_use_ghost=!1),"b4w_collision_margin"in ae||(ae.b4w_collision_margin=.04,o("material",ae,"b4w_collision_margin")),"b4w_collision_group"in ae||(ae.b4w_collision_group=128,o("material",ae,"b4w_collision_group")),"b4w_collision_mask"in ae||(ae.b4w_collision_mask=127,o("material",ae,"b4w_collision_mask")),"b4w_do_not_render"in ae||(ae.b4w_do_not_render=!1,o("material",ae,"b4w_do_not_render")),"HALO"!=ae.type||"b4w_halo_sky_stars"in ae||(ae.b4w_halo_sky_stars=!1,o("material",ae,"b4w_halo_sky_stars")),"HALO"!=ae.type||"b4w_halo_stars_blend_height"in ae||(ae.b4w_halo_stars_blend_height=10,o("material",ae,"b4w_halo_stars_blend_height")),"HALO"!=ae.type||"b4w_halo_stars_min_height"in ae||(ae.b4w_halo_stars_min_height=0,o("material",ae,"b4w_halo_stars_min_height")),"specular_shader"in ae||(ae.specular_shader="COOKTORR",o("material",ae,"specular_shader")),"diffuse_shader"in ae||(ae.diffuse_shader="LAMBERT",o("material",ae,"diffuse_shader")),"roughness"in ae||(ae.roughness=.5,o("material",ae,"roughness")),"diffuse_fresnel"in ae||(ae.diffuse_fresnel=.1,o("material",ae,"diffuse_fresnel")),"diffuse_fresnel_factor"in ae||(ae.diffuse_fresnel_factor=.5,o("material",ae,"diffuse_fresnel_factor")),"specular_slope"in ae||(ae.specular_slope=.2,o("material",ae,"specular_slope")),"specular_toon_size"in ae||(ae.specular_toon_size=.5,o("material",ae,"specular_toon_size")),"specular_toon_smooth"in ae||(ae.specular_toon_smooth=.1,o("material",ae,"specular_toon_smooth")),"specular_alpha"in ae||(ae.specular_alpha=1,o("material",ae,"specular_alpha")),"b4w_wettable"in ae||(ae.b4w_wettable=!1,o("material",ae,"b4w_wettable")),"b4w_refractive"in ae||(ae.b4w_refractive=!1,o("material",ae,"b4w_refractive")),"b4w_refr_bump"in ae||(ae.b4w_refr_bump=0,o("material",ae,"b4w_refr_bump")),"b4w_shallow_water_col"in ae||(ae.b4w_shallow_water_col=[0,.8,.3],o("material",ae,"b4w_shallow_water_col")),"b4w_shore_water_col"in ae||(ae.b4w_shore_water_col=[0,.9,.2],o("material",ae,"b4w_shore_water_col")),"b4w_shallow_water_col_fac"in ae||(ae.b4w_shallow_water_col_fac=1,o("material",ae,"b4w_shallow_water_col_fac")),"b4w_shore_water_col_fac"in ae||(ae.b4w_shore_water_col_fac=.5,o("material",ae,"b4w_shore_water_col_fac")),"b4w_water_sss_strength"in ae||(ae.b4w_water_sss_strength=5.9,o("material",ae,"b4w_water_sss_strength")),"b4w_water_sss_width"in ae||(ae.b4w_water_sss_width=.45,o("material",ae,"b4w_water_sss_width")),"b4w_render_above_all"in ae||(ae.b4w_render_above_all=!1,o("material",ae,"b4w_render_above_all")),"b4w_water_norm_uv_velocity"in ae||(ae.b4w_water_norm_uv_velocity=.05,o("material",ae,"b4w_water_norm_uv_velocity")),"specular_ior"in ae||(ae.specular_ior=1,o("material",ae,"specular_ior")),"darkness"in ae||(ae.darkness=0,o("material",ae,"darkness")),"diffuse_toon_size"in ae||(ae.diffuse_toon_size=0,o("material",ae,"diffuse_toon_size")),"diffuse_toon_smooth"in ae||(ae.diffuse_toon_smooth=0,o("material",ae,"diffuse_toon_smooth")),"pass_index"in ae||(ae.pass_index=0,o("material",ae,"pass_index"));for(var l=ae.texture_slots,u=0;u<l.length;u++){var ne=l[u];"blend_type"in ne||(ne.blend_type="MIX",o("texture_slot",ne,"blend_type"))}if(ae.node_tree){for(var _e=ae.node_tree.nodes,u=0;u<_e.length;u++)r(_e[u]);ae.node_tree.animation_data&&a(ae.node_tree.animation_data)}}for(var se=e.node_groups,m=0;m<se.length;m++)for(var _e=se[m].node_tree.nodes,u=0;u<_e.length;u++)r(_e[u]);for(var oe=e.objects,m=0;m<oe.length;m++){var ie=oe[m];switch(ie.type){case"MESH":"b4w_dynamic_geometry"in ie||(ie.b4w_dynamic_geometry=!1),"b4w_reflexible"in ie||(ie.b4w_reflexible=!1),"b4w_reflexible_only"in ie||(ie.b4w_reflexible_only=!1),"b4w_reflective"in ie||(ie.b4w_reflective=!1),"b4w_reflection_type"in ie||(ie.b4w_reflection_type="PLANE",o("object",ie,"b4w_reflection_type")),"b4w_wind_bending"in ie||(ie.b4w_wind_bending=!1,o("object",ie,"b4w_wind_bending")),"b4w_wind_bending_angle"in ie||(ie.b4w_wind_bending_angle=10,ie.b4w_wind_bending_freq=.25,o("object",ie,"wind bending params")),"b4w_detail_bending_amp"in ie||(ie.b4w_detail_bending_amp=.1,ie.b4w_branch_bending_amp=.3,o("object",ie,"detail bending params")),"b4w_detail_bending_freq"in ie||(ie.b4w_detail_bending_freq=1,o("object",ie,"b4w_detail_bending_freq")),"b4w_main_bend_stiffness_col"in ie||(ie.b4w_main_bend_stiffness_col="",o("object",ie,"b4w_main_bend_stiffness_col")),"b4w_detail_bend_colors"in ie||(ie.b4w_detail_bend_colors={leaves_stiffness_col:"",leaves_phase_col:"",overall_stiffness_col:""},o("object",ie,"b4w_detail_bend_colors")),"b4w_caustics"in ie||(ie.b4w_caustics=!1),"vertex_groups"in ie&&ie.vertex_groups.length&&ie.data&&0==ie.data.vertex_groups.length&&(ie.data.vertex_groups=ie.vertex_groups,delete ie.vertex_groups,o("object",ie,"vertex_groups")),"b4w_vertex_anim"in ie&&ie.b4w_vertex_anim.length&&ie.data&&0==ie.data.b4w_vertex_anim.length&&(ie.data.b4w_vertex_anim=ie.b4w_vertex_anim,delete ie.b4w_vertex_anim,o("object",ie,"b4w_vertex_anim")),"b4w_do_not_render"in ie||(ie.b4w_do_not_render=!1),"b4w_hidden_on_load"in ie||(ie.b4w_hidden_on_load=!1),"b4w_hide_chldr_on_load"in ie||(ie.b4w_hide_chldr_on_load=!1),"use_ghost"in ie.game||(ie.game.use_ghost=!1),"use_sleep"in ie.game||(ie.game.use_sleep=!1),"velocity_min"in ie.game||(ie.game.velocity_min=0),"velocity_max"in ie.game||(ie.game.velocity_max=0),"collision_group"in ie.game||(ie.game.collision_group=1),"collision_mask"in ie.game||(ie.game.collision_mask=255),_(ie),"b4w_vehicle_settings"in ie?ie.b4w_vehicle_settings&&("steering_ratio"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.steering_ratio=10),"steering_max"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.steering_max=1),"inverse_control"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.inverse_control=!1),"force_max"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.force_max=1500),"brake_max"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.brake_max=100),"speed_ratio"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.speed_ratio=.027),"max_speed_angle"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.max_speed_angle=Math.PI),"delta_tach_angle"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.delta_tach_angle=4.43),"suspension_compression"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.suspension_compression=4.4),"suspension_stiffness"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.suspension_stiffness=20),"suspension_damping"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.suspension_damping=2.3),"wheel_friction"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.wheel_friction=1e3),"roll_influence"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.roll_influence=.1),"max_suspension_travel_cm"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.max_suspension_travel_cm=30),"floating_factor"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.floating_factor=3),"floating_factor"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.floating_factor=3),"water_lin_damp"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.water_lin_damp=.9),"water_rot_damp"in ie.b4w_vehicle_settings||(ie.b4w_vehicle_settings.water_rot_damp=.9)):(ie.b4w_vehicle_settings=null,o("object",ie,"b4w_vehicle_settings")),"b4w_floating_settings"in ie?ie.b4w_floating_settings&&("floating_factor"in ie.b4w_floating_settings||(ie.b4w_floating_settings.floating_factor=3),"water_lin_damp"in ie.b4w_floating_settings||(ie.b4w_floating_settings.water_lin_damp=.8),"water_rot_damp"in ie.b4w_floating_settings||(ie.b4w_floating_settings.water_rot_damp=.8)):(ie.b4w_floating_settings=null,o("object",ie,"b4w_floating_settings")),"b4w_character_settings"in ie?ie.b4w_character_settings&&("walk_speed"in ie.b4w_character_settings||(ie.b4w_character_settings.walk_speed=4),"run_speed"in ie.b4w_character_settings||(ie.b4w_character_settings.run_speed=8),"step_height"in ie.b4w_character_settings||(ie.b4w_character_settings.step_height=.25),"jump_strength"in ie.b4w_character_settings||(ie.b4w_character_settings.jump_strength=5),"waterline"in ie.b4w_character_settings||(ie.b4w_character_settings.waterline=0)):(ie.b4w_character_settings=null,o("object",ie,"b4w_character_settings")),"b4w_selectable"in ie||(ie.b4w_selectable=!1,o("object",ie,"b4w_selectable")),"b4w_outlining"in ie||(ie.b4w_outlining=!1,o("object",ie,"b4w_outlining")),"b4w_outline_on_select"in ie||(ie.b4w_outline_on_select=!1,o("object",ie,"b4w_outline_on_select")),"b4w_billboard"in ie||(ie.b4w_billboard=!1,o("object",ie,"b4w_billboard")),"b4w_billboard_geometry"in ie||(ie.b4w_billboard_geometry="SPHERICAL",o("object",ie,"b4w_billboard_geometry")),"b4w_pres_glob_orientation"in ie||(ie.b4w_pres_glob_orientation=!1,o("object",ie,"b4w_pres_glob_orientation")),"b4w_outline_settings"in ie||("b4w_glow_settings"in ie?ie.b4w_outline_settings=ie.b4w_glow_settings:(ie.b4w_outline_settings={},ie.b4w_outline_settings.outline_duration=1,ie.b4w_outline_settings.outline_period=1,ie.b4w_outline_settings.outline_relapses=0),o("object",ie,"b4w_outline_settings")),"lod_levels"in ie||(ie.lod_levels=[],o("object",ie,"lod_levels")),"b4w_animation_mixing"in ie||(ie.b4w_animation_mixing=!1,o("object",ie,"b4w_animation_mixing"));break;case"EMPTY":"b4w_anchor"in ie||(ie.b4w_anchor=null,o("object",ie,"b4w_anchor")),!ie.b4w_anchor||"max_width"in ie.b4w_anchor||(ie.b4w_anchor.max_width=250)}if("collision_margin"in ie.game||(ie.game.collision_margin=.04,o("object",ie,"collision_margin")),"b4w_anim_behavior"in ie||(ie.b4w_anim_behavior=ie.b4w_cyclic_animation?"CYCLIC":"FINISH_STOP",o("object",ie,"b4w_anim_behavior")),!("rotation_quaternion"in ie)){var le=[0,0,0,1];F.euler_to_quat(ie.rotation_euler,le),s(le,le),ie.rotation_quaternion=le,o("object",ie,"rotation_quaternion")}"webgl_do_not_batch"in ie&&(ie.b4w_do_not_batch=ie.webgl_do_not_batch,ie.webgl_do_not_batch&&f("object",ie,"webgl_do_not_batch")),"b4w_shadow_cast_only"in ie||(ie.b4w_shadow_cast_only=!1,o("object",ie,"b4w_shadow_cast_only")),"b4w_correct_bounding_offset"in ie||(ie.b4w_correct_bounding_offset="AUTO",o("object",ie,"b4w_correct_bounding_offset"));for(var ce=ie.particle_systems,u=0;u<ce.length;u++){var ue=ce[u],de=ue.settings;"use_rotation_dupli"in de||(de.use_rotation_dupli=!1,o("particle_settings",de,"use_rotation_dupli")),"use_whole_group"in de||(de.use_whole_group=!1,o("particle_settings",de,"use_whole_group")),ue.transforms||(ue.transforms=new Float32Array,o("particle_system",ue,"transforms")),"b4w_billboard_align"in de||(de.b4w_billboard_align="VIEW",o("particle_settings",de,"b4w_billboard_align")),"b4w_dynamic_grass"in de||(de.b4w_dynamic_grass=!1,o("object",de,"b4w_dynamic_grass")),"b4w_dynamic_grass_scale_threshold"in de||(de.b4w_dynamic_grass_scale_threshold=.01,o("object",de,"b4w_dynamic_grass_scale_threshold")),"b4w_initial_rand_rotation"in de||(de.b4w_initial_rand_rotation=!1,o("particle_settings",de,"b4w_initial_rand_rotation")),"b4w_rotation_type"in de||(de.b4w_rotation_type="Z",o("particle_settings",de,"b4w_rotation_type")),"b4w_rand_rotation_strength"in de||(de.b4w_rand_rotation_strength=1,o("particle_settings",de,"b4w_rand_rotation_strength")),"b4w_hair_billboard"in de||(de.b4w_hair_billboard=!1,o("particle_settings",de,"b4w_hair_billboard")),"b4w_hair_billboard_type"in de||(de.b4w_hair_billboard_type="BASIC",o("particle_settings",de,"b4w_hair_billboard_type")),"b4w_hair_billboard_jitter_amp"in de||(de.b4w_hair_billboard_jitter_amp=0,o("particle_settings",de,"b4w_hair_billboard_jitter_amp")),"b4w_hair_billboard_jitter_freq"in de||(de.b4w_hair_billboard_jitter_freq=0,o("particle_settings",de,"b4w_hair_billboard_jitter_freq")),"b4w_hair_billboard_geometry"in de||(de.b4w_hair_billboard_geometry="SPHERICAL",o("particle_settings",de,"b4w_hair_billboard_geometry")),"b4w_wind_bend_inheritance"in de||(de.b4w_wind_bend_inheritance="PARENT",o("particle_settings",de,"b4w_wind_bend_inheritance")),"b4w_shadow_inheritance"in de||(de.b4w_shadow_inheritance="PARENT",o("particle_settings",de,"b4w_shadow_inheritance")),"b4w_reflection_inheritance"in de||(de.b4w_reflection_inheritance="PARENT",o("particle_settings",de,"b4w_reflection_inheritance")),"b4w_vcol_from_name"in de||(de.b4w_vcol_from_name="",o("particle_settings",de,"b4w_vcol_from_name")),"b4w_vcol_to_name"in de||(de.b4w_vcol_to_name="",o("particle_settings",de,"b4w_vcol_to_name")),"b4w_coordinate_system"in de||(de.b4w_coordinate_system="LOCAL",o("particle_settings",de,"b4w_coordinate_system")),"b4w_allow_nla"in de||(de.b4w_allow_nla=!0,o("particle_settings",de,"b4w_allow_nla")),"b4w_enable_soft_particles"in de||(de.b4w_enable_soft_particles=!1,o("particle_settings",de,"b4w_enable_soft_particles")),"b4w_particles_softness"in de||(de.b4w_particles_softness=1,o("particle_settings",de,"b4w_particles_softness")),"billboard_tilt"in de||(de.billboard_tilt=0,o("particle_settings",de,"billboard_tilt")),"billboard_tilt_random"in de||(de.billboard_tilt_random=0,o("particle_settings",de,"billboard_tilt_random")),"use_rotations"in de||(de.use_rotations=!1,o("particle_settings",de,"use_rotations"))}"constraints"in ie||(ie.constraints=[],o("object",ie,"constraints"));for(var fe=ie.constraints,u=0;u<fe.length;u++){var me=fe[u];"influence"in me||(me.influence=1),"axes"in me||(me.axes=[1,1,1])}for(var pe=ie.modifiers,u=0;u<pe.length;u++)(function(t,r){switch(t.type){case"ARRAY":if(!("fit_type"in t))return v(t.type,r,e.b4w_filepath_blend),!1}return!0})(pe[u],ie)||(pe.splice(u,1),u--);"animation_data"in ie||(ie.animation_data={action:null,nla_tracks:[]},o("object",ie,"animation_data")),ie.animation_data&&("action"in ie.animation_data||(ie.animation_data.action=null,y("no action in animation data "+ie.name)),"nla_tracks"in ie.animation_data||(ie.animation_data.nla_tracks=[],y("no NLA in animation data "+ie.name)),a(ie.animation_data)),"b4w_collision_id"in ie||(ie.b4w_collision_id="",o("object",ie,"b4w_collision_id")),"b4w_viewport_alignment"in ie||(ie.b4w_viewport_alignment=null,o("object",ie,"b4w_viewport_alignment")),"pinverse_tsr"in ie||(ie.pinverse_tsr=null,o("object",ie,"pinverse_tsr")),"b4w_cluster_data"in ie||(ie.b4w_cluster_data={cluster_id:-1,cluster_center:null},o("object",ie,"b4w_cluster_data")),"pass_index"in ie||(ie.pass_index=0,o("object",ie,"pass_index")),"b4w_custom_prop"in ie||(o("object",ie,"b4w_custom_prop"),ie.b4w_custom_prop=null),w(ie)&&y('negative scale for object "'+ie.name+'", can lead to some errors'),E(ie)||y("non-uniform scale for object "+ie.name)}V&&P.error("Compatibility issues detected");for(var he in X){var ve=X[he],be=he.match(/.*?(?=>>|$)/i)[0];P.warn('Property "'+String(be)+'" is '+ve.report_type+' for "'+ve.type+'". To fix this, reexport '+e.b4w_filepath_blend)}},t.check_anim_fcurve_completeness=function(e,t){"num_channels"in e||(e.num_channels=1,y('B4W Warning: no channels number in animation fcurve for "'+t.name+'" action, reexport scene'))},t.apply_mesh_modifiers=function(e){if(!A(e))return null;for(var t=R(e.data,e.data.name+"_MOD"),r=e.modifiers,a=0;a<r.length;a++){var n=r[a];switch(n.type){case"ARRAY":T(t,n);break;case"CURVE":x(t,n)}I.recalculate_mesh_boundings(t)}return t},t.assign_logic_nodes_object_params=function(e,t,r){function a(t,r){var a=t[0];if(t.length>1)for(n=1;n<t.length;n++)a+="*"+t[n];for(var n=0;n<e.length;n++){var _=e[n];if(_.name==a)for(var s in r)_[s]=r[s]}}function n(e,t){for(var r in e)a(e[r],t)}for(var _=r.b4w_logic_nodes,s=0;s<_.length;s++)for(var o=_[s],i=0;i<o.length;i++){var l=o[i],c={register1:"variable1",register2:"variable2",registerd:"variabled"};for(var u in c)u in l&&(l[c[u]]=l[u]);for(var d in l.variables)"boolean"!=typeof l.variables[d][0]&&(l.variables[d]=[!1,l.variables[d]]);["MATH","CONDJUMP","PAGEPARAM","REGSTORE"].indexOf(l.type)>=0&&("variable1"in l&&(l.variables.id0=[!1,l.variable1]),"variable2"in l&&(l.variables.id1=[!1,l.variable2]),"variabled"in l&&(l.variables.vd=[!1,l.variabled]));for(var f in l.links)f.startsWith("id")||delete l.links[f];var m=l.common_usage_names,p=l.variables;switch(l.type){case"SELECT":for(var h=0;h<e.length;h++){var v=e[h];v.name==l.object&&(v.b4w_selectable=!0)}l.bools||(l.bools={}),l.bools.not_wait||(l.bools.not_wait=!1),y('Logic nodes type "SELECT" is deprecated');break;case"SWITCH_SELECT":if(n(l.objects_paths,{b4w_selectable:!0}),l.links instanceof Array){y('Format of a "SWITCH_SELECT" node is outdated. It is recommended to reexport the scene "'+r.name+'"');var b={},g=0;for(h in l.objects_paths)b[h]=l.links[g],g++;l.links=b}break;case"SELECT_PLAY":y('Logic nodes type "SELECT_PLAY" is deprecated, node will be muted. To fix this, reexport the scene "'+r.name+'"'),l.mute=!0;break;case"SELECT_PLAY_ANIM":y('Logic nodes type "SELECT_PLAY_ANIM" is deprecated');break;case"SHOW":case"HIDE":l.bools||(l.bools={}),void 0===l.bools.ch&&(l.bools.ch=!1),l.bools.id0||n(l.objects_paths,{b4w_do_not_batch:!0});break;case"SET_SHADER_NODE_PARAM":case"INHERIT_MAT":n(l.objects_paths,{b4w_do_not_batch:!0});break;case"PLAY":r.b4w_use_nla=!0;break;case"MOVE_TO":n(l.objects_paths,{b4w_do_not_batch:!0});break;case"TRANSFORM_OBJECT":switch(n(l.objects_paths,{b4w_do_not_batch:!0}),m.space_type){case"WORLD":m.space_type=j.NST_WORLD;break;case"PARENT":m.space_type=j.NST_PARENT;break;case"LOCAL":m.space_type=j.NST_LOCAL}break;case"OUTLINE":n(l.objects_paths,{b4w_outlining:!0});break;case"CONDJUMP":if(l.condition&&(m.condition=l.condition),"cnd"in l.floats)m.condition=l.floats.cnd;else switch(m.condition){case"GEQUAL":m.condition=j.NC_GEQUAL;break;case"LEQUAL":m.condition=j.NC_LEQUAL;break;case"GREATER":m.condition=j.NC_GREATER;break;case"LESS":m.condition=j.NC_LESS;break;case"NOTEQUAL":m.condition=j.NC_NOTEQUAL;break;case"EQUAL":m.condition=j.NC_EQUAL}switch(void 0!=l.number1&&(l.input1=l.number1),void 0!=l.number2&&(l.input2=l.number2),l.bools||(l.bools={}),l.bools.str&&(m.variable_type="STRING"),m.variable_type){case"NUMBER":m.variable_type=j.NT_NUMBER;break;case"STRING":m.variable_type=j.NT_STRING;break;case"OBJECT":m.variable_type=j.NT_OBJECT}void 0===m.variable_type&&(m.variable_type=j.NT_NUMBER,l.floats.inp1=l.input1,l.floats.inp2=l.input2),void 0===p.id0&&(p.id0=p.v1,p.id1=p.v2);break;case"SEND_REQ":l.bools||(l.bools={}),l.strings||(l.strings={}),void 0===l.bools.ct&&(l.bools.ct=!1),void 0!=l.url&&(l.bools.url=!1,l.strings.url=l.url);break;case"MATH":switch(void 0!=l.number1&&(l.input1=l.number1),void 0!=l.number2&&(l.input2=l.number2),void 0!=l.input1&&(l.floats.inp1=l.input1),void 0!=l.input2&&(l.floats.inp2=l.input2),l.operation){case"DIV":l.operation=j.NMO_DIV;break;case"SUB":l.operation=j.NMO_SUB;break;case"MUL":l.operation=j.NMO_MUL;break;case"ADD":l.operation=j.NMO_ADD;break;case"RAND":l.operation=j.NMO_RAND;break;case"SIN":l.operation=j.NMO_SIN;break;case"COS":l.operation=j.NMO_COS;break;case"TAN":l.operation=j.NMO_TAN;break;case"ARCSIN":l.operation=j.NMO_ARCSIN;break;case"ARCCOS":l.operation=j.NMO_ARCCOS;break;case"ARCTAN":l.operation=j.NMO_ARCTAN;break;case"LOG":l.operation=j.NMO_LOG;break;case"MIN":l.operation=j.NMO_MIN;break;case"MAX":l.operation=j.NMO_MAX;break;case"ROUND":l.operation=j.NMO_ROUND;break;case"MOD":l.operation=j.NMO_MOD;break;case"ABS":l.operation=j.NMO_ABS}void 0===p.id0&&(p.id0=p.v1,p.id1=p.v2);break;case"REGSTORE":if(l.floats||(l.floats={}),l.strings||(l.strings={}),void 0!=l.number1&&(l.input1=l.number1),void 0!=l.input1)switch(typeof l.input1){case"number":l.floats.inp1=l.input1,m.variable_type="NUMBER";break;default:l.strings.inp1=l.input1,m.variable_type="STRING"}switch(m.variable_type){case"NUMBER":m.variable_type=j.NT_NUMBER;break;case"STRING":m.variable_type=j.NT_STRING;break;case"OBJECT":m.variable_type=j.NT_OBJECT,n(l.objects_paths,{b4w_do_not_batch:!0})}break;case"PAGEPARAM":l.bools||(l.bools={}),void 0===l.bools.hsh&&(l.bools.hsh=!1),l.floats||(l.floats={}),void 0===l.floats.ptp&&(l.floats.ptp=0);break;case"STOP_ANIM":case"PLAY_ANIM":if(l.bools||(l.bools={}),void 0===l.bools.env&&(l.bools.env=!1),void 0===l.bools.id0&&(l.bools.id0=!1),l.bools.id0||a(l.objects_paths.id0,{b4w_do_not_batch:!0}),"PLAY_ANIM"==l.type){var E=m.param_anim_behavior;E||(E="FINISH_STOP"),m.param_anim_behavior=z.anim_behavior_bpy_b4w(E)}break;case"STRING":switch(m.string_operation){case"JOIN":m.string_operation=j.NSO_JOIN;break;case"FIND":m.string_operation=j.NSO_FIND;break;case"REPLACE":m.string_operation=j.NSO_REPLACE;break;case"SPLIT":m.string_operation=j.NSO_SPLIT;break;case"COMPARE":m.string_operation=j.NSO_COMPARE}if("cnd"in l.floats)m.condition=l.floats.cnd;else switch(m.condition){case"GEQUAL":m.condition=j.NC_GEQUAL;break;case"LEQUAL":m.condition=j.NC_LEQUAL;break;case"GREATER":m.condition=j.NC_GREATER;break;case"LESS":m.condition=j.NC_LESS;break;case"NOTEQUAL":m.condition=j.NC_NOTEQUAL;break;case"EQUAL":m.condition=j.NC_EQUAL}break;case"REDIRECT":void 0!=l.url&&(l.bools.url=!1,l.strings.url=l.url);break;case"SET_CAMERA_MOVE_STYLE":switch(m.camera_move_style){case"STATIC":m.camera_move_style=j.NCMS_STATIC;break;case"TARGET":m.camera_move_style=j.NCMS_TARGET;break;case"EYE":m.camera_move_style=j.NCMS_EYE;break;case"HOVER":m.camera_move_style=j.NCMS_HOVER}break;case"ENTRYPOINT":l.bools||(l.bools={}),void 0===l.bools.js&&(l.bools.js=!1),l.bools.js&&(l.mute=!0);break;case"JS_CALLBACK":var w=m.js_cb_params;for(var u in w)switch(w[u]){case"OBJECT":w[u]=j.NCPT_OBJECT;break;case"VARIABLE":w[u]=j.NCPT_VARIABLE}}}}}),Q=o("__animation",function(e,t){function r(){return{type:Ke,num_pierced:0,pierce_step:0,params:null,bones:null,bflags:null,channels_mask:new Int8Array(8)}}function a(e,t){var r=e.anim_slots[t];r&&r.finish_callback&&r.exec_finish_callback&&(r.exec_finish_callback=!1,r.finish_callback(e,t))}function n(e,t,r){var a=e.anim_slots[r];a.type=Je;var n=t.frame_start,_=t.frame_end-n+1;a.start=n,a.length=_,a.current_frame_float=n,a.animation_name=t.name;for(var s=0,o=0;o<e.vertex_anim.length;o++){var i=e.vertex_anim[o];if(i==t)break;s+=i.frame_end-i.frame_start+1}a.va_frame_offset=s}function _(e,t,r){t.type=et,t.animation_name=r.name,t.start=r.frame_start,t.length=r.frame_end-t.start,r.cyclic||(t.length+=r.lifetime_frames)}function s(e,t,r){for(var a=e.scenes_data,n=0;n<a.length;n++)for(var s=a[n].batches,o=0;o<s.length;o++){var i=s[o].particles_data;if(i&&i.name==t){var l=e.anim_slots[r];_(s[o],l,i)}}}function o(e,t){var r={type:null,animation_name:null,action_frame_range:null,action_step:0,action_bflags:null,channels_mask:new Int8Array(8),quats:null,trans:null,bone_space_quats:null,bone_space_trans:null,skinning_data:[],play:!1,behavior:it,current_frame_float:0,start:0,length:0,trans_smooth_period:0,quat_smooth_period:0,exec_finish_callback:!1,va_frame_offset:null,speed:1,volume:null,pitch:null,color:null,energy:null,zenith_color:null,horizon_color:null,fog_intensity:null,fog_depth:null,fog_start:null,fog_height:null,fog_color:null,nodemat_values:[],node_value_inds:[],nodemat_rgbs:[],node_rgb_inds:[],node_batches:null};if(!e.anim_slots.length)for(var a=0;a<8;a++)e.anim_slots.push(null);e.anim_slots[t]=r}function i(e){-1==It.indexOf(e)&&It.push(e)}function c(e){return e.replace(/_B4W_BAKED$/,"")}function u(e){for(var t=[],r=0;r<St.length;r++){var a=St[r],n=a._render;n.type==Qe?t.push(a):a._render.type!=tt||"MESH"!=e.type&&"WORLD"!=e.type?n.type==Ze&&"ARMATURE"==e.type?t.push(a):n.type==$e&&"SPEAKER"==e.type?t.push(a):n.type==at&&"WORLD"==e.type&&t.push(a):t.push(a)}return t}function f(e){return e.def_action_slots.slice()}function p(e,t){return{name_list:e,action:t}}function b(e,t,r){if(e.animation_data){var a=e.animation_data.action;a&&a._render.type==tt&&t.push(p(r,a))}for(var n=e.nodes,_=0;_<n.length;_++){var s=n[_];if(s.node_group){var o=s.node_group.node_tree;if(o){var i=r.slice();i.push(s.name),b(o,t,i)}}}}function y(e){return!(!Se.is_mesh(e)||!e.render.vertex_anim)}function E(e,t,r){var a=e.anim_slots;if(r==st)for(var n=0;n<8;n++)(_=a[n])&&(_.current_frame_float=t,T(e,0,n,!0));else{var _=a[r];_&&(_.current_frame_float=t,T(e,0,r,!0))}}function w(e,t,r){if(t==st)for(var a=0;a<8;a++)(n=e[a])&&r(n);else{var n=e[t];n&&r(n)}}function T(e,t,r,n){V(e,t,r,n),a(e,r),e.render.anim_mixing&&(te(e,t),J(e,t))}function M(e,t,r,a){var n=r.frame_range;if(n[0]>n[1])return Pe.warn('Incompatible action "'+r.name+'" has been applied to object "'+e.name+'"'),!1;var _=r._render,s=e.anim_slots[a];switch(s.animation_name=r.name,s.action_frame_range=n,s.action_step=_.pierce_step,s.action_bflags=_.bflags,s.channels_mask.set(_.channels_mask),s.start=n[0],s.length=n[1]-n[0],s.current_frame_float=n[0],_.type){case Ze:if(Se.is_armature(e)){s.type=Ze;var o=I(e,t,r);o||S(e,t,r,o=re(r,e.render.bone_pointers)),s.trans=o.trans,s.quats=o.quats,s.bone_space_quats=o.bone_space_quats,s.bone_space_trans=o.bone_space_trans,L(e,a,r,o)}break;case $e:Se.is_speaker(e)&&(s.volume=_.params.volume||null,s.pitch=_.params.pitch||null,s.type=$e);break;case rt:Se.is_lamp(e)&&(s.color=_.params.color||null,s.energy=_.params.energy||null,s.type=rt);break;case tt:if("MESH"==e.type||"WORLD"==e.type){s.type=tt;var i=G(e,t,r,Se.is_world(e));s.node_value_inds=i.val_inds,s.nodemat_values=i.values,s.node_rgb_inds=i.rgb_inds,s.nodemat_rgbs=i.rgbs,s.node_batches=i.node_batches}break;case Qe:var l=_.params.tsr;if(!l)return Pe.warn('Incompatible action "'+r.name+'" has been applied to object "'+e.name+'"'),!1;s.type=Qe;var c=I(e,t,r);if(c||S(e,t,r,c=q(0,r,l)),s.trans=c.trans,s.quats=c.quats,Le.obj_has_particles(e)){var u=s.trans[0],d=s.quats[0];Le.update_start_pos(e,u,d)}break;case at:Se.is_world(e)&&(s.energy=_.params["light_settings.environment_energy"]||null,s.horizon_color=_.params.horizon_color||null,s.zenith_color=_.params.zenith_color||null,s.fog_intensity=_.params["mist_settings.intensity"]||null,s.fog_depth=_.params["mist_settings.depth"]||null,s.fog_start=_.params["mist_settings.start"]||null,s.fog_height=_.params["mist_settings.height"]||null,s.fog_color=_.params.b4w_fog_color||null,s.type=at)}return Se.is_armature(e)&&_.type!=Ze&&F(e,a),!0}function I(e,t,r){var a=e.action_anim_cache;if(t)n=t.join("%join%");else var n=null;for(var _=0;_<a.length;_+=3)if(r==a[_]&&n==a[_+1])return a[_+2];return null}function S(e,t,r,a){var n=e.action_anim_cache;if(t)_=t.join("%join%");else var _=null;n.push(r,_,a)}function L(e,t,r,a){var n=e.render,_=n.skinned_renders,s=e.anim_slots[t],o=s.skinning_data,i=C(n,r);if(i)s.skinning_data=i;else{for(var l=0;l<_.length;l++){var c=ne(a,_[l].bone_skinning_info);o.push(c)}P(n,r,o)}if(n.anim_mixing){var u=n.blend_skel_slots;if(t>u[1]){var d=u[1];u[1]=t,u[0]=d}else t>u[0]&&t<u[1]&&(u[0]=t);U(e)}}function C(e,t){for(var r=e.skinning_data_cache,a=0;a<r.length;a+=2)if(t==r[a])return r[a+1];return null}function P(e,t,r){e.skinning_data_cache.push(t,r)}function U(e){var t=e.render.blend_skel_slots;if(-1!=t[0]&&-1!=t[1]){var r=t[1],a=e.anim_slots,n=a[r].current_frame_float,_=Math.floor(n),s=n-_,o=a[t[0]];n=o.current_frame_float,_=Math.floor(n),o.current_frame_float=_+s}}function F(e,t){var r=e.render.blend_skel_slots,a=r[1];if(r[0]=-1,r[1]=-1,t!=st)for(var n=e.anim_slots,_=a;_>=nt;_--){var s=n[_];if(s&&s.type==Ze){if(_>r[1]){r[1]=_;continue}_>r[0]&&(r[1]=_);break}}}function B(e,t){var r=e.match(/"(.*?)"/)[1];if(t&&t.length>1){for(var a=t[1],n=2;n<t.length;n++)a=a+"%join%"+t[n];a+="%join%"+r}else a=r;return a}function G(e,t,r,a){var n=[],_=[],s=[],o=[],i=[],l=r._render,c=t?t[0]:null;for(var u in l.params)for(var d=B(u,t),f=0;f<e.scenes_data.length;f++)for(var m=e.scenes_data[f].batches,p=0;p<m.length;p++){var h=m[p];if(a||!c||-1!=h.material_names.indexOf(c)){var v=h.node_value_inds,b=h.node_rgb_inds,g=H(u,d,l,_,n,v),y=z(u,d,l,o,s,b);(g||y)&&i.push(h)}}return{val_inds:n,values:_,rgb_inds:s,rgbs:o,node_batches:i}}function z(e,t,r,a,n,_){if(!_)return!1;for(var s=!1,o=0;o<_.length;o+=2)if(t==_[o]){var i=_[o+1];n.push(i),a.push(new Float32Array(r.params[e])),s=!0}return s}function H(e,t,r,a,n,_){if(!_)return!1;for(var s=!1,o=0;o<_.length;o+=3)t==_[o]&&(n.push(4*_[o+1]+_[o+2]),a.push(new Float32Array(r.params[e])),s=!0);return s}function q(e,t,r){for(var a=t._render.num_pierced,n=[],_=[],s=0;s<a;s++)n.push(r.subarray(8*s,8*s+4)),_.push(r.subarray(8*s+4,8*s+8));return{trans:n,quats:_}}function V(e,t,r,a){var n=e.anim_slots[r];if(n&&null!=n.type&&(n.play||a)){var _=e.render,s=n.current_frame_float,o=n.start,i=n.length;s+=n.speed*t*je.get_framerate();var l=n.type,c=n.speed;if(c>=0&&s>=o+i||c<0&&s<o)switch(a||(n.exec_finish_callback=!0),n.behavior){case ot:s=c>=0?(s-o)%i+o:o+i-Xe;break;case it:s=c>=0?o:o+i-Xe,n.play=!1;break;case lt:s=c>=0?o+i-Xe:o,n.play=!1}switch(n.current_frame_float=s,l){case Ze:if(!_.anim_mixing){var u=(y=X(n))[0],d=y[1],f=y[2];_.quats_before=n.quats[u],_.quats_after=n.quats[d],_.trans_before=n.trans[u],_.trans_after=n.trans[d],_.frame_factor=f,Q(_,n,u,d),ze.update_transform(e)}break;case Qe:var m=ye(n,0,y=X(n),gt),p=Ee(n,0,y,xt),h=we(n,0,y);if(e.parent&&e.pinverse_tsr){var v=Nt;Ye.set_sep(m,h,p,v),Ye.multiply(e.pinverse_tsr,v,v),Ye.get_trans(v,m),Ye.get_quat(v,p),h=Ye.get_scale(v)}if(n.trans_smooth_period){var b=yt;ze.get_translation(e,b),He.smooth_v(m,b,t,n.trans_smooth_period,m)}if(n.quat_smooth_period){var g=Ot;ze.get_rotation(e,g),He.smooth_q(p,g,t,n.quat_smooth_period,p)}(j=n.channels_mask)[0]&&ze.set_translation_rel(e,m),j[1]&&ze.set_rotation_rel(e,p),j[2]&&ze.set_scale_rel(e,h),ze.update_transform(e),Ce.sync_transform(e);break;case Je:var y=K(n);_.va_frame=y[0],_.va_frame_factor=y[2];break;case $e:var E=(y=X(n))[0],w=y[1],A=y[2];if(n.volume){var T=(1-A)*n.volume[E]+A*n.volume[w];Be.set_volume(e,T)}if(n.pitch){var x=(1-A)*n.pitch[E]+A*n.pitch[w];Be.playrate(e,x)}break;case et:if(n.behavior==ot)O=(s-o)/je.get_framerate();else var O=s/je.get_framerate();Le.set_time(e,n.animation_name,O);break;case tt:for(var E=(y=X(n))[0],w=y[1],A=y[2],R=n.nodemat_values,k=n.node_value_inds,N=n.nodemat_rgbs,M=n.node_rgb_inds,I=n.node_batches,S=0;S<k.length;S++)for(var L=R[S],C=k[S],P=(1-A)*L[E]+A*L[w],D=0;D<I.length;D++)I[D].node_values[C]=P;for(S=0;S<M.length;S++)for(var U=N[S],C=M[S],F=U.subarray(3*E,3*E+3),B=U.subarray(3*w,3*w+3),G=We.lerp(F,B,A,gt),D=0;D<I.length;D++)I[D].node_rgbs[3*C]=G[0],I[D].node_rgbs[3*C+1]=G[1],I[D].node_rgbs[3*C+2]=G[2];Se.is_world(e)&&Fe.update_sky_texture(e);break;case rt:var E=(y=X(n))[0],w=y[1],A=y[2],j=n.channels_mask;if((q=n.energy)&&j[0]){var z=(1-A)*q[E]+A*q[w];Ie.set_light_energy(e.light,z)}var Y=n.color;Y&&j[1]&&(gt[0]=(1-A)*Y[3*E]+A*Y[3*w],gt[1]=(1-A)*Y[3*E+1]+A*Y[3*w+1],gt[2]=(1-A)*Y[3*E+2]+A*Y[3*w+2],Ie.set_light_color(e.light,gt));for(var H=e.scenes_data,S=0;S<H.length;S++)Fe.update_lamp_scene_color_intensity(e,H[S].scene);break;case at:var E=(y=X(n))[0],w=y[1],A=y[2],j=n.channels_mask,H=e.scenes_data,W=Fe.get_subs(H[0].scene,Ge.MAIN_OPAQUE),q=n.energy;if(j[ct])V=(1-A)*q[E]+A*q[w];else var V=W.energy;var Z=n.horizon_color;if(j[ut])gt[0]=(1-A)*Z[3*E]+A*Z[3*w],gt[1]=(1-A)*Z[3*E+1]+A*Z[3*w+1],gt[2]=(1-A)*Z[3*E+2]+A*Z[3*w+2],J=gt;else var J=W.horizon_color;var $=n.zenith_color;if(j[dt])yt[0]=(1-A)*$[3*E]+A*$[3*w],yt[1]=(1-A)*$[3*E+1]+A*$[3*w+1],yt[2]=(1-A)*$[3*E+2]+A*$[3*w+2],ee=yt;else var ee=W.zenith_color;var te=n.fog_intensity;if(j[ft])var re=(1-A)*te[E]+A*te[w];var ae=n.fog_depth;if(j[mt])var ne=(1-A)*ae[E]+A*ae[w];var _e=n.fog_start;if(j[pt])var se=(1-A)*_e[E]+A*_e[w];var oe=n.fog_height;if(j[ht])var ie=(1-A)*oe[E]+A*oe[w];var le=n.fog_color;if(j[vt]){xt[0]=(1-A)*le[3*E]+A*le[3*w],xt[1]=(1-A)*le[3*E+1]+A*le[3*w+1],xt[2]=(1-A)*le[3*E+2]+A*le[3*w+2];var ce=xt}for(S=0;S<H.length;S++){var ue=e.scenes_data[S].scene;(j[ct]||j[ut]||j[dt])&&Fe.set_environment_colors(ue,V,J,ee),j[ft]&&Fe.set_fog_intensity(ue,re),j[mt]&&Fe.set_fog_depth(ue,ne),j[pt]&&Fe.set_fog_start(ue,se),j[ht]&&Fe.set_fog_height(ue,ie),j[vt]&&Fe.set_fog_color_density(ue,ce)}break;default:He.panic("Unknown animation type:"+l)}}}function X(e){var t=e.current_frame_float,r=e.action_frame_range[0],a=e.action_frame_range[1]-r,n=t-r;n<0&&(n=0),n>=a&&(n=a),n/=e.action_step;var _=Math.floor(n);if(e.action_bflags[_])s=n-_;else var s=0;var o=Math.ceil(_+s);return bt[0]=_,bt[1]=o,bt[2]=s,bt}function K(e){var t=e.current_frame_float-e.start;t<0&&(t=0),t>=e.length&&(t=e.length);var r=Math.floor(t),a=r+1,n=t-r;e.behavior!=ot&&a==e.length&&(a=r-=1,n=1);var _=e.va_frame_offset;return bt[0]=r+_,bt[1]=a+_,bt[2]=n,bt}function Q(e,t,r,a){for(var n=e.skinned_renders,_=t.skinning_data,s=0;s<n.length;s++){var o=n[s],i=_[s];o.quats_before=i.quats[r],o.quats_after=i.quats[a],o.trans_before=i.trans[r],o.trans_after=i.trans[a],o.frame_factor=e.frame_factor}}function J(e,t){var r=e.render,a=r.anim_mix_factor,n=r.blend_skel_slots,_=n[0],s=n[1];if(-1!=s){if(-1!=_){var o=e.anim_slots[_];if(o.play||0==t||r.mix_with_current){var i=X(o),l=i[0],c=i[1];r.frame_factor=i[2];var u=o.quats[l],d=o.quats[c],f=o.trans[l],m=o.trans[c]}else a=1}else a=1;var p=e.anim_slots[s];if(p.play||0==t||r.mix_with_current){var h=X(p),v=h[0],b=h[1];r.frame_factor=h[2]}else{if(-1==_||!o.play)return;a=0}var g=p.quats[v],y=p.quats[b],E=p.trans[v],w=p.trans[b];if(1!=a||r.mix_with_current)if(0!=a||r.mix_with_current){var A=r.bone_pointers;if(r.mix_with_current&&!r.trans_curr&&!r.quats_curr){r.trans_curr=new Float32Array(r.trans_before.length),r.quats_curr=new Float32Array(r.quats_before.length);for(var T in A)(x=A[T]).parent_bone_ptr||ee(r,x)}for(var T in A){var x=A[T];x.parent_bone_ptr||$(r,x,o,p,l,c,v,b)}}else r.quats_before.set(u),r.quats_after.set(d),r.trans_before.set(f),r.trans_after.set(m);else r.quats_before.set(g),r.quats_after.set(y),r.trans_before.set(E),r.trans_after.set(w);ze.update_transform(e),Ne.update_skinned_renders(e)}}function $(e,t,r,a,n,_,s,o){var i=t.parent_bone_ptr,l=e.anim_mix_factor,c=xt,u=Ot,d=Et,f=wt,m=Rt,p=kt,h=At,v=Tt,b=4*t.bone_index,g=a.bone_space_quats[s],y=a.bone_space_trans[s],E=a.bone_space_quats[o],w=a.bone_space_trans[o];if(!e.mix_with_current)var A=r.bone_space_quats[n],T=r.bone_space_trans[n],x=r.bone_space_quats[_],O=r.bone_space_trans[_];for(k=0;k<4;k++)u[k]=g[b+k],f[k]=y[b+k],p[k]=E[b+k],v[k]=w[b+k],e.mix_with_current?(c[k]=e.quats_curr[b+k],d[k]=e.trans_curr[b+k],m[k]=e.quats_curr[b+k],h[k]=e.trans_curr[b+k]):(c[k]=A[b+k],d[k]=T[b+k],m[k]=x[b+k],h[k]=O[b+k]);for(De.slerp(c,u,l,c),He.blend_arrays(d,f,l,d),Ye.set_transcale(d,Nt),Ye.set_quat(c,Nt),i&&Ye.multiply(i.tsr_local_pose_b,Nt,Nt),Ye.copy(Nt,t.tsr_local_pose_b),Ye.multiply(Nt,t.tsr_local_rest_i,Nt),Ye.get_transcale(Nt,d),Ye.get_quat(Nt,c),De.slerp(m,p,l,m),He.blend_arrays(h,v,l,h),Ye.set_transcale(h,Nt),Ye.set_quat(m,Nt),i&&Ye.multiply(i.tsr_local_pose_a,Nt,Nt),Ye.copy(Nt,t.tsr_local_pose_a),Ye.multiply(Nt,t.tsr_local_rest_i,Nt),Ye.get_transcale(Nt,h),Ye.get_quat(Nt,m),k=0;k<4;k++)e.quats_before[b+k]=c[k],e.trans_before[b+k]=d[k],e.quats_after[b+k]=m[k],e.trans_after[b+k]=h[k];for(var R=t.descend_bones_ptrs,k=0;k<R.length;k++)$(e,R[k],r,a,n,_,s,o)}function ee(e,t){for(var r=4*t.bone_index,a=t.parent_bone_ptr,n=e.anim_mix_factor,_=Et,s=xt,o=wt,i=Ot,l=0;l<4;l++)_[l]=e.trans_before[r+l],s[l]=e.quats_before[r+l],o[l]=e.trans_after[r+l],i[l]=e.quats_after[r+l];for(Ye.set_transcale(_,Nt),Ye.set_quat(s,Nt),Ye.multiply(Nt,t.tsr_local_rest,Nt),Ye.copy(Nt,t.tsr_local_pose_b),a&&(Ye.invert(a.tsr_local_pose_b,Mt),Ye.multiply(Mt,Nt,Nt)),Ye.get_transcale(Nt,_),Ye.get_quat(Nt,s),Ye.set_transcale(o,Nt),Ye.set_quat(i,Nt),Ye.multiply(Nt,t.tsr_local_rest,Nt),Ye.copy(Nt,t.tsr_local_pose_a),a&&(Ye.invert(a.tsr_local_pose_a,Mt),Ye.multiply(Mt,Nt,Nt)),Ye.get_transcale(Nt,o),Ye.get_quat(Nt,i),De.slerp(s,i,n,s),He.blend_arrays(_,o,n,_),l=0;l<4;l++)e.quats_curr[r+l]=s[l],e.trans_curr[r+l]=_[l];for(var c=t.descend_bones_ptrs,l=0;l<c.length;l++)ee(e,c[l])}function te(e,t){var r=e.render,a=r.anim_mix_factor,n=r.anim_mix_factor_change_speed;if(0!=n){!r.mix_with_current||r.trans_curr||r.quats_curr||(a=r.anim_mix_factor=0);var _=r.anim_destination_mix_factor-a,s=n*t;He.sign(_)==He.sign(n)&&Math.abs(s)<Math.abs(_)?r.anim_mix_factor+=s:(r.anim_mix_factor=r.anim_destination_mix_factor,r.anim_mix_factor_change_speed=0,r.anim_mix_cb&&(r.anim_mix_cb(),r.anim_mix_cb=null),r.mix_with_current&&(r.trans_curr=null,r.quats_curr=null,r.mix_with_current=!1))}}function re(e,t){for(var r=[],a=[],n=[],_=[],s=e._render.num_pierced,o=0;o<s;o++){for(var i in t){var l=t[i],c=l.tsr_basis,u=e._render.bones[i];u?Ye.copy(u.subarray(8*o,8*o+8),c):Ye.identity(c),l.tsr_channel_cache_valid=!1}var d=ae(t);r.push(d.trans),a.push(d.quats),n.push(d.bone_space_trans),_.push(d.bone_space_quats)}return{trans:r,quats:a,bone_space_trans:n,bone_space_quats:_}}function ae(e){var t=[],r=[],a=[],n=[],_=new Float32Array(4),s=new Float32Array(4);for(var o in e){var i=e[o];se(i,_,s);var l=i.bone_index;Ye.multiply(i.tsr_bone_rest,i.tsr_basis,Nt);for(var c=0;c<4;c++){var u=4*l+c;t[u]=_[c],r[u]=s[c],a[u]=Nt[c],n[u]=Nt[c+4]}}return{trans:t,quats:r,bone_space_trans:a,bone_space_quats:n}}function ne(e,t){for(var r=[],a=[],n=e.trans,_=e.quats,s=0;s<n.length;s++){var o=_e(n[s],_[s],t);r.push(o.trans),a.push(o.quats)}return{trans:r,quats:a}}function _e(e,t,r){var a=[],n=[];for(var _ in r)for(var s=r[_],o=s.bone_index,i=s.deform_bone_index,l=0;l<4;l++){var c=4*i+l,u=4*o+l;a[c]=e[u],n[c]=t[u]}return a=new Float32Array(a),n=new Float32Array(n),{trans:a,quats:n}}function se(e,t,r){var a=e.chain,n=a[a.length-1],_=n.tsr_channel_cache;n.tsr_channel_cache_valid||Ye.identity(_);for(var s=a.length-1;s>=0;s--){var o=a[s],i=o.tsr_channel_cache;if(o.tsr_channel_cache_valid)_=i;else{var l=o.tsr_local_rest,c=o.tsr_basis;Ye.invert(l,Nt),Ye.multiply(c,Nt,Nt),Ye.multiply(l,Nt,Nt),Ye.multiply(_,Nt,i),_=i,o.tsr_channel_cache_valid=!0}}var u=o.tsr_channel_cache;t[0]=u[0],t[1]=u[1],t[2]=u[2],t[3]=u[3],r[0]=u[4],r[1]=u[5],r[2]=u[6],r[3]=u[7],De.normalize(r,r)}function oe(e){var t=e._render;t.bones?t.type=Ze:t.params?"volume"in t.params||"pitch"in t.params?t.type=$e:ie(e)?t.type=tt:le(e)?t.type=rt:ce(e)?t.type=at:ue(e)?t.type=Qe:t.type=Ke:t.type=Ke}function ie(e){var t=e._render.params;if(t)for(var r in t)if(-1!=r.indexOf("nodes"))return!0;return!1}function le(e){if(e._render.params){var t=e.fcurves;for(var r in t)if("color"==r&&!t[r][3])return!0;if("energy"==r)return!0}return!1}function ce(e){var t=e._render.params;return"light_settings.environment_energy"in t||"horizon_color"in t||"zenith_color"in t||"mist_settings.intensity"in t||"mist_settings.depth"in t||"mist_settings.start"in t||"mist_settings.height"in t||"b4w_fog_color"in t}function ue(e){if(e._render.params){var t=e.fcurves;for(var r in t)if("location"==r||"rotation_quaternion"==r||"scale"==r)return!0}return!1}function de(e,t){t[0]=t[1]=t[2]=0;for(var r in e)"location"==r?t[0]=1:"rotation_quaternion"==r?t[1]=1:"scale"==r&&(t[2]=1)}function fe(e,t){t[0]=t[1]=0;for(var r in e)"energy"==r?t[0]=1:"color"==r&&(t[1]=1)}function me(e,t){t[ct]=t[ut]=t[dt]=0,t[ft]=t[mt]=t[pt]=0,t[ht]=t[vt]=0;for(var r in e)"light_settings.environment_energy"==r?t[ct]=1:"horizon_color"==r?t[ut]=1:"zenith_color"==r?t[dt]=1:"mist_settings.intensity"==r?t[ft]=1:"mist_settings.depth"==r?t[mt]=1:"mist_settings.start"==r?t[pt]=1:"mist_settings.height"==r?t[ht]=1:"b4w_fog_color"==r&&(t[vt]=1)}function pe(e,t,r){var a=t[0],n=t[1],_=r[0],s=(r[1]-n)/(_-a);return s*e+(n-s*a)}function he(e,t,r,a){var n,_,s,o,i=[],l=[];i[0]=e[0]-t[0],i[1]=e[1]-t[1],l[0]=a[0]-r[0],l[1]=a[1]-r[1],s=a[0]-e[0],(n=Math.abs(i[0]))+(_=Math.abs(l[0]))!=0&&n+_>s&&(o=s/(n+_),t[0]=e[0]-o*i[0],t[1]=e[1]-o*i[1],r[0]=a[0]-o*l[0],r[1]=a[1]-o*l[1])}function ve(e,t,r,a,n){return ge(be(0,1,e,t[0],r[0],a[0],n[0]),t[1],r[1],a[1],n[1])}function be(e,t,r,a,n,_,s){var o=e+(t-e)/2,i=ge(o,a,n,_,s)-r;return Math.abs(i)<.02?o:i>0?be(e,o,r,a,n,_,s):be(o,t,r,a,n,_,s)}function ge(e,t,r,a,n){var _=1-e;return t*_*_*_+3*r*_*_*e+3*a*_*e*e+n*e*e*e}function ye(e,t,r,a){var n=r[0],_=r[1],s=r[2],o=e.trans,i=o[n][4*t],l=o[n][4*t+1],c=o[n][4*t+2],u=o[_][4*t],d=o[_][4*t+1],f=o[_][4*t+2];return a[0]=(1-s)*i+s*u,a[1]=(1-s)*l+s*d,a[2]=(1-s)*c+s*f,a}function Ee(e,t,r,a){var n=r[0],_=r[1],s=r[2],o=e.quats,i=Ot;i[0]=o[n][4*t],i[1]=o[n][4*t+1],i[2]=o[n][4*t+2],i[3]=o[n][4*t+3];var l=Rt;return l[0]=o[_][4*t],l[1]=o[_][4*t+1],l[2]=o[_][4*t+2],l[3]=o[_][4*t+3],De.slerp(i,l,s,a),a}function we(e,t,r){var a=r[0],n=r[1],_=r[2],s=e.trans;return(1-_)*s[a][4*t+3]+_*s[n][4*t+3]}function Ae(e,t){o(e,t),i(e)}function Te(e,t){ze.update_transform(e),Ce.sync_transform(e),T(e,0,t,!0)}function xe(e,t,r,a){if(a=a||nt,Se.is_mesh(e)){var _=Oe(e,r);if(_)return Ae(e,a),n(e,_,a),Te(e,a),!0;var o=Re(e,r);if(o&&"EMITTER"==o.p_type)return Ae(e,a),s(e,o.name,a),Te(e,a),!0}var i=He.keysearch("name",r,St)||He.keysearch("name",r+"_B4W_BAKED",St);if(i){if(Ae(e,a),M(e,t,i,a))return Te(e,a),!0;e.anim_slots[a]=null}return Pe.error('Unsupported object: "'+e.name+'" or animation name: "'+r+'"'),!1}function Oe(e,t){for(var r=0;r<e.vertex_anim.length;r++){var a=e.vertex_anim[r];if(a.name===t)return a}return null}function Re(e,t){for(var r=e.scenes_data,a=0;a<r.length;a++)for(var n=r[a].batches,_=0;_<n.length;_++){var s=n[_].particles_data;if(s&&s.name===t)return s}return null}function ke(e){for(var t=e.modifiers,r=0;r<t.length;r++){var a=t[r];if("ARMATURE"==a.type)return a.object}return null}var Ne=O(e),Me=g(e),Ie=R(e),Se=k(e),Le=N(e),Ce=W(e),Pe=m(e),De=d(e),Ue=Z(e),Fe=j(e),Be=D(e),Ge=A(e),je=x(e),ze=Y(e),Ye=v(e),He=h(e),We=l(e),qe=Me.animation,Ve=Me.context_limits,Xe=1e-6;t.LAST_FRAME_EPSILON=Xe;var Ke=0,Ze=10,Qe=20,Je=30,$e=40,et=50,tt=60,rt=70,at=80;t.OBJ_ANIM_TYPE_NONE=Ke,t.OBJ_ANIM_TYPE_ARMATURE=Ze,t.OBJ_ANIM_TYPE_OBJECT=Qe,t.OBJ_ANIM_TYPE_VERTEX=Je,t.OBJ_ANIM_TYPE_SOUND=$e,t.OBJ_ANIM_TYPE_PARTICLES=et,t.OBJ_ANIM_TYPE_MATERIAL=tt,t.OBJ_ANIM_TYPE_LIGHT=rt,t.OBJ_ANIM_TYPE_ENVIRONMENT=at;var nt=0,_t=7,st=-1;t.SLOT_0=nt,t.SLOT_1=1,t.SLOT_2=2,t.SLOT_3=3,t.SLOT_4=4,t.SLOT_5=5,t.SLOT_6=6,t.SLOT_7=_t,t.SLOT_ALL=st;var ot=10,it=20,lt=30;t.AB_CYCLIC=ot,t.AB_FINISH_RESET=it,t.AB_FINISH_STOP=lt;var ct=0,ut=1,dt=2,ft=3,mt=4,pt=5,ht=6,vt=7,bt=new Array(3),gt=new Float32Array(3),yt=new Float32Array(3),Et=new Float32Array(4),wt=new Float32Array(4),At=new Float32Array(4),Tt=new Float32Array(4),xt=new Float32Array(4),Ot=new Float32Array(4),Rt=new Float32Array(4),kt=new Float32Array(4),Nt=Ye.create(),Mt=Ye.create(),It=[],St=[];t.get_max_bones=function(){return He.trunc((Ve.max_vertex_uniform_vectors-50)/4)},t.frame_to_sec=function(e){return e/je.get_framerate()},t.update=function(e){for(n=0;n<It.length;n++){for(var t=It[n],r=0;r<8;r++)V(t,e,r);t.render.anim_mixing&&(te(t,e),J(t,e))}for(var n=0;n<It.length;n++)for(var t=It[n],r=0;r<8&&t.anim_slots.length;r++)a(t,r)},t.get_all_actions=function(){return St},t.get_anim_names=function(e){var t=[];if(y(e))for(a=0;a<e.vertex_anim.length;a++)t.push(e.vertex_anim[a].name);for(var r=u(e),a=0;a<r.length;a++)t.push(c(r[a].name));if(Le.obj_has_particles(e)&&Le.obj_has_anim_particles(e))for(var n=e.scenes_data,a=0;a<n.length;a++)for(var _=n[a].batches,s=0;s<_.length;s++){var o=_[s].particles_data;o&&t.push(o.name)}return t},t.strip_baked_suffix=c,t.get_anim_type=function(e,t){var r=e.anim_slots[t];return r?r.type:Ke},t.apply_def=function(e){for(var t=nt,r=e.scenes_data,a=0;a<r.length;a++)for(var s=r[a].batches,o=0;o<s.length;o++){var i=s[o].particles_data;i&&"EMITTER"==i.p_type&&!s[o].forked_batch&&(Ae(e,t),_(s[o],e.anim_slots[t],i),Te(e,t),i.cyclic?e.anim_slots[t].behavior=ot:e.anim_slots[t].behavior=e.anim_behavior_def,t++)}for(var l=f(e),a=0;a<l.length;a++){var c=l[a],u=c.name_list,d=c.action;Ae(e,t),M(e,u,d,t)?(Te(e,t),e.anim_slots[t].behavior=e.anim_behavior_def,t++):e.anim_slots[t]=null}y(e)&&(Ae(e,t),n(e,e.vertex_anim[0],t),Te(e,t),e.anim_slots[t].behavior=e.anim_behavior_def,t++)},t.anim_behavior_bpy_b4w=function(e){switch(e){case"CYCLIC":return ot;case"FINISH_RESET":return it;case"FINISH_STOP":return lt;default:He.panic("Wrong animation behavior")}},t.get_bpy_material_actions=function(e){for(var t=[],r=e.data.materials,a=0;a<r.length;a++){var n=r[a],_=n.node_tree;_&&b(_,t,[n.name])}return t},t.get_bpy_world_material_actions=function(e){var t=[],r=e.node_tree;return r&&b(r,t,[e.name]),t},t.init_action_slot=p,t.play=function(e,t,r){w(e.anim_slots,r,function(e){e.play=!0,e.finish_callback=t||null,e.exec_finish_callback=!1}),e.render.anim_mixing&&U(e)},t.stop=function(e,t){w(e.anim_slots,t,function(e){e.play=!1,e.finish_callback=null,e.exec_finish_callback=!1})},t.is_play=function(e,t){var r=e.anim_slots;if(t==st){for(var a=0;a<8;a++)if(r[a]&&r[a].play)return!0}else{var n=r[t];if(n)return n.play}return!1},t.set_frame=E,t.set_first_frame=function(e,t){t=t||nt,w(e.anim_slots,t,function(r){E(e,r.start,t)})},t.get_current_frame_float=function(e,t){var r=e.anim_slots[t];return r&&r.current_frame_float?r.current_frame_float:0},t.is_cyclic=function(e,t){var r=e.anim_slots[t];return r&&r.behavior==ot},t.set_behavior=function(e,t,r){w(e.anim_slots,r,function(e){e.behavior=t})},t.get_behavior=function(e,t){var r=e.anim_slots[t];return r&&r.behavior},t.apply_smoothing=function(e,t,r,a){w(e.anim_slots,a,function(e){e.trans_smooth_period=t||0,e.quat_smooth_period=r||0})},t.remove_slot_animation=function(e,t){if(t==st)for(var r=0;r<8;r++)e.anim_slots[r]=null;else e.anim_slots[t]=null;e.render.anim_mixing&&F(e,t)},t.update_object_animation=T,t.obj_is_animatable=function(e){if("ARMATURE"==e.type)return!0;if(e.armobj)return!0;if("WORLD"==e.type)return!0;for(var t=0;t<e.def_action_slots.length;t++){var r=e.def_action_slots[t].action._render.type;if(r==Qe||r==Ze||r==$e&&"SPEAKER"==e.type||r==rt&&"LAMP"==e.type||r==tt&&"MESH"==e.type)return!0}return!(!Le.obj_has_particles(e)||!Le.obj_has_anim_particles(e))||!("MESH"!=e.type||!e.vertex_anim.length)},t.bpy_mesh_empty_is_animatable=function(e){if(ke(e))return!0;if(e._def_action_slots)for(var t=0;t<e._def_action_slots.length;t++){var r=e._def_action_slots[t].action._render.type;if(r==Qe||r==tt&&"MESH"==e.type)return!0}return!(!Le.bpy_obj_has_particles(e)||!Le.bpy_obj_has_anim_particles(e))||!("MESH"!=e.type||!e.data.b4w_vertex_anim.length)},t.is_animated=function(e){return Boolean(e.anim_slots.length)},t.init_action_cache=function(e,t,r,a,n){if(r)_=He.keysearch("uuid",r,St);else var _=He.keysearch("name",a,St)||He.keysearch("name",a+"_B4W_BAKED",St);if(_){o(e,n),i(e);var s=_.frame_range;if(s[0]>s[1])return Pe.warn('Incompatible action "'+_.name+'" has been applied to object "'+e.name+'"'),!1;var l=_._render;switch(l.type){case Ze:if(Se.is_armature(e)){var c=I(e,t,_);c||S(e,t,_,c=re(_,e.render.bone_pointers)),L(e,n,_,c)}break;case Qe:var u=l.params.tsr;if(!u)return Pe.warn('Incompatible action "'+_.name+'" has been applied to object "'+e.name+'"'),!1;var d=I(e,t,_);d||S(e,t,_,d=q(0,_,u))}}},t.delete_cached_anim_data_by_mat=function(e,t){for(var r=e.action_anim_cache,a=[],n=0;n<r.length;n+=3)(r[n]._render.type!=tt||null!==r[n+1]&&r[n+1].split("%join%")[0]!=t)&&a.push(r[n],r[n+1],r[n+2]);e.action_anim_cache=a},t.calc_pose_data=ae,t.extract_skinned_pose_data=_e,t.append_action=function(e){var t=new RegExp(/pose.bones\[\".+\"\]/g),a=Ye.create(),n=function(e,t){if("object"==typeof t&&t.length)for(var r=t.length,a=new Float32Array(e*r),n=0;n<e;n++)for(var _=0;_<r;_++)a[n*r+_]=t[_];else if("number"==typeof t)for(var a=new Float32Array(e),n=0;n<e;n++)a[n]=t;else He.panic("Wrong storage default value");return a},_=function(e,t){for(var r=0;r<t;r++){var a=e.subarray(8*r+4,8*r+8);De.normalize(a,a)}},s=e._render=r();s.pierce_step=1/qe.frame_steps;var o=e.fcurves,i={},l={},c=0;for(var u in o){var d=o[u];for(var f in d){var m=d[f],p=m._pierced_points;Ue.check_anim_fcurve_completeness(m,e);var h=m.num_channels;c||(c=p.length);for(var v=function(e,r,_,s,o){if(_.search(t)>-1)var i=r,l=_.split('"')[1],c=a;else if(i=e,8==o)var l="tsr",c=a;else if(o>1)var l=_,c=new Float32Array(o);else var l=_,c=0;return i[l]||(i[l]=n(s,c)),i[l]}(i,l,u,c,h),b=v.length/c,g=function(e,t){if(e.indexOf("location")>-1)var r=0,a=t;else if(e.indexOf("rotation_quaternion")>-1)var r=4,a=0==t?3:t-1;else if(e.indexOf("scale")>-1)var r=3,a=0;else var r=0,a=t;return r+a}(u,0|f),y=0;y<c;y++)v[y*b+g]=p[y]}}if(He.get_dict_length(i)){for(var E in i)"tsr"==E&&_(i[E],c);s.params=i}if(He.get_dict_length(l)){for(var w in l)_(l[w],c);s.bones=l}s.num_pierced=c,s.bflags=e._bflags,"tsr"in i&&de(o,s.channels_mask),("color"in i||"energy"in i)&&fe(o,s.channels_mask),("light_settings.environment_energy"in i||"horizon_color"in i||"zenith_color"in i||"mist_settings.intensity"in i||"mist_settings.depth"in i||"mist_settings.start"in i||"mist_settings.height"in i||"b4w_fog_color"in i)&&me(o,s.channels_mask),oe(e),St.push(e)},t.get_approx_curve_length=function(e,t){return(t-e)*qe.frame_steps+1},t.approximate_curve=function(e,t,r,a,n,_){for(var s=new Float32Array(2),o=new Float32Array(2),i=new Float32Array(2),l=new Float32Array(2),c=t[1],u=t[2],d=t[e.last_frame_offset+1],f=t[e.last_frame_offset+2],m=0,p=0,h=null,v=n;v<=_;v++)if(v<c)for(w=0;w<qe.frame_steps;w++)r[m++]=u;else if(v>d)for(w=0;w<qe.frame_steps;w++)r[m++]=f;else{var b=t[p],g=3;0===b&&(g+=2),0===h&&(g+=2);var y=2===b?0:1;if(t[p+1]==t[p+g+1]){h=b,p+=g;continue}var E=0;if(v==t[p+1]&&(y&&(a[m]=1),r[m]=t[p+2],m++,E++),v==d)for(w=E;w<qe.frame_steps;w++)r[m++]=f;else{s[0]=t[p+1],s[1]=t[p+2],0!==b?(o[0]=0,o[1]=0):0===h?(o[0]=t[p+5],o[1]=t[p+6]):(o[0]=t[p+3],o[1]=t[p+4]),0!==b?(i[0]=0,i[1]=0):(i[0]=t[p+g+3],i[1]=t[p+g+4]),l[0]=t[p+g+1],l[1]=t[p+g+2];for(var w=E;w<qe.frame_steps;w++){var A=v+w/qe.frame_steps;switch(b){case 0:he(s,o,i,l),y&&(a[m]=1),r[m]=ve(A,s,o,i,l),m++;break;case 1:y&&(a[m]=1),r[m]=pe(A,s,l),m++;break;case 2:y&&(a[m]=1),r[m]=t[p+2],m++;break;default:He.panic("Unknown keyframe interpolation mode: "+b)}}}v+1==t[p+g+1]&&(h=b,p+=g)}},t.apply=xe,t.apply_by_uuid=function(e,t,r,a){a=a||nt;var n=He.keysearch("uuid",r,St);if(n){if(Ae(e,a),M(e,t,n,a))return Te(e,a),!0;e.anim_slots[a]=null}return Pe.error('Unsupported object: "'+e.name+'" or animation uuid: "'+r+'"'),!1},t.validate_action_by_name=function(e,t){var r=He.keysearch("name",t,St)||He.keysearch("name",t+"_B4W_BAKED",St);if(r){if(r._render.type==Ke)return!1}else if(!(Re(e,t)||Se.is_mesh(e)&&Oe(e,t)))return!1;return!0},t.get_slot_num_by_anim=function(e,t){for(var r=e.anim_slots,a=0;a<r.length;a++){var n=r[a];if(n&&c(n.animation_name)==c(t))return a}return-1},t.get_anim_by_slot_num=function(e,t){var r=e.anim_slots[t];return r&&r.animation_name?c(r.animation_name):null},t.remove=function(e){e.anim_slots.length=0;var t=It.indexOf(e);-1!=t&&It.splice(t,1)},t.remove_actions=function(e){for(var t=St.length-1;t>=0;t--)St[t]._data_id==e&&St.splice(t,1)},t.apply_to_first_empty_slot=function(e,t){if(!e.anim_slots.length)return xe(e,null,t,nt)?nt:-1;for(var r=0;r<e.anim_slots.length;r++)if(!e.anim_slots[r])return xe(e,null,t,r)?r:-1},t.set_skel_mix_factor=function(e,t,r,a){var n=e.render,_=(t-n.anim_mix_factor)/r;n.anim_mix_factor_change_speed=_,n.anim_destination_mix_factor=t,n.anim_mix_cb&&n.anim_mix_cb(),n.anim_mix_cb=a},t.mix_from_cur_pos=function(e,t,r,a){var n=e.render;n.blend_skel_slots[1]=t;var _=1/r;n.anim_mix_factor_change_speed=_,n.anim_destination_mix_factor=1,n.anim_mix_cb&&n.anim_mix_cb(),n.anim_mix_cb=a,n.trans_curr=null,n.quats_curr=null,n.mix_with_current=!0},t.set_speed=function(e,t,r){w(e.anim_slots,r,function(e){e.speed=t})},t.get_speed=function(e,t){return e.anim_slots[t].speed},t.get_anim_start_frame=function(e,t){return e.anim_slots[t].start},t.get_anim_length=function(e,t){return e.anim_slots[t].length},t.cleanup=function(){It.length=0,St.length=0},t.fcurve_replace_euler_by_quat=function(e){var t=(e[0]||e[1]||e[2])._pierced_points.length,r=xt,a=gt,n=Boolean(e[0]);n||(e[0]={_pierced_points:new Float32Array(t),num_channels:8});var _=Boolean(e[1]);_||(e[1]={_pierced_points:new Float32Array(t),num_channels:8});var s=Boolean(e[2]);s||(e[2]={_pierced_points:new Float32Array(t),num_channels:8}),e[3]={_pierced_points:new Float32Array(t),num_channels:8};for(var o=0;o<t;o++)a[0]=n?e[0]._pierced_points[o]:0,a[1]=_?e[1]._pierced_points[o]:0,a[2]=s?e[2]._pierced_points[o]:0,He.euler_to_quat(a,r),e[0]._pierced_points[o]=r[3],e[1]._pierced_points[o]=r[0],e[2]._pierced_points[o]=r[1],e[3]._pierced_points[o]=r[2]},t.get_bpy_armobj=ke,t.slot_by_anim_type=function(e,t){for(var r=_t,a=Ke,n=0;n<St.length;n++){var _=St[n];if(_.name==t){a=_._render.type;break}}if(a==Ke)if(Oe(e,t))a=Je;else{var s=Re(e,t);s&&"EMITTER"==s.p_type&&(a=et)}for(n=0;n<8;n++){var o=e.anim_slots[n];if(o){if(o.type==a)return n}else n<r&&(r=n)}return r}}),J=o("__material",function(e,t){function r(){return{name:"",type:"",uuid:"",use_nodes:!1,node_tree:null,texture_slots:[],blend_mode:"",use_shadeless:!1,use_transparency:!1,use_backface_culling:!1,use_tangent_shading:!1,use_orco_tex_coord:!1,use_vertex_color_paint:!1,use_double_sided_lighting:!1,do_not_render:!1,render_above_all:!1,is_lens_flares:!1,is_wettable:!1,is_refractive:!1,refr_bump:0,pass_index:0,offset_z:0,diffuse_shader:"",diffuse_color:new Float32Array(3),diffuse_intensity:0,diffuse_toon_size:0,diffuse_toon_smooth:0,roughness:0,diffuse_fresnel:0,diffuse_fresnel_factor:0,darkness:0,alpha:0,specular_shader:"",specular_color:new Float32Array(3),specular_intensity:0,specular_toon_size:0,specular_toon_smooth:0,specular_hardness:0,specular_ior:0,specular_slope:0,specular_alpha:0,emit:0,ambient:0,water_settings:{is_water:!1,shore_smoothing:!1,absorb_factor:0,foam_factor:0,shallow_col:new Float32Array(3),shore_col:new Float32Array(3),shallow_col_fac:0,shore_col_fac:0,fog_color:new Float32Array(3),fog_density:0,sss_strength:0,sss_width:0,norm_uv_velocity:0,is_dynamic:!1,waves_height:0,waves_length:0,dst_noise_scale0:0,dst_noise_scale1:0,dst_noise_freq0:0,dst_noise_freq1:0,dir_min_shore_fac:0,dir_freq:0,dir_noise_scale:0,dir_noise_freq:0,dir_min_noise_fac:0,dst_min_fac:0,waves_hor_fac:0,is_generated_mesh:!1,num_cascads:0,num_subdivs:0,detailed_dist:0,enable_caust:!1,caust_scale:0,caust_brightness:0},terrain_settings:{is_terrain:!1,dynamic_grass_size:"",dynamic_grass_color:""},raytrace_mirror:{reflect_factor:0,fresnel:0,fresnel_factor:0},halo_settings:{size:0,hardness:0,rings_color:new Float32Array(3),lines_color:new Float32Array(3),ring_count:0,line_count:0,star_tip_count:0,is_sky_stars:!1,stars_blend_height:0,stars_min_height:0},physics_settings:{use_coll_physics:!1,use_ghost:!1,friction:0,elasticity:0,collision_id:"",collision_margin:0,collision_group:0,collision_mask:0}}}var a=h(e);t.init_material=r,t.create_default=function(){var e=r();return e.name="DEFAULT",e.type="SURFACE",e.uuid=a.gen_uuid(),e.use_nodes=!1,e.node_tree=null,e.texture_slots=[],e.blend_mode="OPAQUE",e.use_shadeless=!1,e.use_transparency=!1,e.use_backface_culling=!0,e.use_vertex_color_paint=!1,e.use_double_sided_lighting=!1,e.render_above_all=!1,e.is_refractive=!1,e.refr_bump=0,e.pass_index=0,e.offset_z=0,e.diffuse_shader="LAMBERT",e.diffuse_color.set([.8,.8,.8]),e.diffuse_intensity=.8,e.alpha=1,e.specular_shader="COOKTORR",e.specular_color.set([1,1,1]),e.specular_intensity=.5,e.specular_hardness=50,e.specular_alpha=1,e.emit=0,e.ambient=1,e.water_settings.is_water=!1,e.terrain_settings.is_terrain=!1,e.raytrace_mirror.reflect_factor=0,e.raytrace_mirror.fresnel=0,e.raytrace_mirror.fresnel_factor=1.25,e.physics_settings.use_coll_physics=!1,e},t.update_material=function(e,t){t.name=e.name,t.type=e.type,t.uuid=e.uuid,t.use_nodes=e.use_nodes,t.node_tree=e.node_tree,t.texture_slots=e.texture_slots,t.blend_mode=e.game_settings.alpha_blend,t.use_shadeless=e.use_shadeless,t.use_transparency=e.use_transparency,t.use_backface_culling=e.game_settings.use_backface_culling,t.use_tangent_shading=e.use_tangent_shading,t.use_orco_tex_coord=e.use_orco_tex_coord,t.use_vertex_color_paint=e.use_vertex_color_paint,t.use_double_sided_lighting=e.b4w_double_sided_lighting,t.do_not_render=e.b4w_do_not_render,t.render_above_all=e.b4w_render_above_all,t.is_lens_flares=e.b4w_lens_flares,t.is_wettable=e.b4w_wettable,t.is_refractive=e.b4w_refractive,t.refr_bump=e.b4w_refr_bump,t.pass_index=e.pass_index,t.offset_z=e.offset_z,t.diffuse_shader=e.diffuse_shader,t.diffuse_color.set(e.diffuse_color),t.diffuse_intensity=e.diffuse_intensity,t.diffuse_toon_size=e.diffuse_toon_size,t.diffuse_toon_smooth=e.diffuse_toon_smooth,t.roughness=e.roughness,t.diffuse_fresnel=e.diffuse_fresnel,t.diffuse_fresnel_factor=e.diffuse_fresnel_factor,t.darkness=e.darkness,t.alpha=e.alpha,t.specular_shader=e.specular_shader,t.specular_color.set(e.specular_color),t.specular_intensity=e.specular_intensity,t.specular_toon_size=e.specular_toon_size,t.specular_toon_smooth=e.specular_toon_smooth,t.specular_hardness=e.specular_hardness,t.specular_ior=e.specular_ior,t.specular_slope=e.specular_slope,t.specular_alpha=e.specular_alpha,t.emit=e.emit,t.ambient=e.ambient;var r=t.water_settings;r.is_water=e.b4w_water,r.shore_smoothing=e.b4w_water_shore_smoothing,r.absorb_factor=e.b4w_water_absorb_factor,r.foam_factor=e.b4w_foam_factor,r.shallow_col.set(e.b4w_shallow_water_col),r.shore_col.set(e.b4w_shore_water_col),r.shallow_col_fac=e.b4w_shallow_water_col_fac,r.shore_col_fac=e.b4w_shore_water_col_fac,r.fog_color.set(e.b4w_water_fog_color),r.fog_density=e.b4w_water_fog_density,r.sss_strength=e.b4w_water_sss_strength,r.sss_width=e.b4w_water_sss_width,r.norm_uv_velocity=e.b4w_water_norm_uv_velocity,r.is_dynamic=e.b4w_water_dynamic,r.waves_height=e.b4w_waves_height,r.waves_length=e.b4w_waves_length,r.dst_noise_scale0=e.b4w_water_dst_noise_scale0,r.dst_noise_scale1=e.b4w_water_dst_noise_scale1,r.dst_noise_freq0=e.b4w_water_dst_noise_freq0,r.dst_noise_freq1=e.b4w_water_dst_noise_freq1,r.dir_min_shore_fac=e.b4w_water_dir_min_shore_fac,r.dir_freq=e.b4w_water_dir_freq,r.dir_noise_scale=e.b4w_water_dir_noise_scale,r.dir_noise_freq=e.b4w_water_dir_noise_freq,r.dir_min_noise_fac=e.b4w_water_dir_min_noise_fac,r.dst_min_fac=e.b4w_water_dst_min_fac,r.waves_hor_fac=e.b4w_water_waves_hor_fac,r.is_generated_mesh=e.b4w_generated_mesh,r.num_cascads=e.b4w_water_num_cascads,r.num_subdivs=e.b4w_water_subdivs,r.detailed_dist=e.b4w_water_detailed_dist,r.enable_caust=e.b4w_water_enable_caust,r.caust_scale=e.b4w_water_caust_scale,r.caust_brightness=e.b4w_water_caust_brightness;var a=t.terrain_settings;a.is_terrain=e.b4w_terrain,a.dynamic_grass_size=e.b4w_dynamic_grass_size,a.dynamic_grass_color=e.b4w_dynamic_grass_color;var n=t.raytrace_mirror;n.reflect_factor=e.raytrace_mirror.reflect_factor,n.fresnel=e.raytrace_mirror.fresnel,n.fresnel_factor=e.raytrace_mirror.fresnel_factor;var _=t.halo_settings;_.size=e.halo.size,_.hardness=e.halo.hardness,_.rings_color.set(e.halo.b4w_halo_rings_color),_.lines_color.set(e.halo.b4w_halo_lines_color),_.ring_count=e.halo.ring_count,_.line_count=e.halo.line_count,_.star_tip_count=e.halo.star_tip_count,_.is_sky_stars=e.b4w_halo_sky_stars,_.stars_blend_height=e.b4w_halo_stars_blend_height,_.stars_min_height=e.b4w_halo_stars_min_height;var s=t.physics_settings;s.use_coll_physics=e.b4w_collision,s.use_ghost=e.b4w_use_ghost,s.friction=e.physics.friction,s.elasticity=e.physics.elasticity,s.collision_id=e.b4w_collision_id,s.collision_margin=e.b4w_collision_margin,s.collision_group=e.b4w_collision_group,s.collision_mask=e.b4w_collision_mask},t.clone_material=function(e){var t=e;t.name=e.name,t.type=e.type,t.uuid=e.uuid,t.use_nodes=e.use_nodes,t.node_tree=e.node_tree,t.texture_slots=e.texture_slots.slice(),t.blend_mode=e.blend_mode,t.use_shadeless=e.use_shadeless,t.use_transparency=e.use_transparency,t.use_backface_culling=e.use_backface_culling,t.use_tangent_shading=e.use_tangent_shading,t.use_orco_tex_coord=e.use_orco_tex_coord,t.use_vertex_color_paint=e.use_vertex_color_paint,t.use_double_sided_lighting=e.use_double_sided_lighting,t.do_not_render=e.do_not_render,t.render_above_all=e.render_above_all,t.is_lens_flares=e.is_lens_flares,t.is_wettable=e.is_wettable,t.is_refractive=e.is_refractive,t.refr_bump=e.refr_bump,t.pass_index=e.pass_index,t.offset_z=e.offset_z,t.diffuse_shader=e.diffuse_shader,t.diffuse_color.set(e.diffuse_color),t.diffuse_intensity=e.diffuse_intensity,t.diffuse_toon_size=e.diffuse_toon_size,t.diffuse_toon_smooth=e.diffuse_toon_smooth,t.roughness=e.roughness,t.diffuse_fresnel=e.diffuse_fresnel,t.diffuse_fresnel_factor=e.diffuse_fresnel_factor,t.darkness=e.darkness,t.alpha=e.alpha,t.specular_shader=e.specular_shader,t.specular_color.set(e.specular_color),t.specular_intensity=e.specular_intensity,t.specular_toon_size=e.specular_toon_size,t.specular_toon_smooth=e.specular_toon_smooth,t.specular_hardness=e.specular_hardness,t.specular_ior=e.specular_ior,t.specular_slope=e.specular_slope,t.specular_alpha=e.specular_alpha,t.emit=e.emit,t.ambient=e.ambient;var r=e.water_settings,a=t.water_settings;a.is_water=r.is_water,a.shore_smoothing=r.shore_smoothing,a.absorb_factor=r.absorb_factor,a.foam_factor=r.foam_factor,a.shallow_col.set(r.shallow_col),a.shore_col.set(r.shore_col),a.shallow_col_fac=r.shallow_col_fac,a.shore_col_fac=r.shore_col_fac,a.fog_color=r.fog_color,a.fog_density=r.fog_density,a.sss_strength=r.sss_strength,a.sss_width=r.sss_width,a.norm_uv_velocity=r.norm_uv_velocity,a.is_dynamic=r.is_dynamic,a.waves_height=r.waves_height,a.waves_length=r.waves_length,a.dst_noise_scale0=r.dst_noise_scale0,a.dst_noise_scale1=r.dst_noise_scale1,a.dst_noise_freq0=r.dst_noise_freq0,a.dst_noise_freq1=r.dst_noise_freq1,a.dir_min_shore_fac=r.dir_min_shore_fac,a.dir_freq=r.dir_freq,a.dir_noise_scale=r.dir_noise_scale,a.dir_noise_freq=r.dir_noise_freq,a.dir_min_noise_fac=r.dir_min_noise_fac,a.dst_min_fac=r.dst_min_fac,a.waves_hor_fac=r.waves_hor_fac,a.is_generated_mesh=r.is_generated_mesh,a.num_cascads=r.num_cascads,a.num_subdivs=r.num_subdivs,a.detailed_dist=r.detailed_dist,a.enable_caust=r.enable_caust,a.caust_scale=r.caust_scale,a.caust_brightness=r.caust_brightness;var n=e.terrain_settings,_=t.terrain_settings;_.is_terrain=n.is_terrain,_.dynamic_grass_size=n.dynamic_grass_size,_.dynamic_grass_color=n.dynamic_grass_color;var s=e.raytrace_mirror,o=t.raytrace_mirror;o.reflect_factor=s.reflect_factor,o.fresnel=s.fresnel,o.fresnel_factor=s.fresnel_factor;var i=e.halo_settings,l=t.halo_settings;l.size=i.size,l.hardness=i.hardness,l.rings_color.set(i.rings_color),l.lines_color.set(i.lines_color),l.ring_count=i.ring_count,l.line_count=i.line_count,l.star_tip_count=i.star_tip_count,l.is_sky_stars=i.is_sky_stars,l.stars_blend_height=i.stars_blend_height,l.stars_min_height=i.stars_min_height;var c=e.physics_settings,u=t.physics_settings;return u.use_coll_physics=c.use_coll_physics,u.use_ghost=c.use_ghost,u.friction=c.friction,u.elasticity=c.elasticity,u.collision_id=c.collision_id,u.collision_margin=c.collision_margin,u.collision_group=c.collision_group,u.collision_mask=c.collision_mask,t}}),$=o("__objects",function(e,t){function r(e){for(var t=e.scenes_data,r=e.render,a=0;a<t.length;a++){var n=t[a].scene;n._render.outline&&r.outline_intensity&&Fe.request_outline(n)}}function a(e){e.render.outline_intensity=0;var t=at.indexOf(e);-1!=t&&at.splice(t,1)}function n(e,t){if(t.uuid=e.uuid,t.is_meta=!1,t.def_action_slots=e._def_action_slots,t.is_dynamic=e._is_dynamic,t.is_hair_dupli=e._is_hair_dupli||!1,G(e,t),"MESH"===t.type)r=t.is_dynamic?"DYNAMIC":"STATIC";else var r=t.type;var a=t.render=Se.create_render(r);q(e,t);var n=e.location,_=e.scale[0],o=_t;switch(We.quat_bpy_b4w(e.rotation_quaternion,o),Ye.set_translation(t,n),Ye.set_rotation(t,o),Ye.set_scale(t,_),t.use_default_animation=e.b4w_use_default_animation,t.anim_behavior_def=ye.anim_behavior_bpy_b4w(e.b4w_anim_behavior),e.b4w_object_tags&&(t.metatags={title:e.b4w_object_tags.title,description:e.b4w_object_tags.description,category:e.b4w_object_tags.category}),t.custom_prop=e.b4w_custom_prop,e.b4w_viewport_alignment&&(t.viewport_alignment={alignment:e.b4w_viewport_alignment.alignment,distance:e.b4w_viewport_alignment.distance}),a.hide=e.b4w_hidden_on_load,a.hide_children=e.b4w_hide_chldr_on_load,e.type){case"ARMATURE":Ve.update_object(e,t);var i=a.bone_pointers,l=ye.calc_pose_data(i);e.b4w_animation_mixing?(a.quats_before=new Float32Array(l.quats),a.quats_after=new Float32Array(l.quats),a.trans_before=new Float32Array(l.trans),a.trans_after=new Float32Array(l.trans)):(a.quats_before=l.quats,a.quats_after=l.quats,a.trans_before=l.trans,a.trans_after=l.trans);for(var c in i){var u=i[c];1==u.chain.length&&Ve.update_bone_tsr_r(u,!0,l.trans,l.quats)}a.pose_data=l,a.frame_factor=0,a.anim_mixing=e.b4w_animation_mixing;break;case"MESH":a.bb_original=Ee.bb_bpy_to_b4w(e.data.b4w_boundings.bb),t.is_boundings_overridden=e.data.is_boundings_overridden,a.do_not_render=e.b4w_do_not_render,a.selectable=Qe.outlining_overview_mode||e.b4w_selectable,a.origin_selectable=e.b4w_selectable,a.outlining=Qe.outlining_overview_mode||e.b4w_outlining,a.origin_outlining=e.b4w_outlining,a.outline_on_select=Qe.outlining_overview_mode||e.b4w_outline_on_select,a.billboard=e.b4w_billboard,a.billboard_pres_glob_orientation=e.b4w_pres_glob_orientation,a.billboard_type="BASIC",a.billboard_spherical="SPHERICAL"==e.b4w_billboard_geometry;var d=a.outline_anim_settings_default;if(d.outline_duration=e.b4w_outline_settings.outline_duration,d.outline_period=e.b4w_outline_settings.outline_period,d.outline_relapses=e.b4w_outline_settings.outline_relapses,a.selectable&&(a.color_id=We.gen_color_id(et),et++),H(e,t),P(e,t),a.shadow_cast=e.b4w_shadow_cast,a.shadow_receive=e.b4w_shadow_receive,a.shadow_cast_only=e.b4w_shadow_cast_only&&a.shadow_cast,a.reflexible=e.b4w_reflexible,a.reflexible_only=e.b4w_reflexible_only&&a.reflexible,a.reflective=e.b4w_reflective,a.reflection_type=e.b4w_reflection_type,a.reflective||s(t),a.caustics=e.b4w_caustics,a.wind_bending=e.b4w_wind_bending,e.b4w_wind_bending){a.wind_bending_angle=e.b4w_wind_bending_angle;var f=Ee.wb_angle_to_amp(We.deg_to_rad(e.b4w_wind_bending_angle),a.bb_original,e.scale[0]);a.wind_bending_amp=f,a.wind_bending_freq=e.b4w_wind_bending_freq,a.detail_bending_freq=e.b4w_detail_bending_freq,a.detail_bending_amp=e.b4w_detail_bending_amp,a.branch_bending_amp=e.b4w_branch_bending_amp,a.main_bend_col=e.b4w_main_bend_stiffness_col;var m=e.b4w_detail_bend_colors;a.detail_bend_col.leaves_stiffness=m.leaves_stiffness_col,a.detail_bend_col.leaves_phase=m.leaves_phase_col,a.detail_bend_col.overall_stiffness=m.overall_stiffness_col}if(a.dynamic_geometry=e.b4w_dynamic_geometry,a.dynamic_geometry)for(t._bpy_obj=e,b=0;b<t.materials.length;b++){var p=t.materials[b];t.mat_inheritance_data.original_mat_names.push(p.name),t.mat_inheritance_data.is_disabled.push(!1)}var h=t.materials[0];a.friction=h.physics_settings.friction,a.elasticity=h.physics_settings.elasticity,a.lod_dist_min=0,a.lod_dist_max=Se.LOD_DIST_MAX_INFINITY,a.pass_index=e.pass_index;break;case"LINE":a.bb_local=we.create_bb(),a.be_local=we.create_be(),a.bb_world=we.create_bb(),a.be_world=we.create_be();break;case"CAMERA":Ae.camera_object_to_camera(e,t),Ae.assign_boundings(t);break;case"LAMP":ke.lamp_to_light(e,t);break;case"SPEAKER":t.sfx=Ge.create_sfx();for(var v=!1,b=0;b<t.scenes_data.length;b++)if(t.scenes_data[b].scene._sfx){v=!0;break}v&&Ge.update_object(e,t);break;case"EMPTY":var g=we.create_bb();a.bb_local=g;var y=we.create_bs();a.bs_local=y,e.field&&(t.field={type:e.field.type,strength:e.field.strength}),e.b4w_anchor&&(t.anchor={type:e.b4w_anchor.type,detect_visibility:e.b4w_anchor.detect_visibility,element_id:e.b4w_anchor.element_id,max_width:e.b4w_anchor.max_width})}ie(t)}function _(e,t){t.uuid=e.uuid,t.is_meta=!1,t.def_action_slots=e._def_action_slots,t.is_dynamic=e._is_dynamic;var r=t.type;t.render=Se.create_render(r),t.use_default_animation=e.b4w_use_default_animation,t.anim_behavior_def=ye.anim_behavior_bpy_b4w(e.b4w_anim_behavior),ie(t)}function s(e){for(var t=e.materials,r=0;r<t.length;r++){var a=t[r];a.use_nodes&&(o(a.node_tree,"BSDF_GLOSSY")||o(a.node_tree,"BSDF_DIFFUSE"))&&(e.render.reflective=!0,e.render.reflection_type="CUBE")}}function o(e,t){return-1!=e._bsdf_types.indexOf(t)}function i(e){if(e.field)for(var t=e.scenes_data,r=0;r<t.length;r++){var a=t[r].scene;Fe.update_force_scene(a,e)}}function c(e,t){var r=t.render;if("CUBE"==r.reflection_type)r.cube_reflection_id=tt++;else if("PLANE"==r.reflection_type){var a=f(e,t);a||(a=u(t));for(var n=null,_=0;_<rt.length;_++)if(rt[_]==a){n=_;break}null==n&&(n=rt.length,rt.push(a)),a.render.plane_reflection_id=n,r.plane_reflection_id=n,a.reflective_objs.push(t)}}function u(e){var t=We.unique_name("%reflection%"),r=Se.create_object(t,"EMPTY"),a=Se.create_render("EMPTY");return r.render=a,p(e,r),xe.append_stiff_obj(r,e,[0,0,0],null,1),ie(r),r}function f(e,t){for(var r=e.constraints,a=0;a<r.length;a++){var n=r[a];if("LOCKED_TRACK"==n.type&&"REFLECTION PLANE"==n.name){if(n.target&&n.target._object)return n.target._object;Pe.warn('Reflection plane target for object: "'+t.name+"\" is not present on the scene. Using object's Z-axis.")}}return null}function p(e,t){for(var r=e.scenes_data,a=t.scenes_data,n=0;n<r.length;n++){for(var _=!1,s=0;s<a.length;s++)if(r[n].scene==a[s].scene){_=!0;break}_||y(t,r[n].scene)&&Se.append_scene_data(t,r[n].scene)}}function y(e,t){return!(!t._is_main&&"SPEAKER"==e.type||!t._is_primary_thread&&"LAMP"==e.type)}function E(e){var t=ye.bpy_mesh_empty_is_animatable(e),r=e.b4w_do_not_batch,a=e.b4w_collision,n=e.b4w_vehicle,_=e.b4w_floating,s=e.b4w_character,o=Le.has_dynamic_grass_particles(e),i=Me.bpy_obj_has_nla(e),l=e.data.b4w_shape_keys.length>0,c=e.b4w_dynamic_geometry,u=T(e);return Je||t||r||a||n||l||_||o||s||i||c||I(e)||u}function T(e){var t=!1,r=e.constraints.length;if(r){for(var a=null,n=r-1;n>=0;n--){var _=e.constraints[n];if("LOCKED_TRACK"!=_.type||"REFLECTION PLANE"!=_.name){a=_;break}}if(!a)return!1;if(!a.target)return!1;var s=a.target,o=s.type;if(s.parent){var i=s.parent.type;return t="MESH"==i?t||E(s.parent):"EMPTY"!=i||t||M(s.parent)}t="MESH"==o?t||E(s):"EMPTY"!=o||t||M(s)}return t}function M(e){var t=ye.bpy_mesh_empty_is_animatable(e),r=Me.bpy_obj_has_nla(e),a=e.b4w_do_not_batch,n=Boolean(e.b4w_anchor),_=T(e);return t||r||a||n||_}function I(e){for(var t=e.data,r=0;r<t.materials.length;r++){var a=t.materials[r];if(a.water_settings.is_water)return!0;if(a.is_lens_flares)return!0;if(S(a.node_tree))return!0}return!1}function S(e){if(!e)return!1;for(var t=e.nodes,r=0;r<t.length;r++){var a=t[r];if("VECT_TRANSFORM"==a.type){var n=a.convert_from,_=a.convert_to;if((o=a.outputs[0]).is_linked&&("WORLD"!=n||"CAMERA"!=_)&&("CAMERA"!=n||"WORLD"!=_)&&("OBJECT"!=n||"OBJECT"!=_))return!0}if("NORMAL_MAP"==a.type){var s=a.space,o=a.outputs[0];if(o.is_linked&&("OBJECT"==s||"BLENDER_OBJECT"==s))return!0}if("TEX_COORD"==a.type&&a.outputs[3].is_linked)return!0;if("OBJECT_INFO"==a.type){var i=a.outputs[0],l=a.outputs[1],c=a.outputs[3];if(i.is_linked||l.is_linked||c.is_linked)return!0}}return!1}function L(e,t,r){var a=t.render,n=e.data;t.armobj=r;var _=n.vertex_groups;if(_.length){var s=r.render.bone_pointers,o=0,i={};for(var l in s){var c=We.keysearch("name",l,_);if(c){var u=s[l];i[l]={vgroup_index:c.index,bone_index:u.bone_index,deform_bone_index:o++}}}a.bone_skinning_info=i;var d=o,f=ye.get_max_bones();a.max_bones=d,d>2*f?(a.is_skinning=!1,Pe.error('too many bones for "'+e.name+'" / '+a.max_bones+" bones (max "+f+" with blending, "+2*f+" without blending). Skinning will be disabled.")):a.is_skinning=!0}}function P(e,t){"MESH"!=e.type&&We.panic("Wrong object type: "+e.name);var r=t.render;if(e.data.b4w_shape_keys.length){r.use_shape_keys=!0;for(var a=0;a<e.data.b4w_shape_keys.length;a++){var n={};n.value=e.data.b4w_shape_keys[a].value,n.name=e.data.b4w_shape_keys[a].name,r.shape_keys_values.push(n)}}else r.use_shape_keys=!1}function U(e){if($(e,$e.ALL,!1,st)){for(var t,r=1;t="."+(String(r).length<3?("000"+String(r)).slice(-3):String(r)),$(e+t,$e.ALL,!1,st);)r++;return Pe.error('Object "'+e+'" already exists. Name was replaced by "'+e+t+'".'),t}return""}function F(e,t,r){var a=t,n=Se.get_dg_parent(e),_=n?Se.gen_dupli_name(n.name,t):t,s=U(_);_+=s,a+=s;var o=Se.create_object(_,e.type,a);o.is_meta=e.is_meta,o._bpy_obj=e._bpy_obj,o.mat_inheritance_data.original_mat_names=Se.copy_bpy_object_props_by_link(e.mat_inheritance_data.original_mat_names),o.mat_inheritance_data.is_disabled=Se.copy_bpy_object_props_by_link(e.mat_inheritance_data.is_disabled),o.is_dynamic=e.is_dynamic,o.is_hair_dupli=e.is_hair_dupli,o.use_default_animation=e.use_default_animation,o.def_action_slots=e.def_action_slots,o.render=Se.clone_render(e.render),o.render.is_lod=!1,o.metatags=Se.copy_object_props_by_value(e.metatags),o.custom_prop=Se.copy_object_props_by_value(e.custom_prop),p(e,o),o.action_anim_cache=Se.copy_bpy_object_props_by_link(e.action_anim_cache),o.parent=Se.copy_bpy_object_props_by_link(e.parent),o.parent_is_dupli=e.parent_is_dupli,o.parent_bone=e.parent_bone,o.vertex_anim=Se.copy_bpy_object_props_by_link(e.vertex_anim),o.anim_behavior_def=e.anim_behavior_def,e.physics&&!(e.is_vehicle||e.is_character||e.is_floating)&&(o.use_obj_physics=e.use_obj_physics,o.physics=null),o.collision_id=e.collision_id,o.correct_bounding_offset=e.correct_bounding_offset,o.physics_settings=Se.copy_object_props_by_value(e.physics_settings),B(e,o,r);for(var i=0;i<e.materials.length;i++)o.materials.push(Ne.clone_material(e.materials[i]));return Se.scene_data_set_active(o,!1),ie(o),o}function B(e,t,r){for(var a=[],n=0;n<e.scenes_data.length;n++){var _=e.scenes_data[n],s=t.scenes_data[n],o=_.batches;if(r){for(var i=s.batches,l=0;l<o.length;l++)if(!o[l].forked_batch){var c=Se.copy_object_props_by_value(o[l]);c.bufs_data=Re.clone_bufs_data(o[l].bufs_data),Se.append_batch(t,s.scene,c),a.push(o[l].bufs_data)}for(l=0;l<o.length;l++)if(o[l].forked_batch){var u=Se.copy_object_props_by_value(o[l]);Se.append_batch(t,s.scene,u);for(var d=0;d<a.length;d++)a[d]==o[l].bufs_data&&(u.bufs_data=i[d].bufs_data)}for(l=0;l<i.length;l++)i[l].bufs_data&&Re.update_gl_buffers(i[l].bufs_data),Ze.allow_vao_ext&&i[l].bufs_data&&Ke.assign_vao(i[l]),i[l].odd_id_prop=Ee.generate_odd_id(i[l],t.render,t.uuid),Ee.update_batch_id(i[l]);je.share_batch_canvas_textures(i)}else for(l=0;l<o.length;l++)Se.append_batch(t,s.scene,o[l])}}function G(e,t){t.is_vehicle=e.b4w_vehicle,t.is_character=e.b4w_character,t.is_floating=e.b4w_floating,t.use_obj_physics=e.b4w_collision,t.collision_id=e.b4w_collision_id,t.correct_bounding_offset=e.b4w_correct_bounding_offset;var r=e.game;t.physics_settings={physics_type:r.physics_type,use_ghost:r.use_ghost,use_sleep:r.use_sleep,mass:r.mass,velocity_min:r.velocity_min,velocity_max:r.velocity_max,damping:r.damping,rotation_damping:r.rotation_damping,lock_location_x:r.lock_location_x,lock_location_y:r.lock_location_y,lock_location_z:r.lock_location_z,lock_rotation_x:r.lock_rotation_x,lock_rotation_y:r.lock_rotation_y,lock_rotation_z:r.lock_rotation_z,collision_margin:r.collision_margin,collision_group:r.collision_group,collision_mask:r.collision_mask,use_collision_bounds:r.use_collision_bounds,collision_bounds_type:r.collision_bounds_type,use_collision_compound:r.use_collision_compound};var a=e.b4w_vehicle_settings;a&&(t.vehicle_settings={name:a.name,part:a.part,suspension_rest_length:a.suspension_rest_length,suspension_compression:a.suspension_compression,suspension_stiffness:a.suspension_stiffness,suspension_damping:a.suspension_damping,wheel_friction:a.wheel_friction,roll_influence:a.roll_influence,max_suspension_travel_cm:a.max_suspension_travel_cm,force_max:a.force_max,brake_max:a.brake_max,steering_max:a.steering_max,max_speed_angle:a.max_speed_angle,delta_tach_angle:a.delta_tach_angle,speed_ratio:a.speed_ratio,steering_ratio:a.steering_ratio,inverse_control:a.inverse_control,floating_factor:a.floating_factor,water_lin_damp:a.water_lin_damp,water_rot_damp:a.water_rot_damp,synchronize_position:a.synchronize_position});var n=e.b4w_floating_settings;n&&(t.floating_settings={name:n.name,part:n.part,floating_factor:n.floating_factor,water_lin_damp:n.water_lin_damp,water_rot_damp:n.water_rot_damp,synchronize_position:n.synchronize_position});var _=e.b4w_character_settings;_&&(t.character_settings={walk_speed:_.walk_speed,run_speed:_.run_speed,step_height:_.step_height,jump_strength:_.jump_strength,waterline:_.waterline});for(var s=0;s<e.constraints.length;s++){var o=e.constraints[s];"RIGID_BODY_JOINT"==o.type&&t.physics_constraints.push({target:o.target._object,pivot_type:o.pivot_type,pivot_x:o.pivot_x,pivot_y:o.pivot_y,pivot_z:o.pivot_z,axis_x:o.axis_x,axis_y:o.axis_y,axis_z:o.axis_z,use_limit_x:o.use_limit_x,use_limit_y:o.use_limit_y,use_limit_z:o.use_limit_z,use_angular_limit_x:o.use_angular_limit_x,use_angular_limit_y:o.use_angular_limit_y,use_angular_limit_z:o.use_angular_limit_z,limit_max_x:o.limit_max_x,limit_max_y:o.limit_max_y,limit_max_z:o.limit_max_z,limit_min_x:o.limit_min_x,limit_min_y:o.limit_min_y,limit_min_z:o.limit_min_z,limit_angle_max_x:o.limit_angle_max_x,limit_angle_max_y:o.limit_angle_max_y,limit_angle_max_z:o.limit_angle_max_z,limit_angle_min_x:o.limit_angle_min_x,limit_angle_min_y:o.limit_angle_min_y,limit_angle_min_z:o.limit_angle_min_z})}}function H(e,t){for(var r=0;r<e.data.b4w_vertex_anim.length;r++){var a=e.data.b4w_vertex_anim[r];t.vertex_anim.push({name:a.name,frame_start:a.frame_start,frame_end:a.frame_end,averaging:a.averaging,averaging_interval:a.averaging_interval,allow_nla:a.allow_nla})}t.render.vertex_anim=!!t.vertex_anim.length}function q(e,t){e.parent?(t.parent=e.parent._object,"BONE"==e.parent_type&&"ARMATURE"==e.parent.type&&(t.parent_bone=e.parent_bone),e.pinverse_tsr&&(t.pinverse_tsr=He.create(),He.copy(e.pinverse_tsr,t.pinverse_tsr))):e.dg_parent&&(t.parent=e.dg_parent._object,t.parent_is_dupli=!0)}function X(e,t,r){for(var a=$e[t]||[],n=[],_=0;_<a.length;_++){var s=a[_];if(s.render.data_id==r||r==st)for(var o=s.scenes_data,i=0;i<o.length;i++)o[i].scene==e&&n.push(s)}return n}function K(e,t){var r=$e[e]||[];if(t==st)return r;for(var a=[],n=0;n<r.length;n++){var _=r[n];_.render.data_id==t&&a.push(_)}return a}function Z(e,t,r,a){for(var n=0;n<e.scenes_data.length;n++)for(var _=e.scenes_data[n].batches,s=0;s<_.length;s++){var o=_[s];if(o.bufs_data&&(o.bufs_data.cleanup_gl_data_on_unload=t),o.cleanup_gl_data_on_unload=t,o.shader&&(o.shader.cleanup_gl_data_on_unload=r),""!==o.ngraph_proxy_id){var i=Ie.get_ngraph_proxy_cached(o.ngraph_proxy_id);i&&(i.cleanup_on_unload=a)}}}function $(e,t,r,a,n){for(var _=null,s=0;s<t.length;s++){var o=t[s];if(!((r?o.origin_name:o.name)!=e||o.render.data_id!=a&&a!=st||n&&o.is_meta||(_=o,Se.get_dg_parent(_))))break}return _}function re(e,t,r,a){for(var n=0;n<r.length;n++){var _=r[n];if(_.origin_name==t&&(_.render.data_id==a||a==st)){var s=Se.get_dg_parent(_);if(s&&s.origin_name==e)return _}}return null}function ae(e,t,r){for(var a=0;a<t.length;a++){for(var n=t[a],_=e.length-1,s=n,o=!0;_>=0&&o;)o=s&&s.origin_name==e[_]&&(s.render.data_id==r||r==st),s&&(s=Se.get_dg_parent(s)),_--;if(o&&!s)return n}return null}function oe(e,t){var r=0,n=e.outline_animation;0==n.time_start&&(n.time_start=t);var _=t-n.time_start;if(n.relapses&&_/n.period>=n.relapses)a(e);else{var s=_%n.period;if(s<n.outline_time){var o=s/(n.outline_time/5),i=Math.floor(o);switch(i){case 0:r=(o-i)/2;break;case 1:r=(o-i)/2+.5;break;case 2:r=1;break;case 3:r=1-(o-i)/2;break;case 4:r=.5-(o-i)/2}}e.render.outline_intensity=r}}function ie(e){$e.ALL.push(e),$e[e.type]||($e[e.type]=[]),$e[e.type].push(e);var t=e.render.plane_reflection_id;if(null!=t)for(var r=0;r<rt.length;r++){var a=rt[r];a.render.plane_reflection_id==t&&a.reflective_objs.push(e)}}function le(e){var t=$e.ALL,r=$e[e.type],a=t.indexOf(e),n=r.indexOf(e);-1!=a&&t.splice(a,1),-1!=n&&r.splice(n,1)}function de(e,t,r){if(!t.is_lod)return!0;var a=e.lod_settings;if(a.dest_coverage!=a.coverage)if(a.use_smoothing){var n=We.sign(a.dest_coverage-a.coverage);a.coverage+=n*ze.get_delta()/ot,a.coverage=We.clamp(a.coverage,0,1)}else a.coverage=a.dest_coverage;if("STATIC"==t.type)_=t.lod_center;else var _=qe.add(t.bs_world.center,t.main_lod_offset,nt);var s=qe.dist(_,r);if(0==a.hyst_prev_state)var o=Math.max(t.lod_dist_min-a.hyst_interval_min/2,0),i=t.lod_dist_max+a.hyst_interval_max/2;else if(-1==a.hyst_prev_state)var o=t.lod_dist_min+a.hyst_interval_min/2,i=t.lod_dist_max+a.hyst_interval_max/2;else var o=Math.max(t.lod_dist_min-a.hyst_interval_min/2,0),i=Math.max(t.lod_dist_max-a.hyst_interval_max/2,0);return a.hyst_prev_state=s<o?-1:s<i?0:1,a.dest_coverage=s<o||s>i?0:1,a.cmp_logic=0==a.dest_coverage?-1:1,Math.abs(s-a.prev_dist)>Ze.lod_leap_smooth_threshold&&(0==a.coverage||1==a.coverage)&&(a.coverage=a.dest_coverage),a.prev_dist=s,0!=a.dest_coverage||0!=a.coverage}function fe(e,t){var r=e.render,a=t._render;if(r.is_lod)for(var n=Ye.get_translation(t._camera,nt),_=0;_<e.scenes_data.length;_++)if(e.scenes_data[_].scene==t)for(var s=0;s<e.scenes_data[_].batches.length;s++){var o=e.scenes_data[_].batches[s],i=o.lod_settings,l="SHADOW"==o.type&&"RECEIVE"==o.subtype&&!Ze.reuse_depth_optimization;if(Ze.lod_smooth_transitions&&!l){var c=a.lod_smooth_type;("ALL"==c||"NON-OPAQUE"==c&&(o.blend||o.alpha_clip))&&(i.use_smoothing=!0)}de(o,r,n),i.coverage=i.dest_coverage,i.hyst_interval_min=Math.min(a.lod_hyst_interval,2*it*r.lod_lower_border_range),i.hyst_interval_max=Math.min(a.lod_hyst_interval,2*it*r.lod_upper_border_range)}}function me(e,t){Z(e,!0,!1,!0);for(var r=K("ALL",st),a=0;a<r.length;a++){var n=r[a];n!=e&&Z(n,!1,!1,!1)}for(Fe.remove_object_bundles(e,t),a=0;a<e.scenes_data.length;a++)for(var _=e.scenes_data[a].batches.length-1;_>=0;_--){var s=e.scenes_data[a].batches[_];0!=s.material_names.length&&-1==s.material_names.indexOf(t)||Se.scene_data_remove_batch(e.scenes_data[a],_)}for(Ce.obj_has_physics(e)&&Ce.remove_object(e),a=0;a<r.length;a++)r[a]!=e&&Z(r[a],!0,!0,!0);ye.delete_cached_anim_data_by_mat(e,t);var o=e._bpy_obj._object;return e._bpy_obj._object=e,o}function pe(e,t){e._bpy_obj._object=t,Z(e,!0,!0,!0)}function he(e,t,r,a){var n=e.mat_inheritance_data.original_mat_names.indexOf(t),_=r.mat_inheritance_data.original_mat_names.indexOf(a),s=e.materials[n];r.materials[_]=s;var o=s.name;s.name=a;for(var i=0;i<r.materials.length;i++)r.mat_inheritance_data.is_disabled[i]=!(i==_);return o}function ve(e,t,r,a){for(var n=0;n<r.materials.length;n++)r.mat_inheritance_data.is_disabled[n]=!1;var _=e.mat_inheritance_data.original_mat_names.indexOf(t);e.materials[_].name=a}function be(e,t,r,a,n){for(o=1;o<e.render.shape_keys_values.length;o++){var _=e.render.shape_keys_values[o].name,s=e.render.shape_keys_values[o].value;Re.apply_shape_key(e,_,s)}if(ye.is_animated(e))for(var o=0;o<e.anim_slots.length;o++){var i=e.anim_slots[o];if(i)switch(i.type){case ye.OBJ_ANIM_TYPE_PARTICLES:var l=ye.get_current_frame_float(e,o);ye.set_frame(e,l,o);break;case ye.OBJ_ANIM_TYPE_MATERIAL:if(i.node_batches)for(var c=i.node_batches.length-1;c>=0;c--)-1!=i.node_batches[c].material_names.indexOf(t)&&i.node_batches.splice(c,1)}}if(a&&Ee.iterate_batches_by_mat(e,t,function(t){if(t.particles_data){var r=t.particles_data.name;if(a[r]){var n=t.particles_data.count_factor!=a[r].count_factor;t.particles_data=Le.clone_particles_data(a[r]),n&&Le.set_factor(e,r,t.particles_data.count_factor)}}},"PARTICLES"),n){var u=Ee.find_batch_material(e,t,"MAIN");u&&(u.diffuse_color.set(n.diffuse_color),u.diffuse_intensity=n.diffuse_intensity,u.diffuse_color_factor=n.diffuse_color_factor,u.diffuse_params.set(n.diffuse_params),u.specular_color.set(n.specular_color),u.specular_color_factor=n.specular_color_factor,u.specular_params.set(n.specular_params),u.specular_alpha=n.specular_alpha,u.emit=n.emit,u.ambient=n.ambient,u.alpha_factor=n.alpha_factor,u.mirror_factor=n.mirror_factor,u.normal_factor=n.normal_factor,u.reflect_factor=n.reflect_factor,u.refr_bump=n.refr_bump,u.fresnel_params.set(n.fresnel_params),u.parallax_scale=n.parallax_scale,u.texture_scale.set(n.texture_scale),u.shallow_water_col.set(n.shallow_water_col),u.shallow_water_col_fac=n.shallow_water_col_fac,u.shore_water_col.set(n.shore_water_col),u.shore_water_col_fac=n.shore_water_col_fac,u.foam_factor=n.foam_factor,u.water_norm_uv_velocity=n.water_norm_uv_velocity,u.node_values=n.node_values.slice(),u.node_rgbs=n.node_rgbs.slice())}Ee.iterate_batches_by_mat(e,t,function(t){for(var a=0;a<t.bpy_tex_names.length;a++){var n=t.bpy_tex_names[a],_=t.textures[a];if("IMAGE"==_.source||"ENVIRONMENT"==_.source){var s=je.get_texture_by_name(r,n);s&&_.img_full_filepath!=s.img_full_filepath&&je.set_texture_by_name(e,n,s)}}})}function ge(e,t){for(var r=e[t],a=t+1;a<e.length;a++)r+="%join%"+e[a];return r}var ye=Q(e),Ee=_e(e),we=b(e),Ae=ue(e),Te=g(e),xe=z(e),Oe=ce(e),Re=w(e),ke=R(e),Ne=J(e),Me=V(e),Ie=ne(e),Se=k(e),Le=N(e),Ce=W(e),Pe=m(e),De=C(e),Ue=d(e),Fe=j(e),Be=A(e),Ge=D(e),je=ee(e),ze=x(e),Ye=Y(e),He=v(e),We=h(e),qe=l(e),Ve=O(e),Xe=se(e),Ke=te(e),Ze=Te.defaults,Qe=Te.outlining,Je=!1,$e={ALL:[]},et=0,tt=0,rt=[],at=[],nt=new Float32Array(3),_t=new Float32Array(4),st=-1,ot=.4,it=.3;t.GET_OBJECT_BY_NAME=0,t.GET_OBJECT_BY_DUPLI_NAME=1,t.GET_OBJECT_BY_DUPLI_NAME_LIST=2,t.DATA_ID_ALL=st,t.update=function(e,t){for(_=0;_<at.length;_++){var a=at[_];oe(a,e),a.render.outline_intensity&&r(a)}var n=$e.ARMATURE;if(n)for(var _=0;_<n.length;_++){var s=n[_];s.need_update_transform&&(Ye.update_transform(s),s.need_update_transform=!1)}},t.set_outline_intensity=function(e,t){e.render.outline_intensity=t,r(e)},t.apply_outline_anim=function(e,t,r,a){var n=e.outline_animation;n.time_start=0,n.outline_time=t,n.period=r,n.relapses=a,-1==at.indexOf(e)&&at.push(e)},t.clear_outline_anim=a,t.create_object_from_bpy=function(e,t){var r=t?"%meta_world%"+e.name:e.name,a=t?"%meta_world%"+e.name:e.origin_name,s=t?"WORLD":e.type,o=Se.create_object(r,s,a);if("MESH"==o.type)for(i=0;i<e.data.materials.length;i++)o.materials.push(e.data.materials[i]);for(var i=0;i<e._scenes.length;i++)Se.append_scene_data(o,e._scenes[i]);return e._object=o,t?_(e,o):n(e,o),o},t.update_object_relations=function(e,t){var r=t.render;if("MESH"==t.type){var a=ye.get_bpy_armobj(e);if(a){var n=a._object,_=n.render.pose_data;L(e,t,n);var s=ye.extract_skinned_pose_data(_.trans,_.quats,r.bone_skinning_info);a.b4w_animation_mixing?(r.quats_before=new Float32Array(s.quats),r.quats_after=new Float32Array(s.quats),r.trans_before=new Float32Array(s.trans),r.trans_after=new Float32Array(s.trans)):(r.quats_before=s.quats,r.quats_after=s.quats,r.trans_before=s.trans,r.trans_after=s.trans),r.arm_rel_trans=new Float32Array(4),r.arm_rel_quat=Ue.create(),r.pose_data=s,r.frame_factor=0}r.reflective&&c(e,t)}},t.update_force=i,t.copy_scene_data=p,t.check_bpy_obj_scene_compatibility=y,t.update_objects_dynamics=function(e){for(var t=0;t<e.length;t++){var r=e[t];!r.render||"DYNAMIC"!=r.render.type&&"CAMERA"!=r.render.type||Ye.update_transform(r),r.use_default_animation&&ye.obj_is_animatable(r)&&(ye.apply_def(r),r.anim_slots.length&&ye.play(r,null,ye.SLOT_ALL))}},t.bpy_obj_is_dynamic=function(e){if(e.b4w_hidden_on_load)return!0;if(e.dg_parent&&e.dg_parent._is_dynamic)return!0;if(e.parent&&e.parent._is_dynamic)return!0;switch(e.type){case"MESH":return E(e);case"EMPTY":return M(e);default:return!0}},t.get_meta_tags=function(e){return We.clone_object_r(e.metatags)},t.get_custom_prop=function(e){return e.custom_prop},t.cleanup=function(){et=0,tt=0,rt.length=0,at.length=0,$e={ALL:[]}},t.copy=function(e,t,r){var a=F(e,t,r);return a.render.is_copied=!0,a.render.is_copied_deep=r,a.render.color_id=We.gen_color_id(et),et++,a},t.get_bpy_def_action_slots=function(e,t){var r=[],a=e.animation_data,n=e.data?e.data.animation_data:null;if(a&&a.action){var _=a.action;(_._render.type==ye.OBJ_ANIM_TYPE_OBJECT||_._render.type==ye.OBJ_ANIM_TYPE_ARMATURE&&"ARMATURE"==e.type||_._render.type==ye.OBJ_ANIM_TYPE_LIGHT&&"LAMP"==e.type||_._render.type==ye.OBJ_ANIM_TYPE_ENVIRONMENT&&t)&&r.push(ye.init_action_slot(null,_))}return n&&n.action&&("SPEAKER"==e.type||"LAMP"==e.type)&&r.push(ye.init_action_slot(null,n.action)),"MESH"==e.type&&r.push.apply(r,ye.get_bpy_material_actions(e)),t&&r.push.apply(r,ye.get_bpy_world_material_actions(e)),r},t.update_boundings=function(e){for(var t=e.render,r=null,a=e.scenes_data[0].batches,n=0;n<a.length;n++){var _=a[n],s=e.scenes_data[0].batch_world_bounds[n];if(_.bufs_data&&s.be&&s.bb&&(c=Re.get_vbo_type_by_attr_name("a_position"),u=Re.get_vbo_source_by_type(_.bufs_data.vbo_source_data,c))){var o=_.bufs_data.pointers.a_position.offset,i=_.bufs_data.pointers.a_position.length+o;Ee.update_local_bounds_from_pos(_,u.subarray(o,i)),Se.update_world_bounds_from_batch_tsr(_,t.world_tsr,s),"MAIN"==_.type&&(r?we.expand_bounding_box(r,_.bounds_local.bb):r=we.clone_bb(_.bounds_local.bb))}}if(r=r||we.create_bb(),t.billboard)Se.update_render_bounds_billboard(e,r);else{for(var l=[],n=0;n<a.length;n++)if("MAIN"==(_=a[n]).type){var c=Re.get_vbo_type_by_attr_name("a_position"),u=Re.get_vbo_source_by_type(_.bufs_data.vbo_source_data,c);if(u){var d=a[n].bufs_data.pointers,o=d.a_position.offset,i=d.a_position.length+o;l.push(u.subarray(o,i))}}Se.update_render_bounds_from_pos_arrays(e,r,l)}if(Ze.debug_view)for(n=0;n<a.length;n++)if("DEBUG_VIEW"===a[n].type&&a[n].debug_sphere){var f=t.be_local,m=De.generate_uv_sphere(16,8,1,f.center,!1,!1),p=[f.axis_x[0],f.axis_y[1],f.axis_z[2]];Re.scale_submesh_xyz(m,p,f.center),Re.submesh_drop_indices(m,1,!0),m.va_common.a_polyindex=Re.extract_polyindices(m),Ee.update_batch_geometry(a[n],m);break}},t.get_scene_objs=X,t.get_scene_objs_derived=function(e,t,r){for(var a=$e[t]||[],n=[],_=0;_<a.length;_++){var s=a[_];if(!(s.render.data_id!=r&&r!=st||s.is_meta))for(var o=s.scenes_data,i=0;i<o.length;i++)o[i].scene==e&&n.push(s)}return n},t.get_all_objects=K,t.get_first_character=function(e){var t=$e.MESH;if(t)for(var r=0;r<t.length;r++){var a=t[r];if(Ce.has_character_physics(a))for(var n=a.scenes_data,_=0;_<n.length;_++)if(n[_].scene==e)return a}return null},t.obj_switch_cleanup_flags=Z,t.get_selectable_objects=function(){var e=[],t=$e.MESH;if(t)for(var r=0;r<t.length;r++){var a=t[r];a.render.selectable&&!a.is_meta&&e.push(a)}return e},t.get_outlining_objects=function(){var e=[],t=$e.MESH;if(t)for(var r=0;r<t.length;r++){var a=t[r];a.render.outlining&&!a.is_meta&&e.push(a)}return e},t.get_object=function(){var e=null,r=$e.ALL;switch(arguments[0]){case t.GET_OBJECT_BY_NAME:e=$(arguments[1],r,!0,arguments[2],arguments[3]);break;case t.GET_OBJECT_BY_DUPLI_NAME:e=re(arguments[1],arguments[2],r,arguments[3]);break;case t.GET_OBJECT_BY_DUPLI_NAME_LIST:e=ae(arguments[1],r,arguments[2])}return e},t.get_world_by_name=function(e,t){return $("%meta_world%"+e,$e.WORLD,!0,t)},t.get_world_name=function(e){return e.origin_name.replace("%meta_world%","")},t.pick_object=function(e,r){var a=Fe.get_main();if(!a)return Pe.error("No active scene"),null;var n=Fe.get_subs(a,Be.STEREO);if(n&&n.enable_hmd_stereo){var _=Oe.get_canvas();e=_.clientHeight/2,r=_.clientWidth/2}var s=Xe.pick_anchor(e,r);if(s)return s;var o=Fe.pick_color(a,e,r);if(!o)return null;for(var i=X(a,"MESH",st),l=0;l<i.length;l++){var c=i[l].render,u=c.color_id;if(u&&Math.abs(255*u[0]-o[0])<3&&Math.abs(255*u[1]-o[1])<3&&Math.abs(255*u[2]-o[2])<3){if(c.outlining&&c.outline_on_select)if(Qe.outlining_overview_mode)t.apply_outline_anim(i[l],Qe.outline_duration,Qe.outline_period,Qe.outline_relapses);else{var d=c.outline_anim_settings_default;t.apply_outline_anim(i[l],d.outline_duration,d.outline_period,d.outline_relapses)}return i[l]}}return null},t.set_wind_params=function(e,t){for(var r=X(e,"EMPTY",st),a=0;a<r.length;a++){var n=r[a];if(n.field&&"WIND"===n.field.type){var _=n;break}}if(!_)return Pe.error("There is no wind on the scene"),0;if("number"==typeof t.wind_dir){var s=We.deg_to_rad(t.wind_dir);qe.set(Math.sin(s),-Math.cos(s),0,nt),We.dir_to_quat(nt,We.AXIS_Z,_t),Ye.set_rotation(_,_t)}"number"==typeof t.wind_strength&&(_.field.strength=t.wind_strength),i(_)},t.remove_object=function(e){xe.check_constraint(e)&&xe.remove(e),le(e)},t.objects_storage_add=ie,t.objects_storage_check=function(e){return $e[e.type]&&$e[e.type].indexOf(e)>-1},t.update_lod_scene=function(e,t){e.render.is_lod&&fe(e,t)},t.update_lod_visibility=de,t.set_hair_particles_wind_bend_params=function(e){for(var t=e.render,r=t.wind_bending_amp,a=t.wind_bending_freq,n=t.detail_bending_freq,_=t.detail_bending_amp,s=t.branch_bending_amp,o=e.scenes_data,i=0;i<o.length;i++)for(var l=o[i].batches,c=0;c<l.length;c++){var u=l[c].bufs_data,d=u.pointers,f=d.au_wind_bending_amp,m=d.au_wind_bending_freq,p=d.au_detail_bending_amp,h=d.au_detail_bending_freq,v=d.au_branch_bending_amp;if(m&&(b=Array.apply(null,Array(m.length)).map(function(){return a}),Re.update_gl_buffer_sub_data(u,Re.VBO_FLOAT,new Float32Array(b),m.offset)),f&&(b=Array.apply(null,Array(f.length)).map(function(){return r}),Re.update_gl_buffer_sub_data(u,Re.VBO_FLOAT,new Float32Array(b),f.offset)),p&&(b=Array.apply(null,Array(p.length)).map(function(){return _}),Re.update_gl_buffer_sub_data(u,Re.VBO_FLOAT,new Float32Array(b),p.offset)),h&&(b=Array.apply(null,Array(h.length)).map(function(){return n}),Re.update_gl_buffer_sub_data(u,Re.VBO_FLOAT,new Float32Array(b),h.offset)),v){var b=Array.apply(null,Array(v.length)).map(function(){return s});Re.update_gl_buffer_sub_data(u,Re.VBO_FLOAT,new Float32Array(b),v.offset)}}},t.inherit_material=function(e,t,r,a){if(e.render.dynamic_geometry&&r.render.dynamic_geometry){var n=Ee.find_batch_material(e,t,"MAIN"),_=null;Ee.iterate_batches_by_mat(r,a,function(e){_||(_={}),e.particles_data&&(_[e.particles_data.name]=e.particles_data)},"PARTICLES");for(var s=me(r,a),o=he(e,t,r,a),i=Fe.get_active(),l=0;l<r.scenes_data.length;l++){var c=r.scenes_data[l].scene;Fe.set_active(c);var u=X(c,"LAMP",0),d=r.scenes_data[l].batches;r.scenes_data[l].batches=[],r.scenes_data[l].batch_world_bounds=[],Ee.generate_main_batches(c,[r._bpy_obj],u,[]),Ee.create_forked_batches(r,Fe.get_graph(c),c),Fe.assign_scene_data_subs(c,[r]),Fe.append_object(c,r,!1,!0);for(var f=0;f<d.length;f++)Se.append_batch(r,c,d[f])}ve(e,t,r,o),pe(r,s),be(r,a,e,_,n),Fe.set_active(i)}},t.create_line=function(e){e=e||"",e+=U(e);var t=Se.create_object(e,"LINE");return t.render=Se.create_render("EMPTY"),t.is_dynamic=!0,Ee.generate_line_batches(Fe.get_main(),[t]),Fe.append_object(Fe.get_main(),t),ie(t),t},t.generate_mesh_render_boundings=function(e,t){var r=t.render,a=we.clone_bb(r.bb_original);r.billboard?Se.update_render_bounds_billboard(t,a):Se.update_render_bounds_from_bpy(t,a,e.data.b4w_boundings)},t.set_nodemat_value=function(e,t,r,a){for(var n=Se.is_world(e),_=0;_<e.scenes_data.length;_++)for(var s=e.scenes_data[_].batches,o=0;o<s.length;o++){var i=s[o];(n||-1!=i.material_names.indexOf(t))&&(i.node_values[r]=a)}n&&Fe.update_sky_texture(e)},t.set_nodemat_rgb=function(e,t,r,a,n,_){for(var s=Se.is_world(e),o=0;o<e.scenes_data.length;o++)for(var i=e.scenes_data[o].batches,l=0;l<i.length;l++){var c=i[l];(s||-1!=c.material_names.indexOf(t))&&(c.node_rgbs[3*r]=a,c.node_rgbs[3*r+1]=n,c.node_rgbs[3*r+2]=_)}s&&Fe.update_sky_texture(e)},t.get_nodemat_value=function(e,t){return e.node_values[t]},t.get_nodemat_rgb=function(e,t,r){return r[0]=e.node_rgbs[3*t],r[1]=e.node_rgbs[3*t+1],r[2]=e.node_rgbs[3*t+2],r},t.get_node_val_ind_by_name_list=function(e,t,r){for(var a=ge(t,r),n=0;n<e.length;n+=3)if(e[n]==a)return 4*e[n+1]+e[n+2];return null},t.get_node_rgb_ind_by_name_list=function(e,t,r){for(var a=ge(t,r),n=0;n<e.length;n+=2)if(e[n]==a)return e[n+1];return null}}),ee=o("__textures",function(e,t){function r(){return Le||(Le=Be.createFramebuffer()),Le}function a(){return Se||(Se=Be.createTexture()),Se}function n(){return{type:0,source:"",source_id:"",width:0,height:0,compress_ratio:1,anisotropic_filtering:0,source_size:1024,enable_canvas_mipmapping:!1,canvas_context:null,w_target:0,w_texture:null,w_renderbuffer:null,is_movie:!1,vtex_data_id:-1,video_file:null,video_tex_name:"",movie_length:0,fps:0,frame_start:0,frame_offset:0,frame_duration:0,need_resize:!1,scale_fac:1,use_mipmap:!1,mipmap_count:0,seq_video:null,seq_movie_length:0,seq_fps:0,seq_cur_frame:-1,seq_video_played:!1,seq_last_discrete_mark:-1,video_was_stopped:!1,use_auto_refresh:!1,use_cyclic:!1,use_nla:!1,repeat:!0,img_full_filepath:"",img_filepath:"",img_uuid:"",img_source:"",img_name:"",img_comp_method:""}}function _(e,t,r){e.img_uuid=t.uuid,e.img_filepath=t.filepath,e.img_source=t.source,e.img_name=t.name,e.img_full_filepath=Ee.normpath_preserve_protocol(r+t.filepath),e.img_comp_method=t._comp_method,-1==Pe.textures.indexOf(e)&&(Pe.textures.push(e),Pe.loaded_status.push(!1))}function s(e){var t=n();return t.type=e.type,t.anisotropic_filtering=e.anisotropic_filtering,t.source=e.source,t.source_id=e.source_id,t.width=e.width,t.height=e.height,t.compress_ratio=e.compress_ratio,t.source_size=e.source_size,t.enable_canvas_mipmapping=e.enable_canvas_mipmapping,t.canvas_context=e.canvas_context,t.w_target=e.w_target,t.w_texture=e.w_texture,t.w_renderbuffer=e.w_renderbuffer,t.is_movie=e.is_movie,t.vtex_data_id=e.vtex_data_id,t.video_file=e.video_file,t.video_tex_name=e.video_tex_name,t.movie_length=e.movie_length,t.fps=e.fps,t.frame_start=e.frame_start,t.frame_offset=e.frame_offset,t.frame_duration=e.frame_duration,t.need_resize=e.need_resize,t.scale_fac=e.scale_fac,t.seq_video=e.seq_video,t.seq_movie_length=e.seq_movie_length,t.seq_fps=e.seq_fps,t.seq_cur_frame=e.seq_cur_frame,t.seq_video_played=e.seq_video_played,t.seq_last_discrete_mark=e.seq_last_discrete_mark,t.video_was_stopped=e.video_was_stopped,t.use_auto_refresh=e.use_auto_refresh,t.use_cyclic=e.use_cyclic,t.use_nla=e.use_nla,t.repeat=e.repeat,t.img_filepath=e.img_filepath,t.img_full_filepath=e.img_full_filepath,t.img_uuid=e.img_uuid,t.img_source=e.img_source,t.img_name=e.img_name,t.img_comp_method=e.img_comp_method,t}function o(e,t,r){var a=t.indexOf(".dds")>-1,n=t.indexOf(".pvr")>-1;e.img_comp_method=a?"dds":n?"pvr":"",e.img_filepath=t,e.img_full_filepath=r,e.img_uuid=Ee.gen_uuid(),Pe.textures.push(e),Pe.loaded_status.push(!0)}function i(e,t){Be.bindTexture(e.w_target,e.w_texture);var r=Be.getTexParameter(e.w_target,Be.TEXTURE_MAG_FILTER),a=Be.getTexParameter(e.w_target,Be.TEXTURE_MIN_FILTER),n=Be.getTexParameter(e.w_target,Be.TEXTURE_WRAP_S),_=Be.getTexParameter(e.w_target,Be.TEXTURE_WRAP_T);t.w_texture=Be.createTexture(),Be.bindTexture(t.w_target,t.w_texture),Be.texParameteri(t.w_target,Be.TEXTURE_MAG_FILTER,r),Be.texParameteri(t.w_target,Be.TEXTURE_MIN_FILTER,a),Be.texParameteri(t.w_target,Be.TEXTURE_WRAP_S,n),Be.texParameteri(t.w_target,Be.TEXTURE_WRAP_T,_),Be.bindTexture(t.w_target,null)}function c(e,r,a){var _=n();if(_.type=e,_.source="NONE",_.use_mipmap=a,e==t.TT_RB_RGBA||e==t.TT_RB_DEPTH||e==t.TT_RB_RGBA_MS||e==t.TT_RB_DEPTH_MS)_.w_renderbuffer=Be.createRenderbuffer();else{var s=Be.TEXTURE_2D,o=Be.createTexture();Be.bindTexture(s,o),Be.texParameteri(s,Be.TEXTURE_MAG_FILTER,Be.LINEAR),a?Be.texParameteri(s,Be.TEXTURE_MIN_FILTER,Ce[ke.texture_min_filter]):Be.texParameteri(s,Be.TEXTURE_MIN_FILTER,Be.LINEAR),Be.texParameteri(s,Be.TEXTURE_WRAP_S,Be.CLAMP_TO_EDGE),Be.texParameteri(s,Be.TEXTURE_WRAP_T,Be.CLAMP_TO_EDGE);var i=C(_),l=P(_),c=U(_);if(e==t.TT_DEPTH)u=null;else var u=new Uint8Array([204,204,204,255]);Be.texImage2D(s,0,l,1,1,0,i,c,u),ke.compared_mode_depth&&r&&Be.texParameterf(s,Be.TEXTURE_COMPARE_MODE,Be.COMPARE_REF_TO_TEXTURE),Be.bindTexture(s,null),_.w_target=s,_.w_texture=o}return _}function u(e,t,r){if(ke.anisotropic_available){var a=t.b4w_anisotropic_filtering;if("DEFAULT"===a&&(a=r),"OFF"!==a&&ke.anisotropic_filtering){var n=parseFloat(a.split("x")[0]);e.anisotropic_filtering=n}}}function d(e,t){("REPEAT"!=t.extension||t.b4w_shore_dist_map)&&(e.repeat=!1)}function f(e,t){e.is_movie=!0,e.video_tex_name=t.name,e.frame_start=t.frame_start,e.frame_offset=t.frame_offset,e.frame_duration=t.frame_duration,e.use_auto_refresh=t.use_auto_refresh,e.use_cyclic=t.use_cyclic,e.movie_length=t.movie_length,e.use_nla=t.b4w_nla_video,0!=e.frame_offset&&ge.warn('Frame offset for texture "'+t.name+'" has a nonzero value. Can lead to undefined behaviour for mobile devices.')}function p(e,t,r){var a=t.b4w_source_id,n=t.b4w_source_size;e.source_id=a,e.enable_canvas_mipmapping=t.b4w_enable_canvas_mipmapping;var _=document.createElement("canvas");_.width=n,_.height=n,e.canvas_context=_.getContext("2d"),r in De||(De[r]={}),De[r][a]=e}function v(e){var t=e.w_texture,r=e.w_target;Be.bindTexture(r,t);var a=C(e),n=P(e),_=U(e),s=e.canvas_context.canvas;Be.pixelStorei(Be.UNPACK_FLIP_Y_WEBGL,!0),Be.texImage2D(r,0,n,a,_,s),Be.pixelStorei(Be.UNPACK_FLIP_Y_WEBGL,!1),e.enable_canvas_mipmapping&&Be.generateMipmap(r),Be.bindTexture(r,null),e.width=s.width,e.height=s.height}function b(e){var t=e.w_texture,r=e.w_target;Be.bindTexture(r,t),Be.pixelStorei(Be.UNPACK_FLIP_Y_WEBGL,!0),4!=e.video_file.length?e.need_resize?A(e,e.video_file,e.width*e.scale_fac,e.height*e.scale_fac,!1):Be.texImage2D(r,0,Be.RGBA,Be.RGBA,Be.UNSIGNED_BYTE,e.video_file):Be.texImage2D(r,0,Be.RGBA,1,1,0,Be.RGBA,Be.UNSIGNED_BYTE,e.video_file),Be.bindTexture(r,null)}function E(e){var t=e.w_texture,r=e.w_target;Be.bindTexture(r,t),Be.pixelStorei(Be.UNPACK_FLIP_Y_WEBGL,!0),e.need_resize?A(e,e.seq_video[e.seq_cur_frame],e.width*e.scale_fac,e.height*e.scale_fac,!1):Be.texImage2D(r,0,Be.RGBA,Be.RGBA,Be.UNSIGNED_BYTE,e.seq_video[e.seq_cur_frame]),Be.bindTexture(r,null)}function w(){return Ie||(Ie=document.createElement("canvas")),Ie}function A(e,t,n,_,s){s||(N(Be.TEXTURE_2D),Be.texImage2D(Be.TEXTURE_2D,0,Be.RGBA,Be.RGBA,Be.UNSIGNED_BYTE,t)),Be.bindTexture(Be.TEXTURE_2D,null);var o=r(),i=a();we.draw_resized_texture(e,n,_,o,i,"NONE")}function O(e,t,n,_){for(N(Be.TEXTURE_2D),Be.texImage2D(Be.TEXTURE_2D,0,Be.RGBA,Be.RGBA,Be.UNSIGNED_BYTE,t),Be.bindTexture(Be.TEXTURE_2D,null),i=0;i<6;i++)Be.texImage2D(Be.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,Be.RGBA,n,n,0,Be.RGBA,Be.UNSIGNED_BYTE,null);Be.bindTexture(e.w_target,null);var s=r();Be.bindFramebuffer(Be.FRAMEBUFFER,s);for(var o=a(),i=0;i<6;i++)we.draw_resized_cubemap_texture(e,Be[Ge[i]],n,_,o,i);Be.bindFramebuffer(Be.FRAMEBUFFER,null),Be.bindTexture(e.w_target,e.w_texture),Be.texParameteri(e.w_target,Be.TEXTURE_MIN_FILTER,Ce[ke.texture_min_filter]),Be.texParameteri(e.w_target,Be.TEXTURE_MAG_FILTER,Be.LINEAR)}function R(e,t,r,a){for(var n=0;n<6;n++){var _=Ge[n],s=je[n],o=w();o.width=a,o.height=a;var i=o.getContext("2d");i.translate(a/2,a/2),"TEXTURE_CUBE_MAP_POSITIVE_X"==_?(i.rotate(Math.PI/2),i.scale(1,-1)):"TEXTURE_CUBE_MAP_NEGATIVE_X"==_?(i.rotate(Math.PI/2),i.scale(-1,1)):"TEXTURE_CUBE_MAP_POSITIVE_Y"==_||"TEXTURE_CUBE_MAP_POSITIVE_Z"==_?i.scale(1,-1):"TEXTURE_CUBE_MAP_NEGATIVE_Y"!=_&&"TEXTURE_CUBE_MAP_NEGATIVE_Z"!=_||i.scale(-1,1),i.drawImage(t,s[0]*r,s[1]*r,r,r,-a/2,-a/2,a,a),ke.d3d9_canvas_resizing_hack?Be.texImage2D(Be[_],0,Be.RGBA,a,a,0,Be.RGBA,Be.UNSIGNED_BYTE,new Uint8Array(i.getImageData(0,0,a,a).data.buffer)):Be.texImage2D(Be[_],0,Be.RGBA,Be.RGBA,Be.UNSIGNED_BYTE,o)}}function N(e){Be.bindTexture(e,null);var t=a();Be.bindTexture(e,t),S(e)}function M(e,t,r){var a=e.source,n=e.w_texture,_=e.w_target,s=e.img_comp_method,o=e.img_filepath,i=1,l=1;if(Be.bindTexture(_,n),e.repeat?(Be.texParameteri(_,Be.TEXTURE_WRAP_S,Be.REPEAT),Be.texParameteri(_,Be.TEXTURE_WRAP_T,Be.REPEAT)):(Be.texParameteri(_,Be.TEXTURE_WRAP_S,Be.CLAMP_TO_EDGE),Be.texParameteri(_,Be.TEXTURE_WRAP_T,Be.CLAMP_TO_EDGE)),e.is_movie||"NODE_TEX"==a?Be.texParameteri(_,Be.TEXTURE_MIN_FILTER,Be.LINEAR):Be.texParameteri(_,Be.TEXTURE_MIN_FILTER,Ce[ke.texture_min_filter]),e.anisotropic_filtering&&Be.texParameterf(_,be.get_aniso().TEXTURE_MAX_ANISOTROPY_EXT,e.anisotropic_filtering),4==t.length){var c=!0;t=new Uint8Array([255*t[0],255*t[1],255*t[2],255*t[3]])}if("IMAGE"==a)if(c)Be.texImage2D(_,0,Be.RGBA,1,1,0,Be.RGBA,Be.UNSIGNED_BYTE,t),e.width=1,e.height=1;else if(s){var u=he.get_width_height(t,s),d=Ee.check_npot(u.width)||Ee.check_npot(u.height);if(B(u.width,u.height))return void ge.error('Image "'+o+'" has unsupported size: '+u.width+"x"+u.height+". Max available: "+Ne.max_texture_size+"x"+Ne.max_texture_size+".");i=u.width,l=u.height,(d||"pvr"==s)&&(e.need_resize=!0,N(_),i=L(i*e.scale_fac),l=L(l*e.scale_fac)),"dds"==s?he.upload_dds_levels(Be,be.get_s3tc(),t,!0):"pvr"==s&&he.upload_pvr_levels(Be,be.get_pvr(),t,!0),e.need_resize&&(A(e,null,i,l,!0),Be.bindTexture(_,n),Be.generateMipmap(_)),e.width=i,e.height=l,e.compress_ratio=he.get_compress_ratio(t,s)}else{if(Be.pixelStorei(Be.UNPACK_FLIP_Y_WEBGL,!0),e.is_movie?ke.seq_video_fallback?(i=t[0].width,l=t[0].height):(i=t.videoWidth,l=t.videoHeight):(i=t.width,l=t.height),e.width=i,e.height=l,B(i,l)&&(ge.warn('Image "'+o+'" has unsupported size: '+i+"x"+l+". Max available: "+Ne.max_texture_size+"x"+Ne.max_texture_size+". Reduced image size will be used."),e.scale_fac=Math.min(Ne.max_texture_size/i,Ne.max_texture_size/l),e.need_resize=!0),e.is_movie)r in Ue||(Ue[r]={}),Ue[r][e.video_tex_name]=e,ke.seq_video_fallback?(e.seq_video=t,e.seq_movie_length=t.length,e.fps=e.seq_fps*e.movie_length/t.length,f=t[0]):(e.video_file=t,e.video_file.loop=e.use_cyclic,e.fps=t.duration?e.movie_length/t.duration:ye.get_framerate(),Me.disable_playback_rate_hack||(t.playbackRate=ye.get_framerate()/e.fps,Me.clamp_playback_rate_hack&&t.playbackRate>Fe&&(t.playbackRate=Fe)),f=t,I(e));else var f=t;if(i=L(e.width*e.scale_fac),l=L(e.height*e.scale_fac),e.need_resize||ke.resize_texture_canvas_hack){var m=w(),p=m.getContext("2d");m.width=i,m.height=l,p.drawImage(f,0,0,e.width,e.height,0,0,i,l),ke.d3d9_canvas_resizing_hack?Be.texImage2D(_,0,Be.RGBA,i,l,0,Be.RGBA,Be.UNSIGNED_BYTE,new Uint8Array(p.getImageData(0,0,i,l).data.buffer)):Be.texImage2D(_,0,Be.RGBA,Be.RGBA,Be.UNSIGNED_BYTE,m)}else ke.webgl2||!Ee.check_npot(e.width)&&!Ee.check_npot(e.height)?Be.texImage2D(_,0,Be.RGBA,Be.RGBA,Be.UNSIGNED_BYTE,f):(A(e,f,i,l,!1),e.need_resize=!0);e.width=i,e.height=l,e.is_movie||(Be.bindTexture(_,n),Be.generateMipmap(_))}else if("ENVIRONMENT_MAP"==a)if(c){for(var h=0;h<6;h++){var v=Ge[h];Be.texImage2D(Be["TEXTURE_CUBE_MAP_"+v],0,Be.RGBA,1,1,0,Be.RGBA,Be.UNSIGNED_BYTE,t)}e.width=3,e.height=2}else{if(Be.pixelStorei(Be.UNPACK_FLIP_Y_WEBGL,!1),t.width%3||t.height%2)return void ge.error('Cubemap Image "'+o+'" has unsupported size: '+t.width+"x"+t.height+". The width must be multiple of three and the height - multiple of two.");var b=t.width/3;if(G(b))ge.warn('Cubemap Image "'+o+'" has unsupported size: '+t.width+"x"+t.height+". Max available: "+3*Ne.max_cube_map_texture_size+"x"+2*Ne.max_cube_map_texture_size+". Reduced image size will be used."),g=L(b*(Ne.max_cube_map_texture_size/b)),e.need_resize=!0;else{var g=L(b);!ke.webgl2&&B(3*g,2*g)&&(e.need_resize=!0)}e.need_resize||ke.resize_cubemap_canvas_hack?R(e,t,b,g):O(e,t,g,b),ve.check_ff_cubemap_out_of_memory()&&(ge.warn("Firefox detected, setting max cubemap size to 256, use canvas for resizing."),R(e,t,b,me.NVIDIA_OLD_GPU_CUBEMAP_MAX_SIZE)),e.width=3*g,e.height=2*g,Be.generateMipmap(_)}else"NODE_TEX"==a&&(Be.pixelStorei(Be.UNPACK_FLIP_Y_WEBGL,!1),Be.texImage2D(_,0,Be.RGBA,t.width,t.height,0,Be.RGBA,Be.UNSIGNED_BYTE,t.data),e.width=t.width,e.height=t.height);Be.bindTexture(_,null)}function I(e){e.video_file.oncanplay=function(){V(e)&&b(e)}}function S(e){Be.texParameteri(e,Be.TEXTURE_WRAP_S,Be.CLAMP_TO_EDGE),Be.texParameteri(e,Be.TEXTURE_WRAP_T,Be.CLAMP_TO_EDGE),Be.texParameteri(e,Be.TEXTURE_MAG_FILTER,Be.LINEAR),Be.texParameteri(e,Be.TEXTURE_MIN_FILTER,Be.LINEAR)}function L(e){if(Ee.check_npot(e)){var t=Math.pow(2,(0|e).toString(2).length);return Ee.clamp(t,2,Ne.max_texture_size)}return e}function C(e){var r;switch(e.type){case t.TT_RGBA_INT:r=Be.RGBA;break;case t.TT_RGB_INT:r=Be.RGB;break;case t.TT_RGBA_FLOAT:r=Be.RGBA;break;case t.TT_RGB_FLOAT:r=Be.RGB;break;case t.TT_DEPTH:r=Be.DEPTH_COMPONENT;break;default:Ee.panic("Wrong texture type")}return r}function P(e){var r;switch(e.type){case t.TT_RGBA_INT:r=ke.webgl2?Be.RGBA8:Be.RGBA;break;case t.TT_RGB_INT:r=ke.webgl2?Be.RGB8:Be.RGB;break;case t.TT_RGBA_FLOAT:r=ke.webgl2?Be.RGBA8:Be.RGBA;break;case t.TT_RGB_FLOAT:r=ke.webgl2?Be.RGB8:Be.RGB;break;case t.TT_DEPTH:r=ke.webgl2?D(Ne.depth_bits):Be.DEPTH_COMPONENT;break;default:Ee.panic("Wrong texture type")}return r}function D(e){var t;switch(e){case 16:t=Be.DEPTH_COMPONENT16;break;case 24:t=Be.DEPTH_COMPONENT24;break;case 32:t=Be.DEPTH_COMPONENT32F;break;default:t=Be.DEPTH_COMPONENT24}return t}function U(e){var r;switch(e.type){case t.TT_RGBA_INT:case t.TT_RGB_INT:r=Be.UNSIGNED_BYTE;break;case t.TT_RGBA_FLOAT:case t.TT_RGB_FLOAT:r=Be.FLOAT;break;case t.TT_DEPTH:r=Be.UNSIGNED_INT;break;default:Ee.panic("Wrong texture type")}return r}function F(e){e.w_texture&&Be.deleteTexture(e.w_texture);var t=Pe.textures.indexOf(e);-1!=t&&(Pe.textures.splice(t,1),Pe.loaded_status.splice(t,1))}function B(e,t){return e>Ne.max_texture_size||t>Ne.max_texture_size}function G(e){return e>Ne.max_cube_map_texture_size}function z(e){e.video_file?e.video_file.play():e.seq_video&&(e.seq_video_played=!0),e.video_was_stopped=!1}function Y(e){e.video_file?e.video_file.pause():e.seq_video&&(e.seq_video_played=!1),e.video_was_stopped=!0}function H(e){e.video_file?e.video_file.currentTime=e.frame_offset/e.fps:e.seq_video&&(e.seq_cur_frame=X(e,e.frame_offset),E(e))}function W(e){return e.video_file?!e.video_file.paused:!!e.seq_video&&e.seq_video_played}function V(e){return e.video_file||e.seq_video?!e.video_file||e.video_file.readyState>=2:0}function X(e,t){return Math.round(t*e.seq_movie_length/e.movie_length)}function K(e,t){if(Te.is_dynamic(e))return Q(e,t);for(var r=e.meta_objects,a=0;a<r.length;a++){var n=Q(r[a],t);if(n)return n}return null}function Z(e,t,r){if(Te.is_dynamic(e))J(e,t,r);else for(var a=e.meta_objects,n=0;n<a.length;n++)J(a[n],t,r)}function Q(e,t){var r=e.scenes_data;if(r.length)for(var a=r[0].batches,n=0;n<a.length;n++){var _=a[n];if("MAIN"==_.type||"SKY"==_.type)for(var s=0;s<_.textures.length;s++)if(_.bpy_tex_names[s]==t)return _.textures[s]}return null}function J(e,t,r){var a=e.scenes_data;if(a.length)for(var n=a[0].batches,_=0;_<n.length;_++){var s=n[_];if("MAIN"==s.type)for(var o=0;o<s.textures.length;o++)if(s.bpy_tex_names[o]==t){var i=s.textures[o];s.textures[o]=r,ce(i)}}}function ee(e,t){var r=e.scenes_data;if(r.length)for(var a=r[0].batches,n=0;n<a.length;n++){var _=a[n];if("MAIN"==_.type)for(var s=0;s<_.textures.length;s++){var o=_.textures[s],i=_.bpy_tex_names[s];-1==t.indexOf(i)&&"NODE_TEX"!=o.source&&t.push(i)}}}function ne(e){var t=n();t.source="CANVAS",t.width=e.width,t.height=e.height,t.enable_canvas_mipmapping=e.enable_canvas_mipmapping,t.type=e.type;var r=document.createElement("canvas");return r.width=t.width,r.height=t.height,t.canvas_context=r.getContext("2d"),t.w_target=Be.TEXTURE_2D,t.w_texture=Be.createTexture(),Be.bindTexture(Be.TEXTURE_2D,t.w_texture),t.enable_canvas_mipmapping?Be.texParameteri(Be.TEXTURE_2D,Be.TEXTURE_MIN_FILTER,Ce[ke.texture_min_filter]):Be.texParameteri(Be.TEXTURE_2D,Be.TEXTURE_MIN_FILTER,Be.LINEAR),Be.texParameteri(Be.TEXTURE_2D,Be.TEXTURE_MAG_FILTER,Be.LINEAR),Be.bindTexture(Be.TEXTURE_2D,null),t}function _e(e,t){var r=t.canvas_context;e.canvas_context.drawImage(r.canvas,0,0),v(e)}function se(e,t,r){for(var a=e.elements,n=e.interpolation,_=0;_<t;_++){var s=_/(t-1),o=ie(a,s,!0),i=le(a,s,!0);o&&i&&("CONSTANT"==n?r.push.apply(r,o.color):oe(r,o,i,s)),i&&!o&&r.push.apply(r,i.color),o&&!i&&r.push.apply(r,o.color)}}function oe(e,t,r,a){if(t==r)e.push.apply(e,t.color);else{var n=xe.linear_interpolation(r.color[0],r.position,t.color[0],t.position,a);e.push(n);var _=xe.linear_interpolation(r.color[1],r.position,t.color[1],t.position,a);e.push(_);var s=xe.linear_interpolation(r.color[2],r.position,t.color[2],t.position,a);e.push(s);var o=xe.linear_interpolation(r.color[3],r.position,t.color[3],t.position,a);e.push(o)}}function ie(e,t,r){for(var a=null,n=0;n<e.length;n++){if(r)_=t-e[n].position;else var _=t-e[n][1][0];if(_>=0)if(a){if(r)s=t-a.position;else var s=t-e[n][1][0];_<=s&&(a=e[n])}else a=e[n]}return a}function le(e,t,r){for(var a=null,n=0;n<e.length;n++){if(r)_=e[n].position-t;else var _=e[n][1][0]-t;if(_>=0)if(a){if(r)s=a.position-t;else var s=a[1][0]-t;_<=s&&(a=e[n])}else a=e[n]}return a}function ce(e){ke.enable_texture_cache||ue(e)||F(e)}function ue(e){for(var t=Ae.get_all_objects("ALL",Ae.DATA_ID_ALL),r=0;r<t.length;r++){var a=t[r];if(de(a,e))return!0;for(var n=a.meta_objects,_=0;_<n.length;_++)if(de(n[_],e))return!0}return!1}function de(e,t){for(var r=0;r<e.scenes_data.length;r++)for(var a=e.scenes_data[r].batches,n=0;n<a.length;n++)for(var _=a[n].textures,s=0;s<_.length;s++)if(_[s]==t)return!0}function fe(e,t){for(var r=0;r<Pe.textures.length;r++){var a=Pe.textures[r];if(a.img_full_filepath==e&&a.type==t.type&&a.source==t.source&&a.repeat==t.repeat&&a.anisotropic_filtering==t.anisotropic_filtering&&a.use_nla==t.use_nla)return a}return null}var me=re(e),pe=g(e),he=T(e),ve=ae(e),be=y(e),ge=m(e),ye=x(e),Ee=h(e),we=te(e),Ae=$(e),Te=k(e),xe=q(e),Oe=l(e),Re=j(e),ke=pe.defaults,Ne=pe.context_limits,Me=pe.sfx,Ie=null,Se=null,Le=null;t.TF_NEAREST=0,t.TF_LINEAR=0,t.TF_NEAREST_MIPMAP_NEAREST=0,t.TF_LINEAR_MIPMAP_NEAREST=0,t.TF_NEAREST_MIPMAP_LINEAR=0,t.TF_LINEAR_MIPMAP_LINEAR=0,t.TT_RGBA_INT=10,t.TT_RGB_INT=20,t.TT_RGBA_FLOAT=30,t.TT_RGB_FLOAT=40,t.TT_DEPTH=50,t.TT_RB_RGBA=60,t.TT_RB_DEPTH=70,t.TT_RB_RGBA_MS=80,t.TT_RB_DEPTH_MS=90,t.CURVE_NODES_TEXT_SIZE=128,t.COLORRAMP_TEXT_SIZE=128,t.PART_COLORRAMP_TEXT_SIZE=128;var Ce,Pe={textures:[],loaded_status:[]},De={},Ue={},Fe=2,Be=null,Ge=["TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z"],je=[[2,0],[0,0],[2,1],[1,0],[1,1],[0,1]];t.setup_context=function(e){Ce=[e.NEAREST_MIPMAP_NEAREST,e.NEAREST_MIPMAP_LINEAR,e.LINEAR_MIPMAP_NEAREST,e.LINEAR_MIPMAP_LINEAR],t.TF_NEAREST=e.NEAREST,t.TF_LINEAR=e.LINEAR,t.TF_NEAREST_MIPMAP_NEAREST=e.NEAREST_MIPMAP_NEAREST,t.TF_LINEAR_MIPMAP_NEAREST=e.LINEAR_MIPMAP_NEAREST,t.TF_NEAREST_MIPMAP_LINEAR=e.NEAREST_MIPMAP_LINEAR,t.TF_LINEAR_MIPMAP_LINEAR=e.LINEAR_MIPMAP_LINEAR,Be=e},t.get_canvas_context=function(e,t){return t in De&&e in De[t]?De[t][e].canvas_context:null},t.update_canvas_context=function(e,t){return t in De&&e in De[t]&&(v(De[t][e]),!0)},t.append_img_info=_,t.create_texture=c,t.create_cubemap_texture=function(e,r){var a=Be.createTexture(),_=Be.TEXTURE_CUBE_MAP;Be.bindTexture(_,a),Be.texParameteri(_,Be.TEXTURE_MAG_FILTER,Be.LINEAR),r?Be.texParameteri(_,Be.TEXTURE_MIN_FILTER,Ce[ke.texture_min_filter]):Be.texParameteri(_,Be.TEXTURE_MIN_FILTER,Be.LINEAR),Be.texParameteri(_,Be.TEXTURE_WRAP_S,Be.CLAMP_TO_EDGE),Be.texParameteri(_,Be.TEXTURE_WRAP_T,Be.CLAMP_TO_EDGE);for(var s=0;s<6;s++){var o=Ge[s];Be.texImage2D(Be[o],0,Be.RGBA,e,e,0,Be.RGBA,Be.UNSIGNED_BYTE,null)}Be.bindTexture(_,null);var i=n();return i.type=t.TT_RGBA_INT,i.source="NONE",i.width=3*e,i.height=2*e,i.compress_ratio=1,i.use_mipmap=r,i.w_texture=a,i.w_target=Be.TEXTURE_CUBE_MAP,i},t.set_cubemap_tex_size=function(e,t){var r=e.w_texture,a=e.w_target;Be.bindTexture(a,r);for(var n=0;n<6;n++){var _=Ge[n];Be.texImage2D(Be[_],0,Be.RGBA,t,t,0,Be.RGBA,Be.UNSIGNED_BYTE,null)}Be.bindTexture(a,null),e.width=3*t,e.height=2*t},t.set_filters=function(e,t,r){var a=e.w_target,n=e.w_texture;Be.bindTexture(a,n),t&&Be.texParameteri(a,Be.TEXTURE_MIN_FILTER,t),r&&Be.texParameteri(a,Be.TEXTURE_MAG_FILTER,r),Be.bindTexture(a,null)},t.resize=function(e,r,a){if(r=Math.max(r,1),a=Math.max(a,1),e.width!=r||e.height!=a){switch(e.type){case t.TT_RB_RGBA:Be.bindRenderbuffer(Be.RENDERBUFFER,e.w_renderbuffer),Be.renderbufferStorage(Be.RENDERBUFFER,Be.RGB565,r,a),Be.bindRenderbuffer(Be.RENDERBUFFER,null);break;case t.TT_RB_DEPTH:Be.bindRenderbuffer(Be.RENDERBUFFER,e.w_renderbuffer),Be.renderbufferStorage(Be.RENDERBUFFER,D(Ne.depth_bits),r,a),Be.bindRenderbuffer(Be.RENDERBUFFER,null);break;case t.TT_RB_RGBA_MS:Be.bindRenderbuffer(Be.RENDERBUFFER,e.w_renderbuffer),Be.renderbufferStorageMultisample(Be.RENDERBUFFER,ke.msaa_samples,Be.RGBA8,r,a),Be.bindRenderbuffer(Be.RENDERBUFFER,null);break;case t.TT_RB_DEPTH_MS:Be.bindRenderbuffer(Be.RENDERBUFFER,e.w_renderbuffer),Be.renderbufferStorageMultisample(Be.RENDERBUFFER,ke.msaa_samples,D(Ne.depth_bits),r,a),Be.bindRenderbuffer(Be.RENDERBUFFER,null);break;default:var n=e.w_texture,_=e.w_target;Be.bindTexture(_,n);var s=C(e),o=P(e),i=U(e);if(e.use_mipmap){if(!ke.webgl2){var l=Math.max(r,a);r=L(l),a=L(l)}e.mipmap_count=Math.round(Math.log(Math.max(r,a))/Math.log(2)+.5)}Be.texImage2D(_,0,o,r,a,0,s,i,null),Be.bindTexture(_,null)}B(r,a)?Ee.panic('Slink texture "'+e.type+'" has unsupported size: '+r+"x"+a+". Max available: "+Ne.max_texture_size+"x"+Ne.max_texture_size+"."):(e.width=r,e.height=a)}},t.create_texture_bpy=function(e,r,a,s,o){var i=e.type;if("BLEND"==i)return null;var l=e.image,c=n();if(c.type=t.TT_RGBA_INT,c.width=1,c.height=1,u(c,e,r),d(c,e),l){"IMAGE"==i&&"MOVIE"==l.source&&f(c,e),c.source=i;var m=fe(Ee.normpath_preserve_protocol(o+l.filepath),c);if(m)return m;_(c,l,o)}var h=new Uint8Array([204,204,204,255]);switch(i){case"IMAGE":var b=Be.createTexture(),g=Be.TEXTURE_2D;Be.bindTexture(g,b),Be.texImage2D(g,0,Be.RGBA,1,1,0,Be.RGBA,Be.UNSIGNED_BYTE,h);break;case"NONE":if("NONE"==e.b4w_source_type)return null;var b=Be.createTexture(),g=Be.TEXTURE_2D;if(c.source=e.b4w_source_type,"SCENE"==c.source){if(!e.b4w_source_id)return null;var y=e.b4w_source_id,E=Ee.keysearch("name",y,a);if(!E)return null;c.source_id=e.b4w_source_id,c.source_size=e.b4w_source_size,E._render_to_textures=E._render_to_textures||[],E._render_to_textures.push(c),Be.bindTexture(g,b),Be.texImage2D(g,0,Be.RGBA,1,1,0,Be.RGBA,Be.UNSIGNED_BYTE,h)}else"CANVAS"==c.source&&(p(c,e,s),Be.bindTexture(g,b));break;case"ENVIRONMENT_MAP":var b=Be.createTexture(),g=Be.TEXTURE_CUBE_MAP;Be.bindTexture(g,b);for(var w=["POSITIVE_X","NEGATIVE_X","POSITIVE_Y","NEGATIVE_Y","POSITIVE_Z","NEGATIVE_Z"],A=0;A<6;A++)Be.texImage2D(Be["TEXTURE_CUBE_MAP_"+w[A]],0,Be.RGBA,1,1,0,Be.RGBA,Be.UNSIGNED_BYTE,h);break;default:return ge.error('texture "'+e.name+'" has unsupported type "'+i+'"'),null}return c.w_texture=b,c.w_target=g,"NONE"==i?(c.enable_canvas_mipmapping?Be.texParameteri(g,Be.TEXTURE_MIN_FILTER,Ce[ke.texture_min_filter]):Be.texParameteri(g,Be.TEXTURE_MIN_FILTER,Be.LINEAR),c.anisotropic_filtering&&Be.texParameterf(g,be.get_aniso().TEXTURE_MAX_ANISOTROPY_EXT,c.anisotropic_filtering),"CANVAS"==c.source&&v(c)):(Be.generateMipmap(g),Be.bindTexture(g,null)),c},t.update_texture_canvas=v,t.update_video_texture=b,t.update_seq_video_texture=E,t.update_texture=M,t.calc_pot_size=L,t.is_texture=function(e){return!(!e||!e.w_texture&&!e.w_renderbuffer)},t.is_renderbuffer=function(e){return!(!e||!e.w_renderbuffer)},t.is_float=function(e){return e.type==t.TT_RGBA_FLOAT||e.type==t.TT_RGB_FLOAT},t.get_texture_texel_size=function(e){var r=0;switch(e.type){case t.TT_RGBA_INT:case t.TT_RGB_INT:r=4;break;case t.TT_RGBA_FLOAT:case t.TT_RGB_FLOAT:r=16;break;case t.TT_DEPTH:r=3;break;case t.TT_RB_RGBA:case t.TT_RB_DEPTH:r=2;break;case t.TT_RB_RGBA_MS:r=4*ke.msaa_samples;break;case t.TT_RB_DEPTH_MS:r=3*ke.msaa_samples}return r},t.cleanup=function(){if(!ke.seq_video_fallback)for(var e in Ue)for(var t in Ue[e])Ue[e][t].video_file.pause(),Ue[e][t].video_file.src="",Ue[e][t].video_file.load();Pe.textures.length=0,Pe.loaded_status.length=0,De={},Ue={}},t.pause=function(){for(var e in Ue)for(var t in Ue[e]){var r=Ue[e][t];W(r)&&Y(r)}},t.reset=function(){for(var e in Ue)for(var t in Ue[e])H(Ue[e][t])},t.play=function(e){for(var t in Ue)for(var r in Ue[t]){var a=Ue[t][r];e&&!a.video_was_stopped||z(a)}},t.get_video_texture=function(e,t){return t in Ue&&e in Ue[t]?Ue[t][e]:null},t.video_allow_nla=function(e){return e.use_nla},t.play_video=z,t.pause_video=Y,t.reset_video=H,t.set_frame_video=function(e,t,r){if(r in Ue&&e in Ue[r]){var a=Ue[r][e];return a.video_file?a.video_file.currentTime=t/a.fps:a.seq_video&&(a.seq_cur_frame=t,E(a)),!0}return!1},t.video_is_played=W,t.video_update_is_available=V,t.video_get_current_frame=function(e){return e.video_file||e.seq_video?e.video_file?Math.round(e.video_file.currentTime*e.fps):e.seq_cur_frame:0},t.video_get_start_frame=function(e){return e.video_file||e.seq_video?e.video_file?e.frame_offset:X(e,e.frame_offset):0},t.video_get_end_frame=function(e){if(!e.video_file&&!e.seq_video)return 0;var t=Math.min(e.frame_duration,e.movie_length-e.frame_offset);return e.video_file?e.frame_offset+t:X(e,e.frame_offset+t)},t.seq_video_get_discrete_timemark=function(e,t){return Math.round(t*e.seq_fps*(ye.get_framerate()/e.fps))},t.video_get_duration=function(e){return Math.min(e.frame_duration,e.movie_length-e.frame_offset)},t.video_frame_to_seq_frame=X,t.get_canvas_context_by_object=function(e,t){var r=K(e,t);return r&&"CANVAS"==r.source?r.canvas_context:null},t.get_texture_by_name=K,t.set_texture_by_name=Z,t.get_texture_names=function(e){var t=[];if(Te.is_dynamic(e))ee(e,t);else for(var r=e.meta_objects,a=0;a<r.length;a++)ee(r[a],t);return t},t.share_batch_canvas_textures=function(e){for(var t={},r=0;r<e.length;r++){for(var a=e[r].textures,n=e[r].texture_names,_=[],s=[],o=0;o<a.length;o++){var i=a[o],l=n[o];"CANVAS"==i.source&&(l in t?i=t[l]:(_e(i=ne(a[o]),a[o]),t[l]=i)),_.push(i),s.push(l)}e[r].textures=_}},t.extract_col_ramps_data=function(e,t){for(var r=[],a=0;a<e.length;a++)se(e[a].data.value.color_ramp,t,r);return new Uint8Array(r.map(function(e){return Ee.clamp(255*e,0,255)}))},t.calc_color_ramp_data=se,t.extract_vec_curves_data=function(e,t){for(var r=new Float32Array(3),a=new Float32Array(3),n=[],_=0;_<e.length;_++){for(var s=e[_].data.value,o=[],i=s.curve_mapping.curves_data,l=s.curve_mapping.curve_extend,c=s.curve_mapping.curves_handle_types,u=0;u<i.length;u++){for(var d=l[u],f=i[u],m=[],p=c[u],h=0;h<f.length;h++)m.push([new Float32Array(3),new Float32Array(f[h].concat(0)),new Float32Array(3)]);for(xe.calchandle_curvemap(m[0],null,m[1],p[0],p[0]),h=1;h<m.length-1;h++)xe.calchandle_curvemap(m[h],m[h-1],m[h+1],p[h],p[h]);if(xe.calchandle_curvemap(m[m.length-1],m[m.length-2],null,p[m.length-1],p[m.length-1]),m.length>2&&("AUTO"==p[0]&&(Oe.subtract(m[0][2],m[0][1],r),v=Oe.length(r),Oe.copy(m[1][0],a),a[0]<m[0][1][0]&&(a[0]=m[0][1][0]),Oe.subtract(a,m[0][1],a),(b=Oe.length(a))>1e-8&&(Oe.scale(a,v/b,a),Oe.add(m[0][1],a,m[0][2]),Oe.subtract(m[0][1],a,m[0][0]))),M=m.length-1,"AUTO"==p[0])){Oe.subtract(m[M][0],m[M][1],r);var v=Oe.length(r);Oe.copy(m[M-1][2],a),a[0]>m[M][1][0]&&(a[0]=m[M][1][0]),Oe.subtract(a,m[M][1],a);var b=Oe.length(a);b>1e-8&&(Oe.scale(a,v/b,a),Oe.add(m[M][1],a,m[M][0]),Oe.subtract(m[M][1],a,m[M][2]))}for(M=0;M<m.length-1;M++)xe.correct_bezpart(m[M][1],m[M][2],m[M+1][0],m[M+1][1]);var g=[];if(i.length<=3)var y=Math.round(-t/2),E=Math.round(t/2);else var y=0,E=t;for(h=y;h<E;h++){var w=h/(E-1),A=ie(m,w,!1),T=le(m,w,!1);if(A&&T)g.push(xe.bezier(w,A[1],A[2],T[0],T[1],.001));else if(T&&!A)"EXTRAPOLATED"==d?(x=T[1][0]==T[2][0]?T[1][1]:xe.linear(w,T[1],T[2]),g.push(x)):g.push(T[1][1]);else if(A&&!T)if("EXTRAPOLATED"==d){var x=A[0][0]==A[1][0]?A[1][1]:xe.linear(w,A[0],A[1]);g.push(x)}else g.push(A[1][1])}o.push(g)}n.push(o)}for(var O=[],h=0;h<n.length;h++)for(var o=n[h],u=0;u<o[0].length;u++){if(o.length<=3)var R=Ee.clamp(127.5*(o[0][u]+1),0,255),k=Ee.clamp(127.5*(o[1][u]+1),0,255),N=Ee.clamp(127.5*(o[2][u]+1),0,255),M=255;else var R=Ee.clamp(255*o[0][u],0,255),k=Ee.clamp(255*o[1][u],0,255),N=Ee.clamp(255*o[2][u],0,255),M=Ee.clamp(255*o[3][u],0,255);O.push(R,k,N,M)}return new Uint8Array(O)},t.create_color_ramp_texture=function(e,r){var a=c(t.TT_RGBA_INT,!1);return a.source="NODE_TEX",a.repeat=!1,M(a,{width:r,height:e.length/(4*r),data:e}),a},t.change_image=function(e,t,r,a,n){var _=Ee.normpath_preserve_protocol(n);if("WORLD"!=e.type){var l=fe(_,t);if(l)var c=l;else i(t,c=s(t)),o(c,n,_),M(c,a,0);Z(e,r,c)}else o(c=t,n,_),M(c,a,0),Re.update_cube_sky_dim(e,c),Re.update_sky_texture(e)},t.cleanup_unused=ce,t.get_batch_texture=function(e){return e.texture._render},t.reset_mod=function(){Be=null},t.get_img_textures=function(){return Pe.textures},t.get_cache_loaded_status=function(e){var t=Pe.textures.indexOf(e);return-1!=t&&Pe.loaded_status[t]},t.set_cache_loaded_status=function(e,t){var r=Pe.textures.indexOf(e);-1!=r&&(Pe.loaded_status[r]=t)}}),te=o("__renderer",function(e,t){function r(e){for(var t=e.camera,r=t.color_attachment.w_texture,a=0;a<6;a++){var n=b(a);t.view_matrix=e.cube_view_matrices[a],P.from_mat4(t.view_matrix,t.view_tsr),R.calc_sky_vp_inverse(t),K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,n,r,0),i(e);for(var s=e.draw_data,o=0;o<s.length;o++)for(var l=0;l<s[o].bundles.length;l++){var c=s[o].bundles[l];c.do_render=c.do_render_cube[a]}_(e)}}function a(e){var t=e.camera;K.bindFramebuffer(K.READ_FRAMEBUFFER,t.framebuffer_prev),K.bindFramebuffer(K.DRAW_FRAMEBUFFER,t.framebuffer);var r=0;t.color_attachment&&(r|=K.COLOR_BUFFER_BIT),t.depth_attachment&&(r|=K.DEPTH_BUFFER_BIT),K.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,r,K.NEAREST)}function n(e){var t=e.camera;K.bindFramebuffer(K.FRAMEBUFFER,t.framebuffer_prev);var r=t.color_attachment.w_texture;K.bindTexture(K.TEXTURE_2D,r),K.copyTexSubImage2D(K.TEXTURE_2D,0,0,0,0,0,t.width,t.height,0)}function _(e){for(var t=e.camera,r=e.draw_data,a=null,n=P.get_trans(t.world_tsr,re),_=0;_<r.length;_++){var o=r[_];if(o.do_render){var i=o.shader,l=o.bundles;i.program!=a&&(K.useProgram(i.program),s(e,t,i),a=i.program),o.alpha_antialiasing?(K.enable(K.SAMPLE_ALPHA_TO_COVERAGE),e.blend||K.enable(K.BLEND)):(K.disable(K.SAMPLE_ALPHA_TO_COVERAGE),e.blend||K.disable(K.BLEND));for(var d=0;d<l.length;d++){var f=l[d];if(f.do_render){var m=f.obj_render,p=f.batch;N.render_time_start_batch(p),N.is_debug_view_render_time_mode()&&"DEBUG_VIEW"==p.type&&(p.debug_main_batch_render_time=D.smooth(O.batch_get_debug_storage(p.debug_main_batch_id),p.debug_main_batch_render_time,1,X)),oe.alpha_sort&&p.z_sort&&u(p,m,f.info_for_z_sort_updates,n),c(e,m,p,i),N.render_time_stop_batch(p),N.is_debug_view_render_time_mode()&&"MAIN"==p.type&&O.batch_set_debug_storage(p.id,p.debug_render_time)}}}}}function s(e,t,r){for(var a=r.transient_sc_uniform_setters,n=a.length;n--;)(o=a[n]).fun(K,o.loc,e,t);if(r.need_uniforms_update&&!r.no_permanent_uniforms){r.permanent_sc_uniform_setters.length||T(r);for(var _=r.permanent_sc_uniform_setters,s=_.length;s--;){var o=_[s];o.fun(K,o.loc,e,t)}}}function o(e){var t=e.camera;if(K.bindFramebuffer(K.FRAMEBUFFER,t.framebuffer),e.assign_texture){var r=t.color_attachment;K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,r.w_target,r.w_texture,0)}switch(K.viewport(0,0,t.width,t.height),e.type!=L.MAIN_CUBE_REFLECT&&e.type!=L.MAIN_CUBE_REFLECT_BLEND&&i(e),e.blend?K.enable(K.BLEND):K.disable(K.BLEND),e.depth_test?K.enable(K.DEPTH_TEST):K.disable(K.DEPTH_TEST),e.type){case L.SHADOW_CAST:K.enable(K.POLYGON_OFFSET_FILL),K.polygonOffset(e.self_shadow_polygon_offset,e.self_shadow_polygon_offset),K.cullFace(K.BACK);break;case L.MAIN_PLANE_REFLECT:case L.MAIN_PLANE_REFLECT_BLEND:K.disable(K.POLYGON_OFFSET_FILL),K.cullFace(K.FRONT);break;case L.DEBUG_VIEW:K.enable(K.POLYGON_OFFSET_FILL),K.polygonOffset(-4,-4),K.cullFace(K.BACK);break;case L.MAIN_GLOW:if(oe.msaa_samples>1||oe.safari_glow_hack){K.enable(K.POLYGON_OFFSET_FILL),K.polygonOffset(-2,-2);break}default:K.disable(K.POLYGON_OFFSET_FILL),K.cullFace(K.BACK)}}function i(e){if(e){if(!(t=(e.clear_color?K.COLOR_BUFFER_BIT:0)|(e.clear_depth?K.DEPTH_BUFFER_BIT:0)))return;switch(e.type){case L.MAIN_GLOW:r=H;break;case L.SHADOW_CAST:r=j;break;case L.SHADOW_RECEIVE:r=z;break;case L.COLOR_PICKING:case L.COLOR_PICKING_XRAY:case L.ANCHOR_VISIBILITY:r=Y;break;case L.OUTLINE_MASK:case L.SMAA_BLENDING_WEIGHT_CALCULATION:case L.SMAA_EDGE_DETECTION:r=H;break;default:r=oe.background_color}}else var t=K.COLOR_BUFFER_BIT|K.DEPTH_BUFFER_BIT,r=oe.background_color;K.colorMask(!0,!0,!0,!0),K.depthMask(!0),K.clearColor(r[0],r[1],r[2],r[3]),K.clear(t)}function c(e,t,r,a){for(var n=a.transient_uniform_setters,_=n.length;_--;)(i=n[_]).fun(K,i.loc,t,r);if(a.need_uniforms_update&&!a.no_permanent_uniforms){a.permanent_uniform_setters.length||T(a);for(var s=a.permanent_uniform_setters,o=s.length;o--;){var i=s[o];i.fun(K,i.loc,t,r)}a.need_uniforms_update=!1}K.depthMask(r.depth_mask),G&&(r.use_backface_culling?K.enable(K.CULL_FACE):K.disable(K.CULL_FACE)),x(r.textures),e.type==L.SKY||e.type==L.IRRADIANCE?(f(e,r,a),e.debug_render_calls+=6):e.type==L.ROUGHNESS_CONVOLUTION?(m(e,r,a),e.debug_render_calls+=30):(te(r,t.va_frame),e.debug_render_calls++)}function u(e,t,r,a){var n=e.bufs_data;(B.dist(a,r.zsort_eye_last)>oe.alpha_sort_threshold*Math.min(r.bb_min_side,1)||t.force_zsort)&&(I.update_buffers_movable(n,r,t.world_tsr,a),B.copy(a,r.zsort_eye_last),t.force_zsort=!1)}function f(e,t,r){for(var a=e.camera,n=r.uniforms,_=a.color_attachment,s=_.w_texture,o=_.w_target,i=e.cube_view_matrices,l=0;l<6;l++){var c=b(l);if(oe.clear_procedural_sky_hack){var u=K.TEXTURE_CUBE_MAP;K.bindTexture(u,s),K.texImage2D(c,0,K.RGBA,1,1,0,K.RGBA,K.UNSIGNED_BYTE,W)}else K.uniformMatrix4fv(n.u_cube_view_matrix,!1,i[l]),K.uniform4fv(n.u_sky_tex_fac,e.sky_tex_fac),K.uniform3fv(n.u_sky_tex_color,e.sky_tex_color),K.uniform1f(n.u_sky_tex_dvar,e.sky_tex_default_value),K.uniform3fv(n.u_horizon_color,e.horizon_color),K.uniform3fv(n.u_zenith_color,e.zenith_color),K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,c,s,0),te(t,0);e.need_fog_update&&l!=V&&p(e,l)}oe.texture_lod_available&&(K.bindTexture(o,s),K.generateMipmap(o),K.texParameteri(o,K.TEXTURE_MIN_FILTER,C.TF_LINEAR_MIPMAP_LINEAR))}function m(e,t,r){var a=e.camera,n=r.uniforms,_=a.color_attachment,s=_.w_texture,o=_.w_target,i=e.cube_view_matrices;oe.texture_lod_available&&(K.activeTexture(K.TEXTURE7),K.bindTexture(o,s),K.generateMipmap(o),K.texParameteri(o,K.TEXTURE_MIN_FILTER,C.TF_LINEAR_MIPMAP_LINEAR));for(var l=0;l<5;++l){var c=128*Math.pow(.5,l),u=128*Math.pow(.5,l);K.viewport(0,0,c,u);for(var d=l/4,f=0;f<6;f++){var m=b(f);K.uniformMatrix4fv(n.u_cube_view_matrix,!1,i[f]),K.uniform1f(n.u_roughness,d),K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,m,s,l),te(t,0)}}}function p(e,t){var r=se;oe.clear_procedural_sky_hack?r.set(W):(K.readPixels(191,191,1,1,K.RGBA,K.UNSIGNED_BYTE,r),255!=r[0]&&255!=r[1]&&255!=r[2]||K.readPixels(191,220,1,1,K.RGBA,K.UNSIGNED_BYTE,r));var a=r[0],n=r[1],_=r[2];a/=255,n/=255,_/=255,t===q?(e.cube_fog[3]=a,e.cube_fog[7]=n,e.cube_fog[11]=_):(e.cube_fog[4*t]=a,e.cube_fog[4*t+1]=n,e.cube_fog[4*t+2]=_)}function b(e){switch(e){case 0:return K.TEXTURE_CUBE_MAP_POSITIVE_X;case 1:return K.TEXTURE_CUBE_MAP_NEGATIVE_X;case 2:return K.TEXTURE_CUBE_MAP_POSITIVE_Y;case 3:return K.TEXTURE_CUBE_MAP_NEGATIVE_Y;case 4:return K.TEXTURE_CUBE_MAP_POSITIVE_Z;case 5:return K.TEXTURE_CUBE_MAP_NEGATIVE_Z}}function E(e){var t=M.get_vertex_array_object(),r=e.attribute_setters,a=e.bufs_data,n=a.pointers;e.vaos.length=0;var _=1;for(var s in n)_=Math.max(_,n[s].frames);for(var o=0;o<_;o++){var i=t.createVertexArray();$(i),a.ibo&&K.bindBuffer(K.ELEMENT_ARRAY_BUFFER,a.ibo);for(var l=0;l<a.vbo_data.length;l++){K.bindBuffer(K.ARRAY_BUFFER,a.vbo_data[l].vbo);for(var c=0;c<r.length;c++){var u=r[c];if(u.vbo_type==a.vbo_data[l].type){K.enableVertexAttribArray(u.loc);var d=u.base_offset+u.frame_length*o,f=u.gl_type!=K.FLOAT;K.vertexAttribPointer(u.loc,u.num_comp,u.gl_type,f,0,d),Q(u.loc,u.divisor)}}}$(null),e.vaos.push(i)}}function T(e){var t=e.uniforms,r=e.transient_uniform_setters,a=e.permanent_uniform_setters,n=e.transient_sc_uniform_setters,_=e.permanent_sc_uniform_setters;r.length=0,a.length=0,n.length=0,_.length=0;for(var s in t){var o=!1,i=null,l=null;switch(s){case"u_proj_matrix":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,a.proj_matrix)},o=!0;break;case"u_view_refl_matrix":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,a.view_refl_matrix)},o=!0;break;case"u_view_tsr":case"u_view_tsr_frag":i=function(e,t,r,a){a.reflection_plane?e.uniformMatrix3fv(t,!1,a.real_view_tsr):e.uniformMatrix3fv(t,!1,a.view_tsr)},o=!0;break;case"u_view_tsr_inverse":i=function(e,t,r,a){a.reflection_plane?e.uniformMatrix3fv(t,!1,a.real_view_tsr_inv):e.uniformMatrix3fv(t,!1,a.view_tsr_inv)},o=!0;break;case"u_shadow_cast_billboard_view_tsr":i=function(e,t,r,a){e.uniformMatrix3fv(t,!1,a.shadow_cast_billboard_view_tsr)},o=!0;break;case"u_view_proj_prev":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,a.prev_view_proj_matrix)},o=!0;break;case"u_view_proj_matrix":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,a.view_proj_matrix)},o=!0;break;case"u_view_proj_inverse":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,a.view_proj_inv_matrix)},o=!0;break;case"u_sky_vp_inverse":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,a.sky_vp_inv_matrix)},o=!0;break;case"u_camera_eye":case"u_camera_eye_frag":i=function(e,t,r,a){e.uniform3fv(t,P.get_trans(a.world_tsr,re))},o=!0;break;case"u_camera_quat":i=function(e,t,r,a){e.uniform4fv(t,P.get_quat(a.world_tsr,ne))},o=!0;break;case"u_view_max_depth":i=function(e,t,r,a){e.uniform1f(t,a.far)},o=!0;break;case"u_camera_range":i=function(e,t,r,a){e.uniform2f(t,a.near,a.far)},o=!0;break;case"u_csm_center_dists":i=function(e,t,r,a){e.uniform4fv(t,a.csm_center_dists)};break;case"u_height":i=function(e,t,r,a){e.uniform1f(t,a.height)},o=!0;break;case"u_pcf_blur_radii":i=function(e,t,r,a){e.uniform4fv(t,a.pcf_blur_radii)};break;case"u_dof_dist":i=function(e,t,r,a){a.dof_on?e.uniform1f(t,a.dof_distance):e.uniform1f(t,0)},o=!0;break;case"u_dof_front_start":i=function(e,t,r,a){e.uniform1f(t,a.dof_front_start)},o=!0;break;case"u_dof_front_end":i=function(e,t,r,a){e.uniform1f(t,a.dof_front_end)},o=!0;break;case"u_dof_rear_start":i=function(e,t,r,a){e.uniform1f(t,a.dof_rear_start)},o=!0;break;case"u_dof_rear_end":i=function(e,t,r,a){e.uniform1f(t,a.dof_rear_end)},o=!0;break;case"u_dof_bokeh_intensity":i=function(e,t,r,a){e.uniform1f(t,a.dof_bokeh_intensity)},o=!0;break;case"u_camera_direction":i=function(e,t,r,a){e.uniform3fv(t,a.direction)},o=!0;break;case"u_cam_water_depth":i=function(e,t,r,a){e.uniform1f(t,r.cam_water_depth)},o=!0;break;case"u_fog_color_density":i=function(e,t,r,a){e.uniform4fv(t,r.fog_color_density)};break;case"u_fog_params":i=function(e,t,r,a){e.uniform4fv(t,r.fog_params)};break;case"u_underwater_fog_color_density":i=function(e,t,r,a){e.uniform4fv(t,r.water_fog_color_density)};break;case"u_bloom_key":i=function(e,t,r,a){e.uniform1f(t,r.bloom_key)};break;case"u_average_lum_val":i=function(e,t,r,a){e.uniform1f(t,r.average_luminance)};break;case"u_mipmap_1x1":i=function(e,t,r,a){e.uniform1f(t,r.last_mip_map_ind)};break;case"u_bloom_edge_lum":i=function(e,t,r,a){e.uniform1f(t,r.bloom_edge_lum)};break;case"u_time":i=function(e,t,r,a){e.uniform1f(t,r.time)},o=!0;break;case"u_wind":i=function(e,t,r,a){e.uniform3fv(t,r.wind)},o=!0;break;case"u_sky_tex_dvar":i=function(e,t,r,a){e.uniform1f(t,r.sky_tex_default_value)};break;case"u_sky_tex_fac":i=function(e,t,r,a){e.uniform4fv(t,r.sky_tex_fac)};break;case"u_sky_tex_color":i=function(e,t,r,a){e.uniform3fv(t,r.sky_tex_color)};break;case"u_horizon_color":i=function(e,t,r,a){e.uniform3fv(t,r.horizon_color)};break;case"u_zenith_color":i=function(e,t,r,a){e.uniform3fv(t,r.zenith_color)};break;case"u_environment_energy":i=function(e,t,r,a){e.uniform1f(t,r.environment_energy)};break;case"u_bsdf_cube_sky_dim":i=function(e,t,r,a){e.uniform1f(t,r.bsdf_cube_sky_dim)},o=!0;break;case"u_sky_color":i=function(e,t,r,a){e.uniform3fv(t,r.sky_color)};break;case"u_rayleigh_brightness":i=function(e,t,r,a){e.uniform1f(t,r.rayleigh_brightness)};break;case"u_mie_brightness":i=function(e,t,r,a){e.uniform1f(t,r.mie_brightness)};break;case"u_spot_brightness":i=function(e,t,r,a){e.uniform1f(t,r.spot_brightness)};break;case"u_scatter_strength":i=function(e,t,r,a){e.uniform1f(t,r.scatter_strength)};break;case"u_rayleigh_strength":i=function(e,t,r,a){e.uniform1f(t,r.rayleigh_strength)};break;case"u_mie_strength":i=function(e,t,r,a){e.uniform1f(t,r.mie_strength)};break;case"u_rayleigh_collection_power":i=function(e,t,r,a){e.uniform1f(t,r.rayleigh_collection_power)};break;case"u_mie_collection_power":i=function(e,t,r,a){e.uniform1f(t,r.mie_collection_power)};break;case"u_mie_distribution":i=function(e,t,r,a){e.uniform1f(t,r.mie_distribution)};break;case"u_light_positions":i=function(e,t,r,a){e.uniform4fv(t,r.light_positions)};break;case"u_light_directions":i=function(e,t,r,a){e.uniform3fv(t,r.light_directions)};break;case"u_light_color_intensities":i=function(e,t,r,a){e.uniform4fv(t,r.light_color_intensities)};break;case"u_sun_quaternion":i=function(e,t,r,a){e.uniform4fv(t,r.sun_quaternion)};break;case"u_sun_intensity":i=function(e,t,r,a){e.uniform3fv(t,r.sun_intensity)};break;case"u_sun_direction":i=function(e,t,r,a){e.uniform3fv(t,r.sun_direction)};break;case"u_debug_view_mode":i=function(e,t,r,a){e.uniform1i(t,r.debug_view_mode)};break;case"u_debug_colors_seed":i=function(e,t,r,a){e.uniform1f(t,r.debug_colors_seed)};break;case"u_debug_render_time_threshold":i=function(e,t,r,a){e.uniform1f(t,r.debug_render_time_threshold)};break;case"u_subpixel_jitter":i=function(e,t,r,a){e.uniform2fv(t,r.jitter_projection_space)},o=!0;break;case"u_subsample_indices":i=function(e,t,r,a){e.uniform4fv(t,r.jitter_subsample_ind)},o=!0;break;case"u_radial_blur_step":i=function(e,t,r,a){e.uniform1f(t,r.radial_blur_step)};break;case"u_god_rays_intensity":i=function(e,t,r,a){e.uniform1f(t,r.god_rays_intensity)};break;case"u_ssao_radius_increase":i=function(e,t,r,a){e.uniform1f(t,r.ssao_radius_increase)};break;case"u_ssao_blur_discard_value":i=function(e,t,r,a){e.uniform1f(t,r.ssao_blur_discard_value)},o=!0;break;case"u_ssao_influence":i=function(e,t,r,a){e.uniform1f(t,r.ssao_influence)};break;case"u_ssao_dist_factor":i=function(e,t,r,a){e.uniform1f(t,r.ssao_dist_factor)};break;case"u_texel_size":i=function(e,t,r,a){e.uniform2fv(t,r.texel_size)},o=!0;break;case"u_normal_offset":i=function(e,t,r,a){e.uniform1f(t,r.self_shadow_normal_offset)};break;case"u_v_light_ts":i=function(e,t,r,a){e.uniform4fv(t,r.v_light_ts)},o=!0;break;case"u_v_light_r":i=function(e,t,r,a){e.uniform4fv(t,r.v_light_r)},o=!0;break;case"u_v_light_tsr":i=function(e,t,r,a){e.uniformMatrix3fv(t,!1,r.v_light_tsr)},o=!0;break;case"u_p_light_matrix0":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,r.p_light_matrix[0])},o=!0;break;case"u_p_light_matrix1":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,r.p_light_matrix[1])},o=!0;break;case"u_p_light_matrix2":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,r.p_light_matrix[2])},o=!0;break;case"u_p_light_matrix3":i=function(e,t,r,a){e.uniformMatrix4fv(t,!1,r.p_light_matrix[3])},o=!0;break;case"u_outline_color":i=function(e,t,r,a){e.uniform3fv(t,r.outline_color)};break;case"u_draw_outline":i=function(e,t,r,a){e.uniform1f(t,r.draw_outline_flag)},o=!0;break;case"u_glow_mask_small_coeff":i=function(e,t,r,a){e.uniform1f(t,r.small_glow_mask_coeff)},o=!0;break;case"u_glow_mask_large_coeff":i=function(e,t,r,a){e.uniform1f(t,r.large_glow_mask_coeff)},o=!0;break;case"u_brightness":i=function(e,t,r,a){e.uniform1f(t,r.brightness)};break;case"u_contrast":i=function(e,t,r,a){e.uniform1f(t,r.contrast)};break;case"u_exposure":i=function(e,t,r,a){e.uniform1f(t,r.exposure)};break;case"u_saturation":i=function(e,t,r,a){e.uniform1f(t,r.saturation)};break;case"u_enable_hmd_stereo":i=function(e,t,r,a){e.uniform1i(t,r.enable_hmd_stereo)};break;case"u_distortion_params":i=function(e,t,r,a){e.uniform4fv(t,r.distortion_params)};break;case"u_chromatic_aberration_coefs":i=function(e,t,r,a){e.uniform4fv(t,r.chromatic_aberration_coefs)};break;case"u_motion_blur_exp":i=function(e,t,r,a){e.uniform1f(t,r.motion_blur_exp)},o=!0;break;case"u_motion_blur_decay_threshold":i=function(e,t,r,a){e.uniform1f(t,r.mb_decay_threshold)},o=!0;break;case"u_model_tsr":l=function(e,t,r,a){e.uniformMatrix3fv(t,!1,r.world_tsr)},o=!0;break;case"u_model_tsr_inverse":l=function(e,t,r,a){e.uniformMatrix3fv(t,!1,r.world_tsr_inv)},o=!0;break;case"u_transb":l=function(e,t,r,a){e.uniform4fv(t,r.trans_before)},o=!0;break;case"u_transa":l=function(e,t,r,a){e.uniform4fv(t,r.trans_after)},o=!0;break;case"u_arm_rel_trans":l=function(e,t,r,a){e.uniform4fv(t,r.arm_rel_trans)},o=!0;break;case"u_arm_rel_quat":l=function(e,t,r,a){e.uniform4fv(t,r.arm_rel_quat)},o=!0;break;case"u_quat":l=function(e,t,r,a){e.uniform4fv(t,P.get_quat(r.world_tsr,ne))},o=!0;break;case"u_quatsb":l=function(e,t,r,a){e.uniform4fv(t,r.quats_before)},o=!0;break;case"u_quatsa":l=function(e,t,r,a){e.uniform4fv(t,r.quats_after)},o=!0;break;case"u_frame_factor":l=function(e,t,r,a){e.uniform1f(t,r.frame_factor)},o=!0;break;case"au_center_pos":l=function(e,t,r,a){e.uniform3fv(t,r.center_pos)},o=!0;break;case"au_wind_bending_amp":l=function(e,t,r,a){e.uniform1f(t,r.wind_bending_amp)},o=!0;break;case"au_wind_bending_freq":l=function(e,t,r,a){e.uniform1f(t,r.wind_bending_freq)},o=!0;break;case"au_detail_bending_freq":l=function(e,t,r,a){e.uniform1f(t,r.detail_bending_freq)},o=!0;break;case"au_detail_bending_amp":l=function(e,t,r,a){e.uniform1f(t,r.detail_bending_amp)},o=!0;break;case"au_branch_bending_amp":l=function(e,t,r,a){e.uniform1f(t,r.branch_bending_amp)},o=!0;break;case"u_node_values":l=function(e,t,r,a){e.uniform4fv(t,a.node_values)},o=!0;break;case"u_node_rgbs":l=function(e,t,r,a){e.uniform3fv(t,a.node_rgbs)},o=!0;break;case"u_lod_coverage":l=function(e,t,r,a){e.uniform1f(t,a.lod_settings.coverage)},o=!0;break;case"u_lod_cmp_logic":l=function(e,t,r,a){e.uniform1f(t,a.lod_settings.cmp_logic)},o=!0;break;case"u_diffuse_color":l=function(e,t,r,a){e.uniform4fv(t,a.diffuse_color)},o=!0;break;case"u_diffuse_intensity":l=function(e,t,r,a){e.uniform1f(t,a.diffuse_intensity)},o=!0;break;case"u_diffuse_params":l=function(e,t,r,a){e.uniform2fv(t,a.diffuse_params)},o=!0;break;case"u_emit":l=function(e,t,r,a){e.uniform1f(t,a.emit)},o=!0;break;case"u_ambient":l=function(e,t,r,a){e.uniform1f(t,a.ambient)},o=!0;break;case"u_specular_color":l=function(e,t,r,a){e.uniform3fv(t,a.specular_color)},o=!0;break;case"u_specular_alpha":l=function(e,t,r,a){e.uniform1f(t,a.specular_alpha)},o=!0;break;case"u_specular_params":l=function(e,t,r,a){e.uniform3fv(t,a.specular_params)},o=!0;break;case"u_reflect_factor":l=function(e,t,r,a){e.uniform1f(t,a.reflect_factor)},o=!0;break;case"u_mirror_factor":l=function(e,t,r,a){e.uniform1f(t,a.mirror_factor)},o=!0;break;case"u_grass_map_dim":l=function(e,t,r,a){e.uniform3fv(t,a.grass_map_dim)},o=!0;break;case"u_grass_size":l=function(e,t,r,a){e.uniform1f(t,a.grass_size)},o=!0;break;case"u_scale_threshold":l=function(e,t,r,a){e.uniform1f(t,a.grass_scale_threshold)},o=!0;break;case"u_cube_fog":l=function(e,t,r,a){e.uniformMatrix4fv(t,!1,a.cube_fog)};break;case"u_jitter_amp":l=function(e,t,r,a){e.uniform1f(t,a.jitter_amp)},o=!0;break;case"u_jitter_freq":l=function(e,t,r,a){e.uniform1f(t,a.jitter_freq)},o=!0;break;case"u_wireframe_edge_color":l=function(e,t,r,a){e.uniform3fv(t,a.wireframe_edge_color)};break;case"u_cluster_id":l=function(e,t,r,a){e.uniform1f(t,a.cluster_id)},o=!0;break;case"u_batch_debug_id_color":l=function(e,t,r,a){e.uniform1f(t,a.debug_id_color)},o=!0;break;case"u_batch_debug_main_render_time":l=function(e,t,r,a){e.uniform1f(t,a.debug_main_batch_render_time)},o=!0;break;case"u_refr_bump":l=function(e,t,r,a){e.uniform1f(t,a.refr_bump)},o=!0;break;case"u_line_width":l=function(e,t,r,a){e.uniform1f(t,a.line_width)},o=!0;break;case"u_lamp_light_positions":l=function(e,t,r,a){e.uniform3fv(t,a.lamp_light_positions)};break;case"u_lamp_light_directions":l=function(e,t,r,a){e.uniform3fv(t,a.lamp_light_directions)};break;case"u_lamp_light_color_intensities":l=function(e,t,r,a){e.uniform3fv(t,a.lamp_light_color_intensities)};break;case"u_halo_size":l=function(e,t,r,a){e.uniform1f(t,a.halo_size)},o=!0;break;case"u_halo_hardness":l=function(e,t,r,a){e.uniform1f(t,a.halo_hardness)},o=!0;break;case"u_halo_rings_color":l=function(e,t,r,a){e.uniform3fv(t,a.halo_rings_color)},o=!0;break;case"u_halo_lines_color":l=function(e,t,r,a){e.uniform3fv(t,a.halo_lines_color)},o=!0;break;case"u_halo_stars_blend":l=function(e,t,r,a){e.uniform1f(t,a.halo_stars_blend)},o=!0;break;case"u_halo_stars_height":l=function(e,t,r,a){e.uniform1f(t,a.halo_stars_height)},o=!0;break;case"u_fresnel_params":l=function(e,t,r,a){e.uniform2fv(t,a.fresnel_params)},o=!0;break;case"u_texture_scale":l=function(e,t,r,a){e.uniform3fv(t,a.texture_scale)},o=!0;break;case"u_parallax_scale":l=function(e,t,r,a){e.uniform1f(t,a.parallax_scale)},o=!0;break;case"u_color_id":l=function(e,t,r,a){e.uniform3fv(t,r.color_id)},o=!0;break;case"u_diffuse_color_factor":l=function(e,t,r,a){e.uniform1f(t,a.diffuse_color_factor)},o=!0;break;case"u_alpha_factor":l=function(e,t,r,a){e.uniform1f(t,a.alpha_factor)},o=!0;break;case"u_specular_color_factor":l=function(e,t,r,a){e.uniform1f(t,a.specular_color_factor)},o=!0;break;case"u_normal_factor":l=function(e,t,r,a){e.uniform1f(t,a.normal_factor)},o=!0;break;case"u_normalmap0_scale":l=function(e,t,r,a){e.uniform2fv(t,a.normalmap_scales[0])},o=!0;break;case"u_normalmap1_scale":l=function(e,t,r,a){e.uniform2fv(t,a.normalmap_scales[1])},o=!0;break;case"u_normalmap2_scale":l=function(e,t,r,a){e.uniform2fv(t,a.normalmap_scales[2])},o=!0;break;case"u_normalmap3_scale":l=function(e,t,r,a){e.uniform2fv(t,a.normalmap_scales[3])},o=!0;break;case"u_foam_factor":l=function(e,t,r,a){e.uniform1f(t,a.foam_factor)},o=!0;break;case"u_foam_uv_freq":l=function(e,t,r,a){e.uniform2fv(t,a.foam_uv_freq)},o=!0;break;case"u_foam_mag":l=function(e,t,r,a){e.uniform2fv(t,a.foam_mag)},o=!0;break;case"u_foam_scale":l=function(e,t,r,a){e.uniform2fv(t,a.foam_scale)},o=!0;break;case"u_water_norm_uv_velocity":l=function(e,t,r,a){e.uniform1f(t,a.water_norm_uv_velocity)},o=!0;break;case"u_shallow_water_col":l=function(e,t,r,a){e.uniform3fv(t,a.shallow_water_col)},o=!0;break;case"u_shore_water_col":l=function(e,t,r,a){e.uniform3fv(t,a.shore_water_col)},o=!0;break;case"u_water_shallow_col_fac":l=function(e,t,r,a){e.uniform1f(t,a.shallow_water_col_fac)},o=!0;break;case"u_water_shore_col_fac":l=function(e,t,r,a){e.uniform1f(t,a.shore_water_col_fac)},o=!0;break;case"u_p_length":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.time_length)},o=!0;break;case"u_p_cyclic":l=function(e,t,r,a){e.uniform1i(t,a.particles_data.cyclic)},o=!0;break;case"u_p_max_lifetime":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.lifetime)},o=!0;break;case"u_p_fade_in":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.fade_in)},o=!0;break;case"u_p_fade_out":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.fade_out)},o=!0;break;case"u_p_size":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.size)},o=!0;break;case"u_p_alpha_start":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.alpha_start)},o=!0;break;case"u_p_alpha_end":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.alpha_end)},o=!0;break;case"u_p_nfactor":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.nfactor)},o=!0;break;case"u_p_gravity":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.gravity)},o=!0;break;case"u_p_mass":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.mass)},o=!0;break;case"u_p_color_ramp":l=function(e,t,r,a){e.uniform4fv(t,a.particles_data.color_ramp)},o=!0;break;case"u_p_wind_fac":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.wind_factor)},o=!0;break;case"u_p_time":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.time)},o=!0;break;case"u_p_tilt":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.tilt)},o=!0;break;case"u_p_tilt_rand":l=function(e,t,r,a){e.uniform1f(t,a.particles_data.tilt_rand)},o=!0;break;case"u_position":l=function(e,t,r,a){e.uniform3fv(t,a.anchor_positions)},o=!0;break;case"u_va_frame_factor":l=function(e,t,r,a){e.uniform1f(t,r.va_frame_factor)},o=!0;break;case"u_refl_plane":l=function(e,t,r,a){e.uniform4fv(t,r.reflection_plane)},o=!0;break;case"u_outline_intensity":l=function(e,t,r,a){e.uniform1f(t,r.outline_intensity)},o=!0;break;case"u_obj_info":l=function(e,t,r,a){e.uniform3fv(t,a.obj_info_params)},o=!0}if(l&&(c={name:s,fun:l,loc:t[s]},o?r.push(c):a.push(c)),i){var c={name:s,fun:i,loc:t[s]};o?n.push(c):_.push(c)}}if(a.length||_.length){var u=e.permanent_uniform_setters_table;for(var d in u)delete u[d];for(d=0;d<a.length;d++)u[(c=a[d]).name]=c;for(d=0;d<_.length;d++)u[(c=_[d]).name]=c}else e.no_permanent_uniforms=!0}function x(e){for(var t=K,r=0;r<e.length;r++){var a=e[r];t.activeTexture(t.TEXTURE0+r),t.bindTexture(a.w_target,a.w_texture),a.use_mipmap&&t.generateMipmap(a.w_target)}}var O=_e(e),R=ue(e),k=g(e),N=ae(e),M=y(e),I=w(e),S=d(e),L=A(e),C=ee(e),P=v(e),D=h(e),F=U(e),B=l(e),G=!0,j=[1,0,0,1],z=[1,1,1,1],Y=[0,0,0,1],H=[0,0,0,0],W=new Uint8Array([91.8,142.8,.96*255,255]),q=4,V=5,X=15,K=null,Z=null,Q=null,J=null,$=null,te=null,re=new Float32Array(3),ne=S.create(),se=new Uint8Array(4),oe=k.defaults;t.setup_context=function(e){var t=oe.background_color;e.clearColor(t[0],t[1],t[2],t[3]),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),G?(e.enable(e.CULL_FACE),e.frontFace(e.CCW),e.cullFace(e.BACK)):e.disable(e.CULL_FACE),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),K=e},t.draw=function(e){e.do_render&&!e.force_do_not_render&&(e.type==L.RESOLVE?(N.render_time_start_subs(e),a(e),N.render_time_stop_subs(e),N.check_gl("draw resolve")):e.type==L.COPY?(N.render_time_start_subs(e),n(e),N.render_time_stop_subs(e),N.check_gl("draw copy")):(N.render_time_start_subs(e),o(e),e.type==L.MAIN_CUBE_REFLECT||e.type==L.MAIN_CUBE_REFLECT_BLEND?r(e):_(e),N.render_time_stop_subs(e),N.check_gl("draw subscene: "+L.subs_label(e))))},t.clear=function(e){var t=e.camera;K.bindFramebuffer(K.FRAMEBUFFER,t.framebuffer),i(e)},t.assign_attribute_setters=function(e){var t=e.attribute_setters;t.length=0;var r=e.bufs_data,a=e.shader,n=r.pointers,_=a.attributes;for(var s in _){var o=n[s],i=I.get_vbo_type_by_attr_name(s),l=I.get_gl_type_by_attr_name(s),c=I.get_type_size_by_attr_name(s),u={vbo_type:i,gl_type:l,loc:_[s],base_offset:o.offset*c,frame_length:o.frames>1?o.length*c:0,num_comp:o.num_comp,divisor:o.divisor};t.push(u)}if("DEBUG"==F.type())for(var s in n){var i=I.get_vbo_type_by_attr_name(s),d=I.search_vbo_index_by_type(r.vbo_data,i),f=r.vbo_data[d],m=e.shaders_info.vert+" | "+e.shaders_info.frag,p=n[s].length*n[s].frames*I.get_type_size_by_attr_name(s);N.fill_vbo_garbage_info(f.debug_id,m,s,p,s in _)}oe.allow_vao_ext&&E(e)},t.assign_vao=E,t.cleanup_vao=function(e){for(var t=M.get_vertex_array_object(),r=0;r<e.vaos.length;r++)t.deleteVertexArray(e.vaos[r]);e.vaos.length=0},t.clone_attribute_setters=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r],n={vbo_type:a.vbo_type,gl_type:a.gl_type,loc:a.loc,base_offset:a.base_offset,frame_length:a.frame_length,num_comp:a.num_comp,divisor:a.divisor};t.push(n)}return t},t.assign_uniform_setters=T,t.assign_texture_uniforms=function(e){var t=e.shader,r=e.textures,a=e.texture_names;K.useProgram(t.program);for(var n=0;n<r.length;n++){var _=a[n];K.uniform1i(t.uniforms[_],n)}},t.read_pixels=function(e,t,r,a,n,_){return K.bindFramebuffer(K.FRAMEBUFFER,e),K.readPixels(t,r,a,n,K.RGBA,K.UNSIGNED_BYTE,_),K.bindFramebuffer(K.FRAMEBUFFER,null),_},t.update_batch_permanent_uniform=function(e,t){var r=e.shader;if(!r.no_permanent_uniforms){K.useProgram(r.program),r.permanent_uniform_setters.length||T(r);var a=r.permanent_uniform_setters_table[t];a.fun(K,a.loc,null,e)}},t.render_target_create=function(e,t){var r=K.createFramebuffer();if(K.bindFramebuffer(K.FRAMEBUFFER,r),C.is_renderbuffer(e))_=e.w_renderbuffer,K.framebufferRenderbuffer(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,K.RENDERBUFFER,_);else if(C.is_texture(e)){var a=(s=e).w_texture,n=s.w_target==K.TEXTURE_CUBE_MAP?K.TEXTURE_CUBE_MAP_NEGATIVE_Z:s.w_target;K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,n,a,0)}if(C.is_renderbuffer(t)){var _=t.w_renderbuffer;K.framebufferRenderbuffer(K.FRAMEBUFFER,K.DEPTH_ATTACHMENT,K.RENDERBUFFER,_)}else if(C.is_texture(t)){var s=t,a=s.w_texture,n=s.w_target;K.framebufferTexture2D(K.FRAMEBUFFER,K.DEPTH_ATTACHMENT,n,a,0)}return N.check_bound_fb(),K.bindFramebuffer(K.FRAMEBUFFER,null),r},t.render_target_cleanup=function(e,t,r,a,n){if(null==e)return K.bindFramebuffer(K.FRAMEBUFFER,e),K.viewport(0,0,a,n),void K.clear(K.COLOR_BUFFER_BIT|K.DEPTH_BUFFER_BIT);C.is_renderbuffer(t)?K.deleteRenderbuffer(t.w_renderbuffer):C.is_texture(t)&&K.deleteTexture(t.w_texture),C.is_renderbuffer(r)?K.deleteRenderbuffer(r.w_renderbuffer):C.is_texture(r)&&K.deleteTexture(r.w_texture),K.deleteFramebuffer(e)},t.increment_subpixel_index=function(){},t.draw_resized_cubemap_texture=function(e,t,r,a,n,_){var s=e.w_texture;K.viewport(0,0,r,r),K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,t,s,0);var o=O.create_postprocessing_batch("FLIP_CUBEMAP_COORDS"),i=o.shader;K.activeTexture(K.TEXTURE0),K.bindTexture(K.TEXTURE_2D,n);var l=0,c=0;r!=a&&(l=1/(6*a),c=1/(4*a)),K.uniform1i(i.uniforms.u_tex_number,_),K.uniform2fv(i.uniforms.u_delta,[l,c]),K.useProgram(i.program),te(o,0),K.bindTexture(K.TEXTURE_2D,null)},t.draw_resized_texture=function(e,t,r,a,n,_){K.bindFramebuffer(K.FRAMEBUFFER,a);var s=e.w_texture,o=e.w_target;K.bindTexture(o,s),K.viewport(0,0,t,r),K.texImage2D(o,0,K.RGBA,t,r,0,K.RGBA,K.UNSIGNED_BYTE,null),K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,o,s,0);var i=O.create_postprocessing_batch(_),l=i.shader;K.activeTexture(K.TEXTURE0),K.bindTexture(o,n),K.useProgram(l.program),te(i,0),K.bindFramebuffer(K.FRAMEBUFFER,null),K.bindTexture(o,null)},t.cleanup=function(){},t.set_draw_methods=function(){var e=M.get_instanced_arrays(),t=M.get_vertex_array_object();oe.allow_instanced_arrays_ext=!!e,oe.allow_vao_ext=!!t,e?(Z=function(t,r,a,n){e.drawElementsInstanced(K.TRIANGLES,t,r,a,n)},Q=function(t,r){e.vertexAttribDivisor(t,r)},J=function(t,r,a){e.drawArraysInstanced(K.TRIANGLES,t,r,a)}):(Z=function(e,t,r){K.drawElements(K.TRIANGLES,e,t,r)},Q=function(e,t){},J=function(e,t,r){K.drawArrays(K.TRIANGLES,e,t)}),t?($=function(e){t.bindVertexArray(e)},te=function(e,t){var r=e.bufs_data;$(e.vaos[t]),r.ibo?Z(r.count,r.ibo_type,0,r.instance_count):J(0,r.count,r.instance_count),$(null)}):te=function(e,t){for(var r=e.bufs_data,a=e.attribute_setters,n=0;n<r.vbo_data.length;n++){K.bindBuffer(K.ARRAY_BUFFER,r.vbo_data[n].vbo);for(var _=0;_<a.length;_++)if((i=a[_]).vbo_type==r.vbo_data[n].type){K.enableVertexAttribArray(i.loc);var s=i.base_offset+i.frame_length*t,o=i.gl_type!=K.FLOAT;K.vertexAttribPointer(i.loc,i.num_comp,i.gl_type,o,0,s),Q(i.loc,i.divisor)}}for(r.ibo?(K.bindBuffer(K.ELEMENT_ARRAY_BUFFER,r.ibo),Z(r.count,r.ibo_type,0,r.instance_count)):J(0,r.count,r.instance_count),n=0;n<a.length;n++){var i=a[n];K.disableVertexAttribArray(i.loc)}}},t.reset=function(){K=null,Z=null,Q=null,J=null,$=null}}),re=o("__compat",function(e,t){function r(e){return navigator.userAgent.indexOf(e)>-1}function a(){return navigator.userAgent.match(/Windows Phone/i)||navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)}function n(){return!window.ActiveXObject&&"ActiveXObject"in window}var _=g(e),s=ae(e),o=y(e),i=m(e),l=te(e),c=["R600","RV610","RV630","RV620","RV635","RV670","RS780","RS880","RV770","RV730","RV710","RV740","CEDAR","REDWOOD","JUNIPER","CYPRESS","PALM (Wrestler/Ontario)","SUMO (Llano)","SUMO2 (Llano)","ARUBA (Trinity/Richland)","BARTS","TURKS","CAICOS","CAYMAN"];t.NVIDIA_OLD_GPU_CUBEMAP_MAX_SIZE=256;var u=_.animation,d=_.defaults,f=_.debug_subs,p=_.context,h=_.context_limits,v=_.sfx,b=_.physics,E=_.assets;t.detect_tegra_invalid_enum_issue=function(e){e.getError()==e.INVALID_ENUM&&i.warn("Possible Tegra invalid enum issue detected, ignoring")},t.set_hardware_defaults=function(e,m){var g=function(e){m&&i.warn(e)};h.max_combined_texture_image_units=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),h.max_fragment_uniform_vectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),h.max_texture_image_units=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),h.max_varying_vectors=e.getParameter(e.MAX_VARYING_VECTORS),h.max_vertex_attribs=e.getParameter(e.MAX_VERTEX_ATTRIBS),h.max_vertex_texture_image_units=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),h.max_vertex_uniform_vectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),h.max_cube_map_texture_size=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),h.max_renderbuffer_size=e.getParameter(e.MAX_RENDERBUFFER_SIZE),h.max_texture_size=e.getParameter(e.MAX_TEXTURE_SIZE),h.max_viewport_dims=e.getParameter(e.MAX_VIEWPORT_DIMS);var y=o.get_renderer_info();if(y){var w=e.getParameter(y.UNMASKED_VENDOR_WEBGL),A=e.getParameter(y.UNMASKED_RENDERER_WEBGL);w.indexOf("Qualcomm")>-1&&A.indexOf("330")>-1&&(r("Chrome")||r("Firefox"))&&(g("Chrome/Firefox and Qualcomm 330 detected, force enable WebGL 1, disable blending cascaded shadow maps."),d.webgl2=!1,d.chrome_csm_blend_hack=!0)}h.depth_bits=d.webgl2?24:16,d.webgl2&&!f.enabled&&(d.compared_mode_depth=!0),d.webgl2?(d.msaa_samples=Math.min(d.msaa_samples,e.getParameter(e.MAX_SAMPLES)),r("Firefox")&&(g("Firefox and WebGL 2 detected, applying framebuffer hack."),d.check_framebuffer_hack=!0),r("Windows")&&r("Chrome")&&(g("Windows, Chrome and WebGL 2 detected, applying multisample hack, disabling MSAA."),d.msaa_samples=1)):d.msaa_samples=1,r("Firefox")&&"NONE"!==d.stereo&&(g("Firefox and Stereo rendering detected, disable texture reusage"),d.firefox_tex_reuse_hack=!0),(d.webgl2&&s.check_multisample_issue()||r("Firefox"))&&(g("Firefox detected, disabling multisample"),d.msaa_samples=1),r("Mac OS X")&&r("Chrome/60")&&(g("macOS and Chrome 60 detected, disabling multisample"),d.msaa_samples=1),l.set_draw_methods();var T=Boolean(o.get_depth_texture());if(r("Firefox/28.0")&&(r("Linux")||r("Macintosh"))&&(g("Firefox 28 detected, applying depth hack"),T=!1),r("Windows Phone")||(r("iPad")||r("iPhone")?(g("iOS detected, applying alpha hack, applying vertex animation mix normals hack, disable smaa. Disable ssao for performance. Initialize WebAudio context with empty sound. Applying glow hack."),p.alpha||(d.background_color[3]=1),d.ios_copy_tex_hack=!0,d.vert_anim_mix_normals_hack=!0,d.smaa=!1,d.ssao=!1,d.init_wa_context_hack=!0,Boolean(o.get_pvr())&&E.pvr_available&&(d.compress_format="pvr")):r("Mac OS X")&&r("Safari")&&!r("Chrome")&&(g("OS X / Safari detected, force to wait complete loading. Applying playback rate hack for video textures. Applying canvas alpha hack."),d.safari_canvas_alpha_hack=!0,v.audio_loading_hack=!0,v.clamp_playback_rate_hack=!0)),r("Windows")&&(r("Chrome/40")||r("Firefox/33")||r("Firefox/34")||r("Firefox/35")||r("Firefox/36"))&&(g("Windows/Chrome40 or Firefox33-36 detected. Applying clear procedural skydome hack."),d.clear_procedural_sky_hack=!0),r("Chrome")&&!a()&&_.is_built_in_data()&&(g('Chrome (non-mobile) was detected for a single HTML-exported file. "Background Music" speakers were changed to "Background Sound".'),d.chrome_html_bkg_music_hack=!0),r("Mac OS X")&&(d.mac_os_shadow_hack=!0,g("OS X detected, applying shadows hack.")),a()&&(g("Mobile detected, applying various hacks for video textures."),d.is_mobile_device=!0,r("iPad")||r("iPhone")||r("Windows Phone")||(g("Mobile (not iOS) detected, disable playback rate for video textures."),v.disable_playback_rate_hack=!0)),r("iPad")&&(g('iPad detected, use "autoplay" hack for video textures.'),d.ipad_video_hack=!0),(r("Firefox/35.0")||r("Firefox/36.0"))&&r("Windows")&&(g("Windows/Firefox 35/36 detected, applying shadows slink hack"),d.shadows_color_slink_hack=!0),(r("iPhone")||n())&&(g("iPhone or IE11 detected. Enable sequential video fallback for video textures."),d.seq_video_fallback=!0),h.max_varying_vectors<10&&(g("Not enough varyings, disable shadows on blend objects"),d.disable_blend_shadows_hack=!0),r("Windows Phone")&&(g("Windows Phone detected. Disable debug view mode, glow materials, ssao, smaa, shadows, reflections, refractions."),d.debug_view=!1,d.glow_materials=!1,d.ssao=!1,d.smaa=!1,d.shadows=!1,d.reflections=!1,d.refractions=!1,d.quality_aa_method=!1),(r("UCBrowser")||r("Chrome")&&r("Nexus")&&d.is_mobile_device)&&(g("Mobile Nexus Chrome or UCBrowser detected, disable workers."),b.use_workers=!1),r("Firefox")&&(g("Firefox detected, disabling workers"),b.use_workers=!1),(n()||r("Edge"))&&(g("IE11 or Edge detected, disabling workers"),b.use_workers=!1),r("Chrome")&&r("Linux")&&(g("Chrome and Linux detected, disabling wasm physics."),b.use_wasm=!1),y){var w=e.getParameter(y.UNMASKED_VENDOR_WEBGL),A=e.getParameter(y.UNMASKED_RENDERER_WEBGL);r("Chrome")&&A.indexOf("Mali-T720")>-1&&(g('Chrome and ARM Mali-T720 detected, changing "Alpha Anti-Aliasing" materials to "Alpha Clip".'),d.mali_alpha_antialias_hack=!0),A.indexOf("AMD")>-1&&r("Windows")&&r("Firefox")&&(g("AMD, Windows and Firefox detected, disabling depth textures."),T=!1),w.indexOf("ARM")>-1&&/\b4\d{2}\b/.test(A)&&(g("ARM Mali-400 series detected, applying lamps, depth and frames blending hacks"),T=!1,u.frames_blending_hack=!0,d.mali4_lamps_hack=!0),w.indexOf("ARM")>-1&&A.indexOf("Mali-T604")>-1&&(g("ARM Mali-T604 detected, disabling shadows."),d.shadows=!1),w.indexOf("ARM")>-1&&A.indexOf("Mali-T760")>-1&&(g("ARM Mali-T760 detected, disabling SSAO."),d.ssao=!1,d.skinning_hack=!0,d.webgl2&&(d.msaa_samples=1,g("ARM Mali-T760 and WebGL 2 detected, switching MSAA samples to 1."))),w.indexOf("ARM")>-1&&A.indexOf("Mali-T720")>-1&&(g("ARM Mali-T720 detected, disabling depth textures."),T=!1,d.webgl2&&(d.msaa_samples=1,g("ARM Mali-T720 and WebGL 2 detected, switching MSAA samples to 1."))),w.indexOf("Qualcomm")>-1&&A.indexOf("Adreno")>-1&&(g("Qualcomm Adreno detected, applying shader constants hack."),d.shader_constants_hack=!0,A.indexOf("420")>-1&&(g("Qualcomm Adreno420 detected, setting max cubemap size to 12288x8192, setting max texture size to 4096x4096."),h.max_texture_size=Math.min(h.max_texture_size,4096),h.max_cube_map_texture_size=Math.min(h.max_cube_map_texture_size,4096)),r("Chrome")&&(A.match(/4../)||A.match(/5../))&&(g("Qualcomm Adreno 4xx or 5xx detected, switch MSAA samples to 1."),d.msaa_samples=1)),w.indexOf("NVIDIA")>-1&&A.indexOf("Tegra 3")>-1&&(g("NVIDIA Tegra 3 detected, force low quality for B4W_LEVELS_OF_QUALITY nodes."),d.force_low_quality_nodes=!0),r("Windows")&&r("Chrome")&&!r("Edge")&&(A.match(/NVIDIA GeForce 8..0/)||A.match(/NVIDIA GeForce 9..0/)||A.match(/NVIDIA GeForce( (G|GT|GTS|GTX))? 2../))&&(g("Chrome / Windows / NVIDIA GeForce 8/9/200 series detected, setting max cubemap size to 768x512, use canvas for resizing."),h.max_cube_map_texture_size=t.NVIDIA_OLD_GPU_CUBEMAP_MAX_SIZE,d.resize_cubemap_canvas_hack=!0),A.indexOf("PowerVR")>-1&&A.indexOf("SGX")>-1&&(g("PowerVR SGX series detected, use canvas for resizing. Disable shadows. Apply skinning hack, disable skin blending between frames."),d.resize_cubemap_canvas_hack=!0,d.skinning_hack=!0,d.shadows=!1),r("Windows")&&A.indexOf("Direct3D9")>-1&&(g("DirectX 9.0 detected, using canvas for resizing textures/cubemap textures."),d.d3d9_canvas_resizing_hack=!0,d.resize_cubemap_canvas_hack=!0,d.resize_texture_canvas_hack=!0);for(var x="",O=0;O<c.length;O++)if(A.indexOf(c[O])>-1){x=c[O];break}x&&(g("Architecture "+x+" detected. Blending between frames and shadows on blend objects will be disabled."),d.skinning_hack=!0,d.disable_blend_shadows_hack=!0)}if(0==h.max_vertex_texture_image_units&&(g("Vertex textures are not allowed. Disabling vertex textures"),d.allow_vertex_textures=!1),T||(d.foam=!1,d.dynamic_grass=!1,d.water_dynamic=!1,d.shore_smoothing=!1,d.shore_distance=!1,d.smaa=!1,d.ssao=!1,d.rgba_fallback_shadows=!0),d.use_compression=Boolean(o.get_s3tc())||"pvr"==d.compress_format,d.depth_tex_available=T,e.getShaderPrecisionFormat)var R=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);e.getShaderPrecisionFormat&&0!==R.precision||(d.precision="mediump"),(n()&&r("Touch")||r("Edge"))&&(g("IE11 and touchscreen or Edge detected. Behaviour of the mouse move sensor will be changed."),d.ie11_edge_touchscreen_hack=!0),(n()||r("Edge"))&&(d.ie_edge_anchors_floor_hack=!0,d.ie11_edge_mouseoffset_hack=!0,d.resize_cubemap_canvas_hack=!0),a()&&r("Firefox")&&(i.log("Mobile firefox detected. Applying autoplay media hack.Setting max cubemap size to 12288x8192, setting max texture size to 4096x4096."),d.mobile_firefox_media_hack=!0,h.max_texture_size=Math.min(h.max_texture_size,4096),h.max_cube_map_texture_size=Math.min(h.max_cube_map_texture_size,4096));var k=Boolean(o.get_aniso());d.anisotropic_available=k;var N=Boolean(o.get_texture_lod());d.texture_lod_available=N},t.check_user_agent=r,t.detect_mobile=a,t.apply_context_alpha_hack=function(){r("Firefox/35.0")&&r("Windows")&&(i.warn("Windows/Firefox 35 detected, forcing context's alpha"),_.context.alpha=!0)},t.is_ie11=n}),ae=o("__debug",function(e,t){function r(){return B}function a(e,t,r){var a=[];for(var _ in e)M.get_dict_length(e[_])>1&&a.push([_,e[_]]);if(a.sort(function(e,t){var r=M.get_dict_length(e[1]),a=M.get_dict_length(t[1]);return a!=r?a-r:e<t?-1:t<e?1:0}),a.length){T.groupCollapsed(t+" "+r),T.log_raw("Property different variants (>1) | Property name");for(var s=0;s<a.length;s++)T.groupCollapsed(M.get_dict_length(a[s][1]),a[s][0]),n(a[s][1]);T.groupEnd()}}function n(e){T.log_raw("Batches count for this property value | Property value");var t=[];for(var r in e)t.push([r,e[r]]);t.sort(function(e,t){return t[1]!=e[1]?t[1]-e[1]:e[0]<t[0]?-1:t[0]<e[0]?1:0});for(var a=0;a<t.length;a++)T.log_raw(t[a][1],t[a][0]);T.groupEnd()}function _(e){for(var t=e.split("\n"),r=0;r<t.length;r++)t[r]=r+1+" "+t[r];return e=t.join("\n")}function s(){var e=v.get_disjoint_timer_query();if(e)t=e.createQuery(),e.beginQuery(t);else var t=performance.now();return t}function o(){var e=r();return e&&e.debug_view_mode==t.DV_RENDER_TIME}function i(e,t,r){var a=v.get_disjoint_timer_query(),n=0;if(a){r&&a.endQuery();for(var _=0;_<e.length;_++){var s=e[_],o=a.getQueryAvailable(s),i=C.getParameter(a.getDisjoint());o&&!i&&(n=a.getQueryObject(s)/1e6,t&&(n=M.smooth(n,t,1,L)),e.splice(_,1),_--)}}else n=performance.now()-e.pop(),t&&(n=M.smooth(n,t,1,L));return n}function l(e,t){if(c(e)||M.panic("Structure assertion failed: invalid first object value"),c(t)||M.panic("Structure assertion failed: invalid second object value"),u(e,t)||M.panic("Structure assertion failed: incompatible types"),!(null==e||null==t||"object"!=typeof e||M.is_arr_buf_view(e)||e instanceof Array)){for(var r in e)c(e[r])||M.panic("Structure assertion failed: invalid value for key in the first object: "+r),r in t||M.panic("Structure assertion failed: missing key in the first object: "+r);for(var r in t)c(t[r])||M.panic("Structure assertion failed: invalid value for key in the second object: "+r),r in e||M.panic("Structure assertion failed: missing key in the second object: "+r),u(e[r],t[r])||M.panic("Structure assertion failed: incompatible types for key "+r)}}function c(e){return void 0!==e&&("number"!=typeof e||!isNaN(e))}function u(e,t){if(typeof e!=typeof t)return!1;if(null!=e&&null!=t&&"object"==typeof e){var r=e instanceof Array,a=t instanceof Array;if(r&&!a||!r&&a)return!1;var n=M.is_arr_buf_view(e),_=M.is_arr_buf_view(t);if(n&&!_||!n&&_)return!1}return!0}var d=_e(e),f=re(e),p=g(e),v=y(e),b=E(e),w=$(e),T=m(e),O=j(e),R=A(e),k=ee(e),N=x(e),M=h(e),I=p.defaults,S={},L=10,C=null,P={},D=[],U=-1,F=-1,B=null,G=null,z=!1,Y={};t.DV_NONE=0,t.DV_OPAQUE_WIREFRAME=1,t.DV_TRANSPARENT_WIREFRAME=2,t.DV_FRONT_BACK_VIEW=3,t.DV_BOUNDINGS=4,t.DV_CLUSTERS_VIEW=5,t.DV_BATCHES_VIEW=6,t.DV_RENDER_TIME=7,t.setup_context=function(e){for(var t=["INVALID_ENUM","INVALID_VALUE","INVALID_OPERATION","OUT_OF_MEMORY","INVALID_FRAMEBUFFER_OPERATION","CONTEXT_LOST_WEBGL"],r=0;r<t.length;r++){var a=t[r];a in e&&(S[e[a]]=a)}C=e},t.set_debug_view_subs=function(e){B=e},t.get_debug_view_subs=r,t.fill_vbo_garbage_info=function(e,t,r,a,n){Y[e]||(Y[e]={shaders:t,attrs:{}}),r in Y[e].attrs||(Y[e].attrs[r]=a),n&&(Y[e].attrs[r]=0)},t.calc_vbo_garbage_byte_size=function(){var e=0;for(var t in Y)for(var r in Y[t].attrs)e+=Y[t].attrs[r];return e},t.show_vbo_garbage_info=function(){var e={};for(var t in Y)for(var r in Y[t].attrs){var a=Y[t].attrs[r];a&&((n=Y[t].shaders)in e||(e[n]={total_size:0,attrs:{}}),r in e[n].attrs||(e[n].attrs[r]=0),e[n].attrs[r]+=a,e[n].total_size+=a)}for(var n in e){T.groupCollapsed(n,e[n].total_size);for(var r in e[n].attrs)T.log_raw(r,e[n].attrs[r]);T.groupEnd()}},t.print_batches_stat=function(){for(var e={},t=["bounds_local","bufs_data","id","attribute_setters","num_vertices","num_triangles","material_names","shader","bpy_tex_names"],r=0,n=0,_=w.get_scene_objs(O.get_main(),"MESH",w.DATA_ID_ALL),s=0;s<_.length;s++)for(var o=0;o<_[s].scenes_data.length;o++)for(var i=0;i<_[s].scenes_data[o].batches.length;i++){var l=d.clone_batch(_[s].scenes_data[o].batches[i]),c=l.shaders_info.vert+"/"+l.shaders_info.frag;l["shaders_info.directives"]=l.shaders_info.directives,l["shaders_info.node_elements"]=l.shaders_info.node_elements,delete l.shaders_info;for(var u=0;u<t.length;u++)delete l[t[u]];if(_[s].is_dynamic)n++;else{r++,l.type in e||(e[l.type]={}),c in e[l.type]||(e[l.type][c]={});for(var f in l){f in e[l.type][c]||(e[l.type][c][f]={});var m=JSON.stringify(l[f]);m in e[l.type][c][f]||(e[l.type][c][f][m]=0),e[l.type][c][f][m]++}}}T.group("Batches statistics:"),T.log_raw("STATIC/DYNAMIC count:",r+"/"+n),T.group("STATIC batches diversity:");for(var p in e)for(var c in e[p])a(e[p][c],p,c);T.groupEnd(),T.groupEnd()},t.check_gl=function(e){if(I.gl_debug){var t=C.getError();t!=C.NO_ERROR&&(t in S?M.panic("GL Error: "+t+", gl."+S[t]+" ("+e+")"):M.panic("Unknown GL error: "+t+" ("+e+")"))}},t.check_bound_fb=function(){if(!I.gl_debug&&!I.check_framebuffer_hack)return!0;switch(C.checkFramebufferStatus(C.FRAMEBUFFER)){case C.FRAMEBUFFER_COMPLETE:return!0;case C.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return T.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT"),!1;case C.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return T.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT"),!1;case C.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return T.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS"),!1;case C.FRAMEBUFFER_UNSUPPORTED:return T.error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED"),!1;case C.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:return T.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MULTISAMPLE"),!1;default:return T.error("FRAMEBUFFER CHECK FAILED"),!1}},t.check_depth_only_issue=function(){if(-1!=U)return U;var e=C.createFramebuffer();C.bindFramebuffer(C.FRAMEBUFFER,e);var t=k.create_texture(k.TT_DEPTH,!1);k.resize(t,1,1);var r=t.w_texture,a=t.w_target;return C.framebufferTexture2D(C.FRAMEBUFFER,C.DEPTH_ATTACHMENT,a,r,0),C.checkFramebufferStatus(C.FRAMEBUFFER)!=C.FRAMEBUFFER_COMPLETE?(U=!0,T.warn("depth-only issue was found")):U=!1,C.bindFramebuffer(C.FRAMEBUFFER,null),C.deleteFramebuffer(e),U},t.check_multisample_issue=function(){if(1==I.msaa_samples)return!1;if(-1!=F)return F;var e=C.createRenderbuffer();C.bindRenderbuffer(C.RENDERBUFFER,e),C.renderbufferStorageMultisample(C.RENDERBUFFER,I.msaa_samples,C.RGBA8,1,1);var t=C.getRenderbufferParameter(C.RENDERBUFFER,C.RENDERBUFFER_SAMPLES);return t!=I.msaa_samples?(F=!0,T.warn("multisample issue was found: requested "+I.msaa_samples+", got "+t),C.getError()==C.INVALID_OPERATION&&T.warn("the error from multisample issue detected, ignoring")):F=!1,C.bindRenderbuffer(C.RENDERBUFFER,null),F},t.check_ff_cubemap_out_of_memory=function(){return!(!f.check_user_agent("Firefox")||C.getError()!=C.OUT_OF_MEMORY||(T.warn("Firefox/old GPUs cubemap issue was found."),0))},t.report_shader_compiling_error=function(e,t,r){I.gl_debug&&(r=_(r),T.error("shader compilation failed:\n"+r+"\n"+C.getShaderInfoLog(e)+" ("+t+")"))},t.report_shader_linking_error=function(e,t,r,a){I.gl_debug&&(r=_(r),a=_(a),T.error("shader linking failed:\n"+r+"\n\n\n"+a+"\n"+C.getProgramInfoLog(e)+" ("+t+")"))},t.render_time_start_subs=function(e){(I.show_hud_debug_info||e.type==R.PERFORMANCE)&&(e.do_not_debug||e.debug_render_time_queries.push(s()))},t.render_time_start_batch=function(e){"MAIN"==e.type&&o()&&e.debug_render_time_queries.push(s())},t.render_time_stop_subs=function(e){if((I.show_hud_debug_info||e.type==R.PERFORMANCE)&&!e.do_not_debug){var t=i(e.debug_render_time_queries,e.debug_render_time,!0);t&&(e.debug_render_time=t)}},t.render_time_stop_batch=function(e){if("MAIN"==e.type&&o()){var t=i(e.debug_render_time_queries,e.debug_render_time,!0);t&&(e.debug_render_time=t)}},t.is_debug_view_render_time_mode=o,t.process_timer_queries=function(e){var t=i(e.debug_render_time_queries,e.debug_render_time,!1);t&&(e.debug_render_time=t)},t.exec_count=function(e){e in P?P[e]+=1:P[e]=1},t.update=function(){for(var e in P)T.log(e,P[e]),P[e]=0},t.fbmsg=function(){for(var e=[performance.now()],t=0;t<arguments.length;t++){var r=arguments[t];if(M.is_vector(r))for(var a=0;a<r.length;a++)e.push(r[a]);else e.push(arguments[t])}D.push(e)},t.msg=function(){for(var e=1,t=0;t<D.length;t++)(r=D[t])[1]==arguments[0]&&e++;for(var r=[e],t=0;t<arguments.length;t++){var a=arguments[t];if(M.is_vector(a))for(var n=0;n<a.length;n++)r.push(a[n]);else r.push(arguments[t])}D.push(r)};var H=["color: #3366FF","color: #CC33FF","color: #FF3366","color: #33FF66","color: #FFCC33"];t.print_telemetry=function(e){e||(e=1);for(var t=0,r={},a=Math.max(0,performance.now()-1e3*e),n=0;n<D.length;n++){var _=D[n];if(!((e=_[0])<a)){var s=String(_[1]);r[s]||(r[s]=H[t++%H.length]);for(var o=r[s],i=["%c"+(e/1e3).toFixed(6),o,s],l=2;l<_.length;l++)i.push(_[l]);T.log.apply(this,i)}}D.splice(0)},t.plot_telemetry=function(e){e||(e=1);for(var t={},r=Math.max(0,performance.now()-1e3*e),a=0;a<D.length;a++){var n=D[a];if(!((e=n[0])<r))for(var _=2;_<n.length;_++)o=String(n[1]),n.length>3&&(o+="_"+String(_-2)),t[o]||(t[o]=o+"\n"),t[o]+=String(e)+" "+n[_]+"\n"}var s="";for(var o in t)s+=t[o]+"\n\n";T.log(s),D.splice(0)},t.check_browser=function(e){var t=navigator.userAgent.toLowerCase(),r=function(e){return t.indexOf(e)>-1};switch(e.toLowerCase()){case"chrome":return r("mozilla")&&r("applewebkit")&&r("chrome");case"firefox":return r("mozilla")&&r("gecko")&&r("firefox");case"msie":return r("mozilla")&&r("trident")&&r("msie");case"opera":return r("opera")&&r("presto");case"safari":return r("mozilla")&&r("applewebkit")&&r("safari")&&!r("chrome");default:return!1}},t.check_finite=function(e){if(M.is_vector(e)){for(var t=0;t<e.length;t++)if(!isFinite(e[t]))return!1;return Boolean(e.length)}return!!isFinite(e)},t.assert_cons=function(e,t){e.constructor!=t&&M.panic("Type assertion failed: value <"+e+"> has type <"+e.constructor+">, required <"+t+">")},t.assert_struct=l,t.assert_struct_seq=function(e){z?l(e,G):z=!0,G=null!=e&&"object"==typeof e?M.clone_object_nr(e):e},t.fake_load=function(e,t,r,a,n){(e=e||null)||M.panic("Stage load callback is undefined"),t=t||5e3,r=r||0,(a=a||100)>100&&M.panic("Max percentage must be less than 100"),r<0&&M.panic("Min percentage must be greater than 0"),r>a&&M.panic("Max percentage must be greater than min percentage");var _=N.animate(r,a,t,function(t){var r=t.toFixed();if(e(r),100==r)return N.clear_animation(_),void(n&&n())})},t.nodegraph_to_dot=function(e,t){if(t)var r=function(e){var t="";switch(e.type){case"GEOMETRY_UV":t="\nuv_layer: "+e.data.value;break;case"TEXTURE_COLOR":case"TEXTURE_NORMAL":t="\ntexture: "+e.data.value.name+"\n("+e.data.value.img_filepath+")"}return""==t&&(t="\n---"),t},a=function(e,t){var a=t.type+"("+t.name+")",n=t.inputs;if(a+="\n\nINPUTS:",n.length)for(s=0;s<n.length;s++)a+="\n"+n[s].identifier+": ",n[s].is_linked?a+="linked":a+=n[s].default_value;else a+="\n---";var _=t.outputs;if(a+="\n\nOUTPUTS:",_.length)for(var s=0;s<_.length;s++)a+="\n"+_[s].identifier+": ",_[s].is_linked?a+="linked(default "+_[s].default_value+")":a+="not used";else a+="\n---";return a+="\n\nDATA:",a+=r(t)},n=function(t,r,a){var n=b.get_node_attr(e,t),_=b.get_node_attr(e,r),s=n.outputs[a[0]],o=_.inputs[a[1]];return s.identifier+"\n==>\n"+o.identifier};else var a=function(e,t){return t.type},n=function(t,r,a){var n=b.get_node_attr(e,t),_=b.get_node_attr(e,r),s=n.outputs[a[0]],o=_.inputs[a[1]];return s.identifier+"\n==>\n"+o.identifier};return b.debug_dot(e,a,n)},t.get_gl=function(){return C},t.cleanup=function(){B=null,Y={}},t.reset=function(){C=null}}),ne=o("__nodemat",function(e,t){function r(e,t,n,_,o){var i="";tt.check_active()&&(i=tt.get_active().uuid);var l=A(t,_,i,o);if(l in st)return st[l];var c={graph:null,id:l,cleanup_on_unload:!0};if(n||(it={},lt=0),"SHADOW"!=_&&"COLOR_ID"!=_){for(var u=Ke.create(),d=e.nodes,f=0;f<d.length;f++)if(null==ne(u,d[f],0,_,o))return st[l]=null,c;if(n&&-1==Z(e,u,"GROUP_OUTPUT","group"))return c;var m=Le(u),p=n?e.links:e.links.slice();if(!Ce(u,p,m))return c;if(n)return c.graph=u,c;for(f=0;f<p.length;f++)for(var h=p[f],g=I(h.from_node,u),E=I(h.to_node,u),O=0;O<g.length;O++)for(var k=0;k<E.length;k++){var L=g[O],C=E[k];if(!ke(u,L,C,Ke.get_node_attr(u,L),Ke.get_node_attr(u,C),h))return st[l]=null,c}M(u);var D=!1,U=-1;"GLOW"==_?U=Z(e,u,"B4W_GLOW_OUTPUT","material",!0):(-1==(U=Z(e,u,"OUTPUT","material",!1,!0))&&(U=Z(e,u,"OUTPUT_MATERIAL","material",!1,!0)),-1==U&&(U=Z(e,u,"OUTPUT_WORLD","material",!1,!0),D=!0)),-1==U&&(u=x(),U=0),S(u);var F=Ke.subgraph_node_conn(u,U,Ke.BACKWARD_DIR);D?(v(F),b(F,_),y(F),w(F)):(a(F),s(F,_)),R(F),P(F),q(F),N(F,_),We(F)}else{var B=r(e,t,n,"MAIN",o),G=Ke.clone(B.graph,function(e){var t=rt.clone_object_nr(e);return t.inputs=rt.clone_object_r(e.inputs),t.outputs=rt.clone_object_r(e.outputs),t});-1==(U=Z(e,G,"OUTPUT","material",!1,!0))&&(U=Z(e,G,"OUTPUT_MATERIAL","material",!1,!0)),T(G,U),R(F=Ke.subgraph_node_conn(G,U,Ke.BACKWARD_DIR))}return c.graph=F,st[l]=c,c}function a(e,t){var r=[];Ke.traverse(e,function(e,t){if("MATERIAL"==t.type||"MATERIAL_EXT"==t.type){var a={node_id:e,node:t};r.push(a)}});for(var a=0;a<r.length;++a){var _=r[a].node_id,s=r[a].node,o=Ke.gen_node_id(e);Ke.append_node(e,o,s.data.material_begin);var i=Ke.gen_node_id(e);Ke.append_node(e,i,s.data.material_end),Ke.append_edge(e,o,i,[4,2]);for(var l={5:["LIGHTING_APPLY",10],6:["LIGHTING_APPLY",6],7:["MATERIAL_END",3],8:["MATERIAL_END",4],9:["MATERIAL_END",5]},c=Ke.in_edge_count(e,_),u=[],d=[],f=[],m={},p=0;p<c;p++){var h=Ke.get_in_edge(e,_,p);h in m||(m[h]=0),A=Ke.get_edge_attr(e,h,_,m[h]++),u.push([h,_,A]);var v=l[A[1]];if(v)switch(v[0]){case"MATERIAL_END":d.push([h,i,[A[0],v[1]]]);break;case"LIGHTING_APPLY":f.push([h,[A[0],v[1]]])}else d.push([h,o,A])}for(n(e,s.data.value,o,i,f),p=0;p<u.length;p++)Ke.remove_edge_by_attr(e,u[p][0],u[p][1],u[p][2]);for(p=0;p<d.length;p++)Ke.append_edge(e,d[p][0],d[p][1],d[p][2]);for(var b=Ke.out_edge_count(e,_),g=[],y=[],E={},p=0;p<b;p++){var w=Ke.get_out_edge(e,_,p);w in E||(E[w]=0);var A=Ke.get_edge_attr(e,_,w,E[w]++);g.push([_,w,A]),y.push([i,w,A])}for(p=0;p<g.length;p++)Ke.remove_edge_by_attr(e,g[p][0],g[p][1],g[p][2]);for(p=0;p<y.length;p++)Ke.append_edge(e,y[p][0],y[p][1],y[p][2]);Ke.remove_node(e,_)}}function n(e,t,r,a,n){var s={name:"LIGHTING_AMBIENT",type:"LIGHTING_AMBIENT"},o=ne(e,s,0,null,null),i=o;_(e,r,o,"E"),_(e,r,o,"A"),_(e,r,o,"D");var l=tt.get_active(),c=Je.get_scene_objs(l,"LAMP",Je.DATA_ID_ALL);if(!t.use_shadeless)for(var u,d,f,m,p=0;p<c.length;p++){var h=c[p].light;u=ne(e,s={name:"LIGHTING_LAMP",type:"LIGHTING_LAMP"},0,null,null),_(e,i,d=ne(e,s={name:"LIGHTING_APPLY",type:"LIGHTING_APPLY"},0,null,null),"color"),_(e,i,d,"specular"),_(e,u,d,"ldir"),_(e,r,d,"normal"),_(e,r,d,"D"),_(e,r,d,"S"),_(e,u,d,"lcolorint"),_(e,r,u,"shadow_factor");var v="SPECULAR_"+t.specular_shader;if(s={name:v,type:v,use_tangent_shading:t.use_tangent_shading},f=ne(e,s,0,null,null),_(e,u,f,"ldir"),_(e,u,f,"lfac"),_(e,r,f,"normal"),_(e,f,d,"sfactor"),_(e,u,f,"norm_fac"),_(e,r,f,"sp_params"),"HEMI"==h.type)b="DIFFUSE_LAMBERT";else var b="DIFFUSE_"+t.diffuse_shader;_(e,u,m=ne(e,s={name:b,type:b,use_tangent_shading:t.use_tangent_shading},0,null,null),"ldir"),_(e,u,m,"lfac"),_(e,r,m,"normal"),_(e,u,m,"norm_fac"),_(e,m,d,"lfactor"),"DIFFUSE_LAMBERT"!=b&&_(e,r,m,"dif_params");for(var g=0;g<n.length;g++){var y=n[g][0],E=n[g][1];Ke.append_edge(e,y,d,E)}i=d}_(e,i,a,"color"),_(e,i,a,"specular")}function _(e,t,r,a){for(var n=Ke.get_node_attr(e,t),_=-1,s=Ke.get_node_attr(e,r).inputs,o=0;o<s.length;o++)if(a==s[o].identifier){_=o;break}if(-1!=_){for(var i=-1,l=n.outputs,o=0;o<l.length;o++)if(a==l[o].identifier){i=o;break}-1!=i&&(Ke.append_edge(e,t,r,[i,_]),l[i].is_linked=!0,s[_].is_linked=!0)}}function s(e,t){var r=[];Ke.traverse(e,function(e,t){if("OUTPUT_MATERIAL"==t.type){var a={node_id:e,node:t};r.push(a)}});for(var a=0;a<r.length;++a){var n=r[a].node_id,_=r[a].node,s=!1,i=!1,l=Ke.gen_node_id(e);Ke.append_node(e,l,_.data.output_surface);for(var c=Ke.in_edge_count(e,n),u=[],d=[],m={},p=0;p<c;p++){var h=Ke.get_in_edge(e,n,p);h in m||(m[h]=0);var v=Ke.get_edge_attr(e,h,n,m[h]++);switch(u.push([h,n,v]),v[1]){case St:s=!0,d.push([h,l,v]);break;case Lt:i=!0;var b=Ke.gen_node_id(e);Ke.append_node(e,b,_.data.displacement_bump),d.push([h,b,[v[0],0]])}}for(p=0;p<u.length;p++)Ke.remove_edge_by_attr(e,u[p][0],u[p][1],u[p][2]);for(p=0;p<d.length;p++)Ke.append_edge(e,d[p][0],d[p][1],d[p][2]);if(Ke.remove_node(e,n),s)i&&o(e,l,b),f(e);else{var g=Ke.get_node_attr(e,l);e.nodes=[0,g],e.edges=[]}}}function o(e,t,r){var a=Ke.subgraph_node_conn(e,t,Ke.BACKWARD_DIR),n=d(a);if(n.length){var s=O(Ke.subgraph_node_conn(e,r,Ke.BACKWARD_DIR));Ke.traverse(s,function(e,t){var r="displacement%join%"+t.name;t.name=r}),Ke.append_subgraph(s,a,[],[]);var o=-1;Ke.traverse(a,function(e,t){if("DISPLACEMENT_BUMP"==t.type)return o=e,1});for(var i=0;i<n.length;i++){var l=n[i],u=Ke.get_node_attr(a,l);_(a,o,l,"Normal"),c(u,"USE_NORMAL_IN",1)}}e.nodes=a.nodes,e.edges=a.edges}function c(e,t,r){for(var a=e.dirs,n=0;n<a.length;n++){var _=a[n];_[0]==t&&(_[1]=r)}}function d(e){var t=[];return Ke.traverse(e,function(e,r){for(var a=!1,n=r.inputs,_=0;_<n.length;_++)if("Normal"==n[_].identifier){a=!n[_].is_linked;break}a&&t.push(e)}),t}function f(e,t){var r=[];Ke.traverse(e,function(e,t){if("OUTPUT_SURFACE"==t.type){var a={node_id:e,node:t};r.push(a)}});var a=[];r.length&&Ke.traverse(e,function(e,t){if("MIX_SHADER"==t.type){var r={node_id:e,node:t};a.push(r)}});for(var n=0;n<r.length;++n){var _=r[n].node_id,s=r[n].node,o=Ke.gen_node_id(e);Ke.append_node(e,o,s.data.bsdf_begin);var i=Ke.gen_node_id(e);Ke.append_node(e,i,s.data.bsdf_end),Ke.append_edge(e,o,i,[4,2]);for(var l=Ke.in_edge_count(e,_),c=[],u=[],d={},f=0;f<l;f++){var m=Ke.get_in_edge(e,_,f),h=Ke.get_node_attr(e,m);m in d||(d[m]=0);var v=Ke.get_edge_attr(e,m,_,d[m]++);if(c.push([m,_,v]),u.push([m,o,v]),"BSDF_GLOSSY"==h.type||"BSDF_DIFFUSE"==h.type||"MIX_SHADER"==h.type||"EMISSION"==h.type||"BSDF_TRANSPARENT"==h.type){u.push([m,o,[1,1]]),u.push([m,o,[2,2]]),u.push([m,o,[3,3]]),u.push([m,o,[4,4]]),u.push([m,o,[5,5]]),u.push([m,o,[6,6]]),u.push([m,o,[7,7]]),u.push([m,o,[8,8]]),u.push([m,o,[9,9]]),u.push([m,o,[10,10]]);for(var b=0;b<a.length;++b)for(var g=a[b].node_id,y=Ke.in_edge_count(e,g),E=0;E<y;E++){var w=Ke.get_in_edge(e,g,E),A=Ke.get_node_attr(e,w),T=Ke.get_edge_attr(e,w,g,0);if(0!=T[1]&&("BSDF_GLOSSY"==A.type||"BSDF_DIFFUSE"==A.type||"MIX_SHADER"==A.type||"EMISSION"==A.type||"BSDF_TRANSPARENT"==A.type)){var x=1==T[1]?3:13;u.push([w,g,[1,x]]),u.push([w,g,[2,x+1]]),u.push([w,g,[3,x+2]]),u.push([w,g,[4,x+3]]),u.push([w,g,[5,x+4]]),u.push([w,g,[6,x+5]]),u.push([w,g,[7,x+6]]),u.push([w,g,[8,x+7]]),u.push([w,g,[9,x+8]]),u.push([w,g,[10,x+9]])}}}}for(p(e,s.data.value,o,i,[]),u.push([i,_,[0,0]]),f=0;f<c.length;f++)Ke.remove_edge_by_attr(e,c[f][0],c[f][1],c[f][2]);for(f=0;f<u.length;f++)Ke.append_edge(e,u[f][0],u[f][1],u[f][2])}}function p(e,t,r,a,n){var s={name:"LIGHTING_AMBIENT",type:"LIGHTING_AMBIENT"},o=ne(e,s,0,null,null),i=o;_(e,r,o,"E"),_(e,r,o,"A"),_(e,r,o,"D");for(var l,c,u,d=tt.get_active(),f=Je.get_scene_objs(d,"LAMP",Je.DATA_ID_ALL),m=0;m<f.length;m++){l=ne(e,s={name:"LIGHTING_LAMP",type:"LIGHTING_LAMP"},0,null,null),_(e,i,c=ne(e,s={name:"LIGHTING_APPLY",type:"LIGHTING_APPLY"},0,null,null),"color"),_(e,i,c,"specular"),_(e,l,c,"ldir"),_(e,r,c,"normal"),_(e,r,c,"D"),_(e,r,c,"S"),_(e,l,c,"lcolorint"),_(e,r,l,"shadow_factor");var p=t.bsdf_shader;_(e,l,u=ne(e,s={name:p,type:p},0,null,null),"ldir"),_(e,l,u,"lfac"),_(e,r,u,"normal"),_(e,l,u,"norm_fac"),_(e,r,u,"bsdf_params"),_(e,u,c,"lfactor"),_(e,u,c,"sfactor");for(var h=0;h<n.length;h++){var v=n[h][0],b=n[h][1];Ke.append_edge(e,v,c,b)}i=c}_(e,r,a,"bsdf_params"),_(e,r,a,"d_color"),_(e,r,a,"s_color"),_(e,r,a,"e_color"),_(e,r,a,"emission"),_(e,r,a,"a_color"),_(e,r,a,"alpha"),_(e,i,a,"color"),_(e,i,a,"specular")}function v(e,t){var r=[];Ke.traverse(e,function(e,t){if("OUTPUT_WORLD"==t.type){var a={node_id:e,node:t};r.push(a)}});for(var a=0;a<r.length;++a){var n=r[a].node_id,_=r[a].node,s=Ke.gen_node_id(e);Ke.append_node(e,s,_.data.output_world_surface);for(var o=Ke.in_edge_count(e,n),i=[],l=[],c={},u=0;u<o;u++){var d=Ke.get_in_edge(e,n,u);d in c||(c[d]=0);var f=Ke.get_edge_attr(e,d,n,c[d]++);switch(i.push([d,n,f]),f[1]){case St:l.push([d,s,f])}}for(u=0;u<i.length;u++)Ke.remove_edge_by_attr(e,i[u][0],i[u][1],i[u][2]);for(u=0;u<l.length;u++)Ke.append_edge(e,l[u][0],l[u][1],l[u][2]);Ke.remove_node(e,n)}}function b(e,t){var r=[];if(Ke.traverse(e,function(e,t){if("MIX_SHADER"==t.type||"ADD_SHADER"==t.type){var a={node_id:e,node:t};r.push(a)}}),r.length)for(var a={name:"RGB_WORLD_NODE",type:"RGB_WORLD_NODE",factor:.5},n=0;n<r.length;n++){var _=r[n].node_id,s=r[n].node;switch(a.name=s.name,a.fac=s.inputs[0].default_value,a.fac_is_linked=s.inputs[0].is_linked,a.color1_is_linked=s.inputs[1].is_linked,a.color2_is_linked=s.inputs[2].is_linked,s.type){case"ADD_SHADER":a.type="ADD_WORLD_RGB";break;case"MIX_SHADER":a.type="MIX_WORLD_RGB"}for(var o=ne(e,a,0,t,null),i=Ke.in_edge_count(e,_),l=[],c=[],u={},d=0;d<i;d++){var f=Ke.get_in_edge(e,_,d);f in u||(u[f]=0),g=Ke.get_edge_attr(e,f,_,u[f]++),l.push([f,_,g]),c.push([f,o,g])}for(d=0;d<l.length;d++)Ke.remove_edge_by_attr(e,l[d][0],l[d][1],l[d][2]);for(d=0;d<c.length;d++)Ke.append_edge(e,c[d][0],c[d][1],c[d][2]);for(var m=Ke.out_edge_count(e,_),p=[],h=[],v={},d=0;d<m;d++){var b=Ke.get_out_edge(e,_,d);b in v||(v[b]=0);var g=Ke.get_edge_attr(e,_,b,v[b]++);p.push([_,b,g]),h.push([o,b,g])}for(d=0;d<p.length;d++)Ke.remove_edge_by_attr(e,p[d][0],p[d][1],p[d][2]);for(d=0;d<h.length;d++)Ke.append_edge(e,h[d][0],h[d][1],h[d][2]);Ke.remove_node(e,_)}}function y(e){var t=-1,r=[],a=[],n=["OUTPUT_WORLD_SURFACE","BACKGROUND","RGB","VALUE","ADD_WORLD_RGB","MIX_WORLD_RGB","TEXTURE_ENVIRONMENT_EQUIRECTANGULAR","TEXTURE_ENVIRONMENT_MIRROR_BALL","GEOMETRY_NO","GEOMETRY_TRN","GEOMETRY_GL","GEOMETRY_IN","TEXTURE_COLOR","TEX_COORD_GE","TEX_COORD_OB","TEX_COORD_NO","COMBRGB","COMBHSV","CURVE_RGB","CURVE_VEC","B4W_LINEAR_TO_SRGB","B4W_NORMAL_VIEW","B4W_VECTOR_VIEW","B4W_SRGB_TO_LINEAR","B4W_REFLECT","B4W_CLAMP","B4W_TIME","B4W_SMOOTHSTEP","NORMAL","MAPPING","MATH_ADD","MATH_SUBTRACT","MATH_MULTIPLY","MATH_DIVIDE","MATH_SINE","MATH_COSINE","MATH_TANGENT","MATH_ARCSINE","MATH_ARCCOSINE","MATH_ARCTANGENT","MATH_POWER","MATH_LOGARITHM","MATH_MINIMUM","MATH_MAXIMUM","MATH_ROUND","MATH_LESS_THAN","MATH_GREATER_THAN","MATH_MODULO","MATH_ABSOLUTE","MIX_RGB_MIX","MIX_RGB_ADD","MIX_RGB_MULTIPLY","MIX_RGB_SUBTRACT","MIX_RGB_SCREEN","MIX_RGB_DIVIDE","MIX_RGB_DIFFERENCE","MIX_RGB_DARKEN","MIX_RGB_LIGHTEN","MIX_RGB_OVERLAY","MIX_RGB_DODGE","MIX_RGB_BURN","MIX_RGB_HUE","MIX_RGB_SATURATION","MIX_RGB_VALUE","MIX_RGB_COLOR","MIX_RGB_SOFT_LIGHT","MIX_RGB_LINEAR_LIGHT","SEPRGB","SEPHSV","VALTORGB","VECT_TRANSFORM","VECT_MATH_ADD","VECT_MATH_SUBTRACT","VECT_MATH_AVERAGE","VECT_MATH_DOT_PRODUCT","VECT_MATH_CROSS_PRODUCT","VECT_MATH_NORMALIZE"];for(Ke.traverse(e,function(e,a){var _=a.type;switch(n.indexOf(_)){case-1:var s={node_id:e,node:a};r.push(s);break;case 0:t=e}}),u=0;u<r.length;u++)for(var _=r[u].node_id,s=Ke.out_edge_count(e,_),o={},i=0;i<s;i++){var l=Ke.get_out_edge(e,_,i);l in o||(o[l]=0);var c=Ke.get_edge_attr(e,_,l,o[l]++);a.push([_,l,c])}for(var u=0;u<a.length;u++)Ke.remove_edge_by_attr(e,a[u][0],a[u][1],a[u][2]);if(a.length){var d=Ke.subgraph_node_conn(e,t,Ke.BACKWARD_DIR);e.nodes=d.nodes,e.edges=d.edges}}function w(e){var t=-1,r=[],a=[];for(Ke.traverse(e,function(e,a){switch(a.type){case"ADD_WORLD_RGB":case"MIX_WORLD_RGB":n={node_id:e,node:a},r.push(n);break;case"OUTPUT_WORLD_SURFACE":t=e;var n={node_id:e,node:a};r.push(n)}}),d=0;d<r.length;d++)for(var n=r[d].node_id,_=r[d].node,s=Ke.in_edge_count(e,n),o={},i=0;i<s;i++){var l=Ke.get_in_edge(e,n,i),c=Ke.get_node_attr(e,l);l in o||(o[l]=0);var u=Ke.get_edge_attr(e,l,n,o[l]++);"OUTPUT_WORLD_SURFACE"!=_.type&&0==u[1]||"ADD_WORLD_RGB"==c.type||"MIX_WORLD_RGB"==c.type||"BACKGROUND"==c.type||a.push([l,n,u])}for(var d=0;d<a.length;d++)Ke.remove_edge_by_attr(e,a[d][0],a[d][1],a[d][2]);if(a.length){var f=Ke.subgraph_node_conn(e,t,Ke.BACKWARD_DIR);e.nodes=f.nodes,e.edges=f.edges}}function A(e,t,r,a){switch(e+=r,t){case"GLOW":e+="11";case"COLOR_ID":case"SHADOW":e+="00";default:e+="10"}return a&&a.vc_name&&(e+=a.vc_name),a&&a.uv_name&&(e+=a.uv_name),e}function T(e,t){Ke.traverse_edges(e,function(r,a,n){var _=Ke.get_node_attr(e,a);a==t&&"Color"==_.inputs[n[1]].identifier&&Ke.remove_edge_by_attr(e,r,a,n)})}function x(){var e=Ke.create(),t={data:null,dirs:[],params:[],inputs:[{default_value:new Float32Array([0,0,0]),identifier:"Color",is_linked:!1,name:"Color"},{default_value:1,identifier:"Alpha",is_linked:!1,name:"Alpha"}],outputs:[],type:"OUTPUT",vparams:[]};return Ke.append_node(e,0,t),e}function O(e){return Ke.clone(e,re,Re)}function R(e){Ke.traverse(e,function(t,r){for(var a=r.inputs,n=r.outputs,_=0;_<a.length;_++)k(e,a[_],t,_,1);for(_=0;_<n.length;_++)k(e,n[_],t,_,0)})}function k(e,t,r,a,n){if(t.is_linked){var _=!0;Ke.traverse_edges(e,function(e,t,s){(!n&&e==r&&s[0]==a||n&&t==r&&s[1]==a)&&(_=!1)}),_&&(t.is_linked=!1)}}function N(e,t){var r=[];Ke.traverse_edges(e,function(a,n,_){var s=Ke.get_node_attr(e,a),o=Ke.get_node_attr(e,n),i=rt.is_vector(s.outputs[_[0]].default_value),l=rt.is_vector(o.inputs[_[1]].default_value);if(i!=l){var c,u={default_value:[0,0,0],identifier:"Vector",is_linked:!0,name:"Vector"},d={default_value:0,identifier:"Value",is_linked:!0,name:"Value"};i&&!l?c=Q("vector_to_scalar","B4W_VECTOSCAL",[u],[d]):!i&&l&&(c=Q("scalar_to_vector","B4W_SCALTOVEC",[d],[u])),ne(e,c,0,t,null),r.push([a,n,e.nodes[e.nodes.length-2],_])}});for(var a=0;a<r.length;++a)Ke.remove_edge_by_attr(e,r[a][0],r[a][1],r[a][3]),Ke.append_edge(e,r[a][0],r[a][2],[r[a][3][0],0]),Ke.append_edge(e,r[a][2],r[a][1],[0,r[a][3][1]])}function M(e){var t=[];Ke.traverse(e,function(r,a){switch(a.type){case"B4W_TRANSLUCENCY":Ke.traverse_edges(e,function(n,_,s){var o=Ke.get_node_attr(e,_);if(n==r&&"MATERIAL_EXT"==o.type){var i=s[0];"Translucency"==a.outputs[i].name&&t.push(n,_,[s[0]+1,s[1]+1])}})}});for(var r=0;r<t.length;r+=3)Ke.append_edge(e,t[r],t[r+1],t[r+2])}function I(e,t){var r=[];if(Ke.traverse(t,function(t,a){a.name==e.name&&r.push(t)}),r.length)return r;rt.panic("Node not found")}function S(e){var t=[];Ke.traverse(e,function(e,r){"B4W_PARALLAX"!=r.type&&"REROUTE"!=r.type||t.push(e,r)});for(var r=0;r<t.length;r+=2){var a=t[r],n=t[r+1];if("B4W_PARALLAX"==n.type)L(e,a,n);else if("REROUTE"==n.type){for(var _=Ke.get_in_edge(e,a,0),s=Ke.out_edge_count(e,a),o=[],i=[],l=[],c=0;c<s;c++){var u=Ke.get_out_edge(e,a,c),d=i.indexOf(u),f=d>=0?l[d]:0,m=Ke.get_edge_attr(e,a,u,f);if(m){var p=m[1],h=n.inputs[0].default_value,v=Ke.get_node_attr(e,u).inputs[p];switch(typeof h){case"number":if("object"==typeof v.default_value)for(var b=v.default_value,g=0;g<b.length;g++)b[g]=h;else"number"==typeof v.default_value&&(v.default_value=h);break;case"object":if("object"==typeof v.default_value)for(var b=v.default_value,g=0;g<b.length;g++)b[g]=h[g];else"number"==typeof v.default_value&&(v.default_value=.35*h[0]+.45*h[1]+.2*h[2])}}for(var y=n.outputs,g=0;g<y.length;g++)y[g].default_value=n.inputs[0].default_value;-1!=d?l[d]+=1:(i.push(u),l.push(1),o.push(a,u))}if(-1!=_)for(var E=Ke.get_edge_attr(e,_,a,0)[0],c=0;c<i.length;c++)for(g=0;g<l[c];g++){var w=Ke.get_edge_attr(e,a,i[c],g)[1];Ke.append_edge(e,_,i[c],[E,w])}for(c=0;c<o.length;c+=2)Ke.remove_edge(e,o[c],o[c+1],-1)}}}function L(e,t,r){var a=C(e,t,1);if(-1!=a){var n=Ke.get_node_attr(e,a);if(r.data=n.data,Ke.remove_edge(e,a,t,-1),0==Ke.out_edge_count(e,a)){var _=Ke.get_in_edge(e,a,0);-1!=_&&Ke.remove_edge(e,_,a,-1),Ke.remove_node(e,a)}}r.inputs.splice(1,1)}function C(e,t,r){for(var a=e.edges,n=0;n<a.length;n+=3)if(a[n+1]==t&&a[n+2][1]==r)return a[n];return-1}function P(e){F(e),Y(e),D(e)}function D(e,t){var r={};Ke.traverse(e,function(e,t){if("GEOMETRY_UV"==t.type||"UVMAP"==t.type||"TEX_COORD_UV"==t.type){var a=t.data.value;a in r||(r[a]=[]),r[a].push(e,t)}});for(var a in r){var n=r[a];if(n.length>2)for(var _=ne(e,U(a),0,t,null),s=Ke.get_node_attr(e,_),o=0;o<n.length;o+=2){for(var i=n[o],l=n[o+1],c=[],u={},d=Ke.out_edge_count(e,i),f=0;f<d;f++){var m=Ke.get_out_edge(e,i,f);m in u||(u[m]=0);var p=Ke.get_edge_attr(e,i,m,u[m]);u[m]++,c.push(i,m,p);var h=p.splice(0,p.length);switch(l.type){case"GEOMETRY_UV":h[0]=0,s.outputs[0].is_linked=!0;break;case"UVMAP":case"TEX_COORD_UV":h[0]=1,s.outputs[1].is_linked=!0}Ke.append_edge(e,_,m,h)}for(f=0;f<c.length;f+=3)Ke.remove_edge(e,c[f],c[f+1],0);Ke.remove_node(e,i)}}}function U(e){var t=Q("merged_uv","UV_MERGED",[],[{default_value:[0,0,0],identifier:"UV_geom",is_linked:!1,name:"UV_geom"},{default_value:[0,0,0],identifier:"UV_cycles",is_linked:!1,name:"UV_cycles"}]);return t.uv_layer=e,t}function F(e){var t=[];Ke.traverse(e,function(e,r){"GEOMETRY_VC"!=r.type&&"GEOMETRY_NO"!=r.type&&"GEOMETRY_FB"!=r.type&&"GEOMETRY_VW"!=r.type&&"GEOMETRY_GL"!=r.type&&"GEOMETRY_LO"!=r.type&&"GEOMETRY_OR"!=r.type&&"GEOMETRY_BF"!=r.type&&"GEOMETRY_IN"!=r.type||t.push(e,r)});for(var r=[],a=0;a<t.length;a+=2){for(var n=t[a],_=t[a+1],s=!0,o=0;o<r.length;o++)if(H(_,(f=r[o]).attr)){for(var i=[],l=Ke.out_edge_count(e,n),c=0;c<l;c++){var u=Ke.get_out_edge(e,n,c),d=Ke.get_edge_attr(e,n,u,0);i.push(n,u,d),Ke.append_edge(e,f.id,u,d)}for(c=0;c<i.length;c+=3)Ke.remove_edge(e,i[c],i[c+1],0);Ke.remove_node(e,n),s=!1;break}if(s){var f={id:n,attr:_};r.push(f)}}}function G(e){for(var t={},r=0;r<e.nodes.length;r+=2)t[n=e.nodes[r]]={ascs_ids:{},is_completed:!1};for(r=0;r<e.edges.length;r+=3){var a=e.edges[r];t[e.edges[r+1]].ascs_ids[a]=!0}for(var n in t)z(n,t);for(var n in t)t[n]=Object.keys(t[n].ascs_ids).map(function(e){return parseInt(e,10)});return t}function z(e,t){var r=t[e];if(!r.is_completed){var a=rt.clone_object_r(r);for(var n in r.ascs_ids){z(n,t);var _=t[n];for(var s in _.ascs_ids)a.ascs_ids[s]=!0}a.is_completed=!0,t[e]=a}}function Y(e){var t=[];if(Ke.traverse(e,function(e,r){"TEXTURE_COLOR"!=r.type&&"TEXTURE_NORMAL"!=r.type||t.push(e,r)}),t.length){for(var r=G(e),a=[],n=0;n<t.length;n+=2){for(var _=t[n],s=t[n+1],o=!0,i=0;i<a.length;i++)if(!((y=a[i]).merged_nodes.length>=3)&&H(s,y.attr)&&!(r[_].indexOf(y.id)>-1||r[y.id].indexOf(_)>-1)){for(var l=!1,c=0;c<y.merged_nodes.length;c++){var u=y.merged_nodes[c].id;if(r[_].indexOf(u)>-1||r[u].indexOf(_)>-1){l=!0;break}}if(!l){var d=[],f=Ke.in_edge_count(e,_),m={};for(c=0;c<f;c++)(O=Ke.get_in_edge(e,_,c))in m||(m[O]=0),b=Ke.get_edge_attr(e,O,_,m[O]++),d.push(O,_,b);var p=[],h=Ke.out_edge_count(e,_),v={};for(c=0;c<h;c++){(R=Ke.get_out_edge(e,_,c))in v||(v[R]=0);var b=Ke.get_edge_attr(e,_,R,v[R]++);p.push(_,R,b)}for(var g=d.concat(p),c=0;c<g.length;c+=3)Ke.remove_edge(e,g[c],g[c+1],0);Ke.remove_node(e,_),A={id:_,attr:s,edges_in:d,edges_out:p},y.merged_nodes.push(A),o=!1;break}}if(o){var y={id:_,attr:s,merged_nodes:[]};a.push(y)}}for(n=0;n<a.length;n++){for(var E=(y=a[n]).merged_nodes.length,i=0;i<E;i++){var w=y.merged_nodes[i],A=w.attr,T=w.edges_in,x=w.edges_out;for(y.attr.inputs[i+1].is_linked=A.inputs[0].is_linked,y.attr.inputs[i+1].default_value=A.inputs[0].default_value,y.attr.outputs[2*(i+1)].is_linked=A.outputs[0].is_linked,y.attr.outputs[2*(i+1)].default_value=A.outputs[0].default_value,y.attr.outputs[2*(i+1)+1].is_linked=A.outputs[1].is_linked,y.attr.outputs[2*(i+1)+1].default_value=A.outputs[1].default_value,c=0;c<T.length;c+=3){var O=T[c];(b=T[c+2])[1]+=i+1,Ke.append_edge(e,O,y.id,b)}for(c=0;c<x.length;c+=3){var R=x[c+1];(b=x[c+2])[0]+=2*(i+1),Ke.append_edge(e,y.id,R,b)}y.attr.dirs.push(["USE_uv"+(i+2),1])}Ke.remove_node(e,y.id),Ke.append_node(e,y.id,y.attr)}}}function H(e,t){if(e.type!==t.type)return!1;switch(e.type){case"GEOMETRY_VC":return e.data.value==t.data.value;case"GEOMETRY_NO":return W(e,t,"USE_NORMAL_IN");case"GEOMETRY_FB":case"GEOMETRY_VW":case"GEOMETRY_GL":case"GEOMETRY_LO":case"GEOMETRY_OR":case"GEOMETRY_BF":case"GEOMETRY_IN":return!0;case"TEXTURE_COLOR":case"TEXTURE_NORMAL":return e.data.bpy_uuid==t.data.bpy_uuid&&e.data.value.img_uuid==t.data.value.img_uuid;case"VALUE":case"RGB":return e.origin_name==t.origin_name;default:return!1}}function W(e,t,r){for(var a=e.dirs,n=-1,_=0;_<a.length;_++){var s=a[_];if(s[0]==r){n=s[1];break}}for(var o=t.dirs,i=-1,_=0;_<o.length;_++){var l=o[_];if(l[0]==r){i=l[1];break}}return n===i}function q(e){var t=[],r=[];Ke.traverse(e,function(e,a){"GEOMETRY_VC"==a.type&&t.push(e,a),"GEOMETRY_VW"==a.type&&r.push(e,a)}),V(e,t),X(e,r)}function V(e,t){for(var r=0;r<t.length;r+=2){for(var a=t[r],n=t[r+1],_=!1,s=[],o=[],i=[[],[],[]],l=Ke.out_edge_count(e,a),c=0;c<l;c++){var u=Ke.get_out_edge(e,a,c);if("SEPRGB"!=Ke.get_node_attr(e,u).type){_=!1;break}s.push(a,u);for(var d={},f=Ke.out_edge_count(e,u),m=0;m<f;m++){var p=Ke.get_out_edge(e,u,m);p in d||(d[p]=0);var h=Ke.get_edge_attr(e,u,p,d[p]++);s.push(u,p),i[h[0]].push(a,p,h)}o.push(u),_=!0}if(_){for(var v=0,b=0,c=0;c<i.length;c++)i[c].length&&(v++,b|=1<<2-c);if(v){for(n.type+=v,n.outputs=[],c=0;c<i.length;c++)if(i[c].length)for(n.outputs.push({default_value:0,identifier:"RGB"[c],is_linked:!0,name:"RGB"[c]}),m=0;m<i[c].length;m+=3)i[c][m+2][0]=rt.rgb_mask_get_channel_presence_index(b,c);for(c=0;c<s.length;c+=2)Ke.remove_edge(e,s[c],s[c+1],0);for(c=0;c<o.length;c++)Ke.remove_node(e,o[c]);for(c=0;c<i.length;c++)for(m=0;m<i[c].length;m+=3)Ke.append_edge(e,i[c][m],i[c][m+1],i[c][m+2])}}}}function X(e,t){for(var r=0;r<t.length;r+=2){for(var a=t[r],n=!0,_=[],s=Ke.out_edge_count(e,a),o=0;o<s;o++){var i=Ke.get_out_edge(e,a,o);if("B4W_REFLECT"==Ke.get_node_attr(e,i).type){var l=Ke.get_edge_attr(e,a,i,0),c=Ke.get_edge_attr(e,a,i,1);l&&1==l[1]||c&&1==c[1]?n=!1:_.push(a,i)}else n=!1}for(o=0;o<_.length;o+=2)K(e,_[o],_[o+1]);n&&Ke.remove_node(e,a)}}function K(e,t,r){var a=Ke.get_node_attr(e,r);a.type+="_WORLD",Ke.remove_edge(e,t,r,0),a.inputs.splice(0,1);var n=Ke.get_in_edge(e,r,0);n!=Ke.NULL_NODE&&(Ke.get_edge_attr(e,n,r,0)[1]=0)}function Z(e,t,r,a,n,_){for(var s=e.nodes,o=null,i=0;i<s.length;i++){var l=s[i];n?"GROUP"==l.type&&l.node_tree_name==r&&(o=l):l.type==r&&(o=l)}return o?I(o,t)[0]:(_||$e.error('No "'+r+'" node in node '+a),-1)}function Q(e,t,r,a){return{name:e,type:t,inputs:r,outputs:a}}function J(e,t,r,a){return{from_node:e,from_socket:t,to_node:r,to_socket:a}}function te(){return{name:"",origin_name:"",type:"",vparams:[],inputs:[],outputs:[],params:[],data:null,dirs:[]}}function re(e){var t=te();t.name=e.name,t.origin_name=e.origin_name,t.type=e.type;for(var r=t.vparams,a=e.vparams,n=0;n<a.length;n++){var _=a[n];r.push(xe(_))}for(var s=t.params,o=e.params,n=0;n<o.length;n++){var i=o[n];s.push(xe(i))}for(var l=t.inputs,c=e.inputs,n=0;n<c.length;n++){var u=c[n];l.push(ye(u))}for(var d=t.outputs,f=e.outputs,n=0;n<f.length;n++){var m=f[n];d.push(ye(m))}for(var p=t.dirs,h=e.dirs,n=0;n<h.length;n++){var v=h[n];p.push(v.slice())}return t.data=e.data,t}function ne(e,t,r,a,n){var _=t.name,s=t.name,o=t.type,i=[],l=[],c=[],u=[],d=null,f="uv_layer"in t?t.uv_layer||n&&n.uv_name||"":"",m="color_layer"in t?t.color_layer||n&&n.vc_name||"":"",p=[];switch(o){case"BSDF_ANISOTROPIC":case"BSDF_GLASS":case"BSDF_HAIR":case"BSDF_TRANSLUCENT":case"BSDF_REFRACTION":case"BSDF_TOON":case"BSDF_VELVET":case"SUBSURFACE_SCATTERING":case"AMBIENT_OCCLUSION":case"VOLUME_ABSORPTION":case"VOLUME_SCATTER":case"BLACKBODY":case"WAVELENGTH":case"SEPXYZ":case"COMBXYZ":case"LIGHT_FALLOFF":case"TEX_SKY":case"TEX_NOISE":case"TEX_WAVE":case"TEX_MUSGRAVE":case"TEX_GRADIENT":case"TEX_MAGIC":case"TEX_CHECKER":case"TEX_BRICK":case"WIREFRAME":case"TANGENT":case"LIGHT_PATH":case"ATTRIBUTE":case"HOLDOUT":case"HAIR_INFO":case"SCRIPT":l=we(t),c=Ae(t),$e.warn(o+" node is not fully supported.");break;case"BRIGHTCONTRAST":case"ADD_SHADER":l=we(t),c=Ae(t);break;case"MIX_SHADER":l.push(he(t,"Fac"));var h=he(t,"Shader"),v=h.is_linked;l.push(h);var b=he(t,"Shader_001");b||(b=he(t,"Shader.001"));var g=b.is_linked;l.push(b),l.push(ge("d_color1","d_color1",[0,0,0],v)),l.push(ge("d_roughness1","d_roughness1",0,v)),l.push(ge("s_color1","s_color1",[0,0,0],v)),l.push(ge("s_roughness1","s_roughness1",0,v)),l.push(ge("metalness1","metalness1",0,v)),l.push(ge("normal1","normal1",[0,0,0],v)),l.push(ge("e_color1","e_color1",[0,0,0],v)),l.push(ge("emission1","emission1",0,v)),l.push(ge("a_color1","a_color1",[0,0,0],v)),l.push(ge("alpha1","alpha1",1,v)),l.push(ge("d_color2","d_color2",[0,0,0],g)),l.push(ge("d_roughness2","d_roughness2",0,g)),l.push(ge("s_color2","s_color2",[0,0,0],g)),l.push(ge("s_roughness2","s_roughness2",0,g)),l.push(ge("metalness2","metalness2",0,g)),l.push(ge("normal2","normal2",[0,0,0],g)),l.push(ge("e_color2","e_color2",[0,0,0],g)),l.push(ge("emission2","emission2",0,g)),l.push(ge("a_color2","a_color2",[0,0,0],g)),l.push(ge("alpha2","alpha2",1,g));var y=ve(t,"Shader"),E=y.is_linked;c=[y,ge("d_color","d_color",[0,0,0],E),ge("d_roughness","d_roughness",0,E),ge("s_color","s_color",[0,0,0],E),ge("s_roughness","s_roughness",0,E),ge("metalness","metalness",0,E),ge("normal","normal",[0,0,0],E),ge("e_color","e_color",[0,0,0],E),ge("emission","emission",0,E),ge("a_color","a_color",[0,0,0],E),ge("alpha","alpha",1,E)];break;case"OBJECT_INFO":l=we(t),c=[];var w=ve(t,"Location"),A=ve(t,"Object Index"),T=ve(t,"Material Index"),x=ve(t,"Random");c.push(w),c.push(A),c.push(T),c.push(x),p.push(["USE_LOCATION_OUT",0|w.is_linked]),p.push(["USE_OBJ_IND_OUT",0|A.is_linked]),p.push(["USE_MAT_IND_OUT",0|T.is_linked]),p.push(["USE_RANDOM_OUT",0|x.is_linked]);break;case"UVMAP":if(f||(o="EMPTY_UV"),"EMPTY_UV"!=o){var O=ce("param_"+o+"_a"),R=ce("param_"+o+"_v");i.push(Te(O)),i.push(Te(R)),u.push(Te(R)),d={name:O,value:f}}c=Ae(t);break;case"UV_MERGED":var O=ce("param_UV_MERGED_a"),R=ce("param_UV_MERGED_v");i.push(Te(O)),i.push(Te(R)),c.push(ve(t,"UV_geom")),c.push(ve(t,"UV_cycles")),u.push(Te(R)),d={name:O,value:f};break;case"CAMERA":l=[],c=Ae(t);break;case"COMBRGB":case"COMBHSV":l=we(t),c=Ae(t);break;case"CURVE_RGB":case"CURVE_VEC":"CURVE_RGB"==o?(qe(t,0,0,1)&&p.push(["READ_R",1]),qe(t,1,0,1)&&p.push(["READ_G",1]),qe(t,2,0,1)&&p.push(["READ_B",1]),qe(t,3,0,1)&&p.push(["READ_A",1])):(qe(t,0,-1,1)&&p.push(["READ_R",1]),qe(t,1,-1,1)&&p.push(["READ_G",1]),qe(t,2,-1,1)&&p.push(["READ_B",1])),l=we(t),c=Ae(t),d={value:t};break;case"PARTICLE_INFO":l=we(t),c=Ae(t);for(var k=0;k<t.outputs.length;k++){var N=t.outputs[k],M=N.identifier,I=Te("v_param_PART_INFO_"+M.replace(" ",""));if(N.is_linked)switch(M){case"Size":p.push(["PART_INFO_SIZE",et.glsl_value(1)]);break;case"Age":p.push(["PART_INFO_AGE",et.glsl_value(1)]);break;case"Lifetime":p.push(["PART_INFO_LT",et.glsl_value(1)]);break;case"Location":p.push(["PART_INFO_LOC",et.glsl_value(1)]);break;case"Index":var S=Te("a_param_PART_INFO_"+N.identifier.replace(" ",""));d=S,p.push(["PART_INFO_IND",et.glsl_value(1)]);break;case"Velocity":p.push(["PART_INFO_VEL",et.glsl_value(1)]);break;case"Angular Velocity":p.push(["PART_INFO_A_VEL",et.glsl_value(1)])}"Age"!=M&&"Lifetime"!=M&&"Size"!=M&&(i.push(I),u.push(I))}S&&i.push(S);break;case"NEW_GEOMETRY":case"GEOMETRY":if(!ue(t))return!0;if(!(o=de(t,r)))return $e.error("Geometry output is not supported"),null;switch(o){case"GEOMETRY_UV":if(f||(o="EMPTY_UV"),"EMPTY_UV"!=o){var O=ce("param_GEOMETRY_UV_a"),R=ce("param_GEOMETRY_UV_v");i.push(Te(O)),i.push(Te(R)),u.push(Te(R)),d={name:O,value:f}}c.push(ve(t,"UV"));break;case"GEOMETRY_VC":if(m||(o="EMPTY_VC"),"EMPTY_VC"!=o){var L=ce("param_GEOMETRY_VC_a"),C=ce("param_GEOMETRY_VC_v");i.push(Te(L)),i.push(Te(C)),u.push(Te(C)),d={name:L,value:m}}c.push(ve(t,"Vertex Color"));break;case"GEOMETRY_NO":l.push(ge("Normal","Normal",[0,0,0],!1)),p.push(["USE_NORMAL_IN",0]),c.push(ve(t,"Normal"));break;case"GEOMETRY_TRN":o="GEOMETRY_NO",l.push(ge("Normal","Normal",[0,0,0],!1)),c.push(ve(t,"True Normal")),p.push(["USE_NORMAL_IN",0]),$e.warn("Geometry True Normal output is not fully supported.");break;case"GEOMETRY_FB":c.push(ve(t,"Front/Back"));break;case"GEOMETRY_VW":c.push(ve(t,"View"));break;case"GEOMETRY_GL":c.push(ve(t,"Global")||ve(t,"Position"));break;case"GEOMETRY_LO":c.push(ve(t,"Local"));break;case"GEOMETRY_OR":var P=ce("param_GEOMETRY_OR_v");i.push(Te(P)),c.push(ve(t,"Orco")),u.push(Te(P));break;case"GEOMETRY_IN":c.push(ve(t,"Incoming"));break;case"GEOMETRY_BF":c.push(ve(t,"Backfacing"))}break;case"TEX_COORD":if(!ue(t))return!0;switch(o=fe(t,r)){case"TEX_COORD_UV":if(f||(o="EMPTY_UV"),"EMPTY_UV"!=o){var O=ce("param_TEX_COORD_UV_a"),R=ce("param_TEX_COORD_UV_v");i.push(Te(O)),i.push(Te(R)),u.push(Te(R)),d={name:O,value:f}}c.push(ve(t,"UV"));break;case"TEX_COORD_NO":c.push(ve(t,"Normal"));break;case"TEX_COORD_GE":var D=ce("param_TEX_COORD_GE_v");i.push(Te(D)),c.push(ve(t,"Generated")),u.push(Te(D));break;case"TEX_COORD_OB":c.push(ve(t,"Object"));break;case"TEX_COORD_CA":c.push(ve(t,"Camera"));break;case"TEX_COORD_WI":c.push(ve(t,"Window"));break;case"TEX_COORD_RE":c.push(ve(t,"Reflection"))}break;case"GROUP":var U=t.node_tree_name;switch(U){case"B4W_LINEAR_TO_SRGB":if(!_e(t,[1],[1])){d=se(t,a,n);break}o="B4W_LINEAR_TO_SRGB";break;case"B4W_NORMAL_VIEW":case"B4W_VECTOR_VIEW":if(!_e(t,[1],[1])){d=se(t,a,n);break}o="B4W_VECTOR_VIEW";break;case"B4W_SRGB_TO_LINEAR":if(!_e(t,[1],[1])){d=se(t,a,n);break}o="B4W_SRGB_TO_LINEAR";break;case"B4W_REFLECT":if(!_e(t,[1,1],[1])){d=se(t,a,n);break}o="B4W_REFLECT";break;case"B4W_REFRACTION":if(!_e(t,[1,0],[1])){d=se(t,a,n);break}o="B4W_REFRACTION";break;case"B4W_PARALLAX":if(!_e(t,[1,1,0,0,0],[1])){d=se(t,a,n);break}Ye=ce("param_B4W_PARALLAX_texture"),u.push(Te(Ye)),o="B4W_PARALLAX";break;case"B4W_CLAMP":if(!_e(t,[1],[1])){d=se(t,a,n);break}o="B4W_CLAMP";break;case"B4W_TRANSLUCENCY":if(!_e(t,[0,0,0,0,0],[0])){d=se(t,a,n);break}o="B4W_TRANSLUCENCY";break;case"B4W_TIME":if(!_e(t,[],[0])){d=se(t,a,n);break}o="B4W_TIME";break;case"B4W_SMOOTHSTEP":if(!_e(t,[0,0,0],[0])){d=se(t,a,n);break}o="B4W_SMOOTHSTEP";break;case"B4W_GLOW_OUTPUT":o="B4W_GLOW_OUTPUT";break;default:d=se(t,a,n)}if(l=we(t),c=Ae(t),"B4W_TRANSLUCENCY"==U){var F=ge("TranslucencyParams","TranslucencyParams",[0,0,0,0]);F.is_linked=c[0].is_linked,c.push(F)}break;case"LAMP":var B=t.lamp;B?(B.uuid in it?p.push(["LAMP_INDEX",String(it[B.uuid])]):(it[B.uuid]=lt,p.push(["LAMP_INDEX",String(lt++)])),d=it):($e.error("There is no lamp in node: "+t.name),p.push(["LAMP_INDEX",-1])),c.push(ve(t,"Color")),c.push(ve(t,"Light Vector")),c.push(ve(t,"Distance")),c.push(ve(t,"Visibility Factor"));break;case"LIGHTING_AMBIENT":l=[ge("E","E",[0,0,0],!0),ge("A","A",[0,0,0],!0),ge("D","D",[0,0,0],!0)],c=[ge("color","color",[0,0,0],!0),ge("specular","specular",[0,0,0],!0)];break;case"LIGHTING_BEGIN":c=[ge("E","E",[0,0,0],!0),ge("A","A",[0,0,0],!0),ge("D","D",[0,0,0],!0),ge("S","S",[0,0,0],!0),ge("normal","normal",[0,0,0],!0),ge("dif_params","dif_params",[0,0],!0),ge("sp_params","sp_params",[0,0],!0),ge("shadow_factor","shadow_factor",0,!0),ge("translucency_color","translucency_color",0,!0),ge("translucency_params","translucency_params",[0,0,0,0],!0)];break;case"LIGHTING_END":l=[ge("color","color",[0,0,0],!0),ge("specular","specular",[0,0,0],!0)];break;case"LIGHTING_LAMP":l=[ge("shadow_factor","shadow_factor",0,!0)],c=[ge("ldir","ldir",[0,0,0],!0),ge("lfac","lfac",[0,0],!0),ge("lcolorint","lcolorint",[0,0,0],!0),ge("norm_fac","norm_fac",0,!0)];break;case"DIFFUSE_LAMBERT":l=[ge("ldir","ldir",[0,0,0],!0),ge("lfac","lfac",[0,0],!0),ge("normal","normal",[0,0,0],!0),ge("norm_fac","norm_fac",0,!0)],c=[ge("lfactor","lfactor",0,!0)],p.push(["MAT_USE_TBN_SHADING",0|t.use_tangent_shading]);break;case"DIFFUSE_FRESNEL":case"DIFFUSE_MINNAERT":case"DIFFUSE_OREN_NAYAR":case"DIFFUSE_TOON":l=[ge("ldir","ldir",[0,0,0],!0),ge("lfac","lfac",[0,0],!0),ge("normal","normal",[0,0,0],!0),ge("norm_fac","norm_fac",0,!0),ge("dif_params","dif_params",[0,0],!0)],c=[ge("lfactor","lfactor",0,!0)],p.push(["MAT_USE_TBN_SHADING",0|t.use_tangent_shading]);break;case"SPECULAR_BLINN":case"SPECULAR_PHONG":case"SPECULAR_COOKTORR":l=[ge("ldir","ldir",[0,0,0],!0),ge("lfac","lfac",[0,0],!0),ge("normal","normal",[0,0,0],!0),ge("norm_fac","norm_fac",0,!0),ge("sp_params","sp_params",[0,0],!0)],c=[ge("sfactor","sfactor",0,!0)],p.push(["MAT_USE_TBN_SHADING",0|t.use_tangent_shading]);break;case"SPECULAR_TOON":case"SPECULAR_WARDISO":l=[ge("ldir","ldir",[0,0,0],!0),ge("lfac","lfac",[0,0],!0),ge("normal","normal",[0,0,0],!0),ge("norm_fac","norm_fac",0,!0),ge("sp_params","sp_params",[0,0],!0)],c=[ge("sfactor","sfactor",0,!0)],p.push(["MAT_USE_TBN_SHADING",0|t.use_tangent_shading]);break;case"BSDF_COMPUTE":l=[ge("ldir","ldir",[0,0,0],!0),ge("lfac","lfac",[0,0],!0),ge("normal","normal",[0,0,0],!0),ge("norm_fac","norm_fac",0,!0),ge("bsdf_params","bsdf_params",[0,0,0,0],!0)],c=[ge("lfactor","lfactor",0,!0),ge("sfactor","sfactor",0,!0)];break;case"LIGHTING_APPLY":l=[ge("color","color",[0,0,0,0],!0),ge("specular","specular",[0,0,0],!0),ge("lfactor","lfactor",0,!0),ge("sfactor","sfactor",0,!0),ge("ldir","ldir",[0,0,0],!0),ge("normal","normal",[0,0,0],!0),ge("translucency_params","translucency_params",[0,0,0,0],!0),ge("D","D",[0,0,0],!0),ge("S","S",[0,0,0],!0),ge("lcolorint","lcolorint",[0,0,0],!0),ge("translucency_color","translucency_color",0,!0)],c=[ge("color","color",[0,0,0,0],!0),ge("specular","specular",[0,0,0],!0)];break;case"NORMAL":l=we(t),c=Ae(t);var G=ve(t,"Normal");u.push(Te(ce("param_NORMAL_Normal"),G.default_value,3));break;case"MAPPING":var j=t.vector_type;o="MAPPING",l.push(he(t,"Vector")),c.push(ve(t,"Vector"));var z=rt.f32(t.rotation),Y=rt.f32(t.scale),H=rt.f32(t.translation),W=Ze.create(),q=rt.euler_to_rotation_matrix(z,Ze.create());"TEXTURE"!=j&&"NORMAL"!=j||(Y[0]=Y[0]||1,Y[1]=Y[1]||1,Y[2]=Y[2]||1);var V=new Float32Array([Y[0],0,0,0,Y[1],0,0,0,Y[2]]);switch(Ze.multiply(q,V,W),W=rt.mat3_to_mat4(W,Qe.create()),j){case"POINT":W[12]=H[0],W[13]=H[1],W[14]=H[2];break;case"TEXTURE":W[12]=H[0],W[13]=H[1],W[14]=H[2],W=Qe.invert(W,W);break;case"NORMAL":Qe.invert(W,W),Qe.transpose(W,W)}switch(j){case"NORMAL":p.push(["MAPPING_IS_NORMAL",1]);case"TEXTURE":p.push(["MAPPING_TRS_MATRIX_DEF",1]),p.push(["MAPPING_TRS_MATRIX",et.glsl_value(W,16)]);break;case"POINT":0!==at.length(z)?(p.push(["MAPPING_TRS_MATRIX_DEF",1]),p.push(["MAPPING_TRS_MATRIX",et.glsl_value(W,16)])):(0!==at.sqrDist(Y,rt.VEC3_UNIT)&&(p.push(["MAPPING_SCALE_DEF",1]),p.push(["MAPPING_SCALE",et.glsl_value(Y,3)])),0!==at.length(H)&&(p.push(["MAPPING_TRANS_DEF",1]),p.push(["MAPPING_TRANS",et.glsl_value(H,3)])));break;case"VECTOR":0!==at.length(z)?(p.push(["MAPPING_TRS_MATRIX_DEF",1]),p.push(["MAPPING_TRS_MATRIX",et.glsl_value(W,16)])):0!==at.sqrDist(Y,rt.VEC3_UNIT)&&(p.push(["MAPPING_SCALE_DEF",1]),p.push(["MAPPING_SCALE",et.glsl_value(Y,3)]))}t.use_min&&(p.push(["MAPPING_MIN_CLIP_DEF",1]),p.push(["MAPPING_MIN_CLIP",et.glsl_value(t.min,3)])),t.use_max&&(p.push(["MAPPING_MAX_CLIP_DEF",1]),p.push(["MAPPING_MAX_CLIP",et.glsl_value(t.max,3)]));break;case"MATERIAL":case"MATERIAL_EXT":var X=[],K=[],Z=[],Q=[ge("E","E",[0,0,0],!0),ge("A","A",[0,0,0],!0),ge("D","D",[0,0,0],!0),ge("S","S",[0,0,0],!0),ge("normal","normal",[0,0,0],!0),ge("dif_params","dif_params",[0,0],!0),ge("sp_params","sp_params",[0,0],!0),ge("shadow_factor","shadow_factor",0,!0)],J=[ge("color","color",[0,0,0],!0),ge("specular","specular",[0,0,0],!0),ge("normal","normal",[0,0,0],!0)],$=[ve(t,"Color"),ve(t,"Alpha"),ve(t,"Normal")],ee=[];if((Be=he(t,"Color")).default_value.splice(3),Z.push(Be),l.push(Be),(Be=he(t,"Spec")).default_value.splice(3),Z.push(Be),l.push(Be),(Be=he(t,"DiffuseIntensity"))||(Be=he(t,"Refl")),Be.default_value=t.diffuse_intensity,Z.push(Be),l.push(Be),(ot=he(t,"Normal")).default_value.splice(3),Z.push(ot),l.push(ot),"MATERIAL_EXT"==o){(Be=he(t,"Emit"))||(Be=ge("Emit","Emit",0)),Z.push(Be),l.push(Be),(Be=he(t,"Translucency"))?(Be.default_value=0,Be.name="Translucency",Be.identifier="Translucency"):Be=ge("Translucency","Translucency",0),l.push(Be),(Be=he(t,"Translucency"))?(Be.default_value=[0,0,0,0],Be.name="TranslucencyParams",Be.identifier="TranslucencyParams"):Be=ge("TranslucencyParams","TranslucencyParams",[0,0,0,0]),l.push(Be);var te=he(t,"Reflectivity"),re=he(t,"Ray Mirror");if(te)Be=te,ae="Reflectivity";else if(re)Be=re,ae="Ray Mirror";else{Be=te;var ae="Reflectivity"}Be||(Be=ge(ae,ae,0)),l.push(Be),J.push(Be),(Be=he(t,"SpecTra"))||(Be=ge("SpecTra","SpecTra",0)),l.push(Be),J.push(Be),(Be=he(t,"Alpha"))||(Be=ge("Alpha","Alpha",t.alpha)),l.push(Be),J.push(Be),$.push(ve(t,"Diffuse")),$.push(ve(t,"Spec")),X.push(["MATERIAL_EXT",1]),K.push(["MATERIAL_EXT",1])}else Z.push(ge("emit_intensity","emit_intensity",0)),J.push(ge("reflect_factor","reflect_factor",0)),J.push(ge("specular_alpha","specular_alpha",0)),J.push(ge("alpha_in","alpha_in",0)),$.push(ge("diffuse_out","diffuse_out",0)),$.push(ge("spec_out","spec_out",0)),X.push(["MATERIAL_EXT",0]),K.push(["MATERIAL_EXT",0]);ee.push(Te(ce("param_MATERIAL_alpha"),t.alpha)),ee.push(Te(ce("param_MATERIAL_spec_alpha"),t.specular_alpha)),c=$,X.push(["USE_MATERIAL_NORMAL",0|ot.is_linked]),t.use_diffuse&&(X.push(["USE_MATERIAL_DIFFUSE",1]),K.push(["USE_MATERIAL_DIFFUSE",1])),t.use_specular&&K.push(["USE_MATERIAL_SPECULAR",1]);var oe,ie=[],le=0;switch(t.specular_shader){case"COOKTORR":case"PHONG":oe=t.specular_hardness;break;case"WARDISO":oe=t.specular_slope;break;case"TOON":oe=t.specular_toon_size,le=t.specular_toon_smooth;break;case"BLINN":oe=t.specular_ior,le=t.specular_hardness;break;default:$e.error("unsupported specular shader: "+t.specular_shader+' (material "'+t.material_name+'")'),oe=t.specular_hardness}var be,ye;switch(t.diffuse_shader){case"LAMBERT":be=0,ye=0;break;case"OREN_NAYAR":be=t.roughness,ye=0;break;case"FRESNEL":be=t.diffuse_fresnel,ye=t.diffuse_fresnel_factor;break;case"MINNAERT":be=t.darkness,ye=0;break;case"TOON":be=t.diffuse_toon_size,ye=t.diffuse_toon_smooth;break;default:$e.error("unsupported diffuse shader: "+t.diffuse_shader+' (material "'+t.material_name+'")'),be=0,ye=0}ie.push(Te(ce("param_MATERIAL_diffuse"),[be,ye],2)),ie.push(Te(ce("param_MATERIAL_spec"),[t.specular_intensity,oe,le],3)),X.push(["SHADELESS_MAT",t.use_shadeless?1:0]);var Ee={name:t.name,value:{specular_shader:t.specular_shader,diffuse_shader:t.diffuse_shader,use_shadeless:t.use_shadeless,use_tangent_shading:t.use_tangent_shading}},xe={name:"material_begin",type:"MATERIAL_BEGIN",inputs:Z,outputs:Q,params:ie,data:Ee,dirs:X,vparams:[]},Oe={name:"material_end",type:"MATERIAL_END",inputs:J,outputs:$,params:ee,data:Ee,dirs:K,vparams:[]};d={name:t.name,value:{specular_shader:t.specular_shader,diffuse_shader:t.diffuse_shader,use_shadeless:t.use_shadeless,use_tangent_shading:t.use_tangent_shading},material_begin:xe,material_end:Oe};break;case"BSDF_DIFFUSE":l=we(t),p.push(["USE_NORMAL_IN",0|l[2].is_linked]),c=[Re=ve(t,"BSDF"),ge("d_color","d_color",[0,0,0],ke=Re.is_linked),ge("d_roughness","d_roughness",0,ke),ge("s_color","s_color",[0,0,0],ke),ge("s_roughness","s_roughness",0,ke),ge("metalness","metalness",0,ke),ge("normal","normal",[0,0,0],ke),ge("e_color","e_color",[0,0,0],ke),ge("emisson","emisson",0,ke),ge("a_color","a_color",[0,0,0],ke),ge("alpha","alpha",1,ke)];break;case"BSDF_GLOSSY":l=we(t),p.push(["USE_NORMAL_IN",0|l[2].is_linked]),c=[Re=ve(t,"BSDF"),ge("d_color","d_color",[0,0,0],ke=Re.is_linked),ge("d_roughness","d_roughness",0,ke),ge("s_color","s_color",[0,0,0],ke),ge("s_roughness","s_roughness",0,ke),ge("metalness","metalness",1,ke),ge("normal","normal",[0,0,0],ke),ge("e_color","e_color",[0,0,0],ke),ge("emisson","emisson",0,ke),ge("a_color","a_color",[0,0,0],ke),ge("alpha","alpha",1,ke)];break;case"BSDF_TRANSPARENT":l=we(t);var Re=ve(t,"BSDF"),ke=Re.is_linked;c=[Re,ge("d_color","d_color",[0,0,0],ke),ge("d_roughness","d_roughness",0,ke),ge("s_color","s_color",[0,0,0],ke),ge("s_roughness","s_roughness",0,ke),ge("metalness","metalness",0,ke),ge("normal","normal",[0,0,0],ke),ge("e_color","e_color",[0,0,0],ke),ge("emisson","emisson",0,ke),ge("a_color","a_color",[0,0,0],ke),ge("alpha","alpha",1,ke)];break;case"EMISSION":l=we(t);var Ne=ve(t,"Emission"),Me=Ne.is_linked;c=[Ne,ge("d_color","d_color",[0,0,0],Me),ge("d_roughness","d_roughness",0,Me),ge("s_color","s_color",[0,0,0],Me),ge("s_roughness","s_roughness",0,Me),ge("metalness","metalness",1,Me),ge("normal","normal",[0,0,0],Me),ge("e_color","e_color",[0,0,0],Me),ge("emisson","emisson",1,Me),ge("a_color","a_color",[0,0,0],ke),ge("alpha","alpha",1,ke)];break;case"MATH":switch(t.operation){case"ADD":o="MATH_ADD";break;case"SUBTRACT":o="MATH_SUBTRACT";break;case"MULTIPLY":o="MATH_MULTIPLY";break;case"DIVIDE":o="MATH_DIVIDE";break;case"SINE":o="MATH_SINE";break;case"COSINE":o="MATH_COSINE";break;case"TANGENT":o="MATH_TANGENT";break;case"ARCSINE":o="MATH_ARCSINE";break;case"ARCCOSINE":o="MATH_ARCCOSINE";break;case"ARCTANGENT":o="MATH_ARCTANGENT";break;case"POWER":o="MATH_POWER";break;case"LOGARITHM":o="MATH_LOGARITHM";break;case"MINIMUM":o="MATH_MINIMUM";break;case"MAXIMUM":o="MATH_MAXIMUM";break;case"ROUND":o="MATH_ROUND";break;case"LESS_THAN":o="MATH_LESS_THAN";break;case"GREATER_THAN":o="MATH_GREATER_THAN";break;case"MODULO":o="MATH_MODULO";break;case"ABSOLUTE":o="MATH_ABSOLUTE";break;default:return $e.error("Unsupported MATH operation: "+t.operation),null}p.push(["MATH_USE_CLAMP",Number(t.use_clamp)]),l=we(t),c=Ae(t);break;case"MIX_RGB":switch(t.blend_type){case"MIX":o="MIX_RGB_MIX";break;case"ADD":o="MIX_RGB_ADD";break;case"MULTIPLY":o="MIX_RGB_MULTIPLY";break;case"SUBTRACT":o="MIX_RGB_SUBTRACT";break;case"SCREEN":o="MIX_RGB_SCREEN";break;case"DIVIDE":o="MIX_RGB_DIVIDE";break;case"DIFFERENCE":o="MIX_RGB_DIFFERENCE";break;case"DARKEN":o="MIX_RGB_DARKEN";break;case"LIGHTEN":o="MIX_RGB_LIGHTEN";break;case"OVERLAY":o="MIX_RGB_OVERLAY";break;case"DODGE":o="MIX_RGB_DODGE";break;case"BURN":o="MIX_RGB_BURN";break;case"HUE":o="MIX_RGB_HUE";break;case"SATURATION":o="MIX_RGB_SATURATION";break;case"VALUE":o="MIX_RGB_VALUE";break;case"COLOR":o="MIX_RGB_COLOR";break;case"SOFT_LIGHT":o="MIX_RGB_SOFT_LIGHT";break;case"LINEAR_LIGHT":o="MIX_RGB_LINEAR_LIGHT";break;default:return $e.error("Unsupported MIX_RGB blend type: "+t.blend_type),null}p.push(["MIX_RGB_USE_CLAMP",Number(t.use_clamp)]),l=we(t),c=Ae(t);break;case"MIX_WORLD_RGB":case"ADD_WORLD_RGB":l=[ge("Factor","Factor",t.fac,t.fac_is_linked),ge("Color1","Color1",[0,0,0],t.color1_is_linked),ge("Color2","Color1",[0,0,0],t.color2_is_linked)],c=[ge("Color","Color",[0,0,0],!0)];break;case"OUTPUT":l=we(t),c=[];break;case"OUTPUT_MATERIAL":l=we(t),c=[];var Ie=(Ce=he(t,"Surface")).is_linked,Se={name:"output_surface",type:"OUTPUT_SURFACE",inputs:[Ce],outputs:[],params:[],data:{value:{bsdf_shader:"BSDF_COMPUTE"},bsdf_begin:{name:"bsdf_begin",type:"BSDF_BEGIN",inputs:[Ce,ge("d_color","d_color",[0,0,0],Ie),ge("d_roughness","d_roughness",0,Ie),ge("s_color","s_color",[0,0,0],Ie),ge("s_roughness","s_roughness",0,Ie),ge("metalness","metalness",0,Ie),ge("normal","normal",[0,0,0],Ie),ge("e_color","e_color",[0,0,0],Ie),ge("emission","emission",0,Ie),ge("a_color","a_color",[0,0,0],Ie),ge("alpha","alpha",0,Ie)],outputs:[ge("E","E",[0,0,0],!0),ge("A","A",[0,0,0],!0),ge("D","D",[0,0,0],!0),ge("S","S",[0,0,0],!0),ge("normal","normal",[0,0,0],!0),ge("bsdf_params","bsdf_params",[0,0,0,0],!0),ge("shadow_factor","shadow_factor",0,!0),ge("d_color","d_color",[0,0,0],!0),ge("s_color","s_color",[0,0,0],!0),ge("e_color","e_color",[0,0,0],!0),ge("emission","emission",0,!0),ge("a_color","a_color",[0,0,0],!0),ge("alpha","alpha",0,!0)],params:[],data:null,dirs:[],vparams:[]},bsdf_end:{name:"bsdf_end",type:"BSDF_END",inputs:[ge("color","color",[0,0,0],!0),ge("specular","specular",[0,0,0],!0),ge("normal","normal",[0,0,0],!0),ge("bsdf_params","bsdf_params",[0,0,0,0],!0),ge("d_color","d_color",[0,0,0],!0),ge("s_color","s_color",[0,0,0],!0),ge("e_color","e_color",[0,0,0],!0),ge("emission","emission",0,!0),ge("a_color","a_color",[0,0,0],!0),ge("alpha","alpha",0,!0)],outputs:[ge("color","color",[0,0,0],Ie)],params:[],data:null,dirs:[],vparams:[]}},dirs:[],vparams:[]},Le={name:"displacement_bump",type:"DISPLACEMENT_BUMP",inputs:[ge("Height","Height",0,!0)],outputs:[ge("Normal","Normal",[0,0,0],!1)],params:[],data:null,dirs:[],vparams:[]};d={name:t.name,output_surface:Se,displacement_bump:Le};break;case"OUTPUT_WORLD":l=we(t),c=Ae(t);var Ce=he(t,"Surface"),Se={name:"output_world_surface",type:"OUTPUT_WORLD_SURFACE",inputs:[Ce],outputs:[],params:[],data:null,dirs:[],vparams:[]};d={name:t.name,output_world_surface:Se};break;case"RGB":Xe={name:"-1",value:Ve=t.name},u.push(Xe),c.push(ve(t,"Color"));break;case"SEPRGB":case"SEPHSV":l=we(t),c=Ae(t);break;case"TEX_ENVIRONMENT":(Pe=t.image)?(o="TEXTURE_ENVIRONMENT_"+t.projection,"NONE"==t.color_space?p.push(["NON_COLOR",1]):p.push(["NON_COLOR",0]),l.push(he(t,"Vector")),p.push(["USE_VECTOR_IN",0|l[0].is_linked]),c.push(ve(t,"Color")),Ye=ce("param_TEXTURE_texture"),u.push(Te(Ye)),(He=nt.create_texture(nt.TT_RGBA_INT,!1)).repeat=!0,He.source="IMAGE",ct.anisotropic_available&&(He.anisotropic_filtering=16),nt.append_img_info(He,Pe),d={bpy_name:t.name,bpy_uuid:"",name:Ye,value:He}):o="TEXTURE_EMPTY";break;case"TEX_IMAGE":var Pe=t.image;if(Pe){for(o="TEXTURE_COLOR","NONE"==t.color_space?p.push(["NON_COLOR",1]):p.push(["NON_COLOR",0]),p.push(["CONVERT_UV",0]),Fe=0;Fe<4;++Fe)Fe?(Be=ge("Vector"+Fe,"Vector"+Fe,[0,0,0],!1),Ge=ge("Color"+Fe,"Color"+Fe,[0,0,0],!1),je=ge("Alpha"+Fe,"Alpha"+Fe,0,!1)):(Be=he(t,"Vector"),Ge=ve(t,"Color"),je=ve(t,"Alpha")),l.push(Be),c.push(Ge),c.push(je);Ye=ce("param_TEXTURE_texture"),u.push(Te(Ye)),(He=nt.create_texture(nt.TT_RGBA_INT,!1)).repeat="REPEAT"==t.extension,He.source="IMAGE",nt.append_img_info(He,Pe),d={bpy_name:t.name,bpy_uuid:"",name:Ye,value:He}}else o="TEXTURE_EMPTY";break;case"TEXTURE":if("TEXTURE_EMPTY"==(o=pe(t)))c.push(ve(t,"Color")),c.push(ve(t,"Normal")),c.push(ve(t,"Value"));else if("TEXTURE_ENVIRONMENT_CUBE"==o)l.push(he(t,"Vector")),c.push(ve(t,"Color")),c.push(ve(t,"Value"));else{if("TEXTURE_NORMAL"==o&&"ENVIRONMENT_MAP"==t.texture.type)return $e.error("Wrong output for ENVIRONMENT_MAP texture: "+t.name),null;if("TEXTURE_COLOR"==o){var De=!1,Ue=t.texture.image;!Ue||"Non-Color"!=Ue.colorspace_settings_name&&"Non-Colour Data"!=Ue.colorspace_settings_name||(De=!0),p.push(["NON_COLOR",Number(De)]),p.push(["CONVERT_UV",1])}for(var Fe=0;Fe<4;++Fe){var Be,Ge,je,ze="TEXTURE_COLOR"==o?"Color":"Normal";Fe?(Be=ge("Vector"+Fe,"Vector"+Fe,[0,0,0],!1),Ge=ge(ze+Fe,ze+Fe,[0,0,0],!1),je=ge("Value"+Fe,"Value"+Fe,0,!1)):(Be=he(t,"Vector"),Ge=ve(t,ze),je=ve(t,"Value")),l.push(Be),c.push(Ge),c.push(je)}}if("TEXTURE_EMPTY"!=o){var Ye=ce("param_TEXTURE_texture");u.push(Te(Ye));var He=t.texture._render;d={bpy_name:t.texture.name,bpy_uuid:t.texture.uuid,name:Ye,value:He}}break;case"VALTORGB":l=we(t),c=Ae(t),d={value:t};var We=t.color_ramp.interpolation;"CONSTANT"!=We&&"LINEAR"!=We&&$e.warn("Color Ramp node is not fully supported.");break;case"VALUE":o="VALUE";var Ve=t.name,Xe={name:"-1",value:Ve};u.push(Xe),c.push(ve(t,"Value"));break;case"VECT_MATH":switch(t.operation){case"ADD":o="VECT_MATH_ADD";break;case"SUBTRACT":o="VECT_MATH_SUBTRACT";break;case"AVERAGE":o="VECT_MATH_AVERAGE";break;case"DOT_PRODUCT":o="VECT_MATH_DOT_PRODUCT";break;case"CROSS_PRODUCT":o="VECT_MATH_CROSS_PRODUCT";break;case"NORMALIZE":o="VECT_MATH_NORMALIZE";break;default:return $e.error("Unsupported VECT_MATH operation: "+t.operation),null}l=we(t),c=Ae(t);break;case"VECT_TRANSFORM":switch(t.vector_type){case"POINT":p.push(["VECTOR_TYPE",et.glsl_value(pt)]);break;case"VECTOR":p.push(["VECTOR_TYPE",et.glsl_value(ht)]);break;case"NORMAL":p.push(["VECTOR_TYPE",et.glsl_value(vt)]);break;default:return $e.error("Unsupported VECT_TRANSFORM vector_type: "+t.vector_type),null}var Je=t.convert_from,tt=t.convert_to,_t=bt;if("WORLD"==Je)if("WORLD"==tt)_t=bt;else if("OBJECT"==tt)_t=gt;else{if("CAMERA"!=tt)return $e.error("Unsupported VECT_TRANSFORM convert_to: "+t.convert_to),null;_t=yt}else if("OBJECT"==Je)if("WORLD"==tt)_t=Et;else if("OBJECT"==tt)_t=wt;else{if("CAMERA"!=tt)return $e.error("Unsupported VECT_TRANSFORM convert_to: "+t.convert_to),null;_t=At}else{if("CAMERA"!=Je)return $e.error("Unsupported VECT_TRANSFORM convert_from: "+t.convert_from),null;if("WORLD"==tt)_t=Tt;else if("OBJECT"==tt)_t=xt;else{if("CAMERA"!=tt)return $e.error("Unsupported VECT_TRANSFORM convert_to: "+t.convert_to),null;_t=Ot}}p.push(["CONVERT_TYPE",et.glsl_value(_t)]),l=we(t),c=Ae(t);break;case"NORMAL_MAP":var st=Rt;switch(t.space){case"TANGENT":st=Rt;break;case"OBJECT":st=kt;break;case"WORLD":st=Nt;break;case"BLENDER_OBJECT":st=Mt;break;case"BLENDER_WORLD":st=It;break;default:return $e.error("Unsupported NORMAL_MAP space: "+t.space),null}p.push(["SPACE",et.glsl_value(st)]),l.push(he(t,"Strength")),l.push(he(t,"Color")),l.push(ge("Normal","Normal",[0,0,0],!1)),p.push(["USE_NORMAL_IN",0]),c.push(ve(t,"Normal"));break;case"FRESNEL":ot=he(t,"Normal"),l.push(he(t,"IOR")),l.push(ot),c.push(ve(t,"Fac")),p.push(["USE_FRESNEL_NORMAL",0|ot.is_linked]);break;case"LAYER_WEIGHT":ot=he(t,"Normal"),l.push(he(t,"Blend")),l.push(ot),c=Ae(t),p.push(["USE_NORMAL_IN",0|ot.is_linked]);break;case"BUMP":var ot=he(t,"Normal");p.push(["INVERT",t.invert?1:0]),p.push(["USE_NORMAL_IN",0|ot.is_linked]),l=we(t),c=Ae(t);break;case"BACKGROUND":default:l=we(t),c=Ae(t)}var ut={name:_,origin_name:s,type:o,vparams:i,inputs:l,outputs:c,params:u,data:d,dirs:p},dt=Ke.gen_node_id(e);return Ke.append_node(e,dt,ut),"GEOMETRY"!=t.type&&"TEX_COORD"!=t.type&&"NEW_GEOMETRY"!=t.type||!me(t,r)||null!=ne(e,t,++r,a,n)?dt:null}function _e(e,t,r){for(var a=e.inputs,n=e.outputs,_=e.node_tree_name,s=0;s<t.length;s++){var o=a[s],i=t[s];if(!o||o.default_value instanceof Array!=i)return $e.warn('Wrong inputs for custom node group "'+e.name+'" of type: "',_,'".Processing as general node group.'),!1}for(s=0;s<r.length;s++){var l=n[s],c=r[s];if(!l||l.default_value instanceof Array!=c)return $e.warn('Wrong outputs for custom node group "'+e.name+'" of type: "',_,'".Processing as general node group.'),!1}return!0}function se(e,t,a){var n=le(e.node_group.node_tree),_=e.node_tree_name;if("B4W_REPLACE"==_||"B4W_LEVELS_OF_QUALITY"==_){var s=Q("Group input","GROUP_INPUT",[],e.inputs),o=Q("Group output","GROUP_OUTPUT",e.outputs,[]),i=null;i="B4W_REPLACE"==_||"B4W_LEVELS_OF_QUALITY"==_&&(ct.quality==Ve.P_LOW||ct.force_low_quality_nodes)?J(s,s.outputs[1],o,o.inputs[0]):J(s,s.outputs[0],o,o.inputs[0]),n.nodes=[s,o],n.links=[i]}return Se(e.name,n),{node_group_graph:r(n,e.node_group.uuid,!0,t,a).graph,node_group_links:n.links}}function oe(){_t={}}function ie(e){var t=typeof e;return"string"!=t&&"number"!=t&&"boolean"!=t&&e?rt.clone_object_nr(e):e}function le(e){var t={};for(var r in e)if("links"==r||"nodes"==r){t[r]=[];for(var a=0;a<e[r].length;a++){t[r][a]={};for(var n in e[r][a])if("links"==r){t[r][a][n]={};for(var _ in e[r][a][n])t[r][a][n][_]=ie(e[r][a][n][_])}else t[r][a][n]=ie(e[r][a][n])}}else t[r]=ie(e[r]);return t}function ce(e){_t[e]||(_t[e]=0);var t=e+"_"+_t[e];return t=t.replace(/ /g,"_").replace(/\//g,"_"),_t[e]++,t}function ue(e){for(var t=e.outputs,r=0;r<t.length;r++)if(t[r].is_linked)return!0;return!1}function de(e,t){for(var r=e.outputs,a=0,n=0;n<r.length;n++){var _=r[n];if(_.is_linked&&!(a++<t))switch(_.identifier){case"UV":return"GEOMETRY_UV";case"Vertex Color":return"GEOMETRY_VC";case"Normal":return"GEOMETRY_NO";case"True Normal":return"GEOMETRY_TRN";case"Front/Back":return"GEOMETRY_FB";case"View":return"GEOMETRY_VW";case"Global":case"Position":return"GEOMETRY_GL";case"Local":return"GEOMETRY_LO";case"Orco":return"GEOMETRY_OR";case"Incoming":return"GEOMETRY_IN";case"Backfacing":return"GEOMETRY_BF";default:return null}}}function fe(e,t){for(var r=e.outputs,a=0,n=0;n<r.length;n++){var _=r[n];if(_.is_linked&&!(a++<t))switch(_.identifier){case"Camera":return"TEX_COORD_CA";case"Generated":return"TEX_COORD_GE";case"Normal":return"TEX_COORD_NO";case"Object":return"TEX_COORD_OB";case"Reflection":return"TEX_COORD_RE";case"UV":return"TEX_COORD_UV";case"Window":return"TEX_COORD_WI";default:return null}}}function me(e,t){for(var r=e.outputs,a=0,n=0;n<r.length;n++)if(r[n].is_linked&&a++>t)return!0;return!1}function pe(e){if(!e.texture||!e.texture._render)return"TEXTURE_EMPTY";for(var t=e.outputs,r=!1,a=!1,n=!1,_=0;_<t.length;_++){var s=t[_];if(s.is_linked)switch(s.identifier){case"Color":r=!0;break;case"Normal":a=!0;break;case"Value":n=!0;break;default:rt.panic("Unknown texture output")}}return r?(a&&$e.warn('Node "'+e.name+'" has both Color and Normal outputs. Normal will be omitted.'),"ENVIRONMENT_MAP"==e.texture.type?"TEXTURE_ENVIRONMENT_CUBE":"TEXTURE_COLOR"):a?"TEXTURE_NORMAL":n?"ENVIRONMENT_MAP"==e.texture.type?"TEXTURE_ENVIRONMENT_CUBE":"TEXTURE_COLOR":void 0}function he(e,t){for(var r=e.inputs,a=0;a<r.length;a++){var n=r[a];if(n.identifier==t)return be(n)}return null}function ve(e,t){for(var r=e.outputs,a=0;a<r.length;a++){var n=r[a];if(n.identifier==t)return be(n)}return null}function be(e){return{name:e.name,identifier:e.identifier,is_linked:e.is_linked,default_value:Ee(e.default_value)}}function ge(e,t,r,a){return{name:e,identifier:t,is_linked:a,default_value:r}}function ye(e){return ge(e.name,e.identifier,e.default_value,e.is_linked)}function Ee(e){return rt.is_vector(e)?e.slice(0):e}function we(e){for(var t=[],r=0;r<e.inputs.length;r++){var a=be(e.inputs[r]);a.default_value.length&&a.default_value.splice(3),t.push(a)}return t}function Ae(e){for(var t=[],r=0;r<e.outputs.length;r++){var a=be(e.outputs[r]);t.push(a)}return t}function Te(e,t,r){if(null===t||void 0===t)a=null;else var a=et.glsl_value(t,r);return{name:e,value:a}}function xe(e){return{name:e.name,value:e.value}}function Oe(e){return e=e.replace(/(,)/g,"$1 "),e=e.replace(/(^|[^0-9]|\s)(0\.0)($|[^0-9]|\s)/g,"$1_0_0$3"),e=e.replace(/(^|[^0-9]|\s)(1\.0)($|[^0-9]|\s)/g,"$1_1_0$3"),e=e.replace(/\s+/g,"")}function Re(e){return e.slice()}function ke(e,t,r,a,n,_){for(var s=[],o=_.from_socket.identifier,i=_.to_socket.identifier,l=a.outputs,c=0;c<l.length;c++)if(l[c].identifier==o){s.push(c);break}for(var u=n.inputs,c=0;c<u.length;c++)if(u[c].identifier==i){s.push(c);break}return 2==s.length&&Ke.append_edge(e,t,r,s),!0}function Ne(e){for(var t=[],r=[],a=[],n=[],_=[],s=[],o=0;o<e.inputs.length;o++){var i=e.inputs[o];if(i.is_linked)t.push(null),r.push(null);else{t.push(ce("in_"+e.type+"_"+Me(i.identifier)));var l=et.glsl_value(i.default_value,0);ct.shader_constants_hack&&(e.type.indexOf("MIX_RGB_")>=0&&("Color1"==i.identifier||"Color2"==i.identifier||"Fac"==i.identifier)||e.type.indexOf("MATH_")>=0&&("Value"==i.identifier||"Value_001"==i.identifier||"Value.001"==i.identifier)||e.type.indexOf("VECT_MATH_")>=0&&("Vector_001"==i.identifier||"Vector.001"==i.identifier)||e.type.indexOf("LIGHTING_APPLY")>=0||e.type.indexOf("MATERIAL_END")>=0||e.type.indexOf("MATERIAL_BEGIN")>=0)&&(l=Oe(l)),r.push(l)}}for(o=0;o<e.outputs.length;o++){var c=e.outputs[o];c.is_linked?a.push(null):a.push(ce("out_"+e.type+"_"+Me(c.identifier)))}for(o=0;o<e.params.length;o++){var u=e.params[o];n.push(u.name),_.push(u.value)}for(o=0;o<e.vparams.length;o++){var d=e.vparams[o];s.push(d.name)}return{id:e.type,inputs:t,input_values:r,outputs:a,params:n,param_values:_,vparams:s,dirs:JSON.parse(JSON.stringify(e.dirs))}}function Me(e){return e.replace(/\./g,"")}function Ie(e,t,r){return"GROUP_INPUT"==e?t+"*GI*"+r:"GROUP_OUTPUT"==e?t+"*GO*"+r:t+"%join%"+r}function Se(e,t){for(var r=t.nodes,a=t.links,n=0;n<r.length;n++)r[n].name=Ie(r[n].type,e,r[n].name);for(n=0;n<a.length;n++)a[n].from_node.name=Ie(a[n].from_node.type,e,a[n].from_node.name),a[n].to_node.name=Ie(a[n].to_node.type,e,a[n].to_node.name)}function Le(e){var t=[];return Ke.traverse(e,function(e,r){"GROUP"==r.type&&t.push(r)}),t}function Ce(e,t,r){for(var a=0;a<r.length;a++){var n=r[a].data.node_group_graph,_=r[a].data.node_group_links;if(!n)return!1;Ke.traverse(n,function(t,r){Ke.append_node(e,Ke.gen_node_id(e),r)});for(var s=0;s<_.length;s++)t.push(_[s]);Ye(r[a],t,e)}return!0}function Pe(e,t,r,a,n,_){switch(e.type){case"GROUP":e.name==t&&a.push(r);break;case"GROUP_INPUT":e.name.indexOf(t+"*GI*")||n.push(r);break;case"GROUP_OUTPUT":e.name.indexOf(t+"*GO*")||_.push(r)}}function De(e,t,r){for(var a=[],n=0;n<r.length;n++){for(var _=r[n],s=null,o=0;o<t.length;o++)if(_.from_socket.identifier==t[o].to_socket.identifier){s=t[o];break}s?(_.from_node=s.from_node,_.from_socket=s.from_socket):a.push(_)}for(n=0;n<t.length;n++)e.splice(e.indexOf(t[n]),1);return a}function Ue(e,t){if(t.length)for(var r=t[0].from_node.name,a=0;a<e.length;a++)e[a].from_node.name==r&&t.push(e[a])}function Fe(e,t,r){for(var a=I(e.to_node,t),n=0;n<a.length;n++)for(var _=Ke.get_node_attr(t,a[n]),s=0;s<_.inputs.length;s++){var o=_.inputs[s];if(o.identifier==e.to_socket.identifier){var i=Ge(o.default_value);if(Ge(r)==i)o.default_value=r;else switch(i){case dt:je(r,o.default_value);break;case ft:o.default_value=ze(r)}break}}}function Be(e,t,r,a){for(var n=0;n<a.length;n++){for(var _,s=a[n],o=0;o<r.inputs.length;o++)if(s.from_socket.identifier==r.inputs[o].identifier){_=r.inputs[o].default_value;break}Fe(s,t,_);var i=e.indexOf(s);-1!=i&&e.splice(i,1)}}function Ge(e){return e instanceof Object?dt:ft}function je(e,t){return t[0]=t[1]=t[2]=e,t}function ze(e){return(e[0]+e[1]+e[2])/3}function Ye(e,t,r){for(var a=e.name,n=[],_=[],s=[],o=[],i=0;i<t.length;i++){var l=t[i];Pe(l.from_node,a,l,n,s,o),Pe(l.to_node,a,l,_,s,o)}var c=De(t,_,s),u=De(t,o,n);if(Ue(t,c),Be(t,r,e,c),u.length){var d;Ke.traverse(r,function(e,t){"GROUP_OUTPUT"!=t.type||t.name.indexOf(a+"*GO*")||(d=t)}),Be(t,r,d,u)}}function He(e,t,r){$e.log("\n====== USER: "+t+", MATERIAL: "+r+" ======\n"+Xe.nodegraph_to_dot(e,!0)+"\n=============================================================")}function We(e){var t=[],r=[];Ke.traverse(e,function(e,a){switch(a.type){case"VALTORGB":t.push(a);break;case"CURVE_VEC":case"CURVE_RGB":r.push(a)}});var a=0,n=null,_=null,s=t.length+r.length;if(t.length)for(n=nt.extract_col_ramps_data(t,nt.COLORRAMP_TEXT_SIZE),l=0;l<t.length;l++)t[l].dirs.push(["NODE_TEX_ROW",et.glsl_value((a+.5)/s)]),a++;if(r.length)for(_=nt.extract_vec_curves_data(r,nt.CURVE_NODES_TEXT_SIZE),l=0;l<r.length;l++)r[l].dirs.push(["NODE_TEX_ROW",et.glsl_value((a+.5)/s)]),a++;var o=null;if(n&&_?((o=new Uint8Array(n.length+_.length)).set(n),o.set(_,n.length)):o=n||_,o)i=nt.create_color_ramp_texture(o,nt.CURVE_NODES_TEXT_SIZE);else var i=null;for(l=0;l<t.length;l++)t[l].data.texture=i;for(var l=0;l<r.length;l++)r[l].data.texture=i}function qe(e,t,r,a){var n=e.curve_mapping.curves_data[t];return!(2==n.length&&n[0][0]<r+mt&&n[0][1]<r+mt&&n[1][0]>a-mt&&n[1][1]>a-mt)}var Ve=g(e),Xe=ae(e),Ke=E(e),Ze=u(e),Qe=i(e),Je=$(e),$e=m(e),et=B(e),tt=j(e),rt=h(e),at=l(e),nt=ee(e),_t={},st={},ot={},it={},lt=0,ct=Ve.defaults,ut=!1,dt=0,ft=1,mt=.01,pt=0,ht=1,vt=2,bt=0,gt=1,yt=2,Et=3,wt=4,At=5,Tt=6,xt=7,Ot=8;t.VT_WORLD_TO_WORLD=bt,t.VT_WORLD_TO_OBJECT=gt,t.VT_WORLD_TO_CAMERA=yt,t.VT_OBJECT_TO_WORLD=Et,t.VT_OBJECT_TO_OBJECT=wt,t.VT_OBJECT_TO_CAMERA=At,t.VT_CAMERA_TO_WORLD=Tt,t.VT_CAMERA_TO_OBJECT=xt,t.VT_CAMERA_TO_CAMERA=Ot;var Rt=0,kt=1,Nt=2,Mt=3,It=4;t.NM_TANGENT=Rt,t.NM_OBJECT=kt,t.NM_WORLD=Nt,t.NM_BLENDER_OBJECT=Mt,t.NM_BLENDER_WORLD=It;var St=0,Lt=2;t.get_ngraph_proxy_cached=function(e){return st[e]},t.cleanup_ngraph_proxy=function(e){delete st[e]},t.compose_ngraph_proxy=function(e,t,a,n,_,s,o){var i=r(e,t,a,s,o);return ut&&He(i.graph,n,_),i},t.create_lighting_graph=function(e,t){var r=A(e,"MAIN",tt.get_active().uuid);if(r in ot)return ot[r];var a=Ke.create(),_={name:"LIGHTING_BEGIN",type:"LIGHTING_BEGIN"},s=ne(a,_,0,null,null);return n(a,t,s,ne(a,_={name:"LIGHTING_END",type:"LIGHTING_END"},0,null,null),[[s,[8,10]],[s,[9,6]]]),R(a),ot[r]=a,a},t.compose_node_elements=function(e){var t=[],r={};oe();var a=Ke.topsort(e);return Ke.traverse(a,function(e,a){var n=Ne(a);t.push(n),r[e]=n}),Ke.traverse_edges(a,function(e,t,n){var _=Ke.get_node_attr(a,e),s=_.outputs[n[0]],o=r[e].outputs,i=r[t].inputs,l=o[n[0]]||ce("out_"+_.type+"_"+Me(s.identifier));o[n[0]]=l,i[n[1]]=l}),t},t.check_material_glow_output=function(e){if(e.node_tree)for(var t=0;t<e.node_tree.nodes.length;t++){var r=e.node_tree.nodes[t];if("GROUP"==r.type&&"B4W_GLOW_OUTPUT"==r.node_tree_name)return!0}return!1},t.print_node_graph=He,t.cleanup=function(){for(var e in st)delete st[e];for(var e in ot)delete ot[e];for(var t in it)delete it[t];lt=0},t.get_max_env_texture_height=function(e){var t=-1;return Ke.traverse(e,function(e,r){if("TEXTURE_ENVIRONMENT_EQUIRECTANGULAR"==r.type||"TEXTURE_ENVIRONMENT_MIRROR_BALL"==r.type){var a=r.data.value.height;t=Math.max(t,a)}}),t}}),_e=o("__batch",function(e,t){function r(e){var t={type:e,subtype:"",id:0,data_id:0,cluster_id:-1,odd_id_prop:"",debug_id_color:-1,debug_main_batch_id:-1,debug_main_batch_render_time:0,debug_render_time:0,debug_render_time_queries:[],textures:[],texture_names:[],bpy_tex_names:[],material_names:[],common_attributes:[],uv_maps_usage:null,vertex_colors_usage:{},shader:null,shaders_info:Je.init_shaders_info(),ngraph_proxy_id:"",attribute_setters:[],bufs_data:null,vaos:at.create_non_smi_array(),use_shape_keys:!1,debug_sphere:!1,debug_sphere_dynamic:!1,num_vertices:0,num_triangles:0,jitter_amp:0,jitter_freq:0,dynamic_grass:!1,grass_scale_threshold:0,grass_size:0,grass_map_dim:new Float32Array(3),cube_fog:new Float32Array(16),alpha_clip:!1,alpha_antialiasing:!1,blend:!1,depth_mask:!1,xray:!1,use_backface_culling:!1,use_shadeless:!1,dynamic_geometry:!1,shadow_cast:!1,shadow_cast_only:!1,shadow_receive:!1,reflexible:!1,reflexible_only:!1,reflective:!1,draw_mode:rt.DM_DEFAULT,z_sort:!1,forked_batch:!1,do_not_cull:!1,caustics:!1,lod_dist_max:We.LOD_DIST_MAX_INFINITY,lod_dist_min:0,lod_lower_border_range:0,lod_upper_border_range:0,lod_settings:n(),cube_reflection_id:-1,plane_reflection_id:-1,halo:!1,halo_size:0,halo_hardness:0,halo_stars_blend:0,halo_stars_height:0,halo_rings_color:new Float32Array(3),halo_lines_color:new Float32Array(3),halo_particles:!1,ambient:0,emit:0,diffuse_intensity:1,reflect_factor:0,specular_color_factor:0,specular_alpha:1,parallax_scale:0,diffuse_color_factor:0,alpha_factor:1,normal_factor:0,mirror_factor:0,offset_z:0,refr_bump:0,diffuse_params:new Float32Array(2),specular_params:new Float32Array(3),texture_scale:new Float32Array(3),specular_color:new Float32Array(3),diffuse_color:new Float32Array(4),fresnel_params:new Float32Array(2),lamp_uuid_indexes:null,lamp_light_positions:null,lamp_light_directions:null,lamp_light_color_intensities:null,has_nodes:!1,wireframe_edge_color:nt.create(),water:!1,water_dynamic:!1,water_shore_smoothing:!1,water_generated_mesh:!1,water_num_cascads:0,water_subdivs:0,water_detailed_dist:0,water_norm_uv_velocity:.1,shallow_water_col_fac:0,shore_water_col_fac:0,foam_factor:0,foam_uv_freq:new Float32Array(2),foam_mag:new Float32Array(2),foam_scale:new Float32Array(2),shallow_water_col:new Float32Array(3),shore_water_col:new Float32Array(3),normalmap_scales:null,refractive:!1,is_sky:!1,draw_proc_sky:!1,particles_data:null,line_width:0,anchor_positions:null,part_node_data:null,node_values:[],node_value_inds:[],node_rgbs:[],node_rgb_inds:[],bounds_local:Fe.init_boundings(),use_be:!1,submesh:null,cleanup_gl_data_on_unload:!0,inst_array_state:0,obj_info_params:new Float32Array(3)};return t.diffuse_color[3]=1,t.depth_mask=!0,t.line_width=1,t.lod_settings.hyst_prev_state=-1,t}function a(e){var t=r(e.type);return t.subtype=e.subtype,t.id=e.id,t.cluster_id=e.cluster_id,t.odd_id_prop=e.odd_id_prop,t.debug_id_color=e.debug_id_color,t.debug_main_batch_id=e.debug_main_batch_id,t.debug_main_batch_render_time=e.debug_main_batch_render_time,t.debug_render_time=e.debug_render_time,t.debug_render_time_queries=[],t.textures=e.textures.slice(),t.texture_names=e.texture_names.slice(),t.bpy_tex_names=e.bpy_tex_names.slice(),t.material_names=e.material_names.slice(),t.common_attributes=e.common_attributes.slice(),t.uv_maps_usage=at.clone_object_r(e.uv_maps_usage),t.vertex_colors_usage=at.clone_object_r(e.vertex_colors_usage),t.shader=e.shader,t.shaders_info=Je.clone_shaders_info(e.shaders_info),t.ngraph_proxy_id=e.ngraph_proxy_id,t.attribute_setters=Ze.clone_attribute_setters(e.attribute_setters),t.bufs_data=e.bufs_data,t.use_shape_keys=e.use_shape_keys,t.debug_sphere=e.debug_sphere,t.debug_sphere_dynamic=e.debug_sphere_dynamic,t.num_vertices=e.num_vertices,t.num_triangles=e.num_triangles,t.jitter_amp=e.jitter_amp,t.jitter_freq=e.jitter_freq,t.grass_scale_threshold=e.grass_scale_threshold,t.grass_size=e.grass_size,t.grass_map_dim=e.grass_map_dim,t.cube_fog=e.cube_fog,t.alpha_clip=e.alpha_clip,t.alpha_antialiasing=e.alpha_antialiasing,t.blend=e.blend,t.depth_mask=e.depth_mask,t.xray=e.xray,t.use_backface_culling=e.use_backface_culling,t.use_shadeless=e.use_shadeless,t.dynamic_geometry=e.dynamic_geometry,t.shadow_cast=e.shadow_cast,t.shadow_cast_only=e.shadow_cast_only,t.shadow_receive=e.shadow_receive,t.reflexible=e.reflexible,t.reflexible_only=e.reflexible_only,t.reflective=e.reflective,t.dynamic_grass=e.dynamic_grass,t.draw_mode=e.draw_mode,t.z_sort=e.z_sort,t.forked_batch=e.forked_batch,t.do_not_cull=e.do_not_cull,t.caustics=e.caustics,t.lod_dist_max=e.lod_dist_max,t.lod_dist_min=e.lod_dist_min,t.lod_lower_border_range=e.lod_lower_border_range,t.lod_upper_border_range=e.lod_upper_border_range,t.lod_settings=_(e.lod_settings),t.cube_reflection_id=e.cube_reflection_id,t.plane_reflection_id=e.plane_reflection_id,t.halo=e.halo,t.halo_size=e.halo_size,t.halo_hardness=e.halo_hardness,t.halo_stars_blend=e.halo_stars_blend,t.halo_stars_height=e.halo_stars_height,nt.copy(e.halo_rings_color,t.halo_rings_color),nt.copy(e.halo_lines_color,t.halo_lines_color),t.halo_particles=e.halo_particles,t.ambient=e.ambient,t.emit=e.emit,t.diffuse_intensity=e.diffuse_intensity,t.reflect_factor=e.reflect_factor,t.specular_color_factor=e.specular_color_factor,t.specular_alpha=e.specular_alpha,t.parallax_scale=e.parallax_scale,t.diffuse_color_factor=e.diffuse_color_factor,t.alpha_factor=e.alpha_factor,t.normal_factor=e.normal_factor,t.mirror_factor=e.mirror_factor,t.offset_z=e.offset_z,t.refr_bump=e.refr_bump,t.diffuse_params[0]=e.diffuse_params[0],t.diffuse_params[1]=e.diffuse_params[1],nt.copy(e.specular_params,t.specular_params),nt.copy(e.texture_scale,t.texture_scale),nt.copy(e.specular_color,t.specular_color),_t.copy(e.diffuse_color,t.diffuse_color),t.fresnel_params.set(e.fresnel_params),t.lamp_uuid_indexes=at.clone_object_r(e.lamp_uuid_indexes),e.lamp_light_positions&&(t.lamp_light_positions=new Float32Array(e.lamp_light_positions),t.lamp_light_directions=new Float32Array(e.lamp_light_directions),t.lamp_light_color_intensities=new Float32Array(e.lamp_light_color_intensities)),t.has_nodes=e.has_nodes,nt.copy(e.wireframe_edge_color,t.wireframe_edge_color),t.water=e.water,t.water_dynamic=e.water_dynamic,t.water_shore_smoothing=e.water_shore_smoothing,t.water_generated_mesh=e.water_generated_mesh,t.water_num_cascads=e.water_num_cascads,t.water_subdivs=e.water_subdivs,t.water_detailed_dist=e.water_detailed_dist,t.water_norm_uv_velocity=e.water_norm_uv_velocity,t.shallow_water_col_fac=e.shallow_water_col_fac,t.shore_water_col_fac=e.shore_water_col_fac,t.foam_factor=e.foam_factor,t.foam_uv_freq.set(e.foam_uv_freq),t.foam_mag.set(e.foam_mag),t.foam_scale.set(e.foam_scale),nt.copy(e.shallow_water_col,t.shallow_water_col),nt.copy(e.shore_water_col,t.shore_water_col),t.normalmap_scales=at.clone_object_r(e.normalmap_scales),t.refractive=e.refractive,t.is_sky=e.is_sky,t.draw_proc_sky=e.draw_proc_sky,e.particles_data&&(t.particles_data=qe.clone_particles_data(e.particles_data)),t.line_width=e.line_width,e.anchor_positions&&(t.anchor_positions=new Float32Array(e.anchor_positions)),t.part_node_data=at.clone_object_r(e.part_node_data),t.node_values=e.node_values.slice(),t.node_value_inds=e.node_value_inds.slice(),t.node_rgbs=e.node_rgbs.slice(),t.node_rgb_inds=e.node_rgb_inds.slice(),Fe.copy_boundings(e.bounds_local,t.bounds_local),t.use_be=e.use_be,t.cleanup_gl_data_on_unload=e.cleanup_gl_data_on_unload,t.obj_info_params=e.obj_info_params,t}function n(){var e={use_smoothing:!1,coverage:0,cmp_logic:0,dest_coverage:0,hyst_prev_state:0,hyst_interval_min:0,hyst_interval_max:0,prev_dist:0};return e.cmp_logic=1,e}function _(e){var t=n();return t.use_smoothing=e.use_smoothing,t.coverage=e.coverage,t.cmp_logic=e.cmp_logic,t.dest_coverage=e.dest_coverage,t.hyst_prev_state=e.hyst_prev_state,t.hyst_interval_min=e.hyst_interval_min,t.hyst_interval_max=e.hyst_interval_max,t.prev_dist=e.prev_dist,t}function s(e){switch(e.type){case"MAIN":case"PARTICLES":case"LINE":e.blend?e.xray?e.subtype="XRAY":e.subtype="BLEND":e.subtype="OPAQUE";break;case"SHADOW":e.shadow_cast_only?e.subtype="CAST":e.subtype="RECEIVE";break;case"COLOR_ID":e.xray?e.subtype="COLOR_ID_XRAY":e.subtype="COLOR_ID"}}function o(e,t){for(var r=[],a=0;a<e.length;a++){var n=e[a],_=n._object,s=_.render;_.is_hair_dupli||r.push.apply(r,i(n,s,t))}return r}function i(e,t,a){var n=[],_=e._object,s=I(a,t,!t.do_not_render,!1),o=e.data,i=_.materials,l=new Array(i.length),c=new Array(i.length),u=[],d=Qe.find_subs(a,$e.MAIN_OPAQUE),m=!1;for(d&&(m=!!d.light_positions.length),w=0;w<s.length;w++)for(var h=s[w],v=0;v<i.length;v++){var b=i[v];if(!Ue(_,v)&&!rt.has_empty_submesh(o,v))if("PHYSICS"==h&&e.b4w_collision&&"NAVMESH"==e.game.physics_type)u.push(rt.extract_submesh(o,v,[],t.bone_skinning_info,{},null));else if(!b.is_lens_flares||m){var g=r(h);"MAIN"==h?l[v]=g:"DEBUG_VIEW"==h&&(c[v]=g),g.cluster_id=e.b4w_cluster_data.cluster_id,ve(g,b)&&S(g,b,o)&&("SHADOW"==h&&l[v]&&(g.use_shadeless=l[v].use_shadeless),g.draw_mode=t.use_shape_keys||t.dynamic_geometry?rt.DM_DYNAMIC_TRIANGLES:rt.DM_DEFAULT,oe(g,t),ce(g,e.particle_systems),"DYNAMIC"!=t.type&&"COLOR_ID"!=g.type||(g.odd_id_prop=De(g,t,e.uuid)),g.do_not_cull=e.b4w_do_not_cull,"MAIN"==g.type&&(g.caustics=e.b4w_caustics),de(g,"DISABLE_FOG",0|("COLOR_ID"!=h&&"SHADOW"!=h&&e.b4w_disable_fogging)),y=rt.extract_submesh(o,v,g.common_attributes,t.bone_skinning_info,g.vertex_colors_usage,g.uv_maps_usage),!b.use_tangent_shading||"a_shade_tangs"in y.va_frames[0]||(de(g,"CALC_TBN",1),ue(g,"a_tbn")),b.is_lens_flares&&(y=qe.prepare_lens_flares(y)),ke(g),n.push({batch:g,obj_render:t,batch_render:t,submesh:y,mat_names:[b.name],rel_bpy_objects:[e]}))}}if(u.length){(g=r("PHYSICS")).subtype="NAVMESH",g.odd_id_prop=De(g,t,e.uuid);for(var y=rt.submesh_list_join(u),E=[],w=0;w<i.length;w++)E.push(i[w].name);ke(g),n.push({batch:g,obj_render:t,batch_render:t,submesh:y,mat_names:E,rel_bpy_objects:[e]})}for(w=0;w<c.length;w++)c[w]&&(c[w].debug_main_batch_id=l[w].id,ke(c[w]));var A=e.particle_systems;if(A.length>0){for(var x=!1,O=!1,w=0;w<A.length;w++){var R=A[w],k=R.settings;if(k.use_render_emitter&&n.length&&(x=!0),"HAIR"!=k.type||"OBJECT"!=k.render_type&&"GROUP"!=k.render_type&&R.transforms.length||(O=!0),x&&O)break}if(n.length)N=n[0];else var N=f(o,t,A);var M=N.batch.vertex_colors_usage;if(O)L=i.length>1?p(o,A,M,e._object.render):N.submesh;else var L=null;var C=T(e,t,a,M,L);x?n.push.apply(n,C):n=C}return n}function f(e,t,a){var n=r("TMP");return ce(n,a),{batch:n,submesh:rt.extract_submesh(e,0,n.common_attributes,t.bone_skinning_info,n.vertex_colors_usage,n.uv_maps_usage)}}function p(e,t,r,a){for(var n={},_=0;_<t.length;_++){var s=t[_].settings;if("HAIR"==s.type&&("OBJECT"==s.render_type||"GROUP"==s.render_type)){var o=s.b4w_vcol_from_name,i=s.b4w_vcol_to_name;""!==o&&""!==i&&(n[o]=at.clone_object_r(r[o]))}}return"a_bending_col_main"in r&&(n.a_bending_col_main=at.clone_object_r(r.a_bending_col_main)),"a_bending_col_detail"in r&&(n.a_bending_col_detail=at.clone_object_r(r.a_bending_col_detail)),rt.extract_submesh_all_mats(e,[],n)}function T(e,t,a,n,_){for(var s=e._object,o=[],i=e.particle_systems,l=e.data,c=0;c<i.length;c++){var u=i[c],d=u.settings;if(d.count)if("EMITTER"==d.type){if("DYNAMIC"==t.type){var f=r("PARTICLES");f.bounds_local.bb=t.bb_local,f.bounds_local.be=t.be_local,f.bounds_local.bs=t.bs_local;var m=x(u,s.materials),p=s.materials[m];if(Ue(s,m))continue;if("HALO"===u.settings.render_type&&"HALO"==p.type&&(f.halo_particles=!0),!S(f,p,l))continue;pe(f,u,s),f.dynamic_geometry=!0,f.do_not_cull=e.b4w_do_not_cull,f.odd_id_prop=De(f,t,s.name+"_"+d.uuid),qe.create_particles_data(f,u,p);var h=qe.generate_emitter_particles_submesh(f,l,u,s.render);qe.update_particles_submesh(h,f,d.count),qe.update_particles_objs_cache(s),oe(f,s.render),ke(f),o.push({batch:f,obj_render:t,batch_render:t,submesh:h,mat_names:[p.name],rel_bpy_objects:[e]})}}else if("HAIR"==d.type){var v=at.init_rand_r_seed(u.seed),b=Ke.check_particles_bin_format(st.loaded_data_version)&&!d.b4w_initial_rand_rotation&&!d.b4w_hair_billboard,g=4;if(b&&(g=8),u.transforms.length)E=u.transforms;else for(var y=rt.geometry_random_points(_,d.count,!1,v),E=new Float32Array(y.length*g),w=0;w<y.length;w++){var A=.75+.5*at.rand_r(v);E[w*g]=y[w][0],E[w*g+1]=y[w][1],E[w*g+2]=y[w][2],E[w*g+3]=A,b&&(E[w*g+4]=1,E[w*g+5]=0,E[w*g+6]=0,E[w*g+7]=0)}var T=!!Qe.find_subs(a,$e.GRASS_MAP);if("OBJECT"==d.render_type){var O=[I(a,d.dupli_object._object.render,!t.do_not_render,!0)],R=he(e,t,n,_,[d.dupli_object],O,[E],d,u,T,v,!1);o.push.apply(o,R)}else if("GROUP"==d.render_type){for(var k=d.dupli_group.objects,O=[],w=0;w<k.length;w++){var N=I(a,k[w]._object.render,!t.do_not_render,!0);O.push(N)}for(var M=!1,L=[],w=0;w<k.length;w++)L.push(k[w]._object);if(d.use_whole_group)C=Oe(E,L,b,g),M=!0;else if(d.use_group_count)C=Re(E,L,d.dupli_weights,v,b,g);else var C=xe(E,L,v,b,g);R=he(e,t,n,_,k,O,C,d,u,T,v,M),o.push.apply(o,R)}"INSTANCE"==d.b4w_wind_bend_inheritance&&s.render.wind_bending&&Ge.warn('Emitter object "'+s.name+"\" has a particle system with wind bending inheritance from the particle instance. Wind bending on the emitter isn't disabled. Expect unforeseen behavior.")}else at.panic("Unknown particle settings type")}return o}function x(e,t){var r=e.settings.material-1;return r>=t.length&&(Ge.warn('Wrong material used for rendering particle system "'+e.name+'"'),r=0),r}function O(e){for(var t=[],r=[],a={},n=0;n<e.length;n++){var _=null;if((c=e[n].batch).id in a){var s=a[c.id],o=r[s].batch;if(Ne(c,function(e){Ne(o,function(t){at.strict_objs_is_equal(e,t)&&e.inst_array_state!=ht&&(_=r[s])})}),!_)do{c.id++}while(a[c.id])}if(_&&!dt||(_={batch:c,obj_renders_ordered:[],batch_renders_ordered:[],submeshes_ordered:[],rel_bpy_objects:[],rel_bpy_objects_uuids:[],mat_names:[]},a[c.id]=r.length,r.push(_)),e[n].submesh&&e[n].submesh.base_length){for(_.obj_renders_ordered.push(e[n].obj_render),_.batch_renders_ordered.push(e[n].batch_render),_.submeshes_ordered.push(e[n].submesh),w=0;w<e[n].rel_bpy_objects.length;w++){var i=e[n].rel_bpy_objects[w];-1==_.rel_bpy_objects_uuids.indexOf(i.uuid)&&(_.rel_bpy_objects.push(i),_.rel_bpy_objects_uuids.push(i.uuid))}for(w=0;w<e[n].mat_names.length;w++){var l=e[n].mat_names[w];-1==_.mat_names.indexOf(l)&&_.mat_names.push(l)}}_.mat_names.sort()}for(n=0;n<r.length;n++){var c=r[n].batch,u=r[n].obj_renders_ordered,d=r[n].batch_renders_ordered,f=r[n].submeshes_ordered,m=R(d,c);if("STATIC"==m.type&&"COLOR_ID"!=c.type)for(w=0;w<u.length;w++){var p=u[w],h=d[w],v=f[w],b=tt.identity(wt);if(p.billboard&&!p.billboard_pres_glob_orientation){var g=tt.get_transcale(p.world_tsr,Et);tt.set_transcale(g,b)}else tt.copy(p.world_tsr,b);if(h.is_hair_particles?v.instanced_array_data||(h.billboard?rt.submesh_apply_particle_transform(v,b):rt.submesh_apply_transform(v,b)):rt.submesh_apply_transform(v,b),h.is_hair_particles)de(c,"AU_QUALIFIER","GLSL_IN");else if(r[n].rel_bpy_objects.length>1){var y={};(h.wind_bending||h.billboard)&&(y.au_center_pos=[b[0],b[1],b[2]]),h.wind_bending&&(y.au_wind_bending_amp=[h.wind_bending_amp],y.au_wind_bending_freq=[h.wind_bending_freq],y.au_detail_bending_amp=[h.detail_bending_amp],y.au_detail_bending_freq=[h.detail_bending_freq],y.au_branch_bending_amp=[h.branch_bending_amp]),rt.submesh_apply_params(v,y),de(c,"AU_QUALIFIER","GLSL_IN")}else m.center_pos.set(b.subarray(0,3)),de(c,"AU_QUALIFIER","uniform")}if(0==f.length)v=rt.init_submesh(at.unique_name("%empty"));else if(1==f.length)v=f[0];else{for(var E=[],w=0;w<f.length;w++)rt.is_long_submesh(f[w])||E.push(w);if(E.length<f.length)for(w=0;w<E.length;w++)rt.submesh_drop_indices(f[E[w]]);v=rt.submesh_list_join(f)}if("STATIC"==m.type){if("COLOR_ID"!=c.type){for(var A=[],w=0;w<r[n].rel_bpy_objects.length;w++){var T=r[n].rel_bpy_objects[w]._object;Fe.extract_rot_bb_corners(T.render.bbr_world,A)}Fe.bb_from_coords(A,0,A.length,m.bb_world),Fe.copy_bb(m.bb_world,m.bb_local),m.be_world=Fe.create_be_by_bb(at.f32(A),!0),Fe.copy_be(m.be_world,m.be_local),m.bs_world=Fe.create_bs_by_be(m.be_world),Fe.copy_bs(m.bs_world,m.bs_local)}if(m.is_lod){var x=r[n].rel_bpy_objects[0].b4w_cluster_data;x.cluster_center?m.lod_center.set(x.cluster_center):m.lod_center.set(m.bs_world.center)}}if("PARTICLES"!=c.type){var O=v.submesh_bd;m.billboard?(Fe.copy_bb(m.bb_local,c.bounds_local.bb),Fe.copy_be(m.be_local,c.bounds_local.be),Fe.copy_bs(m.bs_local,c.bounds_local.bs),c.use_be=!1):(Fe.copy_bb(O.bb_local,c.bounds_local.bb),Fe.copy_be(O.be_local,c.bounds_local.be),m.bs_local.radius<O.bs_local.radius?"STATIC"==m.type&&"COLOR_ID"!=c.type?Fe.copy_bs(m.bs_world,c.bounds_local.bs):Fe.copy_bs(m.bs_local,c.bounds_local.bs):Fe.copy_bs(O.bs_local,c.bounds_local.bs),c.use_be=Fe.is_be_optimized(c.bounds_local.be,c.bounds_local.bs))}var k={batch:c,render:m,submesh:v,mat_names:r[n].mat_names,rel_bpy_objects:r[n].rel_bpy_objects};t.push(k)}return t}function R(e,t){return"DYNAMIC"==e[0].type||"COLOR_ID"==t.type?e[0]:We.clone_render(e[0])}function M(e,t){for(var r=0;r<t.length;r++){var a=e.indexOf(t[r]);-1!==a&&e.splice(a,1)}return e}function I(e,t,r,a){var n=[];if(a||(t.selectable&&Qe.find_subs(e,$e.COLOR_PICKING)||t.outlining&&Qe.find_subs(e,$e.OUTLINE_MASK))&&n.push("COLOR_ID"),r&&(n.push("MAIN"),n.push("NODES_GLOW"),Qe.find_subs(e,$e.DEBUG_VIEW)&&n.push("DEBUG_VIEW"),Qe.find_subs(e,$e.SHADOW_RECEIVE)&&n.push("SHADOW"),Qe.find_subs(e,$e.GRASS_MAP)&&n.push("GRASS_MAP")),n.push("PHYSICS"),t.shadow_cast_only||t.reflexible_only){var _=null;if(t.shadow_cast_only&&(_=["MAIN","NODES_GLOW","COLOR_ID","PHYSICS","DEBUG_VIEW"]),t.reflexible_only){var s=["COLOR_ID","PHYSICS","SHADOW","DEBUG_VIEW"];_=null!==_?at.array_intersect(_,s):s}n=M(n,_)}return n}function S(e,t,r){var a;switch(e.type){case"MAIN":a=L(e,t,r);break;case"NODES_GLOW":a=W(e,t,r,"GLOW");break;case"SHADOW":a=J(e,t,r);break;case"PHYSICS":a=$(e,t);break;case"COLOR_ID":a=re(e,t,r);break;case"GRASS_MAP":a=_e(e,t);break;case"DEBUG_VIEW":a=ae(e,t);break;case"PARTICLES":a=se(e,t,r);break;default:at.panic("Wrong batch type: "+e.type)}return a}function L(e,t,r){if(t.do_not_render)return!1;if(t.use_nodes&&"HALO"!=t.type)return W(e,t,r,"MAIN"),!0;U(e,t),e.use_backface_culling=t.use_backface_culling,e.xray=t.render_above_all&&"OPAQUE"!=t.blend_mode&&"CLIP"!=t.blend_mode&&"ALPHA_ANTIALIASING"!=t.blend_mode,e.offset_z=t.offset_z,e.texture_scale.set([1,1,1]);var a=t.texture_slots;if(e.diffuse_color.set(t.diffuse_color),e.diffuse_color[3]=t.alpha,t.is_lens_flares)Ie(e,"lens_flares.glslv","lens_flares.glslf"),ue(e,"a_position"),ue(e,"a_texcoord"),Se(e,w=et.get_batch_texture(a[0]),"u_sampler",(y=a[0].texture).name);else{if(Ie(e,"main.glslv","main_stack.glslf"),!t.use_shadeless){var n={use_shadeless:t.use_shadeless,diffuse_shader:t.diffuse_shader,specular_shader:t.specular_shader,use_tangent_shading:t.use_tangent_shading},_=He.create_lighting_graph(t.uuid,n);e.shaders_info.node_elements=He.compose_node_elements(_)}var s=F("use_map_color_diffuse",!0,a),o=F("use_map_color_spec",!0,a),i=F("use_map_normal",!0,a),l=F("use_map_mirror",!0,a),c=F("use_stencil",!0,a),u=s[0],d=o[0],f=i[0],m=l[0],p=s[1],h=c[0]&&F("use_rgb_to_intensity",!0,a)[0];if(u){switch(y=u.texture,u.blend_type){case"MIX":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case"MULTIPLY":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY")}Se(e,w=et.get_batch_texture(u),"u_colormap0",y.name),e.diffuse_color_factor=u.diffuse_color_factor,u.use_map_alpha?e.alpha_factor=u.alpha_factor:e.alpha_factor=0,e.texture_scale.set(u.scale)}var v=u&&u==d;if(d&&(v||(y=d.texture,Se(e,w=et.get_batch_texture(d),"u_specmap0",y.name)),e.specular_color_factor=d.specular_color_factor),f&&(y=f.texture,ue(e,"a_tbn"),Se(e,w=et.get_batch_texture(f),"u_normalmap0",y.name),e.normal_factor=f.normal_factor,y.b4w_use_map_parallax&&st.parallax)){var b=Je.glsl_value(y.b4w_parallax_steps),g=Je.glsl_value(y.b4w_parallax_lod_dist);de(e,"PARALLAX",1),de(e,"PARALLAX_STEPS",b),de(e,"PARALLAX_LOD_DIST",g),e.parallax_scale=y.b4w_parallax_scale}if(m){var y=m.texture;Se(e,w=et.get_batch_texture(m),"u_mirrormap",y.name),e.mirror_factor=m.mirror_factor}var E=u&&p&&h?1:0;if(E){var w=et.get_batch_texture(p);Se(e,w,"u_colormap1",(y=p.texture).name),Se(e,w=et.get_batch_texture(h),"u_stencil0",(y=h.texture).name)}var A=u||d||f;A&&e.texture_scale.set(A.scale),de(e,"TEXTURE_SPEC",void 0==d?0:1),de(e,"ALPHA_AS_SPEC",v?1:0),de(e,"TEXTURE_STENCIL_ALPHA_MASK",E),ue(e,"a_position"),ue(e,"a_tbn"),(u||d||f)&&ue(e,"a_texcoord"),t.water_settings.is_water&&j(t,e),"HALO"===t.type&&(Ie(e,"halo.glslv","halo.glslf"),P(e,t),e.common_attributes=["a_position"]),t.use_tangent_shading&&(de(e,"USE_TBN_SHADING",1),ue(e,"a_shade_tangs")),de(e,"TEXCOORD",0),de(e,"NORMAL_TEXCOORD",0),u&&D(e,u,"TEXTURE_COLOR0_CO"),p&&D(e,p,"TEXTURE_COLOR1_CO"),h&&D(e,h,"TEXTURE_STENCIL_ALPHA_MASK_CO"),d&&D(e,d,"TEXTURE_SPEC_CO"),f&&D(e,f,"TEXTURE_NORM_CO"),de(e,"SHADELESS",t.use_shadeless?1:0),e.use_shadeless=t.use_shadeless}return de(e,"ALPHA","OPAQUE"===t.blend_mode?0:1),de(e,"ALPHA_CLIP","CLIP"===t.blend_mode?1:0),de(e,"DOUBLE_SIDED_LIGHTING",t.use_double_sided_lighting?1:0),t.use_vertex_color_paint?(de(e,"VERTEX_COLOR",1),ue(e,"a_color")):de(e,"VERTEX_COLOR",0),e.ambient=t.ambient,e.diffuse_intensity=t.diffuse_intensity,e.emit=t.emit,e.specular_color.set(t.specular_color),e.specular_alpha=t.specular_alpha,Y(e,t),H(e,t),t.is_wettable?de(e,"WETTABLE",1):de(e,"WETTABLE",0),z(e,t),t.is_refractive&&!e.blend?(Ge.warn('Material "'+t.name+'" is not blend. Disabling refractions.'),e.refractive=!1):e.refractive=t.is_refractive,e.refr_bump=t.refr_bump,!0}function P(e,t){var r=t.halo_settings;de(e,"NUM_RINGS",r.ring_count),de(e,"NUM_LINES",r.line_count),de(e,"NUM_STARS",r.star_tip_count),de(e,"SKY_STARS",r.is_sky_stars?1:0),e.halo_size=r.size,e.halo_hardness=r.hardness/20,e.halo_rings_color.set(r.rings_color),e.halo_lines_color.set(r.lines_color),e.halo_stars_blend=1/r.stars_blend_height,e.halo_stars_height=r.stars_min_height,e.halo=!0}function D(e,t,r){switch(t.texture_coords){case"UV":case"ORCO":de(e,r,"TEXTURE_COORDS_UV_ORCO"),de(e,"TEXCOORD",1);break;case"NORMAL":de(e,r,"TEXTURE_COORDS_NORMAL"),de(e,"NORMAL_TEXCOORD",1);break;default:de(e,r,"TEXTURE_COORDS_NONE")}}function U(e,t){switch(t.blend_mode){case"ALPHA_ANTIALIASING":e.blend=!1,e.z_sort=!1,e.depth_mask=!0,e.alpha_clip=!1,e.alpha_antialiasing=!0;break;case"ALPHA_SORT":e.blend=!0,e.z_sort=!0,e.depth_mask=!0,e.alpha_clip=!1,e.alpha_antialiasing=!1;break;case"ALPHA":e.blend=!0,e.z_sort=!1,e.depth_mask=!0,e.alpha_clip=!1,e.alpha_antialiasing=!1;break;case"CLIP":e.blend=!1,e.z_sort=!1,e.depth_mask=!0,e.alpha_clip=!0,e.alpha_antialiasing=!1;break;case"ADD":e.blend=!0,e.z_sort=!1,e.depth_mask=!1,e.alpha_clip=!1,e.alpha_antialiasing=!1;break;case"OPAQUE":e.blend=!1,e.z_sort=!1,e.depth_mask=!0,e.alpha_clip=!1,e.alpha_antialiasing=!1;break;default:at.panic("Unknown alpha blend mode: "+t.blend_mode)}}function F(e,t,r){for(var a=[],n=r.length,_=0;_<n;_++){var s=r[_];s[e]==t&&s.texture&&s.texture._render&&a.push(s)}return a}function j(e,t){t.water=!0,t.water_dynamic=e.water_settings.is_dynamic,e.water_settings.shore_smoothing&&!t.blend?(Ge.warn('Material: "'+e.name+'" is opaque.',"Disabling water shore smoothing."),t.water_shore_smoothing=!1):t.water_shore_smoothing="REFLECT"!=t.subtype&&e.water_settings.shore_smoothing,Ie(t,"water.glslv","water.glslf");var r={use_shadeless:!1,diffuse_shader:e.diffuse_shader,specular_shader:e.specular_shader,use_tangent_shading:e.use_tangent_shading},a=He.create_lighting_graph(e.uuid,r);t.shaders_info.node_elements=He.compose_node_elements(a),ue(t,"a_position"),st.water_wireframe_debug?(ue(t,"a_polyindex"),t.depth_mask=!0,nt.set(0,0,0,t.wireframe_edge_color),je.get_standard_derivatives()?de(t,"DEBUG_WIREFRAME",1):de(t,"DEBUG_WIREFRAME",2)):de(t,"DEBUG_WIREFRAME",0);var n=e.texture_slots,_=F("use_map_normal",!0,n),s=F("use_map_mirror",!0,n)[0];for(_.length&&(Se(t,et.get_batch_texture(_[0]),"u_normalmap0",(d=_[0].texture).name),t.water_norm_uv_velocity=e.water_settings.norm_uv_velocity),de(t,"NUM_NORMALMAPS",_.length),t.normalmap_scales=new Array(_.length),i=0;i<_.length;i++)t.normalmap_scales[i]=new Float32Array(2),t.normalmap_scales[i].set([_[i].scale[0],_[i].scale[1]]);s&&(Se(t,et.get_batch_texture(s),"u_mirrormap",(d=s.texture).name),t.mirror_factor=s.mirror_factor);var o=null;if(st.foam)for(i=0;i<n.length;i++)if(!0===(l=n[i]).texture.b4w_water_foam){o=l;break}o&&(de(t,"FOAM",1),Se(t,et.get_batch_texture(o),"u_foam",(d=o.texture).name),t.foam_factor=e.water_settings.foam_factor,t.foam_uv_freq.set(d.b4w_foam_uv_freq),t.foam_mag.set(d.b4w_foam_uv_magnitude),t.foam_scale[0]=o.scale[0],t.foam_scale[1]=o.scale[1]);for(var i=0;i<n.length;i++){var l=n[i];if(!0===l.texture.b4w_shore_dist_map){var c=l;break}}if(c&&st.allow_vertex_textures){var u=et.get_batch_texture(c),d=c.texture;Se(t,u,"u_shore_dist_map",d.name),de(t,"SHORE_PARAMS",1);var f=l.texture.b4w_shore_boundings;de(t,"MAX_SHORE_DIST",Je.glsl_value(l.texture.b4w_max_shore_dist)),de(t,"SHORE_MAP_SIZE_X",Je.glsl_value(f[0]-f[1])),de(t,"SHORE_MAP_SIZE_Y",Je.glsl_value(f[2]-f[3])),de(t,"SHORE_MAP_CENTER_X",Je.glsl_value((f[0]+f[1])/2)),de(t,"SHORE_MAP_CENTER_Y",Je.glsl_value((f[2]+f[3])/2))}if(e.water_settings.is_generated_mesh?(de(t,"GENERATED_MESH",1),t.water_generated_mesh=!0,t.water_num_cascads=e.water_settings.num_cascads,t.water_subdivs=e.water_settings.num_subdivs,t.water_detailed_dist=e.water_settings.detailed_dist):(ue(t,"a_tbn"),(o||_.length)&&ue(t,"a_texcoord"),de(t,"GENERATED_MESH",0)),e.water_settings.is_dynamic){var m=Je.glsl_value(e.water_settings.dst_noise_scale0),p=Je.glsl_value(e.water_settings.dst_noise_scale1),h=Je.glsl_value(e.water_settings.dst_noise_freq0),v=Je.glsl_value(e.water_settings.dst_noise_freq1),b=Je.glsl_value(e.water_settings.dir_min_shore_fac),g=Je.glsl_value(e.water_settings.dir_freq),y=Je.glsl_value(e.water_settings.dir_noise_scale),E=Je.glsl_value(e.water_settings.dir_noise_freq),w=Je.glsl_value(e.water_settings.dir_min_noise_fac),A=Je.glsl_value(e.water_settings.dst_min_fac),T=Je.glsl_value(e.water_settings.waves_hor_fac);de(t,"DST_NOISE_SCALE_0",m),de(t,"DST_NOISE_SCALE_1",p),de(t,"DST_NOISE_FREQ_0",h),de(t,"DST_NOISE_FREQ_1",v),de(t,"DIR_MIN_SHR_FAC",b),de(t,"DIR_FREQ",g),de(t,"DIR_NOISE_SCALE",y),de(t,"DIR_NOISE_FREQ",E),de(t,"DIR_MIN_NOISE_FAC",w),de(t,"DST_MIN_FAC",A),de(t,"WAVES_HOR_FAC",T)}Y(t,e),H(t,e),t.shallow_water_col.set(e.water_settings.shallow_col),t.shore_water_col.set(e.water_settings.shore_col),t.shallow_water_col_fac=e.water_settings.shallow_col_fac,t.shore_water_col_fac=e.water_settings.shore_col_fac,de(t,"ABSORB",Je.glsl_value(e.water_settings.absorb_factor)),de(t,"SSS_STRENGTH",Je.glsl_value(e.water_settings.sss_strength)),de(t,"SSS_WIDTH",Je.glsl_value(e.water_settings.sss_width))}function z(e,t){var r=t.raytrace_mirror;e.reflect_factor=r.reflect_factor,e.fresnel_params[0]=r.fresnel,e.fresnel_params[1]=1-r.fresnel_factor/5}function Y(e,t){var r,a=0;switch(t.specular_shader){case"PHONG":case"COOKTORR":r=t.specular_hardness;break;case"WARDISO":r=t.specular_slope;break;case"TOON":r=t.specular_toon_size,a=t.specular_toon_smooth;break;case"BLINN":r=t.specular_ior,a=t.specular_hardness;break;default:Ge.error("unsupported specular shader: "+t.specular_shader+' (material "'+t.name+'")'),r=t.specular_hardness}e.specular_params[0]=t.specular_intensity,e.specular_params[1]=r,e.specular_params[2]=a}function H(e,t){switch(t.diffuse_shader){case"LAMBERT":e.diffuse_params[0]=0,e.diffuse_params[1]=0;break;case"OREN_NAYAR":e.diffuse_params[0]=t.roughness,e.diffuse_params[1]=0;break;case"FRESNEL":e.diffuse_params[0]=t.diffuse_fresnel,e.diffuse_params[1]=t.diffuse_fresnel_factor;break;case"MINNAERT":e.diffuse_params[0]=t.darkness,e.diffuse_params[1]=0;break;case"TOON":e.diffuse_params[0]=t.diffuse_toon_size,e.diffuse_params[1]=t.diffuse_toon_smooth;break;default:Ge.error("unsupported diffuse shader: "+t.diffuse_shader+' (material "'+t.name+'")'),e.diffuse_params[0]=0,e.diffuse_params[1]=0}}function W(e,t,r,a){if(!t.use_nodes||t.do_not_render)return!1;var n;switch(a){case"MAIN":Ie(e,"main.glslv","main.glslf"),n=!1;break;case"GLOW":Ie(e,"main.glslv","main.glslf"),n=!0;break;case"SHADOW":Ie(e,"shadow.glslv","shadow.glslf"),n=!1;break;case"COLOR_ID":Ie(e,"color_id.glslv","color_id.glslf"),n=!1}var _=t.node_tree,s=t.uuid,o=He.compose_ngraph_proxy(_,s,!1,r.name,t.name,a,{vc_name:r.active_vcol_name,uv_name:r.active_uv_name});if(!o.graph)return Ge.error('Failed to create node graph for material "'+t.name+'", disable nodes'),Q(e,t),!0;e.ngraph_proxy_id=o.id,e.has_nodes=!0,de(e,"NODES",1),de(e,"DOUBLE_SIDED_LIGHTING",t.use_double_sided_lighting?1:0),ue(e,"a_position"),t.use_orco_tex_coord&&ue(e,"a_orco_tex_coord"),U(e,t),e.use_backface_culling=t.use_backface_culling,e.offset_z=t.offset_z,n?(de(e,"ALPHA",1),de(e,"ALPHA_CLIP",0)):(de(e,"ALPHA","OPAQUE"===t.blend_mode?0:1),de(e,"ALPHA_CLIP","CLIP"===t.blend_mode?1:0)),e.xray=t.render_above_all&&"OPAQUE"!=t.blend_mode&&"CLIP"!=t.blend_mode&&"ALPHA_ANTIALIASING"!=t.blend_mode,e.emit=t.emit,e.ambient=t.ambient,z(e,t),t.is_wettable?de(e,"WETTABLE",1):de(e,"WETTABLE",0);var i=null,l=!1;ze.traverse(o.graph,function(r,a){switch(a.type){case"UVMAP":case"TEX_COORD_UV":case"GEOMETRY_UV":case"UV_MERGED":var n=a.data.name,_=a.data.value;e.uv_maps_usage||(e.uv_maps_usage={}),e.uv_maps_usage[_]=n;break;case"GEOMETRY_VC":case"GEOMETRY_VC1":case"GEOMETRY_VC2":case"GEOMETRY_VC3":var n=a.data.name,s=a.data.value;e.vertex_colors_usage[n]={generate_buffer:!0,src:[{name:s}]};var o=0;if("GEOMETRY_VC"==a.type)o=7;else for(var c=0;c<a.outputs.length;c++){var u="RGB".indexOf(a.outputs[c].identifier);u>-1&&(o|=1<<2-u)}e.vertex_colors_usage[n].src[0].mask=o;break;case"TEX_COORD_NO":case"TEX_COORD_RE":case"GEOMETRY_NO":case"FRESNEL":case"LAYER_WEIGHT":ue(e,"a_tbn");break;case"TEX_COORD_OB":de(e,"USE_MODEL_TSR_INVERSE",1);break;case"TEX_COORD_WI":de(e,"USE_POSITION_CLIP",1);break;case"MATERIAL_BEGIN":a.data.value.use_tangent_shading&&(de(e,"USE_TBN_SHADING",1),"PARTICLES"!=e.type&&ue(e,"a_shade_tangs")),ue(e,"a_tbn"),l=!0;break;case"BSDF_BEGIN":l=!0,ue(e,"a_tbn");break;case"TEXTURE_COLOR":case"TEXTURE_ENVIRONMENT_CUBE":case"TEXTURE_ENVIRONMENT_EQUIRECTANGULAR":case"TEXTURE_ENVIRONMENT_MIRROR_BALL":var n=a.data.name,d=a.data.bpy_name,f=a.data.value;Se(e,f,n,d);break;case"TEXTURE_NORMAL":case"B4W_PARALLAX":if(de(e,"CALC_TBN_SPACE",1),ue(e,"a_tbn"),a.data){var n=a.data.name,d=a.data.bpy_name,f=a.data.value;Se(e,f,n,d)}break;case"NORMAL_MAP":switch(ue(e,"a_tbn"),Number(a.dirs[0][1])){case He.NM_TANGENT:de(e,"CALC_TBN_SPACE",1);break;case He.NM_OBJECT:case He.NM_BLENDER_OBJECT:de(e,"USE_MODEL_TSR",1)}break;case"LAMP":a.data&&(e.lamp_uuid_indexes=a.data);break;case"B4W_REFRACTION":e.blend?e.refractive=!0:(e.refractive=!1,Ge.warn('Material "'+t.name+'" is not blend. Disabling refractions.')),de(e,"USE_POSITION_CLIP",1);break;case"VALTORGB":case"CURVE_VEC":case"CURVE_RGB":i||(i=a.data.texture);break;case"PARTICLE_INFO":"PARTICLES"==e.type&&a.data&&(e.part_node_data=a.data);break;case"VECT_TRANSFORM":switch(Number(a.dirs[1][1])){case He.VT_WORLD_TO_OBJECT:de(e,"USE_MODEL_TSR_INVERSE",1);break;case He.VT_WORLD_TO_CAMERA:de(e,"USE_VIEW_TSR",1);break;case He.VT_OBJECT_TO_WORLD:de(e,"USE_MODEL_TSR",1);break;case He.VT_OBJECT_TO_CAMERA:de(e,"USE_MODEL_TSR",1),de(e,"USE_VIEW_TSR",1);break;case He.VT_CAMERA_TO_WORLD:de(e,"USE_VIEW_TSR_INVERSE",1);break;case He.VT_CAMERA_TO_OBJECT:de(e,"USE_MODEL_TSR_INVERSE",1),de(e,"USE_VIEW_TSR_INVERSE",1)}break;case"OBJECT_INFO":de(e,"USE_MODEL_TSR",1),e.obj_info_params[1]=t.pass_index,e.obj_info_params[2]=Math.random();break;case"B4W_VECTOR_VIEW":case"GEOMETRY_VW":de(e,"USE_VIEW_TSR",1);break;case"B4W_REFLECT":de(e,"USE_VIEW_TSR_INVERSE",1);break;case"BUMP":case"DISPLACEMENT_BUMP":ue(e,"a_tbn"),je.get_standard_derivatives()?de(e,"USE_DERIVATIVES_EXT",1):Ge.warn('"OES_standard_derivatives" extension is not available. Disabling the BUMP node in the "'+t.name+'" material.');break;case"BSDF_TRANSPARENT":e.blend=!0,e.refractive=!0;break;case"BSDF_GLOSSY":case"BSDF_DIFFUSE":de(e,"USE_BSDF_SKY_DIM",1),je.get_texture_lod()&&de(e,"USE_TEXTURE_LOD_EXT",1)}}),i&&Se(e,i,"u_nodes_texture"),l||(e.use_shadeless=!0);var c=e.shaders_info.node_elements=He.compose_node_elements(o.graph);V(o.graph,e,t.name);for(var u=e.node_value_inds,d=e.node_rgb_inds,f=0;f<c.length;f++){var m=c[f];switch(m.id){case"VALUE":if(p=m.param_values[0])for(h=0;h<u.length;h+=3)if(u[h]==p){m.dirs.push(["VALUE_ROW_IND",u[h+1]]),m.dirs.push(["VALUE_COL_IND",u[h+2]]);break}break;case"RGB":var p=m.param_values[0];if(p)for(var h=0;h<d.length;h+=2)if(d[h]==p){m.dirs.push(["RGB_IND",d[h+1]]);break}}}return de(e,"NUM_VALUES",e.node_values.length/4),de(e,"NUM_RGBS",e.node_rgbs.length),!0}function q(e,t){var r=t._render.world_light_set;if(""!=r.ngraph_proxy_id){e.has_nodes=!0,e.ngraph_proxy_id=r.ngraph_proxy_id;var a=He.get_ngraph_proxy_cached(r.ngraph_proxy_id).graph;if(!a)return Ge.error('Failed to create node graph for world "'+t.world.name+'", disable nodes'),Q(e,t.world.name),!0;var n=null;ze.traverse(a,function(t,r){switch(r.type){case"TEXTURE_COLOR":case"TEXTURE_ENVIRONMENT_EQUIRECTANGULAR":case"TEXTURE_ENVIRONMENT_MIRROR_BALL":var a=r.data.name,_=r.data.bpy_name,s=r.data.value;Se(e,s,a,_);break;case"VALTORGB":case"CURVE_VEC":case"CURVE_RGB":n||(n=r.data.texture);break;case"VECT_TRANSFORM":switch(Number(r.dirs[1][1])){case He.VT_WORLD_TO_OBJECT:de(e,"USE_MODEL_TSR_INVERSE",1);break;case He.VT_WORLD_TO_CAMERA:de(e,"USE_VIEW_TSR",1);break;case He.VT_OBJECT_TO_WORLD:de(e,"USE_MODEL_TSR",1);break;case He.VT_OBJECT_TO_CAMERA:de(e,"USE_MODEL_TSR",1),de(e,"USE_VIEW_TSR",1);break;case He.VT_CAMERA_TO_WORLD:de(e,"USE_VIEW_TSR_INVERSE",1);break;case He.VT_CAMERA_TO_OBJECT:de(e,"USE_MODEL_TSR_INVERSE",1),de(e,"USE_VIEW_TSR_INVERSE",1)}break;case"B4W_VECTOR_VIEW":de(e,"USE_VIEW_TSR",1);break;case"B4W_REFLECT":de(e,"USE_VIEW_TSR_INVERSE",1)}}),n&&Se(e,n,"u_nodes_texture");var _=e.shaders_info.node_elements=He.compose_node_elements(a);V(a,e,t.world.name);for(var s=e.node_value_inds,o=e.node_rgb_inds,i=0;i<_.length;i++){var l=_[i];switch(l.id){case"VALUE":if(c=l.param_values[0])for(u=0;u<s.length;u+=3)if(s[u]==c){l.dirs.push(["VALUE_ROW_IND",s[u+1]]),l.dirs.push(["VALUE_COL_IND",s[u+2]]);break}break;case"RGB":var c=l.param_values[0];if(c)for(var u=0;u<o.length;u+=2)if(o[u]==c){l.dirs.push(["RGB_IND",o[u+1]]);break}}}return de(e,"NUM_VALUES",e.node_values.length/4),de(e,"NUM_RGBS",e.node_rgbs.length),!0}return!1}function V(e,t,r){var a=[],n=[],_=[],s=[];X(e,"",a,n,_,s),t.node_values=a,t.node_value_inds=n,t.node_rgbs=_,t.node_rgb_inds=s}function X(e,t,r,a,n,_){ze.traverse(e,function(e,s){if("VALUE"==s.type){c=K(t,s.name),r.push(s.outputs[0].default_value);var o=a.length/3,i=parseInt(o/4),l=parseInt(o%4);a.push(c,i,l)}else if("RGB"==s.type){var c=K(t,s.name),u=s.outputs[0].default_value.slice(0,3);n.push(u[0],u[1],u[2]),_.push(c,_.length/2)}});for(var s=r.length+4-r.length%4,o=r.length;o<s;o++)r.push(0)}function K(e,t){var r=e?e+"%join%":"";return r+=t}function Q(e,t){switch(e.type){case"SHADOW":Ie(e,"shadow.glslv","shadow.glslf");break;case"COLOR_ID":Ie(e,"color_id.glslv","color_id.glslf");break;default:Ie(e,"main.glslv","main_stack.glslf")}return de(e,"SHADELESS",1),ue(e,"a_position"),ue(e,"a_tbn"),_t.set(1,0,1,1,e.diffuse_color),t&&(de(e,"ALPHA","OPAQUE"===t.blend_mode?0:1),de(e,"ALPHA_CLIP","CLIP"===t.blend_mode?1:0),de(e,"VERTEX_COLOR",0),e.offset_z=t.offset_z,U(e,t),e.use_backface_culling=t.use_backface_culling),!0}function J(e,t,r){if(t.is_lens_flares||t.water_settings.is_water||t.do_not_render||"HALO"==t.type)return!1;if(U(e,t),e.use_backface_culling=t.use_backface_culling,e.blend)return!1;!t.use_nodes||"CLIP"!=t.blend_mode&&"ALPHA_ANTIALIASING"!=t.blend_mode?Ie(e,"shadow.glslv","shadow.glslf"):W(e,t,r,"SHADOW"),e.depth_mask=e.depth_mask&&!(st.reuse_depth_optimization&&"ALPHA_ANTIALIASING"==t.blend_mode),_t.set(0,0,0,t.alpha,e.diffuse_color),ue(e,"a_position"),ue(e,"a_tbn"),de(e,"ALPHA","OPAQUE"===t.blend_mode?0:1),e.texture_scale.set([1,1,1]);var a=F("use_map_color_diffuse",!0,t.texture_slots)[0];if(!a||"CLIP"!=t.blend_mode&&"ALPHA_ANTIALIASING"!=t.blend_mode)de(e,"TEXTURE_COLOR",0);else{switch(a.blend_type){case"MIX":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case"MULTIPLY":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY")}e.texture_scale.set(a.scale),de(e,"TEXTURE_COLOR",1),ue(e,"a_texcoord");var n=et.get_batch_texture(a),_=a.texture;"IMAGE"!=n.source&&"ENVIRONMENT_MAP"!=n.source&&"CANVAS"!=n.source&&"NONE"!=n.source||Se(e,n,"u_colormap0",_.name)}return!0}function $(e,t){var r=t.physics_settings,a=t.water_settings;return r.use_coll_physics?(e.use_ghost=r.use_ghost,e.collision_id=r.collision_id,e.collision_margin=r.collision_margin,e.collision_group=r.collision_group,e.collision_mask=r.collision_mask,e.friction=r.friction,e.elasticity=r.elasticity,!0):!!a.is_water&&(e.water=!0,e.water_dynamics=a.is_dynamic,e.dst_noise_scale0=a.dst_noise_scale0,e.dst_noise_scale1=a.dst_noise_scale1,e.dst_noise_freq0=a.dst_noise_freq0,e.dst_noise_freq1=a.dst_noise_freq1,e.dir_min_shore_fac=a.dir_min_shore_fac,e.dir_freq=a.dir_freq,e.dir_noise_scale=a.dir_noise_scale,e.dir_noise_freq=a.dir_noise_freq,e.dir_min_noise_fac=a.dir_min_noise_fac,e.dst_min_fac=a.dst_min_fac,e.waves_hor_fac=a.waves_hor_fac,!0)}function re(e,t,r){if(t.is_lens_flares||"HALO"==t.type)return!1;var a=t.blend_mode,n=a;"ALPHA_ANTIALIASING"==n&&(n="CLIP",t.blend_mode="CLIP"),U(e,t),e.use_backface_culling=t.use_backface_culling,e.z_sort=!1,e.depth_mask=!0,e.blend=!1,e.xray=t.render_above_all&&"OPAQUE"!=n&&"CLIP"!=n,t.use_nodes&&"CLIP"==n?W(e,t,r,"COLOR_ID"):Ie(e,"color_id.glslv","color_id.glslf"),_t.set(0,0,0,t.alpha,e.diffuse_color),ue(e,"a_position"),de(e,"ALPHA","OPAQUE"===n?0:1),e.texture_scale.set([1,1,1]);var _=F("use_map_color_diffuse",!0,t.texture_slots)[0];if(de(e,"ALPHA_CLIP","CLIP"===n?1:0),_&&"CLIP"==n){switch(_.blend_type){case"MIX":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case"MULTIPLY":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY")}e.texture_scale.set(_.scale),de(e,"TEXTURE_COLOR",1),ue(e,"a_texcoord");var s=et.get_batch_texture(_),o=_.texture;"IMAGE"!=s.source&&"ENVIRONMENT_MAP"!=s.source&&"CANVAS"!=s.source&&"NONE"!=s.source||Se(e,s,"u_colormap0",o.name)}else de(e,"TEXTURE_COLOR",0);return t.blend_mode=a,!0}function ae(e,t){return!(t&&(t.is_lens_flares||t.do_not_render)||(Ie(e,"debug_view.glslv","debug_view.glslf"),ue(e,"a_position"),ue(e,"a_tbn"),ue(e,"a_polyindex"),e.depth_mask=!0,nt.set(0,0,0,e.wireframe_edge_color),0))}function _e(e,t){if(!t.terrain_settings.is_terrain||t.do_not_render)return!1;if(U(e,t),e.use_backface_culling=t.use_backface_culling,e.blend=!1,e.z_sort=!1,e.depth_mask=!0,Ie(e,"grass_map.glslv","grass_map.glslf"),ue(e,"a_position"),t.terrain_settings.dynamic_grass_size)r=t.terrain_settings.dynamic_grass_size;else var r=null;if(t.terrain_settings.dynamic_grass_color)a=t.terrain_settings.dynamic_grass_color;else var a=null;e.vertex_colors_usage.a_grass_size={generate_buffer:!0,src:[]},r?(e.vertex_colors_usage.a_grass_size.src.push({name:r,mask:4}),de(e,"DYNAMIC_GRASS_SIZE",1)):de(e,"DYNAMIC_GRASS_SIZE",0),e.vertex_colors_usage.a_grass_color={generate_buffer:!0,src:[]},a?(e.vertex_colors_usage.a_grass_color.src.push({name:a,mask:7}),de(e,"DYNAMIC_GRASS_COLOR",1)):de(e,"DYNAMIC_GRASS_COLOR",0);var n=it.grass_tex_size;return de(e,"GRASS_TEXTURE_SIZE",Je.glsl_value(n)),!0}function se(e,t,r){if(t.do_not_render)return!1;var a=t.texture_slots;if(e.halo_particles)Ie(e,"particle_system.glslv","particle_system_stack.glslf"),de(e,"HALO_PARTICLES",1),P(e,t);else{var n={use_shadeless:!1,diffuse_shader:t.diffuse_shader,specular_shader:t.specular_shader,use_tangent_shading:t.use_tangent_shading};if(t.use_nodes)return Ie(e,"particle_system.glslv","particle_system.glslf"),W(e,t,r,"PARTICLES"),!0;Ie(e,"particle_system.glslv","particle_system_stack.glslf");var _=He.create_lighting_graph(t.uuid,n);e.shaders_info.node_elements=He.compose_node_elements(_);var s=F("use_map_color_diffuse",!0,a)[0];if(s){switch(de(e,"TEXTURE_COLOR",1),s.blend_type){case"MIX":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case"MULTIPLY":de(e,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY")}e.diffuse_color_factor=s.diffuse_color_factor,s.use_map_alpha?e.alpha_factor=s.alpha_factor:e.alpha_factor=0,Se(e,et.get_batch_texture(s),"default"+String(e.textures.length),s.texture.name)}}return e.diffuse_color.set(t.diffuse_color),e.diffuse_color[3]=t.alpha,e.ambient=t.ambient,e.diffuse_intensity=t.diffuse_intensity,e.emit=t.emit,e.specular_color.set(t.specular_color),e.specular_alpha=t.specular_alpha,ue(e,"a_position"),ue(e,"a_tbn"),de(e,"ALPHA","OPAQUE"===t.blend_mode?0:1),de(e,"ALPHA_CLIP","CLIP"===t.blend_mode?1:0),de(e,"PARTICLES_SHADELESS",t.use_shadeless?1:0),Y(e,t),H(e,t),U(e,t),e.use_backface_culling=t.use_backface_culling,e.xray=t.render_above_all&&"OPAQUE"!=t.blend_mode&&"CLIP"!=t.blend_mode&&"ALPHA_ANTIALIASING"!=t.blend_mode,e.offset_z=t.offset_z,!0}function oe(e,t){if(e.data_id=t.data_id,"PHYSICS"!==e.type){switch("DYNAMIC"==t.type||"COLOR_ID"==e.type?(t.is_hair_particles?de(e,"AU_QUALIFIER","GLSL_IN"):de(e,"AU_QUALIFIER","uniform"),de(e,"STATIC_BATCH",0)):(de(e,"AU_QUALIFIER","GLSL_IN"),de(e,"STATIC_BATCH",1)),"DEBUG_VIEW"==e.type&&(je.get_standard_derivatives()?de(e,"WIREFRAME_QUALITY",1):de(e,"WIREFRAME_QUALITY",0),e.debug_sphere?(de(e,"DEBUG_SPHERE",1),e.debug_sphere_dynamic?de(e,"DEBUG_SPHERE_DYNAMIC",1):de(e,"DEBUG_SPHERE_DYNAMIC",0)):de(e,"DEBUG_SPHERE",0),de(e,"ALPHA",1)),t.use_shape_keys&&"PARTICLES"!=e.type&&!t.is_hair_particles&&(e.use_shape_keys=t.use_shape_keys),t.wind_bending?(""!==t.main_bend_col?(e.vertex_colors_usage.a_bending_col_main={generate_buffer:!0,src:[{name:t.main_bend_col,mask:4}]},ue(e,"a_bending_col_main"),""!==t.detail_bend_col.leaves_stiffness&&""!==t.detail_bend_col.leaves_phase&&""!==t.detail_bend_col.overall_stiffness?(e.vertex_colors_usage.a_bending_col_detail={generate_buffer:!0,src:[{name:t.detail_bend_col.leaves_stiffness,mask:4},{name:t.detail_bend_col.leaves_phase,mask:2},{name:t.detail_bend_col.overall_stiffness,mask:1}]},ue(e,"a_bending_col_detail"),ue(e,"a_tbn"),de(e,"DETAIL_BEND",1)):de(e,"DETAIL_BEND",0),de(e,"MAIN_BEND_COL",1)):de(e,"MAIN_BEND_COL",0),t.bend_center_only?de(e,"BEND_CENTER_ONLY",1):de(e,"BEND_CENTER_ONLY",0),de(e,"WIND_BEND",1)):de(e,"WIND_BEND",0),de(e,"BILLBOARD_PRES_GLOB_ORIENTATION",0|t.billboard_pres_glob_orientation),t.billboard?de(e,"BILLBOARD",1):de(e,"BILLBOARD",0),t.billboard&&t.is_hair_particles?de(e,"HAIR_BILLBOARD",1):de(e,"HAIR_BILLBOARD",0),t.billboard_spherical?de(e,"BILLBOARD_SPHERICAL",1):de(e,"BILLBOARD_SPHERICAL",0),t.billboard_type){case"RANDOM":de(e,"BILLBOARD_RANDOM",1),de(e,"BILLBOARD_JITTERED",0);break;case"JITTERED":de(e,"BILLBOARD_RANDOM",0),de(e,"BILLBOARD_JITTERED",1);break;default:de(e,"BILLBOARD_RANDOM",0),de(e,"BILLBOARD_JITTERED",0)}t.dynamic_grass&&st.allow_vertex_textures?de(e,"DYNAMIC_GRASS",1):de(e,"DYNAMIC_GRASS",0),e.dynamic_grass=t.dynamic_grass,"PARTICLES"!=e.type&&(e.dynamic_geometry=t.dynamic_geometry),e.shadow_cast=t.shadow_cast,e.shadow_cast_only=t.shadow_cast_only,e.shadow_receive=t.shadow_receive&&!e.use_shadeless&&!(e.blend&&st.disable_blend_shadows_hack),st.rgba_fallback_shadows?("MAIN"==e.type&&e.shadow_receive||"SHADOW"==e.type)&&de(e,"RGBA_SHADOWS",1):de(e,"RGBA_SHADOWS",0),e.reflexible=t.reflexible,e.reflexible_only=t.reflexible_only,e.reflective=t.reflective,e.obj_info_params[0]=t.pass_index,e.lod_dist_max=t.lod_dist_max,e.lod_dist_min=t.lod_dist_min,e.lod_lower_border_range=t.lod_lower_border_range,e.lod_upper_border_range=t.lod_upper_border_range,e.cube_reflection_id=t.cube_reflection_id,e.plane_reflection_id=t.plane_reflection_id,t.is_skinning?(ue(e,"a_influence"),de(e,"SKINNED",1),st.skinning_hack?(de(e,"DISABLE_TANGENT_SKINNING",1),de(e,"FRAMES_BLENDING",0)):(de(e,"DISABLE_TANGENT_SKINNING",0),t.frames_blending?de(e,"FRAMES_BLENDING",1):de(e,"FRAMES_BLENDING",0)),de(e,"MAX_BONES",t.max_bones)):(de(e,"SKINNED",0),de(e,"FRAMES_BLENDING",0),de(e,"DISABLE_TANGENT_SKINNING",0)),t.vertex_anim?(de(e,"VERTEX_ANIM",1),st.vert_anim_mix_normals_hack?de(e,"VERTEX_ANIM_MIX_NORMALS_FACTOR",.5):de(e,"VERTEX_ANIM_MIX_NORMALS_FACTOR","u_va_frame_factor")):de(e,"VERTEX_ANIM",0),t.is_skinning&&t.vertex_anim&&at.panic("Skinning and vertex animation are mutually exlusive")}}function ie(e,t,r){if(t.length){for(var a=st.ssao&&r.b4w_enable_ssao,n=We.get_shadow_lamps(t,a),_=e.shaders_info,s=e.lamp_uuid_indexes,o=0,i=0;i<e.shaders_info.node_elements.length;i++){var l=e.shaders_info.node_elements[i];if("LIGHTING_LAMP"==l.id){var c=(h=t[o++%t.length]).light,u=We.get_scene_data(h,r);"SPOT"!=c.type&&"POINT"!=c.type||(v=Math.cos(c.spot_size/2)),"SPOT"==c.type&&(b=c.spot_blend*(1-v));var d=u.light_index,f=n.indexOf(h);l.dirs=[["LAMP_TYPE",c.type],["LAMP_IND",d],["LAMP_SPOT_SIZE",Je.glsl_value(v||.01)],["LAMP_SPOT_BLEND",Je.glsl_value(b||.01)],["LAMP_LIGHT_DIST",Je.glsl_value(c.distance)],["LAMP_USE_SPHERE",c.use_sphere?1:0],["LAMP_SHADOW_MAP_IND",f]]}else if("LAMP"==l.id&&s)for(var m=l.dirs[0][1],p=0;p<t.length;p++){var h=t[p];if(s[h.uuid]==m){if("SPOT"==(c=h.light).type||"POINT"==c.type)var v=Math.cos(c.spot_size/2);if("SPOT"==c.type)var b=c.spot_blend*(1-v);l.dirs.push(["LAMP_TYPE",c.type],["LAMP_SPOT_SIZE",Je.glsl_value(v||.01)],["LAMP_SPOT_BLEND",Je.glsl_value(b||.01)],["LAMP_LIGHT_DIST",Je.glsl_value(c.distance)],["LAMP_USE_SPHERE",c.use_sphere?1:0])}}}if(s){var g=0;for(var y in s)g++;for(e.lamp_light_positions=new Float32Array(3*g),e.lamp_light_directions=new Float32Array(3*g),e.lamp_light_color_intensities=new Float32Array(3*g),Je.set_directive(_,"NUM_LAMP_LIGHTS",g),i=0;i<t.length;i++)le(e,t[i])}}}function le(e,t){if(t.uuid in e.lamp_uuid_indexes){var r=e.lamp_uuid_indexes[t.uuid],a=tt.get_trans_view(t.render.world_tsr);e.lamp_light_positions.set(a,3*r),e.lamp_light_directions.set(t.light.direction,3*r),e.lamp_light_color_intensities.set(t.light.color_intensity,3*r)}}function ce(e,t){for(var r=0;r<t.length;r++){var a=t[r].settings.b4w_vcol_from_name,n=t[r].settings.b4w_vcol_to_name;""!==a&&""!==n&&(e.vertex_colors_usage[a]={generate_buffer:!1,src:[{name:a,mask:7}]})}}function ue(e,t){var r=e.common_attributes;-1==r.indexOf(t)&&r.push(t),e.common_attributes=r.sort()}function de(e,t,r){Je.set_directive(e.shaders_info,t,r)}function fe(e,t){if("PHYSICS"!=e.type){var r=e.draw_mode;if(e.halo&&"PARTICLES"!=e.type&&(t=rt.extract_halo_submesh(t)),e.water_generated_mesh){var a=e.water_num_cascads,n=e.water_subdivs,_=e.water_detailed_dist;t=Ve.generate_cascaded_grid(a,n,_)}var s=rt.submesh_to_bufs_data(t,r,e.vertex_colors_usage);e.bufs_data=s,ut||e.dynamic_geometry||e.z_sort||e.use_shape_keys||(s.ibo_array=null,s.vbo_source_data.length=0);var o=t.va_frames.length;e.num_vertices=t.base_length*o,me(e)?rt.is_indexed(t)?e.num_triangles=t.indices.length/3*o:e.num_triangles=t.base_length/3*o:e.num_triangles=0,ct&&(e.submesh=t)}else"NAVMESH"==e.subtype?e.bufs_data=rt.submesh_to_bufs_data(t,rt.DM_DEFAULT,[]):(t.shape_keys.length>0&&rt.submesh_init_shape_keys(t,t.va_frames[0]),e.submesh=t)}function me(e){switch(e.draw_mode){case rt.DM_DEFAULT:case rt.DM_TRIANGLES:case rt.DM_DYNAMIC_TRIANGLES:return!0;default:return!1}}function pe(e,t,r){var a=t.settings;switch(a.b4w_billboard_align){case"VIEW":de(e,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW");break;case"XY":de(e,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_XY");break;case"YZ":de(e,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_YZ");break;case"ZX":de(e,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_ZX");break;default:at.panic("Wrong billboard align value")}de(e,"BILLBOARD",0);var n=a.b4w_enable_soft_particles&&We.check_obj_soft_particles_accessibility(r,a);de(e,"SOFT_PARTICLES",a.b4w_particles_softness>0&&n&&st.depth_tex_available?1:0),de(e,"SOFT_STRENGTH",Je.glsl_value(a.b4w_particles_softness));var _="WORLD"==a.b4w_coordinate_system?1:0;Je.set_directive(e.shaders_info,"WORLD_SPACE",_)}function he(e,t,a,n,_,s,o,i,l,c,u,d){var f=e._object,m=[],p=i.b4w_dynamic_grass;if(!c&&p)return m;for(var h="INSTANCE"==i.b4w_wind_bend_inheritance,v="INSTANCE"==i.b4w_shadow_inheritance,b="INSTANCE"==i.b4w_reflection_inheritance,g=[],y=[],E=0;E<_.length;E++){var w=_[E]._object.render;(z=We.clone_render(t)).billboard=i.b4w_hair_billboard,z.billboard_type=i.b4w_hair_billboard_type,z.billboard_spherical="SPHERICAL"==i.b4w_hair_billboard_geometry,z.dynamic_grass=p,z.is_hair_particles=!0,h?(z.wind_bending=w.wind_bending,z.wind_bending_angle=w.wind_bending_angle,z.wind_bending_freq=w.wind_bending_freq,z.detail_bending_freq=w.detail_bending_freq,z.main_bend_col=w.main_bend_col,z.detail_bending_amp=w.detail_bending_amp,z.branch_bending_amp=w.branch_bending_amp,z.wind_bending_amp=w.wind_bending_amp,z.detail_bend_col=w.detail_bend_col,z.bend_center_only=!1):(z.wind_bending=f.render.wind_bending,z.wind_bending_angle=f.render.wind_bending_angle,z.wind_bending_freq=f.render.wind_bending_freq,z.detail_bending_freq=f.render.detail_bending_freq,z.main_bend_col=f.render.main_bend_col,z.detail_bending_amp=f.render.detail_bending_amp,z.branch_bending_amp=f.render.branch_bending_amp,z.wind_bending_amp=f.render.wind_bending_amp,z.detail_bend_col=f.render.detail_bend_col,z.bend_center_only=!0),v?(z.shadow_cast=w.shadow_cast,z.shadow_cast_only=w.shadow_cast_only,z.shadow_receive=w.shadow_receive):(z.shadow_cast=f.render.shadow_cast,z.shadow_cast_only=f.render.shadow_cast_only,z.shadow_receive=f.render.shadow_receive),b?(z.reflexible=w.reflexible,z.reflexible_only=w.reflexible_only,z.reflective=w.reflective,z.cube_reflection_id=w.cube_reflection_id,z.plane_reflection_id=w.plane_reflection_id,z.reflection_type=w.reflection_type):(z.reflexible=f.render.reflexible,z.reflexible_only=f.render.reflexible_only,z.reflective=f.render.reflective,z.cube_reflection_id=f.render.cube_reflection_id,z.plane_reflection_id=f.render.plane_reflection_id,z.reflection_type=f.render.reflection_type),g.push(z);var A=o[E];A||(A=new Float32Array),d&&at.init_rand_r_seed(l.seed,u);var T=new Float32Array(3),x=new Float32Array([0,0,0,1]),O=[],R=Ke.check_particles_bin_format(st.loaded_data_version)&&!i.b4w_initial_rand_rotation&&!i.b4w_hair_billboard,k=4;for(R&&(k=8),F=0;F<A.length;F+=k){T[0]=A[F],T[1]=A[F+1],T[2]=A[F+2];var N=A[F+3]*tt.get_scale(w.world_tsr);if(i.b4w_initial_rand_rotation){switch(i.b4w_rotation_type){case"XYZ":M=new Float32Array([at.rand_r(u),at.rand_r(u),at.rand_r(u)]),nt.normalize(M,M);break;case"Z":var M=new Float32Array([0,0,1]);break;default:at.panic("Unsupported random rotation type: "+i.b4w_rotation_type)}var I=i.b4w_rand_rotation_strength;Xe.setAxisAngle(M,I*(2*Math.PI*at.rand_r(u)-Math.PI),x)}else if(R&&(x.set(A.subarray(F+4,F+8)),at.quat_bpy_b4w(x,x),!i.use_whole_group))if(i.use_rotation_dupli){var L=tt.get_quat_view(w.world_tsr);Xe.multiply(x,L,x)}else Xe.multiply(x,mt,x);var C=tt.set_sep(T,N,x,tt.create());O.push(C)}y.push(O)}for(var P={},D=0,E=0;E<_.length;E++)for(var U=_[E]._object.materials,F=0;F<U.length;F++)U[F].name in P?P[U[F].name]++:(P[U[F].name]=1,D++);D=D||1;for(var B={},E=0;E<_.length;E++){var G=_[E],j=s[E],z=g[E],Y={};if(z.wind_bending&&(Y.au_wind_bending_amp=[z.wind_bending_amp],Y.au_wind_bending_freq=[z.wind_bending_freq],Y.au_detail_bending_freq=[z.detail_bending_freq],Y.au_detail_bending_amp=[z.detail_bending_amp],Y.au_branch_bending_amp=[z.branch_bending_amp],z.wind_bending_amp=0,z.wind_bending_freq=0,z.detail_bending_freq=0,z.detail_bending_amp=0,z.branch_bending_amp=0),(O=y[E]).length){for(var H=G.data,U=G._object.materials,W=new Array(U.length),q=new Array(U.length),F=0;F<U.length;F++)if(!Ue(f,F)&&!rt.has_empty_submesh(H,F))for(var V=0;V<j.length;V++){var X=j[V],K=r(X),Z=U[F];if("MAIN"==X?W[F]=K:"DEBUG_VIEW"==X&&(q[F]=K),K.cluster_id=e.b4w_cluster_data.cluster_id,ve(K,Z)&&S(K,Z,H)){"SHADOW"==X&&W[F]&&(K.use_shadeless=W[F].use_shadeless),K.draw_mode=rt.DM_DEFAULT,oe(K,z),K.odd_id_prop=De(K,z,i.uuid),K.do_not_cull=e.b4w_do_not_cull||i.b4w_dynamic_grass,"MAIN"==K.type&&(K.caustics=e.b4w_caustics),de(K,"DISABLE_FOG",0|("COLOR_ID"!=X&&"SHADOW"!=X&&e.b4w_disable_fogging)),"JITTERED"==i.b4w_hair_billboard_type&&(K.jitter_amp=i.b4w_hair_billboard_jitter_amp,K.jitter_freq=i.b4w_hair_billboard_jitter_freq),p&&(K.grass_scale_threshold=i.b4w_dynamic_grass_scale_threshold),h||(delete K.vertex_colors_usage.a_bending_col_main,delete K.vertex_colors_usage.a_bending_col_detail);var Q=rt.extract_submesh(H,F,K.common_attributes,t.bone_skinning_info,K.vertex_colors_usage,K.uv_maps_usage),J=f.render.world_tsr,$=!0;if(P[Z.name]>1){var ee=0;for(var te in Q.va_frames)ee++;$=Q.indices.length*O.length*ee*P[Z.name]>pt*D}var re=st.allow_instanced_arrays_ext&&$&&"PHYSICS"!=K.type;if(re){K.inst_array_state=i.use_whole_group?vt:ht;var ae=rt.clone_submesh(Q);if(rt.calc_unit_boundings(Q,ae,O),ae.instanced_array_data={tsr_array:O,stat_part_em_tsr:J,static_hair:"STATIC"==t.type,submesh_params:Y,part_inh_attrs:{},dyn_grass:p},z.wind_bending&&z.bend_center_only){var ne=nt.fromValues(0,0,0);tt.transform_vec3(ne,f.render.world_tsr,ne);for(var _e=[],se=0;se<O.length;se++)_e.push(ne[0],ne[1],ne[2]);ae.instanced_array_data.part_inh_attrs.a_emitter_center={num_comp:3,data:_e}}rt.calc_unit_boundings(Q,Q,O),"STATIC"==t.type&&rt.bounding_data_apply_transform(ae.submesh_bd,J)}else ae=Ee(ae=rt.make_propagated_submesh(Q,Y,O),O),z.wind_bending&&z.bend_center_only&&(ae=we(ae,f.render.world_tsr));var ie=ge(i.b4w_vcol_from_name,i.b4w_vcol_to_name,K,a,!h,H);de(K,"USE_INSTANCED_PARTCLS",(ae=Ae(ae,O,f.render.bb_local,n,ie,K.vertex_colors_usage,B,re)).instanced_array_data?1:0),ke(K),m.push({batch:K,obj_render:t,batch_render:z,submesh:ae,mat_names:[Z.name],rel_bpy_objects:[e]})}}for(F=0;F<q.length;F++)q[F]&&(q[F].debug_main_batch_id=W[F].id,ke(q[F]))}}return m}function ve(e,t){var r=!0;return"NODES_GLOW"==e.type&&(r=He.check_material_glow_output(t)),r}function be(e,t,r){for(e.cell_size=new Float32Array(3),e.base_point=new Float32Array(3),e.verts_indices=new Uint32Array(r.length/3),e.octs_indices=new Uint32Array(r.length/3),e.cell_size[0]=(t.max_x-t.min_x)/ft,e.cell_size[1]=(t.max_y-t.min_y)/ft,e.cell_size[2]=(t.max_z-t.min_z)/ft,e.base_point[0]=t.min_x,e.base_point[1]=t.min_y,e.base_point[2]=t.min_z,c=0;c<r.length/3;c++){var a=r[3*c],n=r[3*c+1],_=r[3*c+2],s=at.trunc((a-e.base_point[0])/e.cell_size[0]),o=at.trunc((n-e.base_point[1])/e.cell_size[1]),i=at.trunc((_-e.base_point[2])/e.cell_size[2]);s=at.clamp(s,0,ft-1),o=at.clamp(o,0,ft-1),i=at.clamp(i,0,ft-1),e.verts_indices[c]=c,e.octs_indices[c]=i*Math.pow(ft,2)+o*ft+s}for(rt.sort_two_arrays(e.octs_indices,e.verts_indices,rt.SORT_NUMERIC,!0),e.verts_offsets=new Uint32Array(Math.pow(ft,3)),c=0;c<e.octs_indices.length;c++){var l=e.octs_indices[c];e.verts_offsets[l]++}delete e.octs_indices;for(var c=1;c<e.verts_offsets.length;c++)e.verts_offsets[c]+=e.verts_offsets[c-1];return e}function ge(e,t,r,a,n,_){var s=[];if(""!==e&&""!==t){var o=ye(t,r.vertex_colors_usage);if(o.length>0)for(var i=0;i<o.length;i+=3)s.push({emitter_attr:e,emitter_mask:7,particle_attr:o[i],particle_mask:o[i+1],dst_channel_offset:o[i+2]});else rt.has_attr(r.common_attributes,"a_color")&&t==_.active_vcol_name&&s.push({emitter_attr:e,emitter_mask:7,particle_attr:"a_color",particle_mask:7,dst_channel_offset:0})}return n&&("a_bending_col_main"in a&&s.push({emitter_attr:"a_bending_col_main",emitter_mask:4,particle_attr:"a_bending_col_main",particle_mask:4,dst_channel_offset:0}),"a_bending_col_detail"in a&&s.push({emitter_attr:"a_bending_col_detail",emitter_mask:7,particle_attr:"a_bending_col_detail",particle_mask:7,dst_channel_offset:0})),s}function ye(e,t){var r=[];for(var a in t)for(var n=t[a].src,_=0,s=0;s<n.length;s++){var o=n[s].mask;e==n[s].name&&r.push(a,o,_),_+=at.rgb_mask_get_channels_count(o)}return r}function Ee(e,t){e.va_common.au_center_pos=new Float32Array(3*e.base_length);for(var r=t.length,a=e.base_length/r,n=0;n<r;n++)for(var _=t[n],s=3*a*n,o=0;o<a;o++)e.va_common.au_center_pos[s+3*o]=_[0],e.va_common.au_center_pos[s+3*o+1]=_[1],e.va_common.au_center_pos[s+3*o+2]=_[2];return e}function we(e,t){e.va_common.a_emitter_center=new Float32Array(3*e.base_length);var r=nt.fromValues(0,0,0);tt.transform_vec3(r,t,r);for(var a=0;a<e.base_length;a++)e.va_common.a_emitter_center[3*a]=r[0],e.va_common.a_emitter_center[3*a+1]=r[1],e.va_common.a_emitter_center[3*a+2]=r[2];return e}function Ae(e,t,r,a,n,_,s,o){for(var i=!1,l=0;l<n.length;l++)if(p=n[l].emitter_attr,(v=a.va_common[p])&&v.length>0){i=!0;break}if(o)var c=e.instanced_array_data.part_inh_attrs;if(i)for(var u=Te(r,a.va_frames[0].a_position,t,s),d=e.base_length/t.length,l=0;l<n.length;l++){var f=n[l].particle_attr,m=n[l].particle_mask,p=n[l].emitter_attr,h=n[l].emitter_mask,v=a.va_common[p];switch(f){case"a_bending_col_main":b=1;break;case"a_bending_col_detail":case"a_color":b=3;break;default:for(var b=0,g=0;g<_[f].src.length;g++)b+=at.rgb_mask_get_channels_count(_[f].src[g].mask)}if(v&&v.length>0){var y=at.rgb_mask_get_channels_count(h),E=at.rgb_mask_get_channels_count(m),w=h&m,A=at.rgb_mask_get_channels_presence(w);if(w!=m&&Ge.error("Wrong color extraction from "+p+" to "+f+"."),o)for(c[f]={num_comp:b,data:[]},g=0;g<t.length;g++)for(var T=u[g],x=T*y,O=0;O<A.length;O++)A[O]&&(M=at.rgb_mask_get_channel_presence_index(h,O),c[f].data.push(v[x+M]));else for("a_bending_col_main"!=f&&"a_bending_col_detail"!=f||(e.va_common[f]=new Float32Array(e.base_length*E)),g=0;g<t.length;g++){var x=(T=u[g])*y,R=g*d*b;if(-1!=T)for(var k=0;k<d;k++)for(var N=k*b,O=0;O<A.length;O++)if(A[O]){var M=at.rgb_mask_get_channel_presence_index(h,O),I=n[l].dst_channel_offset+at.rgb_mask_get_channel_presence_index(m,O);e.va_common[f][R+N+I]=v[x+M]}}}else e.va_common[f]=new Float32Array(0)}return e}function Te(e,t,r,a){var n=new Float32Array(3),_=new Float32Array(3),s=new Uint32Array(r.length);"verts_indices"in a||be(a,e,t);for(var o=0;o<r.length;o++){n[0]=r[o][0],n[1]=r[o][1],n[2]=r[o][2];var i=1e10,l=-1,c=at.trunc((n[0]-a.base_point[0])/a.cell_size[0]),u=at.trunc((n[1]-a.base_point[1])/a.cell_size[1]),d=at.trunc((n[2]-a.base_point[2])/a.cell_size[2]);c=at.clamp(c,0,ft-1),u=at.clamp(u,0,ft-1);for(var f=(d=at.clamp(d,0,ft-1))*Math.pow(ft,2)+u*ft+c,m=0==f?0:a.verts_offsets[f-1],p=a.verts_offsets[f],h=m;h<p;h++){var v=a.verts_indices[h];_[0]=t[3*v],_[1]=t[3*v+1],_[2]=t[3*v+2],nt.sub(_,n,_),(b=nt.sqrLen(_))<=i&&(i=b,l=v)}if(-1==l)for(h=0;h<t.length/3;h++){_[0]=t[3*h],_[1]=t[3*h+1],_[2]=t[3*h+2],nt.sub(_,n,_);var b=nt.sqrLen(_);b<=i&&(i=b,l=h)}s[o]=l}return s}function xe(e,t,r,a,n){for(var _=t.length,s={},o=0;o<e.length;o+=n)s[i=Math.floor(_*at.rand_r(r))]=s[i]||[],s[i].push(e[o],e[o+1],e[o+2],e[o+3]),a&&s[i].push(e[o+4],e[o+5],e[o+6],e[o+7]);for(var i in s)s[i]=new Float32Array(s[i]);return s}function Oe(e,t,r,a){for(var n={},_=new Float32Array([0,0,0,1]),s=0;s<e.length;s+=a)for(var o=0;o<t.length;o++){var i=nt.create(),l=tt.get_scale(t[o].render.world_tsr),c=tt.get_trans_view(t[o].render.world_tsr);nt.scale(c,l,i);var u=nt.clone([e[s],e[s+1],e[s+2]]);n[o]||(n[o]=new Float32Array(e.length)),r&&(n[o][s+4]=_[0]=e[s+4],n[o][s+5]=_[1]=e[s+5],n[o][s+6]=_[2]=e[s+6],n[o][s+7]=_[3]=e[s+7],at.quat_bpy_b4w(_,_),at.transformQuatFast(i,_,i)),nt.add(u,i,u),n[o][s]=u[0],n[o][s+1]=u[1],n[o][s+2]=u[2],n[o][s+3]=e[s+3]}return n}function Re(e,t,r,a,n,_){for(var s={},o=[],i=0;i<t.length;i++)for(var l=t[i],c=l.origin_name||l.name,u=0;u<r.length;u++){var d=r[u];c==d.name&&o.push(d)}for(r.length!=o.length&&Ge.error("dupli weights match failed"),i=0;i<e.length;i+=_)s[f=function(e){for(var t=[0],r=0;r<e.length;r++){var n=e[r];t[r+1]=t[r]+n.count}for(var _=t[t.length-1]*at.rand_r(a),s=0,r=0;r<t.length;r++)if(_>=t[r]&&_<t[r+1]){s=r;break}return s}(o)]=s[f]||[],s[f].push(e[i],e[i+1],e[i+2],e[i+3]),n&&s[f].push(e[i+4],e[i+5],e[i+6],e[i+7]);for(var f in s)s[f]=new Float32Array(s[f]);return s}function ke(e){Ne(e,function(e){e.id=0,e.id=at.calc_variable_id(e,0)})}function Ne(e,t){for(var r=null,a=null,n=[],_=0;_<e.textures.length;_++){var s=e.textures[_],o=s.canvas_context;o&&(r||(r={}),r[_]=o,s.canvas_context=null);var i=s.video_file;i&&(a||(a={}),a[_]=i,s.video_file=null),n.push(s.num_users),s.num_users=0}var l=e.bounds_local;e.bounds_local=null;var c=e.vaos;e.vaos=null;var u=e.bufs_data;e.bufs_data=null;var d=e.submesh;if(e.submesh=null,t(e),e.bufs_data=u,e.submesh=d,e.vaos=c,e.bounds_local=l,r)for(var _ in r)e.textures[_].canvas_context=r[_];if(a)for(var _ in a)e.textures[_].video_file=a[_];for(_=0;_<e.textures.length;_++)e.textures[_].num_users=n[_]}function Me(e,t,a,n){var _=r("DEBUG_VIEW");if(Ie(_,"debug_view.glslv","debug_view.glslf"),_.debug_sphere=!0,_.depth_mask=!0,_.odd_id_prop=De(_,e,t),_.debug_sphere_dynamic=a,oe(_,e),ke(_),n.use_be){var s=n.bounds_local.be,o=nt.create(),i=Ve.generate_uv_sphere(16,8,1,o,!1,!1),l=nt.fromValues(nt.length(s.axis_x),nt.length(s.axis_y),nt.length(s.axis_z));rt.scale_submesh_xyz(i,l,o);var c=nt.normalize(s.axis_x,bt),u=nt.normalize(s.axis_y,gt),d=nt.normalize(s.axis_z,yt);!l[0]&&l[1]&&l[2]?nt.cross(u,d,c):!l[1]&&l[0]&&l[2]?nt.cross(d,c,u):!l[2]&&l[0]&&l[1]&&nt.cross(c,u,d);var f=at.ellipsoid_axes_to_mat3(c,u,d,At);Ye.invert(f,f);var m=Xe.fromMat3(f,Et);tt.set_quat(m,wt),tt.set_scale(1,wt),tt.set_trans(s.center,wt),rt.submesh_apply_transform(i,wt)}else var p=n.bounds_local.bs,i=Ve.generate_uv_sphere(16,8,p.radius,p.center,!1,!1);return Fe.copy_boundings(n.bounds_local,_.bounds_local),rt.submesh_drop_indices(i,1,!0),i.va_common.a_polyindex=rt.extract_polyindices(i),fe(_,i),_}function Ie(e,t,r){e.shaders_info.vert=t,e.shaders_info.frag=r,Je.set_default_directives(e.shaders_info)}function Se(e,t,r,a){a=a||"",-1==e.texture_names.indexOf(r)&&(e.textures.push(t),e.texture_names.push(r),e.bpy_tex_names.push(a)),e.shader&&Ze.assign_texture_uniforms(e)}function Le(e){return e.shaders_info||at.panic("No shaders info for batch "+e.name),e.shader=Je.get_compiled_shader(e.shaders_info),Ce(e),e.shaders_info.status===Je.VALID&&(Ze.assign_uniform_setters(e.shader),Ze.assign_attribute_setters(e),Ze.assign_texture_uniforms(e),!0)}function Ce(e){var t=e.shaders_info;if(t.status===Je.VALID){var r=e.shader.attributes,a=e.bufs_data.pointers;for(var n in r)a[n]||at.panic('missing data for "'+n+'" attribute')}t.status&Je.INVALID_TEX_IMAGE_UNITS&&Ge.error("Texture limit exceeded for shader - "+t.frag+', materials: "'+e.material_names.join(", ")+'". Maximum texture count: '+ot.max_texture_image_units+", actual texture count: "+t.texture_count),t.status&Je.INVALID_F_UNIFORM_VECTORS&&Ge.error("Fragment uniform limit exceeded for shader - "+t.frag+', materials: "'+e.material_names.join(", ")+'". '),t.status&Je.INVALID_V_UNIFORM_VECTORS&&Ge.error("Vertex uniform limit exceeded for shader - "+t.vert+', materials: "'+e.material_names.join(", ")+'". '),t.status&Je.INVALID_VERTEX_ATTRIBS&&Ge.error("Vertex attribute limit exceeded for shader - "+t.vert+', materials: "'+e.material_names.join(", ")+'". Maximum attribute count: '+ot.max_vertex_attribs+", actual attribute count: "+t.attribute_count),t.status&Je.INVALID_VARYING_VECTORS&&Pe(e),t.status&Je.COMPILATION_ERROR&&Ge.error("Shader compilation/linking error: "+t.vert+", "+t.frag+', materials: "'+e.material_names.join(", ")+'"')}function Pe(e){if("MAIN"!=e.type||e.has_nodes||Ge.error("Varying limit exceeded for shader - "+e.shaders_info.frag+', materials: "'+e.material_names.join(", ")+'"'),"MAIN"==e.type&&e.has_nodes||"NODES_GLOW"==e.type){var t=0,r=0;e.uv_maps_usage&&(t=at.get_dict_length(e.uv_maps_usage)),e.vertex_colors_usage&&(r=at.get_dict_length(e.vertex_colors_usage)),Ge.error("Varying limit exceeded for node shader - "+e.shaders_info.frag+", uv: "+t+", vc: "+r+', materials: "'+e.material_names.join(", ")+'"')}}function De(e,t,r){var a=r;return"NAVMESH"==e.subtype?a:t.dynamic_geometry?"_odd_id_"+at.unique_id():a}function Ue(e,t){return t>=0&&t<e.mat_inheritance_data.is_disabled.length&&e.mat_inheritance_data.is_disabled[t]}var Fe=b(e),Be=g(e),Ge=m(e),je=y(e),ze=E(e),Ye=u(e),He=ne(e),We=k(e),qe=N(e),Ve=C(e),Xe=d(e),Ke=Z(e),Ze=te(e),Qe=G(e),Je=B(e),$e=A(e),et=ee(e),tt=v(e),rt=w(e),at=h(e),nt=l(e),_t=c(e),st=Be.defaults,ot=Be.context_limits,it=Be.scenes,lt=Be.hmd_params,ct=!1,ut=!1,dt=!1,ft=20,mt=new Float32Array([0,0,-Math.sqrt(.5),Math.sqrt(.5)]),pt=2e5,ht=1,vt=2,bt=new Float32Array(3),gt=new Float32Array(3),yt=new Float32Array(3),Et=new Float32Array(4),wt=tt.create(),At=Ye.create(),Tt={},xt=new Float32Array(24);t.batch_get_debug_storage=function(e){return Tt[e]||null},t.batch_set_debug_storage=function(e,t){Tt[e]=t},t.clone_batch=a,t.generate_main_batches=function(e,t,r,a){var n=o(t,e._render.graph);for(n=O(n),h=0;h<n.length;h++)if((p=n[h].batch).material_names=n[h].mat_names,fe(p,n[h].submesh),ie(p,r,e),"STATIC"==n[h].render.type&&"COLOR_ID"!=p.type){var _=at.unique_name("%meta%"+p.type+"%"+p.material_names.join("%")+"%"),i=We.create_object(_,"MESH");if(We.meta_obj_append_render(i,n[h].render),We.append_scene_data(i,e),We.append_batch(i,e,p),a.push(i),"MAIN"==p.type)for(d=0;d<n[h].rel_bpy_objects.length;d++)(l=n[h].rel_bpy_objects[d]._object).meta_objects.push(i)}else l=n[h].rel_bpy_objects[0]._object,We.append_batch(l,e,p);if(st.debug_view){for(h=0;h<n.length;h++)if("DYNAMIC"==(f=n[h].render).type){var l=n[h].rel_bpy_objects[0]._object;if("MAIN"==(p=n[h].batch).type){for(var c=(v=We.get_scene_data(l,e)).batches,u=!1,d=0;d<c.length;d++)if(c[d].debug_sphere){u=!0;continue}if(u)continue;m=Me(f,l.name,!0,p),We.append_batch(l,e,m)}}for(h=0;h<a.length;h++){var f=(l=a[h]).render;if("MAIN"==(p=(v=We.get_scene_data(l,e)).batches[0]).type){var m=Me(f,l.name,!1,p);We.append_batch(l,e,m)}}for(h=0;h<n.length;h++){var p=n[h].batch;"DEBUG_VIEW"==p.type&&(p.debug_id_color=h)}}for(h=0;h<t.length;h++)for(var c=(v=We.get_scene_data(t[h]._object,e)).batches,d=0;d<c.length;d++)s(c[d]);for(var h=0;h<a.length;h++)for(var v=We.get_scene_data(a[h],e),c=v.batches,d=0;d<c.length;d++)s(c[d])},t.append_sky_batch_to_world=function(e,t,n){var _=e._render.world_light_set,o=r("MAIN");if(Ie(o,"sky.glslv","sky.glslf"),o.is_sky=!0,o.depth_mask=!1,t.procedural_skydome)de(o,"PROCEDURAL_SKYDOME",1),o.draw_proc_sky=!0;else{var i=_.sky_texture_param;Se(o,Qe.find_subs(e._render.graph,$e.SKY).camera.color_attachment,"u_sky"),i&&(de(o,"WO_SKYTEX",1),i.invert&&de(o,"MTEX_NEGATIVE",1),i.use_rgb_to_intensity&&de(o,"MTEX_RGBTOINT",1),de(o,"BLENDTYPE",i.blend_type),i.use_map_blend&&de(o,"WOMAP_BLEND",1),i.use_map_horizon&&de(o,"WOMAP_HORIZ",1),i.use_map_zenith_up&&de(o,"WOMAP_ZENUP",1),i.use_map_zenith_down&&de(o,"WOMAP_ZENDOWN",1)),_.use_sky_blend&&de(o,"WO_SKYBLEND",1),_.use_sky_paper&&de(o,"WO_SKYPAPER",1),_.use_sky_real&&de(o,"WO_SKYREAL",1)}t.reflexible&&(o.reflexible=!0,t.reflexible_only&&(o.reflexible_only=!0)),ue(o,"a_position");var l=Ve.generate_fullscreen_quad();if(fe(o,l),s(o),o.do_not_cull=!0,ke(o),We.append_batch(n,e,o),Qe.find_subs(e._render.graph,$e.DEBUG_VIEW)){var c=a(o);c.type="DEBUG_VIEW",c.subtype="",ae(c),de(c,"DEBUG_VIEW_SPECIAL_SKYDOME",1),l.va_common.a_polyindex=rt.extract_polyindices(l),fe(c,l),c.debug_main_batch_id=o.id,ke(c),We.append_batch(n,e,c)}},t.create_forked_batches=function(e,t,r){for(var n=We.get_scene_data(e,r).batches,_=[],s=Qe.find_subs(t,$e.MAIN_PLANE_REFLECT),o=Qe.find_subs(t,$e.MAIN_CUBE_REFLECT),i=Qe.find_subs(t,$e.OUTLINE_MASK),l=Qe.find_subs(t,$e.COLOR_PICKING),c=0;c<n.length;c++){var u=n[c],d=null;"SHADOW"==u.type&&"RECEIVE"==u.subtype&&u.shadow_cast&&((d=a(u)).subtype="CAST"),"MAIN"!=u.type&&"PARTICLES"!=u.type||!s&&!o||!u.reflexible||((d=a(u)).subtype="REFLECT",d.refractive=!1,d.z_sort&&(d.z_sort=!1,d.depth_mask=!1),d.particles_data=u.particles_data),"COLOR_ID"==u.type&&i&&e.render.outlining&&(l&&e.render.selectable?(d=a(u)).subtype="OUTLINE":u.subtype="OUTLINE"),d&&(d.forked_batch=!0,ke(d),_.push(d))}for(var f=0;f<_.length;f++)We.append_batch(e,r,_[f])},t.wb_angle_to_amp=function(e,t,r){var a=r*(t.max_z-t.min_z);if(0==a)return 0;var n=a*Math.tan(e);return.5*(Math.sqrt(2*Math.sqrt(4*n+1)+2)/2-1)/a},t.wb_amp_to_angle=function(e,t,r){var a=r*(t.max_z-t.min_z);if(0==a)return 0;e*=2*a;var n=Math.pow(e+1,4)-Math.pow(e+1,2);return Math.atan(n/a)},t.bb_bpy_to_b4w=function(e){var t=Fe.create_bb();return t.max_x=e.max_x,t.min_x=e.min_x,t.max_y=e.max_y,t.min_y=e.min_y,t.max_z=e.max_z,t.min_z=e.min_z,t},t.update_batch_material_error=Q,t.update_batch_lights=ie,t.set_lamp_data=le,t.assign_shadow_receive_dirs=function(e,t,r){if(de(e,"CSM_SECTION1",0),de(e,"CSM_SECTION2",0),de(e,"CSM_SECTION3",0),de(e,"NUM_CAST_LAMPS",0),t){de(e,"NUM_CAST_LAMPS",t.lamp_types.length),st.mac_os_shadow_hack&&de(e,"MAC_OS_SHADOW_HACK",1);for(var a=1;a<t.csm_num;a++)de(e,"CSM_SECTION"+String(a),1);de(e,"SHADOW_TEX_RES",Je.glsl_value(t.csm_resolution)),de(e,"CSM_FADE_LAST_CASCADE",t.fade_last_cascade?1:0),de(e,"CSM_BLEND_BETWEEN_CASCADES",t.blend_between_cascades&&!st.chrome_csm_blend_hack?1:0)}else de(e,"SHADOW_TEX_RES",0),de(e,"CSM_FADE_LAST_CASCADE",0),de(e,"CSM_BLEND_BETWEEN_CASCADES",0)},t.set_batch_directive=de,t.get_batch_directive=function(e,t){return Je.get_directive(e.shaders_info,t)},t.update_batch_geometry=fe,t.update_batch_id=ke,t.update_local_bounds_from_pos=function(e,t){e.bounds_local.bb=Fe.bb_from_coords(t,0,t.length,e.bounds_local.bb);var r=Fe.extract_bb_corners(e.bounds_local.bb,xt);e.bounds_local.be=Fe.create_be_by_bb(r,!0),e.bounds_local.bs=Fe.create_bs_by_be(e.bounds_local.be),e.use_be=Fe.is_be_optimized(e.bounds_local.be,e.bounds_local.bs)},t.apply_shader=Ie,t.append_texture=Se,t.replace_texture=function(e,t,r){var a=e.texture_names.indexOf(r);a>-1&&(e.textures[a]=t)},t.create_shadeless_batch=function(e,t,a){var n=r("MAIN");return a<1&&(n.blend=!0),_t.set(t[0],t[1],t[2],a,n.diffuse_color),n.draw_mode=rt.DM_TRIANGLES,fe(n,e),Ie(n,"main.glslv","main_stack.glslf"),de(n,"SHADELESS",1),Le(n),n},t.update_shader=Le,t.generate_line_batches=function(e,t){for(var a=0;a<t.length;a++){var n=t[a],_=r("LINE");Ie(_,"line.glslv","line.glslf"),_.blend=!0,_.do_not_cull=!0,fe(_,Ve.generate_line()),s(_),We.append_scene_data(n,e),We.append_batch(n,e,_),Le(_)}},t.check_batch_perm_uniform=function(e,t){return!!e.shader.permanent_uniform_setters.length&&!!e.shader.permanent_uniform_setters_table[t]},t.create_depth_pack_batch=function(e){var t=r("DEPTH_PACK");return t.use_backface_culling=!0,t.depth_mask=!1,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/depth_pack.glslf"),Le(t),t},t.create_postprocessing_batch=function(e){var t=r("POSTPROCESSING");switch(Ie(t,"postprocessing/postprocessing.glslv","postprocessing/postprocessing.glslf"),e){case"NONE":de(t,"POST_EFFECT","POST_EFFECT_NONE");break;case"GRAYSCALE":de(t,"POST_EFFECT","POST_EFFECT_GRAYSCALE");break;case"X_BLUR":case"Y_BLUR":de(t,"POST_EFFECT","POST_EFFECT_BLUR");break;case"X_GLOW_BLUR":case"Y_GLOW_BLUR":case"X_BLOOM_BLUR":case"Y_BLOOM_BLUR":de(t,"POST_EFFECT","POST_EFFECT_GLOW_BLUR");break;case"X_DOF_BLUR":case"Y_DOF_BLUR":de(t,"POST_EFFECT","POST_EFFECT_DOF_BLUR");break;case"X_ALPHA_BLUR":case"Y_ALPHA_BLUR":de(t,"POST_EFFECT","POST_EFFECT_ALPHA_BLUR");break;case"X_EXTEND":case"Y_EXTEND":de(t,"POST_EFFECT","POST_EFFECT_EXTEND");break;case"FLIP_CUBEMAP_COORDS":de(t,"POST_EFFECT","FLIP_CUBEMAP_COORDS");break;default:at.panic("Wrong postprocessing effect: "+e)}return de(t,"SHADOW_USAGE","NO_SHADOWS"),t.use_backface_culling=!0,t.depth_mask=!1,fe(t,Ve.generate_fullscreen_tri()),Le(t),t},t.create_ssao_batch=function(e){var t=r("SSAO");t.depth_mask=!1,t.use_backface_culling=!0,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/ssao.glslf"),de(t,"SSAO_QUALITY","SSAO_QUALITY_"+e.ssao_samples),de(t,"SSAO_HEMISPHERE",e.ssao_hemisphere?1:0),de(t,"SHADOW_USAGE","NO_SHADOWS");var a={width:4,height:4,data:new Uint8Array([150,123,254,0,127,3,97,0,164,246,99,0,155,177,14,0,54,83,221,0,2,142,143,0,32,57,79,0,49,160,32,0,57,232,115,0,178,216,203,0,70,196,218,0,241,164,82,0,225,58,85,0,233,88,189,0,144,25,203,0,117,73,12,0])},n=et.create_texture(et.TT_RGBA_INT,!1);return n.source="NODE_TEX",et.update_texture(n,a,0),Se(t,n,"u_ssao_special_tex"),Le(t),t},t.create_ssao_blur_batch=function(e){var t=r("SSAO_BLUR");return t.depth_mask=!1,t.use_backface_culling=!0,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/ssao_blur.glslf"),de(t,"SSAO_BLUR_DEPTH",e.ssao_blur_depth?1:0),de(t,"SHADOW_USAGE","NO_SHADOWS"),Le(t),t},t.create_coc_batch=function(e){var t=r("COC");switch(t.depth_mask=!1,t.use_backface_culling=!0,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/coc.glslf"),de(t,"DEPTH_RGBA",1),e){case"COC_ALL":de(t,"COC_TYPE","COC_ALL");break;case"COC_FOREGROUND":de(t,"COC_TYPE","COC_FOREGROUND");break;case"COC_COMBINE":de(t,"COC_TYPE","COC_COMBINE")}return de(t,"SHADOW_USAGE","NO_SHADOWS"),Le(t),t},t.create_dof_batch=function(e){var t=r("DOF");return t.depth_mask=!1,t.use_backface_culling=!0,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/dof.glslf"),e.camera.dof_bokeh?de(t,"DOF_TYPE","DOF_BOKEH"):(de(t,"DOF_TYPE","DOF_SIMPLE"),de(t,"DEPTH_RGBA",1)),de(t,"SHADOW_USAGE","NO_SHADOWS"),Le(t),t},t.create_outline_batch=function(){var e=r("OUTLINE");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/outline.glslf"),Le(e),e},t.create_glow_combine_batch=function(){var e=r("GLOW_COMBINE");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/glow.glslf"),Le(e),e},t.create_god_rays_batch=function(e,t,a){var n=r("GOD_RAYS");return n.depth_mask=!1,n.use_backface_culling=!0,fe(n,Ve.generate_billboard()),Ie(n,"postprocessing/god_rays.glslv","postprocessing/god_rays.glslf"),de(n,"DEPTH_RGBA",e?1:0),de(n,"WATER_EFFECTS",t?1:0),de(n,"STEPS_PER_PASS",Je.glsl_value(a,1)),de(n,"SHADOW_USAGE","NO_SHADOWS"),Le(n),n},t.create_god_rays_combine_batch=function(){var e=r("GOD_RAYS_COM");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/god_rays_combine.glslf"),de(e,"SAFARI_CANVAS_ALPHA_HACK",st.safari_canvas_alpha_hack?1:0),Le(e),e},t.create_cube_sky_batch=function(e,t){var a=r("SKY");if(a.depth_mask=!1,a.use_backface_culling=!1,fe(a,Ve.generate_plane(1,1)),""!=t.sky_ngraph_proxy_id)Ie(a,"skybox.glslv","node_skybox.glslf"),de(a,"IS_WORLD",1),q(a,e);else if(t.procedural_skydome)Ie(a,"skybox.glslv","proc_skybox.glslf"),de(a,"WATER_EFFECTS",1);else{if(Ie(a,"skybox.glslv","tex_skybox.glslf"),e){var n=e._render.world_light_set;if(n.sky_texture_slot){var _=n.sky_texture_slot.texture;Se(a,et.get_batch_texture(n.sky_texture_slot,null),"u_sky_texture",_.name)}n.sky_texture_param&&de(a,"WO_SKYTEX",1)}t.sky_invert&&de(a,"MTEX_NEGATIVE",1),t.sky_use_rgb_to_intensity&&de(a,"MTEX_RGBTOINT",1),de(a,"BLENDTYPE",t.sky_blend_type),t.sky_use_map_blend&&de(a,"WOMAP_BLEND",1),t.sky_use_map_horizon&&de(a,"WOMAP_HORIZ",1),t.sky_use_map_zenith_up&&de(a,"WOMAP_ZENUP",1),t.sky_use_map_zenith_down&&de(a,"WOMAP_ZENDOWN",1),t.use_sky_blend&&de(a,"WO_SKYBLEND",1),t.use_sky_paper&&de(a,"WO_SKYPAPER",1),t.use_sky_real&&de(a,"WO_SKYREAL",1)}return Le(a),a},t.append_cube_sky_batch_to_world=function(e,t){var r=Qe.find_subs(e._render.graph,$e.SKY);if(r){var a=r.draw_data[0].bundles[0].batch;We.append_batch(t,e,a)}},t.create_cube_irradiance_batch=function(e,t){var a=r("IRRADIANCE");return a.depth_mask=!1,a.use_backface_culling=!1,fe(a,Ve.generate_plane(1,1)),Ie(a,"skybox.glslv","irradiance_skybox.glslf"),Le(a),a},t.create_cube_roughness_convolution_batch=function(e,t){var a=r("R_CONVOLUTION");return a.depth_mask=!1,a.use_backface_culling=!1,fe(a,Ve.generate_plane(1,1)),Ie(a,"skybox.glslv","r_convolution_skybox.glslf"),Le(a),a},t.create_brdf_batch=function(e,t){var a=r("BRDF");return a.depth_mask=!1,a.use_backface_culling=!1,fe(a,Ve.generate_plane(1,1)),Ie(a,"postprocessing/postprocessing.glslv","postprocessing/precompute_brdf.glslf"),Le(a),a},t.create_antialiasing_batch=function(e){var t=r("ANTIALIASING");return t.depth_mask=!1,t.use_backface_culling=!0,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/antialiasing.glslf"),st.quality_aa_method?(de(t,"AA_METHOD","AA_METHOD_FXAA_QUALITY"),de(t,"AA_QUALITY",e.fxaa_quality)):de(t,"AA_METHOD","AA_METHOD_FXAA_LIGHT"),Le(t),t},t.create_smaa_batch=function(e){var t=r("SMAA");return fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/smaa.glslv","postprocessing/smaa.glslf"),de(t,"AA_METHOD","AA_METHOD_SMAA_HIGH"),de(t,"SMAA_PASS",e),de(t,"SMAA_PREDICATION",0),de(t,"SMAA_REPROJECTION",0),Le(t),t.depth_mask=!1,t.use_backface_culling=!0,t},t.create_compositing_batch=function(){var e=r("COMPOSITING");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/compositing.glslf"),Le(e),e},t.create_motion_blur_batch=function(e){var t=r("MOTION_BLUR");return t.use_backface_culling=!0,t.depth_mask=!1,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/motion_blur.glslf"),Le(t),t},t.create_stereo_batch=function(e){var t=r("STEREO");return t.use_backface_culling=!0,t.depth_mask=!1,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/stereo.glslf"),de(t,"ANAGLYPH","ANAGLYPH"===e?1:0),de(t,"SIDEBYSIDE","SIDEBYSIDE"===e?1:0),de(t,"DISTOR_SCALE",lt.nonwebvr.distor_scale),Le(t),t},t.create_luminance_batch=function(){var e=r("LUMINANCE");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/luminance.glslf"),Le(e),e},t.create_average_luminance_batch=function(){var e=r("LUMINANCE");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/luminance_av.glslf"),Le(e),e},t.create_luminance_truncated_batch=function(e){var t=r("LUMINANCE_X_BLUR");return t.depth_mask=!1,t.use_backface_culling=!0,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/luminance_truncated.glslf"),e&&Je.set_directive(t.shaders_info,"ADAPTIVE_BLOOM",1),Le(t),t},t.create_bloom_combine_batch=function(e){var t=r("BLOOM");if(t.depth_mask=!1,t.use_backface_culling=!0,fe(t,Ve.generate_fullscreen_tri()),Ie(t,"postprocessing/postprocessing.glslv","postprocessing/bloom_combine.glslf"),1==e)a="BLUR_PASS_1";else if(2==e)a="BLUR_PASS_2";else if(3==e)a="BLUR_PASS_3";else if(4==e)a="BLUR_PASS_4";else if(5==e)var a="BLUR_PASS_5";return Je.set_directive(t.shaders_info,"BLUR_PASS_NUM",a),Le(t),t},t.create_velocity_batch=function(){var e=r("VELOCITY");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/velocity.glslf"),Le(e),e},t.create_anchor_visibility_batch=function(){var e=r("ANCHOR_VISIBILITY");return e.depth_mask=!0,e.use_backface_culling=!0,e.draw_mode=rt.DM_TRIANGLES,Ie(e,"anchors.glslv","anchors.glslf"),fe(e,Ve.generate_index(1)),de(e,"ANCHOR_NUM",1),Le(e),e.anchor_positions=new Float32Array(3),e},t.create_performance_batch=function(){var e=r("PERFORMANCE");return e.depth_mask=!1,e.use_backface_culling=!0,fe(e,Ve.generate_fullscreen_tri()),Ie(e,"postprocessing/postprocessing.glslv","postprocessing/performance.glslf"),Le(e),e},t.update_anchor_visibility_batch=function(e,t){var r=t.length/3;r!=e.anchor_positions.length/3&&(fe(e,Ve.generate_index(r)),de(e,"ANCHOR_NUM",r),Le(e)),e.anchor_positions=t},t.get_first_batch=function(e){if(!e.scenes_data.length)return null;var t=e.scenes_data[0];return t.batches.length?t.batches[0]:null},t.find_batch_material_any=function(e,t,r){for(var a=e.scenes_data[0].batches,n=0;n<a.length;n++)if(a[n].type==r&&-1!=a[n].material_names.indexOf(t))return a[n];return null},t.find_batch_material=function(e,t,r){for(var a=e.scenes_data[0].batches,n=0;n<a.length;n++)if(a[n].type==r&&!a[n].forked_batch&&-1!=a[n].material_names.indexOf(t))return a[n];return null},t.find_batch_material_forked=function(e,t,r){for(var a=e.scenes_data[0].batches,n=0;n<a.length;n++)if(a[n].type==r&&a[n].forked_batch&&-1!=a[n].material_names.indexOf(t))return a[n];return null},t.iterate_batches_by_mat=function(e,t,r,a){for(var n=e.scenes_data[0].batches,_=0;_<n.length;_++){var s=n[_];if(-1!=s.material_names.indexOf(t)&&(!a||s.type==a)&&r(s))return}},t.check_batch_type=function(e,t){for(var r=e.scenes_data[0].batches,a=0;a<r.length;a++)if(r[a].type==t)return!0;return!1},t.get_batch_by_type=function(e,t,r){for(var a=(r?We.get_scene_data(e,r):e.scenes_data[0]).batches,n=0;n<a.length;n++)if(a[n].type==t)return a[n];return null},t.clear_batch=function(e){var t=e.textures;e.textures=[];for(var r=0;r<t.length;r++)et.cleanup_unused(t[r]);if(e.textures=t,e.bufs_data&&e.bufs_data.cleanup_gl_data_on_unload&&rt.cleanup_bufs_data(e.bufs_data),e.cleanup_gl_data_on_unload&&e.vaos.length&&Ze.cleanup_vao(e),e.shader&&e.shader.cleanup_gl_data_on_unload&&Je.cleanup_shader(e.shader),e.ngraph_proxy_id){var a=He.get_ngraph_proxy_cached(e.ngraph_proxy_id);a&&a.cleanup_on_unload&&He.cleanup_ngraph_proxy(e.ngraph_proxy_id)}},t.generate_odd_id=De,t.cleanup=function(){Tt={}}}),se=o("__anchors",function(e,t){function r(e){function t(){Q=!1,s.style.visibility="visible"}if(!Q&&!X){var r=K;if(r){if("visible"==r.lastElementChild.style.visibility)return n(),void(K=null);if(1==r.style.opacity){var a=r.lastElementChild,_=r.firstElementChild,s=a.firstElementChild,o=Math.ceil(a.getBoundingClientRect().width),i=Math.ceil(a.getBoundingClientRect().height),l=Math.ceil(_.getBoundingClientRect().width),c=Math.ceil(_.getBoundingClientRect().height);a.style.position="absolute",a.style.visibility="visible";var u=!0,d=!0;_.style.display="none",Q=!0,l!=o?G.animate(l,o,200,function(e){e==o&&(u=!1,d||t()),a.style.width=e+"px"}):(u=!1,d||(Q=!1)),c!=i?G.animate(c,i,200,function(e){e==i&&(d=!1,u||t()),a.style.height=e+"px"}):(d=!1,u||(Q=!1))}}}}function a(){Z=!0,I.get_container().addEventListener("mouseup",r)}function n(){var e=K.lastElementChild;K.firstElementChild.style.display="",e.style.visibility="hidden",e.style.position="relative",e.firstElementChild.style.visibility="hidden"}function _(e){var t=e.obj,r=I.get_container(),a=C.get_meta_tags(t),n=t.name,_="",l=document.createElement("div"),c=l.cloneNode(!1),f=document.createElement("span");return o(l),s(c),l.style.visibility="hidden",a&&(_=a.description||_,n=a.title||n),f.innerHTML=n,u(f),i(f),f.style.whiteSpace="nowrap",c.appendChild(f),l.appendChild(c),_&&d(_,l,e.annotation_max_width),r.appendChild(l),l}function s(e){e.style.cssText+="background-color:   #000;border-radius:      20px 20px 20px 0px;box-shadow:         0px 0px 10px rgb(180, 180, 200);-webkit-box-shadow: 0px 0px 10px rgb(180, 180, 200);opacity:            1.0;box-sizing:         border-box;bottom:             0;left:               0;padding:            6px 12px 6px 12px;position:           absolute;"}function o(e){e.style.cssText+="position:        absolute;height:          0;top:             0;left:            0;transform-style: preserve-3d;"}function i(e){e.style.cssText+="color:       #fff;font-family: Arial;font-size:   12px;font-weight: bold;line-height: 1.25;"}function c(e){e.style.cssText+="background-color:   #000;border-radius:      20px 20px 20px 0px;bottom:             0;box-shadow:         0px 0px 10px rgb(180, 180, 200);-webkit-box-shadow: 0px 0px 10px rgb(180, 180, 200);left:               0;box-sizing:         border-box;opacity:            1.0;padding:            6px 12px 6px 12px;position:           relative;z-index:            2;"}function u(e){e.style.cssText+="-webkit-touch-callout: none;-webkit-user-select:   none;-khtml-user-select:    none;-moz-user-select:      none;-ms-user-select:       none;user-select:           none;cursor:                default;"}function d(e,t,r){var a=document.createElement("div"),_=document.createElement("span");r&&(a.style.maxWidth=r+"px"),c(a),i(_),_.innerHTML=e,a.style.visibility="hidden",_.style.visibility="hidden",a.appendChild(_),t.appendChild(a),L.add_click_listener(t,function(e){Q||t!=K&&1==t.style.opacity&&(X||(K&&"visible"==K.lastElementChild.style.visibility&&n(),K=t))})}function f(){for(var e=0,t=0;t<V.length;t++)V[t].detect_visibility&&e++;J=new Float32Array(3*e)}function p(e,t){return t.depth-e.depth}function h(e,t,r){var a=e.element;q.ie_edge_anchors_floor_hack&&(t=Math.floor(t),r=Math.floor(r)),"transform"in a.style?a.style.transform="translate3d("+t+"px, "+r+"px, 0px)":"webkitTransform"in a.style?a.style.webkitTransform="translate3d("+t+"px, "+r+"px, 0px)":(a.style.left=t+"px",a.style.top=r+"px")}function b(e,t){var r=F.get_camera(F.get_main()),a=H.get_trans_view(e.obj.render.world_tsr);return N.project_point(r,a,t),t}function y(e){var t=F.get_subs(F.get_main(),B.ANCHOR_VISIBILITY).camera,r=I.canvas_to_viewport_coords(e.x,e.y,re,t);return U.read_pixels(t.framebuffer,r[0],t.height-r[1],2,2,ee),ee[0]+ee[4]+ee[8]+ee[12]>=255?"visible":"out"==e.appearance||ee[0]+ee[4]+ee[8]+ee[12]==0?"covered":e.appearance}function E(e){I.get_container().removeChild(e.element)}function w(e){for(var t=0;t<V.length;t++)if(V[t].obj==e)return!0;return!1}function T(e,t,r){if(e.element)var a=Math.round(e.element.offsetWidth)||0,n=Math.round(e.element.offsetHeight)||0;else var a=0,n=0;var _=e.x,s=e.y;return t>=_&&t<=_+a&&r<s&&r>=s-n}function O(e,t){if(!e.is_lod)return!0;var r=e.lod_dist_min,a=e.lod_dist_max;return!(t<r)&&(a==P.LOD_DIST_MAX_INFINITY||t<a)}var R=_e(e),N=ue(e),M=g(e),I=ce(e),L=S(e),C=$(e),P=k(e),D=m(e),U=te(e),F=j(e),B=A(e),G=x(e),z=Y(e),H=v(e),W=l(e),q=M.defaults,V=[],X=!1,K=null,Z=!1,Q=!1,J=new Float32Array(0),ee=new Uint8Array(16),re=new Float32Array(2),ae=new Float32Array(3),ne=new Float32Array(3);t.append=function(e){if(!w(e)){var t=e.anchor.detect_visibility&&Boolean(F.get_subs(F.get_main(),B.ANCHOR_VISIBILITY)),r={type:e.anchor.type,obj:e,x:0,y:0,depth:0,appearance:"out",detect_visibility:t,element:null,move_cb:null,annotation_max_width:e.anchor.max_width,element_id:e.anchor.element_id};switch(r.type){case"ANNOTATION":r.element=_(r);break;case"ELEMENT":if(r.element=document.getElementById(e.anchor.element_id),r.element)for(var n=0;n<V.length;n++)"ELEMENT"==V[n].type&&V[n].element_id==e.anchor.element_id&&(D.warn("Anchor with the id '"+e.anchor.element_id+"' already exists, making the new anchor generic."),r.type="GENERIC");else D.warn("Anchor HTML element with the id '"+e.anchor.element_id+"' was not found, making it generic."),r.type="GENERIC"}V.push(r),f(),Z||a()}},t.remove=function(e){for(var t=0;t<V.length;t++){var r=V[t];if(r.obj==e){"ANNOTATION"==r.type&&E(r),V.splice(t,1),f(),t--;break}}},t.update=function(e){for(var t=0,r=V.length;r--;){if((u=V[r]).detect_visibility){var a=H.get_trans_view(u.obj.render.world_tsr);J.set(a,3*t++)}var n=b(u,ae),_=n[0],s=n[1],o=n[2];if(e||_!=u.x||s!=u.y||o!=u.depth){switch(u.type){case"ANNOTATION":h(u,l=_,c=s);break;case"ELEMENT":var i=u.element.getBoundingClientRect(),l=_-i.width/2,c=s-i.height/2;h(u,l,c)}u.x=_,u.y=s,u.depth=o,u.move_cb&&u.move_cb(_,s,u.appearance,u.obj,u.element)}}for(V.sort(p),r=0;r<V.length;r++){var u=V[r];"GENERIC"!=u.type&&(K==u.element?u.element.style.zIndex=V.length:u.element.style.zIndex=r)}if(t>0){var d=F.get_subs(F.get_main(),B.ANCHOR_VISIBILITY),f=d.draw_data[0].bundles[0],m=f.batch;R.update_anchor_visibility_batch(m,J),B.append_draw_data(d,f)}},t.update_visibility=function(){for(var e=I.get_container(),t=F.get_active(),r=F.get_subs(t,B.STEREO),a=Boolean(r&&r.enable_hmd_stereo),_=V.length;_--;){var s=V[_],o=s.obj,i=o.render,l=s.x,c=s.y,u=s.depth,d=F.get_camera(F.get_main()),f=z.get_translation(o,ae),m=z.get_translation(d,ne),p=W.dist(f,m);if(l<0||c<0||u<0||u>1||F.is_hidden(o)||l>=e.clientWidth||c>=e.clientHeight||!O(i,p))h="out";else var h="visible";if(s.detect_visibility&&"out"!=h&&(h=y(s)),a&&(h="out"),h!=s.appearance){switch(s.type){case"ANNOTATION":case"ELEMENT":var v=s.element;if(!v)break;"out"==h?(v.style.visibility="hidden",v.children.length&&(v.children[0].style.visibility="hidden")):"visible"==h?(v.style.visibility="visible",v.children.length&&(v.children[0].style.visibility="visible"),v.style.opacity=1):(v.style.visibility="visible",v.style.opacity=.1,v.children.length&&(v.children[0].style.visibility="visible"),"ANNOTATION"==s.type&&v.children.length>1&&"visible"==v.lastElementChild.style.visibility&&(n(),v==K&&(K=null)))}s.appearance=h,s.move_cb&&s.move_cb(l,c,s.appearance,o,v)}}},t.attach_move_cb=function(e,t){for(var r=0;r<V.length;r++)V[r].obj==e&&(V[r].move_cb=t)},t.detach_move_cb=function(e){for(var t=0;t<V.length;t++)V[t].obj==e&&(V[t].move_cb=null)},t.cleanup=function(){for(var e=0;e<V.length;e++){var t=V[e];"ANNOTATION"==t.type&&E(t)}V.length=0},t.is_anchor=w,t.get_element_id=function(e){for(var t=0;t<V.length;t++)if(V[t].obj==e)return V[t].element_id;return!1},t.pause=function(){X=!0},t.resume=function(){X=!1},t.pick_anchor=function(e,t){for(var r=-1,a=0;a<V.length;a++)if("visible"==V[a].appearance&&T(V[a],e,t))if(r<0){var n=V[a].depth;r=a}else V[a].depth<n&&(r=a,n=V[a].depth);return r<0?null:V[r].obj}}),oe=o("__loader",function(e,t){function r(){return U}function a(e){U=e}function n(e,a,n,s){var o=r(),i=x.create();for(var l in a){var c=_(a[l]);(s&&c.is_resource||!e&&c.primary_only)&&y(c),x.append_node_attr(i,c)}for(var l in a)for((c=a[l]).name=l,p=0;p<c.inputs.length;p++)x.append_edge_attr(i,a[c.inputs[p]],c,null);var u=_({name:"out",priority:t.FINISH_PRIORITY,cb_before:function(e,t,r,a,n,_){t.is_primary&&(o.start_secondary_threads=!0),T(t)||(t.status=N),t.loaded_cb(t.id,!0),n(t,r),O.log("%cTHREAD "+t.id+": LOADED CALLBACK",D)},relative_size:5});if(n)d=x.get_sink_nodes(i);else{var d,f,m=x.clone(i);do{for(d=x.get_sink_nodes(m),f=[],p=0;p<d.length;p++)h=d[p],(v=x.get_node_attr(m,h)).background_loading&&f.push(h);for(p=0;p<f.length;p++)x.remove_node(m,f[p]);f.length&&x.cleanup_loose_edges(m)}while(f.length)}x.append_node_attr(i,u);for(var p=0;p<d.length;p++){var h=d[p],v=x.get_node_attr(i,h);u.inputs.push(v.name),x.append_edge_attr(i,v,u,null)}return i}function _(e){return e.background_loading=e.background_loading||!1,e.priority||0===e.priority||(e.priority=e.SYNC_PRIORITY),e.inputs=e.inputs||[],e.is_finished=e.is_finished||!1,e.skip=e.skip||!1,e.relative_size=e.relative_size||0,e.is_resource=e.is_resource||!1,e.primary_only=e.primary_only||!1,e.status=S,e.loop_index=0,e.load_rate=0,e.cb_param=e.cb_param||null,e}function s(e,t,r){if(t.complete_load_cb(r,t),t.status=M,e.active_threads--,k.debug_loading){var a=Math.round(performance.now()-t.time_load_start);O.log("%cTHREAD "+t.id+": 100% LOADING END "+a+"ms",D)}w(t)}function o(e,r){var a=e.stages_queue.length;do{var n=e.stages_queue[0],_=x.get_node_attr(e.stage_graph,n),s=c(e,_,r);_.priority==t.ASYNC_PRIORITY&&(e.reset_time_cycle=!0);var o=e.stages_queue.shift();e.stages_queue.push(o),a--}while(!s&&0!=a)}function i(e,t){for(var r=[],a=[],n=0;n<t.length;n++){var _=t[n];x.get_node_attr(e.stage_graph,_).is_finished&&(x.traverse_outputs(e.stage_graph,_,function(a,n,_){var s=!0;x.traverse_inputs(e.stage_graph,a,function(e,t,r){if(!t.is_finished)return s=!1,1}),s&&-1==r.indexOf(a)&&-1==t.indexOf(a)&&r.push(a)}),a.push(n))}for(n=a.length-1;n>=0;n--)t.splice(a[n],1);return r}function l(e){var t=[],r=e.stages_queue,a=!1;do{var n=i(e,r);t.push.apply(t,r),n.length>0&&(a=!0),r=n}while(n.length>0);return a&&t.sort(function(t,r){var a=x.get_node_attr(e.stage_graph,t),n=x.get_node_attr(e.stage_graph,r),_=n.priority-a.priority;return 0==_&&(_=a.background_loading-n.background_loading),_}),e.stages_queue=t,e.stages_queue.length}function c(e,t,r){if(t.skip)return t.is_finished=!0,k.debug_loading&&O.log("%cTHREAD "+e.id+": SKIP STAGE "+t.name,D),f(e,t),!1;if(k.debug_loading&&t.status==S){var a=u(e),n="LOADING START "+t.name,_=Math.round(performance.now()-e.time_load_start);O.log("%cTHREAD "+e.id+": "+a+"% "+n+" "+_+"ms ",D)}if(!t.cb_before&&!t.cb_loop&&!t.cb_after)return f(e,t),!1;if(t.status==S&&(t.status++,t.cb_before))return t.cb_before(r,e,t,t.cb_param,f,p),!0;if(t.status==L){if(t.cb_loop)return t.cb_loop(r,e,t,t.cb_param,f,p),!0;t.status++}return!(t.status!=C||(t.status++,!t.cb_after)||(t.cb_after(r,e,t,t.cb_param,f,p),0))}function u(e){if(0==e.stages_size_total)return 100;var t=0;return x.traverse(e.stage_graph,function(r,a){d(e,a)&&(t+=a.load_rate*a.relative_size)}),R.trunc(100*t/e.stages_size_total)}function d(e,t){return!(e.do_not_load_resources&&t.is_resource)}function f(e,t){if(t.is_finished=!0,t.status=P,v(e,t,1),k.debug_loading){var r=u(e),a="LOADING END "+t.name,n=Math.round(performance.now()-e.time_load_start);O.log("%cTHREAD "+e.id+": "+r+"% "+a+" "+n+"ms ",D)}}function p(e,t,r){r<1?v(e,t,r):t.status++}function v(e,t,a){var n=r();if(t.cb_before||t.cb_loop||t.cb_after){t.load_rate=a;var _=u(e);e.curr_percents==_&&1!=a||(e.stageload_cb(_,performance.now()-e.time_load_start,e.id),e.curr_percents=_,n.make_idle_iteration=!0)}}function b(e,t){var r=null;return x.traverse(e.stage_graph,function(e,a){if(a.name==t)return r=a,1}),r}function y(e){e.skip=!0}function w(e){e.stageload_cb=null,e.complete_load_cb=null,k.debug_loading||(e.stage_graph=null),e.stages_queue=null}function A(){return 0==r().active_threads}function T(e){return e&&(e.status==M||e.status==I)}var x=E(e),O=m(e),R=h(e),k=g(e).defaults,N=2,M=3,I=4,S=0,L=1,C=2,P=3,D="color: #f0f;";t.SYNC_PRIORITY=0,t.ASYNC_PRIORITY=1,t.FINISH_PRIORITY=2;var U=null;t.get_scheduler=r,t.create_scheduler=function(){var e={threads:[],current_thread_index:0,active_threads:0,start_secondary_threads:!1,make_idle_iteration:!1};return a(e),e},t.create_thread=function(e,t,a,_,s,o,i,l,c){var u=r(),f=u.threads.length,m={id:f,is_primary:0==f,status:0,filepath:t,binary_name:"",loaded_cb:a||function(){},load_hidden:l||!1,wait_complete_loading:o,time_load_start:0,curr_percents:0,stages_size_total:0,reset_time_cycle:!1,stageload_cb:_||function(){},complete_load_cb:s||function(){},stage_graph:null,stages_queue:null,has_video_textures:!1,has_background_music:!1,init_wa_context:!1,is_preloading:c},p=n(m.is_primary,e,o,i);m.stage_graph=p;for(var h=[],v=x.get_source_nodes(p),b=0;b<v.length;b++)h.push(v[b]);return m.stages_queue=h,x.traverse(p,function(e,t){(t.cb_before||t.cb_loop||t.cb_after)&&d(m,t)&&(m.stages_size_total+=t.relative_size)}),u.threads.push(m),u.active_threads++,m.id},t.update_scheduler=function(e){var t=r();if(t&&!A())if(t.make_idle_iteration)t.make_idle_iteration=!1;else{var a=performance.now();do{var n=t.threads[t.current_thread_index],_=e[n.id];if(T(n)||(0==n.status&&(n.status=1,n.time_load_start=performance.now(),n.stageload_cb(0,0,n.id),k.debug_loading&&O.log("%cTHREAD "+n.id+": 0% LOADING START 0ms",D)),l(n)?o(n,_):s(t,n,_)),t.start_secondary_threads&&(t.current_thread_index=(t.current_thread_index+1)%t.threads.length),n.reset_time_cycle)return void(n.reset_time_cycle=!1)}while(performance.now()-a<16)}},t.abort_thread=function(e){var t=r();s(t,e,null),e.status=I,e.is_primary&&(t.start_secondary_threads=!0),e.loaded_cb(e.id,!1)},t.stage_part_finish_cb=p,t.skip_stage_by_name=function(e,t){var r=b(e,t);null!==r&&y(r)},t.is_finished=A,t.thread_is_finished=T,t.is_primary_loaded=function(e){var t=r();return!!t&&(e|=0,t.threads[e]&&(t.threads[e].status==M||t.threads[e].status==N))},t.graph_to_dot=function(e){if(k.debug_loading){var a=r();return a&&a.threads[e]&&a.threads[e].stage_graph?x.debug_dot(a.threads[e].stage_graph,function(e,r){if(r.skip)return"SKIPPED\n("+r.name+")";var a=r.name+"\n",n=[];return n.push(r.priority==t.ASYNC_PRIORITY?"ASYNC":"SYNC"),r.background_loading&&n.push("BKG"),r.is_resource&&n.push("RES"),a+n.join(" | ")},null):null}O.error("Debug mode isn't enabled. Can not retrieve the graph.")},t.cleanup=function(){a(null)}}),ie=o("md5",function(e,t){function r(e,t){var r=e[0],a=e[1],i=e[2],l=e[3];a=o(a=o(a=o(a=o(a=s(a=s(a=s(a=s(a=_(a=_(a=_(a=_(a=n(a=n(a=n(a=n(a,i=n(i,l=n(l,r=n(r,a,i,l,t[0],7,-680876936),a,i,t[1],12,-389564586),r,a,t[2],17,606105819),l,r,t[3],22,-1044525330),i=n(i,l=n(l,r=n(r,a,i,l,t[4],7,-176418897),a,i,t[5],12,1200080426),r,a,t[6],17,-1473231341),l,r,t[7],22,-45705983),i=n(i,l=n(l,r=n(r,a,i,l,t[8],7,1770035416),a,i,t[9],12,-1958414417),r,a,t[10],17,-42063),l,r,t[11],22,-1990404162),i=n(i,l=n(l,r=n(r,a,i,l,t[12],7,1804603682),a,i,t[13],12,-40341101),r,a,t[14],17,-1502002290),l,r,t[15],22,1236535329),i=_(i,l=_(l,r=_(r,a,i,l,t[1],5,-165796510),a,i,t[6],9,-1069501632),r,a,t[11],14,643717713),l,r,t[0],20,-373897302),i=_(i,l=_(l,r=_(r,a,i,l,t[5],5,-701558691),a,i,t[10],9,38016083),r,a,t[15],14,-660478335),l,r,t[4],20,-405537848),i=_(i,l=_(l,r=_(r,a,i,l,t[9],5,568446438),a,i,t[14],9,-1019803690),r,a,t[3],14,-187363961),l,r,t[8],20,1163531501),i=_(i,l=_(l,r=_(r,a,i,l,t[13],5,-1444681467),a,i,t[2],9,-51403784),r,a,t[7],14,1735328473),l,r,t[12],20,-1926607734),i=s(i,l=s(l,r=s(r,a,i,l,t[5],4,-378558),a,i,t[8],11,-2022574463),r,a,t[11],16,1839030562),l,r,t[14],23,-35309556),i=s(i,l=s(l,r=s(r,a,i,l,t[1],4,-1530992060),a,i,t[4],11,1272893353),r,a,t[7],16,-155497632),l,r,t[10],23,-1094730640),i=s(i,l=s(l,r=s(r,a,i,l,t[13],4,681279174),a,i,t[0],11,-358537222),r,a,t[3],16,-722521979),l,r,t[6],23,76029189),i=s(i,l=s(l,r=s(r,a,i,l,t[9],4,-640364487),a,i,t[12],11,-421815835),r,a,t[15],16,530742520),l,r,t[2],23,-995338651),i=o(i,l=o(l,r=o(r,a,i,l,t[0],6,-198630844),a,i,t[7],10,1126891415),r,a,t[14],15,-1416354905),l,r,t[5],21,-57434055),i=o(i,l=o(l,r=o(r,a,i,l,t[12],6,1700485571),a,i,t[3],10,-1894986606),r,a,t[10],15,-1051523),l,r,t[1],21,-2054922799),i=o(i,l=o(l,r=o(r,a,i,l,t[8],6,1873313359),a,i,t[15],10,-30611744),r,a,t[6],15,-1560198380),l,r,t[13],21,1309151649),i=o(i,l=o(l,r=o(r,a,i,l,t[4],6,-145523070),a,i,t[11],10,-1120210379),r,a,t[2],15,718787259),l,r,t[9],21,-343485551),e[0]=d(r,e[0]),e[1]=d(a,e[1]),e[2]=d(i,e[2]),e[3]=d(l,e[3])}function a(e,t,r,a,n,_){return t=d(d(t,e),d(a,_)),d(t<<n|t>>>32-n,r)}function n(e,t,r,n,_,s,o){return a(t&r|~t&n,e,t,_,s,o)}function _(e,t,r,n,_,s,o){return a(t&n|r&~n,e,t,_,s,o)}function s(e,t,r,n,_,s,o){return a(t^r^n,e,t,_,s,o)}function o(e,t,r,n,_,s,o){return a(r^(t|~n),e,t,_,s,o)}function i(e){var t,a=e.length,n=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=e.length;t+=64)r(n,l(e.substring(t-64,t)));e=e.substring(t-64);var _=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<e.length;t++)_[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(_[t>>2]|=128<<(t%4<<3),t>55)for(r(n,_),t=0;t<16;t++)_[t]=0;return _[14]=8*a,r(n,_),n}function l(e){var t,r=[];for(t=0;t<64;t+=4)r[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return r}function c(e){for(var t="",r=0;r<4;r++)t+=f[e>>8*r+4&15]+f[e>>8*r&15];return t}function u(e){for(var t=0;t<e.length;t++)e[t]=c(e[t]);return e.join("")}function d(e,t){return e+t&4294967295}var f="0123456789abcdef".split("");t.hexdigest=function(e){return u(i(e))}}),le=o("__data",function(e,t){function r(e,t){kr[t.id]=null,Nr[t.id]=null}function a(e,t,r,a){var n,_;if(e instanceof ArrayBuffer){var s=Ht.get_width_height(e,a);n=s.width,_=s.height}else n=e.width,_=e.height;var o;o=n>2048||_>2048?"a00":n>1024||_>1024?"aa0":"0a0",nr.log("%cLOAD IMAGE "+n+"x"+_,"color: #"+o,t),-1==t.indexOf(Mr)&&r&&nr.warn("image",t,"is not from app root.")}function n(e,t,r,a){if(a==Bt.AT_VIDEO_ELEMENT)var n=e.videoWidth,_=e.videoHeight;else var n=e.images[0].width,_=e.images[0].height;var s;s=n>2048||_>2048?"a00":n>1024||_>1024?"aa0":"0a0",nr.log("%cLOAD VIDEO "+n+"x"+_,"color: #"+s,t),-1==t.indexOf(Mr)&&r&&nr.warn("video",t,"is not from app root.")}function _(e,t,r,a,n,_){var l=t.filepath;l||vr.panic("Nothing requested");var c=function(a,_,d,f){if(!a)return d==Bt.AT_JSON_ZIP?(nr.warn("Compressed file ",f,"not found or invalid. Trying to load non-compressed",l),void Bt.enqueue([{id:l,type:Bt.AT_JSON,url:l,is_fetch:t.is_preloading}],c,null,u)):void Xt.abort_thread(t);nr.log("%cLOAD METADATA","color: #616",f),b(a);for(var m in a)e[m]=a[m];s(t,e),i(e,t),o(e,t),t.is_preloading&&Se(e),n(t,r)},u=function(e){_(t,r,e)};if(Er.assets_gzip_available)var d=l+".gz",f=Bt.AT_JSON_ZIP;else var d=l,f=Bt.AT_JSON;Bt.enqueue([{id:d,type:f,url:d,is_fetch:t.is_preloading}],c,null,u)}function s(e,t){e.is_primary&&(Ir=ir.find_main_scene(t.scenes));var r=t.binaries[0].binfile;r?e.binary_name=r:(Xt.skip_stage_by_name(e,"load_binaries"),Xt.skip_stage_by_name(e,"prepare_bindata")),Er.is_mobile_device||Xt.skip_stage_by_name(e,"mobile_media_start"),Er.antialiasing&&Er.smaa||Xt.skip_stage_by_name(e,"load_smaa_textures")}function o(e,t){if(e.b4w_export_warnings)for(var r=0;r<e.b4w_export_warnings.length;r++){var a=e.b4w_export_warnings[r];(t.is_primary&&"PRIMARY"==a.type||"ALL"==a.type)&&nr.export_warn(a.text+" See more details in https://www.blend4web.com/doc/en/addon.html#other-messages")}}function i(e,t){if(e.b4w_export_errors)for(var r=0;r<e.b4w_export_errors.length;r++){var a=e.b4w_export_errors[r];(t.is_primary&&"PRIMARY"==a.type||"ALL"==a.type)&&nr.export_error(a.text+" See more details in https://www.blend4web.com/doc/en/addon.html#non-critical-export-errors")}}function u(e,t,r,a,n,_){var s=Lt(t.filepath)+t.binary_name;s||vr.panic("Binary data is missing");var o=function(a,_,l,c){if(!a)return l==Bt.AT_ARRAYBUFFER_ZIP?(nr.warn("Compressed file ",c,"not found or invalid. Trying to load non-compressed",s),void Bt.enqueue([{id:s,type:Bt.AT_ARRAYBUFFER,url:s,is_fetch:t.is_preloading}],o,null,i)):void Xt.abort_thread(t);nr.log("%cLOAD BINARY","color: #616",c),e.bin_data=a,w(a,e),n(t,r)},i=function(e){_(t,r,e)};if(Er.assets_gzip_available)var l=s+".gz",c=Bt.AT_ARRAYBUFFER_ZIP;else var l=s,c=Bt.AT_ARRAYBUFFER;Bt.enqueue([{id:l,type:c,url:l,is_fetch:t.is_preloading}],o,null,i)}function f(e,t,r,a,n,_){cr.check_shaders_loaded()&&n(t,r)}function b(e){var t=vr.str_to_version(e.b4w_format_version);switch(vr.version_cmp(t,Er.min_format_version)){case-1:t[0]<Er.min_format_version[0]?vr.panic("JSON version is too old relative to B4W engine: "+vr.version_to_str(t)+", required: "+vr.version_to_str(Er.min_format_version)+". Reexport scene with the latest B4W addon to fix it."):nr.warn("JSON version is a bit old relative to B4W engine: "+vr.version_to_str(t)+", required: "+vr.version_to_str(Er.min_format_version)+". Some compatibility issues can occur. Reexport scene with the latest B4W addon to fix it.");break;case 1:t[0]>Er.min_format_version[0]?vr.panic("B4W engine version is too old relative to JSON. Can't load the scene. Update your engine version to fix it."):nr.error("B4W engine version is a bit old relative to JSON. Some compatibility issues can occur. Update your engine version to fix it.")}Er.loaded_data_version=t}function E(e,t,r,a,n,_){var s=e.bin_data,o=e.binaries[0],i=e.objects,l=e.meshes,c=e.actions,u=vr.check_endians();R(s,o,l,u,Wr),I(s,o,i,u,Wr),L(s,o,c,u,Wr),n(t,r)}function w(e,t){var r=O(e),a=vr.str_to_version(t.b4w_format_version);r[0]!=a[0]&&vr.panic("BIN version does not match to JSON version: "+vr.version_to_str(r)+", required: "+vr.version_to_str(Er.min_format_version)+". Couldn't load the scene. Reexport scene to fix it."),r[1]!=a[1]&&nr.warn("BIN version does not match to JSON version: "+ +vr.version_to_str(r)+", required: "+vr.version_to_str(Er.min_format_version)+". Some compatibility issues can occur. Reexport scene to fix it.")}function O(e){return[new Uint32Array(e,4,1)[0],new Uint32Array(e,8,1)[0]]}function R(e,t,r,a,n){for(var _=["indices"],s=["position","texcoord","texcoord2","shade_tangs"],o=["normal","tangent"],i=["group"],l=["color"],c=0;c<r.length;c++)for(var u=r[c].submeshes,d=0;d<u.length;d++){for(var f in u[d]){var m=u[d][f][1];if(-1!=_.indexOf(f))p=u[d][f][0]*vr.INT_SIZE+t.int+n,u[d][f]=P(e,p,m,a);else if(-1!=s.indexOf(f))p=u[d][f][0]*vr.FLOAT_SIZE+t.float+n,u[d][f]=C(e,p,m,a);else if(-1!=o.indexOf(f))p=u[d][f][0]*vr.SHORT_SIZE+t.short+n,u[d][f]=U(e,p,m);else if(-1!=i.indexOf(f))p=u[d][f][0]*vr.SHORT_SIZE+t.ushort+n,u[d][f]=G(e,p,m);else if(-1!=l.indexOf(f)){var p=u[d][f][0]*vr.BYTE_SIZE+t.uchar+n;u[d][f]=H(e,p,m)}}if(M(r[c],u[d]),delete u[d].normal,delete u[d].tangent,"texcoord2"in u[d]){var h=new Float32Array(u[d].texcoord.length+u[d].texcoord2.length);h.set(u[d].texcoord),h.set(u[d].texcoord2,u[d].texcoord.length),u[d].texcoord=h,delete u[d].texcoord2}}}function M(e,t){if(e.b4w_shape_keys.length){var r=t.base_length,a=t.normal.length/r/Or,n=t.normal.length/Or;t.tbn=dr.from_norm_tan(t.normal.subarray(0,r*Or),t.tangent.subarray(0,r*Rr),dr.create(n));for(var _=1;_<a;_++)for(var s=_*r,o=0;o<r;o++){var i=t.normal.subarray(o*Or,(o+1)*Or),l=br.add(t.normal.subarray((s+o)*Or,(s+o+1)*Or),i,Lr),c=dr.identity(Dr);if(t.tangent.length){var u=t.tangent.subarray(o*Rr,(o+1)*Rr),d=gr.add(t.tangent.subarray((s+o)*Rr,(s+o+1)*Rr),u,Cr),f=dr.from_norm_tan(i,u),m=dr.from_norm_tan(l,d);dr.multiply_tbn_inv(m,f,c)}else{var p=_r.rotationTo(i,l,Pr);dr.set_quat(c,p,0)}dr.set_item(t.tbn,c,s+o)}}else t.tbn=dr.from_norm_tan(t.normal,t.tangent)}function I(e,t,r,a,n){for(var _=0;_<r.length;_++)for(var s=r[_].particle_systems,o=0;o<s.length;o++){var i=s[o],l=i.transforms[0]*vr.FLOAT_SIZE+t.float+n,c=i.transforms[1];i.transforms=C(e,l,c,a)}}function L(e,t,r,a,n){for(var _=0;_<r.length;_++){var s=r[_],o=s.fcurves,i=s.frame_range,l=i[0],c=i[1],u=Ft.get_approx_curve_length(l,c),d=null;u<0&&(u=0);var f=!1,m=!1;for(var p in o)f|=p.indexOf("rotation_euler")>-1,m|=p.indexOf("rotation_quaternion")>-1;var h=[];for(var p in o)if(f&&m&&p.indexOf("rotation_euler")>-1)delete o[p];else{var v=o[p];for(var b in v){var g=v[b],y=C(e,t.float+g.bin_data_pos[0]*vr.FLOAT_SIZE+n,g.bin_data_pos[1],a),E=new Float32Array(u);null===d&&(d=new Int8Array(u)),Ft.approximate_curve(g,y,E,d,l,c),g._pierced_points=E}p.indexOf("rotation_euler")>-1&&(Ft.fcurve_replace_euler_by_quat(o[p]),h.push(p))}for(var w=0;w<h.length;w++){var A=h[w];o[A.replace("euler","quaternion")]=o[A],delete o[A]}s._bflags=d}}function C(e,t,r,a){if(a)n=new Float32Array(e,t,r);else for(var n=new Float32Array(r),_=new DataView(e),s=0;s<r;s++)n[s]=_.getFloat32(t+s*vr.FLOAT_SIZE,!0);return n}function P(e,t,r,a){if(a)n=new Uint32Array(e,t,r);else for(var n=new Uint32Array(r),_=new DataView(e),s=0;s<r;s++)n[s]=_.getUint32(t+s*vr.INT_SIZE,!0);return n}function U(e,t,r){for(var a=new Float32Array(r),n=new DataView(e),_=0;_<r;_++)a[_]=n.getInt16(t+_*vr.SHORT_SIZE,!0)/32767;return a}function G(e,t,r){for(var a=new Float32Array(r),n=new DataView(e),_=0;_<r;_++)a[_]=n.getUint16(t+_*vr.SHORT_SIZE,!0)/65535;return a}function H(e,t,r){for(var a=new Float32Array(r),n=new DataView(e),_=0;_<r;_++)a[_]=n.getUint8(t+_*vr.BYTE_SIZE)/255;return a}function q(e){for(var t={},r=e.objects,a=0;a<r.length;a++){var n=r[a];if("MESH"===n.type&&!n.particle_systems.length)for(var _=n.data,s=_.name,o=_.submeshes,i=_.materials,l=0;l<o.length;l++)0!==o[l].base_length||t[s]||(i[l]&&nr.warn('material "'+i[l].name+'" is not assigned to any face (object "'+n.name+'").'),t[s]=!0)}}function re(e,t,r,a,n,_){je(e),sr.check_bpy_data(e),Se(e),ce(e,t),q(e),lt(e),ct(e.actions,t.id),ut(e),ue(e,t),ye(e),fe(e,t),me(e,t),pe(e),Ee(e,t),xr&&nr.log("%cDEBUG BPYDATA:","color: #a0a",e),n(t,r)}function le(e,t,r,a,n,_){for(var s=Lt(t.filepath),o=[],i=[],l=0;l<e.speakers.length;l++){var c=e.speakers[l],u=c.sound.uuid;if(-1==i.indexOf(u)){switch(i.push(u),c.b4w_behavior){case"POSITIONAL":case"BACKGROUND_SOUND":d=Bt.AT_AUDIOBUFFER;break;case"BACKGROUND_MUSIC":var d=Bt.AT_AUDIO_ELEMENT}at(o,u,d,vr.normpath_preserve_protocol(s+c.sound.filepath),t.is_preloading)}}o.length?Bt.enqueue(o,function(){},function(){n(t,r)}):n(t,r)}function ce(e,t){for(var r=Lt(t.filepath),a=e.textures,n=De(e,t),_=0;_<a.length;_++){var s=a[_];t.is_primary||"SCENE"!=s.b4w_source_type||(s.b4w_source_id="");var o=fr.create_texture_bpy(s,n,e.scenes,t.id,r);s._render=o}}function ue(e,t){if(!t.is_primary&&e.scenes.length>1&&(e.scenes=[ir.find_main_scene(e.scenes)],nr.warn("loading data contains multiple scenes.","Only the first one will be loaded.")),t.is_primary)r=Ir;else var r=ir.find_main_scene(e.scenes);if(mr.set_framerate(Ir.fps),e.scenes.length>1){var a=e.scenes.indexOf(Ir);e.scenes.splice(a,1),e.scenes.unshift(Ir)}for(var n=0;n<e.scenes.length;n++){var _=e.scenes[n];if(_._render=ir.create_scene_render(),_._is_main=_==r,_._is_primary_thread=t.is_primary,Ar.enabled){if("OFF"==_.b4w_enable_physics||"AUTO"==_.b4w_enable_physics&&!de(_))continue;(t.is_primary||!ar.scene_has_physics(Ir)&&_==ir.find_main_scene(e))&&ar.init_scene_physics(_)}}}function de(e){for(var t=ve(e,"ALL"),r=0;r<t.length;r++){if(t[r].b4w_collision)return!0;var a=t[r].data;if(a.materials)for(var n=0;n<a.materials.length;n++)if(a.materials[n].physics_settings.use_coll_physics)return!0}return!1}function fe(e,t){for(s=0;s<e.scenes.length;s++){for(var r=e.scenes[s],a=ve(r,"ALL"),n=0;n<a.length;n++)o=a[n],tr.check_bpy_obj_scene_compatibility(o,r,e)&&(o._scenes||(o._scenes=[]),o._scenes.push(t.is_primary?r:Ir));ge(a)}we(e,t);for(var _=Te(t.id),s=0;s<_.length;s++){var o=_[s];if(!t.is_primary&&o.parent&&Yr.indexOf(o.parent.type)>-1&&(o.parent=""),"MESH"==o.type){var i=sr.apply_mesh_modifiers(o);i&&(e.meshes.push(i),o.data=i)}o._def_action_slots=tr.get_bpy_def_action_slots(o,!1),o._is_dynamic=tr.bpy_obj_is_dynamic(o)}for(s=0;s<_.length;s++){for(var l=(o=_[s])._is_dynamic,n=0;n<o.lod_levels.length;n++)(c=o.lod_levels[n].object)&&(l=l||c._is_dynamic);if(l)for(o._is_dynamic=!0,n=0;n<o.lod_levels.length;n++){var c=o.lod_levels[n].object;c&&(c._is_dynamic=!0)}}}function me(e,t){for(n=0;n<e.scenes.length;n++){var r=e.scenes[n];(_=r.world)._scenes||(_._scenes=[]),_._scenes.push(t.is_primary?r:Ir)}for(var a=[],n=0;n<e.worlds.length;n++)(_=e.worlds[n])._scenes?(_._def_action_slots=tr.get_bpy_def_action_slots(_,!0),_._is_dynamic=tr.bpy_obj_is_dynamic(_)):a.push(_);for(n=0;n<a.length;n++){var _=a[n],s=e.worlds.indexOf(_);e.worlds.splice(s,1)}}function pe(e){for(var t=e.node_groups,r=e.materials,a=0;a<t.length;a++)(n=t[a].node_tree)&&(he(n,_=[],!0),n._bsdf_types=_);for(a=0;a<r.length;a++){var n=r[a].node_tree;if(n){var _=[];he(n,_,!1),n._bsdf_types=_}}}function he(e,t,r){for(var a=e.nodes,n=0;n<a.length;n++){var _=a[n],s=_.type;if("GROUP"==s&&_.node_group){var o=_.node_group.node_tree;if(!o)continue;if(r)he(o,t,!0);else for(var i=o._bsdf_types,l=0;l<i.length;l++){var c=i[l];-1==t.indexOf(c)&&t.push(c)}}else-1!=qr.indexOf(s)&&-1==t.indexOf(s)&&t.push(s)}}function ve(e,t){t||(t="ALL");var r=[];return-1==e.objects.indexOf(e.camera)&&e.objects.push(e.camera),be(e.objects,t,r),r}function be(e,t,r){for(var a=0;a<e.length;a++){var n=e[a];"ALL"!=t&&t!=n.type||r.push(n);var _=n.dupli_group;_&&be(_.objects,t,r)}}function ge(e){for(var t=0;t<e.length;t++){var r=e[t];if(r._scenes&&"WORLD"!=r.type)for(var a=r.particle_systems,n=0;n<a.length;n++){var _=a[n].settings;if("HAIR"==_.type)if("OBJECT"==_.render_type)(i=_.dupli_object)._scenes||(i._scenes=r._scenes.slice());else if("GROUP"==_.render_type)for(var s=_.dupli_group,o=0;o<s.objects.length;o++){var i=s.objects[o];i._scenes||(i._scenes=r._scenes.slice())}}}}function ye(e){for(var t=0;t<e.scenes.length;t++){var r=e.scenes[t];if(r.b4w_use_logic_editor){var a=ve(r,"ALL"),n=r.world;sr.assign_logic_nodes_object_params(a,n,r)}}}function Ee(e,t){for(var r=0;r<e.scenes.length;r++){var a=e.scenes[r],n=t.is_primary?a:Ir;Boolean(xe(t.id,n,"SPEAKER").length)&&!n._sfx&&lr.attach_scene_sfx(n)}}function we(e,t){for(var r=e.scenes,a=[],n=0;n<r.length;n++)Ae(r[n].objects,0,t.is_primary,a);for(Nr[t.id]=[],n=0;n<a.length;n++)for(var _=a[n],s=0;s<_.length;s++)for(var o=_[s],i=0;i<o.length;i++)Nr[t.id].push(o[i]);for(var l=e.particles,n=0;n<l.length;n++){var c=l[n].dupli_object;c&&(c._is_hair_dupli=!0,Nr[t.id].push(c));var u=l[n].dupli_group;if(u)for(var d=u.objects,s=0;s<d.length;s++)(c=d[s])._is_hair_dupli=!0,Nr[t.id].push(c)}for(var f=Nr[t.id],n=f.length-1;n>=0;n--)f[n]._scenes||f.splice(n,1)}function Ae(e,t,r,a){a[t]=a[t]||[];for(var n=a[t],_=0;_<e.length;_++){var s=e[_],o=Pt(s);n[o]=n[o]||[],(r||-1==Yr.indexOf(s.type))&&-1==n[o].indexOf(s)&&n[o].push(s);var i=s.dupli_group;i&&Ae(i.objects,t+1,r,a)}}function Te(e){return Nr[e]}function xe(e,t,r){for(var a=[],n=Te(e),_=0;_<n.length;_++){var s=n[_];if(s.type==r||"ALL"==r)for(var o=0;o<s._scenes.length;o++)t==s._scenes[o]&&a.push(s)}return a}function Oe(e,t,r,a,n,_){for(var s=Te(t.id),o=0;o<s.length;o++)(c=tr.create_object_from_bpy(s[o])).render.data_id=t.id;for(var i=e.worlds,o=0;o<i.length;o++)tr.create_object_from_bpy(i[o],!0);for(var l=tr.get_all_objects("ALL",t.id),o=0;o<s.length;o++){var c=(f=s[o])._object;Qt.update_object(f,c)}for(o=0;o<i.length;o++){var u=i[o],d=u._object;Qt.update_object(u,d)}for(t.is_primary&&Re(e,t.id),o=0;o<s.length;o++){var f=s[o];(c=f._object).is_hair_dupli||(zt.prepare_object_relations(f,c),tr.update_object_relations(f,c),pr.update_transform(c)),"MESH"==c.type&&tr.generate_mesh_render_boundings(f,c)}mt(s),Ie(l),ft(l),pt(l),ht(l),n(t,r)}function Re(e,t){for(var r=0;r<e.scenes.length;r++){for(var a=e.scenes[r],n=tr.get_scene_objs(a,"LAMP",t),_=new Array(n.length),s=0;s<n.length;s++)_[s]=s;for(_.sort(function(e,t){var r=n[e].light,a=n[t].light;return!a.use_diffuse||!a.use_specular||r.use_diffuse&&r.use_specular?!r.use_diffuse&&(a.use_diffuse||!r.use_specular&&a.use_specular)?1:0:1}),s=0;s<_.length;s++){var o=n[_[s]];rr.get_scene_data(o,a).light_index=s}}}function ke(e,t,r,a,n,_){Ne(e);for(var s=0;s<e.scenes.length;s++){var o=t.is_primary?e.scenes[s]:Ir,i=t.is_primary?tr.get_scene_objs(o,"LAMP",t.id):tr.get_scene_objs(o,"LAMP",0),l=tr.get_scene_objs(o,"ALL",t.id),c=xe(t.id,o,"MESH"),u=xe(t.id,o,"EMPTY");t.is_primary&&ir.append_scene(o,l,i,c,u);for(var d=!1,f=0;f<u.length;f++)for(var m=(x=u[f]._object).scenes_data,p=0;p<m.length;p++){var h=m[p].scene,v=ir.update_force_scene(h,x);o.name==h.name&&(d=d||v)}t.is_primary&&o._render.water_params&&!d&&nr.warn('Scene "'+o.name+'" has water but has no wind. Using default settings.');var b=[];ir.set_active(o),Gt.generate_main_batches(o,c,i,b);var g=tr.get_scene_objs(o,"LINE",t.id);Gt.generate_line_batches(o,g);var y=ir.get_graph(o);if(t.is_primary){var E=o._render.sky_params,w=o.world;if(E.render_sky||E.procedural_skydome){var A=w._object;Gt.append_sky_batch_to_world(o,E,A),Gt.create_forked_batches(A,y,o)}ir.generate_auxiliary_batches(o,y);var T=o._render.world_light_set;T&&(T.use_environment_light||T.ngraph_proxy_id)&&Gt.append_cube_sky_batch_to_world(o,w._object)}for(f=0;f<c.length;f++)Gt.create_forked_batches(c[f]._object,y,o);for(f=0;f<b.length;f++)Gt.create_forked_batches(b[f],y,o),tr.objects_storage_add(b[f]);for(l=tr.get_scene_objs(o,"ALL",t.id),ir.assign_scene_data_subs(o,l,i),f=0;f<l.length;f++){var x=l[f];x.render.use_shape_keys&&!x.is_boundings_overridden&&tr.update_boundings(x),rr.check_inv_zup_tsr_is_needed(x)&&(x.need_inv_zup_tsr=!0),tr.update_lod_scene(x,o)}}ir.append_scene_vtex(Ir,e.textures,t.id),t.is_primary&&Ir._render.video_textures.length&&(t.has_video_textures=!0),n(t,r)}function Ne(e){for(var t=0;t<e.scenes.length;t++){var r=e.scenes[t];r._camera=r.camera._object}}function Me(e,t){for(var r=0;r<e.scenes.length;r++)e.scenes[r].camera=null}function Ie(e){for(var t=0;t<e.length;t++){var r=e[t];if("MESH"==r.type){var a=r.armobj;if(a){var n=a.render,_=r.render.bone_skinning_info,s=[];for(var o in _){var i=_[o],l=i.bone_index,c=4*i.deform_bone_index,u=4*l;s.push(c,u)}n.mesh_to_arm_bone_maps.push(s),n.skinned_renders.push(r.render)}}}}function Se(e){var t=e.materials;if(Pe(e.images),(wr.dds_available&&"dds"==Er.compress_format||wr.pvr_available&&"pvr"==Er.compress_format)&&Er.use_compression)for(var r=0;r<t.length;r++){for(var a=t[r],n=a.texture_slots,_=0;_<n.length;_++){var s=n[_],o=s.texture;"IMAGE"!=o.type&&"ENVIRONMENT_MAP"!=o.type||(f=o.image)&&!f._comp_method&&Ce(f,u=!o.b4w_disable_compression&&!s.use_map_normal&&"ENVIRONMENT_MAP"!=o.type&&!o.b4w_shore_dist_map&&"MOVIE"!=f.source)}var i=a.node_tree;if(i)for(var l=i.nodes,_=0;_<l.length;_++){var c=l[_],u=!1;if("TEXTURE"==c.type){var d=c.texture;d&&(f=d.image)&&!f._comp_method&&(u=!d.b4w_disable_compression&&"MOVIE"!=d.image.source&&"ENVIRONMENT_MAP"!=d.type&&!Le(c))}else if("TEX_IMAGE"==c.type){var f=c.image;f&&!f._comp_method&&(u="MOVIE"!=f.source)}else"TEX_ENVIRONMENT"==c.type&&(u=!1);f&&!f._comp_method&&Ce(f,u)}}}function Le(e){for(var t=e.outputs,r=0;r<t.length;r++){var a=t[r];if(a.is_linked&&"Normal"==a.identifier)return!0}return!1}function Ce(e,t){e.filepath.indexOf(".dds")>-1?e._comp_method="dds":t?(e._comp_method=Er.compress_format,"dds"==Er.compress_format?e.filepath+=".dds":e.filepath+=".pvr"):e._comp_method=""}function Pe(e){for(var t=0;t<e.length;t++){var r=e[t],a=Boolean("FILE"==r.source&&r.filepath.indexOf(".dds")>-1&&"dds"==Er.compress_format);r._comp_method=a?"dds":""}}function De(e,t){return t.is_primary?e.scenes[0].b4w_anisotropic_filtering:Ir.b4w_anisotropic_filtering}function Ue(e,t,r,a,n,_){for(var s=e.groups,o=e.objects,i={},l={},c={},u={},d=0;d<s.length;d++){var f=s[d];i[f.uuid]=f,c[f.uuid]=f}for(d=0;d<o.length;d++){var m=o[d];l[m.uuid]=m,u[m.uuid]=m}for(var p=e.scenes,d=0;d<p.length;d++)Fe(p[d].objects,null,u,c,null);for(var h in c)h in i||s.push(c[h]);for(var h in u)h in l||o.push(u[h]);n(t,r)}function Fe(e,t,r,a,n){for(var _=[],s=0;s<e.length;s++){var o=(p=r[(E=e[s]).uuid]).proxy;if(o){t&&-1==_.indexOf(o.uuid)&&_.push(o.uuid);for(var i=r[o.uuid],l=i.constraints,c=0;c<l.length;c++){var u=vr.clone_object_r(l[c]);u.name=u.name+"_CLONE",p.constraints.push(u)}"b4w_proxy_inherit_anim"in p&&!p.b4w_proxy_inherit_anim||(p.animation_data&&(i.animation_data=vr.clone_object_r(p.animation_data)),i.b4w_use_default_animation=p.b4w_use_default_animation,i.b4w_auto_skel_anim=p.b4w_auto_skel_anim,i.b4w_anim_behavior=p.b4w_anim_behavior,i.b4w_cyclic_animation=p.b4w_cyclic_animation)}}for(s=0;s<_.length;s++){var d=_[s],f=vr.get_index_for_key_value(e,"uuid",d);f>-1&&e.splice(f,1)}var m={};if(t)for(s=0;s<e.length;s++){var p=r[(E=e[s]).uuid],h=vr.clone_object_r(p),v="origin_name"in p?p.origin_name:p.name;h.name=rr.gen_dupli_name(t.name,v),h.origin_name=v,h.dg_parent={uuid:t.uuid},Be(h),r[h.uuid]=h,m[E.uuid]=h.uuid,E.uuid=h.uuid,n&&n[p.uuid]&&(h.b4w_cluster_data=n[p.uuid])}for(s=0;s<e.length;s++)if((p=r[(E=e[s]).uuid]).dupli_group){var b=p.dupli_group,g=a[b.uuid],y=vr.clone_object_r(g);y.name=vr.unique_name(g.name+"_CLONE"),Ge(y),a[y.uuid]=y,b.uuid=y.uuid,Fe(y.objects,p,r,a,p.b4w_cluster_data)}if(t)for(s=0;s<e.length;s++){var E=e[s];(p=r[E.uuid]).parent&&p.parent.uuid in m?p.parent.uuid=m[p.parent.uuid]:p.parent&&(nr.warn("Object's \""+p.name+'" parent is not in dupli group. Disabling parenting.'),p.parent=null);for(var l=p.constraints,c=0;c<l.length;c++)(O=l[c]).target&&O.target.uuid in m&&(O.target.uuid=m[O.target.uuid]);var w=p.pose;if(w)for(var A=w.bones,c=0;c<A.length;c++){var T=A[c].constraints;if(T)for(var x=0;x<T.length;x++){var O=T[x];O.target&&O.target.uuid in m&&(O.target.uuid=m[O.target.uuid])}}for(var R=p.modifiers,c=0;c<R.length;c++){var k=R[c];k.object&&k.object.uuid in m&&(k.object.uuid=m[k.object.uuid])}var N=p.lod_levels;if(N&&N.length)for(c=0;c<N.length;c++){var M=N[c];M.object&&M.object.uuid in m&&(M.object.uuid=m[M.object.uuid])}}for(var I in m)Sr[I]=m[I]}function Be(e){e.uuid=Zt.hexdigest("Object"+e.name)}function Ge(e){e.uuid=Zt.hexdigest("Group"+e.name)}function je(e){var t=e.cameras,r=e.groups,a=e.materials,n=e.meshes,_=e.node_groups,s=e.objects,o=e.particles,i=e.scenes,l=e.speakers,c=e.lamps,u=e.textures,d=e.worlds;_||(nr.warn('"node_groups" datablock undefined. reexport main scene.'),_=e.node_groups=[]);for(var f=He(e),m=0;m<i.length;m++){for(var p=i[m],h=p.objects,v=0;v<h.length;v++)We(h,v,f);p.camera&&We(p,"camera",f),p.world&&We(p,"world",f)}for(m=0;m<r.length;m++)for(var b=r[m].objects,v=0;v<b.length;v++)We(b,v,f);for(m=0;m<s.length;m++){var g=s[m];switch(g.dupli_group&&We(g,"dupli_group",f),g.parent&&We(g,"parent",f),g.dg_parent&&We(g,"dg_parent",f),(H=g.animation_data)&&ze(H,f),g.type){case"MESH":g.data||vr.panic("mesh not found for object "+g.name),We(g,"data",f);for(var y=!1,E=g.modifiers,v=0;v<E.length;v++){var w=E[v];"ARMATURE"==w.type?(y&&nr.warn('Object "'+g.name+'" has more than one armature modifiers. Only the first one will be used.'),y=!0,We(w,"object",f)):"CURVE"==w.type&&We(w,"object",f)}var A=g.particle_systems;if(A)for(v=0;v<A.length;v++)We(A[v],"settings",f);break;case"ARMATURE":We(g,"data",f);for(var T=g.pose.bones,x=g.data.bones,v=0;v<T.length;v++){var O=T[v],R=x[O.bone];if(O.bone=R,I=O.constraints)for(N=0;N<I.length;N++)(S=I[N]).target&&We(S,"target",f);for(var k=O.parent_recursive,N=0;N<k.length;N++){var M=k[N];k[N]=T[M]}}break;case"LAMP":case"CAMERA":case"SPEAKER":case"CURVE":We(g,"data",f)}var I=g.constraints;if(I)for(v=0;v<I.length;v++){var S=I[v];S.target&&We(S,"target",f)}var L=g.lod_levels;if(L)for(v=0;v<L.length;v++){var C=L[v];C.object&&We(C,"object",f)}}for(m=0;m<n.length;m++)for(var P=n[m].materials,v=0;v<P.length;v++)We(P,v,f);for(m=0;m<a.length;m++){for(var D=a[m],U=D.texture_slots,v=0;v<U.length;v++)We(U[v],"texture",f);(W=D.node_tree)&&Ye(W,f)}for(m=0;m<_.length;m++)(W=_[m].node_tree)&&Ye(W,f);for(m=0;m<u.length;m++){var F=u[m],B=F.type;"IMAGE"!=B&&"ENVIRONMENT_MAP"!=B||We(F,"image",f)}for(m=0;m<t.length;m++){var G=t[m];G.dof_object&&We(G,"dof_object",f)}for(m=0;m<l.length;m++){var j=l[m];j.sound&&We(j,"sound",f),(H=j.animation_data)&&ze(H,f)}for(m=0;m<o.length;m++){for(var z=o[m],U=z.texture_slots,v=0;v<U.length;v++)We(U[v],"texture",f);z.dupli_group&&We(z,"dupli_group",f),z.dupli_object&&We(z,"dupli_object",f)}for(m=0;m<c.length;m++)(H=c[m].animation_data)&&ze(H,f);for(m=0;m<d.length;m++){var Y=d[m];if(U=Y.texture_slots)for(v=0;v<U.length;v++)We(U[v],"texture",f);var H=Y.animation_data;H&&ze(H,f);var W=Y.node_tree;W&&Ye(W,f)}}function ze(e,t){if(e.action&&We(e,"action",t),e.nla_tracks)for(var r=0;r<e.nla_tracks.length;r++)for(var a=e.nla_tracks[r],n=0;n<a.strips.length;n++)a.strips[n].action&&We(a.strips[n],"action",t)}function Ye(e,t){for(var r=e.nodes,a=0;a<r.length;a++){var n=r[a];"TEXTURE"==n.type&&n.texture&&We(n,"texture",t),"LAMP"==n.type&&n.lamp&&(n.lamp.uuid in Sr&&(n.lamp.uuid=Sr[n.lamp.uuid]),t[n.lamp.uuid]||(n.lamp=null)),"GROUP"==n.type&&n.node_group&&We(n,"node_group",t),"TEX_IMAGE"!=n.type&&"TEX_ENVIRONMENT"!=n.type||!n.image||We(n,"image",t)}for(var _=e.links,a=0;a<_.length;a++){var s=_[a];qe(s,"from_node",r),qe(s,"to_node",r),Ve(s,"from_socket",s.from_node.outputs),Ve(s,"to_socket",s.to_node.inputs)}var o=e.animation_data;o&&ze(o,t)}function He(e){for(var t=["actions","armatures","cameras","curves","groups","images","lamps","materials","meshes","node_groups","objects","particles","scenes","sounds","speakers","textures","worlds"],r={},a=0;a<t.length;a++)for(var n=e[t[a]],_=0;_<n.length;_++){var s=n[_];r[s.uuid]=s}return r}function We(e,t,r){if(e[t]){var a=r[e[t].uuid];a||nr.error("Dangling link found:",t,e),e[t]=a}}function qe(e,t,r){var a=e[t],n=vr.keysearch("name",a.name,r);e[t]=n}function Ve(e,t,r){var a=e[t],n=vr.keysearch("identifier",a.identifier,r);e[t]=n}function Xe(e,t,r,_,s,o){for(var i=[],l=[],c={},u=e.images,d=fr.get_img_textures(),f=Lt(t.filepath),m=0;m<u.length;m++){var p=u[m],h=p.uuid;if(h){var v=vr.normpath_preserve_protocol(f+p.filepath),b=Bt.split_extension(v),g=b[1].toLowerCase(),y=p.source;if("FILE"===y){if(w=p._comp_method?Bt.AT_ARRAYBUFFER:Bt.AT_IMAGE_ELEMENT,!Bt.check_image_extension(g)){nr.error('image "'+p.name+'" has unsupported format or broken path.');continue}wr.min50_available&&Er.use_min50&&(v=Je(b))}else{if("MOVIE"!==y){nr.error('Image "'+p.name+'" has unsupported format "'+y+'".');continue}if(Er.seq_video_fallback)v=b[0]+".altconv.seq",w=Bt.AT_SEQ_VIDEO_ELEMENT;else{var E=lr.detect_video_container(g);if(""==E){nr.error("failed to load video file (unsupported format)",v);continue}v=E!=g?b[0]+".altconv."+E:b[0]+"."+b[1];var w=Bt.AT_VIDEO_ELEMENT}}h in c||(c[h]=[]);for(var A=0;A<d.length;A++){var T=d[A];(!fr.get_cache_loaded_status(T)&&T.img_comp_method==p._comp_method&&T.img_uuid==h||t.is_preloading)&&c[h].push(T)}p._comp_method&&Er.assets_gzip_available&&(w=Bt.AT_ARRAYBUFFER_ZIP,v+=".gz"),c[h].length&&i.push({id:h,type:w,url:v,is_fetch:t.is_preloading})}}if(i.length){var x=0,O=function(_,s,u,d){if(_){if(t.is_preloading)v=u;else{for(var f=c[s],m=0;m<f.length;m++){var p=f[m];if(u==Bt.AT_SEQ_VIDEO_ELEMENT)p.seq_fps=_.fps,fr.update_texture(p,_.images,t.id);else if(fr.update_texture(p,_,t.id),"ENVIRONMENT_MAP"==p.source&&t.is_primary)for(var h=0;h<e.scenes.length;h++)ir.update_world_texture(e.scenes[h]);fr.set_cache_loaded_status(p,!0)}var v=f[0].img_comp_method}u==Bt.AT_VIDEO_ELEMENT||u==Bt.AT_SEQ_VIDEO_ELEMENT?n(_,d,!0,u):a(_,d,!0,v)}else{var b=Ke(s,d,t.is_preloading,c);b&&(nr.warn("Trying to load fallback image",b.url),l.push(b))}var g=++x/(i.length+l.length);o(t,r,g)},R=function(){l.length?(Bt.enqueue(l,O,R),l.length=0):(nr.log("%cLOADED ALL IMAGES","color: #0a0"),s(t,r))};Bt.enqueue(i,O,R)}else s(t,r)}function Ke(e,t,r,a){var n=Ze(t),_=Bt.split_extension(n);if("gz"==_[1])var s=_[0],o=Bt.AT_ARRAYBUFFER;else if("dds"==_[1]||"pvr"==_[1]){var s=_[0],o=Bt.AT_IMAGE_ELEMENT;$e(a[e])}else{if(-1==n.indexOf(".min50"))return null;var s=Qe(n),o=Bt.AT_IMAGE_ELEMENT}return{id:e,type:o,url:s,is_fetch:r}}function Ze(e){return e.split("?v")[0]}function Qe(e){var t=e.split(".min50");return t[0]+t[1]}function Je(e){if("dds"==e[1]){var t=Bt.split_extension(e[0]);return t[0]+".min50."+t[1]+".dds"}return e[0]+".min50."+e[1]}function $e(e){for(var t=0;t<e.length;t++)e[t].img_comp_method=""}function et(e,t,r,a,n,_){for(var s=ir.get_rendered_scenes(),o=0;o<s.length;o++){var i=s[o];if(i.b4w_use_nla){var l=i.b4w_nla_cyclic;i.b4w_use_logic_editor&&(l=!1),Qt.update_scene(i,l,t.id)}}n(t,r)}function tt(e){for(var t=[],r=fr.get_img_textures(),a=0;a<r.length;a++){var n=r[a];n.uri===e&&t.push(n)}return t}function rt(e,t,r,a,n,_){for(var s=Lt(t.filepath),o=[],i={},l=tr.get_all_objects("ALL",t.id),c=0;c<l.length;c++){var u=l[c];if(nt(u)){var d=u.sfx.uuid;if("BACKGROUND_MUSIC"==lr.get_spk_behavior(u)?(d=vr.gen_uuid(),t.has_background_music=!0):"NONE"!=lr.get_spk_behavior(u)&&Er.init_wa_context_hack&&(t.init_wa_context=!0),!(d in i)){i[d]=[];var f=vr.normpath_preserve_protocol(s+u.sfx.filepath);switch(lr.source_type(u)){case lr.AST_ARRAY_BUFFER:m=Bt.AT_AUDIOBUFFER;break;case lr.AST_HTML_ELEMENT:var m=Bt.AT_AUDIO_ELEMENT}at(o,d,m,f,t.is_preloading)}i[d].push(u)}}if(o.length){var p=0;Bt.enqueue(o,function(e,a,n,s){if(e){nr.log("%cLOAD SOUND","color: #0aa",s),-1==s.indexOf(Mr)&&nr.warn("sound",s,"is not from app root.");for(var l=i[a],c=0;c<l.length;c++)lr.update_spkobj(l[c],e)}var u=++p/o.length;_(t,r,u)},function(){nr.log("%cLOADED ALL SOUNDS","color: #0aa"),n(t,r)})}else n(t,r)}function at(e,t,r,a,n){var _=Bt.split_extension(a),s=_[1].toLowerCase(),o=lr.detect_audio_container(s);""!=o?(a=o!=s?_[0]+".altconv."+o:_[0]+"."+_[1],e.push({id:t,type:r,url:a,is_fetch:n})):nr.error("failed to load audio file (unsupported format)",a)}function nt(e){return rr.is_speaker(e)&&lr.source_type(e)!=lr.AST_NONE}function _t(e,t,r){for(var a=tr.get_scene_objs(e,"SPEAKER",t),n=0;n<a.length;n++){var _=a[n];rr.is_speaker(_)&&(lr.is_autoplay(_)||r)&&lr.play_def(_)}}function st(e,t){for(var r=e._render.video_textures,a=0;a<r.length;a++){var n=r[a]._render;e.b4w_use_nla&&r[a].b4w_nla_video||!r[a].use_auto_refresh||t==n.vtex_data_id&&(fr.reset_video(n),fr.play_video(n))}}function ot(e,t,r,a,n,_){Qt.prepare(),n(t,r)}function it(e,t,r,a,n,_){Qt.start(),nr.log("%cSTART NLA","color: #0a0"),n(t,r)}function lt(e){var t=[];e.materials=[];for(var r=e.meshes,a=0;a<r.length;a++){var n=r[a];if(0==n.materials.length){var _=Kt.create_default();n.materials.push(_),-1==t.indexOf(_.uuid)&&(t.push(_.uuid),e.materials.push(_))}else for(var s=0;s<n.materials.length;s++){var o=n.materials[s],i=Kt.init_material();Kt.update_material(o,i),n.materials[s]=i,-1==t.indexOf(i.uuid)&&(t.push(i.uuid),e.materials.push(i))}}}function ct(e,t){for(var r=0;r<e.length;r++){var a=e[r];a._data_id=t,Ft.append_action(a)}}function ut(e){for(var t={lod_parents:[],lod_levels_data:[]},r=e.scenes,a=0;a<r.length;a++)for(var n=r[a],_=r[a].objects,s=0;s<_.length;s++)dt(n,_,_[s],null,t);for(a=0;a<t.lod_levels_data.length;a++)for(var o=t.lod_levels_data[a],s=0;s<o.old_lods.length;s++){var i=o.old_lods[s],l=o.new_lods[s],c=o.lod_levels[s],u=o.scene_arrays[s],d=o.objs_container_arrays[s];c.object=l;for(var f=0;f<d.length;f++)vr.append_unique(d[f],l);vt(i,u)}}function dt(e,t,r,a,n){for(var _=r.lod_levels.length,s=0;s<_;s++){var o=r.lod_levels[s],i=o.object;if(i){var l=n.lod_parents.indexOf(r);if(-1==l)n.lod_parents.push(r),c={old_lods:[],new_lods:[],lod_levels:[],scene_arrays:[],objs_container_arrays:[]},n.lod_levels_data.push(c);else var c=n.lod_levels_data[l];var u=c.old_lods.indexOf(i);if(-1!=l&&-1!=u)c.scene_arrays[u].push(e),c.objs_container_arrays[u].push(t);else{var d=vr.clone_object_nr(i);d.name=r.name+"_LOD_"+String(s+1),d.b4w_cluster_data=r.b4w_cluster_data,Be(d),d.lod_levels=[],a&&(d.dg_parent=a),c.old_lods.push(i),c.new_lods.push(d),c.lod_levels.push(o),c.scene_arrays.push([e]),c.objs_container_arrays.push([t])}}}var f=r.dupli_group;if(f)for(var m=f.objects,p=0;p<m.length;p++)dt(e,m,m[p],r,n)}function ft(e){for(var t=-1,r=-1,a=Ft.get_max_bones(),n=0;n<e.length;n++)if(o=(s=e[n]).render,rr.is_mesh(s)&&o.is_skinning){var _=o.max_bones;_>t&&(t=_),a>=_&&_>r&&(r=_)}for(n=0;n<e.length;n++){var s=e[n],o=s.render;rr.is_mesh(s)&&o.is_skinning&&(o.frames_blending=!0,t<a?o.max_bones=t:o.max_bones<=a?o.max_bones=r:(nr.warn('too many bones for "'+s.name+'" / '+o.max_bones+" bones (max "+a+" with blending, "+2*a+" without blending). Blending between frames will be disabled."),o.max_bones=t,o.frames_blending=!1),o.frames_blending=o.frames_blending&&!yr.frames_blending_hack)}}function mt(e){for(var t=0;t<e.length;t++){var r=e[t],a=r._object,n=a.render;if(rr.is_mesh(a)||rr.is_empty(a)){var _=r.lod_levels.length;if(_){for(var s=[r],o=[0],i=1/0,l=0;l<_;l++){var c=r.lod_levels[l].object,u=r.lod_levels[l].distance;if(!c){i=u;break}s.push(c),o.push(u)}for(o.push(i),l=0;l<s.length;l++){var d=(c=s[l])._object.render;d.is_lod=!0,"DYNAMIC"==n.type&&l>0&&br.subtract(n.bs_world.center,d.bs_world.center,d.main_lod_offset),d.lod_dist_min=o[l],d.lod_dist_max=o[l+1];var f=0==l?0:o[l]-o[l-1],m=o[l+1]-o[l],p=l==s.length-1?1/0:o[l+2]-o[l+1];d.lod_lower_border_range=Math.min(f,m),d.lod_upper_border_range=Math.min(m,p)}}}}}function pt(e){for(var t=0;t<e.length;t++){var r=e[t];if(r.is_vehicle){var a=r.vehicle_settings;if("CHASSIS"==a.part){if(r.vehicle={},r.vehicle.force_max=a.force_max,r.vehicle.brake_max=a.brake_max,r.vehicle.suspension_compression=a.suspension_compression,r.vehicle.suspension_stiffness=a.suspension_stiffness,r.vehicle.suspension_damping=a.suspension_damping,r.vehicle.wheel_friction=a.wheel_friction,r.vehicle.roll_influence=a.roll_influence,r.vehicle.max_suspension_travel_cm=a.max_suspension_travel_cm,r.vehicle.engine_force=0,r.vehicle.brake_force=1,r.vehicle.steering=0,r.vehicle.speed=0,r.vehicle.props=[],r.vehicle.prop_offsets=[],r.vehicle.steering_wheel=null,c=rr.get_dg_parent(r))n=rr.get_dg_objects(c,e);else var n=e;for(d=0;d<n.length;d++)if((f=n[d]).is_vehicle)if(m=f.vehicle_settings,ar.is_car_wheel(f)&&a.name==m.name){var _=ar.wheel_index(f.vehicle_settings.part);r.vehicle.props[_]=f,r.vehicle.prop_offsets[_]=new Float32Array(8)}else if(ar.is_vehicle_steering_wheel(f)&&a.name==m.name){r.vehicle.steering_wheel=f,r.vehicle.steering_max=m.steering_max,r.vehicle.steering_ratio=m.steering_ratio,r.vehicle.inverse_control=m.inverse_control;var s=hr.invert(r.render.world_tsr,hr.create()),o=hr.multiply(s,f.render.world_tsr,s);r.vehicle.steering_wheel_tsr=o,p=new Float32Array([1,0,0]),hr.transform_dir_vec3(p,o,p),r.vehicle.steering_wheel_axis=p}else if(ar.is_vehicle_speedometer(f)&&a.name==m.name){r.vehicle.speedometer=f,r.vehicle.speed_ratio=m.speed_ratio,r.vehicle.max_speed_angle=m.max_speed_angle;var s=hr.invert(r.render.world_tsr,hr.create()),i=hr.multiply(s,f.render.world_tsr,s);r.vehicle.speedometer_tsr=i,h=new Float32Array([1,0,0]),hr.transform_dir_vec3(h,i,h),r.vehicle.speedometer_axis=h}else if(ar.is_vehicle_tachometer(f)&&a.name==m.name){r.vehicle.tachometer=f,r.vehicle.delta_tach_angle=m.delta_tach_angle;var s=hr.invert(r.render.world_tsr,hr.create()),l=hr.multiply(s,f.render.world_tsr,s);r.vehicle.tachometer_tsr=l,v=new Float32Array([1,0,0]),hr.transform_dir_vec3(v,l,v),r.vehicle.tachometer_axis=v}4!=r.vehicle.props.length&&vr.panic("Not enough wheels for chassis "+r.name)}else if("HULL"==a.part){r.vehicle={},r.vehicle.props=[],r.vehicle.prop_offsets=[],r.vehicle.force_max=a.force_max,r.vehicle.brake_max=a.brake_max,r.vehicle.floating_factor=a.floating_factor,r.vehicle.water_lin_damp=a.water_lin_damp,r.vehicle.water_rot_damp=a.water_rot_damp,r.vehicle.engine_force=0,r.vehicle.brake_force=1,r.vehicle.steering=0,r.vehicle.speed=0,r.vehicle.steering_wheel=null;var c=rr.get_dg_parent(r);if(c)u=rr.get_dg_objects(c,e);else var u=e;for(var d=0;d<u.length;d++){var f=u[d];if(f.is_vehicle){var m=f.vehicle_settings;if(ar.is_boat_bob(f)&&a.name==m.name)r.vehicle.props.push(f),r.vehicle.prop_offsets.push(new Float32Array(8));else if(ar.is_vehicle_steering_wheel(f)&&a.name==m.name){r.vehicle.steering_wheel=f,r.vehicle.steering_max=m.steering_max,r.vehicle.steering_ratio=m.steering_ratio,r.vehicle.inverse_control=m.inverse_control;var s=hr.invert(r.render.world_tsr,hr.create()),o=hr.multiply(s,f.render.world_tsr,s);r.vehicle.steering_wheel_tsr=o;var p=new Float32Array([1,0,0]);hr.transform_dir_vec3(p,o,p),r.vehicle.steering_wheel_axis=p}else if(ar.is_vehicle_speedometer(f)&&a.name==m.name){r.vehicle.speedometer=f,r.vehicle.speed_ratio=m.speed_ratio,r.vehicle.max_speed_angle=m.max_speed_angle;var s=hr.invert(r.render.world_tsr,hr.create()),i=hr.multiply(s,f.render.world_tsr,s);r.vehicle.speedometer_tsr=i;var h=new Float32Array([1,0,0]);hr.transform_dir_vec3(h,i,h),r.vehicle.speedometer_axis=h}else if(ar.is_vehicle_tachometer(f)&&a.name==m.name){r.vehicle.tachometer=f,r.vehicle.delta_tach_angle=m.delta_tach_angle;var s=hr.invert(r.render.world_tsr,hr.create()),l=hr.multiply(s,f.render.world_tsr,s);r.vehicle.tachometer_tsr=l;var v=new Float32Array([1,0,0]);hr.transform_dir_vec3(v,l,v),r.vehicle.tachometer_axis=v}}}}}}}function ht(e){for(var t=0;t<e.length;t++){var r=e[t];if(r.is_floating){var a=r.floating_settings;if("MAIN_BODY"==a.part){r.floater={},r.floater.floating_factor=a.floating_factor,r.floater.water_lin_damp=a.water_lin_damp,r.floater.water_rot_damp=a.water_rot_damp,r.floater.bobs=[];var n=rr.get_dg_parent(r);if(n)_=rr.get_dg_objects(n,e);else var _=e;for(var s=0;s<_.length;s++){var o=_[s];if(o.is_floating){var i=o.floating_settings;ar.is_floater_bob(o)&&a.name==i.name&&(r.floater.bobs.push(o),o.bob_synchronize_pos=o.floating_settings.synchronize_position)}}}}}}function vt(e,t){for(var r=0;r<t.length;r++){for(var a=t[r].objects,n=0;n<a.length;n++){var _=a[n].dupli_group;_&&bt(e,_)}var s=a.indexOf(e);s>-1&&a.splice(s,1)}}function bt(e,t){var r=t.objects,a=r.indexOf(e);a>-1&&r.splice(a,1);for(var n=0;n<r.length;n++)(t=r[n].dupli_group)&&bt(e,t)}function gt(e,t,r,a,n,_){for(var s=!0,o=0;o<e.scenes.length;o++){var i=e.scenes[o];if(!ar.check_worker_loaded(i)){s=!1;break}}s&&(n(t,r),nr.log("%cPHYSICS READY","color: #0a0"))}function yt(e,t,r,a,n,_){for(var s=0;s<e.scenes.length;s++){var o=e.scenes[s];if(t.is_primary)i=ar.scene_has_physics(o);else{var i=ar.scene_has_physics(Ir)||ar.scene_has_physics(o);o=Ir}if(Ar.enabled&&i)for(var l=0;l<Hr.length;l++)for(var c=Hr[l],u=tr.get_scene_objs(o,c,t.id),d=0;d<u.length;d++){var f=u[d];f.render.data_id==t.id&&(ar.append_object(f,o),t.load_hidden&&ar.obj_has_physics(f)&&ar.disable_simulation(f))}}n(t,r)}function Et(e,t,r,n,_,s){for(var o={},i=[],l=e.scenes,c=0;c<e.scenes.length;c++){var u=l[c];if(u._render.water_params){var d=u._render.water_params.shoremap_image;if(d&&"FILE"===d.source){var f=d.uuid,m=Lt(t.filepath),p=vr.normpath_preserve_protocol(m+d.filepath);if(d._comp_method)h=Bt.AT_ARRAYBUFFER;else var h=Bt.AT_IMAGE_ELEMENT;i.push({id:f,type:h,url:p}),o[f]=d}}}i.length?Bt.enqueue(i,function(e,r,n,_){if(e){a(e,_,!0);for(var s=tt(r),i=0;i<s.length;i++){var c=s[i];fr.update_texture(c,e,t.id)}for(i=0;i<l.length;i++){var u=l[i];if(u._render.water_params){var f=u._render.water_params.shoremap_image;f===d&&wt(e,d,u)}}}else for(var m=o[r],i=0;i<l.length;i++)(f=(u=l[i])._render.water_params.shoremap_image)===m&&(u._render.water_params.shoremap_image=null,nr.warn("image",f.filepath," was not found. Disabling water shore effects."))},function(){_(t,r)}):_(t,r)}function wt(e,t,r){var a=document.createElement("canvas"),n=t.size[0],_=t.size[1];a.width=n,a.height=_;var s=a.getContext("2d");s.drawImage(e,0,0);var o=s.getImageData(0,0,n,_).data,i=new Float32Array(4);i[0]=1/16581375,i[1]=1/65025,i[2]=1/255,i[3]=1;for(var l=n*_,c=new Float32Array(l),u=0;u<l;u++)c[u]=i[1]*o[4*u+2]+i[2]*o[4*u+3];r._render.shore_distances=c}function At(e,t,r,n,_,s){for(var o=e.scenes[0],i=[],l=[ur.SMAA_EDGE_DETECTION,ur.SMAA_BLENDING_WEIGHT_CALCULATION,ur.SMAA_NEIGHBORHOOD_BLENDING,ur.SMAA_RESOLVE],c=0;c<l.length;c++){var u=ir.get_subs(o,l[c]);u&&i.push(u)}if(i.length){var d=[],f=Bt.AT_IMAGE_ELEMENT,m=jt.paths.smaa_search_texture_path;d.push({id:"SEARCH_TEXTURE",type:f,url:m,is_fetch:t.is_preloading});var p=jt.paths.smaa_area_texture_path;for(d.push({id:"AREA_TEXTURE",type:f,url:p,is_fetch:t.is_preloading}),c=0;c<i.length;c++){var h=i[c];if(h.type==ur.SMAA_BLENDING_WEIGHT_CALCULATION){for(var v=h.slinks_internal,b=0;b<v.length;b++){var g=v[b];if("u_search_tex"==g.to)var y=g.texture;else if("u_area_tex"==g.to)var E=g.texture}break}}d.length?Bt.enqueue(d,function(e,r,n,_){if(e){if(a(e,_,!1),"SEARCH_TEXTURE"==r)s=y;else var s=E;s.source="IMAGE",fr.update_texture(s,e,t.id),fr.set_filters(s,fr.TF_LINEAR,fr.TF_LINEAR)}},function(){_(t,r)}):_(t,r)}else _(t,r)}function Tt(e,t,r,a,n,_){for(var s=0;s<e.scenes.length;s++){var o=e.scenes[s];t.is_primary||(o=Ir);for(var i=tr.get_scene_objs(o,"LAMP",t.id),l=0;l<i.length;l++){var c=i[l];c.render.data_id==t.id&&a.added_objects.push({scene:o,obj:c})}for(var u=tr.get_scene_objs(o,"ALL",t.id),l=0;l<u.length;l++){var d=u[l];"LAMP"!=d.type&&d.render.data_id==t.id&&(t.load_hidden&&rr.is_mesh(d)&&ir.change_visibility(d,!0),a.added_objects.push({scene:o,obj:d}))}}}function xt(e,t,r,a,n,_){var s=a.added_objects,o=a.obj_counter;if(s.length){var i=s[o].obj,l=s[o].scene,c=rr.get_scene_data(i,l);ir.append_object(l,i),!i.anchor||l._render.anaglyph_use||l._render.sidebyside_use||Ut.append(i),b=++a.obj_counter/s.length,i.render.hide_children&&ir.change_visibility_rec(i,!0);var u=c.cube_refl_subs;if(-1!=i.render.cube_reflection_id&&u){var d=br.copy(i.render.bs_world.center,Lr);ir.update_cube_reflect_subs(u,d)}var f=i.reflective_objs;if(f.length&&l._render.reflection_params)for(var m=hr.get_trans_view(i.render.world_tsr),p=hr.get_quat_view(i.render.world_tsr),h=c.plane_refl_subs,v=0;v<h.length;v++)ir.update_plane_reflect_subs(h[v],m,p),rr.update_refl_objects(f,h[v].camera.reflection_plane)}else var b=1;_(t,r,b)}function Ot(e,t,r,a,n,_){if(t.is_primary){var s=ir.get_main();ir.update_world_texture(s);for(var o=ir.get_rendered_scenes(),i=0;i<o.length;i++){var l=o[i];ir.update_world_texture(l),ir.prepare_rendering(l,s)}ir.set_active(s)}else ir.update_scene_permanent_uniforms(Ir);var c=tr.get_all_objects("ALL",t.id);tr.update_objects_dynamics(c),n(t,r)}function Rt(e,t,r,a,n,_){if(t.is_primary)for(var s=ir.get_rendered_scenes(),o=0;o<s.length;o++)for(var i=s[o],l=tr.get_scene_objs(i,"WORLD",0),c=0;c<l.length;c++){var u=l[c];ir.init_cube_sky_dim(i,u),ir.update_world_texture(i)}n(t,r)}function kt(e,t,r,a,n,_){if(t.is_primary)for(var s=ir.get_rendered_scenes(),o=0;o<s.length;o++){var i=s[o];i.b4w_use_logic_editor&&Jt.init_logic(i,t.id)}n(t,r)}function Nt(e,t,r,a,n,_){if(t.is_primary)for(var s=0;s<e.scenes.length;s++)st(e.scenes[s],t.id),_t(e.scenes[s],t.id,!1);else st(Ir,t.id),_t(Ir,t.id,!1);n(t,r)}function Mt(e,t,r,a,n,_){Me(e,t),Er.media_auto_activation&&(t.has_video_textures||t.has_background_music||t.init_wa_context)?Fr||It(e,n,t,r):n(t,r)}function It(e,t,r,a){var n=Vr.parentElement;Gr=n.style.zIndex,n.style.zIndex="999",(Fr=document.createElement("div")).style.position="relative",Fr.style.height="88px",Fr.style.width="88px";var _=Math.round(Vr.offsetHeight/2-44),s=Math.round(Vr.offsetWidth/2-44);Fr.style.top=_.toString()+"px",Fr.style.left=s.toString()+"px",Fr.style.backgroundImage="url('"+Ur+"')",Fr.style.backgroundSize="88px",(Br=document.createElement("div")).style.position="relative",Br.style.height=Vr.offsetHeight.toString()+"px",Br.style.width=Vr.offsetWidth.toString()+"px",Br.style.background="rgba(0, 0, 0, 0.5)",Br.style.zIndex="999",n.appendChild(Br),Br.appendChild(Fr),zr=function(){if(r.has_video_textures&&(fr.play(),fr.pause(),fr.reset()),r.has_background_music){if(r.is_primary)for(var n=0;n<e.scenes.length;n++)_t(e.scenes[n],r.id,!0);else _t(Ir,r.id,!0);lr.pause()}r.init_wa_context&&lr.play_empty_sound(),St(),t(r,a)},Vt.add_click_listener(Fr,zr)}function St(){if(Fr){var e=Vr.parentElement;e.style.zIndex=Gr,Vt.remove_click_listener(Fr,zr),Br.removeChild(Fr),e.removeChild(Br),Br=null,Fr=null,Gr=0}}function Lt(e){var t=e.split("/").slice(0,-1).join("/");return t&&(t+="/"),t}function Ct(e){Ft.is_animated(e)&&Ft.remove(e),$t.remove_obj_from_cache(e),tr.clear_outline_anim(e),Yt.check_sensor_manifold(e)&&Yt.remove_sensor_manifold(e),ar.obj_has_physics(e)&&ar.remove_object(e),ir.remove_object_bundles(e),rr.is_speaker(e)&&lr.speaker_remove(e),Ut.is_anchor(e)&&Ut.remove(e)}function Pt(e){var t=Dt(e);return t?1+Pt(t):0}function Dt(e){var t=Ft.get_bpy_armobj(e);return t&&t.parent==e?null:e.parent||t}var Ut=se(e),Ft=Q(e),Bt=F(e),Gt=_e(e),jt=g(e),zt=z(e),Yt=X(e),Ht=T(e),Wt=ae(e),qt=y(e),Vt=S(e),Xt=oe(e),Kt=J(e),Zt=ie(e),Qt=V(e),Jt=K(e),$t=N(e),er=ne(e),tr=$(e),rr=k(e),ar=W(e),nr=m(e),_r=d(e),sr=Z(e),or=te(e),ir=j(e),lr=D(e),cr=B(e),ur=A(e),dr=p(e),fr=ee(e),mr=x(e),pr=Y(e),hr=v(e),vr=h(e),br=l(e),gr=c(e),yr=jt.animation,Er=jt.defaults,wr=jt.assets,Ar=jt.physics,Tr=jt.sfx,xr=!1,Or=3,Rr=4,kr=null,Nr=null,Mr="",Ir=null,Sr={},Lr=new Float32Array(3),Cr=new Float32Array(4),Pr=new Float32Array(4),Dr=dr.create(),Ur="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALAAAACwCAYAAACvt+ReAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAbrwAAG68BXhqRHAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAABVDSURBVHic7Z15kF1Vncc/v05Ys7JIQJZ0GLaAgCzCQARGFMIwZKTiqCPBAbTEEodBhYKALJKSVWYsCpTBcgCLAdQBHWZACCCyhCElIRiWEMOSBZAkCglJOoTQyW/++J3Xfe95971+273v3fvOp6qr+5573+vT3d8+93vP+Z3fTwjUhKoKsC0wLvKxDTA68rEVMNK9ZDiwpft6PdDvvl4LvA+sBt5zn1cCy4EVwDJgpYhouj9RMZB2d6ATUdWtgD2BXvcxARgPbJ5RFzYAS4BFwGL38YqIvJ/R988NQcCAqm4LHADsA+yLibannX1KYBMm6JeBBcA8EVnZ3i61n64UsKoOAyYCh7iPCeTvd6HA68BcYA6wQEQ2trdL2ZO3P1rDqGoPsD9wNHAkMKqBt1nNoFctfV7j2ldj/rbPXdsvIuvd994S88QAIzCfHPXOHyHurRvt21PALOAFEdnUwHvkjsILWFV7gcnAUcDYWl8GvAEsZNCDLhKR91rfw4RvrjoWuyv0us97ALtS+99rFfAEMFNElqTRx06hkAJ2I94ngRMwXzsUmzCxzsP85csisja9HtaPqo7CbM9EzK/vRW1/vwXATODJ0h2hSBRKwO5hbAom3KFuw2uAZzD/+JyIrEm5ey1FVUcDB2Ee/hPU9vM+ANwnIu+m3L3MKISAVXU3YCrwNwx6zSTWArOBJ7Gn+P4q1+YGVR0OfByzSX+N+exKfAg8DtwtIm9m0L1UybWAVfWjwJcw4Vb6WRT4A3YbnV0U0VZCVTfDRDwZOJDKv5dNwGPAXSLydja9az25FLCqbg9MA44FhlW4bDXwIPYgszyrvnUSqrojJuRqlqof+C1wp4i8k1XfWkWuBKyqmwN/D3wRW7ZN4m3gfzHhfpBV3zoZNyofBXwem81I4gPgHsxabMiqb82SGwGr6lHAV7A50yQWA3cCT4c4gmRcPMeRwCnY0ngSK4BbRGRWZh1rgo4XsJtZOAvzdUm8CfwSeKxbJu+bxQl5EnAqsEuFy+YAPxKRP2fWsQboWAG7X/JJwGkMRnVFWQXcDjwchNsYbnVyMibkMQmXvA/8DLi/U+9qHSlg95B2HvCxhNP9wG+AO0SkL+F8oE7cws9UzCNvlnDJAuA6EVmWacdqoOMErKpHA98keS7zReAGEXkr2151B6q6C3A2sF/C6bWYpXgy215Vp2MErKpbYMI9NuF0H3ArNrPQkbeyouCs2wnA6SQPIo8AN3XKDE9HCFhVdwK+iwWv+DwLXF+k5c88oKrbAecAByecfh24shMsRdsFrKqHYn53pHdqAzYtdk8YdduDG40nA18DtvBOrwP+TURmZ96xCG0VsKp+DrtV+f1YDFwrIkuz7lOgHBeSej6wm38KmzP+deadcrRFwG765kxsmszncexBrXChf3nGzVScg63o+cwEftyOHSGZC9htmLwAONQ71Y/9N/9P1n0K1I6qngycQXkMyjPANVkPPJkKWFVHApcDe3un1mIPBc9n2Z9AY6jqgcBFlM9SLAAuy3J+PjMBu20yM4DdvVPLge+JyBtZ9SXQPC4G+zJsD1+U14BLs9p+lYmAXTzDFZRHQi0EZojIqiz6EWgtqroNcCmWQyPKUuDiLKY+Uxewqo4BrqL8CfZF4PKQrCPfuIe7S7Dg+ShvARekPTilKmBVHYGNvHt4p54FrshT3GmgMm4V9SJsf16URcBFae43TE3Abrbh+5Q/sM0Gri761p5uwwXNTwcO904twOxEKrMTqaRPcvO851Eu3uewqZYg3oIhIh9iVnGOd2ofYLrLhtRy0sr/dSbl/4nzMdvwYUrfM9Bm3MB0JfCCd+pQbFNCy2m5gN3ysL/CthCbWgmrawXHPdfMAF7xTk12iyAtpaUCVtXDsNiGKMuxqbIg3i7BzSzNwPbXRfmqC95qGS0TsKqOA75N/MGwjzDP25W41K+XYausA83AeS58tiW0RMCRucBo7oF+zPMWOrlcoDJudfUqIBrkMxK40KVIaJpWjcBnUR6MfkuIbQiIyDzgNq95d+AbrXj/pgWsqpMo3wb0eIgqC5Rw8cL+Xrrj3P7HpmhKwKr6EeBfvOYlwA3NvG+gkFyPxUhEOcvtQG+YhgXstpucSzykbgO2kyLMOARiOE1ci2XHLDES+I7TUkM0MwJPoTxvw63hoS1QCRFZjCVKiXIAcGKj79mQgJ11+LLX/BxwX6MdCXQN92K7N6Kc1qiVaHQE/ibx7JB9wA/D7uHAUDiN3MhgMRyArWlwqbluAbsskf5qyq0hb0OgVlwe4tu85sPcjFZd1CVgN/l8htf8IrYrNRCohwexAK8oX3OxxTVT7wg8FdghctyPbYEP1iFQF04zNzBYQxpge+Cz9bxPzQJ2qYb+wWu+NyTaCzSKW2q+32v+gttDWRP1jMDTiOfpXYUllg4EmuFOrJ5JiS2xDPI1UZOAXTWgT3vNt4f8vIFmcRq63Wv+jCtQMyS1jsCnEM/E8haWZjO3qOrDqrp/u/sRAGwSIFqzbjjwj7W8cEgBuwQWftDFfxagMvpngLmqerNbmAm0CVci4ude87GquvNQr61lBP6cd90SrCJ6ERiO7d/7o6pe0KoY1UBDPI5lJS3Rg2mvKlUF7J4Gj/Ga7yjgtNk2wNXAC6r6+XZ3phtxmvqF1/wpl/2nIkONwFOI1x7+E/B0/d3LDXsBvwz+uG08hRWqLLEZySl4B6goYLdN6ASv+b8LOPomEfxxG3Be+F6v+cRqq3PVRuCjie9xWwM82nj3ckfwx+3hYeLzwqNITqoNVBfw8d7xg10aqB78cYa46kd+bM3kStcnCtjVRNgn2gQ81Gznck7wx9kxE9NciYluOreMSiOwr/g/iMjbiVd2H8Efp4wr3+XvaPcdAZAgYJeYz/ccIVwyTvDH6ePf8Y9x2oyRNALvD4yNHPdhKVED5QR/nB5PY7XoSmwD7OtflCRgf9n4/0I61CEJ/rjFuCSB/sBZNhsRE7DL4XqEd01Rlo2zIPjj1uJrb5JvI/wReCIwOnK8GpiXQseKTPDHrWMutv5QYix2txvAF7Bf42BOsA8NE/xxkzjtzfWaYxr1BezvNvbTxQfqJ/jj5njWO45pdEDALuqnN3JuE5asJNAagj9ujGeJL2rs4YpmAvER+EDiyakXplkeqUsJ/rhOXMXP16JNRFKaRQU80XtteHhLj+CP68PX4sB8cE9So+Pl1LoTKBH8cW34WowL2BUlHB+5QIE/pt+vgCP44+rMJ+6DJ7h49YEReE/io/Ebwf9mTvDHFRCR1dhO+BLDcOWLS6Lt9V7j1/gKZEfwx8ks9I4nwKCAd/dOLkq9O4GhCP44jp84vRcqj8BBwJ1D8MeGr8legB5Xn8CPdg9lAjqL4I/jOSMAxquq9ADbAtFfyJpQWbNj6Vp/7BKoR3PxbQmM7QHGedcuy6xXgUbpVn+83DselyRg/6JA59Jt/tjX5g5BwPmnm/xx4gjs5576S0adCbSWbvDHK7zj7XqI78AAy7weyC9F9serveNRSQIOS8jFoIj+2Bfw6CDgYlM0f+xrc3QPVnC52kWB/FMUf+yPwCN7sBysUT7IqDOB7Mm7P97gHW+eJOCwC7n45NUff+gdb5YkYP+iQDHJoz9OFPBwrzGMwN1FnvxxooADgRLvt7sD9dJD+Yjrj8iBYrMSmA7sLyL3tbszQ1Bmd4djw/Lm3kX+016gePQDtwAXi8if292ZGqko4ChhBC4+jwDfFpEX292ROqlJwBVLGgVyz0Lg3BxYhUr4MyUbeihfeRtFoGjkyedWoyzsYTgJ68sZdSaQPnn0udVIFHBZhE9GnQmkS159bjV8bb4XBFw88u5zq+Hb27XDMX8UZfuMOhNoLSuBa4AfugIpRWQH7/id4ZTvM9oxo84EWkPRfG41fG0uTxKwr/JA51JEn1sNX5uJAg4jcOdTZJ9bjbId9D3Au8SD2EdFaxAEOoqizOfWjapuC4yINL0PvNcjIgos9a7vzapjgZroB34C7C0i1xT4Ia0aE7zjJSIyUPUwMfNfoCN4BDhIRL7eBQ9p1ej1jhfBYODOYu+kr/ZA9nSrz63EeO94CQwK2B+B90y9O4FKdMN8biPs5R0vhkEBvwJsxGoPAOyqqqNCnYxM6ab53LpQ1dHAzpGmjcCr4DK0i8h64jZCgH0y6l8g+Nyh2Jd4Ec7XnWZjlYkq1uIKpMZCYIqIHNdFixGN4GvxpdIX1QScx8QXeaFr53Mb5EDveECr0e1Dz2PF5EpD9d6qOsbVqg20huBz60RVxxCvoqUkjcAishJ4PXKhAB9Pu4NdRPC5jXEIcf/7SrSGi58XYm7CiwPNEXxuc/ganBM98AU8xzs+TFXDLuXGCD63SZz2fAHHBllfwAuI79AYSbAR9RLiFlrHwcTT/67CKzkbE7CIbASe8t7kk6l0rZgEn9tajvaOZ4nIpmhDUm60Wd7xEarqJ5QIxAk+t8W4bJmHec2+NhMF/DwWI1xiBHB467pWKILPTY8jga0jx+8SmT4rUSZgFx/sK/2ElnYt/wSfmz7HecdPOG3GqJRedaZ3fKCq7tSSbuWf4HNTRlV3BA7wmh9KujZRwCKyBJuRGGgCjm9J7/JL8LnZMZn44sV8EfF3DQGVR2AoH4VPUNUtm+1ZDgk+N0NUdQvKLauvxQGqCfgJ4nnTRgHHNt613BF8bns4jngGnjUkzD6UqChgEfkA+I3XPFVVu6EsQfC5bcBp67Ne831Oi4kMJcb7iecP3hE4orHu5YLgc9vLJCA6WbAB02BFqgpYRN4FHveap6mqJF2fY4LPbTNu9D3Fa340GnmWRC124G4guny3G+VLfHkl+NzO4Rhg18jxRuBXQ71oSAGLyJvAY17zNFUdlnB5nngAOCD43PbjRt8ves2/E5E/DfXaWh/I7iJejuuj5HxeWEROFBF/G1WgPZwI7BI57gd+XssLaxKwiLwN/NZrPlVVRyRdHwjUiqqOBKZ5zQ+LyLJaXl/PlNidwPrI8RjgS3W8PhBIYhrxed/12B2/JmoWsIi8gz3QRTlJVXdJuj4QGApV3Q34W6/5F272qybqXZT4FfF8wsOBbxVwWi2QMk4z/0x8Z/wy4N563qcuAbtpplu95n0I4ZaB+jmR8oQlP613KrPuZWERmQX83ms+XVW3q/e9At2Jqm4PnOY1zxaR2fW+V6NxDTcCfZHjEQQrEaiBiHWI7rZYB/x7I+/XkICdyb7daz4ImNLI+wW6ipOBQ72220TkL428WTORZfcDL3htp6tqbxPvGSgwqro78E9e8zxsVbQhGhaw25/0r8DaSPPmwPldGvgeqIKqbgWcD0R3uK/BEnmX7XWrlaZie92wf4PXvBtwbvDDgRJOC+cQXy4G+HGj1qFE08HpIvIUFgAe5QjKA5MD3ctUyhPkzBSRJ5t941btrriJeGZLgDNU1c/rGugyVPUgyn3vq8DNrXj/lgjYbfn4PvG8asOA74aHuu7FLRVPZ7D2CpjvvapVsdct298mIiuAHxAPft8auERVt2nV9wnkA1dZ83vEq2sqcJ2I+OWNG6alGzRF5DnKl5rHAZe6p9BAF6CqWwOXUV6c+6ci8mwrv1fLdxiLyK8Bf1/ZnsCMML1WfFxeh0uBv/JOPSgidQXq1EJaW+R/Avjr2hOBi13WwUABcQmpLwQ+5p2agz3ot5xUBOxyuF5HPD0VWLLsC0K61uLh/qYXUb5MPB+42uWebjmpLja4LUdXAHt4p54HZpSK1QXyjbMNF2PxMFEWAReKyNryV7WG1FfLXJnQq7EVuigvAZeLyLq0+xBID/dccwnltdzeBKYPldehWVJPEyUiq7H/Tj+74H7AFWGKLb+4qbJrKBfvUuCitMULGYzAJdzu0xmUVx1/BxuJ/ZW8QAfjFim+R/lU2WvApVkVyMw04MZ54sspLyTeB1wpIvOy7E+gMdzy8HTiixRgD2yXi0hf+avSIfOIMeeZLgA+4Z3aiC2C3NtMeF0gPVxU2VQstsHPzPR74NqsH8zbEvLoUgmdCZyUcHo2FiOa2X9xYGjcwPMtksuuPQjclNZUWTXaGrOrqicDX03ox1Lsv3lx5p0KlOF2UpxPeTzvJuA/0lhhq5W2B52r6gHYL2esd+pD4A7gnmAp2oOzDFOAM4jvpACLKvuBiPj1tTOl7QIGUNVx2CqOv34OVhv3epcZKJARbuv7OZQvToDNNFzZyqiyRukIAcNAZcZvUF4fDGyW4mfAA2E0Thc36v4d9qC2dcIlM4GbOyWXcscIuISqTgLOJl7kucR84AYReSPbXnUHbm73bCzwymcNcKPbQtYxdJyAYeD29R3Ki92B5Y69D7grzFS0BrfIdAqW7ml4wiXzsJmhpjZgpkFHChhqupWtxpKrPNSO6Zsi4LLsnwCcSjzFaYl1wG10sHXrWAGXcOvtX8cq2CSxHPgvTMibKlwTiOAGh0nAl4GdK1z2DPCjThx1o3S8gEs4b/wVbItSEkuxxMizOnW0aDduAWkSZhd2rXDZMmxu9+nMOtYEuREwDET8n4jd8pJsBdiIfC82Iod4YwaCzY8CvkD5YkSJ9Vj+57s7ZYahFnIl4BLOVkwDPk3yQwfYU/ODmJDfzqpvnYSq7oQVzp5MsscFeyh+GHsorjkzeqeQSwGXUNUdsTodn6JybLNiO0BmYjloczO6NIKbTz8SqyK1P5X/xhuB32HCbfuCRKPkWsAlXJ2OqZiQq+23W4cFC80C5opIf5Vrc4OzCAdhNuFwKtsrsCX6R7El+iHrsHU6hRBwCbe74yTMJ1e6ZZbow56052JiTn33QCtR1bHAwcAh2EbKoUqercFS4t6Xt5+1GoUScAm3yfAo7Dbq12FIfAmWr+t5bLXvZbcVqmNQ1THYCtm+2Bae3ant7zcfeAh4slrV97xSSAFHccujx2P1nbet9WXAW1j1+iVY4sIlWT3kuHoj44EJQC+WGKaecmbvAk9gGSALvexeeAGXcJP3+2Ej8yTKwzdroQ+bJ12BTdetwFYE10Q+r8PiZPtL03guGHw49qC5NWZvRkc+74DNb5c+GqmAugrz9rOAl7plLrxrBBzFTejvhXnHQ7C8FXn7XSjwCvCs+1jYjSuRefujpYLzl/tj/nIi5i/9PV/tZiNmZV7Gcmq8mNXO304mCDgBd8vfA/OfvZgXHQ9klZxwPbAY89+L3NevhpXFcoKA68BN05V86g7Adgz62NGYd90KG72Hua8B3sdG0H5MnH2YZy755ncY9NTLijTNlTb/Dz+sKh/f1rAbAAAAAElFTkSuQmCC",Fr=null,Br=null,Gr=0,jr=!1,zr=null,Yr=["LAMP"],Hr=["MESH","CAMERA","EMPTY"],Wr=12,qr=["BSDF_GLOSSY","BSDF_DIFFUSE","BSDF_TRANSPARENT"],Vr=null;t.is_primary_loaded=function(e){return Xt.is_primary_loaded(e)},t.update=function(){Xt.update_scheduler(kr)},t.setup_canvas=function(e){Vr=e},t.update_media_controls=function(e,t){if(Fr){Br.style.height=t.toString()+"px",Br.style.width=e.toString()+"px";var r=Math.round(t/2-44),a=Math.round(e/2-44);Fr.style.top=r.toString()+"px",Fr.style.left=a.toString()+"px"}},t.load=function(e,t,a,n,s){var o={load_main:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:[],is_resource:!1,relative_size:500,primary_only:!1,cb_before:_},duplicate_objects:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["load_main"],is_resource:!1,relative_size:50,primary_only:!1,cb_before:Ue},load_binaries:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:["load_main"],is_resource:!1,relative_size:500,primary_only:!1,cb_before:u},wait_for_shaders:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:[],is_resource:!1,relative_size:50,primary_only:!0,cb_loop:f},prepare_bindata:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["duplicate_objects","load_binaries"],is_resource:!1,relative_size:100,primary_only:!1,cb_before:E},prepare_bpy_data:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["duplicate_objects","prepare_bindata"],is_resource:!1,relative_size:100,primary_only:!1,cb_before:re},process_objects:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["prepare_bpy_data"],is_resource:!1,relative_size:150,primary_only:!1,cb_before:Oe},process_scenes:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["process_objects","wait_for_shaders"],is_resource:!1,relative_size:300,primary_only:!1,cb_before:ke},load_smaa_textures:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:["process_scenes"],is_resource:!1,relative_size:30,primary_only:!0,cb_before:At},load_shoremap:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:["process_scenes"],is_resource:!1,relative_size:30,primary_only:!0,cb_before:Et},load_images:{priority:Xt.ASYNC_PRIORITY,background_loading:!0,inputs:["process_scenes"],is_resource:!0,relative_size:500,primary_only:!1,cb_before:Xe},update_scenes_nla:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["process_scenes","load_images"],is_resource:!1,relative_size:50,primary_only:!1,cb_before:et},wait_physics_workers:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["load_shoremap"],is_resource:!1,relative_size:20,primary_only:!1,cb_loop:gt},add_physics_objects:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["wait_physics_workers"],is_resource:!1,relative_size:50,primary_only:!1,cb_before:yt},add_objects:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["add_physics_objects"],is_resource:!1,relative_size:600,primary_only:!1,cb_before:Tt,cb_loop:xt,cb_after:Ot,cb_param:{added_objects:[],obj_counter:0}},init_cube_sky_dynamic_props:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["add_objects","load_images"],is_resource:!1,relative_size:50,primary_only:!1,cb_before:Rt},init_logic_nodes:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["update_scenes_nla","add_objects"],is_resource:!1,relative_size:50,primary_only:!1,cb_before:kt},load_speakers:{priority:Xt.ASYNC_PRIORITY,background_loading:!0,inputs:["add_objects"],is_resource:!0,relative_size:100,primary_only:!1,cb_before:rt},mobile_media_start:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["load_images","update_scenes_nla","load_speakers","init_logic_nodes"],is_resource:!0,relative_size:5,primary_only:!1,cb_before:Mt,cb_loop:Mt},synchronize_media:{priority:Xt.SYNC_PRIORITY,background_loading:!0,inputs:["mobile_media_start"],is_resource:!0,relative_size:50,primary_only:!1,cb_before:Nt},prepare_nla:{priority:Xt.SYNC_PRIORITY,background_loading:!1,inputs:["mobile_media_start"],is_resource:!1,relative_size:5,primary_only:!0,cb_before:ot},start_nla:{priority:Xt.SYNC_PRIORITY,background_loading:!0,inputs:["prepare_nla"],is_resource:!1,relative_size:5,primary_only:!0,cb_before:it}},i=Xt.get_scheduler();return i||(i=Xt.create_scheduler(),kr={},Nr={},Sr={}),kr[i.threads.length]={},Xt.create_thread(o,e,t,a,r,n||Tr.audio_loading_hack,Er.do_not_load_resources,s,!1)},t.unload=function(e){var t=Xt.get_scheduler();if(t&&t.threads.length&&(!e||Xt.thread_is_finished(t.threads[e]))){if(0==e)nr.log("%cUNLOAD ALL","color: #00a"),Ut.cleanup(),Ft.cleanup(),lr.cleanup(),Gt.cleanup(),ir.cleanup(),Xt.cleanup(),Yt.cleanup(),ar.cleanup(),tr.cleanup(),vr.cleanup(),or.cleanup(),er.cleanup(),cr.cleanup(),qt.cleanup(),Bt.cleanup(),fr.cleanup(),Jt.cleanup(),$t.cleanup(),Vt.cleanup(),Wt.cleanup(),Nr=null,Sr={},Ir=null,kr=null,jr=!1;else{nr.log("%cUNLOAD DATA "+e,"color: #00a"),Ft.remove_actions(e);for(var r=tr.get_all_objects("ALL",tr.DATA_ID_ALL),a=0;a<r.length;a++){var n=r[a];rr.get_object_data_id(n)!=e&&tr.obj_switch_cleanup_flags(n,!1,!1,!1)}for(a=(r=tr.get_all_objects("ALL",e)).length-1;a>=0;a--)Ct(n=r[a]),tr.remove_object(n);for(r=tr.get_all_objects("ALL",tr.DATA_ID_ALL),a=0;a<r.length;a++)tr.obj_switch_cleanup_flags(r[a],!0,!0,!0)}Qt.cleanup(e),St()}else nr.error("Unable to unload data!")},t.prepare_object_unloading=Ct,t.set_debug_resources_root=function(e){Mr=e},t.activate_media=function(){jr||Er.media_auto_activation||(fr.play(),fr.pause(),fr.reset(),_t(Ir,tr.DATA_ID_ALL,!0),lr.pause(),Er.init_wa_context_hack&&lr.play_empty_sound(),jr=!0)},t.reset=function(){Vr=null},t.prefetch=function(e,t,a){var n={load_main:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:[],is_resource:!1,relative_size:500,primary_only:!1,cb_before:_},load_binaries:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:["load_main"],is_resource:!1,relative_size:500,primary_only:!1,cb_before:u},load_images:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:["load_main"],is_resource:!1,relative_size:500,primary_only:!1,cb_before:Xe},preload_sounds:{priority:Xt.ASYNC_PRIORITY,background_loading:!1,inputs:["load_main"],is_resource:!1,relative_size:500,primary_only:!1,cb_before:le}},s=Xt.get_scheduler();return s||(s=Xt.create_scheduler(),kr={},Nr={},Sr={}),kr[s.threads.length]={},Xt.create_thread(n,e,t,a,r,!1,Er.do_not_load_resources,!1,!0)},t.unfetch=function(){Bt.clear_cache()}}),ce=o("__container",function(e,t){function r(){return k}function a(){return N}function n(){return M}function _(e,t){L.offset_left=e,L.offset_top=t}function s(){var e=k.getBoundingClientRect();_(e.left,e.top)}function o(e,t,r,a){if(T.ie11_edge_mouseoffset_hack){var n=r.getBoundingClientRect();a[0]=e-n.left,a[1]=t-n.top}else{S.clientX=e,S.clientY=t,S.view=window;var _=new MouseEvent("b4w_convert",S);r.dispatchEvent(_),a[0]=_.offsetX,a[1]=_.offsetY}return a}function i(e,t,r,a){e.style.width=r+"px",e.style.height=a+"px",t&&(t.style.width=r+"px",t.style.height=a+"px")}function l(e,t,n){var _=r(),s=a();n&&i(_,s,e,t),s&&(s.width=e,s.height=t,f.update_dim());var o=Math.floor(e*T.canvas_resolution_factor),l=Math.floor(t*T.canvas_resolution_factor);_.width=o,_.height=l;var u=Math.min(R.drawingBufferWidth,O.max_renderbuffer_size,O.max_viewport_dims[0]),m=Math.min(R.drawingBufferHeight,O.max_renderbuffer_size,O.max_viewport_dims[1]);if(o>u||l>m){p.warn("Canvas size exceeds platform limits, downscaling");var h=Math.min(u/o,u/l);o*=h,l*=h}if(e)b=o/e;else var b=1;_.width=Math.floor(o),_.height=Math.floor(l),v.setup_dim(_.width,_.height,b),v.check_active()&&E.update_transform(v.get_active()._camera),d.update_media_controls(_.width,_.height),d.is_primary_loaded()&&(c.update(),v.update(y.get_timeline(),0),c.update_visibility())}var c=se(e),u=g(e),d=le(e),f=I(e),p=m(e),v=j(e),b=A(e),y=x(e),E=Y(e),w=h(e),T=u.defaults,O=u.context_limits,R=null,k=null,N=null,M=null,S={clientX:0,clientY:0},L={width:0,height:0,scale:1,offset_top:0,offset_left:0};t.setup_context=function(e){R=e},t.get_canvas=r,t.get_canvas_hud=a,t.get_container=n,t.init=function(e,t){e&&e.parentNode?(k=e,N=t,M=e.parentNode):w.panic("canvas container is not available")},t.insert_to_container=function(e,t){switch(t=t||"LAST"){case"FIRST":var r=M.firstElementChild;M.insertBefore(e,r);break;case"JUST_BEFORE_CANVAS":M.insertBefore(e,k);break;case"JUST_AFTER_CANVAS":k.nextElementSibling?M.insertBefore(e,k.nextElementSibling):M.appendChild(e,k);break;case"LAST":M.appendChild(e,k);break;default:p.error(t+" invalid stack order")}},t.get_viewport_width=function(){return L.width},t.get_viewport_height=function(){return L.height},t.set_canvas_offsets=_,t.update_canvas_offsets=s,t.setup_viewport_dim=function(e,t,r){L.width=e,L.height=t,L.scale=r,s()},t.force_offsets_updating=function(){},t.client_to_canvas_coords=function(e,t,r){return o(e,t,k,r)},t.get_coords_target_space=function(e,t,r){if(e.constructor==MouseEvent)r[0]=e.offsetX,r[1]=e.offsetY;else if(e.constructor==TouchEvent){if("touchend"==e.type)a=e.changedTouches;else var a=t?e.targetTouches:e.touches;o(a[0].clientX,a[0].clientY,e.target,r)}else r[0]=-1,r[1]=-1;return r},t.client_to_element_coords=o,t.canvas_to_viewport_coords=function(e,t,r,a){if(r||(r=new Float32Array(2)),r[0]=e*L.scale,r[1]=t*L.scale,a){var n=a.width/L.width;r[0]*=n,r[1]*=n}return r},t.viewport_to_canvas_coords=function(e,t,r,a){if(r||(r=new Float32Array(2)),r[0]=e/L.scale,r[1]=t/L.scale,a){var n=a.width/L.width;r[0]/=n,r[1]/=n}return r},t.is_child=function(e){return!(!e||!e.parentNode)&&(e.parentNode==M||t.is_child(e.parentNode))},t.is_hidpi=function(){return!!(T.allow_hidpi&&window.devicePixelRatio>=2)},t.find_script=function(e){for(var t=document.getElementsByTagName("script"),r=w.normpath_preserve_protocol(e),a=0;a<t.length;a++)if(t[a].src==r)return t[a];return null},t.resize=l,t.resize_to_container=function(e){var t=n(),_=r(),s=t.clientWidth,o=t.clientHeight;if(e||s!=_.clientWidth||o!=_.clientHeight){var c=_.width,u=_.height;if(i(r(),a(),s,o),v.check_active()){var d=v.get_active(),f=v.get_subs(d,b.STEREO);if(f&&f.enable_hmd_stereo)return void l(c,u,!1)}l(s,o,!1)}},t.reset=function(){R=null,k=null,N=null,M=null}}),ue=o("__camera",function(e,t){function r(e,r){var a=r.render.move_style,n=e.data,_=null;return a!=t.MS_TARGET_CONTROLS&&a!=t.MS_EYE_CONTROLS||!n.b4w_use_horizontal_clamping||(_={left:n.b4w_rotation_left_limit,right:n.b4w_rotation_right_limit,camera_space:"LOCAL"==n.b4w_horizontal_clamping_type},a==t.MS_EYE_CONTROLS&&(_.left*=-1,_.right*=-1)),_}function a(e,r){var a=r.render.move_style,n=e.data,_=null;return a!=t.MS_TARGET_CONTROLS&&a!=t.MS_EYE_CONTROLS||!n.b4w_use_vertical_clamping?a==t.MS_HOVER_CONTROLS&&n.b4w_use_zooming&&(n.b4w_hover_angle_min<=n.b4w_hover_angle_max?((_={down:n.b4w_hover_angle_min,up:n.b4w_hover_angle_max}).down*=-1,_.up*=-1):We.error("Wrong angle limits for the HOVER camera. Disabling angle limits.")):(_={down:n.b4w_rotation_down_limit,up:n.b4w_rotation_up_limit,camera_space:"LOCAL"==n.b4w_vertical_clamping_type},a==t.MS_TARGET_CONTROLS&&(_.down*=-1,_.up*=-1)),_}function n(e,r){var a=r.render.move_style,n=e.data,_=null;return a==t.MS_TARGET_CONTROLS&&n.b4w_use_target_distance_limits&&n.b4w_distance_min<=n.b4w_distance_max?_={min:n.b4w_distance_min,max:n.b4w_distance_max}:a===t.MS_HOVER_CONTROLS&&n.b4w_use_zooming&&(n.b4w_distance_min<=n.b4w_distance_max?_={min:n.b4w_distance_min,max:n.b4w_distance_max}:We.error("Wrong distance limits for the HOVER camera. Disabling distance limits.")),_}function _(e,r){var a=r.render.move_style,n=e.data,_=null;return a==t.MS_HOVER_CONTROLS&&n.b4w_use_horizontal_clamping&&n.b4w_horizontal_translation_min<=n.b4w_horizontal_translation_max&&(_={min:n.b4w_horizontal_translation_min,max:n.b4w_horizontal_translation_max}),_}function s(e,r){var a=r.render.move_style,n=e.data,_=null;return a==t.MS_HOVER_CONTROLS&&n.b4w_use_vertical_clamping&&n.b4w_vertical_translation_min<=n.b4w_vertical_translation_max&&(_={min:n.b4w_vertical_translation_min,max:n.b4w_vertical_translation_max}),_}function o(e,r){var a=r.render.move_style,n=e.data,_=null;return a==t.MS_TARGET_CONTROLS&&n.b4w_use_pivot_limits&&(_={min_z:n.b4w_pivot_z_min,max_z:n.b4w_pivot_z_max}),_}function u(e,t,r,a,n){Ke.set_translation(e,t),r&&H(e,t,r),K(e,a),Q(e,n)}function p(e,t,r,a,n,_,s,o){var i=e.render;Ke.set_translation(e,t),i.pivot.set(r),H(e,t,r),K(e,a),Q(e,n),te(e,_),re(e,s),i.use_panning=o}function g(e,t,r,a,n,_,s,o){var i=e.render;Ke.set_translation(e,t),i.hover_pivot.set(r),H(e,t,r),ee(e,a),J(e,n),ae(e,_),ne(e,s),i.enable_hover_hor_rotation=o}function y(e,t,r){var a=e.render,n=Ze.get_trans_view(a.world_tsr),_=Ze.get_quat_view(a.world_tsr),s=ht;s.set(Qe.AXIS_Z),s[3]=0;var o=I(e,it)[1],i=Qe.quat_to_dir(_,Qe.AXIS_MZ,ut);return Ye.set_pline_initial_point(yt,n),Ye.set_pline_directional_vec(yt,i),(!Qe.line_plane_intersect(s,-t,yt,r)||Math.abs(o)<nt)&&(We.warn("Active hover camera view vector and the supporting plane are parallel to each other. Hover pivot will be set based on the camera position."),r[0]=n[0],r[1]=n[1],r[2]=0),r}function E(e){for(var r=e.render,a=0;a<e.scenes_data.length;a++){var n=e.scenes_data[a].cameras[0];if(n.type==t.TYPE_ORTHO)switch(r.move_style){case t.MS_TARGET_CONTROLS:_=Ze.get_trans_view(r.world_tsr),r.init_dist=Je.dist(_,r.pivot),r.init_fov=n.fov;break;case t.MS_HOVER_CONTROLS:var _=Ze.get_trans_view(r.world_tsr);r.init_dist=Je.dist(_,r.hover_pivot),r.init_fov=n.fov}}}function w(e){var t={type:e,name:"",size_mult:1,width:0,height:0,framebuffer:null,framebuffer_prev:null,color_attachment:null,depth_attachment:null,aspect:0,fov:0,fit:"VERTICAL",near:0,far:0,left:0,right:0,top:0,bottom:0,hmd_fov:$e.create(),world_tsr:new Float32Array(9),view_matrix:new Float32Array(16),view_refl_matrix:new Float32Array(16),view_transform_params:{trans:Je.create(),angle:0},proj_matrix:new Float32Array(16),view_proj_matrix:new Float32Array(16),view_proj_inv_matrix:new Float32Array(16),prev_view_proj_matrix:new Float32Array(16),sky_vp_inv_matrix:new Float32Array(16),direction:new Float32Array(3),view_tsr:Ze.create_ext(),view_tsr_inv:Ze.create_ext(),real_view_tsr:Ze.create_ext(),real_view_tsr_inv:Ze.create_ext(),shadow_cast_billboard_view_tsr:Ze.create_ext(),dof_distance:0,dof_front_start:0,dof_front_end:0,dof_rear_start:0,dof_rear_end:0,dof_power:0,dof_bokeh_intensity:0,dof_object:null,dof_bokeh:!1,dof_foreground_blur:!1,dof_on:!1,lod_eye:new Float32Array(3),frustum_planes:x(),stereo_conv_dist:0,stereo_eye_dist:0,reflection_plane:null,csm_centers:null,csm_radii:null,csm_center_dists:new Float32Array(4),pcf_blur_radii:new Float32Array(4)};return t.hmd_fov[0]=t.hmd_fov[2]=0,t.hmd_fov[1]=t.hmd_fov[3]=0,t}function T(e,t){var r=w(e.type);return r.name=e.name,r.size_mult=e.size_mult,r.width=e.width,r.height=e.height,t||(r.framebuffer=e.framebuffer,r.framebuffer_prev=e.framebuffer_prev,r.color_attachment=e.color_attachment,r.depth_attachment=e.depth_attachment),r.aspect=e.aspect,r.fit=e.fit,r.fov=e.fov,r.near=e.near,r.far=e.far,r.left=e.left,r.right=e.right,r.top=e.top,r.bottom=e.bottom,$e.copy(e.hmd_fov,r.hmd_fov),Ze.copy(e.world_tsr,r.world_tsr),ze.copy(e.view_matrix,r.view_matrix),ze.copy(e.view_refl_matrix,r.view_refl_matrix),r.view_transform_params=Qe.clone_object_r(e.view_transform_params),ze.copy(e.proj_matrix,r.proj_matrix),ze.copy(e.view_proj_matrix,r.view_proj_matrix),ze.copy(e.view_proj_inv_matrix,r.view_proj_inv_matrix),ze.copy(e.prev_view_proj_matrix,r.prev_view_proj_matrix),ze.copy(e.sky_vp_inv_matrix,r.sky_vp_inv_matrix),r.direction.set(e.direction),Ze.copy(e.view_tsr,r.view_tsr),Ze.copy(e.view_tsr_inv,r.view_tsr_inv),Ze.copy(e.real_view_tsr,r.real_view_tsr),Ze.copy(e.real_view_tsr_inv,r.real_view_tsr_inv),Ze.copy(e.shadow_cast_billboard_view_tsr,r.shadow_cast_billboard_view_tsr),r.dof_distance=e.dof_distance,r.dof_front_start=e.dof_front_start,r.dof_front_end=e.dof_front_end,r.dof_rear_start=e.dof_rear_start,r.dof_rear_end=e.dof_rear_end,r.dof_power=e.dof_power,r.dof_bokeh_intensity=e.dof_bokeh_intensity,r.dof_object=e.dof_object,r.dof_bokeh=e.dof_bokeh,r.dof_foreground_blur=e.dof_foreground_blur,r.dof_on=e.dof_on,Je.copy(e.lod_eye,r.lod_eye),O(e.frustum_planes,r.frustum_planes),r.stereo_conv_dist=e.stereo_conv_dist,r.stereo_eye_dist=e.stereo_eye_dist,e.reflection_plane&&(r.reflection_plane=$e.clone(e.reflection_plane)),Pe(e,r),$e.copy(e.csm_center_dists,r.csm_center_dists),$e.copy(e.pcf_blur_radii,r.pcf_blur_radii),r}function x(){return{left:new Float32Array([0,0,0,0]),right:new Float32Array([0,0,0,0]),top:new Float32Array([0,0,0,0]),bottom:new Float32Array([0,0,0,0]),near:new Float32Array([0,0,0,0]),far:new Float32Array([0,0,0,0])}}function O(e,t){return $e.copy(e.left,t.left),$e.copy(e.right,t.right),$e.copy(e.top,t.top),$e.copy(e.bottom,t.bottom),$e.copy(e.near,t.near),$e.copy(e.far,t.far),t}function R(e){switch(e){case"STATIC":return t.MS_STATIC;case"TARGET":return t.MS_TARGET_CONTROLS;case"EYE":return t.MS_EYE_CONTROLS;case"HOVER":return t.MS_HOVER_CONTROLS;default:Qe.panic("Unknown move style")}}function N(e){var r=w(e);if(e==t.TYPE_NONE)return r;switch(e){case t.TYPE_PERSP:P(r,tt,rt,at);break;case t.TYPE_ORTHO:P(r,et,rt,at);break;case t.TYPE_PERSP_ASPECT:case t.TYPE_ORTHO_ASPECT:case t.TYPE_ORTHO_ASYMMETRIC:break;case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:case t.TYPE_HMD_LEFT:case t.TYPE_HMD_RIGHT:Qe.panic("Stereo camera may only be created from perspective one");break;default:Qe.panic("Unknown camera type")}return r}function M(e,r,a){if(e.type!=t.TYPE_STEREO_LEFT&&e.type!=t.TYPE_STEREO_RIGHT&&e.type!=t.TYPE_HMD_LEFT&&e.type!=t.TYPE_HMD_RIGHT&&Qe.panic("set_stereo_params(): wrong camera type"),e.type!=t.TYPE_STEREO_LEFT&&e.type!=t.TYPE_STEREO_RIGHT||(e.stereo_conv_dist=r),e.stereo_eye_dist=a,Te(e,!1),Ve.check_active()){var n=Ve.get_active(),_=n._render.shadow_params;if(_)for(var s=He.get_scene_data(Ve.get_camera(n),n).cameras,o=0;o<s.length;o++)Se(s[o],_)}}function I(e,t){return S(Ze.get_quat_view(e.render.world_tsr),t)}function S(e,t){var r=Qe.quat_to_dir(e,Qe.AXIS_Z,ut),a=Qe.quat_to_dir(e,Qe.AXIS_MY,dt),n=-Math.asin(r[2]/Je.length(r));if(Math.abs(n)>Math.PI/4)_=Je.scale(a,-Qe.sign(n),ft);else var _=Je.scale(r,-Qe.sign(a[2]),ft);var s=Math.atan(Math.abs(_[0]/_[1])),o=n;a[2]>0&&(o=Qe.sign(o)*Math.PI-o);var i=s;return _[1]>0&&(i=Math.PI-i),_[0]<0&&(i=2*Math.PI-i),t[0]=i,t[1]=o,t}function L(e){switch(e.fit){case"AUTO":return e.aspect>1?Fe(e)?e.fov/e.aspect:2*Math.atan(Math.tan(e.fov/2)/e.aspect):e.fov;case"HORIZONTAL":return Fe(e)?e.fov/e.aspect:2*Math.atan(Math.tan(e.fov/2)/e.aspect);case"VERTICAL":return e.fov}}function C(e){switch(e.fit){case"AUTO":return e.aspect>1?e.fov:Fe(e)?e.fov*e.aspect:2*Math.atan(Math.tan(e.fov/2)*e.aspect);case"HORIZONTAL":return e.fov;case"VERTICAL":return Fe(e)?e.fov*e.aspect:2*Math.atan(Math.tan(e.fov/2)*e.aspect)}}function P(e,r,a,n){switch(e.type){case t.TYPE_PERSP:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:case t.TYPE_ORTHO:e.fov=r,e.aspect=1;break;case t.TYPE_HMD_LEFT:case t.TYPE_HMD_RIGHT:break;default:Qe.panic("set_frustum(): Unsupported camera type: "+e.type)}e.near=a,e.far=n}function D(e,r){var a=Ze.get_trans(r.render.world_tsr,ut),n=Ze.get_quat(r.render.world_tsr,mt),_=ze.fromRotationTranslation(n,a,bt);if(ze.invert(_,e.view_matrix),Ve.check_active())var s=Ve.get_active(),o=Ve.get_subs(s,Xe.STEREO);e.type==t.TYPE_STEREO_LEFT||o&&o.enable_hmd_stereo&&e.type==t.TYPE_HMD_LEFT?e.view_matrix[12]+=e.stereo_eye_dist/2:(e.type==t.TYPE_STEREO_RIGHT||o&&o.enable_hmd_stereo&&e.type==t.TYPE_HMD_RIGHT)&&(e.view_matrix[12]-=e.stereo_eye_dist/2),e.reflection_plane&&(Ze.from_mat4(e.view_matrix,e.real_view_tsr),Ze.invert(e.real_view_tsr,e.real_view_tsr_inv),U(e),F(e),B(e,!0),Je.transformMat4(a,e.view_refl_matrix,a)),Ze.from_mat4(e.view_matrix,e.view_tsr),Ze.invert(e.view_tsr,e.view_tsr_inv),Ze.set_sep(a,1,n,e.world_tsr),ke(e)}function U(e){var t=e.reflection_plane[0],r=e.reflection_plane[1],a=e.reflection_plane[2],n=e.reflection_plane[3],_=e.view_refl_matrix;_[0]=1-2*t*t,_[1]=-2*t*r,_[2]=-2*t*a,_[3]=0,_[4]=-2*t*r,_[5]=1-2*r*r,_[6]=-2*r*a,_[7]=0,_[8]=-2*t*a,_[9]=-2*r*a,_[10]=1-2*a*a,_[11]=0,_[12]=-2*t*n,_[13]=-2*r*n,_[14]=-2*a*n,_[15]=1}function F(e){ze.multiply(e.view_matrix,e.view_refl_matrix,e.view_matrix)}function B(e,t){Te(e,!0);var r=ht,a=bt;ze.invert(e.view_matrix,a),ze.transpose(a,a),$e.transformMat4(e.reflection_plane,a,r);var n=vt;n[0]=(Qe.sign(r[0])+e.proj_matrix[8])/e.proj_matrix[0],n[1]=(Qe.sign(r[1])+e.proj_matrix[9])/e.proj_matrix[5],n[2]=-1,n[3]=(1+e.proj_matrix[10])/e.proj_matrix[14];var _=r[0]*n[0]+r[1]*n[1]+r[2]*n[2]+r[3]*n[3];$e.scale(r,2/_,r),e.proj_matrix[2]=r[0],e.proj_matrix[6]=r[1],e.proj_matrix[10]=r[2]+1,e.proj_matrix[14]=r[3],Re(e),t||ke(e)}function G(e,r,a,n){ze.lookAt(r,a,n,e.view_matrix);var _=Ve.get_active(),s=Ve.get_subs(_,Xe.STEREO);e.type==t.TYPE_STEREO_LEFT||s&&s.enable_hmd_stereo&&e.type==t.TYPE_HMD_LEFT?e.view_matrix[12]+=e.stereo_eye_dist/2:(e.type==t.TYPE_STEREO_RIGHT||s&&s.enable_hmd_stereo&&e.type==t.TYPE_HMD_RIGHT)&&(e.view_matrix[12]-=e.stereo_eye_dist/2),Ze.from_mat4(e.view_matrix,e.view_tsr),Ne(e),Me(e),Ze.set_trans(r,e.world_tsr)}function z(e,t,r){var a=Je.subtract(r,t,ut);if(Je.length(a)){Je.normalize(a,a);var n=Qe.rotation_to_stable(Qe.AXIS_MZ,a,mt);Ke.set_rotation(e,n)}Ke.set_translation(e,t)}function H(e,t,r){var a=e.render,n=X(e);if(z(e,t,r),n){var _=Je.copy(a.vertical_axis,ut);Je.negate(_,_),q(e,_,!0)}else q(e,a.vertical_axis,!0)}function W(e,t){for(var r=e.render,a=t.cameras,n=Ze.get_quat(r.world_tsr,mt),_=Qe.quat_to_dir(n,Qe.AXIS_MZ,ut),s=Ze.get_trans(r.world_tsr,dt),o=t.shadow_cameras,i=0;i<o.length;i++){var l=o[i];Je.copy(_,l.direction),Ze.get_trans(r.world_tsr,l.lod_eye)}for(i=0;i<a.length;i++)if(D(l=a[i],e),Je.copy(_,l.direction),l.dof_object&&l.dof_on){var c=Ke.get_translation(l.dof_object,ft),u=Je.dist(s,c);l.dof_distance=u}}function q(e,r,a){var n=e.render,_=Ze.get_quat_view(n.world_tsr),s=Qe.quat_to_dir(_,Qe.AXIS_Z,ut);if(Je.normalize(s,s),Math.abs(Je.dot(r,s))>.999999)d=qe.identity(mt);else{var o=Je.cross(r,s,dt);if(Je.normalize(o,o),n.move_style==t.MS_TARGET_CONTROLS)n.target_cam_upside_down&&Je.negate(o,o);else{var i=Qe.quat_to_dir(_,Qe.AXIS_MY,ft);Je.dot(i,r)>0&&Je.negate(o,o)}var l=Qe.quat_to_dir(_,Qe.AXIS_X,ft);Je.normalize(l,l);var c=Qe.clamp(Je.dot(l,o),-1,1);if(c<=-.999999)var u=Math.acos(c),d=qe.setAxisAngle(s,u,mt);else d=qe.rotationTo(l,o,mt);qe.normalize(d,d)}if(qe.multiply(d,_,_),a){var f=Qe.quat_to_dir(_,Qe.AXIS_Y,ut);Je.dot(r,f)<0&&qe.rotateZ(_,Math.PI,_)}V(e)}function V(e){var r=e.render;r.move_style==t.MS_TARGET_CONTROLS&&(r.target_cam_upside_down=X(e))}function X(e){var t=Ze.get_quat_view(e.render.world_tsr);return Qe.quat_to_dir(t,Qe.AXIS_Y,ut)[2]<0}function K(e,t){var r=e.render;t?(r.horizontal_limits=r.horizontal_limits||{},r.horizontal_limits.left=t.left,r.horizontal_limits.right=t.right,r.horizontal_limits.left_local=t.left,r.horizontal_limits.right_local=t.right,r.horizontal_limits.camera_space=Boolean(t.camera_space),Z(e)):r.horizontal_limits=null}function Z(e){var r=e.render,a=r.horizontal_limits;if(a&&(r.move_style==t.MS_EYE_CONTROLS||r.move_style==t.MS_TARGET_CONTROLS)){var n=I(e,it);a.camera_space?(a.left+=n[0],a.right+=n[0]):(a.left_local-=n[0],a.right_local-=n[0]),a.left=Qe.angle_wrap_0_2pi(a.left),a.right=Qe.angle_wrap_0_2pi(a.right),a.left_local=Qe.angle_wrap_0_2pi(a.left_local),a.right_local=Qe.angle_wrap_0_2pi(a.right_local)}}function Q(e,t){var r=e.render;t?(r.vertical_limits=r.vertical_limits||{},r.vertical_limits.down=t.down,r.vertical_limits.up=t.up,r.vertical_limits.down_local=t.down,r.vertical_limits.up_local=t.up,r.vertical_limits.camera_space=Boolean(t.camera_space),$(e)):r.vertical_limits=null}function J(e,t){var r=e.render;if(!t){var a=I(e,it);t={down:a[1],up:a[1]}}r.vertical_limits=r.vertical_limits||{},r.vertical_limits.down=t.down,r.vertical_limits.up=t.up,$(e),r.distance_limits&&r.vertical_limits&&be(e)}function $(e){var r=e.render,a=r.vertical_limits;if(a)switch(r.move_style){case t.MS_EYE_CONTROLS:case t.MS_TARGET_CONTROLS:var n=I(e,it);a.camera_space?(a.up+=n[1],a.down+=n[1]):(a.up_local-=n[1],a.down_local-=n[1]),a.up=Qe.angle_wrap_periodic(a.up,-Math.PI,Math.PI),a.down=Qe.angle_wrap_periodic(a.down,-Math.PI,Math.PI),a.up_local=Qe.angle_wrap_periodic(a.up_local,-Math.PI,Math.PI),a.down_local=Qe.angle_wrap_periodic(a.down_local,-Math.PI,Math.PI);break;case t.MS_HOVER_CONTROLS:a.up=Qe.angle_wrap_periodic(a.up,-Math.PI,Math.PI),a.down=Qe.angle_wrap_periodic(a.down,-Math.PI,Math.PI),a.up=Qe.clamp(a.up,-Math.PI/2,0),a.down=Qe.clamp(a.down,-Math.PI/2,0)}}function ee(e,t){var r=e.render;if(!t){var a=Ke.obj_point_distance(e,r.hover_pivot);t={min:a,max:a}}r.distance_limits=r.distance_limits||{},r.distance_limits.min=t.min,r.distance_limits.max=t.max,r.distance_limits&&r.vertical_limits&&be(e)}function te(e,t){var r=e.render;t?(r.distance_limits=r.distance_limits||{},r.distance_limits.min=t.min,r.distance_limits.max=t.max):r.distance_limits=null}function re(e,t){var r=e.render;t?(r.pivot_limits=r.pivot_limits||{},r.pivot_limits.min_z=t.min_z,r.pivot_limits.max_z=t.max_z):r.pivot_limits=null}function ae(e,t){var r=e.render;t?(r.hover_horiz_trans_limits=r.hover_horiz_trans_limits||{},r.hover_horiz_trans_limits.min=t.min,r.hover_horiz_trans_limits.max=t.max):r.hover_horiz_trans_limits=null}function ne(e,t){var r=e.render;t?(r.hover_vert_trans_limits=r.hover_vert_trans_limits||{},r.hover_vert_trans_limits.min=t.min,r.hover_vert_trans_limits.max=t.max):r.hover_vert_trans_limits=null}function _e(e){var r=e.render;if(He.is_camera(e))for(var a=e.scenes_data,n=0;n<a.length;n++){var _=a[n].cameras;if(_[0].type===t.TYPE_ORTHO){switch(r.move_style){case t.MS_TARGET_CONTROLS:var s=Ze.get_trans_view(r.world_tsr),o=(i=Je.dist(s,r.pivot))/r.init_dist*r.init_fov;break;case t.MS_HOVER_CONTROLS:var s=Ze.get_trans_view(r.world_tsr),i=Je.distance(s,r.hover_pivot),o=i/r.init_dist*r.init_fov;break;default:o=_[0].fov}for(var l=0;l<_.length;l++){var c=_[l];c.fov=o,Te(c,!0)}W(e,a[n])}}}function se(e){var r=e.render,a=r.move_style;if(a===t.MS_TARGET_CONTROLS||a===t.MS_EYE_CONTROLS){if(r.horizontal_limits){var n=r.horizontal_limits.left,_=r.horizontal_limits.right,s=I(e,it);(l=a==t.MS_TARGET_CONTROLS?Qe.calc_returning_angle(s[0],n,_):Qe.calc_returning_angle(s[0],_,n))&&(a==t.MS_TARGET_CONTROLS?ie(e,l,0):ue(e,l,0))}if(r.vertical_limits){var o=r.vertical_limits.down,i=r.vertical_limits.up,s=I(e,it);if(a==t.MS_TARGET_CONTROLS)l=Qe.calc_returning_angle(s[1],i,o);else var l=Qe.calc_returning_angle(s[1],o,i);l&&(a==t.MS_TARGET_CONTROLS?ie(e,0,l):ue(e,0,l))}a===t.MS_TARGET_CONTROLS&&r.distance_limits&&ye(e)}a===t.MS_TARGET_CONTROLS&&r.pivot_limits&&Ee(e),a===t.MS_HOVER_CONTROLS&&(we(e),Ae(e))}function oe(e,t,r,a){var n=I(e,ct);return a[0]=t-n[0],a[1]=r-n[1],a}function ie(e,t,r){var a=e.render;ve(e,e.render.pivot,t,r);var n=I(e,lt),_=Qe.angle_wrap_periodic(n[1],-Math.PI,Math.PI);a.target_cam_upside_down=Math.abs(_)>Math.PI/2}function le(e,t,r){var a=oe(e,t,r,lt);ie(e,a[0],a[1])}function ue(e,t,r){fe(e,t,r)}function de(e,t,r){me(e,t,r)}function fe(e,t,r){var a=e.render;if(t||r){var n=qe.identity(mt);if(t){var _=qe.setAxisAngle(a.vertical_axis,t,pt);qe.multiply(n,_,n)}var s=Ze.get_quat_view(a.world_tsr);if(r){var o=Qe.quat_to_dir(s,Qe.AXIS_X,ut),i=qe.setAxisAngle(o,r,pt);qe.normalize(i,i),qe.multiply(n,i,n)}qe.multiply(n,s,s),qe.normalize(s,s)}}function me(e,t,r){var a=e.render,n=S(Ze.get_quat(a.world_tsr,mt),it);fe(e,t-n[0],r-n[1])}function pe(e,t,r){var a=e.render;a.enable_hover_hor_rotation||(t=0),ve(e,a.hover_pivot,t,r),r&&be(e)}function he(e,t,r){var a=oe(e,t,r,lt);pe(e,a[0],a[1])}function ve(e,t,r,a){var n=e.render;if(r||a){var _=qe.identity(mt);if(r){var s=qe.setAxisAngle(Qe.AXIS_Z,r,pt);qe.multiply(_,s,_)}var o=Ze.get_quat_view(n.world_tsr);if(a){var i=Qe.quat_to_dir(o,Qe.AXIS_X,ut),l=qe.setAxisAngle(i,a,pt);qe.normalize(l,l),qe.multiply(_,l,_)}var c=Ze.get_trans_view(n.world_tsr);Qe.rotate_point_pivot(c,t,_,c),qe.multiply(_,o,o),qe.normalize(o,o)}}function be(e){var t=e.render,r=ge(e,I(e,it)[1]),a=Ze.get_trans_view(t.world_tsr),n=Ze.get_quat_view(t.world_tsr),_=Qe.quat_to_dir(n,Qe.AXIS_MZ,ut);Je.normalize(_,_),Je.scale(_,r,_),Je.subtract(t.hover_pivot,_,a)}function ge(e,t){var r=e.render,a=r.vertical_limits,n=r.distance_limits;if(a.down-a.up)_=(a.down-t)/(a.down-a.up),_=Math.max(_,0);else var _=0;return _*(n.max-n.min)+n.min}function ye(e){var t=e.render,r=Ze.get_trans_view(t.world_tsr),a=Je.subtract(r,t.pivot,ut),n=Je.length(a);if(n>t.distance_limits.max){var _=t.distance_limits.max/n;Je.scale(a,_,a),Je.add(t.pivot,a,r)}else if(n<t.distance_limits.min){var s=Ze.get_quat_view(t.world_tsr),o=Qe.quat_to_dir(s,Qe.AXIS_MZ,dt);Je.scale(o,100*t.distance_limits.min,o),Je.add(a,o,a),Je.scale(a,-t.distance_limits.min/Je.length(a),a),Je.add(t.pivot,a,r)}}function Ee(e){var t=e.render,r=t.pivot[2],a=Qe.clamp(t.pivot[2],t.pivot_limits.min_z,t.pivot_limits.max_z);if(a!=r){var n=Je.set(0,0,a-r,ut);Je.add(t.pivot,n,t.pivot);var _=Ze.get_trans_view(t.world_tsr);Je.add(_,n,_)}}function we(e){var t=e.render;if(t.hover_horiz_trans_limits){var r=Qe.clamp(t.hover_pivot[0],t.hover_horiz_trans_limits.min,t.hover_horiz_trans_limits.max)-t.hover_pivot[0];t.hover_pivot[0]+=r,(n=Ze.get_trans_view(t.world_tsr))[0]+=r}if(t.hover_vert_trans_limits){var a=Qe.clamp(t.hover_pivot[1],t.hover_vert_trans_limits.min,t.hover_vert_trans_limits.max)-t.hover_pivot[1];t.hover_pivot[1]+=a;var n=Ze.get_trans_view(t.world_tsr);n[1]+=a}}function Ae(e){var t=e.render,r=I(e,it)[1],a=Qe.calc_returning_angle(r,t.vertical_limits.up,t.vertical_limits.down);a&&pe(e,0,a)}function Te(e,r){switch(e.type){case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:ze.perspective(L(e),e.aspect,e.near,e.far,e.proj_matrix);break;case t.TYPE_ORTHO:case t.TYPE_ORTHO_ASPECT:var a=L(e),n=a*e.aspect;ze.ortho(-n,n,-a,a,e.near,e.far,e.proj_matrix);break;case t.TYPE_ORTHO_ASYMMETRIC:ze.ortho(e.left,e.right,e.bottom,e.top,e.near,e.far,e.proj_matrix);break;case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:xe(e);break;case t.TYPE_HMD_LEFT:case t.TYPE_HMD_RIGHT:Oe(e);break;case t.TYPE_NONE:return;default:Qe.panic("Wrong camera type: "+e.type)}Re(e),r||ke(e)}function xe(e){var r=Math.tan(L(e)/2),a=e.near*r,n=-a,_=e.aspect*e.stereo_conv_dist*r;if(e.type==t.TYPE_STEREO_LEFT)var s=_-e.stereo_eye_dist/2,o=_+e.stereo_eye_dist/2;else var s=_+e.stereo_eye_dist/2,o=_-e.stereo_eye_dist/2;var i=-e.near/e.stereo_conv_dist*s,l=e.near/e.stereo_conv_dist*o;ze.frustum(i,l,n,a,e.near,e.far,e.proj_matrix),e.left=i,e.right=l}function Oe(e){if(Ve.check_active()){var t=Ve.get_active(),r=Ve.get_subs(t,Xe.STEREO);if(r&&r.enable_hmd_stereo){var a=Math.tan(e.hmd_fov[0]),n=Math.tan(e.hmd_fov[1]),_=Math.tan(e.hmd_fov[2]),s=Math.tan(e.hmd_fov[3]);e.top=e.near*a,e.right=e.near*n,e.bottom=-e.near*_,e.left=-e.near*s,ze.frustum(e.left,e.right,e.bottom,e.top,e.near,e.far,e.proj_matrix)}else e.top=e.near*Math.tan(L(e)/2),e.bottom=-e.top,e.right=e.top*e.aspect,e.left=-e.right,ze.perspective(L(e),e.aspect,e.near,e.far,e.proj_matrix)}}function Re(e){ze.translate(e.proj_matrix,e.view_transform_params.trans,e.proj_matrix),ze.rotateZ(e.proj_matrix,e.view_transform_params.angle,e.proj_matrix)}function ke(e){Ne(e),Me(e),Qe.extract_frustum_planes(e.view_proj_matrix,e.frustum_planes)}function Ne(e){ze.copy(e.view_matrix,e.view_proj_matrix),ze.multiply(e.proj_matrix,e.view_proj_matrix,e.view_proj_matrix),ze.invert(e.view_proj_matrix,e.view_proj_inv_matrix)}function Me(e){ze.copy(e.view_matrix,e.sky_vp_inv_matrix),e.sky_vp_inv_matrix[12]=0,e.sky_vp_inv_matrix[13]=0,e.sky_vp_inv_matrix[14]=0,e.sky_vp_inv_matrix[15]=1,ze.multiply(e.proj_matrix,e.sky_vp_inv_matrix,e.sky_vp_inv_matrix),ze.invert(e.sky_vp_inv_matrix,e.sky_vp_inv_matrix)}function Ie(e,r,a,n,_){n||(n=new Float32Array(24)),r||(r=e.near),a||(a=e.far);var s,o,i,l,c,u,d,f;switch(e.type){case t.TYPE_NONE:Qe.panic("Extraction from NONE camera is not possible");break;case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:l=-(s=r*Math.tan(L(e)/2)),i=-(o=s*e.aspect),f=-(c=s*(a/r)),d=-(u=c*e.aspect);break;case t.TYPE_ORTHO:case t.TYPE_ORTHO_ASPECT:var m=L(e),p=m*e.aspect;s=c=m,o=u=p,l=f=-m,i=d=-p;break;case t.TYPE_ORTHO_ASYMMETRIC:s=c=e.top,o=u=e.right,l=f=e.bottom,i=d=e.left;break;case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:h=r/e.near,l=-(s=r*Math.tan(L(e)/2)),f=-(c=s*(v=a/r)),u=(o=e.right*h)*v,d=(i=e.left*h)*v;break;case t.TYPE_HMD_LEFT:case t.TYPE_HMD_RIGHT:var h=r/e.near,v=a/r;c=(s=e.top*h)*v,f=(l=e.bottom*h)*v,u=(o=e.right*h)*v,d=(i=e.left*h)*v;break;default:Qe.panic("Wrong camera type: "+e.type)}if(n[0]=i,n[1]=l,n[2]=-r,n[3]=o,n[4]=l,n[5]=-r,n[6]=o,n[7]=s,n[8]=-r,n[9]=i,n[10]=s,n[11]=-r,n[12]=d,n[13]=f,n[14]=-a,n[15]=d,n[16]=c,n[17]=-a,n[18]=u,n[19]=c,n[20]=-a,n[21]=u,n[22]=f,n[23]=-a,_){var b=bt;ze.invert(e.view_matrix,b),Qe.positions_multiply_matrix(n,b,n,0)}return n}function Se(e,t){t.enable_csm?Le(e,t):e.pcf_blur_radii[0]=t.first_cascade_blur_radius}function Le(e,t){var r=t.csm_num;e.csm_centers||Ce(e,t);for(var a=0;a<r;a++){var n=Ie(e,0==a?e.near:De(t,e,a-1),De(t,e,a),gt),_=Ge.get_frustum_mec(n);e.csm_centers[a].set(_.center),e.csm_radii[a]=_.radius,e.csm_center_dists[a]=Je.length(_.center);var s=t.first_cascade_blur_radius,o=t.last_cascade_blur_radius;e.pcf_blur_radii[a]=Ue(s,o,r,a)}}function Ce(e,t){var r=t.csm_num;e.csm_centers=new Array(r);for(var a=0;a<r;a++)e.csm_centers[a]=new Float32Array(3);e.csm_radii=new Float32Array(r)}function Pe(e,t){if(e.csm_centers){var r=e.csm_centers.length;t.csm_centers=new Array(r);for(var a=0;a<r;a++)t.csm_centers[a]=Je.clone(e.csm_centers[a]);t.csm_radii=new Float32Array(e.csm_radii)}}function De(e,t,r){var a=e.csm_num,n=Ue(Qe.clamp(e.csm_first_cascade_border,t.near,t.far),Qe.clamp(e.csm_last_cascade_border,t.near,t.far),a,r);return Qe.clamp(n,t.near,t.far)}function Ue(e,t,r,a){switch(a){case 0:n=e;break;case r-1:n=t;break;default:var n=0==e?0:e*Math.pow(t/e,a/(r-1))}return n}function Fe(e){switch(e.type){case t.TYPE_ORTHO:case t.TYPE_ORTHO_ASPECT:case t.TYPE_ORTHO_ASYMMETRIC:return!0;default:return!1}}function Be(e,t){t||(t=new Float32Array(3));var r=Ze.get_trans_view(e.render.world_tsr);return Je.copy(r,t),t}var Ge=b(e),je=ce(e),ze=i(e),Ye=f(e),He=k(e),We=m(e),qe=d(e),Ve=j(e),Xe=A(e),Ke=Y(e),Ze=v(e),Qe=h(e),Je=l(e),$e=c(e);t.TYPE_NONE=10,t.TYPE_PERSP=20,t.TYPE_ORTHO=30,t.TYPE_PERSP_ASPECT=40,t.TYPE_ORTHO_ASPECT=50,t.TYPE_ORTHO_ASYMMETRIC=60,t.TYPE_STEREO_LEFT=70,t.TYPE_STEREO_RIGHT=80,t.TYPE_HMD_LEFT=90,t.TYPE_HMD_RIGHT=100,t.MS_STATIC=0,t.MS_TARGET_CONTROLS=2,t.MS_EYE_CONTROLS=3,t.MS_HOVER_CONTROLS=4;var et=2.5,tt=Qe.deg_to_rad(40),rt=.1,at=1e3,nt=Qe.deg_to_rad(.5),_t=new Float32Array([1,1,1,1]),st=new Float32Array([-1,-1,1,1]),ot=new Float32Array([0,0,-1,1]),it=new Float32Array(2),lt=new Float32Array(2),ct=new Float32Array(2),ut=new Float32Array(3),dt=new Float32Array(3),ft=new Float32Array(3),mt=new Float32Array(4),pt=new Float32Array(4),ht=new Float32Array(4),vt=new Float32Array(4),bt=new Float32Array(16),gt=new Float32Array(24),yt=new Float32Array(6);t.camera_object_to_camera=function(e,i){var l=i.render,c=e.data;switch(c.type){case"PERSP":(d=N(t.TYPE_PERSP)).fit=c.sensor_fit,P(d,c.angle,c.clip_start,c.clip_end);break;case"ORTHO":var d=N(t.TYPE_ORTHO);d.fit=c.sensor_fit,P(d,c.ortho_scale/2,c.clip_start,c.clip_end)}d.name=i.name;var f=i.scenes_data;f[0].cameras.push(d);for(var m=1;m<f.length;m++){var h=T(d,!1);f[m].cameras.push(h)}l.move_style=R(c.b4w_move_style),l.dof_distance=c.dof_distance;var v=c.dof_object;l.dof_object=v?v._object:null,l.dof_front_start=c.b4w_dof_front_start,l.dof_front_end=c.b4w_dof_front_end,l.dof_rear_start=c.b4w_dof_rear_start,l.dof_rear_end=c.b4w_dof_rear_end,l.dof_power=c.b4w_dof_power,l.dof_bokeh=c.b4w_dof_bokeh,l.dof_bokeh_intensity=c.b4w_dof_bokeh_intensity,l.dof_foreground_blur=c.b4w_dof_foreground_blur,l.velocity_trans=c.b4w_trans_velocity,l.velocity_rot=c.b4w_rot_velocity,l.velocity_zoom=c.b4w_zoom_velocity;var b=r(e,i),w=a(e,i),A=n(e,i),x=_(e,i),O=s(e,i),k=o(e,i);switch(l.move_style){case t.MS_STATIC:break;case t.MS_EYE_CONTROLS:u(i,M=Ze.get_trans_view(i.render.world_tsr),null,b,w);break;case t.MS_TARGET_CONTROLS:p(i,M=Ze.get_trans_view(i.render.world_tsr),c.b4w_target,b,w,A,k,c.b4w_use_panning);break;case t.MS_HOVER_CONTROLS:var M=Ze.get_trans_view(i.render.world_tsr);g(i,M,y(i,e.data.b4w_hover_zero_level,dt),A,w,x,O,c.b4w_enable_hover_hor_rotation)}se(i),E(i)},t.setup_eye_model=u,t.setup_target_model=p,t.setup_hover_model=g,t.init_ortho_props=E,t.clone_camera=T,t.create_frustum_planes=x,t.move_style_bpy_to_b4w=R,t.create_camera=N,t.check_attachment=function(e,t){switch(t){case"COLOR":case"CUBEMAP":return Boolean(e.color_attachment);case"DEPTH":return Boolean(e.depth_attachment);case"SCREEN":return!Boolean(e.color_attachment)&&!Boolean(e.depth_attachment);default:Qe.panic("Wrong attachment type: "+t)}},t.set_attachment=function(e,t,r){switch(t){case"COLOR":case"CUBEMAP":e.color_attachment=r;break;case"DEPTH":e.depth_attachment=r;break;case"SCREEN":e.color_attachment=null,e.depth_attachment=null;break;default:Qe.panic("Wrong attachment type: "+t)}},t.get_attachment=function(e,t){switch(t){case"COLOR":case"CUBEMAP":return e.color_attachment;case"DEPTH":return e.depth_attachment;case"SCREEN":return null;default:Qe.panic("Wrong attachment type: "+t)}},t.make_stereo=function(e,r){(e.type!=t.TYPE_PERSP||r!=t.TYPE_STEREO_LEFT&&r!=t.TYPE_STEREO_RIGHT&&r!=t.TYPE_HMD_LEFT&&r!=t.TYPE_HMD_RIGHT)&&Qe.panic("make_stereo(): wrong camera type"),e.type=r,M(e,6,.065)},t.set_stereo_params=M,t.get_camera_angles=I,t.get_camera_angles_from_quat=S,t.get_camera_angles_char=function(e,t){return I(e,t),t[0]=Qe.angle_wrap_0_2pi(t[0]+Math.PI),t[1]*=-1,t},t.set_fov=function(e,r){switch(e.type){case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:e.fov=r}},t.get_fov=function(e){switch(e.type){case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:return e.fov;default:return 0}},t.get_vfov=L,t.set_frustum=P,t.set_frustum2=function(e,r,a,n,_){switch(e.type){case t.TYPE_PERSP:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:case t.TYPE_ORTHO:e.fov=a,e.aspect=1;break;case t.TYPE_PERSP_ASPECT:case t.TYPE_ORTHO_ASPECT:e.fov=a,e.aspect=r/a;break;case t.TYPE_HMD_LEFT:case t.TYPE_HMD_RIGHT:break;default:Qe.panic("set_frustum2(): Unsupported camera type: "+e.type)}e.near=n,e.far=_},t.set_frustum_asymmetric=function(e,r,a,n,_,s,o){switch(e.type){case t.TYPE_ORTHO_ASYMMETRIC:e.left=r,e.right=a,e.bottom=n,e.top=_,e.near=s,e.far=o;break;default:Qe.panic("set_frustum_asymmetric(): Unsupported camera type: "+e.type)}},t.get_move_style=function(e){return e.render.move_style},t.set_view=D,t.set_projection_reflect=B,t.set_view_trans_quat=function(e,t,r){var a=ut;a[0]=0,a[1]=0,a[2]=-1,Je.transformQuat(a,r,a),a[0]+=t[0],a[1]+=t[1],a[2]+=t[2];var n=dt;n[0]=0,n[1]=1,n[2]=0,Je.transformQuat(n,r,n),G(e,t,a,n)},t.set_look_at=z,t.set_look_at_corrected=H,t.update_camera_transform=W,t.update_camera=function(e){var r=e.render;switch(se(e),_e(e),r.move_style){case t.MS_TARGET_CONTROLS:var a=Ze.get_trans_view(r.world_tsr),n=Ze.get_quat_view(r.world_tsr);Qe.quat_rotate_to_target(a,n,r.pivot,Qe.AXIS_MZ);for(var _=0;_<e.scenes_data.length;_++)for(var s=e.scenes_data[_].cameras,o=0;o<s.length;o++){var i=s[o];i.type!=t.TYPE_STEREO_LEFT&&i.type!=t.TYPE_STEREO_RIGHT||M(i,Je.dist(a,r.pivot),i.stereo_eye_dist)}q(e,r.vertical_axis);break;case t.MS_EYE_CONTROLS:e.constraint||q(e,r.vertical_axis)}V(e)},t.correct_up=q,t.update_camera_upside_down=V,t.set_horizontal_rot_limits=K,t.set_vertical_rot_limits=Q,t.hover_set_vertical_limits=J,t.hover_set_distance_limits=ee,t.set_distance_limits=te,t.set_pivot_limits=re,t.set_hor_trans_limits=ae,t.set_vert_trans_limits=ne,t.update_ortho_scale=_e,t.rotate_target_angles=ie,t.set_rotation_target_angles=le,t.rotate_eye_angles=ue,t.set_rotation_eye_angles=de,t.rotate_static_angles=fe,t.set_rotation_static_angles=me,t.rotate_hover_angles=pe,t.set_rotation_hover_angles=he,t.rotate_angles=function(e,r,a){var n=e.render.move_style;n===t.MS_TARGET_CONTROLS?ie(e,r,a):n===t.MS_EYE_CONTROLS?ue(e,r,a):n===t.MS_HOVER_CONTROLS?pe(e,r,a):n===t.MS_STATIC&&fe(e,r,a)},t.set_rotation_angles=function(e,r,a){var n=e.render.move_style;n===t.MS_TARGET_CONTROLS?le(e,r,a):n===t.MS_EYE_CONTROLS?de(e,r,a):n===t.MS_HOVER_CONTROLS?he(e,r,a):n===t.MS_STATIC&&me(e,r,a)},t.is_float_aspect=function(e){switch(e.type){case t.TYPE_PERSP:case t.TYPE_ORTHO:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:return!0;default:return!1}},t.get_angular_diameter=function(e){switch(e.type){case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:var r=L(e),a=C(e);return Math.min(r,a);default:return We.error("get_angular_diameter(): Unsupported camera type: "+e.type),0}},t.set_aspect=function(e,r){switch(e.type){case t.TYPE_PERSP_ASPECT:case t.TYPE_ORTHO_ASPECT:We.error("set_aspect(): Unsupported camera type: "+e.type);break;default:e.aspect=r}},t.get_aspect=function(e){return e.aspect},t.set_projection=Te,t.set_color_pick_proj=function(e,r,a,n,_){var s=1/Math.max(_,n);switch(e.type){case t.TYPE_NONE:case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:var o=_/2,i=n/2;a=-(a-o)/o*Math.tan(L(e)/2),r=(r-i)/i*Math.tan(L(e)/2)*e.aspect;var l=e.near*(a+s),c=e.near*(r+s),u=e.near*(a-s),d=e.near*(r-s);ze.frustum(d,c,u,l,e.near,e.far,e.proj_matrix);break;case t.TYPE_ORTHO:case t.TYPE_ORTHO_ASPECT:a=-a/_,d=((r/=n)-s)*((c=(l=L(e))*e.aspect)+c)-c,c=(r+s)*(c+c)-c,u=l+(a-s)*(l+l),l+=(a+s)*(l+l),ze.ortho(d,c,u,l,e.near,e.far,e.proj_matrix);break;case t.TYPE_ORTHO_ASYMMETRIC:a=-a/_,r/=n;var l=e.top+(a+s)*(e.top-e.bottom),c=e.left+(r+s)*(e.right-e.left),u=e.top+(a-s)*(e.top-e.bottom),d=e.left+(r-s)*(e.right-e.left);ze.ortho(d,c,u,l,e.near,e.far,e.proj_matrix)}Re(e),ke(e)},t.calc_sky_vp_inverse=Me,t.extract_frustum_corners=Ie,t.assign_boundings=function(e){var t=e.render,r=Ge.create_bb();r.min_x=-1,r.max_x=1,r.min_y=-1,r.max_y=1,r.min_z=-1,r.max_z=1,t.bb_local=r;var a=Ge.bs_from_values(1,Qe.f32([0,0,0]));t.bs_local=a,t.bcap_local=Ge.bcap_from_values(1,r),t.bcyl_local=Ge.bcyl_from_values(1,r),t.bcon_local=Ge.bcon_from_values(1,r)},t.is_static_camera=function(e){return He.is_camera(e)&&e.render&&e.render.move_style==t.MS_STATIC},t.is_target_camera=function(e){return He.is_camera(e)&&e.render&&e.render.move_style==t.MS_TARGET_CONTROLS},t.is_eye_camera=function(e){return He.is_camera(e)&&e.render&&e.render.move_style==t.MS_EYE_CONTROLS},t.is_hover_camera=function(e){return He.is_camera(e)&&e.render&&e.render.move_style==t.MS_HOVER_CONTROLS},t.is_ortho_camera=function(e){return He.is_camera(e)&&e.render&&e.scenes_data[0].cameras[0].type==t.TYPE_ORTHO},t.update_camera_shadows=Se,t.csm_far_plane=De,t.project_point=function(e,r,a){var n=e.scenes_data[0].cameras[0];switch(n.type){case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:case t.TYPE_ORTHO:case t.TYPE_ORTHO_ASPECT:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:case t.TYPE_HMD_LEFT:case t.TYPE_HMD_RIGHT:case t.TYPE_NONE:var _=ht;_.set(r),_[3]=1;var s=n.view_proj_matrix;$e.transformMat4(_,s,_);var o=_[0]/_[3],i=-_[1]/_[3];return a[0]=(o+1)/2*n.width,a[1]=(i+1)/2*n.height,je.viewport_to_canvas_coords(a[0],a[1],a,n),a.length>2&&(a[2]=(_[2]/Math.abs(_[3])+1)/2),a;default:return We.error("Non-compatible camera"),a}},t.get_first_cam=function(e){return e.scenes_data[0].cameras[0]},t.get_edge=function(e,r){switch(e.type){case t.TYPE_PERSP:case t.TYPE_PERSP_ASPECT:case t.TYPE_STEREO_LEFT:case t.TYPE_STEREO_RIGHT:switch(_=Math.tan(L(e)/2),r){case"LEFT":return-_*e.aspect;case"RIGHT":return _*e.aspect;case"TOP":return _;case"BOTTOM":return-_}break;case t.TYPE_ORTHO:case t.TYPE_ORTHO_ASPECT:switch(r){case"LEFT":return-L(e)*e.aspect;case"RIGHT":return L(e)*e.aspect;case"TOP":return L(e);case"BOTTOM":return-L(e)}break;case t.TYPE_ORTHO_ASYMMETRIC:switch(r){case"LEFT":return e.left;case"RIGHT":return e.right;case"TOP":return e.top;case"BOTTOM":return e.bottom}break;case t.TYPE_HMD_LEFT:case t.TYPE_HMD_RIGHT:var a=Ve.get_active(),n=Ve.get_subs(a,Xe.STEREO);if(n&&n.enable_hmd_stereo)switch(r){case"LEFT":return-Math.tan(Math.min(e.hmd_fov[1],e.hmd_fov[3]));case"RIGHT":return Math.tan(Math.min(e.hmd_fov[1],e.hmd_fov[3]));case"TOP":return Math.tan(Math.min(e.hmd_fov[0],e.hmd_fov[2]));case"BOTTOM":return-Math.tan(Math.min(e.hmd_fov[0],e.hmd_fov[2]))}else{var _=Math.tan(L(e)/2);switch(r){case"LEFT":return-_*e.aspect;case"RIGHT":return _*e.aspect;case"TOP":return _;case"BOTTOM":return-_}}break;default:Qe.panic("Unknown camera type")}},t.is_ortho=Fe,t.set_trans_pivot=function(e,t,r){var a=e.render;Ze.set_trans(t,a.world_tsr),Je.copy(r,a.pivot)},t.set_hover_pivot=function(e,t){var r=e.render,a=Je.subtract(t,r.hover_pivot,ut),n=Ze.get_trans_view(r.world_tsr),_=Je.add(a,n,a);Ke.set_translation(e,_),Je.copy(t,r.hover_pivot)},t.set_target_pivot=function(e,t){var r=e.render,a=Je.subtract(t,r.pivot,ut),n=Ze.get_trans_view(r.world_tsr),_=Je.add(a,n,a);Ke.set_translation(e,_),Je.copy(t,r.pivot)},t.get_eye=Be,t.set_move_style=function(e,r){switch(e.render.move_style=r,e.render.horizontal_limits=null,e.render.vertical_limits=null,e.render.distance_limits=null,e.render.hover_horiz_trans_limits=null,e.render.hover_vert_trans_limits=null,E(e),r){case t.MS_STATIC:case t.MS_EYE_CONTROLS:break;case t.MS_HOVER_CONTROLS:g(e,Ze.get_trans_view(e.render.world_tsr),s=y(e,0,dt),null,null,null,null,e.render.enable_hover_hor_rotation);break;case t.MS_TARGET_CONTROLS:var a=Be(e,ut),n=Ze.get_quat_view(e.render.world_tsr),_=Qe.quat_to_dir(n,Qe.AXIS_MZ,dt),s=Je.scaleAndAdd(a,_,10,_);Je.copy(s,e.render.pivot)}},t.wipe_move_style=function(e){var t=e.render;t.move_style=0,Je.set(0,0,0,t.pivot),Je.set(0,0,0,t.hover_pivot),t.target_cam_upside_down=!1,t.use_panning=!1,t.horizontal_limits=null,t.vertical_limits=null,t.distance_limits=null,t.hover_horiz_trans_limits=null,t.hover_vert_trans_limits=null,t.pivot_limits=null,t.enable_hover_hor_rotation=!0},t.set_eye_distance=function(e,t){for(var r=0;r<e.length;r++){var a=e[r];70!=a.type&&80!=a.type&&90!=a.type&&100!=a.type||M(a,a.stereo_conv_dist,t)}},t.set_hmd_fov=function(e,t,r){for(var a=Ve.get_active(),n=He.get_scene_data(e,a).cameras,_=0;_<n.length;_++){var s=n[_];90!=s.type&&100!=s.type||(90==s.type&&$e.copy(t,s.hmd_fov),100==s.type&&$e.copy(r,s.hmd_fov),s.reflection_plane?B(s,!1):Te(s,!1))}},t.set_hmd_proj_mat=function(e,t,r){for(var a=Ve.get_active(),n=He.get_scene_data(e,a).cameras,_=0;_<n.length;_++){var s=n[_];90!=s.type&&100!=s.type||(90==s.type&&t&&ze.copy(t,s.proj_matrix),100==s.type&&r&&ze.copy(r,s.proj_matrix),Re(s),ke(s))}},t.set_proj_mat=function(e,r){for(var a,n,_,s,o,i,l,c,u=Ve.get_active(),d=He.get_scene_data(e,u).cameras,f=0;f<d.length;f++)if((b=d[f]).type==t.TYPE_NONE&&b.near||b.type==t.TYPE_PERSP||b.type==t.TYPE_PERSP_ASPECT){a=b.near,n=b.far;var m=ze.invert(r,bt),p=$e.transformMat4(_t,m,ht);_=p[0]*a,s=p[1]*a;var h=$e.transformMat4(st,m,ht);o=h[0]*a,i=h[1]*a;var v=$e.transformMat4(ot,m,ht);n=-v[2]*v[3],l=ze.frustum(o,_,i,s,a,n,bt),c=(_-o)/(s-i);break}for(f=0;f<d.length;f++){var b=d[f];b.type!=t.TYPE_NONE&&b.type!=t.TYPE_PERSP&&b.type!=t.TYPE_PERSP_ASPECT||(b.far=n,b.near=a,b.right=_,b.top=s,b.left=o,b.bottom=i,b.aspect=c,b.fov=Math.atan(s/a)-Math.atan(i/a),ze.copy(l,b.proj_matrix),Re(b),ke(b))}}}),de=o("camera",function(e,t){function r(e,t){if(!s.is_camera(e))return i.error("get_view_vector(): Wrong camera object"),null;t=t||new Float32Array(3);var r=b.get_quat_view(e.render.world_tsr);return g.quat_to_dir(r,g.AXIS_MZ,t),t}var a=ue(e),n=ce(e),_=f(e),s=k(e),o=W(e),i=m(e),u=j(e),p=Y(e),b=v(e),g=h(e),y=l(e),E=c(e),w=d(e),A=new Float32Array(2),T=new Float32Array(3),x=new Float32Array(3),O=new Float32Array(4),R=w.create(),N={},M={};t.MS_STATIC=a.MS_STATIC,t.MS_TARGET_CONTROLS=a.MS_TARGET_CONTROLS,t.MS_EYE_CONTROLS=a.MS_EYE_CONTROLS,t.MS_HOVER_CONTROLS=a.MS_HOVER_CONTROLS,t.static_setup=function(e,t){if(s.is_camera(e)){if(a.wipe_move_style(e),e.render.move_style=a.MS_STATIC,t){var r=t.pos||b.get_trans_view(e.render.world_tsr);t.look_at?a.set_look_at(e,r,t.look_at):p.set_translation(e,r)}p.update_transform(e),o.sync_transform(e),a.init_ortho_props(e)}else i.error("static_setup(): Wrong camera object")},t.static_set_look_at=function(e,t,r){a.is_static_camera(e)?(t=t||b.get_trans_view(e.render.world_tsr),r?a.set_look_at(e,t,r):p.set_translation(e,t),p.update_transform(e),o.sync_transform(e)):i.error("static_set_look_at(): Wrong camera object or camera move style")},t.static_set_rotation=function(e,t){a.is_static_camera(e)?(p.set_rotation(e,t),p.update_transform(e),o.sync_transform(e)):i.error("static_set_rotation(): Wrong camera object or camera move style")},t.static_get_rotation=function(e,t){return a.is_static_camera(e)?(t=t||new Float32Array(4),p.get_rotation(e,t)):(i.error("static_get_rotation(): Wrong camera object or camera move style"),null)},t.eye_setup=function(e,t){if(s.is_camera(e))if(!t||!t.horiz_rot_lim||"number"==typeof t.horiz_rot_lim.left&&"number"==typeof t.horiz_rot_lim.right)if(!t||!t.vert_rot_lim||"number"==typeof t.vert_rot_lim.down&&"number"==typeof t.vert_rot_lim.up){if(a.wipe_move_style(e),e.render.move_style=a.MS_EYE_CONTROLS,t){var r=t.pos||b.get_trans_view(e.render.world_tsr);a.setup_eye_model(e,r,t.look_at,t.horiz_rot_lim,t.vert_rot_lim)}p.update_transform(e),o.sync_transform(e),a.init_ortho_props(e)}else i.error("eye_setup(): Wrong vertical limits object.");else i.error("eye_setup(): Wrong horizontal limits object.");else i.error("eye_setup(): Wrong camera object")},t.eye_set_look_at=function(e,t,r){a.is_eye_camera(e)?(t=t||b.get_trans_view(e.render.world_tsr),r?a.set_look_at_corrected(e,t,r):p.set_translation(e,t),a.correct_up(e,e.render.vertical_axis,!0),p.update_transform(e),o.sync_transform(e)):i.error("eye_set_look_at(): Wrong camera object or camera move style")},t.eye_rotate=function(e,r,n,_){i.error_deprecated("eye_rotate","rotate_camera"),a.is_eye_camera(e)?(_=_||!1,t.rotate_camera(e,r,n,_)):i.error("eye_rotate(): Wrong camera object or camera move style")},t.eye_set_vertical_limits=function(e,t){a.is_eye_camera(e)?!t||"number"==typeof t.down&&"number"==typeof t.up?(a.set_vertical_rot_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("eye_set_vertical_limits(): Incorrect limits object."):i.error("eye_set_vertical_limits(): Wrong camera object or camera move style")},t.eye_get_vertical_limits=function(e,t,r){if(!a.is_eye_camera(e))return i.error("eye_get_vertical_limits(): Wrong camera object or camera move style"),null;var n=e.render;return n.vertical_limits?(t=t||{},r?(t.down=n.vertical_limits.down_local,t.up=n.vertical_limits.up_local):(t.down=n.vertical_limits.down,t.up=n.vertical_limits.up),t.camera_space=r||!1,t):null},t.eye_set_horizontal_limits=function(e,t){a.is_eye_camera(e)?!t||"number"==typeof t.left&&"number"==typeof t.right?(a.set_horizontal_rot_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("eye_set_horizontal_limits(): Incorrect limits object."):i.error("eye_set_horizontal_limits(): Wrong camera object or camera move style")},t.eye_get_horizontal_limits=function(e,t,r){if(!a.is_eye_camera(e))return i.error("eye_get_horizontal_limits(): Wrong camera object or camera move style"),null;var n=e.render;return n.horizontal_limits?(t=t||{},r?(t.left=n.horizontal_limits.left_local,t.right=n.horizontal_limits.right_local):(t.left=n.horizontal_limits.left,t.right=n.horizontal_limits.right),t.camera_space=r||!1,t):null},t.target_setup=function(e,t){if(s.is_camera(e))if(!t.horiz_rot_lim||"number"==typeof t.horiz_rot_lim.left&&"number"==typeof t.horiz_rot_lim.right)if(!t.vert_rot_lim||"number"==typeof t.vert_rot_lim.down&&"number"==typeof t.vert_rot_lim.up){if(t.dist_lim){if("number"!=typeof t.dist_lim.min||"number"!=typeof t.dist_lim.max||t.dist_lim.min>t.dist_lim.max)return void i.error("target_setup(): Wrong distance limits object");t.dist_lim.min=Math.max(t.dist_lim.min,0),t.dist_lim.max=Math.max(t.dist_lim.max,0)}if(t.pivot_lim&&("number"!=typeof t.pivot_lim.min_y||"number"!=typeof t.pivot_lim.max_y||t.pivot_lim.min_y>t.pivot_lim.max_y))i.error("target_setup(): Wrong pivot limits object");else{a.wipe_move_style(e),e.render.move_style=a.MS_TARGET_CONTROLS;var n=t.pos||b.get_trans_view(e.render.world_tsr),_=t.pivot;if(!_){var l=r(e,T);_=y.add(n,l,l)}a.setup_target_model(e,n,_,t.horiz_rot_lim,t.vert_rot_lim,t.dist_lim,t.pivot_lim,t.use_panning||!1),p.update_transform(e),o.sync_transform(e),a.init_ortho_props(e)}}else i.error("target_setup(): Wrong vertical limits object");else i.error("target_setup(): Wrong horizontal limits object");else i.error("target_setup(): Wrong camera object")},t.target_rotate=function(e,r,n,_){i.error_deprecated("target_rotate","rotate_camera"),a.is_target_camera(e)?(_=_||!1,t.rotate_camera(e,r,n,_)):i.error("target_rotate(): Wrong camera object or camera move style")},t.target_set_trans_pivot=function(e,t,r){a.is_target_camera(e)?(t=t||b.get_trans_view(e.render.world_tsr),r=r||e.render.pivot,a.set_trans_pivot(e,t,r),p.update_transform(e),o.sync_transform(e)):i.error("target_set_trans_pivot(): Wrong camera object or camera move style")},t.target_set_pivot_translation=function(e,t){a.is_target_camera(e)?(a.set_target_pivot(e,t),p.update_transform(e),o.sync_transform(e)):i.error("target_set_pivot_translation(): Wrong camera object or camera move style")},t.target_set_distance=function(e,t){if(a.is_target_camera(e)){var r=p.obj_point_distance(e,e.render.pivot),n=Math.max(0,t);p.move_local(e,0,0,n-r),p.update_transform(e),o.sync_transform(e)}else i.error("target_set_distance(): Wrong camera object or camera move style")},t.target_get_distance=function(e){return a.is_target_camera(e)?p.obj_point_distance(e,e.render.pivot):(i.error("target_get_distance(): Wrong camera object or camera move style"),0)},t.target_zoom_object=function(e,t){if(a.is_target_camera(e)){var r=p.get_object_center(t,!1,T),n=p.get_object_size(t),_=u.get_active(),l=s.get_scene_data(e,_).cameras[0],c=a.get_angular_diameter(l)/2,d=n/Math.sin(c),f=p.obj_point_distance(e,r);a.set_trans_pivot(e,b.get_trans_view(e.render.world_tsr),r),p.update_transform(e),p.move_local(e,0,0,d-f),p.update_transform(e),o.sync_transform(e)}else i.error("target_zoom_object(): Wrong camera object or camera move style")},t.target_get_pivot=function(e,t){return a.is_target_camera(e)?(t=t||new Float32Array(3),y.copy(e.render.pivot,t),t):(i.error("target_get_pivot(): Wrong camera object or camera move style"),null)},t.target_set_distance_limits=function(e,t){if(a.is_target_camera(e)){if(t){if("number"!=typeof t.min||"number"!=typeof t.max||t.min>t.max)return void i.error("target_set_distance_limits(): Wrong limits object");t.min=Math.max(t.min,0),t.max=Math.max(t.max,0)}a.set_distance_limits(e,t),p.update_transform(e),o.sync_transform(e)}else i.error("target_set_distance_limits(): Wrong camera object or camera move style")},t.target_get_distance_limits=function(e,t){if(!a.is_target_camera(e))return i.error("target_get_distance_limits(): Wrong camera object or camera move style"),null;var r=e.render;return r.distance_limits?(t=t||{},t.min=r.distance_limits.min,t.max=r.distance_limits.max,t):null},t.target_set_vertical_limits=function(e,t){a.is_target_camera(e)?!t||"number"==typeof t.down&&"number"==typeof t.up?(a.set_vertical_rot_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("target_set_vertical_limits(): Wrong limits object"):i.error("target_set_vertical_limits(): Wrong camera object or camera move style")},t.target_get_vertical_limits=function(e,t,r){if(!a.is_target_camera(e))return i.error("target_get_vertical_limits(): Wrong camera object or camera move style"),null;var n=e.render;return n.vertical_limits?(t=t||{},r?(t.down=n.vertical_limits.down_local,t.up=n.vertical_limits.up_local):(t.down=n.vertical_limits.down,t.up=n.vertical_limits.up),t.camera_space=r||!1,t):null},t.target_set_horizontal_limits=function(e,t){a.is_target_camera(e)?!t||"number"==typeof t.left&&"number"==typeof t.right?(a.set_horizontal_rot_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("target_set_horizontal_limits(): Wrong limits object"):i.error("target_set_horizontal_limits(): Wrong camera object or camera move style")},t.target_get_horizontal_limits=function(e,t,r){if(!a.is_target_camera(e))return i.error("target_get_horizontal_limits(): Wrong camera object or camera move style"),null;var n=e.render;return n.horizontal_limits?(t=t||{},r?(t.left=n.horizontal_limits.left_local,t.right=n.horizontal_limits.right_local):(t.left=n.horizontal_limits.left,t.right=n.horizontal_limits.right),t.camera_space=r||!1,t):null},t.target_set_pivot_limits=function(e,t){a.is_target_camera(e)?t&&("number"!=typeof t.min_z||"number"!=typeof t.max_z||t.min_z>t.max_z)?i.error("target_set_pivot_limits(): Wrong limits object"):(a.set_pivot_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("target_set_pivot_limits(): Wrong camera object or camera move style")},t.target_get_pivot_limits=function(e,t){if(!a.is_target_camera(e))return i.error("target_get_pivot_limits(): Wrong camera object or camera move style"),null;var r=e.render;return r.pivot_limits?(t=t||{},t.min_z=r.pivot_limits.min_z,t.max_z=r.pivot_limits.max_z,t):null},t.target_pan_pivot=function(e,t,r){if(a.is_target_camera(e)){var n=e.render;if(n.use_panning){var _=T;_[0]=t,_[1]=-r,_[2]=0,b.transform_dir_vec3(_,n.world_tsr,_),y.add(n.pivot,_,n.pivot);var s=b.get_trans_view(n.world_tsr);y.add(s,_,s),p.update_transform(e),o.sync_transform(e)}}else i.error("target_pan_pivot(): wrong object")},t.target_switch_panning=function(e,t){if(!a.is_target_camera(e))return i.error("target_switch_panning(): Wrong camera object or camera move style"),null;e.render.use_panning=t},t.hover_setup_rel=function(e,r){if(t.hover_setup(e,{pos:r.pos,pivot:r.pivot}),void 0===r.dist_interval)n=0;else var n=Math.max(r.dist_interval,0);if(void 0===r.angle_interval)_=0;else var _=Math.max(r.angle_interval,0);if(void 0===r.t)s=.5;else var s=g.clamp(r.t,0,1);var i=t.hover_get_distance_limits(e,N);i.min=Math.max(i.min-s*n,0),i.max=i.max+(1-s)*n;var l=t.hover_get_vertical_limits(e,M);l.down=g.clamp(l.down+s*_,-Math.PI/2,0),l.up=g.clamp(l.up-(1-s)*_,-Math.PI/2,0),a.hover_set_distance_limits(e,i),a.hover_set_vertical_limits(e,l),p.update_transform(e),o.sync_transform(e),a.init_ortho_props(e)},t.hover_setup=function(e,t){if(s.is_camera(e)){if(t.dist_lim){if("number"!=typeof t.dist_lim.min||"number"!=typeof t.dist_lim.max||t.dist_lim.min>t.dist_lim.max)return void i.error("hover_setup(): Wrong distance limits object");t.dist_lim.min=Math.max(t.dist_lim.min,0),t.dist_lim.max=Math.max(t.dist_lim.max,0)}if(t.hover_angle_lim&&("number"!=typeof t.hover_angle_lim.down||"number"!=typeof t.hover_angle_lim.up||t.hover_angle_lim.down<t.hover_angle_lim.up))i.error("hover_setup(): Wrong hover angle limits object");else if(t.horiz_trans_lim&&("number"!=typeof t.horiz_trans_lim.min||"number"!=typeof t.horiz_trans_lim.max||t.horiz_trans_lim.min>t.horiz_trans_lim.max))i.error("hover_setup(): Wrong horizontal translation limits object");else if(t.vert_trans_lim&&("number"!=typeof t.vert_trans_lim.min||"number"!=typeof t.vert_trans_lim.max||t.vert_trans_lim.min>t.vert_trans_lim.max))i.error("hover_setup(): Wrong vertical translation limits object");else{a.wipe_move_style(e),e.render.move_style=a.MS_HOVER_CONTROLS;var r=t.pos||b.get_trans_view(e.render.world_tsr);a.setup_hover_model(e,r,t.pivot,t.dist_lim,t.hover_angle_lim,t.horiz_trans_lim,t.vert_trans_lim,t.enable_horiz_rot||!1),p.update_transform(e),o.sync_transform(e),a.init_ortho_props(e)}}else i.error("hover_setup(): Wrong camera object")},t.hover_rotate=function(e,r,n,_){i.error_deprecated("hover_rotate","rotate_camera"),a.is_hover_camera(e)?(_=_||!1,t.rotate_camera(e,r,n,_)):i.error("hover_rotate(): Wrong camera object or camera move style")},t.hover_set_pivot_translation=function(e,t){a.is_hover_camera(e)?(a.set_hover_pivot(e,t),p.update_transform(e),o.sync_transform(e)):i.error("hover_set_pivot_translation(): Wrong camera object or camera move style")},t.hover_get_pivot=function(e,t){return a.is_hover_camera(e)?(t=t||new Float32Array(3),y.copy(e.render.hover_pivot,t),t):(i.error("hover_get_pivot(): Wrong camera object or camera move style"),null)},t.hover_get_distance=function(e){return a.is_hover_camera(e)?p.obj_point_distance(e,e.render.hover_pivot):(i.error("hover_get_distance(): Wrong camera object or camera move style"),0)},t.hover_set_vertical_limits=function(e,t){a.is_hover_camera(e)?"number"!=typeof t.down||"number"!=typeof t.up||t.down<t.up?i.error("hover_set_vertical_limits(): Wrong limits object"):(a.hover_set_vertical_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("hover_set_vertical_limits(): Wrong camera object or camera move style")},t.hover_get_vertical_limits=function(e,t){if(!a.is_hover_camera(e))return i.error("hover_get_vertical_limits(): Wrong camera object or camera move style"),null;var r=e.render;return t=t||{},t.down=r.vertical_limits.down,t.up=r.vertical_limits.up,t},t.hover_set_distance_limits=function(e,t){a.is_hover_camera(e)?"number"!=typeof t.min||"number"!=typeof t.max||t.min>t.max?i.error("hover_set_distance_limits(): Wrong limits object"):(t.min=Math.max(t.min,0),t.max=Math.max(t.max,0),a.hover_set_distance_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("hover_set_distance_limits(): Wrong camera object or camera move style")},t.hover_get_distance_limits=function(e,t){if(!a.is_hover_camera(e))return i.error("hover_get_distance_limits(): Wrong camera object or camera move style"),null;var r=e.render;return t=t||{},t.min=r.distance_limits.min,t.max=r.distance_limits.max,t},t.hover_set_vert_trans_limits=function(e,t){a.is_hover_camera(e)?t&&("number"!=typeof t.min||"number"!=typeof t.max||t.min>t.max)?i.error("hover_set_vert_trans_limits(): Wrong limits object"):(a.set_vert_trans_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("hover_set_vert_trans_limits(): Wrong camera object or camera move style")},t.hover_get_vert_trans_limits=function(e,t){if(!a.is_hover_camera(e))return i.error("hover_get_vert_trans_limits(): Wrong camera object or camera move style"),null;var r=e.render;return r.hover_vert_trans_limits?(t=t||{},t.min=r.hover_vert_trans_limits.min,t.max=r.hover_vert_trans_limits.max,t):null},t.hover_set_horiz_trans_limits=function(e,t){a.is_hover_camera(e)?t&&("number"!=typeof t.min||"number"!=typeof t.max||t.min>t.max)?i.error("hover_set_horiz_trans_limits(): Wrong limits object"):(a.set_hor_trans_limits(e,t),p.update_transform(e),o.sync_transform(e)):i.error("hover_set_horiz_trans_limits(): Wrong camera object or camera move style")},t.hover_get_horiz_trans_limits=function(e,t){if(!a.is_hover_camera(e))return i.error("hover_get_horiz_trans_limits(): Wrong camera object or camera move style"),null;var r=e.render;return r.hover_horiz_trans_limits?(t=t||{},t.min=r.hover_horiz_trans_limits.min,t.max=r.hover_horiz_trans_limits.max,t):null},t.hover_switch_horiz_rotation=function(e,t){if(!a.is_hover_camera(e))return i.error("hover_switch_horiz_rotation(): Wrong camera object or camera move style"),null;e.render.enable_hover_hor_rotation=t},t.is_static_camera=a.is_static_camera,t.is_target_camera=a.is_target_camera,t.is_eye_camera=a.is_eye_camera,t.is_hover_camera=a.is_hover_camera,t.get_move_style=function(e){return s.is_camera(e)?a.get_move_style(e):(i.error("get_move_style(): Wrong camera object"),null)},t.set_translation=function(e,t){if(s.is_camera(e)){var r=e.render;if(a.is_target_camera(e)){var n=b.get_trans_view(r.world_tsr),_=y.subtract(t,n,T);y.add(_,r.pivot,r.pivot)}else if(a.is_hover_camera(e)){var n=b.get_trans_view(r.world_tsr),_=y.subtract(t,n,T);y.add(_,r.hover_pivot,r.hover_pivot)}p.set_translation(e,t),p.update_transform(e),o.sync_transform(e)}else i.error("set_translation(): Wrong camera object")},t.get_translation=function(e,t){return s.is_camera(e)?(t=t||new Float32Array(3),p.get_translation(e,t)):(i.error("get_translation(): Wrong camera object"),null)},t.rotate_camera=function(e,t,r,n){s.is_camera(e)?((n=n||!1)?a.set_rotation_angles(e,t,r):a.rotate_angles(e,t,r),p.update_transform(e),o.sync_transform(e)):i.error("rotate_camera(): Wrong camera object")},t.set_velocities=function(e,t){if(s.is_camera(e)){var r=e.render;"number"==typeof t.trans&&(r.velocity_trans=g.clamp(t.trans,0,1/0)),"number"==typeof t.rot&&(r.velocity_rot=g.clamp(t.rot,0,1/0)),"number"==typeof t.zoom&&(r.velocity_zoom=g.clamp(t.zoom,0,.99))}else i.error("set_velocities(): Wrong camera object")},t.get_velocities=function(e,t){if(!s.is_camera(e))return i.error("get_velocities(): Wrong camera object"),null;var r=e.render;return t=t||{},t.trans=r.velocity_trans,t.rot=r.velocity_rot,t.zoom=r.velocity_zoom,t},t.is_look_up=function(e){if(!s.is_camera(e))return i.error("is_look_up(): Wrong camera object"),!1;var t=b.get_quat_view(e.render.world_tsr);return g.quat_to_dir(t,g.AXIS_MZ,T)[1]>=0},t.get_camera_angles=function(e,t){return s.is_camera(e)?(t=t||new Float32Array(2),a.get_camera_angles(e,t),t):(i.error("get_camera_angles(): Wrong camera object"),null)},t.get_camera_angles_char=function(e,t){return s.is_camera(e)?(t=t||new Float32Array(2),a.get_camera_angles_char(e,t),t):(i.error("get_camera_angles_char(): Wrong camera object"),null)},t.get_camera_angles_dir=function(e,t){t=t||new Float32Array(2);var r=y.normalize(e,T),n=g.rotation_to_stable(g.AXIS_MZ,r,R);return g.correct_cam_quat_up(n,!0),a.get_camera_angles_from_quat(n,t),t},t.set_stereo_distance=function(e,t){if(s.is_camera(e))for(var r=u.get_active(),n=s.get_scene_data(e,r).cameras,_=0;_<n.length;_++){var o=n[_];o.type!=a.TYPE_STEREO_LEFT&&o.type!=a.TYPE_STEREO_RIGHT&&o.type!=a.TYPE_HMD_LEFT&&o.type!=a.TYPE_HMD_RIGHT||a.set_stereo_params(o,t,o.stereo_eye_dist)}else i.error("set_stereo_distance(): Wrong camera object")},t.get_stereo_distance=function(e){if(!s.is_camera(e))return i.error("get_stereo_distance(): Wrong camera object"),0;for(var t=u.get_active(),r=s.get_scene_data(e,t).cameras,n=0;n<r.length;n++){var _=r[n];if(_.type==a.TYPE_STEREO_LEFT||_.type==a.TYPE_STEREO_RIGHT)return _.stereo_conv_dist}return 0},t.set_eye_distance=function(e,t){if(s.is_camera(e)){var r=u.get_active(),n=s.get_scene_data(e,r).cameras;a.set_eye_distance(n,t)}else i.error("set_eye_distance(): Wrong camera object")},t.get_eye_distance=function(e){if(!s.is_camera(e))return i.error("get_eye_distance(): Wrong camera object"),0;for(var t=u.get_active(),r=s.get_scene_data(e,t).cameras,n=0;n<r.length;n++){var _=r[n];if(_.type==a.TYPE_STEREO_LEFT||_.type==a.TYPE_STEREO_RIGHT||_.type==a.TYPE_HMD_LEFT||_.type==a.TYPE_HMD_RIGHT)return _.stereo_eye_dist}return 0},t.set_vertical_axis=function(e,t){if(s.is_camera(e)){var r=e.render;y.copy(t,r.vertical_axis),p.update_transform(e),o.sync_transform(e)}else i.error("set_vertical_axis(): Wrong camera object")},t.get_vertical_axis=function(e,t){if(s.is_camera(e)){t||(t=y.create());var r=e.render;return y.copy(r.vertical_axis,t),t}i.error("get_vertical_axis(): Wrong camera object")},t.translate_view=function(e,t,r,n){if(s.is_camera(e))for(var _=u.get_active(),o=s.get_scene_data(e,_).cameras,l=0;l<o.length;l++){var c=o[l];y.set(-t,-r,0,c.view_transform_params.trans),c.reflection_plane?a.set_projection_reflect(c,!1):a.set_projection(c,!1)}else i.error("translate_view(): Wrong camera object")},t.get_view_vector=r,t.get_fov=function(e){if(!s.is_camera(e))return i.error("get_fov(): Wrong camera object"),0;var t=u.get_active(),r=s.get_scene_data(e,t).cameras;return a.get_fov(r[0])},t.set_fov=function(e,t){if(s.is_camera(e))for(var r=u.get_active(),n=s.get_scene_data(e,r).cameras,_=0;_<n.length;_++){var o=n[_];a.set_fov(o,t),o.reflection_plane?a.set_projection_reflect(o,!1):a.set_projection(o,!1)}else i.error("set_fov(): Wrong camera object")},t.set_hmd_fov=function(e,t,r){i.error_once("set_hmd_fov() deprecated")},t.correct_up=function(e,t,r){s.is_camera(e)?(t=t||e.render.vertical_axis,a.correct_up(e,t,r||!1),p.update_transform(e),o.sync_transform(e)):i.error("correct_up(): Wrong camera object")},t.set_ortho_scale=function(e,t){if(s.is_camera(e)&&a.is_ortho_camera(e)){var r=e.render;if(a.is_target_camera(e)){var n=b.get_trans_view(r.world_tsr),_=y.dist(n,r.pivot);r.init_fov=t/2*r.init_dist/_}else if(a.is_hover_camera(e)){var n=b.get_trans_view(r.world_tsr),_=y.distance(n,r.hover_pivot);r.init_fov=t/2*r.init_dist/_}else{var o=u.get_active();s.get_scene_data(e,o).cameras[0].fov=t/2}a.update_ortho_scale(e)}else i.error("set_ortho_scale(): Wrong camera object")},t.get_ortho_scale=function(e){if(!s.is_camera(e)||!a.is_ortho_camera(e))return i.error("get_ortho_scale(): Wrong camera object"),0;var t=u.get_active();return 2*s.get_scene_data(e,t).cameras[0].fov},t.is_ortho_camera=function(e){return s.is_camera(e)?a.is_ortho_camera(e):(i.error("is_ortho_camera(): Wrong camera object"),!1)},t.calc_ray=function(e,t,r,o){if(!s.is_camera(e))return i.error("calc_ray(): Wrong camera object"),null;var l=u.get_active(),c=s.get_scene_data(e,l).cameras[0];switch(o&&3==o.length?i.error_once('dest parameter in the function "calc_ray" should be type of parametric line.'):o=o||new Float32Array(6),c.type){case a.TYPE_PERSP:case a.TYPE_PERSP_ASPECT:case a.TYPE_STEREO_LEFT:case a.TYPE_STEREO_RIGHT:var d=Math.tan(a.get_vfov(c)/2),f=d*c.aspect,m=T,h=n.canvas_to_viewport_coords(t,r,A,c);if(m[0]=(2*h[0]/c.width-1)*f,m[1]=(1-2*h[1]/c.height)*d,m[2]=-1,b.transform_dir_vec3(m,e.render.world_tsr,m),y.normalize(m,m),3==o.length)y.copy(m,o);else{var v=p.get_translation(e,x);_.set_pline_initial_point(o,v),_.set_pline_directional_vec(o,m)}return o;case a.TYPE_ORTHO:var m=T,h=n.canvas_to_viewport_coords(t,r,A,c);m[0]=(2*h[0]/c.width-1)*c.top*c.aspect,m[1]=(1-2*h[1]/c.height)*c.top,m[2]=0,b.transform_vec3(m,e.render.world_tsr,m),y.copy(m,o);var E=b.get_quat_view(e.render.world_tsr,O);return y.transformQuat(g.AXIS_MZ,E,m),_.set_pline_directional_vec(o,m),o;default:return i.error("calc_ray(): Non-compatible camera"),o}},t.project_point=function(e,t,r){return s.is_camera(e)?(r=r||new Float32Array(2),a.project_point(e,t,r)):(i.error("project_point(): Wrong camera object"),null)},t.has_distance_limits=function(e){return(a.is_target_camera(e)||a.is_hover_camera(e))&&null!==e.render.distance_limits},t.has_vertical_rot_limits=function(e){return(a.is_eye_camera(e)||a.is_target_camera(e)||a.is_hover_camera(e))&&null!==e.render.vertical_limits},t.has_horizontal_rot_limits=function(e){return(a.is_target_camera(e)||a.is_eye_camera(e))&&null!==e.render.horizontal_limits},t.has_vertical_trans_limits=function(e){return a.is_hover_camera(e)&&null!==e.render.hover_vert_trans_limits},t.has_horizontal_trans_limits=function(e){return a.is_hover_camera(e)&&null!==e.render.hover_horiz_trans_limits},t.get_frustum_planes=function(e,t){if(!s.is_camera(e))return i.error("get_frustum_planes(): Wrong camera object"),null;var r=u.get_active(),a=s.get_scene_data(e,r).cameras[0].frustum_planes;return E.copy(a.left,t.left),E.copy(a.right,t.right),E.copy(a.top,t.top),E.copy(a.bottom,t.bottom),E.copy(a.near,t.near),E.copy(a.far,t.far),t},t.set_projection=function(e,t){s.is_camera(e)?a.set_proj_mat(e,t):i.error("set_projection(): Wrong camera object")}}),fe=o("config",function(e,t){var r=g(e),a=re(e),n=ae(e),_=le(e),s=m(e);t.P_LOW=r.P_LOW,t.P_HIGH=r.P_HIGH,t.P_ULTRA=r.P_ULTRA,t.P_CUSTOM=r.P_CUSTOM,t.P_AUTO=r.P_AUTO,t.set=r.set,t.get=r.get,t.reset=r.reset,t.reset_limits=r.reset_limits,t.get_std_assets_path=r.get_assets_path,t.get_assets_path=r.get_assets_path,t.apply_quality=function(e){_.is_primary_loaded()?s.error("Cannot change quality profile after a scene is loaded."):(r.set("quality",e),n.get_gl()&&(r.apply_quality(),a.set_hardware_defaults(n.get_gl(),!1)))}}),me=o("constraints",function(e,t){var r=ue(e),a=z(e),n=k(e),_=W(e),s=m(e),o=Y(e),i=h(e),c=l(e);t.append_stiff=function(e,t,r,i,l){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?(r=r||new Float32Array(3),l=l||1,i=i||[0,0,0,1],t instanceof Array&&2==t.length?a.append_stiff_bone(e,t[0],t[1],r,i,l):a.append_stiff_obj(e,t,r,i,l),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_semi_stiff=function(e,t,r,l,c,u,d,f){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?(c=i.isdef(c)?c:Math.PI/2,u=i.isdef(u)?u:-Math.PI/2,d=i.isdef(d)?d:Math.PI/2,f=i.isdef(f)?f:-Math.PI/2,r=r||new Float32Array(3),l=l?new Float32Array(l):null,a.append_semi_stiff_obj(e,t,r,l,c,u,d,f),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_semi_stiff_cam=function(e,a,n,_,o,i,l,c){s.error_deprecated("append_semi_stiff_cam","append_semi_stiff"),r.is_eye_camera(e)?t.append_semi_stiff(e,a,n,_,o,i,l,c):s.error("append_semi_stiff_cam(): wrong object type, only EYE camera objects can be parented.")},t.append_semi_soft_cam=function(e,a,n,_){s.error_deprecated("append_semi_soft_cam","append_semi_soft"),r.is_eye_camera(e)?t.append_semi_soft(e,a,n,_):s.error("append_semi_soft_cam(): wrong object type, only EYE camera objects can be parented.")},t.append_semi_soft=function(e,t,r,l){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?((!i.isdef(l)||l<0)&&(l=.25),r=r||new Float32Array(3),a.append_semi_soft_obj(e,t,r,l),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_stiff_trans=function(e,t,r){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?(r=r||new Float32Array(3),a.append_stiff_trans_obj(e,t,r),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_copy_loc=function(e,t,r,i,l){if(n.is_dynamic(e))if(a.check_self_applying(e,t))if(a.check_compatibility(e,t)){i=i||!1,r=r||"XYZ",l=l||1;var c=o.get_translation(e,new Float32Array(3)),u=new Float32Array(3);u[0]=-1!=r.indexOf("-X")?-1:-1!=r.indexOf("X")?1:0,u[1]=-1!=r.indexOf("-Y")?-1:-1!=r.indexOf("Y")?1:0,u[2]=-1!=r.indexOf("-Z")?-1:-1!=r.indexOf("Z")?1:0,a.append_copy_loc_obj(e,t,c,u,i,l),o.update_transform(e),_.sync_transform(e)}else s.error("Constraint recursion is forbidden.");else s.error("Can not apply constraint. Object and target must be different.");else s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_copy_trans=function(e,t,r){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?(r=r||1,a.append_copy_trans_obj(e,t,r),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_copy_rot=function(e,t,r,i,l){if(n.is_dynamic(e))if(a.check_self_applying(e,t))if(a.check_compatibility(e,t)){i=i||!1,r=r||"XYZ",l=l||1;var c=new Float32Array(3);c[0]=-1!=r.indexOf("-X")?-1:-1!=r.indexOf("X")?1:0,c[1]=-1!=r.indexOf("-Y")?-1:-1!=r.indexOf("Y")?1:0,c[2]=-1!=r.indexOf("-Z")?-1:-1!=r.indexOf("Z")?1:0,a.append_copy_rot_obj(e,t,c,i,l),o.update_transform(e),_.sync_transform(e)}else s.error("Constraint recursion is forbidden.");else s.error("Can not apply constraint. Object and target must be different.");else s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_stiff_trans_rot=function(e,t,r,i){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?(r=r||new Float32Array(3),i=i?new Float32Array(i):[0,0,0,1],a.append_stiff_trans_rot_obj(e,t,r,i,1),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_track=function(e,t,r,l,u,d){if(n.is_dynamic(e))if(a.check_self_applying(e,t))if(a.check_compatibility(e,t)){var f=i.AXIS_Y;"-Y"==r?f=i.AXIS_MY:"Y"==r?f=i.AXIS_Y:"-X"==r?f=i.AXIS_MX:"X"==r?f=i.AXIS_X:"-Z"==r?f=i.AXIS_MZ:"Z"==r&&(f=i.AXIS_Z);var m=i.AXIS_Z;"X"==l?m=i.AXIS_X:"Y"==l&&(m=i.AXIS_Y),1!=Math.abs(c.dot(f,m))?(d=d||1,u=u||!1,a.append_track_obj(e,t,f,m,u,d),o.update_transform(e),_.sync_transform(e)):s.error("Can not use parallel vectors for track and up axes.")}else s.error("Constraint recursion is forbidden.");else s.error("Can not apply constraint. Object and target must be different.");else s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_follow=function(e,t,r,i){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?(a.append_follow_obj(e,t,r,i),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.append_stiff_viewport=function(e,t,r){n.is_dynamic(e)?a.check_self_applying(e,t)?a.check_compatibility(e,t)?(r=r||{},a.append_stiff_viewport(e,t,r),o.update_transform(e),_.sync_transform(e)):s.error("Constraint recursion is forbidden."):s.error("Can not apply constraint. Object and target must be different."):s.error('Wrong object: "'+e.name+'" is not dynamic.')},t.remove=function(e,t){t=t||!1,e.constraint&&a.remove(e,t),t&&o.update_transform(e)}}),pe=o("container",function(e,t){var r=ce(e),a=m(e);t.get_canvas=r.get_canvas,t.get_canvas_hud=r.get_canvas_hud,t.get_container=r.get_container,t.insert_to_container=function(e,t){2==arguments.length?e&&t&&r.insert_to_container(e,t):a.error("insert_to_container(): two arguments required")},t.set_canvas_offsets=function(e,t){return a.error_once("container.set_canvas_offsets() deprecated. Not needed anymore. Use the container.client_to_canvas_coords method."),r.set_canvas_offsets(e,t)},t.update_canvas_offsets=function(){a.error_once("container.update_canvas_offsets() deprecated. Not needed anymore. Use the container.client_to_canvas_coords method."),r.update_canvas_offsets()},t.client_to_canvas_coords=function(e,t,a){return a||(a=new Float32Array(2)),r.client_to_canvas_coords(e,t,a)},t.client_to_element_coords=function(e,t,a,n){return n||(n=new Float32Array(2)),r.client_to_element_coords(e,t,a,n)},t.get_coords_target_space=function(e,t,a){return a||(a=new Float32Array(2)),r.get_coords_target_space(e,t,a)},t.force_offsets_updating=function(){a.error_once("container.force_offsets_updating() deprecated. Not needed anymore. Use the container.client_to_canvas_coords method."),r.force_offsets_updating()},t.resize=function(e,t,a){r.resize(e,t,a)},t.resize_to_container=function(e){e=e||!1,r.resize_to_container(e)}}),he=o("controls",function(e,t){var r=X(e),a=W(e),n=m(e);t.CT_POSITIVE=r.CT_POSITIVE,t.CT_CONTINUOUS=r.CT_CONTINUOUS,t.CT_TRIGGER=r.CT_TRIGGER,t.CT_SHOT=r.CT_SHOT,t.CT_LEVEL=r.CT_LEVEL,t.CT_CHANGE=r.CT_CHANGE,t.KEY_BACKSPACE=8,t.KEY_TAB=9,t.KEY_ENTER=13,t.KEY_SHIFT=16,t.KEY_CTRL=17,t.KEY_ALT=18,t.KEY_PAUSE=19,t.KEY_CAPSLOCK=20,t.KEY_ESC=27,t.KEY_SPACE=32,t.KEY_LEFT=37,t.KEY_UP=38,t.KEY_RIGHT=39,t.KEY_DOWN=40,t.KEY_1=49,t.KEY_2=50,t.KEY_3=51,t.KEY_4=52,t.KEY_5=53,t.KEY_6=54,t.KEY_7=55,t.KEY_8=56,t.KEY_9=57,t.KEY_A=65,t.KEY_B=66,t.KEY_C=67,t.KEY_D=68,t.KEY_E=69,t.KEY_F=70,t.KEY_G=71,t.KEY_H=72,t.KEY_I=73,t.KEY_J=74,t.KEY_K=75,t.KEY_L=76,t.KEY_M=77,t.KEY_N=78,t.KEY_O=79,t.KEY_P=80,t.KEY_Q=81,t.KEY_R=82,t.KEY_S=83,t.KEY_T=84,t.KEY_U=85,t.KEY_V=86,t.KEY_W=87,t.KEY_X=88,t.KEY_Y=89,t.KEY_Z=90,t.KEY_NUM0=96,t.KEY_NUM1=97,t.KEY_NUM2=98,t.KEY_NUM3=99,t.KEY_NUM4=100,t.KEY_NUM5=101,t.KEY_NUM6=102,t.KEY_NUM7=103,t.KEY_NUM8=104,t.KEY_NUM9=105,t.KEY_MULT=106,t.KEY_ADD=107,t.KEY_SUB=109,t.KEY_DEC_POINT=110,t.KEY_DIV=111,t.KEY_SEMI_COLON=186,t.KEY_EQUAL_SIGN=187,t.KEY_COMMA=188,t.KEY_DASH=189,t.KEY_PERIOD=190,t.KEY_FORWARD_SLASH=191,t.KEY_GRAVE_ACCENT=192,t.KEY_LEFT_SQ_BRACKET=219,t.KEY_BACK_SLASH=220,t.KEY_RIGHT_SQ_BRACKET=221,t.KEY_SINGLE_QUOTE=222,t.PL_SINGLE_TOUCH_MOVE=r.PL_SINGLE_TOUCH_MOVE,t.PL_MULTITOUCH_MOVE_ZOOM=r.PL_MULTITOUCH_MOVE_ZOOM,t.PL_MULTITOUCH_MOVE_PAN=r.PL_MULTITOUCH_MOVE_PAN,t.PL_MULTITOUCH_MOVE_ROTATE=r.PL_MULTITOUCH_MOVE_ROTATE,t.default_AND_logic_fun=r.default_AND_logic_fun,t.default_OR_logic_fun=r.default_OR_logic_fun,t.create_gamepad_btn_sensor=r.create_gamepad_btn_sensor,t.create_gamepad_axis_sensor=r.create_gamepad_axis_sensor,t.create_gamepad_position_sensor=r.create_gamepad_position_sensor,t.create_gamepad_orientation_sensor=r.create_gamepad_orientation_sensor,t.create_custom_sensor=r.create_custom_sensor,t.create_keyboard_sensor=r.create_keyboard_sensor,t.create_collision_sensor=function(e,t,a){return t=t||"ANY",a=a||!1,r.create_collision_sensor(e,t,a)},t.create_collision_impulse_sensor=r.create_collision_impulse_sensor,t.create_ray_sensor=function(e,t,_,s,o,i,l){if(!e||a.obj_has_physics(e))return s=s||"ANY",o=o||!1,i=i||!1,l=l||!1,r.create_ray_sensor(e,t,_,s,o,i,l);n.error_once("No physics for object "+e.name)},t.create_mouse_click_sensor=r.create_mouse_click_sensor,t.create_mouse_wheel_sensor=r.create_mouse_wheel_sensor,t.create_mouse_move_sensor=r.create_mouse_move_sensor,t.create_plock_mouse_sensor=r.create_plock_mouse_sensor,t.create_plock_sensor=r.create_plock_sensor,t.create_touch_move_sensor=r.create_touch_move_sensor,t.create_touch_zoom_sensor=r.create_touch_zoom_sensor,t.create_touch_rotate_sensor=r.create_touch_rotate_sensor,t.create_touch_click_sensor=r.create_touch_click_sensor,t.create_motion_sensor=r.create_motion_sensor,t.create_vertical_velocity_sensor=r.create_vertical_velocity_sensor,t.create_gyro_angles_sensor=r.create_gyro_angles_sensor,t.create_gyro_quat_sensor=r.create_gyro_quat_sensor,t.create_gyro_delta_sensor=r.create_gyro_delta_sensor,t.create_hmd_quat_sensor=r.create_hmd_quat_sensor,t.create_hmd_position_sensor=r.create_hmd_position_sensor,t.create_timer_sensor=function(e,t){return r.create_timer_sensor(e,t||!1)},t.reset_timer_sensor=r.reset_timer_sensor,t.create_elapsed_sensor=r.create_elapsed_sensor,t.create_timeline_sensor=r.create_timeline_sensor,t.create_selection_sensor=function(e,t){return r.create_selection_sensor(e,t||!1)},t.create_callback_sensor=function(e,t){return r.create_callback_sensor(e,t||0)},t.set_custom_sensor=function(e,t){r.sensor_set_value(e,t)},t.get_custom_sensor=function(e){return e.value},t.get_sensor_value=r.get_sensor_value,t.get_sensor_payload=r.get_sensor_payload,t.create_sensor_manifold=function(e,t,a,n,_,s,o){o=void 0===o?null:o,_=_||r.default_AND_logic_fun,r.create_sensor_manifold(e,t,a,n,_,s,o)},t.create_kb_sensor_manifold=function(e,t,a,n,_,s){var o=r.create_keyboard_sensor(n);s=void 0===s?null:s;var i=r.default_AND_logic_fun;r.create_sensor_manifold(e,t,a,[o],i,_,s)},t.check_sensor_manifolds=function(e){return r.check_sensor_manifold(e,null)},t.check_sensor_manifold=r.check_sensor_manifold,t.remove_sensor_manifold=r.remove_sensor_manifold,t.reset=r.reset,t.set_plock_smooth_factor=r.set_plock_smooth_factor}),ve=o("data",function(e,t){var r=le(e),a=oe(e);t.load=r.load,t.unload=function(e){e|=0,r.unload(e)},t.set_debug_resources_root=r.set_debug_resources_root,t.is_primary_loaded=r.is_primary_loaded,t.is_idle=a.is_finished,t.load_and_add_new=r.load,t.cleanup=t.unload,t.activate_media=r.activate_media,t.prefetch=r.prefetch,t.unfetch=r.unfetch}),be=o("debug",function(e,t){function r(e,t,r,a){C.group(q.subs_label(e),a);for(var n=0;n<r.length;n++){var _=r[n],s=_.render;if(s.type==a)for(var o=!1,i=0;i<t.length;i++){for(var l=t[i].bundles,c=0;c<l.length;c++){var u=l[c];if(u.do_render&&u.obj_render==s){"STATIC"==a?C.log_raw(_.origin_name,_):C.log_raw(_.name,_),o=!0;break}}if(o)break}}C.groupEnd()}function a(e,t){var r=R.get_debug_shaders();if(r){var a=r.getTranslatedShaderSource(e),s=r.getTranslatedShaderSource(t);if(b.detect_mobile()){a=a.replace("#version","#version 300 //"),s=s.replace("#version","#version 300 //");var o=_("/analyze_shader/vert_gles",a),i=_("/analyze_shader/frag_gles",s)}else{a=a.replace("#version","#version 400 //"),s=s.replace("#version","#version 400 //");var o=_("/analyze_shader/vert",a),i=_("/analyze_shader/frag",s)}var l=n(o),c=n(i);return{vsrc:O.get_gl().getShaderSource(e),vsrc_trans:a,vout:o,vstats:l,fsrc:O.get_gl().getShaderSource(t),fsrc_trans:s,fout:i,fstats:c}}C.warn("WEBGL_debug_shaders extension not found")}function n(e){var t={};if(!e)return t;for(var r=e.split("\n"),a=0;a<r.length;a++){var n=r[a];-1!=n.search(new RegExp(/^[A-Z.]+ ?/))&&((i=n.split(" ")[0])in t||(t[i]=0),t[i]++)}var _=0,s=0,o=0;for(var i in t)switch(i){case"KIL":case"TEX":case"TXB":case"TXP":case"KIL.F":case"TEX.F":case"TXB.F":case"TXD.F":case"TXL.F":case"TXQ.F":case"TXP.F":s+=t[i],_+=t[i];break;case"ATTRIB":o+=t[i];break;case"ADDRESS":case"PARAM":case"TEMP":case"ALIAS":case"OUTPUT":case"END":break;default:_+=t[i]}return t.ALL_OPS=_,t.TEX_OPS=s,t.ATTRIBS=o,t}function _(e,t){var r=new XMLHttpRequest;if(r.open("POST",e,!1),r.send(t),200==r.status)return r.responseText;throw C.error(r.responseText),"Error POST XHR: "+r.status}function s(e){e.sort(function(e,t){return t.fstats.ALL_OPS-e.fstats.ALL_OPS});for(var t=0;t<e.length;t++){var r=e[t],a=r.fstats,n=r.vstats,_=o(r.cshader);_=_.length?"\t\t("+_.join(", ")+")":"\t\t(NA)",C.groupCollapsed("VERT ->","OPS",n.ALL_OPS,"ATT",n.ATTRIBS,"TEX",n.TEX_OPS,"\t\tFRAG ->","OPS",a.ALL_OPS,"TEX",a.TEX_OPS,_),C.groupCollapsed("directives");for(var s=r.shaders_info.directives.slice().sort(),i=0;i<s.length;i++){var l=s[i];C.log_raw(l[0],l[1])}C.groupEnd(),C.groupCollapsed("node elements");for(var c=r.shaders_info.node_elements,i=0;i<c.length;i++)C.log_raw(c[i]);C.groupEnd(),C.groupCollapsed("vert source"),C.log_raw(r.vsrc),C.groupEnd(),C.groupCollapsed("vert translated source"),C.log_raw(r.vsrc_trans),C.groupEnd();var u=["ALL_OPS","TEX_OPS","ATTRIBS"];C.groupCollapsed("vert ops stats");for(var d in n)-1==u.indexOf(d)&&C.log_raw(d,n[d]);C.groupEnd(),C.groupCollapsed("vert assembly"),C.log_raw(r.vout),C.groupEnd(),C.groupCollapsed("frag source"),C.log_raw(r.fsrc),C.groupEnd(),C.groupCollapsed("frag translated source"),C.log_raw(r.fsrc_trans),C.groupEnd(),C.groupCollapsed("frag ops stats");for(var d in a)-1==u.indexOf(d)&&C.log_raw(d,a[d]);C.groupEnd(),C.groupCollapsed("frag assembly"),C.log_raw(r.fout),C.groupEnd(),C.groupEnd()}}function o(e){for(var t=[],r=U.get_all_scenes(),a=0;a<r.length;a++)for(var n=r[a],_=I.get_scene_objs(n,"MESH",I.DATA_ID_ALL),s=0;s<_.length;s++){var o=_[s],i=S.get_scene_data(o,n);if(i&&i.batches.length)for(var l=i.batches,c=0;c<l.length;c++){var u=l[c];if(u.shader==e)for(var d=0;d<u.material_names.length;d++){var f=u.material_names[d];-1==t.indexOf(f)&&t.push(f)}}}return t}function i(e,t){var r=function(){return pe.push(r),e.apply(e,arguments)};return r}function c(e,t,r,a,n){if(typeof t!=typeof e)throw"debug.eqv: wrong expected data type";if(e.length!=t.length)throw"debug.eqv: wrong expected vector length";r=r||me;for(var _=0;_<e.length;_++){if("number"!=typeof t[_]||isNaN(t[_]))throw"debug.eqv: wrong expected data type";if("number"!=typeof e[_]||isNaN(e[_]))throw"debug.eqv: wrong result data type";if(t[_]>e[_]+r||t[_]<e[_]-r)throw"debug.eqv: wrong result"}u(a,n,"eqv")}function u(e,t,r){if(e=e||"",t=t||"",ge){if(""==e)throw"debug."+r+': no error is expected, but got "'+ve+'"';if(ve!=e)throw"debug."+r+': error "'+e+'" is expected, but got "'+ve+'"'}else if(""!=e)throw"debug."+r+': error "'+e+'" is expected, but got nothing';if(be){if(""==t)throw"debug."+r+': no warning is expected, but got "'+he+'"';if(he!=t)throw"debug."+r+': warning "'+t+'" is expected, but got "'+he+'"'}else if(""!=t)throw"debug."+r+': warning "'+t+'" is expected, but got nothing';be=!1,ge=!1}function d(){de&&(I.obj_switch_cleanup_flags(de,!1,!1,!1),x.prepare_object_unloading(de),I.obj_switch_cleanup_flags(de,!0,!0,!0),I.remove_object(de),de=null)}var f=_e(e),p=g(e),b=re(e),E=X(e),T=ce(e),x=le(e),O=ae(e),R=y(e),N=w(e),M=oe(e),I=$(e),S=k(e),L=W(e),C=m(e),P=te(e),U=j(e),F=G(e),z=D(e),H=B(e),q=A(e),V=ee(e),K=Y(e),Z=v(e),Q=h(e),J=l(e),ne=Z.create(),se=new Float32Array(2),ie=J.create(),ue=J.create(),de=null,fe=p.defaults,me=1e-6,pe=[],he="",ve="",be=!1,ge=!1,ye=!0,Ee=new Uint8Array(4);t.DV_NONE=O.DV_NONE,t.DV_OPAQUE_WIREFRAME=O.DV_OPAQUE_WIREFRAME,t.DV_TRANSPARENT_WIREFRAME=O.DV_TRANSPARENT_WIREFRAME,t.DV_FRONT_BACK_VIEW=O.DV_FRONT_BACK_VIEW,t.DV_BOUNDINGS=O.DV_BOUNDINGS,t.DV_CLUSTERS_VIEW=O.DV_CLUSTERS_VIEW,t.DV_BATCHES_VIEW=O.DV_BATCHES_VIEW,t.DV_RENDER_TIME=O.DV_RENDER_TIME,t.physics_stats=function(){L.debug_workers()},t.physics_id=function(e){C.log("O",L.find_obj_by_body_id(e));var t=L.get_active_scene();if(t)for(var r=t._physics.bundles,a=0;a<r.length;a++){var n=r[a];n.physics.body_id==e&&C.log("B",n)}else C.error("No active physics scene.")},t.visible_objects=function(){for(var e=U.get_active(),t=I.get_scene_objs(e,"MESH",I.DATA_ID_ALL),a=U.subs_array(e,[q.MAIN_OPAQUE,q.MAIN_BLEND,q.MAIN_GLOW]),n=0;n<a.length;n++){var _=a[n],s=_.draw_data;s.length&&(r(_,s,t,"DYNAMIC"),r(_,s,t,"STATIC"))}},t.object_info=function(e){for(var t=U.get_active(),r=I.get_scene_objs(t,"MESH",I.DATA_ID_ALL),a=0;a<r.length;a++){var n=r[a];if(n.name==e){C.log("Object",n);for(var _=U.get_all_subscenes(t),s=0;s<_.length;s++){for(var o=_[s],i=[],l=o.draw_data,c=0;c<l.length;c++)for(var u=l[c].bundles,d=0;d<u.length;d++)u[d].obj_render==n.render&&i.push(u[d]);C.log("Subscene "+o.type,i)}}}},t.objects_stat=function(){var e=U.get_active();C.log("Armatures: "+I.get_scene_objs(e,"ARMATURE",I.DATA_ID_ALL).length),C.log("Cameras: "+I.get_scene_objs(e,"CAMERA",I.DATA_ID_ALL).length),C.log("Curves: "+I.get_scene_objs(e,"CURVE",I.DATA_ID_ALL).length),C.log("Empties: "+I.get_scene_objs(e,"EMPTY",I.DATA_ID_ALL).length),C.log("Lamps: "+I.get_scene_objs(e,"LAMP",I.DATA_ID_ALL).length),C.log("Meshes: "+I.get_scene_objs(e,"MESH",I.DATA_ID_ALL).length),C.log("Speakers: "+I.get_scene_objs(e,"SPEAKER",I.DATA_ID_ALL).length)},t.num_vertices=function(){for(var e=0,t=U.get_active(),r=U.subs_array(t,[q.MAIN_OPAQUE,q.MAIN_BLEND,q.MAIN_GLOW]),a=0;a<r.length;a++)for(var n=r[a].draw_data,_=0;_<n.length;_++)for(var s=n[_].bundles,o=0;o<s.length;o++){var i=s[o].batch;i&&(e+=i.num_vertices)}return e},t.num_triangles=function(){for(var e=0,t=U.get_active(),r=U.subs_array(t,[q.MAIN_OPAQUE,q.MAIN_BLEND,q.MAIN_GLOW]),a=0;a<r.length;a++)for(var n=r[a].draw_data,_=0;_<n.length;_++)for(var s=n[_].bundles,o=0;o<s.length;o++){var i=s[o].batch;i&&(e+=i.num_triangles)}return e},t.num_draw_calls=function(){for(var e=U.get_active(),t=U.subs_array(e,[q.MAIN_OPAQUE,q.MAIN_BLEND,q.MAIN_GLOW,q.MAIN_PLANE_REFLECT,q.MAIN_PLANE_REFLECT_BLEND]),r=0,a=0;a<t.length;a++)for(var n=(o=t[a]).draw_data,_=0;_<n.length;_++)r+=n[_].bundles.length;for(var s=U.subs_array(e,[q.MAIN_CUBE_REFLECT,q.MAIN_CUBE_REFLECT_BLEND]),a=0;a<s.length;a++)for(var o=s[a],n=o.draw_data,_=0;_<n.length;_++)r+=6*n[_].bundles.length;return r},t.num_shaders=function(){var e=H.get_compiled_shaders();return Q.get_dict_length(e)},t.geometry_stats=function(){for(var e=U.get_active(),t=U.get_all_subscenes(e),r={},a=0;a<t.length;a++){var n=t[a];if(n.type!=q.SINK&&n.type!=q.DEBUG_VIEW)for(var _=n.draw_data,s=0;s<_.length;s++)for(var o=_[s].bundles,i=0;i<o.length;i++){var l=o[i].batch,c=o[i].obj_render;l&&(n.type!=q.COLOR_PICKING&&n.type!=q.OUTLINE_MASK||c.origin_selectable||c.origin_outlining)&&(r[l.id]=l)}}var u=0,d=0;for(var f in r){var m=r[f].bufs_data;m.debug_ibo_bytes&&(d+=m.debug_ibo_bytes/1048576),u+=m.debug_vbo_bytes/1048576}return{vbo_memory:u,ibo_memory:d}},t.num_textures=function(){for(var e=[],t=0,r=U.get_active(),a=U.subs_array(r,[q.MAIN_OPAQUE,q.MAIN_BLEND,q.MAIN_GLOW]),n=0;n<a.length;n++)for(var _=a[n].draw_data,s=0;s<_.length;s++)for(var o=_[s].bundles,i=0;i<o.length;i++){var l=o[i].batch;if(l)for(var c=l.textures,u=0;u<c.length;u++){var d=c[u];if("IMAGE"===d.source||"ENVIRONMENT_MAP"===d.source){var f=d.w_texture;if(-1===e.indexOf(f)){e.push(f);var m=d.width*d.height*4/1048576/d.compress_ratio;t+=m*=1.3333}}}}return{number:e.length,memory:t}},t.num_render_targets=function(){for(var e=[],t=0,r=U.get_active(),a=U.get_all_subscenes(r),n=0;n<a.length;n++){var _=a[n];if(_.type!=q.SINK){var s=_.camera,o=[s.color_attachment,s.depth_attachment];o.push.apply(o,_.textures_internal);for(var i=0;i<o.length;i++){var l=o[i];V.is_texture(l)&&-1==e.indexOf(l)&&(e.push(l),t+=s.width*s.height*V.get_texture_texel_size(l))}}}return{number:e.length,memory:t/1024/1024}},t.make_camera_frustum_shot=function(){var e=U.get_active(),t=U.get_subs(e,q.MAIN_OPAQUE);t&&U.make_frustum_shot(t.camera,t,[1,1,0])},t.make_light_frustum_shot=function(){var e=U.get_active(),t=U.get_subs(e,q.MAIN_OPAQUE),r=U.subs_array(e,[q.SHADOW_CAST]);if(t)for(var a=0;a<r.length;a++){var n,_=r[a];switch(a){case 0:n=[1,0,0];break;case 1:n=[0,1,0];break;case 2:n=[0,0,1];break;default:n=[1,0,1]}U.make_frustum_shot(_.camera,t,n)}},t.scenegraph_to_dot=function(){for(var e=U.get_all_scenes(),t=0;t<e.length;t++){var r=e[t],a=U.get_graph(r);C.log("\n"+F.debug_convert_to_dot(a))}},t.loading_graph_to_dot=function(e){e|=0,C.log("\n"+M.graph_to_dot(e))},t.controls_info=E.debug,t.object_distance=function(e,t){var r=Z.get_trans_view(e.render.world_tsr),a=Z.get_trans_view(t.render.world_tsr);return J.dist(r,a)},t.msg=O.msg,t.fbmsg=O.fbmsg,t.print_telemetry=O.print_telemetry,t.plot_telemetry=O.plot_telemetry,t.fbres=function(e,t){t||(t=16);var r=function(){O.fbmsg("FBRES",e()),setTimeout(r,t)};r()},t.assert_constants=function(){var e=new Float32Array(3),t=new Float32Array([0,0,0,1]),r=new Float32Array([1,0,0]),a=new Float32Array([0,1,0]),n=new Float32Array([0,0,1]),_=new Float32Array([-1,0,0]),s=new Float32Array([0,-1,0]),o=new Float32Array([0,0,-1]);if(!Q.cmp_arr(e,Q.VEC3_IDENT))throw"Wrong VEC3_IDENT";if(!Q.cmp_arr(t,Q.QUAT4_IDENT))throw"Wrong QUAT4_IDENT";if(!Q.cmp_arr(r,Q.AXIS_X))throw"Wrong AXIS_X";if(!Q.cmp_arr(a,Q.AXIS_Y))throw"Wrong AXIS_Y";if(!Q.cmp_arr(n,Q.AXIS_Z))throw"Wrong AXIS_Z";if(!Q.cmp_arr(_,Q.AXIS_MX))throw"Wrong AXIS_MX";if(!Q.cmp_arr(s,Q.AXIS_MY))throw"Wrong AXIS_MY";if(!Q.cmp_arr(o,Q.AXIS_MZ))throw"Wrong AXIS_MZ"},t.mute_music=function(){for(var e=z.get_speaker_objects(),t=0;t<e.length;t++){var r=e[t];"BACKGROUND_MUSIC"==z.get_spk_behavior(r)&&z.mute(r,!0)}},t.check_finite=O.check_finite,t.set_debug_params=function(e){var t=U.get_active(),r=U.subs_array(t,[q.DEBUG_VIEW]);if(r.length)for(var a=0;a<r.length;a++){var n=r[a];if("number"==typeof e.debug_view_mode)switch(e.debug_view_mode){case O.DV_NONE:case O.DV_OPAQUE_WIREFRAME:case O.DV_TRANSPARENT_WIREFRAME:case O.DV_FRONT_BACK_VIEW:case O.DV_BOUNDINGS:case O.DV_CLUSTERS_VIEW:case O.DV_BATCHES_VIEW:case O.DV_RENDER_TIME:U.set_debug_view_mode(n,e.debug_view_mode);break;default:C.error("set_debug_params(): Wrong debug view mode")}"number"==typeof e.debug_colors_seed&&U.set_debug_colors_seed(n,e.debug_colors_seed),"number"==typeof e.render_time_threshold&&U.set_render_time_threshold(n,e.render_time_threshold),"object"==typeof e.wireframe_edge_color&&U.set_wireframe_edge_color(n,Q.f32(e.wireframe_edge_color))}else C.error("Debugging is not available on the scene.")},t.get_error_quantity=function(){return C.get_error_count()},t.get_warning_quantity=function(){return C.get_warning_count()},t.clear_errors_warnings=function(){return C.clear_errors_warnings()},t.analyze_shaders=function(e){var t=H.get_compiled_shaders(),r=0;for(var n in t)e&&-1===n.indexOf(e)||r++;var _="of "+r+" analyzing...",o={};for(var n in t)if(!e||-1!==n.indexOf(e)){var i=t[n],l=a(i.vshader,i.fshader);if(l){var c=i.shaders_info,u=c.vert+" + "+c.frag;l.cshader=i,l.shaders_info=c,(d=o[u]=o[u]||[]).push(l),C.log_raw(_)}}for(var u in o){C.group("%c"+u,"color: #800");var d=o[u];s(d),C.groupEnd()}},t.fake_load=O.fake_load,t.test_performance=function(e){if(H.check_shaders_loaded())if(R.get_disjoint_timer_query()){var r=fe.gl_debug;fe.gl_debug=!0;var a=F.create_performance_graph();U.generate_auxiliary_batches(null,a);for(var n=F.find_subs(a,q.PERFORMANCE),_=n.camera,s=0;s<5;s++)P.draw(n);fe.gl_debug=r,window.setTimeout(function(){O.process_timer_queries(n);var t=n.debug_render_time,r=_.width*_.height*4*10/(t/1e3)/Math.pow(10,9);e(t,r)},100)}else e(0,0);else window.setTimeout(function(){t.test_performance(e)},100)},t.calc_vbo_garbage_byte_size=O.calc_vbo_garbage_byte_size,t.show_vbo_garbage_info=O.show_vbo_garbage_info,t.print_batches_stat=O.print_batches_stat,t.start_debug=function(e){pe=[],ye=!0;var t=require(e);for(var r in t)"function"==typeof t[r]&&(t[r]=i(t[r]))},t.check_debug_result=function(){return ye},t.test=function(e,t){var r=C.error,a=C.error_once,n=C.warn;C.error=C.error_once=function(){var e=C.compose_args_prefix(arguments,"B4W ERROR");ve=e.join(" "),ge=!0},C.warn=function(){var e=C.compose_args_prefix(arguments,"B4W WARN");he=e.join(" "),be=!0},be=!1,ge=!1;try{t(),_=!0}catch(t){ye=!1,console.error('Test "'+e+'" failed with exception: "'+t+'"');var _=!1;be=!1,ge=!1}return C.error=r,C.error_once=a,C.warn=n,_},t.pix=function(e){var t=T.get_viewport_width(),r=T.get_viewport_height(),a=t/2,n=r/2;T.resize(t,r,!1);var _=U.get_active()._render.graph,s=F.find_on_screen(_);s||Q.panic("Couldn't find onscreen subscene");var o=s.camera,i=T.canvas_to_viewport_coords(a,n,se,s.camera);i[1]=o.height-i[1],c(e,P.read_pixels(o.framebuffer,i[0],i[1],1,1,Ee),1)},t.eqs=function(e,t,r,a){if(JSON.stringify(e)!=JSON.stringify(t))throw"debug.eqs: wrong result";u(r,a,"eqs")},t.eqv=c,t.eqf=function(e,t,r,a,n){if("number"!=typeof t||isNaN(t))throw"debug.eqf: wrong expected data type";if("number"!=typeof e||isNaN(e))throw"debug.eqf: wrong result data type";if(r=r||me,t>e+r||t<e-r)throw"debug.eqf: wrong result";u(a,n,"eqf")},t.eq=function(e,t,r,a){if(e!==t)throw"debug.eq: wrong result";u(r,a,"eq")},t.ok=function(e,t,r){if(!Boolean(e))throw"debug.ok: wrong result";u(t,r,"ok")},t.stat=function(e){var t=[],r=require(e);for(var a in r)-1==pe.indexOf(r[a])&&"function"==typeof r[a]&&t.push(a);if(t.length){C.groupCollapsed(t.length+" function(s) not tested.");for(var n=0;n<t.length;n++)C.log_raw(t[n]);C.groupEnd()}else C.group("All functions were tested.")},t.show_normals=function(e,t,r,a){d();var n=f.find_batch_material(e,t,"MAIN");if(!N.has_dyn_geom(e)||!n)return C.error("Normals are not avaliable for the dynamic object:",e.name),!1;var _=n.bufs_data;if(!(_&&_.pointers&&_.pointers.a_position&&_.pointers.a_tbn))return C.error("Normals are not avaliable for the object:",e.name),!1;var s=N.extract_array_float(_,"a_position"),o=N.extract_array_float(_,"a_normal"),i=K.get_tsr(e,ne);de=I.create_line("normal_line");for(var l=new Float32Array(2*s.length),c=0;c<s.length;c+=3){var u=ie;u[0]=s[c+0],u[1]=s[c+1],u[2]=s[c+2];var m=Z.transform_vec3(u,i,ue);l[2*c+0]=m[0],l[2*c+1]=m[1],l[2*c+2]=m[2];var p=J.scale(o.subarray(c,c+3),r,ue),h=J.add(u,p,ue),v=Z.transform_vec3(h,i,ue);l[2*c+3]=v[0],l[2*c+4]=v[1],l[2*c+5]=v[2]}var b=f.get_first_batch(de);N.draw_line(b,l,!0),P.assign_attribute_setters(b),b.diffuse_color.set([1,1,1,1]),b.line_width=a},t.hide_normals=d}),ge=o("input",function(e,t){function r(e){i.error_deprecated("enable_split_screen","screen.request_split_screen");var t=a.get_device_by_type_element(a.DEVICE_HMD);if(!t)return!1;if(p)return!0;var r=a.get_vector_param(t,a.HMD_FOV_LEFT,d),_=a.get_vector_param(t,a.HMD_FOV_RIGHT,f);n.set_hmd_fov(e,r,_);var c=a.get_value_param(t,b);if(c){var u=l.get_active(),m=o.get_scene_data(e,u).cameras;n.set_eye_distance(m,c)}var v={};if(v.base_line_factor=.5,v.inter_lens_factor=.5,v.enable_hmd_stereo=!0,a.get_value_param(t,a.HMD_WEBVR_TYPE)&(a.HMD_NON_WEBVR|a.HMD_WEBVR_MOBILE|a.HMD_WEBVR_DESKTOP)&&(v.distortion_coefs=[t.distortion_coefs[0],t.distortion_coefs[1]],v.chromatic_aberration_coefs=[t.chromatic_aberration_coefs[0],t.chromatic_aberration_coefs[1],t.chromatic_aberration_coefs[2],t.chromatic_aberration_coefs[3]],t.webvr_hmd_device||(t.base_line_dist&&t.height_dist&&t.bevel_size?v.base_line_factor=(t.base_line_dist-t.bevel_size)/t.height_dist:t.bevel_size||(v.base_line_factor=t.base_line_dist/t.height_dist)),t.inter_lens_dist&&t.width_dist&&!t.webvr_hmd_device&&(v.inter_lens_factor=t.inter_lens_dist/t.width_dist),!h.enabled)){var g=1+t.distortion_coefs[0]+t.distortion_coefs[1];l.multiply_size_mult(g,g)}return l.set_hmd_params(v),s.resize_to_container(!0),a.reset_device(t),p=!0,!0}var a=S(e),n=ue(e),_=g(e),s=ce(e),o=k(e),i=m(e),l=j(e),u=c(e),d=u.create(),f=u.create(),p=!1,h=_.debug_subs,v=_.defaults;t.GMPD_BUTTON_12=a.GMPD_BUTTON_12,t.GMPD_BUTTON_13=a.GMPD_BUTTON_13,t.GMPD_BUTTON_15=a.GMPD_BUTTON_15,t.GMPD_BUTTON_14=a.GMPD_BUTTON_14,t.GMPD_BUTTON_3=a.GMPD_BUTTON_3,t.GMPD_BUTTON_0=a.GMPD_BUTTON_0,t.GMPD_BUTTON_1=a.GMPD_BUTTON_1,t.GMPD_BUTTON_2=a.GMPD_BUTTON_2,t.GMPD_BUTTON_5=a.GMPD_BUTTON_5,t.GMPD_BUTTON_7=a.GMPD_BUTTON_7,t.GMPD_BUTTON_4=a.GMPD_BUTTON_4,t.GMPD_BUTTON_6=a.GMPD_BUTTON_6,t.GMPD_BUTTON_8=a.GMPD_BUTTON_8,t.GMPD_BUTTON_9=a.GMPD_BUTTON_9,t.GMPD_BUTTON_10=a.GMPD_BUTTON_10,t.GMPD_BUTTON_11=a.GMPD_BUTTON_11,t.GMPD_BUTTON_16=a.GMPD_BUTTON_16,t.GMPD_BUTTON_17=a.GMPD_BUTTON_17,t.GMPD_BUTTON_18=a.GMPD_BUTTON_18,t.GMPD_BUTTON_19=a.GMPD_BUTTON_19,t.GMPD_BUTTON_20=a.GMPD_BUTTON_20,t.GMPD_BUTTON_21=a.GMPD_BUTTON_21,t.GMPD_BUTTON_22=a.GMPD_BUTTON_22,t.GMPD_BUTTON_23=a.GMPD_BUTTON_23,t.GMPD_BUTTON_24=a.GMPD_BUTTON_24,t.GMPD_BUTTON_25=a.GMPD_BUTTON_25,t.GMPD_TRACKPAD_BUTTON=a.GMPD_TRACKPAD_BUTTON,t.GMPD_TRIGGER_BUTTON=a.GMPD_TRIGGER_BUTTON,t.GMPD_GRIPS_BUTTON=a.GMPD_GRIPS_BUTTON,t.GMPD_MENU_BUTTON=a.GMPD_MENU_BUTTON,t.GMPD_AXIS_0=a.GMPD_AXIS_0,t.GMPD_AXIS_1=a.GMPD_AXIS_1,t.GMPD_AXIS_2=a.GMPD_AXIS_2,t.GMPD_AXIS_3=a.GMPD_AXIS_3,t.GMPD_AXIS_4=a.GMPD_AXIS_4,t.GMPD_AXIS_5=a.GMPD_AXIS_5,t.GMPD_AXIS_6=a.GMPD_AXIS_6,t.GMPD_AXIS_7=a.GMPD_AXIS_7,t.GMPD_AXIS_8=a.GMPD_AXIS_8,t.GMPD_AXIS_9=a.GMPD_AXIS_9,t.GMPD_AXIS_10=a.GMPD_AXIS_10,t.GMPD_AXIS_11=a.GMPD_AXIS_11,t.HMD_ORIENTATION_QUAT=a.HMD_ORIENTATION_QUAT,t.HMD_POSITION=a.HMD_POSITION,t.HMD_WEBVR_TYPE=a.HMD_WEBVR_TYPE,t.HMD_WEBVR_DESKTOP=a.HMD_WEBVR_DESKTOP,t.HMD_WEBVR_MOBILE=a.HMD_WEBVR_MOBILE,t.HMD_NON_WEBVR=a.HMD_NON_WEBVR,t.HMD_WEBVR1=a.HMD_WEBVR1,t.HMD_WEBVR1_1=a.HMD_WEBVR1_1;var b=a.HMD_EYE_DISTANCE;t.HMD_EYE_DISTANCE=b,t.HMD_DISTORTION=a.HMD_DISTORTION,t.HMD_BASELINE_DIST=a.HMD_BASELINE_DIST,t.HMD_SCREEN_LENS_DIST=a.HMD_SCREEN_LENS_DIST,t.HMD_SCREEN_WIDTH=a.HMD_SCREEN_WIDTH,t.HMD_SCREEN_HEIGHT=a.HMD_SCREEN_HEIGHT,t.HMD_BEVEL_SIZE=a.HMD_BEVEL_SIZE,t.MOUSE_LOCATION=a.MOUSE_LOCATION,t.MOUSE_DOWN_WHICH=a.MOUSE_DOWN_WHICH,t.MOUSE_UP_WHICH=a.MOUSE_UP_WHICH,t.MOUSE_WHEEL=a.MOUSE_WHEEL,t.KEYBOARD_UP=a.KEYBOARD_UP,t.KEYBOARD_DOWN=a.KEYBOARD_DOWN,t.TOUCH_START=a.TOUCH_START,t.TOUCH_MOVE=a.TOUCH_MOVE,t.TOUCH_END=a.TOUCH_END,t.GYRO_ORIENTATION_QUAT=a.GYRO_ORIENTATION_QUAT,t.GYRO_ORIENTATION_ANGLES=a.GYRO_ORIENTATION_ANGLES;var y={};y[a.DEVICE_HMD]=[a.HMD_ORIENTATION_QUAT,a.HMD_POSITION],y[a.DEVICE_MOUSE]=[a.MOUSE_LOCATION];var E={};E[a.DEVICE_HMD]=[a.HMD_WEBVR_TYPE];var w={};w[a.DEVICE_MOUSE]=[a.MOUSE_LOCATION,a.MOUSE_DOWN_WHICH,a.MOUSE_UP_WHICH,a.MOUSE_WHEEL],w[a.DEVICE_KEYBOARD]=[a.KEYBOARD_UP,a.KEYBOARD_DOWN],w[a.DEVICE_TOUCH]=[a.TOUCH_START,a.TOUCH_MOVE,a.TOUCH_END],w[a.DEVICE_GYRO]=[a.GYRO_ORIENTATION_QUAT,a.GYRO_ORIENTATION_ANGLES];var A={};A[a.DEVICE_HMD]=[a.HMD_DISTORTION,a.HMD_EYE_DISTANCE,a.HMD_BASELINE_DIST,a.HMD_SCREEN_LENS_DIST,a.HMD_SCREEN_WIDTH,a.HMD_SCREEN_HEIGHT,a.HMD_BEVEL_SIZE],t.DEVICE_GYRO=a.DEVICE_GYRO,t.DEVICE_HMD=a.DEVICE_HMD,t.DEVICE_MOUSE=a.DEVICE_MOUSE,t.DEVICE_KEYBOARD=a.DEVICE_KEYBOARD,t.DEVICE_TOUCH=a.DEVICE_TOUCH,t.can_use_device=a.can_use_device,t.get_device_by_type_element=a.get_device_by_type_element,t.switch_prevent_default=function(e,t){e&&a.switch_prevent_default(e,t)},t.register_device=function(){i.error_once("input.register_device() deprecated")},t.reset_device=function(e){e&&e.type==a.DEVICE_HMD?a.reset_device(e):i.error("reset_device is undefined for device.")},t.get_vector_param=function(e,t,r){return e&&e.type in y&&y[e.type].indexOf(t)>=0?a.get_vector_param(e,t,r):(i.error("device hasn't param: ",t),null)},t.get_value_param=function(e,t){return e&&e.type in E&&E[e.type].indexOf(t)>=0?a.get_value_param(e,t):(i.error("device hasn't param: ",t),null)},t.attach_param_cb=function(e,t,r){if(r=r||null,e&&e.type in w&&w[e.type].indexOf(t)>=0)return a.attach_param_cb(e,t,r);i.error("device hasn't param: ",t)},t.detach_param_cb=function(e,t,r){if(r=r||null,e&&e.type in w&&w[e.type].indexOf(t)>=0)return a.detach_param_cb(e,t,r);i.error("device hasn't param: ",t)},t.set_config=function(e,t,r){if(e&&e.type in A&&A[e.type].indexOf(t)>=0)return a.set_config(e,t,r);i.error("device hasn't config: ",t)},t.request_fullscreen_hmd=function(){if(i.error_deprecated("request_fullscreen_hmd","screen.request_fullscreen_hmd"),l.check_active()){var e=l.get_camera(l.get_active());if(e){r(e);var t=a.get_device_by_type_element(a.DEVICE_HMD);if(t){var n=t.webvr_display;if(n&&!n.isPresenting)if(n.capabilities.canPresent){var _=s.get_canvas();n.requestPresent([{source:_}]).then(function(){if(!v.is_mobile_device){var e=n.getEyeParameters("left"),t=n.getEyeParameters("right");s.resize(2*Math.max(e.renderWidth,t.renderWidth),Math.max(e.renderHeight,t.renderHeight),!1)}},function(){i.error("HMD fullscreen request failed.")})}else i.error("HMD fullscreen request failed.")}}}},t.enable_split_screen=r,t.disable_split_screen=function(){i.error_deprecated("disable_split_screen","screen.exit_split_screen");var e=a.get_device_by_type_element(a.DEVICE_HMD);if(!p||!e||!e.registered)return!1;var t={};t.enable_hmd_stereo=!1,l.set_hmd_params(t);var r=1/(1+e.distortion_coefs[0]+e.distortion_coefs[1]);return l.multiply_size_mult(r,r),s.resize_to_container(!0),!0},t.set_gamepad_key=function(e,t,r){switch(e){case 0:n=a.DEVICE_GAMEPAD0;break;case 1:n=a.DEVICE_GAMEPAD1;break;case 2:n=a.DEVICE_GAMEPAD2;break;case 3:n=a.DEVICE_GAMEPAD3;break;default:var n=a.DEVICE_GAMEPAD0}var _=a.get_device_by_type_element(n);a.set_config(_,t,r)},t.get_pressed_gmpd_btn=a.get_pressed_gmpd_btn,t.get_moved_gmpd_axis=a.get_moved_gmpd_axis,t.get_gamepad_position=a.get_gamepad_position,t.get_gamepad_orientation=a.get_gamepad_orientation,t.check_enable_gamepad_indices=function(){for(var e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],t=[],r=0;r<e.length;r++)e[r]&&t.push(r);return t},t.get_vr_controller_id=function(e){for(var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],r=0,a=0;r<4;r++){var n=t[r];if(n&&(""==n.id||"OpenVR Gamepad"==n.id||"Oculus Touch (Left)"==n.id||"Oculus Touch (Right)"==n.id)){if(a==e)return a;a++}}return e},t.add_click_listener=function(e,t){e&&t&&a.add_click_listener(e,t)},t.remove_click_listener=function(e,t){e&&t&&a.remove_click_listener(e,t)}}),ye=o("__main",function(e,t){function r(e,t,r){var n=a.get_canvas();if(n.toBlob)n.toBlob(e,t,r);else{for(var _=atob(n.toDataURL(t,r).split(",")[1]),s=new Uint8Array(_.length),o=0;o<_.length;o++)s[o]=_.charCodeAt(o);e(new Blob([s],{type:t||"image/png"}))}}var a=ce(e),n={callback:null,format:"image/png",quality:1,blob_url:"",last_auto_revoke:!1,curr_auto_revoke:!1};t.canvas_data_url=function(e,t,r,a){n.curr_auto_revoke=void 0!==a||a,n.last_auto_revoke=n.curr_auto_revoke,n.callback=e,n.format=t||n.format,n.quality=r||n.quality},t.frame=function(e,t){var a=n.callback;a&&(n.last_auto_revoke&&n.blob_url&&URL.revokeObjectURL(n.blob_url),r(function(e){navigator.msSaveOrOpenBlob?a(e):(n.blob_url=URL.createObjectURL(e),a(n.blob_url))},n.format,n.quality),n.callback=null,n.format="image/png",n.quality=1)}}),Ee=o("main",function(e,t){function r(){window.performance||(q.log("Apply performance workaround"),window.performance={});var e=Date.now();window.performance.now||(q.log("Apply performance.now() workaround"),window.performance.now=function(){return Date.now()-e}),ie.set_timeline(0)}function a(e,t){for(var r=null,a=t?Oe:xe,n=0;n<a.length;n++){var _=a[n];try{r=e.getContext(_,pe)}catch(e){}if(r)break}return r&&b.detect_tegra_invalid_enum_issue(r),r}function n(e,t,r){e.addEventListener("webglcontextlost",function(e){e.preventDefault(),q.error("WebGL context lost"),o()},!1),R.setup_context(r);var a=R.get_renderer_info();a&&q.log("%cRENDERER INFO:","color: #00a",r.getParameter(a.UNMASKED_VENDOR_WEBGL)+", "+r.getParameter(a.UNMASKED_RENDERER_WEBGL)),Z.setup_context(r),k.setup_context(r),oe.setup_context(r),_e.setup_context(r),E.setup_context(r),O.setup_context(r),T.setup_canvas(e),E.init(e,t),J.setup_dim(e.width,e.height,1),ne.init(),M.init(),Ae=u(),l()}function _(e){Te=e}function s(){Te=function(){}}function o(){i()||(be=performance.now()/1e3,ne.pause(),H.pause(),oe.pause(),d.pause())}function i(){return ge<be}function l(){var e="HMD"===he.stereo&&M.get_webvr_display();e?e.requestAnimationFrame(l):ke(l);var t=performance.now()/1e3;ve||(ve=t);var r=t-ve;if(!(r<1/he.max_fps)){for(var a=ie.get_timeline(),n=0;n<Ee.length;n++)Ee[n](a,r);i()||(ge>ve&&(r-=ge-Math.max(be,ve)),ie.set_delta(r),a+=r,ie.set_timeline(a),O.update(),p.update(),T.update(),c(a,r),Ae(r)),ve=t,e&&e.isPresenting&&e.submitFrame()}}function c(e,t){T.is_primary_loaded()&&(L.reset(),ue.update(t),G.update(e,t),C.update(e,t),ne.update(e,t),t&&f.update(t),T.is_primary_loaded()&&(H.update(e,t),T.is_primary_loaded()&&(M.update(e),A.update(e,t),T.is_primary_loaded()&&(d.update(!1),z.update(e,t),me.update(),Te(t,e),T.is_primary_loaded()&&(J.update(e,t),d.update_visibility(),P.frame())))))}function u(){var e=60,t=0,r=he.fps_measurement_interval,a=he.fps_callback_interval;return function(n){if(!(n<1/he.max_fps)){e=de.smooth(1/n,e,n,r);var _=H.get_fps();0==(t=(t+1)%a)&&we(Math.round(e),_)}}}var d=se(e),f=Q(e),p=F(e),v=g(e),b=re(e),E=ce(e),A=X(e),T=le(e),O=ae(e),R=y(e),k=w(e),M=S(e),L=I(e),C=V(e),P=ye(e),G=K(e),z=$(e),H=W(e),q=m(e),Z=te(e),J=j(e),ne=D(e),_e=B(e),oe=ee(e),ie=x(e),ue=Y(e),de=h(e),fe=U(e),me=N(e),pe=v.context,he=v.defaults,ve=0,be=0,ge=0,Ee=[],we=function(){},Ae=function(){},Te=function(){},xe=["webgl","experimental-webgl"],Oe=["webgl2","experimental-webgl2"],Re=null,ke=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/he.max_fps)};t.init=function(e,t){q.set_verbose(he.console_verbose);var _=fe.version_str()+" "+fe.type()+" ("+fe.date_str()+")";if(q.log("%cINIT ENGINE","color: #00a",_),q.log("%cUSER AGENT:","color: #00a",navigator.userAgent),!window.WebGLRenderingContext)return null;r(),t?L.init(t):(v.defaults.show_hud_debug_info=!1,v.sfx.mix_mode=!1),b.apply_context_alpha_hack(),b.check_user_agent("Chrome")||b.check_user_agent("Firefox")||(he.webgl2=!1);var s=a(e,he.webgl2);return!s&&he.webgl2&&(he.webgl2=!1,s=a(e,!1)),s?(q.log("%cINIT WEBGL "+(he.webgl2?"2":"1"),"color: #00a"),Re=s,n(e,t,s),v.apply_quality(),b.set_hardware_defaults(s,!0),v.set_paths(),_e.load_shaders(),he.ie11_edge_touchscreen_hack&&(e.style["touch-action"]="none"),q.log("%cSET PRECISION:","color: #00a",he.precision),s):null},t.set_fps_callback=function(e){we=e},t.clear_fps_callback=function(){we=function(){}},t.set_render_callback=function(e){_(e)},t.clear_render_callback=function(){s()},t.pause=o,t.resume=function(){i()&&(ge=performance.now()/1e3,ne.resume(),H.resume(),oe.play(!0),d.resume())},t.is_paused=i,t.reset=function(){T.unload(0),T.reset(),R.reset(),Z.reset(),k.reset(),oe.reset_mod(),_e.reset(),O.reset(),E.reset(),T.reset(),E.reset(),ie.reset(),ne.reset(),ve=0,be=0,ge=0,we=function(){},Ae=function(){},Te=function(){},Ee.length=0,Re=null},t.canvas_data_url=function(e,t,r,a){P.canvas_data_url(e,t,r,a)},t.detect_mobile=function(){return b.detect_mobile()},t.append_loop_cb=function(e){for(var t=0;t<Ee.length;t++)if(Ee[t]==e)return;Ee.push(e)},t.remove_loop_cb=function(e){for(var t=0;t<Ee.length;t++)if(Ee[t]==e){Ee.splice(t,1);break}},t.get_renderer_info=function(){var e=R.get_renderer_info();return e?{vendor:Re.getParameter(e.UNMASKED_VENDOR_WEBGL),renderer:Re.getParameter(e.UNMASKED_RENDERER_WEBGL)}:null}}),we=o("physics",function(e,t){function r(e,t,r,a,n){return s.dist_to_triange(e,a[r[0]],a[r[1]],a[r[2]])}function a(e,t,r,a,n){var _=Math.abs(e[2]-t[2]);return _<n&&o.is_vector_in_poly(e,r,a)?_:Number.MAX_VALUE}var n=W(e),_=m(e),s=h(e),o=H(e);t.CM_WALK=0,t.CM_RUN=1,t.CM_CLIMB=2,t.CM_FLY=3,t.enable_simulation=function(e){n.obj_has_physics(e)?n.enable_simulation(e):_.error_once("No physics for object "+e.name)},t.disable_simulation=function(e){n.obj_has_physics(e)?n.disable_simulation(e):_.error_once("No physics for object "+e.name)},t.has_physics=function(e){return n.obj_has_physics(e)},t.has_simulated_physics=function(e){return n.has_simulated_physics(e)},t.has_dynamic_physics=function(e){return n.has_dynamic_physics(e)},t.set_gravity=function(e,t){_.error_deprecated("set_gravity","set_object_gravity"),n.obj_has_physics(e)?n.set_gravity(e,0,0,-t):_.error_once("No physics for object "+e.name)},t.set_object_gravity=function(e,t){n.obj_has_physics(e)?n.set_gravity(e,t[0],t[1],t[2]):_.error_once("No physics for object "+e.name)},t.set_transform=function(e,t,r){n.obj_has_physics(e)?n.set_transform(e,t,r):_.error_once("No physics for object "+e.name)},t.sync_transform=function(e){n.obj_has_physics(e)?n.sync_transform(e):_.error_once("No physics for object "+e.name)},t.apply_velocity=function(e,t,r,a){n.obj_has_physics(e)?n.apply_velocity(e,t,r,a):_.error_once("No physics for object "+e.name)},t.apply_velocity_world=function(e,t,r,a){n.obj_has_physics(e)?n.apply_velocity_world(e,t,r,a):_.error_once("No physics for object "+e.name)},t.apply_force=function(e,t,r,a){n.obj_has_physics(e)?n.apply_force(e,t,r,a,!1):_.error_once("No physics for object "+e.name)},t.apply_force_world=function(e,t,r,a){n.obj_has_physics(e)?n.apply_force(e,t,r,a,!0):_.error_once("No physics for object "+e.name)},t.apply_torque=function(e,t,r,a){n.obj_has_physics(e)?n.apply_torque(e,t,r,a):_.error_once("No physics for object "+e.name)},t.set_angular_velocity=function(e,t,r,a){n.obj_has_physics(e)?n.set_angular_velocity(e,t,r,a):_.error_once("No physics for object "+e.name)},t.vehicle_throttle=function(e,t){n.obj_has_physics(e)?(n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)||_.error("Wrong object"),n.vehicle_throttle(e,s.clamp(t,-1,1))):_.error_once("No physics for object "+e.name)},t.vehicle_throttle_inc=function(e,t,r){if(n.obj_has_physics(e)){n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)||_.error("Wrong object"),t=s.clamp(t,0,1);var a=e.vehicle.engine_force;-1==r||1==r?(a+=r*t,a=Math.max(-1,Math.min(a,1))):0==r&&a>=0?(a-=t,a=Math.max(0,a)):0==r&&a<0?(a+=t,a=Math.min(0,a)):_.error("Wrong steering direction"),n.vehicle_throttle(e,s.clamp(a,-1,1))}else _.error_once("No physics for object "+e.name)},t.vehicle_steer=function(e,t){n.obj_has_physics(e)?(n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)||_.error("Wrong object"),n.vehicle_steer(e,s.clamp(t,-1,1))):_.error_once("No physics for object "+e.name)},t.vehicle_steer_inc=function(e,t,r){if(n.obj_has_physics(e)){n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)||_.error("Wrong object"),t=s.clamp(t,0,1);var a=e.vehicle.steering;-1==r||1==r?(a+=r*t,a=Math.max(-1,Math.min(a,1))):0==r&&a>=0?(a-=t,a=Math.max(0,a)):0==r&&a<0?(a+=t,a=Math.min(0,a)):_.error("Wrong steering direction"),n.vehicle_steer(e,s.clamp(a,-1,1))}else _.error_once("No physics for object "+e.name)},t.vehicle_brake=function(e,t){n.obj_has_physics(e)?(n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)||_.error("Wrong object"),n.vehicle_brake(e,s.clamp(t,0,1))):_.error_once("No physics for object "+e.name)},t.vehicle_brake_inc=function(e,t){if(n.obj_has_physics(e)){n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)||_.error("Wrong object"),t=s.clamp(t,-1,1);var r=e.vehicle.brake_force;r+=r*t,n.vehicle_brake(e,s.clamp(r,0,1))}else _.error_once("No physics for object "+e.name)},t.is_vehicle_chassis=function(e){return n.is_vehicle_chassis(e)},t.is_vehicle_hull=function(e){return n.is_vehicle_hull(e)},t.get_vehicle_name=function(e){return n.obj_has_physics(e)?n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)?e.vehicle_settings.name:(_.error("Wrong object"),null):(_.error_once("No physics for object "+e.name),null)},t.get_vehicle_throttle=function(e){return n.obj_has_physics(e)?n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)?e.vehicle.engine_force:(_.error("Wrong object"),null):(_.error_once("No physics for object "+e.name),null)},t.get_vehicle_steering=function(e){return n.obj_has_physics(e)?n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)?e.vehicle.steering:(_.error("Wrong object"),0):(_.error_once("No physics for object "+e.name),0)},t.get_vehicle_brake=function(e){return n.obj_has_physics(e)?n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)?e.vehicle.brake_force:(_.error("Wrong object"),0):(_.error_once("No physics for object "+e.name),0)},t.get_vehicle_speed=function(e){return n.obj_has_physics(e)?n.is_vehicle_chassis(e)||n.is_vehicle_hull(e)?n.get_vehicle_speed(e):(_.error("Wrong object"),0):(_.error_once("No physics for object "+e.name),0)},t.is_character=function(e){return n.has_character_physics(e)},t.set_character_move_dir=function(e,t,r){n.obj_has_physics(e)?n.set_character_move_dir(e,t,r):_.error_once("No physics for object "+e.name)},t.set_character_move_type=function(e,t){n.obj_has_physics(e)?n.set_character_move_type(e,t):_.error_once("No physics for object "+e.name)},t.set_character_walk_velocity=function(e,t){n.obj_has_physics(e)?n.set_character_walk_velocity(e,t):_.error_once("No physics for object "+e.name)},t.set_character_run_velocity=function(e,t){n.obj_has_physics(e)?n.set_character_run_velocity(e,t):_.error_once("No physics for object "+e.name)},t.set_character_fly_velocity=function(e,t){n.obj_has_physics(e)?n.set_character_fly_velocity(e,t):_.error_once("No physics for object "+e.name)},t.character_jump=function(e){n.obj_has_physics(e)?n.character_jump(e):_.error_once("No physics for object "+e.name)},t.character_rotation_inc=function(e,t,r){n.obj_has_physics(e)?n.character_rotation_inc(e,t,r):_.error_once("No physics for object "+e.name)},t.set_character_rotation=function(e,t,r){n.obj_has_physics(e)?n.set_character_rotation(e,t,r):_.error_once("No physics for object "+e.name)},t.set_character_rotation_v=function(e,t){n.obj_has_physics(e)?n.set_character_rotation_v(e,t):_.error_once("No physics for object "+e.name)},t.set_character_rotation_h=function(e,t){n.obj_has_physics(e)?n.set_character_rotation_h(e,t):_.error_once("No physics for object "+e.name)},t.set_character_vert_move_dir_angle=function(e,t){n.obj_has_physics(e)?n.set_character_vert_move_dir_angle(e,t):_.error_once("No physics for object "+e.name)},t.append_collision_test=function(e,t,r,a){n.obj_has_physics(e)?(t=t||"ANY",a=a||!1,n.append_collision_test(e,t,r,a)):_.error_once("No physics for object "+e.name)},t.remove_collision_test=function(e,t,r){n.obj_has_physics(e)?(t=t||"ANY",n.remove_collision_test(e,t,r)):_.error_once("No physics for object "+e.name)},t.apply_collision_impulse_test=function(e,t){n.obj_has_physics(e)?n.apply_collision_impulse_test(e,t):_.error_once("No physics for object "+e.name)},t.clear_collision_impulse_test=function(e){n.obj_has_physics(e)?n.clear_collision_impulse_test(e):_.error_once("No physics for object "+e.name)},t.append_ray_test=function(e,t,r,a,s,o){return null==(e=e||null)||n.obj_has_physics(e)?(a=a||"ANY",o=o||!1,n.append_ray_test(e,t,r,a,s,o,!1,!1,!1)):(_.error_once("No physics for object "+e.name),0)},t.append_ray_test_ext=function(e,t,r,a,s,o,i,l,c){return null==(e=e||null)||n.obj_has_physics(e)?(a=a||"ANY",o=o||!1,i=i||!1,l=l||!1,c=c||!1,n.append_ray_test(e,t,r,a,s,o,i,l,c)):(_.error_once("No physics for object "+e.name),0)},t.remove_ray_test=function(e){n.is_ray_test(e)?n.remove_ray_test(e):_.error("Wrong ray test ID")},t.change_ray_test_from_to=function(e,t,r){n.is_ray_test(e)?n.change_ray_test_from_to(e,t,r):_.error("Wrong ray test ID")},t.apply_constraint=function(e,t,r,a,s,o,i,l,c,u){n.obj_has_physics(t)&&n.obj_has_physics(s)?n.apply_constraint(e,t,r,a,s,o,i,l,c,u):_.error("Wrong objects")},t.clear_constraint=function(e){n.obj_has_physics(e)&&n.has_constraint(e)?n.clear_constraint(e):_.error("Wrong object")},t.pull_to_constraint_pivot=function(e,t,r,a,s,o){n.obj_has_physics(e)&&n.obj_has_physics(a)?n.pull_to_constraint_pivot(e,t,r,a,s,o):_.error("Wrong objects")},t.navmesh_get_island=function(e,t,a){if(a||(a=r),n.obj_has_physics(e)){var s=e.physics.navmesh;return s?o.navmesh_get_island(s,t,a):(_.error(e.name+" is not a navigation mesh object"),null)}_.error_once("No physics for object "+e.name)},t.navmesh_find_path=function(e,t,s,i){if(n.obj_has_physics(e)){var l=e.physics.navmesh;if(!l)return _.error(e.name+" is not a navigation mesh object"),null;i=i||{};var c={};return c.do_not_pull_string=Boolean(i.do_not_pull_string),c.distance_to_closest=i.distance_to_closest||r,c.distance_to_farthest=i.distance_to_farthest||a,c.island=i.island||0,c.allowed_distance=i.allowed_distance||Number.MAX_VALUE,c.return_normals=i.return_normals||!1,o.navmesh_find_path(l,t,s,c)}_.error_once("No physics for object "+e.name)}}),Ae=o("screen",function(e,t){function r(e,t,r){function a(){document.fullscreenElement===e||document.webkitFullscreenElement===e||document.mozFullScreenElement===e||document.webkitIsFullScreen||document.msFullscreenElement===e?t():(document.removeEventListener("fullscreenchange",a,!1),document.removeEventListener("webkitfullscreenchange",a,!1),document.removeEventListener("mozfullscreenchange",a,!1),document.removeEventListener("MSFullscreenChange",a,!1),r())}e=e||s.get_container(),t=t||function(){},r=r||function(){},document.addEventListener("fullscreenchange",a,!1),document.addEventListener("webkitfullscreenchange",a,!1),document.addEventListener("mozfullscreenchange",a,!1),document.addEventListener("MSFullscreenChange",a,!1),e.requestFullScreen=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullscreen,e.requestFullScreen?e.requestFullScreen():f.error("B4W App: request fullscreen method is not supported")}function a(){var e=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;"function"!=typeof e&&f.error("B4W App: exit fullscreen method is not supported"),e.apply(document)}function n(e){var t=l.get_device_by_type_element(l.DEVICE_HMD);if(!t)return!1;if(y)return!0;var r=l.get_value_param(t,l.HMD_WEBVR_TYPE);if(r&l.HMD_WEBVR1_1){var a=t.webvr_display,n=a.getEyeParameters("left"),o=a.getEyeParameters("right");s.resize(2*Math.max(n.renderWidth,o.renderWidth),Math.max(n.renderHeight,o.renderHeight),!1)}else{var i=s.get_canvas(),c=Math.max(2*i.height,i.width),u=c/2;s.resize(c,u,!1)}var f=l.get_vector_param(t,l.HMD_FOV_LEFT,v),m=l.get_vector_param(t,l.HMD_FOV_RIGHT,b);_.set_hmd_fov(e,f,m,!Boolean(r&l.HMD_WEBVR1_1));var h={};h.base_line_factor=.5,h.inter_lens_factor=.5,h.enable_hmd_stereo=!0,r&(l.HMD_NON_WEBVR|l.HMD_WEBVR_MOBILE|l.HMD_WEBVR_DESKTOP)&&(h.distortion_coefs=[t.distortion_coefs[0],t.distortion_coefs[1]],h.chromatic_aberration_coefs=[t.chromatic_aberration_coefs[0],t.chromatic_aberration_coefs[1],t.chromatic_aberration_coefs[2],t.chromatic_aberration_coefs[3]],t.webvr_hmd_device||(t.base_line_dist&&t.height_dist&&t.bevel_size?h.base_line_factor=(t.base_line_dist-t.bevel_size)/t.height_dist:t.bevel_size||(h.base_line_factor=t.base_line_dist/t.height_dist)),t.inter_lens_dist&&t.width_dist&&!t.webvr_hmd_device&&(h.inter_lens_factor=t.inter_lens_dist/t.width_dist)),A.enabled||p.multiply_size_mult(.5,1),p.set_hmd_params(h);var g=l.get_value_param(t,l.HMD_EYE_DISTANCE);if(g){var E=p.get_active(),w=d.get_scene_data(e,E).cameras;_.set_eye_distance(w,g)}return p.render_both_eyes(),y=!0,!0}var _=ue(e),s=ce(e),o=g(e),i=I(e),l=S(e),u=ye(e),d=k(e),f=m(e),p=j(e),h=c(e),v=h.create(),b=h.create(),y=!1,E=function(){},w=function(){},A=o.debug_subs;t.draw_mixer_strip=i.draw_mixer_strip,t.plot_array=i.plot_array,t.request_fullscreen=r,t.exit_fullscreen=a,t.check_fullscreen=l.check_fullscreen,t.request_fullscreen_hmd=function(e,t,a){if("HMD"!=!o.get("stereo")||"NONE"==o.get("stereo")&&o.get("is_mobile_device")){var n=l.get_device_by_type_element(l.DEVICE_HMD);if(n&&l.get_value_param(n,l.HMD_WEBVR_TYPE)&l.HMD_WEBVR1){var _=n.webvr_display;if(_&&!_.isPresenting)if(t=t||function(){},a=a||function(){},w=function(){_.isPresenting?t():(window.removeEventListener("vrdisplaypresentchange",w),a())},window.addEventListener("vrdisplaypresentchange",w,!1),_.capabilities.canPresent){var i=s.get_canvas();_.requestPresent([{source:i}]).then(function(){},function(){f.error("HMD fullscreen request failed.")})}else f.error("HMD fullscreen request failed.")}else r(e,t,a)}},t.exit_fullscreen_hmd=function(){if("HMD"!=!o.get("stereo")||"NONE"==o.get("stereo")&&o.get("is_mobile_device")){var e=l.get_device_by_type_element(l.DEVICE_HMD);if(e&&l.get_value_param(e,l.HMD_WEBVR_TYPE)&l.HMD_WEBVR1){var t=e.webvr_display;t&&t.isPresenting&&(t.exitPresent(),s.resize_to_container(!0))}else a()}},t.check_fullscreen_hmd=function(){var e=l.get_device_by_type_element(l.DEVICE_HMD),t=l.get_value_param(e,l.HMD_WEBVR_TYPE)&l.HMD_WEBVR1;return!(!e||!(t&&e.webvr_display||!t&&l.check_fullscreen()))},t.request_split_screen=function(e,t){var r=l.get_device_by_type_element(l.DEVICE_HMD);if(!r)return!1;if(y)return!0;if(E=t,p.check_active()){var a=p.get_camera(p.get_active());a&&(r.registered?(n(a),e&&e()):(l.request_register_device(r),r.registered_cb=function(){n(a),e&&e()}))}},t.exit_split_screen=function(){var e=l.get_device_by_type_element(l.DEVICE_HMD);if(!y||!e||!e.registered)return!1;var t={};return t.enable_hmd_stereo=!1,p.set_hmd_params(t),y=!1,E&&E(),p.render_one_eye(),A.enabled||p.multiply_size_mult(2,1),s.resize_to_container(!0),!0},t.shot=function(e,t){e=e||"image/png",t=t||1,u.canvas_data_url(function(t){var r="screenshot."+e.split("/")[1];if(navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(t,r);else{var a=window.document.createElement("a");document.body.appendChild(a),a.style.display="none",a.href=t,a.download="screenshot."+e.split("/")[1],a.click(),document.body.removeChild(a)}},e,t,!0)}}),Te=o("scenes",function(e,t){function r(){var e=o.get_canvas(),t=e.clientHeight,r=e.clientWidth;return c.pick_object(r/2,t/2)}function a(e,t,r){var a=f.get_active(),n=e.draw_data[0].bundles[0],s=n.batch,o=t.draw_data[0].bundles[0],i=o.batch;if("quality"in r){var l=r.quality;8===l||16===l||24===l||32===l?(e.ssao_samples=l,_.set_batch_directive(s,"SSAO_QUALITY","SSAO_QUALITY_"+l),_.update_shader(s),v.append_draw_data(e,n)):d.error('set_ssao_params(): Wrong "quality" value.')}if("use_hemisphere"in r&&(e.ssao_hemisphere=r.use_hemisphere,_.set_batch_directive(s,"SSAO_HEMISPHERE",0|r.use_hemisphere),_.update_shader(s),v.append_draw_data(e,n)),"use_blur_depth"in r&&(t.ssao_blur_depth=r.use_blur_depth,_.set_batch_directive(i,"SSAO_BLUR_DEPTH",0|r.use_blur_depth),_.update_shader(i),v.append_draw_data(t,o),p.connect_render_targets_batch(a._render.graph,t,i,!1)),"ssao_white"in r&&(e.ssao_white=r.ssao_white,_.set_batch_directive(s,"SSAO_WHITE",0|r.ssao_white),_.update_shader(s),v.append_draw_data(e,n)),"blur_discard_value"in r&&(t.ssao_blur_discard_value=r.blur_discard_value),"radius_increase"in r&&(e.ssao_radius_increase=r.radius_increase),"influence"in r&&(e.ssao_influence=r.influence),"dist_factor"in r&&(e.ssao_dist_factor=r.dist_factor),"boolean"==typeof r.ssao_only){var c=f.get_subs(a,v.MAIN_OPAQUE);c.ssao_only=r.ssao_only;for(var u=c.draw_data,m=[],h=0;h<u.length;h++)for(var b=u[h].bundles,g=0;g<b.length;g++){var y=b[g].batch;_.set_batch_directive(y,"SSAO_ONLY",0|r.ssao_only),_.update_shader(y),m.push(b[g])}for(h=0;h<m.length;h++)v.append_draw_data(c,m[h])}e.need_perm_uniforms_update=!0,t.need_perm_uniforms_update=!0}function n(e){return u.is_dynamic_mesh(e)||u.is_empty(e)||u.is_line(e)||u.is_lamp(e)}var _=_e(e),s=ue(e),o=ce(e),i=le(e),l=E(e),c=$(e),u=k(e),d=m(e),f=j(e),p=G(e),v=A(e),b=h(e);t.DATA_ID_ALL=c.DATA_ID_ALL,t.set_active=function(e){var t=f.get_all_scenes();f.set_active(b.keysearch("name",e,t))},t.get_active=function(){return f.check_active()?f.get_active().name:""},t.get_scenes=function(){for(var e=f.get_all_scenes(),t=[],r=0;r<e.length;r++)t.push(e[r].name);return t},t.get_active_camera=function(){return f.check_active()?f.get_camera(f.get_active()):(d.error("No active scene"),!1)},t.get_object_by_name=function(e,t){var r=c.get_object(c.GET_OBJECT_BY_NAME,e,0|t,!0);if(r)return r;d.error("get object "+e+": not found")},t.get_object_by_dupli_name=function(e,t,r){var a=c.get_object(c.GET_OBJECT_BY_DUPLI_NAME,e,t,0|r);if(a)return a;d.error("get object "+t+": not found")},t.get_object_by_dupli_name_list=function(e,t){var r=c.get_object(c.GET_OBJECT_BY_DUPLI_NAME_LIST,e,0|t);if(r)return r;d.error("get object "+e+": not found")},t.get_world_by_name=function(e,t){var r=c.get_world_by_name(e,0|t);if(r)return r;d.error("get object "+e+": not found")},t.get_object_data_id=function(e){return u.get_object_data_id(e)},t.pick_object=function(e,t){var a=f.get_main();if(!a)return d.error("No active scene"),null;var n=f.get_subs(a,v.STEREO);return n&&n.enable_hmd_stereo?(d.error_once("pick_object() is not available in the stereo rendering mode. Use scenes.pick_center instead."),r()):c.pick_object(e,t)},t.pick_center=r,t.outlining_is_enabled=function(e){return e&&e.render&&e.render.outlining},t.set_outline_intensity=function(e,t){e&&e.render&&e.render.outlining?c.set_outline_intensity(e,t):d.error("set_outline_intensity(): wrong object")},t.get_outline_intensity=function(e){return e&&e.render&&e.render.outlining?e.render.outline_intensity:(d.error("get_outline_intensity(): wrong object"),0)},t.apply_outline_anim=function(e,t,r,a){e&&e.render&&e.render.outlining?c.apply_outline_anim(e,t,r,a):d.error("apply_outline_anim(): wrong object")},t.apply_outline_anim_def=function(e){if(e&&e.render&&e.render.outlining){var t=e.render.outline_anim_settings_default;c.apply_outline_anim(e,t.outline_duration,t.outline_period,t.outline_relapses)}else d.error("apply_outline_anim_def(): wrong object")},t.clear_outline_anim=function(e){e&&e.render&&e.render.outlining?c.clear_outline_anim(e):d.error("clear_outline_anim(): wrong object")},t.set_outline_color=f.set_outline_color,t.get_outline_color=function(e){var t=f.get_active(),r=f.get_subs(t,v.OUTLINE);if(r)return(e=e||new Float32Array(3)).set(r.outline_color),e},t.set_hmd_params=function(e){f.check_active()?e&&(!e.distortion_coefs||e.distortion_coefs instanceof Array||(e.distortion_coefs=null),!e.chromatic_aberration_coefs||e.chromatic_aberration_coefs instanceof Array||(e.chromatic_aberration_coefs=null),"number"!=typeof e.base_line_factor&&(e.base_line_factor=null),"number"!=typeof e.inter_lens_factor&&(e.inter_lens_factor=null),"boolean"!=typeof e.enable_hmd_stereo&&(e.enable_hmd_stereo=null),f.set_hmd_params(e)):d.error("No active scene")},t.get_shadow_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active(),t=f.get_subs(e,v.SHADOW_CAST);if(!t)return null;var r=e._render.shadow_params,a=f.get_subs(e,v.MAIN_OPAQUE),n=f.get_subs(e,v.SHADOW_RECEIVE),_={};return _.csm_resolution=r.csm_resolution,_.self_shadow_polygon_offset=t.self_shadow_polygon_offset,n&&(_.self_shadow_normal_offset=n.self_shadow_normal_offset),_.enable_csm=r.enable_csm,_.csm_num=r.csm_num,_.csm_first_cascade_border=r.csm_first_cascade_border,_.first_cascade_blur_radius=r.first_cascade_blur_radius,_.csm_last_cascade_border=r.csm_last_cascade_border,_.last_cascade_blur_radius=r.last_cascade_blur_radius,_.fade_last_cascade=r.fade_last_cascade,_.blend_between_cascades=r.blend_between_cascades,r.enable_csm?(_.csm_borders=f.get_csm_borders(e,a.camera),_.blur_radii=new Float32Array(r.csm_num),_.blur_radii.set(a.camera.pcf_blur_radii.subarray(0,r.csm_num))):(_.csm_borders=null,_.blur_radii=null),_},t.set_shadow_params=function(e){if(f.check_active()){var t=f.get_active();"number"==typeof e.self_shadow_polygon_offset&&l.traverse(t._render.graph,function(t,r){r.type==v.SHADOW_CAST&&(r.self_shadow_polygon_offset=e.self_shadow_polygon_offset)});for(var r=f.subs_array(t,[v.SHADOW_RECEIVE]),a=0;a<r.length;a++){var n=r[a];"number"==typeof e.self_shadow_normal_offset&&(n.self_shadow_normal_offset=e.self_shadow_normal_offset),"number"==typeof e.pcf_blur_radius&&(n.pcf_blur_radius=e.pcf_blur_radius)}for(var o=f.subs_array(t,[v.MAIN_BLEND]),a=0;a<o.length;a++){var i=o[a];"number"==typeof e.self_shadow_normal_offset&&(i.self_shadow_normal_offset=e.self_shadow_normal_offset),"number"==typeof e.pcf_blur_radius&&(i.pcf_blur_radius=e.pcf_blur_radius),i.need_perm_uniforms_update=!0}var c=t._render.shadow_params;if("number"==typeof e.csm_first_cascade_border&&(c.csm_first_cascade_border=e.csm_first_cascade_border),"number"==typeof e.first_cascade_blur_radius&&(c.first_cascade_blur_radius=e.first_cascade_blur_radius),"number"==typeof e.csm_last_cascade_border&&(c.csm_last_cascade_border=e.csm_last_cascade_border),"number"==typeof e.last_cascade_blur_radius&&(c.last_cascade_blur_radius=e.last_cascade_blur_radius),n){for(var m=n.draw_data,a=0;a<m.length;a++)for(var p=m[a].bundles,h=0;h<p.length;h++){var b=p[h];if(b.obj_render.shadow_receive){var g=b.batch;_.assign_shadow_receive_dirs(g,c),_.update_shader(g),v.append_draw_data(n,b)}}n.need_perm_uniforms_update=!0}for(var y=u.get_scene_data(t._camera,t).cameras,a=0;a<y.length;a++)s.update_camera_shadows(y[a],c);f.schedule_shadow_update(t)}else d.error("No active scene")},t.get_environment_colors=function(){if(!f.check_active())return d.error("No active scene"),[];var e=f.get_active();return f.get_environment_colors(e)},t.set_environment_colors=function(e,t,r){if(f.check_active()){var a=f.get_active(),n=f.get_subs(a,v.MAIN_OPAQUE),_=e||0==e?parseFloat(e):n.environment_energy,s=t||0==t?t:n.horizon_color,o=r||0==r?r:n.zenith_color;f.set_environment_colors(a,_,s,o)}else d.error("No active scene")},t.get_fog_color_density=function(e){if(!f.check_active())return d.error("No active scene"),!1;var t=f.get_active();return f.get_fog_color_density(t,e)},t.set_fog_color_density=function(e){if(f.check_active()){var t=f.get_active();f.set_fog_color_density(t,e)}else d.error("No active scene")},t.get_fog_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active(),t={};return t.fog_intensity=f.get_fog_intensity(e),t.fog_depth=f.get_fog_depth(e),t.fog_start=f.get_fog_start(e),t.fog_height=f.get_fog_height(e),t},t.set_fog_params=function(e){if(f.check_active()){var t=f.get_active();"number"==typeof e.fog_intensity&&f.set_fog_intensity(t,e.fog_intensity),"number"==typeof e.fog_depth&&f.set_fog_depth(t,e.fog_depth),"number"==typeof e.fog_start&&f.set_fog_start(t,e.fog_start),"number"==typeof e.fog_height&&f.set_fog_height(t,e.fog_height)}else d.error("No active scene")},t.get_ssao_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_ssao_params(e)},t.set_ssao_params=function(e){if(f.check_active()){var t=f.get_active(),r=f.subs_array(t,[v.SSAO]),n=f.subs_array(t,[v.SSAO_BLUR]);if(!r.length)return d.error("SSAO is not enabled on the scene"),0;for(var _=0;_<r.length;_++)a(r[_],n[_],e)}else d.error("No active scene")},t.get_color_correction_params=function(){if(!f.check_active())return d.error("No active scene"),null;var e=f.get_active(),t=f.get_subs(e,v.COMPOSITING);if(!t)return null;var r={};return r.brightness=t.brightness,r.contrast=t.contrast,r.exposure=t.exposure,r.saturation=t.saturation,r},t.set_color_correction_params=function(e){if(f.check_active()){var t=f.get_active(),r=f.get_subs(t,v.COMPOSITING);r&&("brightness"in e&&(r.brightness=e.brightness),"contrast"in e&&(r.contrast=e.contrast),"exposure"in e&&(r.exposure=e.exposure),"saturation"in e&&(r.saturation=e.saturation),r.need_perm_uniforms_update=!0)}else d.error("No active scene")},t.get_sky_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_sky_params(e)},t.set_sky_params=function(e){if(f.check_active()){var t=f.get_active(),r=f.get_subs(t,v.SKY);r&&("color"in e&&r.sky_color.set(e.color),"rayleigh_brightness"in e&&(r.rayleigh_brightness=e.rayleigh_brightness),"mie_brightness"in e&&(r.mie_brightness=e.mie_brightness),"spot_brightness"in e&&(r.spot_brightness=e.spot_brightness),"scatter_strength"in e&&(r.scatter_strength=e.scatter_strength),"rayleigh_strength"in e&&(r.rayleigh_strength=e.rayleigh_strength),"mie_strength"in e&&(r.mie_strength=e.mie_strength),"rayleigh_collection_power"in e&&(r.rayleigh_collection_power=e.rayleigh_collection_power),"mie_collection_power"in e&&(r.mie_collection_power=e.mie_collection_power),"mie_distribution"in e&&(r.mie_distribution=e.mie_distribution),r.need_perm_uniforms_update=!0,r.need_fog_update=!0,f.update_sky(t,r))}else d.error("No active scene")},t.get_dof_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_subs(e,v.DOF)?f.get_dof_params(e):null},t.set_dof_params=function(e){if(f.check_active()){var t=f.get_active();f.set_dof_params(t,e)}else d.error("No active scene")},t.get_god_rays_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_subs(e,v.GOD_RAYS)?f.get_god_rays_params(e):null},t.set_god_rays_params=function(e){if(f.check_active()){var t=f.get_active();f.set_god_rays_params(t,e)}else d.error("No active scene")},t.get_bloom_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_subs(e,v.BLOOM)?f.get_bloom_params(e):null},t.set_bloom_params=function(e){if(f.check_active()){var t=f.get_active();f.set_bloom_params(t,e)}else d.error("No active scene")},t.get_glow_material_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_subs(e,v.GLOW_COMBINE)?f.get_glow_material_params(e):null},t.set_glow_material_params=function(e){if(f.check_active()){var t=f.get_active();f.set_glow_material_params(t,e)}else d.error("No active scene")},t.get_wind_params=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_wind_params(e)},t.set_wind_params=function(e){if(f.check_active()){var t=f.get_active();c.set_wind_params(t,e)}else d.error("No active scene")},t.get_water_surface_level=function(e,t){if(!f.check_active())return d.error("No active scene"),0;var r=f.get_active();return r._render.water_params?f.get_water_surface_level(r,e,t):(d.error("No water parameters on the active scene"),0)},t.set_water_params=function(e){if(f.check_active()){var t=f.get_active();f.set_water_params(t,e)}else d.error("No active scene")},t.get_water_mat_params=function(e){if(f.check_active()){var t=f.get_active();f.get_water_mat_params(t,e)}else d.error("No active scene")},t.update_scene_materials_params=function(){if(f.check_active()){var e=f.get_active();f.update_scene_permanent_uniforms(e)}else d.error("No active scene")},t.hide_object=function(e,t){t=t||!1,n(e)?t?f.change_visibility(e,!0):f.change_visibility_rec(e,!0):d.error("show/hide is only supported for dynamic objects.")},t.show_object=function(e,t){t=t||!1,n(e)?t?f.change_visibility(e,!1):f.change_visibility_rec(e,!1):d.error("show/hide is only supported for dynamic objects.")},t.is_hidden=function(e){return n(e)?f.is_hidden(e):(d.error("show/hide is only supported for dynamic meshes/empties and lamps"),!1)},t.is_visible=function(e){return e.render.is_visible},t.check_object_by_name=function(e,t){return!!c.get_object(c.GET_OBJECT_BY_NAME,e,0|t,!0)},t.check_object_by_dupli_name=function(e,t,r){return!!c.get_object(c.GET_OBJECT_BY_DUPLI_NAME,e,t,0|r)},t.check_object_by_dupli_name_list=function(e,t){return!!c.get_object(c.GET_OBJECT_BY_DUPLI_NAME_LIST,e,0|t)},t.get_all_objects=function(e,t){var r=f.get_active();return e||(e="ALL"),t||0===t||(t=c.DATA_ID_ALL),c.get_scene_objs_derived(r,e,t)},t.get_object_name=function(e){return e?e.origin_name:(d.error("Wrong object name"),"")},t.get_object_name_hierarchy=function(e){if(!e)return d.error("Wrong object name"),null;for(var t=[],r=e;r;)t.push(r.origin_name),r=u.get_dg_parent(r);return t.reverse()},t.get_object_type=function(e){return e&&e.type?e.type:(d.error("Wrong object"),"UNDEFINED")},t.get_object_children=function(e){return e.cons_descends.slice(0)},t.get_first_character=function(){return c.get_first_character(f.get_active())},t.get_shore_dist=function(e,t){if(t||0===t||(t=1),!f.check_active())return d.error("No active scene"),0;var r=f.get_active();return f.get_shore_dist(r,e,t)},t.get_cam_water_depth=function(){return f.get_cam_water_depth()},t.get_type_mesh_object=function(e){return u.is_mesh(e)?e.render.type:""},t.get_meta_tags=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_meta_tags(e)},t.get_custom_prop=function(){if(!f.check_active())return d.error("No active scene"),!1;var e=f.get_active();return f.get_custom_prop(e)},t.append_object=function(e,t){if(t)var r=f.get_all_scenes(),a=b.keysearch("name",t,r);else a=f.get_active();f.append_object(a,e,!0)},t.remove_object=function(e){u.is_dynamic_mesh(e)||u.is_empty(e)||u.is_line(e)?(c.obj_switch_cleanup_flags(e,e.render.is_copied_deep,!1,!1),i.prepare_object_unloading(e),c.obj_switch_cleanup_flags(e,!0,!0,!0),c.remove_object(e)):d.error("Can't remove object \""+e.name+'". It must be dynamic and type of MESH or EMPTY.')},t.marker_frame=function(e){var t=f.get_active();return t.timeline_markers&&e in t.timeline_markers?f.marker_frame(t,e):(d.error('"'+e+'" marker not found.'),0)},t.get_mb_params=function(){var e=f.get_active(),t=f.get_subs(e,v.MOTION_BLUR);return t?{mb_factor:t.mb_factor,mb_decay_threshold:t.mb_decay_threshold}:null},t.set_mb_params=function(e){var t=f.get_active(),r=f.subs_array(t,[v.MOTION_BLUR]);if(r.length)for(var a=0;a<r.length;a++){var n=r[a];"number"==typeof e.mb_decay_threshold&&(n.mb_decay_threshold=e.mb_decay_threshold),"number"==typeof e.mb_factor&&(n.mb_factor=e.mb_factor)}else d.error("The motion blur subscene doesn't exist.")},t.can_select_objects=function(){var e=f.get_active();return Boolean(f.get_subs(e,v.COLOR_PICKING))}}),xe=o("transform",function(e,t){var r=b(e),a=k(e),n=W(e),_=m(e),s=d(e),o=Y(e),i=v(e),l=h(e),c=i.create(),u=new Float32Array(3),f=new Float32Array(4);t.set_translation=function(e,t,r,s){a.is_dynamic(e)?(u[0]=t,u[1]=r,u[2]=s,o.set_translation(e,u),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_translation_rel=function(e,t,r,s){a.is_dynamic(e)?(u[0]=t,u[1]=r,u[2]=s,o.set_translation_rel(e,u),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_translation_v=function(e,t){a.is_dynamic(e)?(o.set_translation(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_translation_rel_v=function(e,t){a.is_dynamic(e)?(o.set_translation_rel(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_translation_obj_rel=function(e,t,r,s,c){if(a.is_dynamic(e)){u[0]=t,u[1]=r,u[2]=s;var d=i.get_trans_view(c.render.world_tsr),f=i.get_quat_view(c.render.world_tsr);l.transform_vec3(u,1,f,d,u),o.set_translation(e,u),o.update_transform(e),n.sync_transform(e)}else _.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_translation=function(e,t){return t||(t=new Float32Array(3)),o.get_translation(e,t),t},t.get_translation_rel=function(e,t){return t||(t=new Float32Array(3)),o.get_translation_rel(e,t),t},t.set_rotation=function(e,t,r,s,i){a.is_dynamic(e)?(f[0]=t,f[1]=r,f[2]=s,f[3]=i,o.set_rotation(e,f),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_rotation_rel=function(e,t,r,s,i){a.is_dynamic(e)?(f[0]=t,f[1]=r,f[2]=s,f[3]=i,o.set_rotation_rel(e,f),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_rotation_v=function(e,t){a.is_dynamic(e)?(o.set_rotation(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_rotation_rel_v=function(e,t){a.is_dynamic(e)?(o.set_rotation_rel(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_rotation_rel_v=function(e,t){if(a.is_dynamic(e))return o.get_rotation_rel(e,t),t;_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_rotation=function(e,t){return t||(t=new Float32Array(4)),o.get_rotation(e,t),t},t.get_rotation_rel=function(e,t){return t||(t=new Float32Array(4)),o.get_rotation_rel(e,t),t},t.set_rotation_euler=function(e,t,r,s){a.is_dynamic(e)?(u[0]=t,u[1]=r,u[2]=s,o.set_rotation_euler(e,u),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_rotation_euler=function(e,t){return t||(t=new Float32Array(3)),o.get_rotation_euler(e,t),t},t.get_rotation_euler_rel=function(e,t){return t||(t=new Float32Array(3)),o.get_rotation_euler_rel(e,t),t},t.set_rotation_euler_rel=function(e,t,r,s){a.is_dynamic(e)?(u[0]=t,u[1]=r,u[2]=s,o.set_rotation_euler_rel(e,u),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_rotation_euler_v=function(e,t){a.is_dynamic(e)?(o.set_rotation_euler(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_rotation_euler_rel_v=function(e,t){a.is_dynamic(e)?(o.set_rotation_euler_rel(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_scale=function(e,t){a.is_dynamic(e)?(o.set_scale(e,t),o.update_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_scale_rel=function(e,t){a.is_dynamic(e)?(o.set_scale_rel(e,t),o.update_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_scale=function(e){return o.get_scale(e)},t.get_scale_rel=function(e){return o.get_scale_rel(e)},t.empty_reset_transform=function(e){if("EMPTY"==e.type){for(var t=0;t<e.cons_descends.length;t++)if(!a.is_dynamic(e.cons_descends[t]))return void _.error('Wrong object: "'+e.cons_descends[t].name+'" is not dynamic.');o.set_translation(e,[0,0,0]),o.set_rotation(e,[0,0,0,1]),o.set_scale(e,1),o.update_transform(e),n.sync_transform(e)}else _.error("Wrong object: "+e.name)},t.get_object_size=function(e){return a.is_mesh(e)?o.get_object_size(e):(_.error("Wrong object: "+e.name),0)},t.get_object_center=function(e,t,r){return a.is_mesh(e)?(r||(r=new Float32Array(3)),o.get_object_center(e,t,r)):(_.error("Wrong object: "+e.name),null)},t.move_local=function(e,t,r,s){a.is_dynamic(e)?(o.move_local(e,t,r,s),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.rotate_x_local=function(e,t){if(a.is_dynamic(e)){var r=s.setAxisAngle(l.AXIS_X,t,f);o.rotate_local(e,r),o.update_transform(e),n.sync_transform(e)}else _.error('Wrong object: "'+e.name+'" is not dynamic.')},t.rotate_y_local=function(e,t){if(a.is_dynamic(e)){var r=s.setAxisAngle(l.AXIS_MY,t,f);o.rotate_local(e,r),o.update_transform(e),n.sync_transform(e)}else _.error('Wrong object: "'+e.name+'" is not dynamic.')},t.rotate_z_local=function(e,t){if(a.is_dynamic(e)){var r=s.setAxisAngle(l.AXIS_Z,t,f);o.rotate_local(e,r),o.update_transform(e),n.sync_transform(e)}else _.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_object_bounding_box=function(e){return r.clone_bb(e.render.bb_world)},t.set_tsr=function(e,t){a.is_dynamic(e)?(o.set_tsr(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_tsr_rel=function(e,t){a.is_dynamic(e)?(o.set_tsr_rel(e,t),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_tsr=function(e,t){return t||(t=new Float32Array(8)),o.get_tsr(e,t),t},t.get_tsr_rel=function(e,t){return t||(t=new Float32Array(8)),o.get_tsr_rel(e,t),t},t.distance=function(e,t){return o.distance(e,t)},t.set_matrix=function(e,t){a.is_dynamic(e)?(i.from_mat4(t,c),o.set_tsr(e,c),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.set_matrix_rel=function(e,t){a.is_dynamic(e)?(i.from_mat4(t,c),o.set_tsr_rel(e,c),o.update_transform(e),n.sync_transform(e)):_.error('Wrong object: "'+e.name+'" is not dynamic.')},t.get_matrix=function(e,t){return t||(t=new Float32Array(16)),o.get_tsr(e,c),i.to_mat4(c,t),t},t.get_matrix_rel=function(e,t){return t||(t=new Float32Array(16)),o.get_tsr_rel(e,c),i.to_mat4(c,t),t}}),Oe=o("util",function(e,t){var r=re(e),a=m(e),n=d(e),_=p(e),s=h(e),o=l(e);t.AXIS_X=new Float32Array([1,0,0]),t.AXIS_Y=new Float32Array([0,1,0]),t.AXIS_Z=new Float32Array([0,0,1]),t.AXIS_MX=new Float32Array([-1,0,0]),t.AXIS_MY=new Float32Array([0,-1,0]),t.AXIS_MZ=new Float32Array([0,0,-1]),t.XYX=s.XYX,t.YZY=s.YZY,t.ZXZ=s.ZXZ,t.XZX=s.XZX,t.YXY=s.YXY,t.ZYZ=s.ZYZ,t.XYZ=s.XYZ,t.YZX=s.YZX,t.ZXY=s.ZXY,t.XZY=s.XZY,t.YXZ=s.YXZ,t.ZYX=s.ZYX,t.f32=function(e){return e=e||0,s.f32(e)},t.assert=s.assert,t.keyfind=s.keyfind,t.keysearch=s.keysearch,t.matrix_to_quat=function(e){return s.matrix_to_quat(e)},t.euler_to_quat=function(e,t){return t||(t=new Float32Array(4)),s.euler_to_quat(e,t)},t.ordered_angles_to_quat=function(e,t,r){return r||(r=n.create()),s.ordered_angles_to_quat(e,t,r)},t.quat_to_ordered_angles=function(e,t,r){return r||(r=o.create()),s.quat_to_ordered_angles(e,t,r)},t.quat_to_euler=function(e,t){return t||(t=new Float32Array(3)),s.quat_to_euler(e,t)},t.sign=s.sign,t.clamp=s.clamp,t.quat_to_dir=s.quat_to_dir,t.ground_project_cam_quat=function(e,t){return s.quat_project(e,s.AXIS_MZ,s.AXIS_Z,s.AXIS_Y,t)},t.cam_quat_to_mesh_quat=function(e,t){return s.cam_quat_to_mesh_quat(e,t)},t.quat_project=function(e,t,r,n,_){return 0!=o.dot(r,n)?(a.error("Wrong in-plane direction"),null):s.quat_project(e,t,r,n,_)},t.hash_code=s.hash_code,t.smooth=s.smooth,t.smooth_v=s.smooth_v,t.is_vector=s.is_vector,t.correct_cam_quat_up=s.correct_cam_quat_up,t.quat_to_angle_axis=s.quat_to_angle_axis,t.random_from_array=s.random_from_array,t.horizontal_direction=s.horizontal_direction,t.angle_wrap_0_2pi=s.angle_wrap_0_2pi,t.angle_wrap_periodic=s.angle_wrap_periodic,t.smooth_step=s.smooth_step,t.lerp=s.lerp,t.deg_to_rad=s.deg_to_rad,t.rad_to_deg=s.rad_to_deg,t.dir_to_quat=s.dir_to_quat,t.is_ie11=r.is_ie11,t.gen_tbn_quats=_.get,t.trunc=s.trunc}),Re=(o("app",function(e,t){function r(){var e=C.is_paused();document.addEventListener("visibilitychange",function(){document.hidden?(e=C.is_paused(),C.pause()):e||C.resume()},!1)}function a(){var e=0,t=N.get_container(),r=C.is_paused(),a=!0;C.append_loop_cb(function(){if(e%Se==0){var n=t.getBoundingClientRect();n.top>window.innerHeight||n.bottom<0?(a&&(r=C.is_paused()),C.pause(),a=!1):r||a||(C.resume(),a=!0)}e++})}function n(e,t,r,a){var n=document.createElement("canvas"),_=document.getElementById(e);if(_||(D.error('Warning: canvas container "'+e+'" not found, appending to body'),_=document.body),n.style.position="absolute",n.style.left=0,n.style.top=0,n.style.width=_.offsetWidth+"px",n.style.height=_.offsetHeight+"px",n.width=_.offsetWidth*window.devicePixelRatio,n.height=_.offsetHeight*window.devicePixelRatio,t)(s=document.createElement("canvas")).style.position="absolute",n.style.left=0,n.style.top=0,s.style.pointerEvents="none";else var s=null;return _.appendChild(n),C.init(n,s)?(s&&N.insert_to_container(s,"LAST"),!0):(r&&y("Browser could not initialize WebGL","For more info visit","https://www.blend4web.com/doc/en/problems_and_solutions.html#problems-upon-startup",a),!1)}function _(e,t){e?(t&&(document.getElementById(t).style.display="block"),De=document.getElementById(e)):((De=document.createElement("div")).innerHTML=0,De.style.cssText="position:absolute;font-family: Arial, sans-serif;top: 20px;right: 20px;text-shadow: 0px 0px 6px #000;font-size: 40px;line-height: 50px;font-weight: bold;color: #fff;",N.insert_to_container(De,"JUST_AFTER_CANVAS"))}function s(e,t){var r=String(e);t&&(r+="/"+String(t)),De.innerHTML=r}function o(e){var t=document.getElementById(e),r=t.cloneNode(!0);return t.parentNode.replaceChild(r,t),r}function i(e,t,r){var a=Math.max(O.hover_get_distance(e),ie),n=B.get_rotation(e,Ve),_=G.quat_to_dir(n,t,We);_[2]=0,j.normalize(_,_),j.scale(_,a*r,_);var s=B.get_translation(e,qe);j.add(s,_,s),O.set_translation(e,s)}function c(e,t){var r=O.hover_get_vertical_limits(e,Ke);if(r.up!=r.down){var a=O.get_camera_angles(e,He)[1],n=(r.down-a)/(r.down-r.up),_=O.hover_get_distance_limits(e,Ke);n=Math.max(n,oe/_.max),O.rotate_camera(e,0,n*t)}}function u(e,t,r,a){t*=W,r*=W,a*=W,B.move_local(e,t,r,a)}function d(e){return e/(1-e)}function f(e,t,r){var a=O.target_get_distance(e),n=Math.abs(t),_=Math.pow(n*r,z-Math.pow(n*r,Y));t=t<0?a>Me?-a*_:0:a*d(_),B.move_local(e,0,0,t)}function p(e,t,r,a,n){for(var _=a*r,s=t;s>0;--s)n+=_,_=(a+=_)*r;return n}function h(e,t,r,a,n,_){if(_){var s=O.target_get_pivot(e,We),o=O.get_translation(e),i=j.dist(s,o)+a;a=t>0?p(e,t,-r,i,a):p(e,-t,d(r),i,a)}else a-=t*n*r;return a}function v(e,t,r,a,n,_){Ue=e,Fe=t,Be=r,Ge=a,je=n,ze=_;var s=F.get_active_camera();b(s);var o=!1,l=null,d=!1;switch(O.get_move_style(s)){case O.MS_TARGET_CONTROLS:o=!e;break;case O.MS_EYE_CONTROLS:l=F.get_first_character();break;case O.MS_STATIC:return;case O.MS_HOVER_CONTROLS:d=!0}var m=O.get_velocities(s,Xe),p=M.create_elapsed_sensor();if(P.has_simulated_physics(s)){var v=M.create_collision_sensor(s,null,!0);M.create_sensor_manifold(s,"CAMERA_COLLISION",M.CT_POSITIVE,[v],null,function(e,t,r){var a=M.get_sensor_payload(e,t,0).coll_dist;if(a<0){var n=M.get_sensor_payload(e,t,0).coll_norm,_=We;j.scale(n,-Ne*a,_);var s=B.get_translation(e,qe);j.add(s,_,s),B.set_translation_v(e,s)}})}if(l){var g=B.get_translation(s),y=B.get_rotation(s),E=G.cam_quat_to_mesh_quat(y);g[2]-=ke,P.set_transform(l,g,E),k.append_stiff_trans(s,l,[0,0,.5]);var R=new Float32Array(2),N=!0;P.set_character_move_type(l,P.CM_FLY),M.create_kb_sensor_manifold(s,"TOGGLE_CHAR_MOVE_TYPE",M.CT_SHOT,M.KEY_C,function(){N=!N,P.set_character_move_type(l,N?P.CM_FLY:P.CM_WALK)})}var I,S,C,D,U,z,Y,W,oe,ie,le,ce,ue=function(e,t,r){if(1==r){var a=M.get_sensor_value(e,t,0);switch(O.get_velocities(e,m),t){case"FORWARD":l?R[0]=1:d?(n=O.get_camera_angles(e,He)[1],i(e,_=Math.abs(n)>=Math.PI/4?G.AXIS_Y:G.AXIS_MZ,m.trans*re*a)):o?f(e,-m.zoom,a):u(e,0,0,-m.trans*a);break;case"BACKWARD":if(l)R[0]=-1;else if(d){var n=O.get_camera_angles(e,He)[1],_=Math.abs(n)>=Math.PI/4?G.AXIS_MY:G.AXIS_Z;i(e,_,m.trans*re*a)}else o?f(e,m.zoom,a):u(e,0,0,m.trans*a);break;case"UP":d?c(e,-m.zoom*ae*a):l||u(e,0,m.trans*a,0);break;case"DOWN":d?c(e,m.zoom*ae*a):l||u(e,0,-m.trans*a,0);break;case"LEFT":l?R[1]=1:d?i(e,G.AXIS_MX,m.trans*re*a):u(e,-m.trans*a,0,0);break;case"RIGHT":l?R[1]=-1:d?i(e,G.AXIS_X,m.trans*re*a):u(e,m.trans*a,0,0);break;case"ROT_LEFT":o?O.rotate_camera(e,-m.rot*Q*a,0):O.rotate_camera(e,m.rot*Q*a,0);break;case"ROT_RIGHT":o?O.rotate_camera(e,m.rot*Q*a,0):O.rotate_camera(e,-m.rot*Q*a,0);break;case"ROT_UP":o?O.rotate_camera(e,0,-m.rot*Q*a):O.rotate_camera(e,0,m.rot*Q*a);break;case"ROT_DOWN":o?O.rotate_camera(e,0,m.rot*Q*a):O.rotate_camera(e,0,-m.rot*Q*a)}}else switch(t){case"FORWARD":case"BACKWARD":l&&(R[0]=0);break;case"LEFT":case"RIGHT":l&&(R[1]=0)}if(l){P.set_character_move_dir(l,R[0],R[1]);var s=O.get_camera_angles_char(e,Ye);P.set_character_rotation_h(l,s[0]),P.set_character_vert_move_dir_angle(l,s[1])}};if(_)Y=W=oe=ie=le=ce=M.create_custom_sensor(0);else{var de=L.check_enable_gamepad_indices();if(de.length)fe=de[de.length-1];else var fe=0;Y=M.create_gamepad_btn_sensor(L.GMPD_BUTTON_6,fe),W=M.create_gamepad_btn_sensor(L.GMPD_BUTTON_7,fe),oe=M.create_gamepad_axis_sensor(L.GMPD_AXIS_0,de),ie=M.create_gamepad_axis_sensor(L.GMPD_AXIS_1,de),le=M.create_gamepad_axis_sensor(L.GMPD_AXIS_2,de),ce=M.create_gamepad_axis_sensor(L.GMPD_AXIS_3,de)}t?I=S=C=D=U=z=M.create_custom_sensor(0):(I=M.create_keyboard_sensor(M.KEY_W),S=M.create_keyboard_sensor(M.KEY_S),C=M.create_keyboard_sensor(M.KEY_A),D=M.create_keyboard_sensor(M.KEY_D),U=M.create_keyboard_sensor(M.KEY_R),z=M.create_keyboard_sensor(M.KEY_F));var me=M.create_keyboard_sensor(M.KEY_UP),pe=M.create_keyboard_sensor(M.KEY_DOWN),he=M.create_keyboard_sensor(M.KEY_LEFT),ve=M.create_keyboard_sensor(M.KEY_RIGHT),be=function(e){return e[0]&&(e[1]||e[2]||e[3])},ge=function(e){return e[0]&&(e[1]||e[2]>Le)},ye=function(e){return e[0]&&(e[1]||e[2]<-Le)},Ee=function(e){return e[0]&&(e[1]||e[2]||e[3]>Le)},we=function(e){return e[0]&&(e[1]||e[2]||e[3]<-Le)};if(d||(M.create_sensor_manifold(s,"FORWARD",M.CT_CONTINUOUS,[p,I,ie],ye,ue),M.create_sensor_manifold(s,"BACKWARD",M.CT_CONTINUOUS,[p,S,ie],ge,ue)),o?(M.create_sensor_manifold(s,"ROT_UP",M.CT_CONTINUOUS,[p,me,U,ce],we,ue),M.create_sensor_manifold(s,"ROT_DOWN",M.CT_CONTINUOUS,[p,pe,z,ce],Ee,ue),M.create_sensor_manifold(s,"ROT_LEFT",M.CT_CONTINUOUS,[p,he,C,le],we,ue),M.create_sensor_manifold(s,"ROT_RIGHT",M.CT_CONTINUOUS,[p,ve,D,le],Ee,ue)):d?(M.create_sensor_manifold(s,"LEFT",M.CT_CONTINUOUS,[p,he,C,oe],we,ue),M.create_sensor_manifold(s,"RIGHT",M.CT_CONTINUOUS,[p,ve,D,oe],Ee,ue),M.create_sensor_manifold(s,"FORWARD",M.CT_CONTINUOUS,[p,me,I,ie],we,ue),M.create_sensor_manifold(s,"BACKWARD",M.CT_CONTINUOUS,[p,pe,S,ie],Ee,ue),M.create_sensor_manifold(s,"UP",M.CT_CONTINUOUS,[p,z,ce],ge,ue),M.create_sensor_manifold(s,"DOWN",M.CT_CONTINUOUS,[p,U,ce],ye,ue)):(M.create_sensor_manifold(s,"UP",M.CT_CONTINUOUS,[p,U,Y],be,ue),M.create_sensor_manifold(s,"DOWN",M.CT_CONTINUOUS,[p,z,W],be,ue),M.create_sensor_manifold(s,"LEFT",M.CT_CONTINUOUS,[p,C,oe],ye,ue),M.create_sensor_manifold(s,"RIGHT",M.CT_CONTINUOUS,[p,D,oe],ge,ue),M.create_sensor_manifold(s,"ROT_UP",M.CT_CONTINUOUS,[p,me,ce],ye,ue),M.create_sensor_manifold(s,"ROT_DOWN",M.CT_CONTINUOUS,[p,pe,ce],ge,ue),M.create_sensor_manifold(s,"ROT_LEFT",M.CT_CONTINUOUS,[p,he,le],ye,ue),M.create_sensor_manifold(s,"ROT_RIGHT",M.CT_CONTINUOUS,[p,ve,le],ge,ue)),!r){var Ae=0,Te=M.create_mouse_wheel_sensor(a),xe=0,Oe=M.create_touch_zoom_sensor(a);M.create_sensor_manifold(s,"MOUSE_WHEEL",M.CT_LEVEL,[Te],null,function(e,t,r){if(1==r){var a=M.get_sensor_value(e,t,0);if(O.get_velocities(e,m),o||d)Ae=h(e,a,m.zoom,Ae,_e,o);else{var n=a*m.zoom;m.trans*=1+n,O.set_velocities(e,m)}}}),M.create_sensor_manifold(s,"TOUCH_ZOOM",M.CT_LEVEL,[Oe],null,function(e,t,r,a){if(1==r){var n=M.get_sensor_value(e,t,0);O.get_velocities(e,m),M.get_sensor_payload(e,t,0)===M.PL_MULTITOUCH_MOVE_ZOOM&&(xe=h(e,n,m.zoom*H,xe,se,o))}}),M.create_sensor_manifold(s,"ZOOM_INTERPOL",M.CT_POSITIVE,[p],null,function(e,t,r){if(o||d)if(Math.abs(Ae)>Ie||Math.abs(xe)>Ie){var a=M.get_sensor_value(e,t,0),n=G.smooth(Ae,0,a,w());Ae-=n;var _=G.smooth(xe,0,a,A());if(xe-=_,d)c(e,-(n+_));else{var s=O.target_get_distance(e)+n+_;s=Math.max(s,Me),O.target_set_distance(e,s)}}else Ae=0,xe=0})}var Re=0,Se=0,De=0,Ve=0,Ke=function(e,t,r,a){if(1==r){var n=M.get_sensor_value(e,t,1);if(O.get_velocities(e,m),d)var _=J*m.trans,s=$*m.rot;else var _=V*m.rot,s=X*m.trans;1===M.get_sensor_payload(e,t,0).which?(Re+="X"==a?-n*_:0,Se+="Y"==a?-n*_:0):2!==M.get_sensor_payload(e,t,0).which&&3!==M.get_sensor_payload(e,t,0).which||(De+="X"==a?-n*s:0,Ve+="Y"==a?-n*s:0)}},Ze=0,Qe=0;if(!_){var Je=function(e,t,r){O.get_velocities(e,m),Ze+=m.trans*Ce},$e=function(e,t,r){O.get_velocities(e,m),Ze-=m.trans*Ce};o?(M.create_sensor_manifold(s,"GMPD_PAN_Y_POS",M.CT_CONTINUOUS,[Y],null,function(e,t,r){O.get_velocities(e,m),Qe+=m.zoom*Pe}),M.create_sensor_manifold(s,"GMPD_PAN_Y_NEG",M.CT_CONTINUOUS,[W],null,function(e,t,r){O.get_velocities(e,m),Qe-=m.zoom*Pe}),M.create_sensor_manifold(s,"GMPD_PAN_X_POS",M.CT_CONTINUOUS,[oe],function(e){return e[0]<-Le},$e),M.create_sensor_manifold(s,"GMPD_PAN_X_NEG",M.CT_CONTINUOUS,[oe],function(e){return e[0]>Le},Je)):d&&(M.create_sensor_manifold(s,"GMPD_PAN_X_POS",M.CT_CONTINUOUS,[le],function(e){return e[0]<-Le},$e),M.create_sensor_manifold(s,"GMPD_PAN_X_NEG",M.CT_CONTINUOUS,[le],function(e){return e[0]>Le},Je))}if(n){var et=M.create_mouse_move_sensor("X",window),tt=M.create_mouse_move_sensor("Y",window),rt=M.create_mouse_click_sensor(a),at=M.create_mouse_click_sensor(window),nt=!1,_t=function(e){return e[2]?nt=!0:e[0]||(nt=!1),nt&&e[0]};M.create_sensor_manifold(s,"MOUSE_X",M.CT_POSITIVE,[at,et,rt],_t,Ke,"X"),M.create_sensor_manifold(s,"MOUSE_Y",M.CT_POSITIVE,[at,tt,rt],_t,Ke,"Y");var st=L.get_device_by_type_element(L.DEVICE_MOUSE,window);L.switch_prevent_default(st,!1)}else{var et=M.create_mouse_move_sensor("X",a),tt=M.create_mouse_move_sensor("Y",a),ot=M.create_mouse_click_sensor(a);M.create_sensor_manifold(s,"MOUSE_X",M.CT_POSITIVE,[ot,et],null,Ke,"X"),M.create_sensor_manifold(s,"MOUSE_Y",M.CT_POSITIVE,[ot,tt],null,Ke,"Y")}var it=0,lt=0,ct=0,ut=0,dt=M.create_touch_move_sensor("X",a),ft=M.create_touch_move_sensor("Y",a),mt=function(e,t,r,a){if(1==r){if(O.get_velocities(e,m),d)n=ee*m.trans;else var n=K*m.rot;var _=M.get_sensor_value(e,t,0);if(M.get_sensor_payload(e,t,0).gesture===M.PL_SINGLE_TOUCH_MOVE)it+="X"==a?-_*n:0,lt+="Y"==a?-_*n:0;else if(M.get_sensor_payload(e,t,0).gesture===M.PL_MULTITOUCH_MOVE_PAN){if(d)s=te*m.rot;else var s=Z*m.trans;ct+="X"==a?-_*s:0,ut+="Y"==a?-_*s:0}}};M.create_sensor_manifold(s,"TOUCH_X",M.CT_POSITIVE,[dt],null,mt,"X"),M.create_sensor_manifold(s,"TOUCH_Y",M.CT_POSITIVE,[ft],null,mt,"Y"),M.create_sensor_manifold(s,"ROT_TRANS_INTERPOL",M.CT_POSITIVE,[p],null,function(e,t,r){if(Math.abs(Re)>Ie||Math.abs(Se)>Ie||Math.abs(it)>Ie||Math.abs(lt)>Ie||Math.abs(De)>Ie||Math.abs(Ve)>Ie||Math.abs(ct)>Ie||Math.abs(ut)>Ie||Math.abs(Ze)>Ie||Math.abs(Qe)>Ie){var a=M.get_sensor_value(e,t,0),n=G.smooth(Re,0,a,T()),_=G.smooth(Se,0,a,T());Re-=n,Se-=_;var s=G.smooth(it,0,a,x()),c=G.smooth(lt,0,a,x());it-=s,lt-=c;var u=G.smooth(De,0,a,T()),f=G.smooth(Ve,0,a,T());De-=u,Ve-=f;var m=G.smooth(ct,0,a,x()),p=G.smooth(ut,0,a,x());ct-=m,ut-=p;var h=G.smooth(Ze,0,a,T()),v=G.smooth(Qe,0,a,T());if(Ze-=h,Qe-=v,o){O.rotate_camera(e,n+s,_+c);var b=O.target_get_distance(e);O.target_pan_pivot(e,b*(u+m+h),b*(f+p+v))}else if(d){if(n+s&&i(e,G.AXIS_X,(n+s)*ne),_+c){var g=O.get_camera_angles(e,He)[1];i(e,Math.abs(g)>Math.PI/4?G.AXIS_MY:G.AXIS_Z,(_+c)*ne)}O.rotate_camera(e,u+m+h,0)}else if(O.rotate_camera(e,(n+s)*q,(_+c)*q),l){var y=O.get_camera_angles_char(e,Ye);P.set_character_rotation_h(l,y[0]),P.set_character_vert_move_dir_angle(l,y[1])}}}),M.create_kb_sensor_manifold(s,"DEC_STEREO_DIST",M.CT_SHOT,M.KEY_LEFT_SQ_BRACKET,function(e,t,r){var a=O.get_stereo_distance(e);O.set_stereo_distance(e,.9*a)}),M.create_kb_sensor_manifold(s,"INC_STEREO_DIST",M.CT_SHOT,M.KEY_RIGHT_SQ_BRACKET,function(e,t,r){var a=O.get_stereo_distance(e);O.set_stereo_distance(e,1.1*a)})}function b(e){var t=O.get_move_style(e),r=M.create_callback_sensor(function(){var r=O.get_move_style(e),a=r!=t;return t=r,a});M.create_sensor_manifold(e,"CHANGE_MOVE_STYLE",M.CT_POSITIVE,[r],null,function(e,t,r){g(),v(Ue,Fe,Be,Ge,je,ze)})}function g(){var e=F.get_active_camera();M.check_sensor_manifold(e,"TOGGLE_CHAR_MOVE_TYPE")&&F.get_first_character()&&k.remove(e);for(var t=["FORWARD","BACKWARD","ROT_UP","ROT_DOWN","ROT_LEFT","ROT_RIGHT","UP","DOWN","LEFT","RIGHT","MOUSE_WHEEL","TOUCH_ZOOM","ZOOM_INTERPOL","MOUSE_X","MOUSE_Y","TOUCH_X","TOUCH_Y","ROT_TRANS_INTERPOL","CHANGE_MOVE_STYLE","TOGGLE_CHAR_MOVE_TYPE"],r=0;r<t.length;r++)M.remove_sensor_manifold(e,t[r])}function y(e,t,r,a){var n=document.createElement("div"),_=document.createElement("div"),s=document.createElement("div");if(a)for(var o=0;o<a.length;o++){var i=document.getElementById(a[o]);i&&i.parentNode.removeChild(i)}n.style.cssText="z-index:10;width:100%;height:auto;position:absolute;top:50%;margin-top:150px;text-align:center;",_.style.cssText="color:#fff;font-size:24px;",s.style.cssText="color:#fff;font-size:20px;",_.innerHTML=e,s.innerHTML=t+'   <a style="color:#fff;font-size:20px;width:100%;" href="'+r+'">'+r.replace("https://www.","")+"</a>",n.appendChild(_),n.appendChild(s),document.body.appendChild(n)}function E(e,t,r,a,n){function _(){var o=performance.now()-s;n(t+o*(r-t)/a),(o>=a||!e.parentNode)&&C.remove_loop_cb(_)}var s=performance.now();C.append_loop_cb(_)}function w(){return ce*le}function A(){return ue*le}function T(){return ye*le}function x(){return Re*le}var O=de(e),R=fe(e),k=me(e),N=pe(e),M=he(e),I=ve(e),S=be(e),L=ge(e),C=Ee(e),P=we(e),D=m(e),U=Ae(e),F=Te(e),B=xe(e),G=Oe(e),j=l(e),z=1,Y=.15,H=.03,W=5,q=.5,V=.003,X=75e-5,K=.003,Z=75e-5,Q=.75,J=.003,$=75e-5,ee=.003,te=.003,re=.5,ae=30,ne=.2,_e=2,se=2,oe=2,ie=1,le=1,ce=.1,ue=.15,ye=.08,Re=.12,ke=.5,Ne=.25,Me=.001,Ie=1e-5,Se=10,Le=.1,Ce=.002,Pe=.05,De=null,Ue=!1,Fe=!1,Be=!1,Ge=null,je=!1,ze=!1,Ye=new Float32Array(2),He=new Float32Array(2),We=new Float32Array(3),qe=new Float32Array(3),Ve=new Float32Array(4),Xe={},Ke={};t.init=function(e){e=e||{};var t=!1,o=null,i=function(){},l=null,c=null,u=0,d=null,f=!0,m=!1,p=!0,h=!0,v=!1,b=!1,g=!1,y=!1,E=R.get("quality");for(var w in e)switch(w){case"canvas_container_id":o=e.canvas_container_id;break;case"callback":i=e.callback;break;case"autoresize":t=e.autoresize;break;case"show_hud_debug_info":g=e.show_hud_debug_info;break;case"sfx_mix_mode":v=e.sfx_mix_mode;break;case"show_fps":b=e.show_fps;break;case"track_container_position":y=e.track_container_position,D.error_once("track_container_position deprecated. Not needed anymore. Use the container.get_coords_target_space method.");break;case"fps_wrapper_id":d=e.fps_wrapper_id;break;case"fps_elem_id":c=e.fps_elem_id;break;case"error_purge_elements":l=e.error_purge_elements;break;case"report_init_failure":h=e.report_init_failure;break;case"pause_invisible":p=e.pause_invisible;break;case"key_pause_enabled":f=e.key_pause_enabled;break;case"force_container_ratio":u=e.force_container_ratio;break;case"min_capabilities":m=e.min_capabilities;break;case"quality":E=e.quality;break;default:R.set(w,e[w])}E!=R.P_AUTO&&R.set("quality",E),f&&document.addEventListener("keydown",function(e){e.keyCode==M.KEY_P&&(C.is_paused()?C.resume():C.pause())},!1),R.set("show_hud_debug_info",g),R.set("sfx_mix_mode",v);var A=g||v||null,T=function(){var e=n(o,A,h,l),f=N.get_canvas();if(e){var v=N.get_container();N.resize_to_container(),b&&(_(c,d),C.set_fps_callback(s)),p&&(r(),a()),u&&C.append_loop_cb(function(){v.style.height=v.clientWidth/u+"px"}),t&&C.append_loop_cb(function(){N.resize_to_container()}),y&&C.append_loop_cb(function(){N.force_offsets_updating()}),m&&R.reset_limits(),E==R.P_AUTO?S.test_performance(function(e,t){0==e?(D.log("QUALITY TEST RESULT: UNSUPPORTED, using HIGH"),R.apply_quality(R.P_HIGH)):t<1.5?(D.log("QUALITY TEST RESULT: LOW ("+t.toFixed(1)+" GB/s)"),R.apply_quality(R.P_LOW)):(D.log("QUALITY TEST RESULT: HIGH ("+t.toFixed(1)+" GB/s)"),R.apply_quality(R.P_HIGH)),i(f,!0)}):i(f,!0)}else i(f,!1)};"complete"==document.readyState?window.setTimeout(T,0):window.addEventListener("load",T,!1),window.addEventListener("unload",function(){I.cleanup()},!1)},t.set_onclick=function(e,t){var r=o(e);r.addEventListener("mouseup",function(e){t(r.value)},!1)},t.set_onchange=function(e,t){var r=o(e);r.addEventListener("change",function(e){var a=r.checked,n=void 0!=a?a:r.value;t(n)},!1)},t.set_onkeypress=function(e,t){var r=o(e);r.addEventListener("keypress",function(e){t(e.keyCode,r.value)},!1)},t.enable_camera_controls=v,t.disable_camera_controls=g,t.enable_object_controls=function(e,t){var r=P.is_vehicle_chassis(e)||P.is_vehicle_hull(e),a=function(e,t,a){if(1==a){var n=M.get_sensor_value(e,t,0);switch(t){case"FORWARD":r?P.vehicle_throttle(e,1):B.move_local(e,0,-1*n,0);break;case"BACKWARD":r?P.vehicle_throttle(e,-1):B.move_local(e,0,1*n,0);break;case"LEFT":r?P.vehicle_steer(e,-1):B.move_local(e,1*n,0,0);break;case"RIGHT":r?P.vehicle_steer(e,1):B.move_local(e,-1*n,0,0)}}else switch(t){case"FORWARD":case"BACKWARD":r&&P.vehicle_throttle(e,0);break;case"LEFT":case"RIGHT":r&&P.vehicle_steer(e,0)}},n=M.create_elapsed_sensor(),_=M.create_keyboard_sensor(M.KEY_W),s=M.create_keyboard_sensor(M.KEY_S),o=M.create_keyboard_sensor(M.KEY_A),i=M.create_keyboard_sensor(M.KEY_D),l=M.create_keyboard_sensor(M.KEY_UP),c=M.create_keyboard_sensor(M.KEY_DOWN),u=M.create_keyboard_sensor(M.KEY_LEFT),d=M.create_keyboard_sensor(M.KEY_RIGHT),f=function(e){return e[0]&&(e[1]||e[2])};M.create_sensor_manifold(e,"FORWARD",M.CT_CONTINUOUS,[n,_,l],f,a),M.create_sensor_manifold(e,"BACKWARD",M.CT_CONTINUOUS,[n,s,c],f,a),M.create_sensor_manifold(e,"LEFT",M.CT_CONTINUOUS,[n,o,u],f,a),M.create_sensor_manifold(e,"RIGHT",M.CT_CONTINUOUS,[n,i,d],f,a)},t.disable_object_controls=function(e){for(var t=["FORWARD","BACKWARD","LEFT","RIGHT"],r=0;r<t.length;r++)M.remove_sensor_manifold(e,t[r])},t.enable_debug_controls=function(){M.create_kb_sensor_manifold(null,"CAMERA_SHOT",M.CT_SHOT,M.KEY_K,function(){S.make_camera_frustum_shot()}),M.create_kb_sensor_manifold(null,"LIGHT_SHOT",M.CT_SHOT,M.KEY_L,function(){S.make_light_frustum_shot()}),M.create_kb_sensor_manifold(null,"TELEMETRY",M.CT_SHOT,M.KEY_T,function(){S.plot_telemetry()})},t.request_fullscreen=function(e,t,r){D.error_deprecated("request_fullscreen","screen.request_fullscreen"),U.request_fullscreen(e,t,r)},t.exit_fullscreen=function(){D.error_deprecated("exit_fullscreen","screen.exit_fullscreen"),U.exit_fullscreen()},t.check_fullscreen=function(){return D.error_deprecated("check_fullscreen","screen.check_fullscreen"),U.check_fullscreen()},t.report_app_error=y,t.get_url_params=function(e){e=!!e;var t=decodeURIComponent(location.href.toString());if(-1==t.indexOf("?"))return null;for(var r=t.split("?")[1].split("&"),a={},n=0;n<r.length;n++){var _=r[n].split("="),s=_[0];if(_.length>1){var o=_[1];e?s in a?a[s].push(o):a[s]=[o]:a[s]=o}else e?s in a||(a[s]=[]):a[s]=""}return a},t.css_animate=function(e,t,r,a,n,_,s,o){if(e&&t&&isFinite(r)&&isFinite(a)&&isFinite(n)){_=_||"",s=s||"",o=o||function(){};var i=e.style,l=t.charAt(0).toUpperCase()+t.slice(1);if(void 0!=i[t]);else if(void 0!=i["webkit"+l])t="webkit"+l;else if(void 0!=i["ms"+l])t="ms"+l;else{if(void 0==i["moz"+l])return;t="moz"+l}E(e,r,a,n,function(n){e&&(i[t]=_+n+s,(r>a&&n<=a||r<a&&n>=a)&&(i[t]=_+a+s,o()))})}},t.attr_animate=function(e,t,r,a,n,_){e&&t&&isFinite(r)&&isFinite(a)&&isFinite(n)&&(_=_||function(){},E(e,r,a,n,function(n){e&&(n>=0&&e.setAttribute(t,n),(r>a&&n<=a||r<a&&n>=a)&&(e.setAttribute(t,a),_()))}))},t.queue_animate=function(e){if(e.length){var r=e.shift(),a=r.elem,n=r.prop,_=r.from,s=r.to,o=r.duration,i=r.opt_prefix,l=r.opt_suffix,c=function(){r.cb&&r.cb(),t.queue_animate(e)};"css"==r.type?t.css_animate(a,n,_,s,o,i,l,c):"attr"==r.type&&t.attr_animate(a,n,_,s,o,c)}},t.set_camera_smooth_factor=function(e){le=e},t.get_camera_smooth_factor=function(){return le}}),o("time",function(e,t){var r=x(e);t.set_timeout=r.set_timeout,t.clear_timeout=r.clear_timeout,t.get_timeline=r.get_timeline,t.animate=r.animate,t.clear_animation=r.clear_animation})),ke=o("tsr",function(e,t){var r=i(e),a=v(e);t.create=a.create,t.from_values=a.from_values,t.copy=a.copy,t.identity=a.identity,t.set_sep=a.set_sep,t.set_trans=a.set_trans,t.set_scale=a.set_scale,t.set_transcale=a.set_transcale,t.set_quat=a.set_quat,t.get_trans_view=a.get_trans_view,t.get_scale=a.get_scale,t.get_quat_view=a.get_quat_view,t.invert=a.invert,t.to_mat4=function(e,t){return t||(t=r.create()),a.to_mat4(e,t),t},t.from_mat4=a.from_mat4,t.multiply=a.multiply,t.transform_vec3=a.transform_vec3,t.transform_vec3_inv=a.transform_vec3_inv,t.transform_vectors=a.transform_vectors,t.transform_dir_vectors=a.transform_dir_vectors,t.transform_dir_vec3=a.transform_dir_vec3,t.transform_tangents=a.transform_tangents,t.translate=a.translate,t.interpolate=function(e,t,r,n){return n||(n=a.create()),a.interpolate(e,t,r,n),n}}),Ne=(o("camera_anim",function(e,t){function r(e,t,r){var _=a(e,n.get_camera_angles(e,v)[0],t.left,t.right,b);return r*Math.min(1,_[0]/p,_[1]/p)}function a(e,t,r,a,_){var s=d.angle_wrap_0_2pi(t-r),o=Math.min(s,2*Math.PI-s),i=d.angle_wrap_0_2pi(a-t),l=Math.min(i,2*Math.PI-i);return(Math.abs(o)<h||2*Math.PI-Math.abs(o)<h)&&(o=0),(Math.abs(l)<h||2*Math.PI-Math.abs(l)<h)&&(l=0),n.is_eye_camera(e)?(_[0]=l,_[1]=o):(_[0]=o,_[1]=l),_}var n=de(e),_=he(e),s=m(e),o=Te(e),i=Re(e),c=xe(e),u=ke(e),d=Oe(e),f=l(e),p=.2,h=1e-6,v=new Float32Array(2),b=new Float32Array(2),g=new Float32Array(3),y=new Float32Array(3),E=new Float32Array(3),w=u.create(),A=u.create(),T=u.create(),x={},O=!1,R=!1,k=!1,N=!1;t.track_to_target=function(e,t,r,a,o,l,u,m){if(n.is_eye_camera(e)){if(d.is_vector(t))p=t;else{var p=g;c.get_object_center(t,!1,p)}r=r||1,a=a||2,o=o||1,l=l||1;var h=c.get_translation(e,y),w=f.subtract(p,h,E),A=n.get_camera_angles(e,v),T=n.get_camera_angles_dir(w,b),x=T[0]-A[0],O=T[1]-A[1],R=Math.acos(Math.cos(x)*Math.cos(O)),k=Math.abs(R/r),N=f.length(w)*(1-1/a),M=function(e){return 6*e*(1-e)},I=i.get_timeline(),S=0,L=function(){_.remove_sensor_manifold(e,"TRACK_TO_TARGET"),u&&u()},C=_.create_timeline_sensor(),P=_.create_elapsed_sensor();_.create_sensor_manifold(e,"TRACK_TO_TARGET",_.CT_CONTINUOUS,[C,P],null,function(t,r,a){if(n.is_eye_camera(t)){if(1==a){var s=_.get_sensor_value(t,r,0)-I,i=_.get_sensor_value(t,r,1);if(s<k){var u=(f=M(s/k))*x*i/k,d=f*O*i/k;n.rotate_camera(e,u,d)}else if(s<k+o)0==S&&(n.rotate_camera(e,T[0],T[1],!0),S++),p=(f=M(s-k/o))*N*i/o,c.move_local(t,0,0,-p);else if(s<k+o+l)S<=1&&(n.rotate_camera(e,T[0],T[1],!0),n.eye_set_look_at(e,h),c.move_local(t,0,0,-N),m&&m(),S++);else if(s<k+o+l+o){S<=2&&(n.rotate_camera(e,T[0],T[1],!0),n.eye_set_look_at(e,h),c.move_local(t,0,0,-N),S++);var f=M(s-k-o-l/o),p=f*N*i/o;c.move_local(t,0,0,p)}else n.rotate_camera(e,T[0],T[1],!0),n.eye_set_look_at(e,h),L()}}else L()})}else s.error("track_to_target(): Wrong camera object or camera move style")},t.auto_rotate=function(e,t,i){function l(t){(h=h||{}).left=t.left,h.right=t.right,g=Math.min(p,d.angle_wrap_0_2pi(h.right-h.left)/2),y=r(m,h,e)}function c(t,r){var s=_.get_sensor_value(t,r,0),o=a(t,n.get_camera_angles(t,v)[0],h.left,h.right,b);o[1]>g&&o[0]>g?y=d.sign(y)*e:o[1]<g?y-=Math.pow(e,2)/(2*p)*s:o[0]<g&&(y+=Math.pow(e,2)/(2*p)*s),n.rotate_camera(t,s*y,0)}function u(t,r){var a=_.get_sensor_value(t,r,0);n.rotate_camera(t,a*e,0)}function f(){_.remove_sensor_manifold(m,"AUTO_ROTATE"),_.remove_sensor_manifold(m,"DISABLE_AUTO_ROTATE"),t()}t=t||function(){};var m=o.get_active_camera();if(n.is_static_camera(m))s.error("auto_rotate(): Wrong camera move style");else{var h={},g=0,y=0;if(_.check_sensor_manifold(m,"AUTO_ROTATE"))f();else{var E=_.create_mouse_move_sensor("X"),w=_.create_mouse_move_sensor("Y"),A=_.create_mouse_click_sensor(),T=_.create_touch_move_sensor(),O=_.create_touch_zoom_sensor(),R=_.create_elapsed_sensor();if(i)k=_.create_mouse_wheel_sensor();else var k=_.create_custom_sensor(0);_.create_sensor_manifold(m,"DISABLE_AUTO_ROTATE",_.CT_LEVEL,[E,w,A,T,O,k],function(e){return e[0]&&e[2]||e[1]&&e[2]||e[3]||e[4]||e[5]},f),_.create_sensor_manifold(m,"AUTO_ROTATE",_.CT_CONTINUOUS,[R],function(e){return e[0]},function(e,t,r){if(1==r){var a=n.get_move_style(e);if(a==n.MS_STATIC)f();else if(a!=n.MS_TARGET_CONTROLS&&a!=n.MS_EYE_CONTROLS||!n.has_horizontal_rot_limits(e))h=null,u(e,t);else{var _=a==n.MS_EYE_CONTROLS?n.eye_get_horizontal_limits(e,x):n.target_get_horizontal_limits(e,x);null!==h&&_.left==h.left&&_.right==h.right||l(_),c(e,t)}}})}}},t.is_auto_rotate=function(){var e=o.get_active_camera();return _.check_sensor_manifold(e,"AUTO_ROTATE")},t.check_auto_rotate=function(){var e=o.get_active_camera();return n.get_move_style(e)!=n.MS_STATIC},t.move_camera_to_point=function(e,t,r,a,_){if(n.get_move_style(e)==n.MS_STATIC){if(!O)if(e)if(t){if(r=r||1,a=a||.01,d.is_vector(e))o=e;else var o=c.get_tsr(e,w);if(d.is_vector(t))l=t;else var l=c.get_tsr(t,A);var m=f.distance(u.get_trans_view(o),u.get_trans_view(l))/r,p=d.quat_to_dir(u.get_quat_view(o),d.AXIS_MZ,g),h=d.quat_to_dir(u.get_quat_view(l),d.AXIS_MZ,y),v=Math.min(Math.abs(f.dot(p,h)),1),b=Math.acos(v)/a,E=1e3*Math.max(m,b);O=!0;var x=i.animate(0,1,E,function(t){var r=u.interpolate(o,l,d.smooth_step(t),T);if(k)return i.clear_animation(x),k=!1,void(O=!1);c.set_tsr(e,r),1==t&&(O=!1,_&&_())})}else s.error("move_camera_to_point(): you must specify the point object");else s.error("move_camera_to_point(): you must specify the camera object")}else s.error("move_camera_to_point(): wrong camera type")},t.rotate_camera=function(e,t,r,a,_){function o(){R&&(R=!1,_&&_())}if(n.get_move_style(e)!=n.MS_STATIC){if(!R)if(e)if(t||r){a=a||1e3,R=!0;var l=0,c=i.animate(0,t,a,function(r){if(N||r>=t)return N=!1,i.clear_animation(c),void o();n.rotate_camera(e,l-r,0),l=r}),u=0,d=i.animate(0,r,a,function(t){if(N||t>=r)return N=!1,i.clear_animation(d),void o();n.rotate_camera(e,0,u-t),u=t})}else s.error("rotate_camera(): you must specify the rotation angle");else s.error("rotate_camera(): you must specify the camera object")}else s.error("rotate_camera(): not supported for STATIC cameras")},t.stop_cam_moving=function(){k=!0},t.stop_cam_rotating=function(){N=!0},t.is_moving=function(){return O},t.is_rotating=function(){return R}}),o("hmd",function(e,t){function r(){_.remove_sensor_manifold(null,"VR_CONTROLLERS")}function a(e,t){function r(t,r,a){if(a>0){var s=i.get_active_camera();if(!s)return;if(n.is_eye_camera(s)){var l=_.get_sensor_payload(t,r,1),c=_.get_sensor_payload(t,r,2),d=m.add(c,k,y);if(u.set_translation_v(s,d),l)if(e==M)l=o.multiply(R,l,O),W=m.transformQuat(f.AXIS_MY,l,y),n.set_vertical_axis(s,W),u.set_rotation_v(s,l);else if(e==I||e==S){var v=u.get_rotation(s,T),b=o.invert(v,T),g=o.multiply(p,b,T),N=n.get_vertical_axis(s,y);if(Math.abs(N[2])<Math.PI/4)L=m.cross(N,f.AXIS_MY,E);else if(Math.abs(N[1])<Math.PI/4)var L=m.cross(N,f.AXIS_Z,E);m.normalize(L,L);var C=m.transformQuat(L,g,w),P=m.dot(N,C),D=m.scaleAndAdd(C,N,-P,w);m.normalize(D,D);var U=m.cross(N,L,y),F=Math.acos(f.clamp(m.dot(L,D),0,1)),B=f.sign(m.dot(D,U));h+=F*B;var G=o.setAxisAngle(f.AXIS_Z,-h,T);if(e==S)H=o.multiply(G,l,A);else var j=f.quat_project(l,f.AXIS_MZ,f.AXIS_Z,f.AXIS_Y,x),z=o.invert(j,x),Y=o.multiply(z,l,x),H=o.multiply(G,Y,A);var W=m.transformQuat(f.AXIS_MY,H,y);n.set_vertical_axis(s,W),u.set_rotation_v(s,H),o.copy(H,p)}}}}if(t){var a=i.get_active_camera();a&&c.request_split_screen(function(){n.is_eye_camera(a)||(v=n.is_target_camera(a),b=n.is_hover_camera(a),g=n.is_static_camera(a),n.eye_setup(a));var e=_.create_elapsed_sensor(),s=_.create_hmd_position_sensor();p=u.get_rotation(a,p),_.create_sensor_manifold(null,"HMD_ROTATE_CAMERA",_.CT_CONTINUOUS,[e,t,s],null,r)})}}var n=de(e),_=he(e),s=ge(e),o=d(e),i=Te(e),c=Ae(e),u=xe(e),f=Oe(e),m=l(e),p=o.create(),h=0,v=!1,b=!1,g=!1,y=m.create(),E=m.create(),w=m.create(),A=o.create(),T=o.create(),x=o.create(),O=o.create(),R=o.create(),k=m.create(),N={pivot:m.create()};t.HMD_NONE_MOUSE_ALL_AXES=0;var M=1;t.HMD_ALL_AXES_MOUSE_NONE=M;var I=2;t.HMD_ROLL_PITCH_MOUSE_YAW=I;var S=3;t.HMD_ALL_AXES_MOUSE_YAW=S,t.enable_hmd=function(e){var t=s.get_device_by_type_element(s.DEVICE_HMD);t&&a(e,s.get_value_param(t,s.HMD_WEBVR_TYPE)&(s.HMD_WEBVR_MOBILE|s.HMD_WEBVR_DESKTOP|s.HMD_WEBVR1)?_.create_hmd_quat_sensor():_.create_gyro_quat_sensor())},t.check_browser_support=function(){return Boolean(s.can_use_device(s.DEVICE_HMD))},t.enable_controllers=function(e,t){if(r(),e||t){var a=s.get_vr_controller_id(0),n=_.create_gamepad_position_sensor(a),o=_.create_gamepad_orientation_sensor(a),i=s.get_vr_controller_id(1),l=_.create_gamepad_position_sensor(i),c=_.create_gamepad_orientation_sensor(i);_.create_sensor_manifold(null,"VR_CONTROLLERS",_.CT_CONTINUOUS,[n,l,o,c],null,function(r,a,n){if(e){var s=_.get_sensor_payload(r,a,0),o=_.get_sensor_payload(r,a,2);m.add(k,s,s),u.set_translation_v(e,s),u.set_rotation_v(e,o)}if(t){var i=_.get_sensor_payload(r,a,1),l=_.get_sensor_payload(r,a,3);m.add(k,i,i),u.set_translation_v(t,i),u.set_rotation_v(t,l)}})}},t.disable_controllers=r,t.disable_hmd=function(){if(_.check_sensor_manifold(null,"HMD_ROTATE_CAMERA")){_.remove_sensor_manifold(null,"HMD_ROTATE_CAMERA"),c.exit_split_screen();var e=i.get_active_camera();v?n.target_setup(e,N):b?n.hover_setup(e,N):g&&n.static_setup(e,N),n.set_vertical_axis(e,f.AXIS_Z);var t=u.get_rotation(e,A);u.set_rotation_v(e,t)}},t.set_rotate_quat=function(e){o.copy(e,R)},t.get_rotate_quat=function(e){return o.copy(R,e),e},t.set_position=function(e){o.copy(e,k)},t.get_position=function(e){return o.copy(k,e),e}})),Me=(o("fps",function(e,t){function r(e,t,r){var a=B.get_active_camera();D.rotate_camera(a,t,r);var n=D.get_camera_angles_char(a,Ge);F.set_character_rotation_h(e,n[0]),F.set_character_vert_move_dir_angle(e,n[1])}function a(e,t,r,a){if(Math.abs(ke[0])>.01||Math.abs(ke[1])>.01){var n=U.get_sensor_value(e,t,0),s=G.smooth(ke[0],0,n,_()),o=G.smooth(ke[1],0,n,_());ke[0]-=s,ke[1]-=o,a(e,-s*Ie,-o*Ie)}}function n(e){Me=e}function _(){return le*Me}function s(e,t){var r=document.createElement("div");r.style.cssText="position: absolute;left: 10px;bottom: 70px;width: 53px;height: 53px;background-image: "+se,r.setAttribute("id",ne);var a=document.createElement("div");a.style.cssText="position: absolute;left: 10px;bottom: 10px;width: 53px;height: 53px;background-image: "+se+"transform: rotate(180deg);transform-origin: center;",a.setAttribute("id",_e),t.appendChild(r),t.appendChild(a)}function o(e){return"function"==typeof(e.requestPointerLock||e.webkitRequestPointerLock||e.mozRequestPointerLock)}function i(e,t,r,a){var n=U.get_sensor_value(e,r,1),_=U.get_sensor_value(e,r,2),s=a*ue,o=-(Math.abs(_)<ce?0:_)*s,i=-(Math.abs(n)<ce?0:n)*s;o=G.clamp(o,fe,ve),D.rotate_camera(t,i,o);var l=D.get_camera_angles(t,Ge);F.set_character_rotation_h(e,l[0]+Math.PI)}function c(e,t){U.check_sensor_manifolds(t,"FPS_PLOCK")&&U.remove_sensor_manifold(t,"FPS_PLOCK"),U.check_sensor_manifolds(null,"FPS_ACTIVATE_PLOCK")&&U.remove_sensor_manifold(null,"FPS_ACTIVATE_PLOCK"),U.check_sensor_manifolds(t,"FPS_CAM_ROT")&&U.remove_sensor_manifold(t,"FPS_CAM_ROT"),U.check_sensor_manifolds(null,"FPS_DRAG_PRESS")&&U.remove_sensor_manifold(null,"FPS_DRAG_PRESS"),U.check_sensor_manifolds(null,"FPS_DRAG_MOVE")&&U.remove_sensor_manifold(null,"FPS_DRAG_MOVE"),U.check_sensor_manifolds(t,"FPS_SMOOTH_DRAG")&&U.remove_sensor_manifold(t,"FPS_SMOOTH_DRAG")}function u(e,t){if(o(e)&&!j.detect_mobile()){var r=U.create_plock_mouse_sensor(e),n=Ce||U.create_plock_sensor(e);Ce=n,U.create_sensor_manifold(t,"FPS_PLOCK",U.CT_CONTINUOUS,[r,n],function(e){return e[0]&&e[1]},function(e,t,r){if(r>0){var a=U.get_sensor_payload(e,t,0);De(e,-a.coords[0]*Ie,-a.coords[1]*Ie)}}),U.create_sensor_manifold(null,"FPS_ACTIVATE_PLOCK",U.CT_TRIGGER,[n],function(e){return e[0]},function(t,r,a){a>0?Pe.enable_cb&&Pe.enable_cb(e):Pe.disable_cb&&Pe.disable_cb(e)})}else{if(j.detect_mobile())var _=U.create_touch_move_sensor("XY",e),s=U.create_touch_click_sensor(e),l=oe;else{var _=U.create_mouse_move_sensor("XY",e),s=U.create_mouse_click_sensor(e),l=ie,c=B.get_active_camera(),u=U.create_elapsed_sensor(),d=U.create_gamepad_axis_sensor(Y.GMPD_AXIS_2),f=U.create_gamepad_axis_sensor(Y.GMPD_AXIS_3);U.create_sensor_manifold(t,"FPS_CAM_ROT",U.CT_CONTINUOUS,[u,d,f],function(e){return Math.abs(e[1])>ce||Math.abs(e[2])>ce},function(e,t,r){if(r>0){var a=U.get_sensor_value(e,t,0);i(e,c,t,a)}})}var m=0,p=0;U.create_sensor_manifold(null,"FPS_DRAG_PRESS",U.CT_SHOT,[s],function(e){return e[0]},function(e,t,r){if(1==r){var a=U.get_sensor_payload(e,t,0).coords;m=a[0],p=a[1]}}),U.create_sensor_manifold(null,"FPS_DRAG_MOVE",U.CT_CONTINUOUS,[_,s],function(e){return e[0]&&e[1]},function(e,t,r){if(1==r){var a=U.get_sensor_payload(e,t,0).coords;ke[0]+=(a[0]-m)*l,ke[1]+=(a[1]-p)*l,m=a[0],p=a[1]}});var h=U.create_elapsed_sensor();U.create_sensor_manifold(t,"FPS_SMOOTH_DRAG",U.CT_CONTINUOUS,[h],null,a,De)}}function d(e,t){var r=B.get_active_camera();if(t){var a=W.get_translation(r,je),n=W.get_translation(e,ze);V.subtract(a,n,a),q.append_stiff_trans(r,e,a)}var _=D.get_camera_angles_char(r,Ge);F.set_character_rotation_h(e,_[0]),F.set_character_vert_move_dir_angle(e,_[1])}function f(e,t){Y.add_click_listener(e,function(){H.request_fullscreen_hmd(e,function(){c(e,t),X.enable_hmd(X.HMD_ALL_AXES_MOUSE_NONE),p(t),Ye&&Ye()},function(){h(t),X.disable_hmd(),u(e,t),He&&He()})})}function p(e){var t=U.create_elapsed_sensor(),r=B.get_active_camera();U.create_sensor_manifold(e,"FPS_CHARECTER_VR_ROT",U.CT_CONTINUOUS,[t],null,function(e,t,a){var n=D.get_camera_angles_char(r,Ge)[0];F.set_character_rotation_h(e,n)})}function h(e){U.remove_sensor_manifold(e,"FPS_CHARECTER_VR_ROT")}function v(){var e=X.check_browser_support()&&!j.detect_mobile(),t=Y.get_device_by_type_element(Y.DEVICE_HMD);return t&&(e=e&&Y.get_value_param(t,Y.HMD_WEBVR_TYPE)&Y.HMD_WEBVR1),e}function b(e,t){v()&&f(e,t),u(e,t)}function g(e,t,r,a){if(j.detect_mobile()){var n=e.parentElement?e.parentElement:e;s(t,n)}var _=k(t),o={left:0,right:0,forw:0,back:0},i=-1,l=a.move_dir_cd,c=function(){return!Be||(o.left=0,o.right=0,o.forw=0,o.back=0,!1)},u=function(e,t){var r=x(_).id;e||t||r==ae?r==$&&(i>0?R(_,te):R(_,ee)):R(_,$)},d=function(e){if(c()){e=(e=e>0?1:e)<0?-1:e;var a=o.forw+o.back;o.back=-e;var n=o.forw+o.back,_=o.left+o.right;F.set_character_move_dir(t,n,_),r&&r(n,_),u(n,_),l&&a!=n&&l(n,_,0)}},f=function(e){if(c()){x(_).id==ae&&(e=0),e=(e=e>0?1:e)<0?-1:e;var a=o.left+o.right;o.right=-e;var n=o.forw+o.back,s=o.left+o.right;F.set_character_move_dir(t,n,s),r&&r(n,s),u(n,s),l&&a!=s&&l(n,s,0)}},m=a.forward_sens_arr,p=a.backward_sens_arr,h=a.right_sens_arr,v=a.left_sens_arr,b=a.jump_sens_arr,g=a.run_sens_arr,y=a.fly_sens_arr;P(Z,m,function(e){if(c()){var a=o.forw+o.back;o.forw=e;var n=o.forw+o.back,_=o.left+o.right;F.set_character_move_dir(t,n,_),r&&r(n,_),u(n,_),l&&a!=n&&l(n,_,0)}}),P(Z,p,d),P(Z,h,f),P(Z,v,function(e){if(c()){x(_).id==ae&&(e=0);var a=o.left+o.right;o.left=e;var n=o.forw+o.back,s=o.left+o.right;F.set_character_move_dir(t,n,s),r&&r(n,s),u(n,s),l&&a!=s&&l(n,s,0)}}),P(Z,b,function(e){c()&&e>0&&(F.character_jump(t),l&&l(o.forw+o.back,o.left+o.right,1))}),P(J,[Y.GMPD_AXIS_0],f),P(J,[Y.GMPD_AXIS_1],d),P(Z,g,function(e){i=e,Math.abs(o.forw+o.back)+Math.abs(o.left+o.right)?(e>0?R(_,te):R(_,ee),l&&l(o.forw+o.back,o.left+o.right,0)):R(_,$)}),P(Z,y,function(e){if(e>0){var t=x(Le).id;t==ee||t==$?R(_,re):R(_,ee)}})}function y(){return Le||(Le={nodes:[],current_node:null,lock:!1,last_state:null}),Le}function E(e,t,r,a,n,_){e.nodes.push({id:t,allowed_ids:r,call_switch:a,call_before_switch:n,call_after_switch:_})}function w(e){for(var t=[],r=0;r<e.nodes;r++){var a=e.nodes[r].id;if(t.indexOf(a)>=0)return!1;t.push(a)}for(r=0;r<e.nodes;r++)for(var n=e.nodes[r],_=0;_<n.allowed_ids.length;_++)if(t.indexOf(n.allowed_ids[_])<0)return!1;return!0}function A(e,t){for(var r=null,a=0;a<e.nodes.length;a++)if(e.nodes[a].id==t){r=e.nodes[a];break}return r}function T(e,t){var r=A(e,t);return e.current_node=r,r}function x(e){return e.current_node}function O(e,t,r){A(e,t).call_after_switch=r}function R(e,t){if(e.last_state=t,e.lock)return!1;var r=x(e),a=r.id;if(r.allowed_ids.indexOf(t)>=0){var n=!0;if(r.call_before_switch&&(n=r.call_before_switch(a,t)),n)return T(e,t),r.call_switch&&r.call_switch(a,t),r.call_after_switch&&r.call_after_switch(a,t),!0}return!1}function k(e){var t=y(),r=function(t,r){switch(r){case $:case ee:F.set_character_move_type(e,F.CM_WALK);break;case te:F.set_character_move_type(e,F.CM_RUN);break;case re:F.set_character_move_type(e,F.CM_FLY);break;case ae:F.set_character_move_type(e,F.CM_CLIMB)}};return E(t,$,[ee,re,te,ae],r,null,null),E(t,ee,[te,re,ae,$],r,null,null),E(t,te,[ee,re,ae,$],r,null,null),E(t,re,[ee],r,null,null),E(t,ae,[ee,te,$],r,null,null),w(t),T(t,$),Le}function N(){for(var e=0;e<Se;e++)U.remove_sensor_manifold(null,"FPS_USER_CONTROL_ACTION_"+e.toString())}function M(e,t){o(t)&&!j.detect_mobile()&&(Pe.disable_cb&&Pe.disable_cb(t),U.remove_sensor_manifold(e,"FPS_PLOCK"),U.remove_sensor_manifold(null,"FPS_ACTIVATE_PLOCK"))}function I(e,t){o(t)&&!j.detect_mobile()||(U.remove_sensor_manifold(e,"FPS_CAM_ROT"),U.remove_sensor_manifold(e,"FPS_DRAG_PRESS"),U.remove_sensor_manifold(e,"FPS_DRAG_MOVE"),U.remove_sensor_manifold(e,"FPS_SMOOTH_DRAG"))}function S(e){v()&&U.remove_sensor_manifold(e,"FPS_CHARECTER_VR_ROT")}function L(e,t){if(j.detect_mobile()){var r=document.getElementById(ne),a=document.getElementById(_e);r&&t.removeChild(r),a&&t.removeChild(a)}}function C(e){Ue=e}function P(e,t,r){if(t.length){for(var a=[],n=0;n<t.length;n++)if("number"==typeof t[n])t[n]<ye?a.push(U.create_keyboard_sensor(t[n])):t[n]<Re?a.push(U.create_gamepad_btn_sensor(t[n],Ue)):a.push(U.create_gamepad_axis_sensor(t[n]));else if("string"==typeof t[n]){var _=document.getElementById(t[n]);_?a.push(U.create_touch_click_sensor(_)):K.error("Couldn't find element with "+t[n]+" ID.")}var s=function(e){return!1},o=U.CT_SHOT,i=function(e,t,r,a){};switch(e){case Z:o=U.CT_TRIGGER,s=function(e){for(var t=0;t<e.length;t++)if(e[t])return!0;return!1},i=function(e,t,a,n){r(a>0?1:0)};break;case Q:o=U.CT_TRIGGER,s=function(e){for(var t=0;t<e.length;t++)if(e[t])return!0;return!1},i=function(e,t,a,n){r(a<0?1:0)};break;case J:o=U.CT_CONTINUOUS,s=function(e){for(var t=0;t<e.length;t++)if(Math.abs(e[t])>ce)return!0;return!1},i=function(e,t,a,n){if(a>0)for(var _=0;_<n;_++){var s=U.get_sensor_value(e,t,_);if(Math.abs(s)>ce)return void r(s)}else r(0)}}var l="FPS_USER_CONTROL_ACTION_"+Se.toString(),c=a.length;U.create_sensor_manifold(null,l,o,a,s,i,c),Se++}}var D=de(e),U=he(e),F=we(e),B=Te(e),G=Oe(e),j=Ee(e),z=pe(e),Y=ge(e),H=Ae(e),W=xe(e),q=me(e),V=l(e),X=Ne(e),K=m(e),Z=1,Q=2,J=3,$=0,ee=1,te=2,re=3,ae=4,ne="B4W_DEFAULT_BTN_1",_e="B4W_DEFAULT_BTN_2",se="url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyBpZD0ic3ZnMzQwMCIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTQuMTExbW0iIHdpZHRoPSIxNC4xMTFtbSIgdmVyc2lvbj0iMS4xIiB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHZpZXdCb3g9IjAgMCA0OS45OTk5OTggNDkuOTk5OTk5Ij4gPG1ldGFkYXRhIGlkPSJtZXRhZGF0YTM0MDUiPjxyZGY6UkRGPjxjYzpXb3JrIHJkZjphYm91dD0iIj48ZGM6Zm9ybWF0PmltYWdlL3N2Zyt4bWw8L2RjOmZvcm1hdD48ZGM6dHlwZSByZGY6cmVzb3VyY2U9Imh0dHA6Ly9wdXJsLm9yZy9kYy9kY21pdHlwZS9TdGlsbEltYWdlIi8+PGRjOnRpdGxlLz48L2NjOldvcms+PC9yZGY6UkRGPiA8L21ldGFkYXRhPiA8ZyBpZD0ibGF5ZXIxIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwIC0xMDAyLjQpIj48cmVjdCBpZD0icmVjdDI0MTI2IiBvcGFjaXR5PSIwLjU0MyIgZmlsbC1vcGFjaXR5PSIuODM2MTEiIGhlaWdodD0iNTAiIHdpZHRoPSI1MCIgeT0iMTAwMi40IiB4PSIwIiBmaWxsPSIjZmZmIi8+PHBhdGggaWQ9InBhdGgyNDEyOCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0ibTM5LjE0MiAxMDMzLjUtMTQuMTQyLTE0LjE0Mi0xNC4xNDIgMTQuMTQyIiBzdHJva2U9IiM2ZTZlNmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+IDwvZz48L3N2Zz4=);",oe=4,ie=2,le=.2,ce=.05,ue=2.5,fe=(.1-Math.PI)/2,ve=(Math.PI-.1)/2,be=2e5,ye=300,Re=326,ke=new Float32Array(2),Me=1,Ie=4e-4,Se=0,Le=null,Ce=null,Pe={enable_cb:null,disable_cb:null},De=function(){},Ue=0,Fe=4,Be=!1,Ge=new Float32Array(2),je=new Float32Array(3),ze=new Float32Array(3),Ye=null,He=null;t.append_switch_vr_cbs=function(e,t){Ye=e,He=He},t.CS_STAY=$,t.CS_WALK=ee,t.CS_RUN=te,t.CS_FLY=re,t.CS_CLIMB=ae,t.AT_PRESSED=Z,t.AT_RELEASED=Q,t.AT_CONTINUOUS=J,t.bind_action=P,t.enable_fps_controls=function(e){var t=(e=e||{lock_camera:!0}).character||B.get_first_character();if(t){var a=e.element||z.get_canvas(),n=e.motion_cb||null;C(e.gamepad_id||0);var _=e.forward_sens||[U.KEY_W,Y.GMPD_BUTTON_12],s=e.backward_sens||[U.KEY_S,Y.GMPD_BUTTON_13],o=e.right_sens||[U.KEY_D,Y.GMPD_BUTTON_15],i=e.left_sens||[U.KEY_A,Y.GMPD_BUTTON_14],l=e.jump_sens||[U.KEY_SPACE,Y.GMPD_BUTTON_1],c=e.run_sens||[U.KEY_SHIFT,Y.GMPD_BUTTON_7],u=e.fly_sens||[];j.detect_mobile()&&(_.push(ne),s.push(_e));var f={forward_sens_arr:_,backward_sens_arr:s,right_sens_arr:o,left_sens_arr:i,jump_sens_arr:l,run_sens_arr:c,fly_sens_arr:u,move_dir_cd:e.move_dir_cd||null};De=e.rotation_cb||r,d(t,void 0===e.lock_camera||e.lock_camera),b(a,t),g(a,t,n,f)}},t.disable_fps_controls=function(e,t){e=e||B.get_first_character(),t=t||z.get_container(),e&&(N(),M(e,t),I(e,t),S(e),L(0,t))},t.set_state_change_cb=function(e,t){O(Le,e,t)},t.set_cam_smooth_factor=function(e){U.set_plock_smooth_factor(e),n(e)},t.get_cam_smooth_factor=function(){return Me},t.set_cam_sensitivity=function(e){Ie=e/be},t.get_cam_sensitivity=function(){return Ie*be},t.set_plock_enable_cb=function(e){Pe.enable_cb=e},t.set_plock_disable_cb=function(e){Pe.disable_cb=e},t.get_character_state=function(){return x(Le).id},t.add_new_state=function(){return Fe++},t.add_state=function(e,t,r){var a=y();E(a,e,t,r,null,null),w(a)||K.error("Incorrect state machine.")},t.switch_state=function(e){R(y(),e)},t.lock_character=function(){y().lock=!0},t.unlock_character=function(){y().lock=!1},t.is_character_locked=function(){return y().lock},t.set_rotation_cb=function(e){De=e||r},t.freeze_movements=function(){Be=!0},t.unfreeze_movements=function(){Be=!1}}),o("storage",function(e,t){function r(e){return s[e||_]?JSON.parse(s[e||_]):{}}function a(e,t){s[t||_]=JSON.stringify(e)}var n=m(e),_="b4w",s=null;t.init=function(e){e?"b4w"!==e?_=e:n.error("b4w prefix denied"):n.warn("Prefix should be a string. Last declared storage prefix will be used.")},t.set=function(e,t,n){var _=r(n);_[e]=String(t),a(_,n)},t.cleanup=function(e){delete s[e||_]},t.get=function(e,t){var a=r(t);return a[e]?a[e]:""},t.debug=function(e){n.log(r(e||_))},function(){try{s=window.localStorage;try{s.tmp=null,delete s.tmp}catch(e){n.warn("localStorage quota is limited. Disabling localStorage"),s=null}}catch(e){n.warn("Applying chrome localStorage bug workaround"),s=null}s||(n.warn("localStorage is not available, initializing temporary storage"),s={})}()})),Ie=(o("gp_conf",function(e,t){function r(e,t,r,a){var n=w.get_sensor_value(t,r,a)*L,_=w.get_sensor_value(t,r,a+1)*L;e.style.transform="translate3d("+n+"px, "+_+"px, 0px) rotate(0rad)"}function a(e,t,r){if(!(r+1>2*we.length)){var a=w.get_sensor_value(e,t,r),n=w.get_sensor_value(e,t,r+1);if(Te[r]>-2){var _=a-Te[r],s=n-Te[r+1],o=we[Math.floor(r/2)],i=o.getAttribute("data-svgid");if(le==P)o.style.backgroundImage=_||s?x+btoa(se[i].replace(N,k))+"')":x+btoa(se[i])+"')";else if(le==U){var l=A.get_moved_gmpd_axis(oe);if(l>=0){l%2!=0&&l--,le=P,o.style.backgroundImage=x+btoa(se[i])+"')";var c=parseFloat(ie.getAttribute("data-key"));A.set_gamepad_key(oe,c,l),A.set_gamepad_key(oe,c+1,l+1),ie=null,document.getElementById("action_label").textContent=M}}}Te[r]=a,Te[r+1]=n}}function n(e,t,r){if(!(r>=we.length)){var a=w.get_sensor_value(e,t,r);if(Te[r]>-2){var n=a-Te[r],_=we[r],s=_.getAttribute("data-svgid");if(le==P)_.style.backgroundImage=n?x+btoa(se[s].replace(N,k))+"')":x+btoa(se[s])+"')";else if(le==U){var o=A.get_moved_gmpd_axis(oe);if(o>=0){le=P,_.style.backgroundImage=x+btoa(se[s])+"')";var i=parseFloat(ie.getAttribute("data-key"));A.set_gamepad_key(oe,i,o),ie=null,document.getElementById("action_label").textContent=M}}}Te[r]=a}}function _(e,t,r){if(le==P){if(t&&"B"==e.getAttribute("data-colorstate")&&(a=se[r],e.style.backgroundImage=x+btoa(a.replace(O,k))+"')",e.setAttribute("data-colorstate","G")),!t&&"B"!=e.getAttribute("data-colorstate")){var a=se[r];e.style.backgroundImage=x+btoa(a)+"')",e.setAttribute("data-colorstate","B")}}else{var n=A.get_pressed_gmpd_btn(oe);if(n>=0&&ie&&le==D){var _=ie.getAttribute("data-key");A.set_gamepad_key(oe,_,n),o(_,n),ie=null,document.getElementById("action_label").textContent=M,le=P}}}function s(){be.length=0;for(var e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],t=0;t<e.length;t++)e[t]&&be.push(e[t]);return be}function o(e,t){var r=T.get(oe+"_gmpd_stngs","b4w")||"{}",a=JSON.parse(r);a[e]=t,T.set(oe+"_gmpd_stngs",JSON.stringify(a),"b4w")}function i(e){var t=JSON.stringify(C);T.set(e+"_gmpd_stngs",t,"b4w")}function l(e,t){for(var r in e)A.set_gamepad_key(t,r,e[r])}function c(e){var t=T.get(e+"_gmpd_stngs","b4w");t?l(JSON.parse(t),e):i(e)}function u(e){Ae=!0;var t=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div"),n=document.createElement("div"),_=document.createElement("div"),s=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),l=document.createElement("div"),c=document.createElement("div"),u=document.createElement("div"),d=document.createElement("div"),f=document.createElement("div"),m=document.createElement("div"),p=document.createElement("div"),h=document.createElement("div"),v=document.createElement("div"),g=document.createElement("div"),y=document.createElement("div"),E=document.createElement("div"),w=document.createElement("div"),T=document.createElement("div");ue=t,t.style.cssText="position: absolute;height: auto;background-image: "+x+btoa(F)+"');width: 637px;height: 455px;background-size: 100% 100%;left: 50%;margin-bottom: 40px;-moz-transform: translateX(-50%);-ms-transform: translateX(-50%);-webkit-transform: translateX(-50%);bottom: 0px;",r.style.cssText="background-image: "+x+btoa(B)+"');position: absolute;top: 47px;left: 65px;width: 135px;height: 135px;",a.style.cssText="background-image: "+x+btoa(G)+"');width: 36px;height: 38px;left: 49px;top: 8px;position: absolute;",n.style.cssText="background-image: "+x+btoa(j)+"');width: 38px;height: 36px;top: 47px;left: 84px;position: absolute;",_.style.cssText="background-image: "+x+btoa(z)+"');width: 36px;height: 38px;bottom: 11px;left: 51px;position: absolute;",s.style.cssText="background-image: "+x+btoa(Y)+"');width: 38px;height: 36px;top: 47px;left: 13px;position: absolute;",o.style.cssText="position: absolute;top: 55px;left: 434px;width: 150px;height: 150px;",i.style.cssText="background-image: "+x+btoa(H)+"');width: 50px;height: 50px;left: 53px;top: 0px;position: absolute;",l.style.cssText="background-image: "+x+btoa(H)+"');width: 50px;height: 50px;left: 107px;top: 51px;position: absolute;",c.style.cssText="background-image: "+x+btoa(H)+"');width: 50px;height: 50px;left: 53px;bottom: 0px;position: absolute;",u.style.cssText="background-image: "+x+btoa(H)+"');width: 50px;height: 50px;top: 51px;position: absolute;",d.style.cssText="background-image: "+x+btoa(W)+"');position: absolute;top: 222px;left: 183px;width: 85px;height: 85px;",f.style.cssText="background-image: "+x+btoa(W)+"');position: absolute;top: 223px;left: 376px;width: 85px;height: 85px;",m.style.cssText="background-image: "+x+btoa(q)+"');position: absolute;top: 76px;left: 227px;width: 34px;height: 34px;",p.style.cssText="background-image: "+x+btoa(q)+"');position: absolute;top: 76px;left: 376px;width: 34px;height: 34px;",h.style.cssText="background-image: "+x+btoa(X)+"');position: absolute;top: 4px;left: 78px;width: 79px;height: 33px;",v.style.cssText="background-image: "+x+btoa(K)+"');position: absolute;top: 4px;left: 477px;width: 79px;height: 33px;",g.style.cssText="background-image: "+x+btoa(V)+"');position: absolute;top: -7px;left: 425px;width: 50px;height: 17px;",y.style.cssText="background-image: "+x+btoa(V)+"');position: absolute;top: -7px;left: 164px;width: 50px;height: 17px;",E.style.cssText="background-image: "+x+btoa(Z)+"');position: absolute;top: 68px;left: 274px;width: 92px;height: 92px;",w.style.cssText="background-image: "+x+btoa(Q)+"');position: absolute;top: 186px;left: 148px;width: 157px;height: 157px;",T.style.cssText="background-image: "+x+btoa(Q)+"');position: absolute;top: 187px;left: 339px;width: 157px;height: 157px;",t.appendChild(w),t.appendChild(T),r.appendChild(a),r.appendChild(n),r.appendChild(_),r.appendChild(s),t.appendChild(r),o.appendChild(i),o.appendChild(l),o.appendChild(c),o.appendChild(u),t.appendChild(o),t.appendChild(d),t.appendChild(f),t.appendChild(m),t.appendChild(p),t.appendChild(h),t.appendChild(v),t.appendChild(g),e.appendChild(t),t.appendChild(y),t.appendChild(E),ye.length=0,se.length=0,Ee.length=0,we.length=0,ye.push(c,l,u,i,h,v,y,g,m,p,d,f,a,_,s,n,E),se.push(H,H,H,H,X,K,V,V,q,q,W,W,G,z,Y,j,Z),Ee.push(d,d,f,f),we.push(w,T);for(var R=0;R<ye.length;R++)ye[R].setAttribute("id","pad_btn_"+R),ye[R].setAttribute("data-colorstate","B"),ye[R].setAttribute("data-key",R),ye[R].setAttribute("data-svgid",R);w.setAttribute("id","pad_left_axis"),w.setAttribute("data-colorstate","GR"),w.setAttribute("data-key",A.GMPD_AXIS_0),w.setAttribute("data-svgid",se.length),T.setAttribute("id","pad_right_axis"),T.setAttribute("data-colorstate","GR"),T.setAttribute("data-key",A.GMPD_AXIS_2),T.setAttribute("data-svgid",se.length+1),se.push(Q,Q),b(ye,O),b(we,N)}function d(e){Ae=!1;var t=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div"),n=document.createElement("div"),_=document.createElement("div"),s=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),l=document.createElement("div"),c=document.createElement("div"),u=document.createElement("div"),d=document.createElement("div"),f=document.createElement("div"),m=document.createElement("div"),p=document.createElement("div"),h=document.createElement("div"),v=document.createElement("div"),g=document.createElement("div"),y=document.createElement("div"),E=document.createElement("div"),w=document.createElement("div"),T=document.createElement("div"),R=document.createElement("div"),k=document.createElement("div"),M=document.createElement("div"),I=document.createElement("div"),S=document.createElement("div"),L=document.createElement("div"),C=document.createElement("div"),P=document.createElement("div");ue=t;var D="position: absolute;height: auto;background-image: "+x+btoa($)+"');width: 19px;height: 19px;background-size: 100% 100%;";t.style.cssText="position: absolute;background-image: "+x+btoa(J)+"');width: 397px;height: 455px;-moz-transform: translateX(-50%);-ms-transform: translateX(-50%);-webkit-transform: translateX(-50%);transform: translateX(-50%);background-size: 100% 100%;left: 50%;margin-left: 25px;margin-bottom: 40px;bottom: 0px;",r.style.cssText=D+"top: 132px;left: 331px;",a.style.cssText=D+"top: 122px;left: 315px;",n.style.cssText=D+"top: 122px;left: 347px;",_.style.cssText=D+"top: 113px;left: 331px;",s.style.cssText="position: absolute;height: auto;background-image: "+x+btoa(ee)+"');width: 54px;height: 37px;background-size: 100% 100%;top: 84px;left: 166px;",o.style.cssText="position: absolute;height: auto;background-image: "+x+btoa(te)+"');width: 54px;height: 37px;background-size: 100% 100%;top: 84px;left: 36px;",i.style.cssText=D+"top: 107px;left: 141px;",l.style.cssText=D+"top: 107px;left: 90px;",c.style.cssText=D+"top: 185px;left: 321px;",u.style.cssText=D+"top: 185px;left: 340px;",d.style.cssText=D+"top: 179px;left: 358px;",f.style.cssText=D+"top: 178px;left: 303px;",m.style.cssText=D+"top: 210px;left: 299px;",p.style.cssText=D+"top: 279px;left: 299px;",h.style.cssText=D+"top: 210px;left: 321px;",v.style.cssText=D+"top: 279px;left: 321px;",g.style.cssText=D+"top: 210px;left: 344px;",y.style.cssText=D+"top: 278px;left: 344px;",E.style.cssText=D+"top: 124px;left: 147px;",w.style.cssText=D+"top: 138px;left: 133px;",T.style.cssText=D+"top: 124px;left: 82px;",R.style.cssText=D+"top: 138px;left: 96px;",k.style.cssText=D+"top: 278px;left: 367px;";var U="position: absolute;background-image: "+x+btoa(re)+"');width: 19px;height: 46px;background-size: 100% 100%;";for(M.style.cssText=U+"top: 291px;left: 50px;",I.style.cssText=U+"top: 291px;left: 111px;",S.style.cssText=U+"top: 291px;left: 171px;",L.style.cssText="position: absolute;background-image: "+x+btoa(ae)+"');width: 297px;height: 179px;background-size: 100% 100%;top: 43px;left: -25px;",C.style.cssText="position: absolute;background-image: "+x+btoa(ne)+"');width: 33px;height: 10px;background-size: 100% 100%;top: 159px;left: 324px;",P.style.cssText="position: absolute;background-image: "+x+btoa(_e)+"');width: 10px;height: 33px;background-size: 100% 100%;top: 148px;left: 335px;",e.appendChild(t),t.appendChild(M),t.appendChild(I),t.appendChild(S),t.appendChild(L),t.appendChild(C),t.appendChild(P),t.appendChild(r),t.appendChild(a),t.appendChild(n),t.appendChild(_),t.appendChild(s),t.appendChild(o),t.appendChild(i),t.appendChild(l),t.appendChild(c),t.appendChild(u),t.appendChild(d),t.appendChild(f),t.appendChild(m),t.appendChild(p),t.appendChild(h),t.appendChild(v),t.appendChild(g),t.appendChild(y),t.appendChild(E),t.appendChild(w),t.appendChild(T),t.appendChild(R),t.appendChild(k),ye.length=0,se.length=0,Ee.length=0,we.length=0,ye.push(r,a,n,_,s,o,i,l,c,u,d,f,m,p,h,v,g,y,E,w,T,R,k),se.push($,$,$,$,ee,te,$,$,$,$,$,$,$,$,$,$,$,$,$,$,$,$,$,$),we.push(L,M,S,I,C,P),F=0;F<ye.length;F++)ye[F].setAttribute("id","wheel_btn_"+F),ye[F].setAttribute("data-colorstate","B"),ye[F].setAttribute("data-key",F),ye[F].setAttribute("data-svgid",F);for(var F=0;F<we.length;F++)ye[F].setAttribute("id","wheel_axis_"+F),ye[F].setAttribute("data-colorstate","GR");L.setAttribute("data-key",A.GMPD_AXIS_0),L.setAttribute("data-svgid",se.length),M.setAttribute("data-key",A.GMPD_AXIS_1),M.setAttribute("data-svgid",se.length+1),S.setAttribute("data-key",A.GMPD_AXIS_2),S.setAttribute("data-svgid",se.length+2),I.setAttribute("data-key",A.GMPD_AXIS_3),I.setAttribute("data-svgid",se.length+3),C.setAttribute("data-key",A.GMPD_AXIS_4),C.setAttribute("data-svgid",se.length+4),P.setAttribute("data-key",A.GMPD_AXIS_5),P.setAttribute("data-svgid",se.length+5),se.push(ae,re,re,re,ne,_e),b(ye,O),b(we,N)}function f(e){return[w.create_gamepad_btn_sensor(A.GMPD_BUTTON_0,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_1,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_2,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_3,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_4,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_5,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_6,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_7,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_8,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_9,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_10,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_11,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_12,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_13,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_14,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_15,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_16,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_17,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_18,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_19,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_20,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_21,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_22,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_23,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_24,e),w.create_gamepad_btn_sensor(A.GMPD_BUTTON_25,e)]}function m(e){return[w.create_gamepad_axis_sensor(A.GMPD_AXIS_0,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_1,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_2,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_3,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_4,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_5,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_6,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_7,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_8,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_9,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_10,e),w.create_gamepad_axis_sensor(A.GMPD_AXIS_11,e)]}function p(e,t){var r=document.createElement("input");r.style.cssText="display: inline-block;position = relative;",r.setAttribute("type","radio"),r.setAttribute("name","choice");var a=document.createElement("label");return a.textContent=t,a.style.cssText="position = relative;display: inline-block;color: white;",e.appendChild(r),e.appendChild(a),r}function h(){ce.removeChild(ue),ue=null}function v(e){switch(h(),e){case"PAD":me.checked=!0,u(ce);break;case"WHEEL":fe.checked=!0,d(ce)}}function b(e,t){for(var r=0;r<e.length;r++){var a=e[r];A.add_click_listener(a,function(e){var r=e.target;if(!(oe<0||"G"==r.getAttribute("data-colorstate")))if(le!=P)"R"==r.getAttribute("data-colorstate")&&(ie=null,document.getElementById("action_label").textContent=M,le=P),("B"==r.getAttribute("data-colorstate")||"GR"==r.getAttribute("data-colorstate"))&&(a=parseFloat(ie.getAttribute("data-svgid")),ie.style.backgroundImage=x+btoa(se[a])+"')",ie.setAttribute("data-colorstate",r.getAttribute("data-colorstate")),ie=r,a=parseFloat(r.getAttribute("data-svgid")),r.style.backgroundImage=x+btoa(se[a].replace(t,R))+"')",r.setAttribute("data-colorstate","R"));else{var a=parseFloat(r.getAttribute("data-svgid")),n="B"==r.getAttribute("data-colorstate")?D:U;le=n,r.style.backgroundImage=x+btoa(se[a].replace(t,R))+"')",r.setAttribute("data-colorstate","R"),document.getElementById("action_label").textContent=n==D?I:S,ie=r}})}}function g(e){var t=document.createElement("label");return t.style.cssText="position: relative;display: inline-block;width: 50px;color: white;margin: 0 10px;font-size: 36px;line-height: 50px;background-color: black;border: 3px solid white;border-radius: 5px;height: 50px;",t.textContent=e,t}function y(){var e=window.innerWidth,t=window.innerHeight;ce.style.zoom=t<=750&&t>400||e<=750&&e>400?"0.5":e<=400||t<=400?"0.3":"1"}var E=pe(e),w=he(e),A=ge(e),T=Me(e),x="url('data:image/svg+xml;base64,",O=new RegExp("#5276cf","g"),R="#ff0000",k="#00ff00",N="#e6e6e6",M="Click on the buttons & arrows to setup your controller",I="Now press the button on the device",S="Now move the axis on the device",L=20,C={};C[A.GMPD_BUTTON_12]=A.GMPD_BUTTON_12,C[A.GMPD_BUTTON_13]=A.GMPD_BUTTON_13,C[A.GMPD_BUTTON_15]=A.GMPD_BUTTON_15,C[A.GMPD_BUTTON_14]=A.GMPD_BUTTON_14,C[A.GMPD_BUTTON_3]=A.GMPD_BUTTON_3,C[A.GMPD_BUTTON_0]=A.GMPD_BUTTON_0,C[A.GMPD_BUTTON_1]=A.GMPD_BUTTON_1,C[A.GMPD_BUTTON_2]=A.GMPD_BUTTON_2,C[A.GMPD_BUTTON_5]=A.GMPD_BUTTON_5,C[A.GMPD_BUTTON_7]=A.GMPD_BUTTON_7,C[A.GMPD_BUTTON_4]=A.GMPD_BUTTON_4,C[A.GMPD_BUTTON_6]=A.GMPD_BUTTON_6,C[A.GMPD_BUTTON_8]=A.GMPD_BUTTON_8,C[A.GMPD_BUTTON_9]=A.GMPD_BUTTON_9,C[A.GMPD_BUTTON_10]=A.GMPD_BUTTON_10,C[A.GMPD_BUTTON_11]=A.GMPD_BUTTON_11,C[A.GMPD_BUTTON_16]=A.GMPD_BUTTON_16;var P=0,D=1,U=2,F='<svg id="svg26627" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="128.51mm" viewBox="0 0 636.63517 455.33329" width="179.67mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/"><defs id="defs26629"><linearGradient id="linearGradient4691"><stop id="stop4693" offset="0"/><stop id="stop4695" stop-opacity="0" offset="1"/></linearGradient><linearGradient id="linearGradient4358"><stop id="stop4360" stop-color="#2e2e2e" offset="0"/><stop id="stop4362" stop-color="#2e2e2e" stop-opacity="0" offset="1"/></linearGradient><linearGradient id="linearGradient4364" x1="1141.5" xlink:href="#linearGradient4358" gradientUnits="userSpaceOnUse" y1="255.95" gradientTransform="matrix(-1 0 0 1 1531.4 560.1)" x2="1165.2" y2="309.88"/><linearGradient id="linearGradient4368" x1="1141.5" xlink:href="#linearGradient4358" gradientUnits="userSpaceOnUse" y1="255.95" gradientTransform="translate(-896.37 560.1)" x2="1165.2" y2="309.88"/><linearGradient id="linearGradient4430" x1="959.32" gradientUnits="userSpaceOnUse" y1="653.07" gradientTransform="matrix(-1 0 0 1 1531.4 70.097)" x2="1467.6" y2="653.07"><stop id="stop4426" stop-color="#4f4f4f" offset="0"/><stop id="stop4428" stop-color="#4f4f4f" stop-opacity="0" offset="1"/></linearGradient><linearGradient id="linearGradient4701" x1="529.91" xlink:href="#linearGradient4691" gradientUnits="userSpaceOnUse" y1="111.1" gradientTransform="translate(-52.276 546.89)" x2="481.49" y2="85.746"/><linearGradient id="linearGradient4713" x1="529.91" xlink:href="#linearGradient4691" gradientUnits="userSpaceOnUse" y1="111.1" gradientTransform="matrix(-1 0 0 1 689.01 546.89)" x2="481.49" y2="85.746"/><linearGradient id="linearGradient4725" x1="367.39" xlink:href="#linearGradient4691" gradientUnits="userSpaceOnUse" y1="125.6" gradientTransform="matrix(-1.3272 0 0 .68317 806.95 579.14)" x2="367.39" y2="116.11"/></defs><metadata id="metadata26632"><rdf:RDF><cc:Work rdf:about="">    <dc:format>image/svg+xml</dc:format>    <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>    <dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -597.03)"><g id="g20" fill-rule="evenodd"><path id="path4209" fill="#434343" d="m576.71 1052.4c42.015-1.9097 64.296-46.468 59.204-122.86-5.0928-76.387-27.374-175.69-44.562-224.7-17.188-49.015-25.501-62.531-26.737-65.565-3.7697-9.2504-11.278-19.949-62.379-27.691-28.97-4.3891-16.697-7.9577-27.084-9.4696-17.96-2.6141-43.609-1.229-52.203 1.6354-8.594 2.8645-12.709 29.16-24.486 35.207-11.777 6.0473-19.416 10.185-80.149 10.185s-68.372-4.1376-80.149-10.185c-11.777-6.0473-18.113-32.099-25.736-36.993-11.183-7.1796-26.985-5.6722-54.891-0.57481-5.64 1.0302-1.1304 7.6212-18.165 12.509-32.913 9.4438-52.094 3.7056-65.087 20.831-1.9807 2.6106-11.822 21.096-29.01 70.111-17.179 48.95-39.46 148.25-44.553 224.64-5.0929 76.39 17.188 120.99 59.204 122.89 73.339-1.7 55.219-116.53 258.4-116.53s185.05 114.82 258.4 116.49z"/><path id="path4366" fill="url(#linearGradient4368)" d="m249.77 838.51c-107.76 0-171.55 96.288-176.84 121.23-5.2294 24.634-17.658 55.705 3.8195 53.789 9.6996-0.8655 18.053-15.713 37.559-38.193 18.78-21.643 41.379-54.425 96.763-54.425s73.209-44.877 75.119-53.152c1.9098-8.2752 2.4146-27.976-36.418-29.25z"/><path id="path4217" fill="url(#linearGradient4364)" d="m385.23 838.51c107.76 0 171.55 96.288 176.84 121.23 5.2293 24.634 17.658 55.705-3.8195 53.789-9.6996-0.8655-18.053-15.713-37.559-38.193-18.78-21.643-41.379-54.425-96.763-54.425s-73.209-44.877-75.119-53.152c-1.9098-8.2752-2.4146-27.976 36.418-29.25z"/><path id="path4370" fill="url(#linearGradient4430)" d="m572.06 654.81c-60.48-19.09-76.79-18.6-89.84-17.96-13.05 0.63657-22.638 16.617-45.237 49.4s-67.48 125.27-116.23 125.27c-48.746 0-93.626-92.491-116.23-125.27-22.599-32.783-32.008-48.942-45.059-49.579-13.05-0.63648-35.251 1.8354-95.728 20.932l1.1161-2.3404c60.494-19.1 81.754-20.83 94.804-20.19 13.05 0.63657 22.281 13.049 44.88 45.832s67.48 123.49 116.23 123.49c48.746 0 93.626-90.709 116.23-123.49 22.599-32.783 31.83-45.195 44.88-45.832 13.05-0.63648 28.783-1.6248 89.26 17.472"/><path id="path4315" fill="#343434" d="m570.99 652.48c-60.477-19.097-76.074-18.269-89.124-17.633-13.05 0.63658-22.281 14.832-44.88 47.614-22.599 32.783-67.48 125.27-116.23 125.27-48.746 0-93.626-92.491-116.23-125.27-22.599-32.783-31.83-46.978-44.88-47.614-13.05-0.63648-34.715 1.2996-95.192 20.396l1.1161-2.3404c60.474-19.1 81.024-22.26 94.074-21.62 13.05 0.63658 22.281 13.049 44.88 45.832s67.48 123.49 116.23 123.49c48.746 0 93.626-90.709 116.23-123.49 22.599-32.783 31.83-45.195 44.88-45.832 13.05-0.63647 27.71-0.17274 88.186 18.924"/></g><g id="g15645" transform="matrix(.75439 0 0 1 1558.5 -6638.3)" fill-rule="evenodd"><rect id="rect15584" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="2" ry="1.8461" height="44.307" width="570" y="6558.3" x="100.71" fill="#4164bb"/><rect id="rect15331" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="2" ry="1.8461" height="44.307" width="570" y="6554.6" x="100.71" fill="#5276cf"/></g><text id="text15623-9" style="word-spacing:0px;letter-spacing:0px" font-weight="300" xml:space="preserve" font-size="22px" line-height="430.99999428%" y="-53.755863" x="1792.7805" font-family="&apos;Noto Sans CJK TC&apos;" fill="#ffffff"><tspan id="tspan15625-5" y="-53.755863" x="1792.7805"/></text><text id="text15657" style="word-spacing:0px;letter-spacing:0px" font-weight="300" xml:space="preserve" font-size="13px" line-height="430.99999428%" y="-3.7607465" x="1670.2437" font-family="&apos;Noto Sans CJK TC&apos;" fill="#828282"><tspan id="tspan15659" y="-3.7607465" x="1670.2437"/></text><g id="g34" fill-rule="evenodd"><path id="path4675" fill="#303030" d="m551.75 628.4c9.3003 4.1796 8.2375 11.558 2.1302 9.9581-6.1073-1.6003-33.792-9.1405-46.239-11.577-12.446-2.4363-34.904-3.0623-36.951-4.0165-2.0474-0.95416 0.93313-7.7247 5.491-7.3449 23.258 0.91012 59.905 6.0339 75.569 12.98z"/><path id="path4677" fill="#303030" d="m474.88 602.61c3.6488 0.63684 4.1169 1.3708 2.4115 5.2499-0.80967 1.8416-1.261 3.904-3.4715 3.7336-4.456-0.34344-16.578-1.2846-25.692-1.3764-9.1139-0.0918-23.83 1.217-25.307 0.79399-1.4771-0.42301-1.8834-4.9141 1.7769-6.7458 4.6221-1.3593 38.698-3.2021 50.281-1.6553z"/><path id="path4699" opacity=".384" fill="url(#linearGradient4701)" d="m475.53 611.7c-11.693-0.63604-8.4597-0.73151-44.068 54.448-6.5182 8.6489-22.874 37.231-36.865 35.326-6.7491-1.4177 15.436-67.299 22.724-75.767 11.112-12.911 19.255-16.122 58.209-14.007z"/><path id="path4703" fill="#303030" d="m84.068 628.4c-9.3003 4.1796-8.2375 11.558-2.1302 9.9581 6.1073-1.6003 33.792-9.1405 46.239-11.577 12.446-2.4363 34.904-3.0623 36.951-4.0165 2.0474-0.95416-0.93313-7.7247-5.491-7.3449-23.258 0.91012-59.905 6.0339-75.569 12.98z"/><path id="path4705" fill="#303030" d="m161.86 602.61c-3.6488 0.63684-4.1169 1.3708-2.4115 5.2499 0.80967 1.8416 1.261 3.904 3.4715 3.7336 4.456-0.34344 16.578-1.2846 25.692-1.3764 9.1139-0.0918 23.83 1.217 25.307 0.79399 1.4771-0.42301 1.8834-4.9141-1.7769-6.7458-4.6221-1.3593-38.698-3.2021-50.281-1.6553z"/><path id="path4711" opacity=".384" fill="url(#linearGradient4713)" d="m161.2 611.7c11.693-0.63604 8.4597-0.73151 44.068 54.448 6.5182 8.6489 22.874 37.231 36.865 35.326 6.7491-1.4177-15.436-67.299-22.724-75.767-11.112-12.911-19.255-16.122-58.209-14.007z"/><path id="path4717" opacity=".115" fill="url(#linearGradient4725)" d="m413.37 645.84c-9.0496 10.007-29.401 19.937-36.775 19.937h-52.205c-31.171 0-37.359 0.34506-47.75 0.51758-10.39 0.17253-18.682 0.65628-23.653-3.278-5.0513-3.9977-24-15.425-24-15.425 53.346 4.1464 144.49 4.3368 184.38-1.7523z"/></g></g><g id="layer1-0" fill-rule="evenodd" transform="translate(159.08 -720.76)"><g id="g4527-3" transform="translate(-961.22,330.69)"><ellipse id="circle4233-8" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="circle4235-8" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="circle4237-7" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g><g id="g4523-1" transform="translate(-961.22,330.69)"><ellipse id="circle4239-4" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="40.057" ry="40.054" cy="655.39" cx="1027.5" fill="#3b63c9"/><ellipse id="circle4243-3" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="36.23" ry="36.228" cy="655.39" cx="1027.5" fill="#5276cf"/></g><g id="g3506" transform="translate(-961.22,330.69)"><ellipse id="ellipse3508" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="ellipse3510" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="ellipse3512" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g></g><g id="layer1-7" fill-rule="evenodd" transform="translate(352.57 -719.72)"><g id="g4527-3-4" transform="translate(-961.22,330.69)"><ellipse id="circle4233-8-8" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="circle4235-8-9" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="circle4237-7-3" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g><g id="g4523-1-1" transform="translate(-961.22,330.69)"><ellipse id="circle4239-4-4" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="40.057" ry="40.054" cy="655.39" cx="1027.5" fill="#3b63c9"/><ellipse id="circle4243-3-5" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="36.23" ry="36.228" cy="655.39" cx="1027.5" fill="#5276cf"/></g><g id="g3506-2" transform="translate(-961.22,330.69)"><ellipse id="ellipse3508-1" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="ellipse3510-1" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="ellipse3512-4" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g></g></svg>',B='<svg id="svg3904" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="35.924mm" width="35.926mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 127.29808 127.28933"><metadata id="metadata3909"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" fill-rule="evenodd" transform="translate(0 -925.07)"><ellipse id="circle4330" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="63.649" ry="63.645" cy="988.72" cx="63.649" fill="#303030"/><ellipse id="circle4223" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="59.705" ry="59.701" cy="988.72" cx="63.649" fill="#4c4c4c"/></g></svg>',G='<svg id="svg3754" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.711mm" width="9.9653mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 35.3101 37.950677"><metadata id="metadata3759"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1014.4)"><path id="path4326" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m34.81 1017.1c-15.254-3.8172-24.634-1.7612-34.31 0v16.247h0.015c-0.013 0.097-0.013 0.1951-0.015 0.2928 0.0006 9.4753 7.6813 18.256 17.156 18.256 9.4739-0.0005 17.154-8.7813 17.154-18.256 0-0.097-0.014-0.1952-0.014-0.2928h0.014z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>',j='<svg id="svg3790" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.9646mm" width="10.711mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 37.953175 35.3077"><metadata id="metadata3795"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1017.1)"><path id="path4324" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m35.298 1017.6c3.8175 15.253 1.7611 24.633 0 34.308h-16.248v-0.015c-0.098 0.01-0.1952 0.01-0.2928 0.015-9.476-0.0006-18.258-7.6807-18.257-17.154 0.0005-9.4733 8.7818-17.153 18.257-17.153 0.098 0 0.1952 0.01 0.2928 0.011v-0.011z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>',z='<svg id="svg3754" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.711mm" width="9.9653mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 35.3101 37.950677"><metadata id="metadata3759"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1014.4)"><path id="path4328" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m34.81 1049.7c-15.254 3.8172-24.634 1.7612-34.31 0v-16.247h0.015c-0.013-0.097-0.013-0.1951-0.015-0.2928 0.0006-9.4753 7.6813-18.256 17.156-18.256 9.4739 0.0005 17.154 8.7813 17.154 18.256 0 0.097-0.014 0.1952-0.014 0.2928h0.014z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>',Y='<svg id="svg3790" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.9646mm" width="10.711mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 37.953175 35.3077"><metadata id="metadata3795"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1017.1)"><path id="path4324" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m2.6552 1051.9c-3.8175-15.253-1.7611-24.633 0-34.308h16.248v0.015c0.098-0.01 0.1952-0.01 0.2928-0.015 9.476 0.0006 18.258 7.6807 18.257 17.154-0.0005 9.4733-8.7818 17.153-18.257 17.153-0.098 0-0.1952-0.01-0.2928-0.011v0.011z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>',H='<svg id="svg3548" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="13.417mm" width="13.418mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 47.543997 47.542"><metadata id="metadata3553"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1004.8)"><ellipse id="circle4271" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="23.772" ry="23.771" cy="1028.6" cx="23.772" fill="#303030"/><ellipse id="circle4273" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" stroke-linecap="round" rx="18.668" ry="18.667" stroke="#3b63c9" cy="1028.6" cx="23.772" fill="#5276cf"/></g></svg>',W='<svg id="svg3461" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="22.608mm" width="22.61mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 80.114398 80.108405"><metadata id="metadata3466"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(.0000019915 -972.25)"><g id="g3514-7" fill-rule="evenodd" transform="translate(-987.45 356.91)"><ellipse id="ellipse3516-7" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="40.057" ry="40.054" cy="655.39" cx="1027.5" fill="#3b63c9"/><ellipse id="ellipse3518-7" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="36.23" ry="36.228" cy="655.39" cx="1027.5" fill="#5276cf"/></g></g></svg>',q='<svg id="svg3699" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.2811mm" width="9.2817mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 32.8879 32.88565"><metadata id="metadata3704"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" fill-rule="evenodd" transform="translate(0 -1019.5)"><ellipse id="ellipse4575" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="16.444" ry="16.443" cy="1035.9" cx="16.444" fill="#2e2e2e"/><ellipse id="ellipse4577" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" stroke-linecap="round" rx="15.112" ry="15.11" stroke="#4364b2" cy="1035.9" cx="16.444" fill="#5276cf"/><ellipse id="ellipse4579" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="11.867" ry="11.866" cy="1035.9" cx="16.444" fill="#434343"/></g></svg>',V='<svg id="svg3560" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="4.7796mm" width="13.57mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 48.082162 16.935645"><metadata id="metadata3565"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1035.4)"><path id="path4727" d="m42.857 1052.2c4.7071 0.4081 4.7981 0.6563 5.1414-4.9139 0.16344-2.6517 0.16699-6.1108-0.72615-8.0342-0.59471-1.2808-1.7793-2.049-3.7642-2.4662-2.5264-0.531-16.253-1.4345-26.685-1.3241-15.118 0.16-15.362 1.4769-15.855 4.1522-0.35071 1.9018-0.5016 3.5056-0.74837 5.5967-0.55261 7.0693-0.44908 7.0921 5.0452 6.5411 11.661-1.1062 25.929-0.7359 37.592 0.4484z" fill-rule="evenodd" fill="#5276cf"/></g></svg>',X='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="21.241671mm" height="8.8544388mm" viewBox="0 0 75.265762 31.373996" id="svg3447" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="l1.svg"><defs id="defs3449" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="1.4" inkscape:cx="-254.57869" inkscape:cy="228.81952" inkscape:document-units="px" inkscape:current-layer="layer1" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3452"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(1.5000945e-8,-1020.9882)"><path style="fill:#5276cf;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.99999994px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" d="m 11.026383,1051.1651 c -7.4440599,1.9144 -7.5133499,2.2466 -9.7963799,-4.4934 -1.81058997,-5.3452 -2.44278,-8.8152 4.01547,-12.116 2.74038,-1.4007 13.7365799,-5.877 38.4768299,-10.72 24.26031,-4.749 25.16653,-2.7967 26.79132,0.3418 1.15503,2.2311 1.8961,4.1561 2.94279,6.651 3.08552,8.5188 2.92609,8.5778 -6.08214,9.5501 -19.09891,2.1414 -37.95723,5.8307 -56.34789,10.7865 z" id="path4289" inkscape:connector-curvature="0" sodipodi:nodetypes="cssssccc" /></g></svg>',K='<svg id="svg3447" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="8.8544mm" width="21.242mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 75.265762 31.373996"><metadata id="metadata3452"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(1.5001e-8 -1021)"><path id="path4715" d="m64.239 1051.2c7.4441 1.9144 7.5134 2.2466 9.7964-4.4934 1.8106-5.3452 2.4428-8.8152-4.0155-12.116-2.7404-1.4007-13.737-5.877-38.477-10.72-24.26-4.749-25.167-2.7967-26.791 0.3418-1.155 2.2311-1.8961 4.1561-2.9428 6.651-3.0855 8.5188-2.9261 8.5778 6.0822 9.5501 19.099 2.1414 37.957 5.8307 56.348 10.786z" fill-rule="evenodd" fill="#5276cf"/></g></svg>',Z='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="24.603382mm" height="24.601696mm" viewBox="0 0 87.177338 87.171363" id="svg3640" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="main.svg"><defs id="defs3642" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="1.979899" inkscape:cx="61.113463" inkscape:cy="69.71796" inkscape:document-units="px" inkscape:current-layer="layer1" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3645"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(0,-965.19093)"><ellipse ry="43.585682" rx="43.588669" style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#2e2e2e;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.99999994;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" id="ellipse4372" cx="43.588669" cy="1008.7766" /><ellipse cy="1008.7766" cx="43.588669" id="circle4239-1" style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#5276cf;fill-opacity:1;fill-rule:evenodd;stroke:#4364b2;stroke-width:0.99999994;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" rx="40.056705" ry="40.053959" /><ellipse style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#434343;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.99999994;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" id="circle4243-0" cx="43.588669" cy="1008.7766" rx="31.455994" ry="31.453836" /></g></svg>',Q='<svg id="svg3407" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="41.787mm" width="41.786mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 148.0624 148.06251"><metadata id="metadata3412"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -904.3)" fill="#e6e6e6"><path id="rect4545" d="m74.031 904.3-14.469 22.156h8.0313v8.2187h12.875v-8.2187h8.0625l-14.5-22.156z"/><path id="rect4603" d="m125.94 963.86v8.0313h-8.25v12.906h8.25v8.0313l22.125-14.5-22.125-14.469z"/><path id="rect4609" d="m67.594 1022v8.25h-8.0313l14.469 22.125 14.5-22.125h-8.0625v-8.25h-12.875z"/><path id="rect4615" d="m22.156 963.86-22.156 14.47l22.156 14.5v-8.2188h8.2188v-12.906h-8.2188v-7.8438z"/><path id="path4619" style="color:#000000;text-indent:0;block-progression:tb;text-decoration-line:none;text-transform:none" d="m54.393 924.58c-15.821 5.7885-28.404 18.385-34.188 34.219h11.156c4.6667-10.175 12.865-18.361 23.031-23.031v-11.188zm39.219 0.031v11.156c10.167 4.6713 18.361 12.86 23.031 23.031h11.156c-5.7846-15.821-18.379-28.393-34.188-34.188zm-73.375 73.438c5.7899 15.816 18.348 28.403 34.156 34.188v-11.156c-10.163-4.6691-18.364-12.861-23.031-23.031h-11.125zm96.406 0c-4.6712 10.167-12.868 18.361-23.031 23.031v11.125c15.796-5.7901 28.366-18.352 34.156-34.156h-11.125z"/></g></svg>',J='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="112.08413mm" height="128.46834mm" viewBox="0 0 397.14849 455.20277" id="svg3440" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="wheel.svg"><defs id="defs3442" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="0.98994949" inkscape:cx="421.01508" inkscape:cy="52.510802" inkscape:document-units="px" inkscape:current-layer="g87" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3445"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title /></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(-2.3645008e-8,-597.15942)"><path inkscape:connector-curvature="0" style="fill:#4d4d4d;stroke:#6e6e6e;stroke-width:2.99125171;stroke-miterlimit:4;stroke-dasharray:none" id="path4140" d="m 307.84153,715.52552 c -4.35995,43.11849 -2.78952,86.66385 -15.90234,128.54337 -10.85452,25.86023 -13.33477,47.2976 6.91492,61.09536 7.23778,50.7442 78.38013,47.39232 82.20535,0 23.06079,-14.19054 13.49405,-42.79138 6.91492,-61.09536 -17.40045,-40.83001 -4.82581,-86.43019 -15.90235,-128.54337 -8.3177,-20.33228 -56.75348,-20.7661 -64.22927,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#cccccc;stroke:#1a1a1a;stroke-width:2.09465766;stroke-miterlimit:4;stroke-dasharray:none" id="path4266" d="m 313.11812,724.1957 -3.84514,68.80568 c 4.64168,13.40814 62.19981,10.8172 61.83082,0 l -3.84515,-68.80568 c -4.46942,-24.00369 -52.58756,-18.95946 -54.13979,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#353535;stroke:#2c2c2c;stroke-width:2.11880326;stroke-miterlimit:4;stroke-dasharray:none" id="path4156" d="m 304.91419,870.673 c -12.36924,67.40381 80.42804,69.69607 70.55134,0 -6.57605,-36.5947 -65.0964,-34.8253 -70.55134,0 z m 60.53812,3.9862 c 8.65841,48.24354 -57.58987,49.86644 -50.52489,0 4.7009,-26.27069 46.6394,-24.84292 50.52489,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#e6e6e6;stroke:#969696;stroke-width:2.99125171;stroke-miterlimit:4;stroke-dasharray:none" id="path4011" d="m 106.04576,696.97906 c -11.197076,4.25792 -17.123706,8.24834 -17.123706,8.24834 l -66.18493,16.33946 1.40291,30.64619 46.54715,-7.67623 c 17.00932,-1.6438 32.551896,8.94676 38.302026,23.34506 l 2.78663,65.4778 27.6363,0 2.78663,-65.4778 c 8.0428,-15.3291 20.46247,-27.10803 38.30202,-23.34506 l 46.54716,7.67623 1.40291,-30.64619 -66.18493,-16.33946 c 0,0 -5.92627,-3.99074 -17.12371,-8.24834 -13.45408,-4.31874 -26.62772,-4.20804 -39.08982,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#252525;stroke:#6e6e6e;stroke-width:2.99125171;stroke-miterlimit:4;stroke-dasharray:none" id="path2996" d="m 38.311064,931.09899 c -8.01574,5.05649 -22.76006,21.74743 -26.34852,58.0567 -4.1290804,35.18581 -4.8394604,60.59901 28.55878,61.68771 l 162.934726,0 c 39.19437,1.1693 30.46155,-41.5992 28.55878,-61.68771 -3.58839,-36.30927 -18.33277,-52.99983 -26.34851,-58.0567 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#373737;stroke:#6e6e6e;stroke-width:2.83429575;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none" id="path3019" d="m 26.230254,979.1291 c -11.50334,14.44882 -11.98241,47.3999 -0.33519,57.1202 l 191.802226,0 c 12.10111,-12.3068 9.93082,-46.99573 -0.33518,-57.1202 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#808080;stroke:#1a1a1a;stroke-width:2.14882827;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0" id="path4133" d="m 360.82498,854.6914 a 20.634815,21.265151 0 1 1 -41.269,0 20.634815,21.265151 0 1 1 41.269,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#333333;stroke:#000000;stroke-width:2.11880326;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0" id="path4280" d="m 351.64051,761.132 a 11.444622,11.75148 0 1 1 -22.88896,0 11.444622,11.75148 0 1 1 22.88896,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#313131;stroke:#565656;stroke-width:2.93434715;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0" id="path3993" d="m 125.52855,598.62659 c -68.528026,0 -124.0613764,57.81925 -124.0613764,129.13695 0,71.31265 55.5370404,129.13696 124.0613764,129.13696 68.52804,0 124.07984,-57.81926 124.07984,-129.13696 0,-71.31264 -55.55611,-129.13695 -124.07984,-129.13695 z m -1.00095,23.63932 c 10.01261,0.0734 20.238,1.32074 28.95237,3.51006 11.62203,3.80301 21.53624,8.52304 31.01135,16.15381 26.21752,19.0207 43.36275,50.36277 43.36275,85.83029 0,58.01564 -45.80548,105.05244 -102.30928,105.05244 -56.500726,0 -102.309276,-47.03364 -102.309276,-105.05244 0,-32.14848 14.06783,-60.91918 36.22336,-80.19121 11.45168,-11.11714 23.14136,-17.13322 37.3943,-21.79731 7.855846,-2.48302 17.655666,-3.5835 27.668276,-3.51006 z" stroke-miterlimit="4" /><g style="stroke-miterlimit:4;stroke-dasharray:none" id="g4127" stroke-miterlimit="4" transform="matrix(0.61498728,0,0,0.63147657,-18.171616,453.28593)"><g id="g4111"><path style="fill:#808080;stroke:#373737;stroke-width:3.56837296" inkscape:connector-curvature="0" id="rect3040" d="m 110.97,771.16 31.694,4.8776 1.3007,44.257 -32.995,0 z" /><path style="fill:#b3b3b3;stroke:#565656;stroke-width:3.4000001;stroke-linecap:butt;stroke-linejoin:miter" inkscape:connector-curvature="0" id="path3024" d="m 96.83,686.82 58.353,-5.0761 c 15.608,27.569 6.8304,64.333 -5.0761,90.545 l -53.841,-2.538 z" /></g><g id="g4115" transform="translate(97.984785,0)"><path style="fill:#808080;stroke:#373737;stroke-width:3.56837296" inkscape:connector-curvature="0" id="path4117" d="m 110.97,771.16 31.694,4.8776 1.3007,44.257 -32.995,0 z" /><path style="fill:#b3b3b3;stroke:#565656;stroke-width:3.4000001;stroke-linecap:butt;stroke-linejoin:miter" inkscape:connector-curvature="0" id="path4119" d="m 96.83,686.82 58.353,-5.0761 c 15.608,27.569 6.8304,64.333 -5.0761,90.545 l -53.841,-2.538 z" /></g><g id="g4121" transform="translate(195.96959,0)"><path style="fill:#808080;stroke:#373737;stroke-width:3.56837296" inkscape:connector-curvature="0" id="path4123" d="m 110.97,771.16 31.694,4.8776 1.3007,44.257 -32.995,0 z" /><path style="fill:#b3b3b3;stroke:#565656;stroke-width:3.4000001;stroke-linecap:butt;stroke-linejoin:miter" inkscape:connector-curvature="0" id="path4125" d="m 96.83,686.82 58.353,-5.0761 c 15.608,27.569 6.8304,64.333 -5.0761,90.545 l -53.841,-2.538 z" /></g></g><g style="fill:#666666;stroke:#969696;stroke-width:3.99777174;stroke-miterlimit:4;stroke-dasharray:none" id="g4051" transform="translate(-42.878584,98.083591)" stroke-miterlimit="4"><g id="g4437" transform="matrix(0.74686368,0,0,0.74686368,-73.374214,285.30447)"><path inkscape:connector-curvature="0" id="rect4348" style="color:#000000;text-indent:0;text-transform:none;block-progression:tb;fill:#ffffff" d="m 567.31,584.22 0,42.25 0,3.4062 0,42.25 3.375,0 0,-42.25 27.062,0 0,42.25 3.375,0 0,-42.25 27.062,0 0,42.25 3.375,0 0,-42.25 27.062,0 0,42.25 3.4062,0 0,-43.969 0,-1.6875 -1.7188,0 -28.75,0 0,-42.25 -3.375,0 0,42.25 -27.062,0 0,-42.25 -3.375,0 0,42.25 -27.062,0 0,-42.25 -3.375,0 z" /><g style="fill:#a02c2c;stroke:#ffffff;stroke-width:3.4000001;stroke-linecap:square" id="g87" /></g></g></g></svg>',$='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="5.4777083mm" height="5.5003009mm" viewBox="0 0 19.409203 19.489255" id="svg3402" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="wheel_btn.svg"><defs id="defs3404" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="22.4" inkscape:cx="4.7324003" inkscape:cy="15.245372" inkscape:document-units="px" inkscape:current-layer="layer1" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3407"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(8.5754969e-8,-1032.873)"><path inkscape:connector-curvature="0" style="fill:#5276cf;stroke:#000000;stroke-width:3.4000001;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;fill-opacity:1" id="path4272" d="m 17.709101,1042.6176 a 8.0046,8.0046 0 1 1 -16.0089998,0 8.0046,8.0046 0 1 1 16.0089998,0 z" stroke-miterlimit="4" /></g></svg>',ee='<svg id="svg3400" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.507mm" width="15.1mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 53.504016 37.228838"><metadata id="metadata3405"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(-2.847e-7 -1015.1)"><path id="path4049" d="m26.584 1016.1c-12.631 0-23.15 9.858-25.478 22.922l50.705 12.18c0.47921-2.1565 0.73023-4.4099 0.73023-6.7204 0-15.677-11.621-28.382-25.957-28.382z" stroke="#5276cf" stroke-linecap="square" stroke-width="1.9247" fill="#666"/></g></svg>',te='<svg id="svg3400" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.507mm" width="15.1mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 53.504016 37.228838"><metadata id="metadata3405"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(-2.847e-7 -1015.1)"><path id="path4033" d="m26.92 1016.1c-14.337 0-25.957 12.707-25.957 28.382 0 2.3225 0.26742 4.5784 0.74876 6.7386l50.681-12.18c-2.321-13.072-12.841-22.944-25.476-22.944z" stroke="#5276cf" stroke-linecap="square" stroke-width="1.9247" fill="#666"/></g></svg>',re='<svg id="svg3386" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="12.859mm" width="5.2917mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 18.749999 45.562501"><metadata id="metadata3391"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1006.8)"><path id="rect4575" d="m9.3125 1006.8-9.3125 14.25h5.3125v17.094h-5.1875l9.3125 14.219 9.3125-14.219h-5.1562v-17.094h5.0312l-9.3125-14.25z" fill="#e6e6e6"/></g></svg>',ae='<svg id="svg3458" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="50.447mm" width="83.899mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 297.28131 178.75"><metadata id="metadata3463"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -873.61)" fill="#e6e6e6"><path id="path4535" style="color:#000000;text-indent:0;block-progression:tb;text-decoration-line:none;text-transform:none" d="m33.875 873.61-18.5 8.8125 5.0626 3.0625c-12.899 22.78-20.438 49.17-20.438 77.44 0 28.284 7.5315 54.691 20.438 77.469l-5.0626 3.0625 18.5 8.8125 0.6563-20.469-5.531 3.3c-12.002-21.2-18.937-45.8-18.937-72.18 0-26.362 6.9415-50.99 18.937-72.188l5.5313 3.3438-0.6563-20.469z"/><path id="path4551" style="color:#000000;text-indent:0;block-progression:tb;text-decoration-line:none;text-transform:none" d="m263.38 873.71-0.6562 20.469 5.5312-3.3438c11.996 21.198 18.969 45.825 18.969 72.188 0 26.371-6.9672 51.011-18.969 72.219l-5.5312-3.3437 0.6562 20.469 18.5-8.8125-5.0312-3.0625c12.906-22.778 20.438-49.184 20.438-77.469 0-28.275-7.5391-54.665-20.438-77.438l5.0312-3.0625-18.5-8.8125z"/></g></svg>',ne='<svg id="svg3378" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="2.9016mm" width="9.2516mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 32.781198 10.281199"><metadata id="metadata3383"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1042.1)"><path id="rect4585" d="m32.781 1047.2-7.875-5.125v2.8437h-17.031v-2.8437l-7.875 5.1 7.875 5.1562v-2.8437h17.031v2.8437z" fill="#e6e6e6"/></g></svg>',_e='<svg id="svg3378" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.2516mm" width="2.9016mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 10.281248 32.7812"><metadata id="metadata3383"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1019.6)"><path id="rect4585" d="m5.125 1019.6-5.125 7.9h2.8437v17.031h-2.8437l5.125 7.875 5.1562-7.875h-2.8438v-17.031h2.8438z" fill="#e6e6e6"/></g></svg>',se=[],oe=-1,ie=null,le=P,ce=null,ue=null,de=null,fe=null,me=null,ve=null,be=[],ye=[],Ee=[],we=[],Ae=!0,Te={};Te[A.GMPD_AXIS_0]=-2,Te[A.GMPD_AXIS_1]=-2,Te[A.GMPD_AXIS_2]=-2,Te[A.GMPD_AXIS_3]=-2,Te[A.GMPD_AXIS_4]=-2,Te[A.GMPD_AXIS_5]=-2,Te[A.GMPD_AXIS_6]=-2,Te[A.GMPD_AXIS_7]=-2,Te[A.GMPD_AXIS_8]=-2,Te[A.GMPD_AXIS_9]=-2,Te[A.GMPD_AXIS_10]=-2,Te[A.GMPD_AXIS_11]=-2,t.show=function(){var e=document.createElement("div");ce=e,e.style.cssText="position: absolute;width: 720px;height: 750px;top: 50%;left: 50%;-moz-transform: translateY(-50%) translateX(-50%);-ms-transform: translateY(-50%) translateX(-50%);-webkit-transform: translateY(-50%) translateX(-50%);transform: translateY(-50%) translateX(-50%);background-color: black;border: 4px solid white;border-radius: 35px;box-shadow: 0px 0px 20px 0px rgba(50, 50, 50, 1);",E.insert_to_container(e,"LAST"),u(e);var t=document.createElement("div");t.style.cssText="position: absolute;width: 637px;top: 0px;font-family: sans-serif;text-align: center;margin-top: 40px;-moz-transform: translateX(-50%);-ms-transform: translateX(-50%);-webkit-transform: translateX(-50%);transform: translateX(-50%);left: 50%;";var o=document.createElement("div");for(o.innerHTML="Select a device",o.style.cssText="color: #fff;display: inline-block;",t.appendChild(o),S=0;S<4;S++){var i=f(S),l=function(){return!0},d=function(e,t,r){if(t==oe)for(var a=0;a<ye.length;a++)_(ye[a],w.get_sensor_value(e,t,a),a)};w.create_sensor_manifold(null,S,w.CT_CONTINUOUS,i,l,d)}s().length>0&&(oe=0);var h=[],b=document.createElement("div");b.style.cssText="margin-top: 20px;";for(var T=0;T<4;T++){var x=g(T);T==oe&&(x.style.backgroundColor="green",de=x),c(T),b.appendChild(x),x.setAttribute("data-device_type","PAD"),h.push(x),A.add_click_listener(x,function(e){for(var t=s(),r=e.target,a=0;a<t.length;a++)h[a]==r&&(de=r,c(oe=a),v(r.getAttribute("data-device_type")))})}t.appendChild(b),(ve=document.createElement("label")).style.cssText="position: relative;display: block;color: white;",t.appendChild(ve);var O=document.createElement("div");O.style.cssText="margin-top: 20px;";var R=p(O,"Pad"),k=p(O,"Wheel");R.setAttribute("checked","true"),R.onchange=function(){v("PAD"),de&&de.setAttribute("data-device_type","PAD")},k.onchange=function(){v("WHEEL"),de&&de.setAttribute("data-device_type","WHEEL")},R.setAttribute("id","test"),me=R,fe=k;var N=document.createElement("label");N.style.cssText+="color: #fff;display: block;",O.appendChild(N),N.textContent=M,N.setAttribute("id","action_label"),t.appendChild(O),e.appendChild(t);var I=w.create_elapsed_sensor();w.create_sensor_manifold(null,"UPDATE_GAMEPAD_DATA",w.CT_CONTINUOUS,[I],l,function(e,t,r){var a=s(),n=a.length;-1==oe&&a.length&&(oe=a[0].index,de=h[oe]);for(var _=0;_<h.length;_++)_<n?(h[_].textContent=a[_].index,h[_]==de?(h[_].style.backgroundColor="green",ve.textContent="Selected device: "+a[_].index+". Data: "+a[_].id):h[_].style.backgroundColor="blue"):h[_].style.backgroundColor="black";n||(oe=-1,ve.textContent="")});for(var S=0;S<4;S++){var i=m(S),d=function(e,t,_){if(t=="AXES"+oe){for(s=0;s<Ee.length;s+=2)r(Ee[s],e,t,s);if(Ae)for(s=0;s<12;s+=2)a(e,t,s);else for(var s=0;s<12;s++)n(e,t,s)}};w.create_sensor_manifold(null,"AXES"+S,w.CT_CONTINUOUS,i,function(){return!0},d)}y(),window.addEventListener("resize",y)},t.hide=function(){le=P,oe=-1,de=null,ie=null,fe=null,me=null,Ee.length=0,ye.length=0,we.length=0,E.get_container().removeChild(ce),ce=null,w.remove_sensor_manifold(null,"UPDATE_GAMEPAD_DATA");for(var e=0;e<4;e++)w.remove_sensor_manifold(null,e),w.remove_sensor_manifold(null,"AXES"+e);window.removeEventListener("resize",y)},t.update=function(){for(var e=0;e<4;e++)c(e)}}),o("gyroscope",function(e,t){function r(e){var t=n.create_gyro_angles_sensor(),r=n.create_gyro_quat_sensor(),_=!0;n.create_sensor_manifold(e,"CAMERA_ROTATE_GYRO",n.CT_CONTINUOUS,[t,r],null,function(e,t,r){if(r>0)if(a.is_eye_camera(e)){var l=n.get_sensor_payload(e,t,1),v=i.transformQuat(o.AXIS_MY,l,d);a.set_vertical_axis(e,v),s.set_rotation_v(e,l)}else{u=n.get_sensor_payload(e,t,0),_&&(c[0]=u[0],c[1]=u[1],c[2]=u[2],_=!1);var b=0,g=0;0==window.orientation&&(b=u[1]-c[1],g=u[0]-c[0],u[1]>m&&u[1]<f&&(g=0)),180==window.orientation&&(b=u[1]-c[1],u[1]<0&&(b=-b),g=c[0]-u[0],(b>Math.PI/2||b<-Math.PI/2)&&(b=0),u[1]>-f&&u[1]<-m&&(g=0)),-90==window.orientation&&(((b=u[0]-c[0])>Math.PI/2||b<-Math.PI/2)&&(b=0),g=c[1]-u[1],(u[0]>p||u[0]<h)&&(g=0)),90==window.orientation&&(((b=c[0]-u[0])>Math.PI/2||b<-Math.PI/2)&&(b=0),g=u[1]-c[1],(u[0]>p||u[0]<h)&&(g=0)),a.rotate_camera(e,g,b),c[0]=u[0],c[1]=u[1],c[2]=u[2]}})}var a=de(e),n=he(e),_=Te(e),s=xe(e),o=Oe(e),i=l(e),c=new Float32Array(3),u=new Float32Array(3),d=i.create(),f=o.deg_to_rad(110),m=o.deg_to_rad(70),p=o.deg_to_rad(70),h=-o.deg_to_rad(70);t.enable_camera_rotation=function(){r(_.get_active_camera())},t.disable_camera_rotation=function(){var e=_.get_active_camera();n.remove_sensor_manifold(e,"CAMERA_ROTATE_GYRO")}}),o("hmd_conf",function(e,t){function r(){if(!T.can_use_device(T.DEVICE_HMD))return!1;var e=T.get_device_by_type_element(T.DEVICE_HMD),t=T.get_value_param(e,T.HMD_WEBVR_TYPE);return t&(T.HMD_NON_WEBVR|T.HMD_WEBVR_MOBILE|T.HMD_WEBVR_DESKTOP)&&!(t&T.HMD_WEBVR1)}function a(){var e=O.get("hmd_conf","b4w"),t=JSON.parse(e||"{}").profile||"custom",r=document.createElement("div"),a=document.createElement("label");a.innerHTML="Profile: ",a.className="text_label",a.style.cssText="background-color: #323232;border: 2px solid rgba(98, 98, 98, .2);border-radius: 2px;width: 120px;height: 30px;display: block;float: left;font-size: 16px;font-weight: normal;color: #fff;cursor: pointer;text-decoration: none;text-align: left;padding-left: 8px;line-height: 28px;margin-bottom: 4px;box-shadow: 0px 0px 4px 0px rgba(98, 98, 98, .8);",r.appendChild(a);var _=document.createElement("select");r.appendChild(_),_.style.cssText="background-color: #323232;border: 2px solid rgba(98, 98, 98, .2);border-radius: 2px;height: 30px;display: block;font-size: 16px;font-weight: normal;color: #fff;cursor: pointer;text-decoration: none;text-align: left;padding-left: 8px;line-height: 28px;margin-bottom: 4px;box-shadow: 0px 0px 4px 0px rgba(98, 98, 98, .8);";var s=T.get_device_by_type_element(T.DEVICE_HMD);if(s)for(var o in V)if(V[o].type==W||T.get_value_param(s,T.HMD_WEBVR_TYPE)&(T.HMD_NON_WEBVR|T.HMD_WEBVR_MOBILE)&&V[o].type==q){var i=document.createElement("option");i.value=o,i.text=V[o].name,_.appendChild(i)}return _.value=t,R.is_ie11()?_.onchange=n:_.oninput=n,r}function n(e){var t=e.target.value,r=V[t];for(var a in L)if(a in r){var n=document.getElementById(a+"_slider");n&&(n.disabled="custom"!==t,n.value=r[a]);var _=document.getElementById(a+"_number");_&&(_.disabled="custom"!==t,_.value=r[a]),L[a]=r[a]}}function _(){A.remove_sensor_manifold(null,"UPDATE_HMD_RENDERING"),f(),h(),k&&(k=!1,i())}function s(){f(!0),h(),o()}function o(){for(var e in L){var t=document.getElementById(e+"_slider");t&&(t.value=L[e]);var r=document.getElementById(e+"_number");r&&(r.value=L[e])}}function i(){w.get_container().removeChild(N),document.head.removeChild(M),N=null,I=null,M=null}function l(){return Math.max(window.screen.width,window.screen.height)*window.devicePixelRatio}function c(){return Math.min(window.screen.width,window.screen.height)*window.devicePixelRatio}function u(e,t,r,a){return e.ua&&t.indexOf(e.ua)>=0||!e.ua&&e.res&&e.res[0]&&e.res[1]&&Math.min(r,a)==Math.min(e.res[0],e.res[1])&&Math.max(r,a)==Math.max(e.res[0],e.res[1])}function d(e,t,r,a){if(1!=e.format||!e.devices||!e.devices.length)return x.error("DPDB isn't correct."),-1;for(var n=0;n<e.devices.length;n++){var _=e.devices[n];if(_.rules&&("ios"==_.type&&Y||"android"==_.type)){for(var s=!1,o=0;o<_.rules.length;o++)if(u(_.rules[o],t,r,a)){s=!0;break}if(s)return n}}return-1}function f(e){var t=navigator.userAgent||navigator.vendor||window.opera,r=l(),a=c(),n=0,_=0,s=0,o=d(K,t,r,a);if(-1!=o){var i=K.devices[o],u=i.dpi[0]||i.dpi,f=i.dpi[1]||i.dpi;n=Math.round(r*z/u),_=Math.round(a*z/f),s=Math.round(i.bw)}var m=O.get("hmd_conf","b4w"),p=JSON.parse(m||"{}");e?(L.first_distortion=C,L.second_distortion=P,L.bevel_size=s||D,L.screen_width=n||U,L.screen_height=_||F,L.screen_lense=B,L.ipd=G,L.baseline=j):(L.first_distortion="first_distortion"in p?parseFloat(p.first_distortion):C,L.second_distortion="second_distortion"in p?parseFloat(p.second_distortion):P,L.bevel_size="bevel_size"in p?parseFloat(p.bevel_size):s||D,L.screen_width="screen_width"in p?parseFloat(p.screen_width):n||U,L.screen_height="screen_height"in p?parseFloat(p.screen_height):_||F,L.screen_lense="screen_lense"in p?parseFloat(p.screen_lense):B,L.ipd="ipd"in p?parseFloat(p.ipd):G,L.baseline="baseline"in p?parseFloat(p.baseline):j),S=!0}function p(){O.set("hmd_conf",JSON.stringify(L),"b4w"),_()}function h(){if(S){var e=T.get_device_by_type_element(T.DEVICE_HMD);e&&(T.set_config(e,T.HMD_DISTORTION,[L.first_distortion,L.second_distortion]),T.get_value_param(e,T.HMD_WEBVR_TYPE)&(T.HMD_NON_WEBVR|T.HMD_WEBVR_MOBILE)&&(T.set_config(e,T.HMD_BEVEL_SIZE,L.bevel_size*H),T.set_config(e,T.HMD_SCREEN_WIDTH,L.screen_width*H),T.set_config(e,T.HMD_SCREEN_HEIGHT,L.screen_height*H),T.set_config(e,T.HMD_SCREEN_LENS_DIST,L.screen_lense*H),T.set_config(e,T.HMD_EYE_DISTANCE,L.ipd*H),T.set_config(e,T.HMD_BASELINE_DIST,L.baseline*H))),S=!1}}function v(e){var t=e.target.id.split("_"),r=t.splice(0,t.length-1).join("_");r in L&&L[r]!=e.target.value&&(S=!0,L[r]=e.target.value,document.getElementById(r+"_slider").value=e.target.value,document.getElementById(r+"_number").value=e.target.value)}function b(e,t){var r=document.createElement("div"),a=document.createElement("label");a.className="text_label";var n="8px";t%2&&(n="0"),a.style.cssText="background-color: #323232;border: 2px solid rgba(98, 98, 98, .2);border-radius: 2px;width: 100%;height: 30px;display: block;font-size: 16px;font-weight: normal;color: #fff;cursor: pointer;text-decoration: none;text-align: left;padding-left: 8px;line-height: 28px;margin-bottom: 4px;box-shadow: 0px 0px 4px 0px rgba(98, 98, 98, .8);",a.textContent=e.label,r.appendChild(a),r.style.cssText="margin-top: 16px;float: left;width: 240px;margin-right: "+n+";border-top: 2px solid rgba(98, 98, 98, .4);box-sizing: border-box;-webkit-box-sizing: border-box;padding-top: 8px;";for(var _=0;_<e.inputs.length;_++){var s=g(e.inputs[_]);r.appendChild(s)}return r}function g(e){var t=document.createElement("div");t.className="row";var r=document.createElement("input");r.className="input_slider",r.style.cssText="-webkit-appearance: none;width: 192px;display: block;float: left;height: 8px;margin-bottom: 16px;margin-top: 16px;box-sizing: border-box;margin-right: 8px;margin-left: 0;",r.setAttribute("id",e.id+"_slider"),r.setAttribute("type","range"),r.setAttribute("min","0.00"),r.setAttribute("step",e.step),r.setAttribute("value",L[e.id]),r.setAttribute("max",e.max),t.appendChild(r);var a=document.createElement("input");return a.className="input_text",a.setAttribute("id",e.id+"_number"),a.setAttribute("type","number"),a.setAttribute("min","0.00"),a.setAttribute("step",e.step),a.setAttribute("value",L[e.id]),a.setAttribute("max",e.max),t.appendChild(a),a.style.cssText="background-color: #323232;border: 2px solid rgba(98, 98, 98, .2);border-radius: 2px;width: 40px;height: 30px;display: block;float: left;font-size: 16px;font-weight: normal;color: #fff;cursor: pointer;text-decoration: none;text-align: center;box-sizing: border-box;line-height: 28px;margin-top: 4px;margin-right: 0;margin-left: 0;box-shadow: 0px 0px 4px 0px rgba(98, 98, 98, .8);",R.is_ie11()?(r.onchange=v,a.onchange=v):(r.oninput=v,a.oninput=v),t}function y(){var e=document.createElement("div"),t=E(p,"SAVE","4px"),r=E(_,"CANCEL","4px"),a=E(s,"RESET","0px");return e.className="row",e.style.cssText="padding-top: 32px;clear: both;box-sizing: border-box;-webkit-box-sizing: border-box;",e.appendChild(t),e.appendChild(r),e.appendChild(a),e}function E(e,t,r){var a=document.createElement("button");return a.onclick=e,a.style.cssText="background-color: #323232;border: 2px solid rgba(98, 98, 98, .2);border-radius: 2px;width: 160px;height: 30px;display: block;float: left;font-size: 16px;font-weight: normal;color: #fff;cursor: pointer;text-decoration: none;text-align: center;padding-left: 8px;line-height: 28px;margin-right:"+r+";box-shadow: 0px 0px 4px 0px rgba(98, 98, 98, .8);",a.innerHTML=t,a}var w=pe(e),A=he(e),T=ge(e),x=m(e),O=Me(e),R=Oe(e),k=!1,N=null,M=null,I=null,S=!0,L={profile:"custom",first_distortion:0,second_distortion:0,bevel_size:0,screen_width:0,screen_height:0,screen_lense:0,ipd:0,baseline:0},C=.34,P=.55,D=4,U=110,F=65,B=50,G=64,j=32,z=25.4,Y=/iPad|iPhone|iPod/.test(navigator.platform),H=.001,W=0,q=1,V={oculus_dk2:{name:"Oculus Rift DK2",type:2,first_distortion:.22,second_distortion:.28},cardboard_1:{name:"Cardboard (2014)",type:q,ipd:60,baseline:35,screen_lense:42,first_distortion:.441,second_distortion:.156},cardboard_2:{name:"Cardboard (2015)",type:q,ipd:64,baseline:35,screen_lense:39,first_distortion:.34,second_distortion:.55},custom:{name:"Custom",type:W,ipd:64,baseline:35,screen_lense:39,first_distortion:0,second_distortion:0}},X=[{label:"Tray to lens-center distance.",is_mobile:!0,inputs:[{id:"baseline",max:"50",step:"0.5"}]},{label:"Interpupillary distance.",is_mobile:!0,inputs:[{id:"ipd",max:"100",step:"1"}]},{label:"Screen to lense distance.",is_mobile:!0,inputs:[{id:"screen_lense",max:"100",step:"1"}]},{label:"Screen height.",is_mobile:!0,inputs:[{id:"screen_height",max:"150",step:"1"}]},{label:"Screen width.",is_mobile:!0,inputs:[{id:"screen_width",max:"200",step:"1"}]},{label:"Bevel width.",is_mobile:!0,inputs:[{id:"bevel_size",max:"20",step:"1"}]},{label:"Distortion coefficients.",inputs:[{id:"first_distortion",max:"1.0",step:"0.01"},{id:"second_distortion",max:"1.0",step:"0.01"}]}];t.check=r,t.show=function(e){if(r()){var t=w.get_container();if(M=document.createElement("style"),M.innerHTML="."+e+" input[type=range]::-webkit-slider-runnable-track {width: 100%; height: 8px;cursor: pointer;background-color: #fff;border: 2px solid rgba(98, 98, 98, .2);box-shadow: 0px 0px 4px 0px rgba(98, 98, 98, .8);}."+e+" input[type=range]::-webkit-slider-thumb {box-shadow: 0px 0px 4px 0px rgba(98, 98, 98, .8);height: 30px;width: 16px;border-radius: 2px;background-color: #323232;cursor: pointer;margin-top: -13px;-webkit-appearance: none;}",document.head.appendChild(M),!k){k=!0,f();var n=T.get_device_by_type_element(T.DEVICE_MOUSE,t);T.switch_prevent_default(n,!1);var _=T.get_device_by_type_element(T.DEVICE_TOUCH,t);T.switch_prevent_default(_,!1),(N=document.createElement("div")).className=e,t.appendChild(N),I=document.createElement("div"),N.appendChild(I),I.style.cssText="background-color: #484848;border: 2px solid rgba(150, 150, 150, 0.7);box-shadow: 0px 0px 10px 0px rgba(150, 150, 150, 0.7);position: relative;width: 524px;padding: 16px;overflow: hidden;";var s=a();I.appendChild(s);for(var o=T.get_device_by_type_element(T.DEVICE_HMD),i=0;i<X.length;i++)if(T.get_value_param(o,T.HMD_WEBVR_TYPE)&(T.HMD_NON_WEBVR|T.HMD_WEBVR_MOBILE)||!X[i].is_mobile){var l=b(X[i],i);I.appendChild(l)}var c=y();I.appendChild(c);var u=A.create_timeline_sensor();A.create_sensor_manifold(null,"UPDATE_HMD_RENDERING",A.CT_CONTINUOUS,[u],null,h)}}},t.hide=_,t.reset=s,t.update=function(){f(),h()};var K={_comment:"AUTOMATICALLY GENERATED BY generate_dpdb.py. DO NOT EDIT.",format:1,last_updated:"2016-01-26T23:11:18Z",devices:[{type:"android",rules:[{mdmh:"asus/*/Nexus 7/*"},{ua:"Nexus 7"}],dpi:[320.8,323],bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_Z00AD/*"},{ua:"ASUS_Z00AD"}],dpi:[403,404.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC6435LVW/*"},{ua:"HTC6435LVW"}],dpi:[449.7,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC One XL/*"},{ua:"HTC One XL"}],dpi:[315.3,314.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"htc/*/Nexus 9/*"},{ua:"Nexus 9"}],dpi:289,bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One M9/*"},{ua:"HTC One M9"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One_M8/*"},{ua:"HTC One_M8"}],dpi:[449.7,447.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One/*"},{ua:"HTC One"}],dpi:472.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/Nexus 6P/*"},{ua:"Nexus 6P"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5X/*"},{ua:"Nexus 5X"}],dpi:[422,419.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS345/*"},{ua:"LGMS345"}],dpi:[221.7,219.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D800/*"},{ua:"LG-D800"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D850/*"},{ua:"LG-D850"}],dpi:[537.9,541.9],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/VS985 4G/*"},{ua:"VS985 4G"}],dpi:[537.9,535.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5/*"},{ua:"Nexus 5 B"}],dpi:[442.4,444.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 4/*"},{ua:"Nexus 4"}],dpi:[319.8,318.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LG-P769/*"},{ua:"LG-P769"}],dpi:[240.6,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS323/*"},{ua:"LGMS323"}],dpi:[206.6,204.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGLS996/*"},{ua:"LGLS996"}],dpi:[403.4,401.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/4560MMX/*"},{ua:"4560MMX"}],dpi:[240,219.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/A250/*"},{ua:"Micromax A250"}],dpi:[480,446.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/Micromax AQ4501/*"},{ua:"Micromax AQ4501"}],dpi:240,bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/DROID RAZR/*"},{ua:"DROID RAZR"}],dpi:[368.1,256.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT830C/*"},{ua:"XT830C"}],dpi:[254,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1021/*"},{ua:"XT1021"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1023/*"},{ua:"XT1023"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1028/*"},{ua:"XT1028"}],dpi:[326.6,327.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1034/*"},{ua:"XT1034"}],dpi:[326.6,328.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1053/*"},{ua:"XT1053"}],dpi:[315.3,316.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1562/*"},{ua:"XT1562"}],dpi:[403.4,402.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/Nexus 6/*"},{ua:"Nexus 6 B"}],dpi:[494.3,489.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1063/*"},{ua:"XT1063"}],dpi:[295,296.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1064/*"},{ua:"XT1064"}],dpi:[295,295.6],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1092/*"},{ua:"XT1092"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1095/*"},{ua:"XT1095"}],dpi:[422,423.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/A0001/*"},{ua:"A0001"}],dpi:[403.4,401],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1005/*"},{ua:"ONE E1005"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2005/*"},{ua:"ONE A2005"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OPPO/*/X909/*"},{ua:"X909"}],dpi:[442.4,444.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9082/*"},{ua:"GT-I9082"}],dpi:[184.7,185.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G360P/*"},{ua:"SM-G360P"}],dpi:[196.7,205.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Nexus S/*"},{ua:"Nexus S"}],dpi:[234.5,229.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[304.8,303.9],bw:5,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-T230NU/*"},{ua:"SM-T230NU"}],dpi:216,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SGH-T399/*"},{ua:"SGH-T399"}],dpi:[217.7,231.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N9005/*"},{ua:"SM-N9005"}],dpi:[386.4,387],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SM-N900A/*"},{ua:"SAMSUNG-SM-N900A"}],dpi:[386.4,387.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9500/*"},{ua:"GT-I9500"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/GT-I9505/*"},{ua:"GT-I9505"}],dpi:439.4,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900F/*"},{ua:"SM-G900F"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900M/*"},{ua:"SM-G900M"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G800F/*"},{ua:"SM-G800F"}],dpi:326.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G906S/*"},{ua:"SM-G906S"}],dpi:[562.7,572.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[306.7,304.8],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-T535/*"},{ua:"SM-T535"}],dpi:[142.6,136.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-N920C/*"},{ua:"SM-N920C"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300I/*"},{ua:"GT-I9300I"}],dpi:[304.8,305.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9195/*"},{ua:"GT-I9195"}],dpi:[249.4,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SPH-L520/*"},{ua:"SPH-L520"}],dpi:[249.4,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SGH-I717/*"},{ua:"SAMSUNG-SGH-I717"}],dpi:285.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SPH-D710/*"},{ua:"SPH-D710"}],dpi:[217.7,204.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-N7100/*"},{ua:"GT-N7100"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SCH-I605/*"},{ua:"SCH-I605"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Galaxy Nexus/*"},{ua:"Galaxy Nexus"}],dpi:[315.3,314.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910H/*"},{ua:"SM-N910H"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910C/*"},{ua:"SM-N910C"}],dpi:[515.2,520.2],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G130M/*"},{ua:"SM-G130M"}],dpi:[165.9,164.8],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G928I/*"},{ua:"SM-G928I"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G920F/*"},{ua:"SM-G920F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G920P/*"},{ua:"SM-G920P"}],dpi:[522.5,577],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G925F/*"},{ua:"SM-G925F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G925V/*"},{ua:"SM-G925V"}],dpi:[522.5,576.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/C6903/*"},{ua:"C6903"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"Sony/*/D6653/*"},{ua:"D6653"}],dpi:[428.6,427.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6653/*"},{ua:"E6653"}],dpi:[428.6,425.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6853/*"},{ua:"E6853"}],dpi:[403.4,401.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/SGP321/*"},{ua:"SGP321"}],dpi:[224.7,224.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"TCT/*/ALCATEL ONE TOUCH Fierce/*"},{ua:"ALCATEL ONE TOUCH Fierce"}],dpi:[240,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"THL/*/thl 5000/*"},{ua:"thl 5000"}],dpi:[480,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"ZTE/*/ZTE Blade L2/*"},{ua:"ZTE Blade L2"}],dpi:240,bw:3,ac:500},{type:"ios",rules:[{res:[640,960]}],dpi:[325.1,328.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[640,1136]}],dpi:[317.1,320.2],bw:3,ac:1e3},{type:"ios",rules:[{res:[750,1334]}],dpi:326.4,bw:4,ac:1e3},{type:"ios",rules:[{res:[1242,2208]}],dpi:[453.6,458.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[1125,2001]}],dpi:[410.9,415.4],bw:4,ac:1e3}]}}),o("sfx",function(e,t){var r=k(e),a=j(e),n=D(e),_=m(e);t.play=function(e,t,r){t=t||0,r=r||0,n.play(e,t,r)},t.play_def=function(e){n.play_def(e)},t.is_playing=function(e){return n.is_playing(e)},t.stop=function(e){n.stop(e)},t.pause=function(e){n.speaker_pause(e)},t.resume=function(e){n.speaker_resume(e)},t.loop_stop=function(e,t,r){t=t||0,r=r||!1,n.loop_stop(e,t,r)},t.playrate=function(e,t){n.playrate(e,t)},t.get_playrate=function(e){return n.get_playrate(e)},t.cyclic=function(e,t){n.cyclic(e,t)},t.is_cyclic=function(e){return n.is_cyclic(e)},t.listener_reset_speed=function(e,t){n.listener_stride()},t.listener_stride=function(){n.listener_stride()},t.speaker_reset_speed=function(e,t,r){n.speaker_stride(e)},t.speaker_stride=function(e){n.speaker_stride(e)},t.get_volume=function(e){return e&&"object"==typeof e?n.get_volume(e):n.get_master_volume()},t.set_volume=function(e,t){e&&"object"==typeof e?n.set_volume(e,t):n.set_master_volume(t)},t.mute=function(e,t){e&&"object"==typeof e?n.mute(e,t):n.mute_master(t)},t.is_muted=function(e){return e&&"object"==typeof e?n.is_muted(e):n.is_master_muted()},t.get_speaker_objects=function(){return n.get_speaker_objects().slice(0)},t.check_active_speakers=n.check_active_speakers,t.set_compressor_params=function(e){n.set_compressor_params(a.get_active(),e)},t.get_compressor_params=function(){return n.get_compressor_params(a.get_active())},t.duck=function(e,t,r){e&&"object"==typeof e?n.duck(e,t,r):n.duck_master(t,r)},t.unduck=function(e){e&&"object"==typeof e?n.unduck(e):n.unduck_master()},t.apply_playlist=n.apply_playlist,t.clear_playlist=n.clear_playlist,t.detect_audio_container=n.detect_audio_container,t.detect_video_container=n.detect_video_container,t.set_positional_params=n.set_positional_params,t.get_positional_params=n.get_positional_params,t.set_filter_params=n.set_filter_params,t.get_filter_params=n.get_filter_params,t.get_filter_freq_response=n.get_filter_freq_response,t.get_duration=function(e){return e&&r.is_speaker(e)?n.get_duration(e):(_.error('Object "'+(e?e.name:void 0)+'" is not a valid speaker'),0)}})),Se=(o("mixer",function(e,t){function r(){O.length=0,R=0,k=a(100),N=new Float32Array(k.length),M=new Float32Array(k.length);var e=A.get_speaker_objects();if(e.length){O.push(n());for(var t=0;t<e.length;t++){var r=e[t];O.push(s(r))}O.sort(function(e,t){return"MASTER"==e.id?-1:"MASTER"==t.id?1:"COMPRESSOR"==e.id?-1:"COMPRESSOR"==t.id?1:e.id.toUpperCase()<t.id.toUpperCase()?-1:e.id.toUpperCase()>t.id.toUpperCase()?1:0})}}function a(e){for(var t=new Float32Array(e),r=0,a=0;a<e;a++)t[a]=20*Math.pow(1e3,r),r+=1/(e-1);return t}function n(){var e=_("MASTER"),t=A.get_compressor_params();return t&&(e.params.push(["THRESHOLD",t.threshold,-100,0,100,!1]),e.params.push(["KNEE",t.knee,0,40,40,!1]),e.params.push(["RATIO",t.ratio,1,20,20,!1]),e.params.push(["ATTACK",t.attack,0,1,1e3,!1]),e.params.push(["RELEASE",t.release,0,1,1e3,!1])),e.params.push(["VOLUME",A.get_volume(null),0,1,50,!1]),e.mute=A.is_muted(null)?1:0,e.solo=-1,e}function _(e){return{id:e,params:[],active_param:0,mute:-1,solo:-1,speaker:null}}function s(e){var t=_(E.get_object_name(e));return t.mute=A.is_muted(e)?1:0,t.solo=0,t.speaker=e,t}function o(e){if(O.length){1==e&&R<O.length-1?R++:-1==e&&R>0&&R--;for(var t=g(),r=t[0];r<=t[1];r++)i(O[r])}}function i(e){if(e.speaker){e.params.length=0;var t=A.get_positional_params(e.speaker);t&&(e.params.push(["DIST_REF",t.dist_ref,0,1e3,1e4,!1]),e.params.push(["ATTENUATION",t.attenuation,0,50,1e3,!1]),e.params.push(["DIST_MAX",t.dist_max,0,1e4,1e4,!1]));var r=A.get_filter_params(e.speaker);r&&(e.params.push(["EQ_FREQ",r.freq,20,2e4,100,!0]),e.params.push(["EQ_Q",r.Q,0,10,100,!1]),e.params.push(["EQ_GAIN",r.gain,-70,30,100,!1])),e.params.push(["VOLUME",A.get_volume(e.speaker),0,1,50,!1]),T.clamp(e.active_param,0,e.params.length-1)}}function l(e){var t=O[R];t&&(1==e&&t.active_param<t.params.length-1?t.active_param++:-1==e&&t.active_param>0&&t.active_param--)}function c(e){var t=O[R];if(t){var r=t.params[t.active_param];switch(r[5]?r[1]*=Math.pow(r[3]/r[2],e/r[4]):r[1]+=e*((r[3]-r[2])/r[4]),r[1]=T.clamp(r[1],r[2],r[3]),r[0]){case"VOLUME":"MASTER"!=t.id?A.set_volume(t.speaker,r[1]):A.set_volume(null,r[1]);break;case"DIST_REF":(a=A.get_positional_params(t.speaker)).dist_ref=r[1],A.set_positional_params(t.speaker,a);break;case"ATTENUATION":(a=A.get_positional_params(t.speaker)).attenuation=r[1],A.set_positional_params(t.speaker,a);break;case"DIST_MAX":var a=A.get_positional_params(t.speaker);a.dist_max=r[1],A.set_positional_params(t.speaker,a);break;case"EQ_FREQ":(n=A.get_filter_params(t.speaker)).freq=r[1],A.set_filter_params(t.speaker,n);break;case"EQ_Q":(n=A.get_filter_params(t.speaker)).Q=r[1],A.set_filter_params(t.speaker,n);break;case"EQ_GAIN":var n=A.get_filter_params(t.speaker);n.gain=r[1],A.set_filter_params(t.speaker,n);break;case"THRESHOLD":(_=A.get_compressor_params()).threshold=r[1],A.set_compressor_params(_);break;case"KNEE":(_=A.get_compressor_params()).knee=r[1],A.set_compressor_params(_);break;case"RATIO":(_=A.get_compressor_params()).ratio=r[1],A.set_compressor_params(_);break;case"ATTACK":(_=A.get_compressor_params()).attack=r[1],A.set_compressor_params(_);break;case"RELEASE":var _=A.get_compressor_params();_.release=r[1],A.set_compressor_params(_);break;default:T.panic("Unknown strip param")}}}function u(){var e=O[R];e&&e.mute>=0&&d(e)}function d(e){"MASTER"!=e.id?0==e.mute?(e.mute=1,A.mute(e.speaker,!0),1==e.solo&&(e.solo=0,f(e)||p(e))):(e.mute=0,f(e)||A.mute(e.speaker,!1)):0==e.mute?(e.mute=1,A.mute(null,!0)):(e.mute=0,A.mute(null,!1))}function f(e){for(var t=0;t<O.length;t++){var r=O[t];if(r!=e&&1==r.solo)return!0}return!1}function m(e){for(var t=0;t<O.length;t++){var r=O[t];r!=e&&0==r.mute&&0==r.solo&&A.mute(r.speaker,!0)}}function p(e){for(var t=0;t<O.length;t++){var r=O[t];r!=e&&0==r.mute&&0==r.solo&&A.mute(r.speaker,!1)}}function h(){var e=O[R];e&&e.solo>=0&&v(e)}function v(e){0==e.solo?(e.solo=1,A.mute(e.speaker,!1),1==e.mute&&(e.mute=0),m(e)):(e.solo=0,f(e)?A.mute(e.speaker,!0):p(e))}function b(){if(O[R])for(var e=g(),t=e[0];t<=e[1];t++){var r=O[t];if(w.draw_mixer_strip(r.id,t==R,t%8,r.params,r.active_param,r.mute,r.solo),r.speaker&&A.get_filter_params(r.speaker)){A.get_filter_freq_response(r.speaker,k,N,M);for(var a=0;a<N.length;a++){var n=N[a];N[a]=20*Math.log(n)/Math.LN10}w.plot_array("EQ",t%8,N,20,2e4,-10,10)}}}function g(){if(0==O.length)return[0,-1];var e=8*Math.floor(R/8),t=e+7;return e=T.clamp(e,0,O.length-1),t=T.clamp(t,0,O.length-1),[e,t]}var y=he(e),E=Te(e),w=Ae(e),A=Ie(e),T=Oe(e),x=["SWITCH_STRIP","SWITCH_STRIP_HOLD","SWITCH_PARAM","INC_DEC","INC_DEC_HOLD","MUTE_SOLO"],O=[],R=0,k=null,N=null,M=null;t.enable_mixer_controls=function(){r();var e=y.create_keyboard_sensor(y.KEY_NUM4),t=y.create_keyboard_sensor(y.KEY_NUM6),a=y.create_keyboard_sensor(y.KEY_NUM8),n=y.create_keyboard_sensor(y.KEY_NUM2),_=y.create_keyboard_sensor(y.KEY_ADD),s=y.create_keyboard_sensor(y.KEY_SUB),d=y.create_keyboard_sensor(y.KEY_NUM7),f=y.create_keyboard_sensor(y.KEY_NUM9),m=y.create_timer_sensor(.15,!0),p=y.create_timer_sensor(.05,!0),v=[e,t,m],E=function(e,t,r){1==r?(o(Boolean(y.get_sensor_value(e,t,0))?-1:1),"SWITCH_STRIP"==t?y.reset_timer_sensor(e,t,2,.15+.3):y.reset_timer_sensor(e,t,2,.15)):y.reset_timer_sensor(e,t,2,10)};y.create_sensor_manifold(null,"SWITCH_STRIP",y.CT_TRIGGER,v,function(e){return e[0]||e[1]},E),y.create_sensor_manifold(null,"SWITCH_STRIP_HOLD",y.CT_SHOT,v,function(e){return(e[0]||e[1])&&e[2]},E);var w=[a,n];y.create_sensor_manifold(null,"SWITCH_PARAM",y.CT_SHOT,w,function(e){return e[0]||e[1]},function(e,t,r){l(Boolean(y.get_sensor_value(e,t,0))?-1:1)});var A=[s,_,p],T=function(e,t,r){1==r?(c(Boolean(y.get_sensor_value(e,t,0))?-1:1),"INC_DEC"==t?y.reset_timer_sensor(e,t,2,.35):y.reset_timer_sensor(e,t,2,.05)):y.reset_timer_sensor(e,t,2,10)};y.create_sensor_manifold(null,"INC_DEC",y.CT_TRIGGER,A,function(e){return e[0]||e[1]},T),y.create_sensor_manifold(null,"INC_DEC_HOLD",y.CT_SHOT,A,function(e){return(e[0]||e[1])&&e[2]},T);var x=[d,f];y.create_sensor_manifold(null,"MUTE_SOLO",y.CT_SHOT,x,function(e){return e[0]||e[1]},function(e,t,r){Boolean(y.get_sensor_value(e,t,0))?u():h()});var R=y.create_elapsed_sensor();y.create_sensor_manifold(null,"MIXER_DRAW",y.CT_CONTINUOUS,[R],null,function(){b()});var k=y.create_timer_sensor(1,!0);y.create_sensor_manifold(null,"MIXER_UPDATE",y.CT_TRIGGER,[k],null,function(){for(var e=g(),t=e[0];t<=e[1];t++)i(O[t])})},t.disable_mixer_controls=function(){for(var e=0;x.length;e++)y.remove_sensor_manifold(null,x[e])}}),o("mouse",function(e,t){function r(){L==x&&(L=T);var e=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;"function"==typeof e&&e.apply(document),f.remove_sensor_manifold(v.get_active_camera(),"SMOOTH_PL")}function a(e){L==O&&(L=T),e.removeEventListener("mousedown",_,!1),e.removeEventListener("mouseup",s,!1),e.removeEventListener("mousemove",n,!1),f.remove_sensor_manifold(v.get_active_camera(),"SMOOTH_DRAG")}function n(e){if(I()){if(P)var t=d.get_coords_target_space(e,M);else(t=M)[0]=e.clientX,t[1]=e.clientY;N[0]+=(t[0]-R)*E,N[1]+=(t[1]-k)*E,R=t[0],k=t[1]}e.preventDefault()}function _(e){if(P)var t=d.get_coords_target_space(e,M);else(t=M)[0]=e.clientX,t[1]=e.clientY;R=t[0],k=t[1],e.currentTarget.addEventListener("mousemove",n,!1),e.preventDefault()}function s(e){e.currentTarget.removeEventListener("mousemove",n,!1),e.preventDefault()}function o(e,t,r,a){if(Math.abs(N[0])>.01||Math.abs(N[1])>.01){var n=f.get_sensor_value(e,t,0),_=b.smooth(N[0],0,n,c()),s=b.smooth(N[1],0,n,c());N[0]-=_,N[1]-=s,a(-_*y,-s*y)}}function i(e,t){var r=v.get_first_character(),a=v.get_active_camera();if(u.rotate_camera(a,e,t),r){var n=u.get_camera_angles_char(a,M);p.set_character_rotation_h(r,n[0]),p.set_character_vert_move_dir_angle(r,n[1])}}function l(e){if(C)var t=d.get_coords_target_space(e,!1,M),r=v.pick_object(t[0],t[1]);else r=v.pick_object(e.clientX,e.clientY);r?(v.outlining_is_enabled(r)&&v.set_outline_intensity(r,1),v.outlining_is_enabled(S)&&r!=S&&v.set_outline_intensity(S,0)):v.outlining_is_enabled(S)&&v.set_outline_intensity(S,0),S=r}function c(){return A*w}var u=de(e),d=pe(e),f=he(e),p=we(e),h=m(e),v=Te(e),b=Oe(e),g=Ee(e),y=4e-4,E=2,w=1,A=.1,T=0,x=1,O=2,R=0,k=0,N=new Float32Array(2),M=new Float32Array(2),I=null,S=null,L=T,C=!1,P=!1;t.request_pointerlock=function(e,t,r,n,_,s){function l(){if(document.pointerLockElement===e||document.webkitPointerLockElement===e||document.mozPointerLockElement===e){a(e),e.addEventListener("mousemove",n,!1);var _=v.get_active_camera();if(!f.check_sensor_manifold(_,"SMOOTH_PL")){var i=f.create_elapsed_sensor();f.create_sensor_manifold(_,"SMOOTH_PL",f.CT_CONTINUOUS,[i],null,o,s)}t()}else e.removeEventListener("mousemove",n,!1),L=T,document.removeEventListener("pointerlockchange",l,!1),document.removeEventListener("webkitpointerlockchange",l,!1),document.removeEventListener("mozpointerlockchange",l,!1),r()}if(L!=x){L=x,t=t||function(){},r=r||function(){},s=s||i,_=_||function(){return!0},n=n||function(e){if(_()){if("number"==typeof e.movementX)var t=e.movementX,r=e.movementY;else if("number"==typeof e.webkitMovementX)var t=e.webkitMovementX,r=e.webkitMovementY;else if("number"==typeof e.mozMovementX)var t=e.mozMovementX,r=e.mozMovementY;else var t=0,r=0;N[0]+=t,N[1]+=r}},document.addEventListener("pointerlockchange",l,!1),document.addEventListener("webkitpointerlockchange",l,!1),document.addEventListener("mozpointerlockchange",l,!1);var c=e.requestPointerLock||e.webkitRequestPointerLock||e.mozRequestPointerLock;"function"==typeof c?c.apply(e):h.error("Pointer lock is not available")}},t.exit_pointerlock=r,t.check_pointerlock=function(e){return"function"==typeof(e.requestPointerLock||e.webkitRequestPointerLock||e.mozRequestPointerLock)},t.request_mouse_drag=function(e,t,a,n){if(L!=O){L=O,r(),I=t||function(){return!0},a=a||i,P=Boolean(n),e.addEventListener("mousedown",_,!1),e.addEventListener("mouseup",s,!1);var l=v.get_active_camera();if(!f.check_sensor_manifold(l,"SMOOTH_DRAG")){var c=f.create_elapsed_sensor();f.create_sensor_manifold(l,"SMOOTH_DRAG",f.CT_CONTINUOUS,[c],null,o,a)}}},t.exit_mouse_drag=a,t.enable_mouse_hover_outline=function(e){C=Boolean(e),g.detect_mobile()||d.get_canvas().addEventListener("mousemove",l)},t.disable_mouse_hover_outline=function(){g.detect_mobile()||(d.get_canvas().removeEventListener("mousemove",l),S&&v.set_outline_intensity(S,0))},t.get_coords_x=function(e,t,r){if(r)return d.get_coords_target_space(e,t,M)[0];if("clientX"in e)return e.clientX;if("touchend"==e.type)a=e.changedTouches;else var a=t?e.targetTouches:e.touches;return a&&a[0]&&"clientX"in a[0]?a[0].clientX:-1},t.get_coords_y=function(e,t,r){if(r)return d.get_coords_target_space(e,t,M)[1];if("clientY"in e)return e.clientY;if("touchend"==e.type)a=e.changedTouches;else var a=t?e.targetTouches:e.touches;return a&&a[0]&&"clientY"in a[0]?a[0].clientY:-1},t.set_plock_smooth_factor=function(e){w=e},t.get_plock_smooth_factor=function(){return w}}),o("animation",function(e,t){var r=Q(e),a=k(e),n=m(e);t.SLOT_0=r.SLOT_0,t.SLOT_1=r.SLOT_1,t.SLOT_2=r.SLOT_2,t.SLOT_3=r.SLOT_3,t.SLOT_4=r.SLOT_4,t.SLOT_5=r.SLOT_5,t.SLOT_6=r.SLOT_6,t.SLOT_7=r.SLOT_7,t.SLOT_ALL=r.SLOT_ALL,t.OBJ_ANIM_TYPE_NONE=r.OBJ_ANIM_TYPE_NONE,t.OBJ_ANIM_TYPE_ARMATURE=r.OBJ_ANIM_TYPE_ARMATURE,t.OBJ_ANIM_TYPE_OBJECT=r.OBJ_ANIM_TYPE_OBJECT,t.OBJ_ANIM_TYPE_VERTEX=r.OBJ_ANIM_TYPE_VERTEX,t.OBJ_ANIM_TYPE_SOUND=r.OBJ_ANIM_TYPE_SOUND,t.OBJ_ANIM_TYPE_PARTICLES=r.OBJ_ANIM_TYPE_PARTICLES,t.OBJ_ANIM_TYPE_MATERIAL=r.OBJ_ANIM_TYPE_MATERIAL,t.OBJ_ANIM_TYPE_STATIC=r.OBJ_ANIM_TYPE_STATIC,t.AB_CYCLIC=r.AB_CYCLIC,t.AB_FINISH_RESET=r.AB_FINISH_RESET,t.AB_FINISH_STOP=r.AB_FINISH_STOP,t.is_animated=function(e){return r.is_animated(e)},t.get_anim_names=function(e){return r.obj_is_animatable(e)?r.get_anim_names(e):[]},t.get_current_anim_name=function(e,t){return r.is_animated(e)?(t=t||r.SLOT_0,r.get_anim_by_slot_num(e,t)):null},t.apply=function(e,t,a){if(a>r.SLOT_7)n.error("Can't apply animation to slot "+a+' for object "'+e.name+'". Object can have maximum of 8 animation slots');else{if(a=a||r.SLOT_0,r.is_animated(e)){var _=r.get_slot_num_by_anim(e,t);if(-1!=_&&_!=a)return void n.error('Animation "'+t+'" is already applied to object "'+e.name+'" (slot "'+_+'").')}r.validate_action_by_name(e,t)?r.apply(e,null,t,a):n.error('No fcurves in action "'+t+'"')}},t.apply_ext=function(e,t,a){if(a>r.SLOT_7)n.error("Can't apply animation to slot "+a+' for object "'+e.name+'". Object can have maximum of 8 animation slots');else{a=a||r.SLOT_0;var _=t[0];if(r.validate_action_by_name(e,_)){var s=t.slice(1);r.apply(e,s,_,a)}else n.error('No fcurves in action "'+_+'"')}},t.remove=function(e){r.remove(e)},t.remove_slot_animation=function(e,t){r.is_animated(e)&&(t=t||r.SLOT_0,r.remove_slot_animation(e,t))},t.apply_def=function(e){r.apply_def(e)},t.play=function(e,t,a){r.is_animated(e)?(a=a||r.SLOT_0,r.play(e,t,a),r.update_object_animation(e,0,a,!0)):n.error('Object "'+e.name+'" has no applied animation')},t.stop=function(e,t){r.is_animated(e)&&(t=t||r.SLOT_0,r.stop(e,t))},t.is_play=function(e,t){return!!r.is_animated(e)&&(t=t||r.SLOT_0,r.is_play(e,t))},t.set_frame=function(e,t,a){r.is_animated(e)&&(a=a||r.SLOT_0,r.set_frame(e,t,a))},t.set_first_frame=function(e,t){r.is_animated(e)&&r.set_first_frame(e,t)},t.set_last_frame=function(e,t){if(r.is_animated(e)){t=t||r.SLOT_0;var a=r.get_anim_start_frame(e,t),n=r.get_anim_length(e,t);r.set_frame(e,a+n-r.LAST_FRAME_EPSILON,t)}},t.get_frame=function(e,t){return r.is_animated(e)?(t=t||r.SLOT_0,r.get_current_frame_float(e,t)):0},t.set_speed=function(e,t,a){r.is_animated(e)&&(a=a||r.SLOT_0,t=t||1,r.set_speed(e,t,a))},t.get_speed=function(e,t){return r.is_animated(e)?(t=t||r.SLOT_0,e.anim_slots[t]?r.get_speed(e,t):0):0},t.get_anim_start_frame=function(e,t){return r.is_animated(e)?(t=t||r.SLOT_0,e.anim_slots[t]?r.get_anim_start_frame(e,t):-1):-1},t.get_anim_length=function(e,t){return r.is_animated(e)?(t=t||r.SLOT_0,e.anim_slots[t]?r.get_anim_length(e,t):-1):-1},t.set_behavior=function(e,t,a){r.is_animated(e)&&(a=a||r.SLOT_0,r.set_behavior(e,t,a))},t.get_behavior=function(e,t){return r.is_animated(e)?(t=t||r.SLOT_0,r.get_behavior(e,t)):null},t.apply_smoothing=function(e,t,a,n){n=n||r.SLOT_0,r.is_animated(e)&&r.apply_smoothing(e,t,a,n)},t.frame_to_sec=function(e){return r.frame_to_sec(e)},t.get_slot_num_by_anim=function(e,t){return r.is_animated(e)&&t?r.get_slot_num_by_anim(e,t):-1},t.get_anim_type=function(e,t){return r.is_animated(e)?r.get_anim_type(e,t):null},t.apply_to_first_empty_slot=function(e,t){return r.apply_to_first_empty_slot(e,t)},t.get_skel_mix_factor=function(e){return e.render.anim_mix_factor},t.set_skel_mix_factor=function(e,t,_,s){a.is_armature(e)?(t=Math.min(Math.max(t,0),1),e.render.anim_mix_factor!=t&&(_=_||0,s=s||null,r.set_skel_mix_factor(e,t,_,s))):n.error("Can't blend animation. Object \""+e.name+'" is not armature')},t.set_skeletal_slots=function(e,t,r,a){r=void 0==(t=void 0==t?-1:t)?-1:r,a=a||0;var n=e.render.blend_skel_slots;t>=0&&(n[0]=t),r>=0&&(n[1]=r),e.render.anim_mix_factor=a},t.get_first_skeletal_slot=function(e){return e.render.blend_skel_slots[0]},t.get_second_skeletal_slot=function(e){return e.render.blend_skel_slots[1]},t.mix_from_cur_pos=function(e,t,a,n){n=n||null,a=a||0,r.mix_from_cur_pos(e,t,a,n)}}));o("npc_ai",function(e,t){function r(){return{obj:null,rig:null,collider:null,empty:null,type:X,state:Q,actions:{},base_pos:new Float32Array(3),destination:new Float32Array(3),path:[],start:[],ended:[],fired:[],delay:[],random:!0,reached:!0,ground_level:0,vert_correction:0,vert_cor_water:0,rotation_mult:1,speed:1,rot_speed:.1,max_height:0,min_height:0,max_depth:0,min_depth:0}}function a(e,t){var r=t.destination,a=t.base_pos,s=z;P.get_translation(t.collider,s);var o=0,i=s[2];switch(r[2]=i,t.type){case X:if(t.random&&t.reached&&(r[0]=(12*Math.random()-6)*t.speed+a[0],r[1]=-(12*Math.random()-6)*t.speed+a[1],n(t,r,s),t.reached=!1),t.ground_level){o=t.ground_level-i;var l=t.speed*e;o>l?o=l:o<-l&&(o=-l)}t.vert_correction=o;break;case K:case Z:if(t.vert_cor_water?o=t.vert_cor_water:t.vert_correction&&(o=t.vert_correction,t.type==Z&&(o*=e)),t.random&&t.reached){if(t.type==Z)t.speed=Math.random()+.1,c=t.max_depth-t.min_depth;else var c=t.max_height-t.min_height;r[0]=10*Math.random()-5+a[0],r[1]=10*Math.random()-5+a[1],r[2]=i-(Math.random()*c-.5*c),t.reached=!1}}o&&(r[2]=i+o),_(e,t)}function n(e,t,r){var a=q,n=Y,_=e.speed,s=e.rot_speed;P.get_rotation(e.collider,a),D.transformQuat(B.AXIS_MY,a,n),n[2]=0,D.normalize(n,n);var o=.5*_/Math.sin(s/2),i=D.dist(t,r);i<2*o&&D.scaleAndAdd(t,n,2*o-i,t)}function _(e,t){var r=j,a=z,n=Y,_=V,l=t.rig,c=t.collider,u=t.destination,d=t.speed,f=t.actions,m=M.get_current_anim_name(l);if(!M.is_play(l)||!f.idle||-1==f.idle.indexOf(m)){P.get_translation(c,r);var p=u[0]-r[0],h=u[1]-r[1],v=Math.sqrt(p*p+h*h);v>2*d*e?(t.state=J,B.horizontal_direction(u,r,n),N(t,u,v,n),s(t,a,e,_,n),o(t,a,e,_),P.set_rotation_v(c,_),i(e,_,t,r,u)):t.type==X?f.move&&m&&-1!=f.move.indexOf(m)&&M.is_play(l)?t.state=J:(t.state=Q,t.reached=!0):t.type!=Z&&t.type!=K||(t.reached=!0),y(t)&&E(t)}}function s(e,t,r,a,n){var _=q,s=H;P.get_rotation(e.collider,_),D.transformQuat(B.AXIS_MY,_,t),s[0]=t[0],s[1]=t[1],s[2]=0,D.normalize(s,s);var o=D.dot(s,n),i=Math.acos(o),l=r/(Math.abs(i)/Math.PI)*e.rot_speed*e.rotation_mult;S.rotationTo(s,n,a),S.rotationTo(B.AXIS_MY,s,_),Math.abs(o)>=1?S.copy(_,a):(S.multiply(a,_,a),S.slerp(_,a,Math.min(l,1),a))}function o(e,t,r,a){if(e.type!=K){r=Math.max(r,1/60);var n=W,_=q,s=Math.asin(-t[2]);S.setAxisAngle(B.AXIS_X,-s,_);var o=e.speed*r,i=e.vert_correction,l=Math.atan(i/o);S.setAxisAngle(B.AXIS_X,-l,n),S.slerp(_,n,r,n),S.multiply(a,n,a)}}function i(e,t,r,a,n){var _=Y,s=H,o=B.AXIS_MY;B.quat_to_dir(t,o,_),D.scale(_,r.speed*e,s),D.add(s,a,s),r.type!=X?s[2]=(n[2]-a[2])*e*.1+a[2]:s[2]=n[2],P.set_translation_v(r.collider,s)}function c(e,t){if(L.is_visible(e.obj))if(e.random)a(t,e);else{for(var r=C.get_timeline(),n=0;n<e.path.length;n++)if(!e.ended[n]){if(e.fired[n]||(e.fired[n]=!0,e.destination[0]=e.path[n][0],e.destination[1]=e.path[n][1],e.destination[2]=e.path[n][2],e.start[n]=r+e.delay[n]),r<e.start[n])break;a(t,e),e.ended[n]=e.reached;break}f(e)&&u(e)}}function u(e){for(var t=0;t<e.path.length;t++)e.fired[t]=!1,e.ended[t]=!1}function f(e){for(var t=0;t<e.path.length;t++)if(0==e.ended[t])return!1;return!0}function p(e,t,r,a){if(a)if(1==r)switch(a.type){case K:var n=100*h(e,t);n<a.min_height?a.vert_correction=10:n>a.max_height?a.vert_correction=-10:a.vert_correction=0;break;case X:_=I.get_sensor_payload(e,t,0),a.ground_level=_.hit_pos[2];break;case Z:var _=I.get_sensor_payload(e,t,0);"CLOSE_GROUND"==t?(a.vert_correction=100*_.hit_fract-1,a.vert_correction<.1?a.vert_correction=.05:a.vert_correction=0):"CLOSE_WATER"==t&&(a.vert_cor_water=100*_.hit_fract,a.vert_cor_water<a.min_depth?a.vert_cor_water=-.02:a.vert_cor_water>a.max_depth?a.vert_cor_water=.02:a.vert_cor_water=0)}else a.vert_correction=0}function h(e,t){for(var r=0;r<3;r++){var a=I.get_sensor_payload(e,t,r).hit_fract;if(a)return a}}function v(){for(var e=0;e<G.length;e++){var t=G[e];b(t),g(t),M.get_current_anim_name(t.rig)&&M.play(t.rig)}}function b(e){var t=D.create(),r=e.collider;switch(e.type){case K:_=[a=I.create_ray_sensor(r,t,[0,0,-100],"TERRAIN",!0,!0),I.create_ray_sensor(r,t,[0,0,-100],"STONE",!0,!0),n=I.create_ray_sensor(r,t,[0,0,-100],"WATER",!0,!0)],I.create_sensor_manifold(r,"CLOSE_GROUND",I.CT_CONTINUOUS,_,function(e){return e[0]||e[1]||e[2]},p,e);break;case X:_=[a=I.create_ray_sensor(r,[0,0,1],[0,0,-99],"TERRAIN",!0,!0)],I.create_sensor_manifold(r,"CLOSE_GROUND",I.CT_CONTINUOUS,_,null,p,e);break;case Z:var a=I.create_ray_sensor(r,[0,0,1],[0,0,-99],"TERRAIN",!0,!0),n=I.create_ray_sensor(r,t,[0,0,100],"WATER",!0,!0),_=[a],s=[n];I.create_sensor_manifold(r,"CLOSE_WATER",I.CT_CONTINUOUS,s,null,p,e),I.create_sensor_manifold(r,"CLOSE_GROUND",I.CT_CONTINUOUS,_,null,p,e)}}function g(e){var t=e.collider;if(e.type==X){var r=I.create_collision_sensor(t,"CONSTRUCTION",!1);I.create_sensor_manifold(t,"CONSTRUCTION_COLL",I.CT_CONTINUOUS,[r],null,function(t,r,a){1==a?(D.copy(e.base_pos,e.destination),e.rotation_mult=4):e.rotation_mult=1})}}function y(e){var t=e.rig;if(!M.is_play(t))return!0;var r=M.get_current_anim_name(t);if(!r)return!0;var a=e.actions;switch(e.state){case Q:if(!a.idle)return!1;if(-1==a.idle.indexOf(r))return!0;break;case J:if(!a.move)return!1;if(-1!=a.move.indexOf(r))return!1;if(a.move_start&&-1!=a.move_start.indexOf(r))return!1;if(a.move_blends&&-1!=a.move_blends.indexOf(r))return!1;break;default:return!1}return!0}function E(e){var t=e.rig;if(!M.is_play(t)){var r=null;switch(e.state){case Q:r=w(e);break;case J:r=A(e)}r&&(M.apply(t,r),M.set_behavior(t,M.AB_FINISH_RESET),M.set_frame(t,0),M.play(t))}}function w(e){var t=e.actions;return t.idle?B.random_from_array(t.idle):null}function A(e){var t=M.get_current_anim_name(e.rig),r=e.actions;return x(e,t)?R(e,t):T(e,t)?k(e,t):O(e,t)?B.random_from_array(r.move_start):null}function T(e,t){var r=e.actions;return!(!r.move||-1==r.move.indexOf(t)&&(r.move_blends||r.move_start)&&(r.move_start||t)&&(!r.move_blends||-1==r.move_blends.indexOf(t))&&(!r.move_start||-1==r.move_start.indexOf(t)))}function x(e,t){var r=e.actions;return!!r.move_blends&&-1==r.move_blends.indexOf(t)&&!(!r.move||-1==r.move.indexOf(t))&&Math.random()>.33}function O(e,t){var r=e.actions;return!!r.move_start&&-1==r.move_start.indexOf(t)&&!(!r.move||-1!=r.move.indexOf(t))}function R(e,t){var r=e.actions,a=r.move.indexOf(t);return r.move_blends[a]}function k(e,t){var r=e.actions;if(!r.move_blends)return B.random_from_array(r.move);var a=r.move_blends.indexOf(t);if(-1!=a){var n=a+1;return n=n<r.move.length?n:0,r.move[n]}return-1!=r.move.indexOf(t)?t:B.random_from_array(r.move)}function N(e,t,r,a){var n=e.rig;if(M.is_animated(n)){var _=e.speed,s=r,o=M.get_frame(n),i=M.get_anim_length(n),l=i/24*_*(1-o/i);if(s/l<.9){var c=l-s;D.scaleAndAdd(t,a,c,t)}}}var M=Se(e),I=he(e),S=d(e),L=Te(e),C=Re(e),P=xe(e),D=l(e),U=we(e),F=m(e),B=Oe(e),G=[],j=new Float32Array(3),z=new Float32Array(3),Y=new Float32Array(3),H=new Float32Array(3),W=new Float32Array(4),q=new Float32Array(4),V=new Float32Array(4),X=t.NT_WALKING=10,K=t.NT_FLYING=20,Z=t.NT_SWIMMING=30,Q=10,J=20;t.new_event_track=function(e){var t=r();if("object"==typeof e.obj)if("object"==typeof e.rig)if("object"==typeof e.collider&&U.has_physics(e.collider)){if(t.obj=e.obj,t.collider=e.collider,t.rig=e.rig,P.get_translation(e.collider,t.base_pos),"object"==typeof e.actions&&(t.actions=e.actions),"boolean"==typeof e.random&&(t.random=e.random),"number"==typeof e.type&&(t.type=e.type),"number"==typeof e.speed&&(t.speed=e.speed),"number"==typeof e.rot_speed&&(t.rot_speed=e.rot_speed),"number"==typeof e.max_height&&(t.max_height=e.max_height),"number"==typeof e.min_height&&(t.min_height=e.min_height),!t.random){for(var a=0;a<e.path.length;a++)t.start[a]=-1,t.ended[a]=!1,t.fired[a]=!1;t.path=e.path,t.delay=e.delay}var n=e.actions,_=M.get_current_anim_name(t.rig);for(var s in n)for(var o=n[s],i=0;i<o.length;i++)M.apply(t.rig,o[i]);_&&M.apply(t.rig,_),G.push(t)}else F.error("Can't create event track. Wrong collider object.");else F.error("Can't create event track. Wrong rig object.");else F.error("Can't create event track. Wrong object.")},t.enable_animation=function(){if(G.length){v();var e=I.create_elapsed_sensor();I.create_sensor_manifold(G[0].collider,"ELAPSED",I.CT_CONTINUOUS,[e],function(e){return e[0]},function(e,t,r){if(1==r)for(var a=I.get_sensor_value(e,t,0),n=0;n<G.length;n++)c(G[n],a)})}},t.disable_animation=function(){if(!(G.length<=0))for(var e=0;e<G.length;e++){var t=G[e];I.check_sensor_manifolds(t.collider)&&I.remove_sensor_manifold(t.collider),M.is_play(t.rig)&&M.stop(t.rig)}}}),o("preloader",function(e,t){var r=pe(e),a={},n=null;t.create_preloader=function(e){var t="#484848",n="#5276cf",_="rgba(150, 150, 150, 0.7)",s="#fff";for(var o in e)switch(o){case"container_color":t=e.container_color;break;case"bar_color":n=e.bar_color;break;case"frame_color":_=e.frame_color;break;case"font_color":s=e.font_color}var i=document.createElement("div"),l=i.cloneNode(!1),c=i.cloneNode(!1),u=i.cloneNode(!1),d=r.get_container();c.appendChild(l),c.appendChild(u),i.appendChild(c),d.appendChild(i),i.style.cssText="background-color: "+t+";width: 100%;height: 100%;position: absolute;top: 0;left: 0;",c.style.cssText="position: absolute;left: 50%;top: 50%;margin-left: -150px;margin-top: -30px;width: 300px;height: 28px;box-shadow: 0px 0px 10px 0px "+_+";border: 2px solid "+_+";",l.style.cssText="position: absolute;width: 0%;top: 0;left: 0;background-color: "+n+";height: 100%;",u.style.cssText="font-family: Arial, sans-serif;line-height: 28px;height: 100%;width: 100%;top: 0;left: 0;text-align: center;position: absolute;font-size: 16px;font-weight: bold;text-shadow: 0px 0px 6px "+_+";color: "+s+";",a.bar=l,a.caption=u,a.container=i,a.type="DEFAULT"},t.create_simple_preloader=function(e){var t=null,r=null,_="#bf9221",s="#000";for(var o in e)switch(o){case"canvas_container_id":t=e.canvas_container_id;break;case"background_container_id":r=e.background_container_id;break;case"bg_color":s=e.bg_color;break;case"bar_color":_=e.bar_color;break;case"preloader_fadeout":a.fadeout=e.preloader_fadeout}var i=document.createElement("div"),l=document.createElement("div");i.id="simple_preloader_container";var c=document.createElement("div"),u=document.createElement("div"),d=document.getElementById(r);n=document.getElementById(t),i.style.cssText="z-index: 4;background-color: "+s+";width: 100%;height: 100%;position: absolute;margin: 0;padding: 0;top: 0;left: 0;",l.style.cssText="position: absolute;left: 50%;top: 82%;width: 300px;height: 20px;margin-left: -150px;margin-top: -10px;border-style:solid;border-width:4px;border-color: #000;border-radius: 0px;",c.style.cssText="position: absolute;left: 0px;top: 1px;width: 0px;height: 18px;background-color: "+_+";border-radius: 0px;",u.style.cssText="position: absolute;left: 50%;top: 50%;width: 100%;height: 100%;margin-left: -150px;margin-top: -10px;text-align: center;font-size: 17px;font-weight: bold;color: #000;font-family: Verdana;"+l.appendChild(c),l.appendChild(u),i.appendChild(l),document.body.appendChild(i),a.type="SIMPLE",a.container=i,a.bar=c,a.caption=u,a.background=d},t.create_rotation_preloader=function(e){var t=null,r=null,_="rgba(0,0,0,0)",s="",o="",i="rgba(0,0,0,0)";for(var l in e)switch(l){case"canvas_container_id":t=e.canvas_container_id;break;case"background_container_id":r=e.background_container_id;break;case"frame_bg_color":_=e.frame_bg_color;break;case"bg_color":i=e.bg_color;break;case"frame_class":s=e.frame_class;break;case"anim_elem_class":o=e.anim_elem_class}var c=document.createElement("div"),u=document.createElement("div"),d=document.createElement("div"),f=document.createElement("div"),m=document.getElementById(r);n=document.getElementById(t),c.style.cssText="z-index: 4;background-color: "+i+";width: 100%;height: 100%;position: absolute;margin: 0;padding: 0;top: 0;left: 0;",u.style.cssText="position: absolute;left: 50%;top: 50%;width: 117px;height: 117px;margin-left: -58px;margin-top: -58px;background-color: "+_+";",d.style.cssText="position: absolute;left: 0px;top: 0px;width: 100%;height: 100%;background-position: center;background-repeat: no-repeat;",f.style.cssText="position: absolute;width: 100%;height: 100%;text-align: center;margin-top: 38px;font-size: 36px;color: #ffffff;font-family: Arial;font-weight: bold;",d.className=o,u.appendChild(d),u.className=s,u.appendChild(f),c.appendChild(u),n.appendChild(c),a.type="ROTATION",a.container=c,a.anim_elem=d,a.caption=f,a.background=m},t.create_advanced_preloader=function(e){var t=e.img_width,r=e.preloader_width,_=e.canvas_container_id,s=r/(r-t),o=document.getElementById(e.preloader_bar_id),i=document.getElementById(e.fill_band_id),l=document.getElementById(e.preloader_caption_id),c=document.getElementById(e.preloader_container_id),u=document.getElementById(e.background_container_id);n=document.getElementById(_),a.type="ADVANCED",a.bar=o,a.fill=i,a.ratio=s,a.caption=l,a.container=c,a.background=u},t.update_preloader=function(e){a.caption.innerHTML=e+"%","SIMPLE"==a.type?a.bar.style.width=e+"%":"ADVANCED"==a.type?(a.bar.style.width=e/a.ratio+"%",a.fill.style.width=100-e+"%"):"ROTATION"==a.type?a.anim_elem.style.transform="rotate("+e+"deg)":"DEFAULT"==a.type&&(a.bar.style.width=e+"%"),100==e&&(a.container.parentNode.removeChild(a.container),a.background&&a.background.parentNode.removeChild(a.background))}}),o("screenshooter",function(e,t){var r=Ae(e),a=m(e);t.shot=function(e,t){a.error_deprecated("shot","screen.shot"),r.shot(e,t)}}),o("anchors",function(e,t){var r=se(e);t.attach_move_cb=r.attach_move_cb,t.detach_move_cb=r.detach_move_cb,t.is_anchor=r.is_anchor,t.get_element_id=r.get_element_id,t.update=function(){r.update(!0)}}),o("armature",function(e,t){var r=O(e),a=k(e),n=Y(e),_=m(e);t.get_bone_tsr=function(e,t,n){return a.is_armature(e)?r.check_bone(e,t)?(n||(n=new Float32Array(8)),r.get_bone_tsr(e,t,!1,!1,n),n):(_.error('There is no bone: "',t,'" in "',e.name,'".'),null):null},t.get_bone_tsr_rel=function(e,t,n){return a.is_armature(e)?r.check_bone(e,t)?(n||(n=new Float32Array(8)),r.get_bone_tsr(e,t,!1,!0,n),n):(_.error('There is no bone: "',t,'" in "',e.name,'".'),null):null},t.set_bone_tsr=function(e,t,s){a.is_armature(e)&&(r.check_bone(e,t)?(r.set_bone_tsr(e,t,s,!1),n.update_transform(e)):_.error('There is no bone: "',t,'" in "',e.name,'".'))},t.set_bone_tsr_rel=function(e,t,s){a.is_armature(e)&&(r.check_bone(e,t)?(r.set_bone_tsr(e,t,s,!0),n.update_transform(e)):_.error('There is no bone: "',t,'" in "',e.name,'".'))}}),o("assets",function(e,t){var r=F(e);t.AT_ARRAYBUFFER=r.AT_ARRAYBUFFER,t.AT_ARRAYBUFFER_ZIP=r.AT_ARRAYBUFFER_ZIP,t.AT_JSON=r.AT_JSON,t.AT_JSON_ZIP=r.AT_JSON_ZIP,t.AT_TEXT=r.AT_TEXT,t.AT_AUDIOBUFFER=r.AT_AUDIOBUFFER,t.AT_IMAGE_ELEMENT=r.AT_IMAGE_ELEMENT,t.AT_AUDIO_ELEMENT=r.AT_AUDIO_ELEMENT,t.AT_VIDEO_ELEMENT=r.AT_VIDEO_ELEMENT,t.AT_SEQ_VIDEO_ELEMENT=r.AT_SEQ_VIDEO_ELEMENT,t.enqueue=function(e,t,a,n){e.length&&r.enqueue(e,t,a,n)}}),o("geometry",function(e,t){var r=_e(e),a=w(e),n=m(e),_=te(e),s=p(e);t.extract_vertex_array=function(e,t,_){if(!a.has_dyn_geom(e))return n.error("Wrong object:",e.name),null;var s=r.find_batch_material(e,t,"MAIN");if(s){var o=s.bufs_data;return o&&o.pointers&&("a_normal"==_&&o.pointers.a_tbn||o.pointers[_])?a.extract_array_float(o,_):(n.error("Attribute not found:"+_),null)}return n.error("Wrong material:",t),null},t.extract_index_array=function(e,t){if(!a.has_dyn_geom(e))return n.error("Wrong object:",e.name),null;var _=r.find_batch_material(e,t,"MAIN");if(_){var s=_.bufs_data;return s&&s.pointers?s.ibo_array:(n.error("Buffer data not found"),null)}return n.error("Wrong material:",t),null},t.update_vertex_array=function(e,t,_,s){if(a.has_dyn_geom(e))for(var o=["MAIN","SHADOW","COLOR_ID"],i=0;i<o.length;i++){var l=o[i],c=r.find_batch_material(e,t,l);if(c){var u=c.bufs_data;u&&u.pointers&&("a_normal"==_&&u.pointers.a_tbn||u.pointers[_])&&a.update_bufs_data_array(u,_,0,s)}}else n.error("Wrong object:",e.name)},t.override_geometry=function(e,t,o,i,l){if(a.has_dyn_geom(e))if(o instanceof Uint16Array||o instanceof Uint32Array)if(i instanceof Float32Array)for(var c=["MAIN","SHADOW","COLOR_ID"],u=0;u<c.length;u++){var d=c[u],f=r.find_batch_material(e,t,d);if(f){var m=f.bufs_data;if(m){a.update_bufs_data_index_array(m,f.draw_mode,o);var p={};for(var h in m.pointers){var v=m.pointers[h],b=i.length/3*v.num_comp;p[E=a.get_vbo_type_by_attr_name(h)]||(p[E]=0),p[E]+=b}var g=a.init_vbo_source_data(p);m.vbo_source_data=g;var y={};for(var h in m.pointers){var v=m.pointers[h],E=a.get_vbo_type_by_attr_name(h);switch(y[E]||(y[E]=0),h){case"a_position":a.vbo_source_data_set_attr(m.vbo_source_data,"a_position",i,y[E]),v.offset=y[E],v.length=i.length,y[E]+=v.length;break;case"a_tbn":var w;l&&(w=a.calc_shared_indices(o,i,i));var A=a.calc_normals(o,i,w);v.length=i.length/3*v.num_comp;for(var T=new Float32Array(v.length),x=0;x<T.length;x+=4)T[x]=1,T[x+3]=1;var O=s.from_norm_tan(A,T);a.vbo_source_data_set_attr(m.vbo_source_data,"a_tbn",O,y[E]),v.offset=y[E],y[E]+=v.length;break;default:v.offset=y[E],v.length=i.length/3*v.num_comp;var R=new(a.get_constructor_by_type(E))(v.length);a.vbo_source_data_set_attr(m.vbo_source_data,h,R,y[E]),y[E]+=v.length}}a.update_gl_buffers(m),_.assign_attribute_setters(f);var k=r.find_batch_material_forked(e,f);k&&k.bufs_data&&(k.bufs_data=m)}}}else n.error("Wrong positions_array type");else n.error("Wrong ibo_array type");else n.error("Wrong object:",e.name)},t.set_shape_key_value=function(e,t,r){if(a.check_shape_keys(e))if(a.has_shape_key(e,t)){var _=parseFloat(r);a.apply_shape_key(e,t,_)}else n.error("Wrong key name:",t);else n.error("Wrong object:",e.name)},t.check_shape_keys=function(e){return a.check_shape_keys(e)},t.get_shape_keys_names=function(e){return a.check_shape_keys(e)?a.get_shape_keys_names(e):(n.error("Wrong object:",e.name),[])},t.get_shape_key_value=function(e,t){return a.check_shape_keys(e)?a.has_shape_key(e,t)?a.get_shape_key_value(e,t):(n.error("Wrong key name:",t),0):(n.error("Wrong object:",e.name),0)},t.draw_line=function(e,t,s){if(s=s||!1,t instanceof Float32Array){var o=r.get_first_batch(e);o&&(a.draw_line(o,t,s),_.assign_attribute_setters(o))}else n.error("Wrong positions type")}}),o("hud",function(e,t){var r=I(e),a=m(e);t.draw_mixer_strip=function(e,t,n,_,s,o,i){a.error_deprecated("draw_mixer_strip","screen.draw_mixer_strip"),r.draw_mixer_strip(e,t,n,_,s,o,i)},t.plot_array=function(e,t,n,_,s,o,i){a.error_deprecated("plot_array","screen.plot_array"),r.plot_array(e,t,n,_,s,o,i)}}),o("lights",function(e,t){function r(e){for(var t=c.get_active(),r=s.get_scene_objs(t,"LAMP",s.DATA_ID_ALL),a=0;a<r.length;a++){var n=r[a];if("SUN"==n.light.type){var o=n;break}}if(o){if("number"==typeof e.hor_position&&"number"==typeof e.vert_position){var l=f.deg_to_rad(180-e.hor_position),m=f.deg_to_rad(90-e.vert_position),h=o.render;u.set_rotation_euler(o,[m,0,l]);var v=new Float32Array(3),g=d.get_quat_view(h.world_tsr);f.quat_to_dir(g,f.AXIS_Z,v);var y=d.get_trans_view(h.world_tsr),E=p.length(y);p.copy(v,b),p.scale(b,E,b),u.set_translation(o,b),u.update_transform(o);var w=o.light;if(w.dynamic_intensity){var A=t.world.light_settings.environment_energy,T=t.world.horizon_color,x=t.world.zenith_color,O=Math.cos(Math.abs(m)),R=Math.max(Math.min(3*O,1),0)*w.default_energy,k=Math.max(O,.1)*A;_.set_light_energy(w,R),c.set_environment_colors(t,k,T,x)}c.update_lamp_scene(o,t)}}else i.error("There is no sun on the scene")}function a(e){return o.is_lamp(e)?e.light.type:(i.error("get_light_type(): Wrong object"),"")}function n(e){var t=e<12?15*e:15*(e-24),a=-Math.cos(e/12*Math.PI)*y,n={};n.hor_position=t,n.vert_position=a,r(n)}var _=R(e),s=$(e),o=k(e),i=m(e),c=j(e),u=Y(e),d=v(e),f=h(e),p=l(e),b=new Float32Array(3),g={},y=60;t.get_lamps=function(e){var t=c.get_active(),r=s.get_scene_objs(t,"LAMP",s.DATA_ID_ALL);if(!e)return r;for(var a=[],n=0;n<r.length;n++){var _=r[n];_.light.type===e&&a.push(_)}return a},t.get_sun_params=function(){for(var e=c.get_active(),t=s.get_scene_objs(e,"LAMP",s.DATA_ID_ALL),r=null,a=0;a<t.length;a++){var n=t[a];if("SUN"==n.light.type){r=n;break}}if(r){var _=r.light.direction,o=f.rad_to_deg(Math.atan2(-_[1],_[0]))+90;o>180&&(o-=360);var i=f.rad_to_deg(Math.atan2(_[2],Math.sqrt(_[0]*_[0]+_[1]*_[1]))),l={};return l.hor_position=o,l.vert_position=i,l}return null},t.set_sun_params=r,t.set_day_time=function(e){for(var t=c.get_active(),r=s.get_scene_objs(t,"LAMP",s.DATA_ID_ALL),a=0;a<r.length;a++){var _=r[a];if("SUN"==_.light.type){var o=_;break}}o?n(e):i.error("There is no sun on the scene")},t.set_date=function(e){g.y=e.getFullYear(),g.m=e.getMonth(),g.d=e.getDate(),g.y?1582==g.y&&9==g.m&&g.d>4&&g.d<15&&i.error("The dates 5 through 14 October, 1582, do not exist in the Gregorian system!"):i.error("There is no year 0 in the Julian system!")},t.set_max_sun_angle=function(e){y=Math.min(Math.max(e,0),90)},t.get_light_params=function(e){if(!o.is_lamp(e))return i.error("get_light_params(): Wrong object"),null;var t=e.light,r=a(e);if(r)switch(r){case"SPOT":(n={light_type:r,light_color:new Float32Array(3),light_energy:t.energy,light_spot_blend:t.spot_blend,light_spot_size:t.spot_size,light_distance:t.distance}).light_color.set(t.color);break;case"POINT":(n={light_type:r,light_color:new Float32Array(3),light_energy:t.energy,light_distance:t.distance}).light_color.set(t.color);break;default:var n={light_type:r,light_color:new Float32Array(3),light_energy:t.energy};n.light_color.set(t.color)}return n||null},t.get_light_type=a,t.set_light_params=function(e,t){if(o.is_lamp(e)){var r=e.light,a=c.get_active(),n=!1;"number"==typeof t.light_energy&&_.set_light_energy(r,t.light_energy),"object"==typeof t.light_color&&_.set_light_color(r,t.light_color),"number"==typeof t.light_spot_blend&&(_.set_light_spot_blend(r,t.light_spot_blend),n=!0),"number"==typeof t.light_spot_size&&(_.set_light_spot_size(r,t.light_spot_size),n=!0),"number"==typeof t.light_distance&&(_.set_light_distance(r,t.light_distance),n=!0),c.update_lamp_scene(e,a),n&&c.update_all_mesh_shaders(a)}else i.error("set_light_params(): Wrong object")},t.get_light_energy=function(e){return o.is_lamp(e)?e.light.energy:(i.error("get_light_energy(): Wrong object"),0)},t.set_light_energy=function(e,t){if(o.is_lamp(e)){var r=c.get_active();_.set_light_energy(e.light,t),c.update_lamp_scene(e,r)}else i.error("set_light_energy(): Wrong object")},t.get_light_color=function(e,t){return o.is_lamp(e)?((t=t||new Float32Array(3)).set(e.light.color),t):(i.error("get_light_color(): Wrong object"),null)},t.set_light_color=function(e,t){if(o.is_lamp(e)){var r=c.get_active();_.set_light_color(e.light,t),c.update_lamp_scene(e,r)}else i.error("set_light_color(): Wrong object")}}),o("logic_nodes",function(e,t){var r=K(e);t.append_custom_callback=function(e,t){r.append_custom_cb(e,t)},t.remove_custom_callback=function(e){r.remove_custom_cb(e)},t.run_entrypoint=function(e,t){r.run_ep(e,t)}}),o("material",function(e,t){var r=_e(e),a=g(e),n=w(e),_=$(e),s=k(e),o=m(e),i=B(e),l=h(e),c=j(e),u=a.defaults;t.inherit_material=function(e,t,r,a){if(n.has_dyn_geom(r)&&n.has_dyn_geom(e)){var s=e.mat_inheritance_data.original_mat_names.indexOf(t);if(-1!=s){var i=r.mat_inheritance_data.original_mat_names.indexOf(a);-1!=i?(0==r._bpy_obj.data.submeshes[i].shade_tangs.length&&e.materials[s].use_tangent_shading&&o.warn('The target material "'+a+'" was exported without tangent shading data. However, the "'+t+'" material requires it. It\'s needed to enable the "Tangent Shading" option on the target material for correct rendering.'),_.inherit_material(e,t,r,a)):o.error('inherit_material(): material "'+a+'" not found on the object "'+r.origin_name+'".')}else o.error('inherit_material(): material "'+t+'" not found on the object "'+e.origin_name+'".')}else o.error('inherit_material(): both objects "'+e.origin_name+'" and "'+r.origin_name+'" must have the "Dynamic Geometry & Materials" flag enabled.')},t.get_materials_names=function(e){var t=[];if(!s.is_dynamic_mesh(e))return o.error('get_materials_names(): Object "'+e.name+'" is not a dynamic MESH.'),t;for(var r=e.scenes_data,a=0;a<r.length;a++)for(var n=r[a].batches,_=0;_<n.length;_++){var i=n[_];if("MAIN"==i.type)for(var l=0;l<i.material_names.length;l++)-1==t.indexOf(i.material_names[l])&&t.push(i.material_names[l])}return t},t.set_diffuse_color=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_diffuse_color(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.diffuse_color.set(a);var _=r.find_batch_material_forked(e,t,"MAIN");_&&_.diffuse_color.set(a)}else o.error('set_diffuse_color(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_diffuse_color(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_diffuse_color=function(e,t){var a=new Float32Array(4);if(!s.is_dynamic_mesh(e))return o.error('get_diffuse_color(): Object "'+e.name+'" is not a dynamic MESH.'),a;var n=r.find_batch_material(e,t,"MAIN");return n?n.has_nodes?(o.error("get_diffuse_color(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),a):(a.set(n.diffuse_color),a):(o.error('get_diffuse_color(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),a)},t.set_diffuse_intensity=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_diffuse_intensity(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.diffuse_intensity=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.diffuse_intensity=a)}else o.error('set_diffuse_intensity(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_diffuse_intensity(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_diffuse_intensity=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_diffuse_intensity(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_diffuse_intensity(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.diffuse_intensity:(o.error('get_diffuse_intensity(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.set_specular_color=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_specular_color(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.specular_color.set(a);var _=r.find_batch_material_forked(e,t,"MAIN");_&&_.specular_color.set(a)}else o.error('set_specular_color(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_specular_color(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_specular_color=function(e,t){var a=new Float32Array(3);if(!s.is_dynamic_mesh(e))return o.error('get_specular_color(): Object "'+e.name+'" is not a dynamic MESH.'),a;var n=r.find_batch_material(e,t,"MAIN");return n?n.has_nodes?(o.error("get_specular_color(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),a):(a.set(n.specular_color),a):(o.error('get_specular_color(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),a)},t.set_specular_color_factor=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_specular_color_factor(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.specular_color_factor=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.specular_color_factor=a)}else o.error('set_specular_color_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_specular_color_factor(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_specular_color_factor=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_specular_color_factor(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_specular_color_factor(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.specular_color_factor:(o.error('get_specular_color_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.set_specular_intensity=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_specular_intensity(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.specular_params[0]=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.specular_params[0]=a)}else o.error('set_specular_intensity(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_specular_intensity(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_specular_intensity=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_specular_intensity(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_specular_intensity(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.specular_params[0]:(o.error('get_specular_intensity(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.check_specular_intensity=function(e,t){o.error_once("check_specular_intensity() is deprecated, not needed anymore");var a=r.find_batch_material(e,t,"MAIN");return Boolean(a&&a.specular_params[0])},t.set_specular_hardness=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_specular_hardness(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.specular_params[1]=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.specular_params[1]=a)}else o.error('set_specular_hardness(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_specular_hardness(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_specular_hardness=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_specular_hardness(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_specular_hardness(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.specular_params[1]:(o.error('get_specular_hardness(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.check_specular_hardness=function(e,t){o.error_once("check_specular_hardness() is deprecated, not needed anymore");var a=r.find_batch_material(e,t,"MAIN");return Boolean(a&&a.specular_params[1])},t.set_emit_factor=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_emit_factor(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.emit=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.emit=a)}else o.error('set_emit_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_emit_factor(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_emit_factor=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_emit_factor(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_emit_factor(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.emit:(o.error('get_emit_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.set_ambient_factor=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_ambient_factor(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.ambient=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.ambient=a)}else o.error('set_ambient_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_ambient_factor(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_ambient_factor=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_ambient_factor(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_ambient_factor(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.ambient:(o.error('get_ambient_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.set_diffuse_color_factor=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_diffuse_color_factor(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.diffuse_color_factor=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.diffuse_color_factor=a)}else o.error('set_diffuse_color_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_diffuse_color_factor(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_diffuse_color_factor=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_diffuse_color_factor(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_diffuse_color_factor(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.diffuse_color_factor:(o.error('get_diffuse_color_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.set_alpha_factor=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_alpha_factor(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{n.alpha_factor=a;var _=r.find_batch_material_forked(e,t,"MAIN");_&&(_.alpha_factor=a)}else o.error('set_alpha_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_alpha_factor(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_alpha_factor=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_alpha_factor(): Object "'+e.name+'" is not a dynamic MESH.'),0;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes?(o.error("get_alpha_factor(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),0):a.alpha_factor:(o.error('get_alpha_factor(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),0)},t.get_material_extended_params=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_material_extended_params(): Object "'+e.name+'" is not a dynamic MESH.'),null;var a=r.find_batch_material(e,t,"MAIN");if(!a)return o.error('get_material_extended_params(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),null;if(a.has_nodes)return o.error("get_material_extended_params(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),null;var n={};return n.reflect_factor=a.reflect_factor,n.fresnel=a.fresnel_params[0],n.fresnel_factor=5*(1-a.fresnel_params[1]),n.parallax_scale=a.parallax_scale,n.parallax_steps=parseFloat(r.get_batch_directive(a,"PARALLAX_STEPS")[1]),n},t.set_material_extended_params=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n)if(n.has_nodes)o.error("set_material_extended_params(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{var _=[n],l=r.find_batch_material_forked(e,t,"MAIN");l&&_.push(l);for(var u=0;u<_.length;u++)n=_[u],"number"==typeof a.reflect_factor&&(n.reflect_factor=a.reflect_factor),"number"==typeof a.fresnel&&(n.fresnel_params[0]=a.fresnel),"number"==typeof a.fresnel_factor&&(n.fresnel_params[1]=1-a.fresnel_factor/5),"number"==typeof a.parallax_scale&&(n.parallax_scale=a.parallax_scale),"number"==typeof a.parallax_steps&&(r.set_batch_directive(n,"PARALLAX_STEPS",i.glsl_value(a.parallax_steps)),r.update_shader(n),c.recalculate_draw_data(n))}else o.error('set_material_extended_params(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".')}else o.error('set_material_extended_params(): Object "'+e.name+'" is not a dynamic MESH.')},t.get_water_material_params=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('get_water_material_params(): Object "'+e.name+'" is not a dynamic MESH.'),null;var a=r.find_batch_material(e,t,"MAIN");if(!a||!a.water)return o.error('get_water_material_params(): Material "'+t+'" wasn\'t found on the object "'+e.name+"\" or it's not a water material."),null;if(a.has_nodes)return o.error("get_water_material_params(): Not allowed for node materials! Use get_nodemat_value/get_nodemat_rgb methods instead."),null;var n={};return n.shore_smoothing=u.shore_smoothing&&a.water_shore_smoothing&&Boolean(parseFloat(r.get_batch_directive(a,"SHORE_SMOOTHING")[1])),n.absorb_factor=parseFloat(r.get_batch_directive(a,"ABSORB")[1]),n.foam_factor=a.foam_factor,n.shallow_water_col=new Float32Array(3),n.shore_water_col=new Float32Array(3),n.shallow_water_col_fac=0,n.shore_water_col_fac=0,u.shore_distance&&(n.shallow_water_col.set(a.shallow_water_col),n.shore_water_col.set(a.shore_water_col),n.shallow_water_col_fac=a.shallow_water_col_fac,n.shore_water_col_fac=a.shore_water_col_fac),n.norm_uv_velocity=a.water_norm_uv_velocity,n.water_dynamic=u.water_dynamic&&a.water_dynamic&&Boolean(parseFloat(r.get_batch_directive(a,"DYNAMIC")[1])),n.sss_strength=parseFloat(r.get_batch_directive(a,"SSS_STRENGTH")[1]),n.sss_width=parseFloat(r.get_batch_directive(a,"SSS_WIDTH")[1]),n.waves_height=parseFloat(r.get_batch_directive(a,"WAVES_HEIGHT")[1]),n.waves_length=parseFloat(r.get_batch_directive(a,"WAVES_LENGTH")[1]),n.dst_noise_scale0=parseFloat(r.get_batch_directive(a,"DST_NOISE_SCALE_0")[1]),n.dst_noise_scale1=parseFloat(r.get_batch_directive(a,"DST_NOISE_SCALE_1")[1]),n.dst_noise_freq0=parseFloat(r.get_batch_directive(a,"DST_NOISE_FREQ_0")[1]),n.dst_noise_freq1=parseFloat(r.get_batch_directive(a,"DST_NOISE_FREQ_1")[1]),n.dir_min_shore_fac=parseFloat(r.get_batch_directive(a,"DIR_MIN_SHR_FAC")[1]),n.dir_freq=parseFloat(r.get_batch_directive(a,"DIR_FREQ")[1]),n.dir_noise_scale=parseFloat(r.get_batch_directive(a,"DIR_NOISE_SCALE")[1]),n.dir_noise_freq=parseFloat(r.get_batch_directive(a,"DIR_NOISE_FREQ")[1]),n.dir_min_noise_fac=parseFloat(r.get_batch_directive(a,"DIR_MIN_NOISE_FAC")[1]),n.dst_min_fac=parseFloat(r.get_batch_directive(a,"DST_MIN_FAC")[1]),n.waves_hor_fac=parseFloat(r.get_batch_directive(a,"WAVES_HOR_FAC")[1]),n},t.set_water_material_params=function(e,t,a){if(s.is_dynamic_mesh(e)){var n=r.find_batch_material(e,t,"MAIN");if(n&&n.water)if(n.has_nodes)o.error("set_water_material_params(): Not allowed for node materials! Use set_nodemat_value/set_nodemat_rgb methods instead.");else{var _=[n],l=r.find_batch_material_forked(e,t,"MAIN");l&&_.push(l);for(var d=0;d<_.length;d++){if(n=_[d],"boolean"==typeof a.shore_smoothing&&(u.shore_smoothing&&n.water_shore_smoothing&&a.shore_smoothing?r.set_batch_directive(n,"SHORE_SMOOTHING",1):r.set_batch_directive(n,"SHORE_SMOOTHING",0)),"number"==typeof a.absorb_factor){var f=i.glsl_value(parseFloat(a.absorb_factor));r.set_batch_directive(n,"ABSORB",f)}if("number"==typeof a.foam_factor&&u.foam&&(n.foam_factor=a.foam_factor),u.shore_distance&&("object"==typeof a.shallow_water_col&&n.shallow_water_col.set(a.shallow_water_col),"number"==typeof a.shallow_water_col_fac&&(n.shallow_water_col_fac=a.shallow_water_col_fac),"object"==typeof a.shore_water_col&&n.shore_water_col.set(a.shore_water_col),"number"==typeof a.shore_water_col_fac&&(n.shore_water_col_fac=a.shore_water_col_fac)),"number"==typeof a.norm_uv_velocity&&(n.water_norm_uv_velocity=a.norm_uv_velocity),u.water_dynamic&&n.water_dynamic){if("boolean"==typeof a.water_dynamic&&(a.water_dynamic?r.set_batch_directive(n,"DYNAMIC",1):r.set_batch_directive(n,"DYNAMIC",0)),"number"==typeof a.sss_strength&&(p=i.glsl_value(parseFloat(a.sss_strength)),r.set_batch_directive(n,"SSS_STRENGTH",p)),"number"==typeof a.sss_width&&(p=i.glsl_value(parseFloat(a.sss_width)),r.set_batch_directive(n,"SSS_WIDTH",p)),"number"==typeof a.waves_height){var m=i.glsl_value(parseFloat(a.waves_height));r.set_batch_directive(n,"WAVES_HEIGHT",m)}if("number"==typeof a.waves_length){var p=i.glsl_value(parseFloat(a.waves_length));r.set_batch_directive(n,"WAVES_LENGTH",p)}if("number"==typeof a.dst_noise_scale0){var h=i.glsl_value(parseFloat(a.dst_noise_scale0));r.set_batch_directive(n,"DST_NOISE_SCALE_0",h)}if("number"==typeof a.dst_noise_scale1){var v=i.glsl_value(parseFloat(a.dst_noise_scale1));r.set_batch_directive(n,"DST_NOISE_SCALE_1",v)}if("number"==typeof a.dst_noise_freq0){var b=i.glsl_value(parseFloat(a.dst_noise_freq0));r.set_batch_directive(n,"DST_NOISE_FREQ_0",b)}if("number"==typeof a.dst_noise_freq1){var g=i.glsl_value(parseFloat(a.dst_noise_freq1));r.set_batch_directive(n,"DST_NOISE_FREQ_1",g)}if("number"==typeof a.dir_min_shore_fac){var y=i.glsl_value(parseFloat(a.dir_min_shore_fac));r.set_batch_directive(n,"DIR_MIN_SHR_FAC",y)}if("number"==typeof a.dir_freq){var E=i.glsl_value(parseFloat(a.dir_freq));r.set_batch_directive(n,"DIR_FREQ",E)}if("number"==typeof a.dir_noise_scale){var w=i.glsl_value(parseFloat(a.dir_noise_scale));r.set_batch_directive(n,"DIR_NOISE_SCALE",w)}if("number"==typeof a.dir_noise_freq){var A=i.glsl_value(parseFloat(a.dir_noise_freq));r.set_batch_directive(n,"DIR_NOISE_FREQ",A)}if("number"==typeof a.dir_min_noise_fac){var T=i.glsl_value(parseFloat(a.dir_min_noise_fac));r.set_batch_directive(n,"DIR_MIN_NOISE_FAC",T)}if("number"==typeof a.dst_min_fac){var x=i.glsl_value(parseFloat(a.dst_min_fac));r.set_batch_directive(n,"DST_MIN_FAC",x)}if("number"==typeof a.waves_hor_fac){var O=i.glsl_value(parseFloat(a.waves_hor_fac));r.set_batch_directive(n,"WAVES_HOR_FAC",O)}}r.update_shader(n),c.recalculate_draw_data(n)}}else o.error('set_water_material_params(): Material "'+t+'" wasn\'t found on the object "'+e.name+"\" or it's not a water material.")}else o.error('set_water_material_params(): Object "'+e.name+'" is not a dynamic MESH.')},t.set_line_params=function(e,t){if(s.is_line(e)){var a=r.get_first_batch(e);a?(l.isdef(t.color)&&a.diffuse_color.set(t.color),l.isdef(t.width)&&(a.line_width=t.width)):o.error("set_line_params(): Couldn't set line parameters!")}else o.error('set_line_params(): Object "'+e.name+'" is not a LINE object.')},t.get_line_params=function(e){if(!s.is_line(e))return o.error('get_line_params(): Object "'+e.name+'" is not a LINE object.'),null;var t=r.get_first_batch(e);return t?{color:new Float32Array(t.diffuse_color),width:t.line_width}:(o.error("get_line_params(): Couldn't get line parameters!"),null)},t.set_nodemat_value=function(e,t,a){var n=s.is_dynamic_mesh(e),i=s.is_world(e),l=i?_.get_world_name(e):e.name;if(n||i){if(n){var u=t[0],d=1;if(!(m=r.find_batch_material_any(e,u,"MAIN")||r.find_batch_material_any(e,u,"PARTICLES")))return void o.error('set_nodemat_value(): Material "'+u+'" wasn\'t found on the object "'+l+'".')}else if(i){var f=c.get_active(),u="",d=0,m=r.get_batch_by_type(e,"SKY",f);if(!m)return void o.error("set_nodemat_value(): Sky node material wasn't found on the world object \""+l+'".')}var p=_.get_node_val_ind_by_name_list(m.node_value_inds,t,d);null!==p?_.set_nodemat_value(e,u,p,a):o.error('set_nodemat_value(): Value node "'+t[t.length-1]+'" was not found in the object "'+l+'".')}else o.error('set_nodemat_value(): Object "'+l+'" is not a dynamic MESH or WORLD.')},t.get_nodemat_value=function(e,t){var a=s.is_dynamic_mesh(e),n=s.is_world(e),i=n?_.get_world_name(e):e.name;if(!a&&!n)return o.error('get_nodemat_value(): Object "'+i+'" is not a dynamic MESH or WORLD.'),0;if(a){var l=t[0],u=1;if(!(f=r.find_batch_material_any(e,l,"MAIN")||r.find_batch_material_any(e,l,"PARTICLES")))return o.error('get_nodemat_value(): Material "'+l+'" wasn\'t found on the object "'+i+'".'),0}else if(n){var d=c.get_active(),l="",u=0,f=r.get_batch_by_type(e,"SKY",d);if(!f)return o.error("get_nodemat_value(): Sky node material wasn't found on the world object \""+i+'".'),0}var m=_.get_node_val_ind_by_name_list(f.node_value_inds,t,u);return null===m?(o.error('get_nodemat_value(): Value node "'+t[t.length-1]+'" was not found in the object "'+i+'".'),0):_.get_nodemat_value(f,m)},t.set_nodemat_rgb=function(e,t,a,n,i){var l=s.is_dynamic_mesh(e),u=s.is_world(e),d=u?_.get_world_name(e):e.name;if(l||u){if(l){var f=t[0],m=1;if(!(h=r.find_batch_material_any(e,f,"MAIN")||r.find_batch_material_any(e,f,"PARTICLES")))return void o.error('set_nodemat_rgb(): Material "'+f+'" wasn\'t found on the object "'+d+'".')}else if(u){var p=c.get_active(),f="",m=0,h=r.get_batch_by_type(e,"SKY",p);if(!h)return void o.error("set_nodemat_rgb(): Sky node material wasn't found on the world object \""+d+'".')}var v=_.get_node_rgb_ind_by_name_list(h.node_rgb_inds,t,m);null!==v?_.set_nodemat_rgb(e,f,v,a,n,i):o.error('set_nodemat_rgb(): RGB node "'+t[t.length-1]+'" was not found in the object "'+d+'".')}else o.error('set_nodemat_rgb(): Object "'+d+'" is not a dynamic MESH or WORLD.')},t.get_nodemat_rgb=function(e,t,a){var n=s.is_dynamic_mesh(e),i=s.is_world(e),l=i?_.get_world_name(e):e.name;if(!n&&!i)return o.error('get_nodemat_rgb(): Object "'+l+'" is not a dynamic MESH or WORLD.'),null;if(n){var u=t[0],d=1;if(!(m=r.find_batch_material_any(e,u,"MAIN")||r.find_batch_material_any(e,u,"PARTICLES")))return o.error('get_nodemat_rgb(): Material "'+u+'" wasn\'t found on the object "'+l+'".'),null}else if(i){var f=c.get_active(),u="",d=0,m=r.get_batch_by_type(e,"SKY",f);if(!m)return o.error("get_nodemat_rgb(): Sky node material wasn't found on the world object \""+l+'".'),null}var p=_.get_node_rgb_ind_by_name_list(m.node_rgb_inds,t,d);return null===p?(o.error('get_nodemat_rgb(): RGB node "'+t[t.length-1]+'" was not found in the object "'+l+'".'),null):(a||(a=new Float32Array(3)),_.get_nodemat_rgb(m,p,a))},t.is_node_material=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('is_node_material(): Object "'+e.name+'" is not a dynamic MESH.'),!1;var a=r.find_batch_material(e,t,"MAIN");return a?a.has_nodes:(o.error('is_node_material(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),!1)},t.is_water_material=function(e,t){if(!s.is_dynamic_mesh(e))return o.error('is_water_material(): Object "'+e.name+'" is not a dynamic MESH.'),!1;var a=r.find_batch_material(e,t,"MAIN");return a?a.water&&!a.has_nodes:(o.error('is_water_material(): Material "'+t+'" wasn\'t found on the object "'+e.name+'".'),!1)}}),o("math",function(e,t){var r=l(e),a=h(e),n=f(e),_=new Float32Array(3);t.create_pline_from_points=function(e,t){var a=new Float32Array(6);return n.set_pline_initial_point(a,e),r.subtract(t,e,_),n.set_pline_directional_vec(a,_),a},t.create_pline_from_point_vec=function(e,t){var r=new Float32Array(6);return n.set_pline_initial_point(r,e),n.set_pline_directional_vec(r,t),r},t.create_pline=function(){return new Float32Array(6)},t.get_pline_directional_vec=n.get_pline_directional_vec,t.get_pline_initial_point=n.get_pline_initial_point,t.set_pline_initial_point=n.set_pline_initial_point,t.set_pline_directional_vec=n.set_pline_directional_vec,t.line_plane_intersect=a.line_plane_intersect,t.calc_pline_point=n.calc_pline_point,t.point_plane_dist=n.point_plane_dist,t.linear_tween=n.linear_tween,t.ease_in_quad=n.ease_in_quad,t.ease_out_quad=n.ease_out_quad,t.ease_in_out_quad=n.ease_in_out_quad,t.ease_in_cubic=n.ease_in_cubic,t.ease_out_cubic=n.ease_out_cubic,t.ease_in_out_cubic=n.ease_in_out_cubic,t.ease_in_quart=n.ease_in_quart,t.ease_out_quart=n.ease_out_quart,t.ease_in_out_quart=n.ease_in_out_quart,t.ease_in_quint=n.ease_in_quint,t.ease_out_quint=n.ease_out_quint,t.ease_in_out_quint=n.ease_in_out_quint,t.ease_in_sine=n.ease_in_sine,t.ease_out_sine=n.ease_out_sine,t.ease_in_out_sine=n.ease_in_out_sine,t.ease_in_expo=n.ease_in_expo,t.ease_out_expo=n.ease_out_expo,t.ease_in_out_expo=n.ease_in_out_expo,t.ease_in_circ=n.ease_in_circ,t.ease_out_circ=n.ease_out_circ,t.ease_in_out_circ=n.ease_in_out_circ,t.ease_in_elastic=n.ease_in_elastic,t.ease_out_elastic=n.ease_out_elastic,t.ease_in_out_elastic=n.ease_in_out_elastic,t.ease_in_back=n.ease_in_back,t.ease_out_back=n.ease_out_back,t.ease_in_out_back=n.ease_in_out_back,t.ease_in_bounce=n.ease_in_bounce,t.ease_out_bounce=n.ease_out_bounce,t.ease_in_out_bounce=n.ease_in_out_bounce}),o("nla",function(e,t){var r=V(e),a=x(e),n=m(e),_=h(e);t.set_frame=function(e){e=_.clamp(e,r.get_frame_start(),r.get_frame_end()),r.check_logic_nodes()?n.error("The active scene is using the Logic Editor."):r.set_frame(e,a.get_timeline())},t.get_frame=function(){return r.get_frame(a.get_timeline())},t.stop=function(){r.check_logic_nodes()&&n.warn("The active scene is using the Logic Editor. It may conflicts with your JS-code."),r.stop_nla()},t.play=function(e){r.check_logic_nodes()&&n.warn("The active scene is using the Logic Editor. It may conflicts with your JS-code."),r.play_nla(e)},t.is_play=function(){return r.is_play()},t.get_frame_start=function(){return r.get_frame_start()},t.get_frame_end=function(){return r.get_frame_end()},t.check_nla=function(){return r.check_nla()},t.check_logic_nodes=function(){return r.check_logic_nodes()},t.set_range=function(e,t){r.check_logic_nodes()?n.error("The active scene is using the Logic Editor."):(t=parseFloat(t)||r.get_frame_end(),e=parseFloat(e)||r.get_frame_end(),t=_.clamp(t,r.get_frame_start(),r.get_frame_end()),e=_.clamp(e,r.get_frame_start(),t),r.set_range(e,t))},t.reset_range=function(){r.check_logic_nodes()?n.error("The active scene is using the Logic Editor."):r.reset_range()},t.set_cyclic=function(e){r.check_logic_nodes()?n.error("The active scene is using the Logic Editor."):r.set_cyclic(e)},t.clear_callback=function(){r.check_logic_nodes()?n.error("The active scene is using the Logic Editor."):r.clear_callback()}}),o("objects",function(e,t){var r=w(e),a=$(e),n=_e(e),_=k(e),s=m(e),o=j(e),i=h(e);t.get_meta_tags=function(e){if(e)return a.get_meta_tags(e)},t.get_custom_prop=function(e){if(e)return a.get_custom_prop(e)},t.copy=function(e,t,n){return _.is_mesh(e)?_.is_dynamic(e)?r.has_dyn_geom(e)||r.check_shape_keys(e)||!n?-1==a.get_scene_objs(o.get_active(),"MESH",a.DATA_ID_ALL).indexOf(e)?(s.error('object "'+e.name+'" does not belong to the active scene.'),!1):(t=t||"",a.copy(e,t,n)):(s.error('object "'+e.name+'" has not dynamic geometry for deep copying.'),!1):(s.error('object "'+e.name+'" is not dynamic.'),!1):(s.error('object "'+e.name+'" is not of type "MESH".'),!1)},t.set_nodemat_value=function(e,t,r){if(s.error_deprecated("set_nodemat_value","material.set_nodemat_value"),_.is_dynamic_mesh(e)){var o=t[0],i=n.find_batch_material(e,o,"MAIN");if(null===i)return s.error('Material "'+o+'" was not found in the object "'+e.name+'".'),null;var l=a.get_node_val_ind_by_name_list(i.node_value_inds,t,1);if(null===l)return s.error('Value node "'+t[t.length-1]+'" was not found in the object "'+e.name+'".'),null;a.set_nodemat_value(e,o,l,r)}else s.error('The type of the object "'+e.name+'" is not "MESH" or it is not dynamic.')},t.get_nodemat_value=function(e,t){if(s.error_deprecated("get_nodemat_value","material.get_nodemat_value"),!_.is_dynamic_mesh(e))return s.error('The type of the object "'+e.name+'" is not "MESH" or it is not dynamic.'),0;var r=t[0],o=n.find_batch_material(e,r,"MAIN");if(null===o)return s.error('Material "'+r+'" was not found in the object "'+e.name+'".'),0;var i=a.get_node_val_ind_by_name_list(o.node_value_inds,t,1);return null===i?(s.error('Value node "'+t[t.length-1]+'" was not found in the object "'+e.name+'".'),0):a.get_nodemat_value(o,i)},t.set_nodemat_rgb=function(e,t,r,o,i){if(s.error_deprecated("set_nodemat_rgb","material.set_nodemat_rgb"),_.is_dynamic_mesh(e)){var l=t[0],c=n.find_batch_material(e,l,"MAIN");if(null!==c){var u=a.get_node_rgb_ind_by_name_list(c.node_rgb_inds,t,1);null!==u?a.set_nodemat_rgb(e,l,u,r,o,i):s.error('RGB node "'+t[t.length-1]+'" was not found in the object "'+e.name+'".')}else s.error('Material "'+l+'" was not found in the object "'+e.name+'".')}else s.error('The type of the object "'+e.name+'" is not "MESH" or it is not dynamic.')},t.get_nodemat_rgb=function(e,t,r){if(s.error_deprecated("get_nodemat_rgb","material.get_nodemat_rgb"),!_.is_dynamic_mesh(e))return s.error('The type of the object "'+e.name+'" is not "MESH" or it is not dynamic.'),null;var o=t[0],i=n.find_batch_material(e,o,"MAIN");if(null===i)return s.error('Material "'+o+'" was not found in the object "'+e.name+'".'),null;var l=a.get_node_rgb_ind_by_name_list(i.node_rgb_inds,t);return null===l?(s.error('RGB node "'+t[t.length-1]+'" was not found in the object "'+e.name+'".'),null):(r||(r=new Float32Array(3)),a.get_nodemat_rgb(i,l,r))},t.update_boundings=function(e){_.is_mesh(e)?r.has_dyn_geom(e)||r.check_shape_keys(e)?a.update_boundings(e):s.error('object "'+e.name+'" has not dynamic geometry.'):s.error('The type of the object "'+e.name+'" is not "MESH".')},t.get_parent=_.get_parent,t.get_dg_parent=_.get_dg_parent,t.is_mesh=_.is_mesh,t.is_armature=_.is_armature,t.is_speaker=_.is_speaker,t.is_camera=_.is_camera,t.is_lamp=_.is_lamp,t.is_empty=_.is_empty,t.is_line=_.is_line,t.is_world=_.is_world,t.get_selectable_objects=function(){return a.get_selectable_objects()},t.get_outlining_objects=function(){return a.get_outlining_objects()},t.is_dynamic=_.is_dynamic,t.set_wind_bending_params=function(e,t){if(_.is_dynamic_mesh(e)){var r=e.render;if(r.wind_bending){if("number"==typeof t.angle){var o=n.wb_angle_to_amp(i.deg_to_rad(t.angle),r.bb_original,r.world_tsr[3]);r.wind_bending_amp=o}"number"==typeof t.main_frequency&&(r.wind_bending_freq=t.main_frequency),"number"==typeof t.detail_frequency&&(r.detail_bending_freq=t.detail_frequency),"number"==typeof t.detail_amplitude&&(r.detail_bending_amp=t.detail_amplitude),"number"==typeof t.branch_amplitude&&(r.branch_bending_amp=t.branch_amplitude),a.set_hair_particles_wind_bend_params(e)}else s.error('The "'+e.name+"\" object doesn't have wind bending parameters.")}else s.error('The type of the object "'+e.name+'" is not "MESH" or it is not dynamic.')},t.get_wind_bending_params=function(e){var t=e.render;if(!t.wind_bending)return null;var r={},a=i.rad_to_deg(n.wb_amp_to_angle(t.wind_bending_amp,t.bb_original,t.world_tsr[3]));return r.angle=a,r.main_frequency=t.wind_bending_freq,r.detail_frequency=t.detail_bending_freq,r.detail_amplitude=t.detail_bending_amp,r.branch_amplitude=t.branch_bending_amp,r},t.create_line=function(e){return a.create_line(e)},t.hide_all_by_data_id=function(e){for(var t=a.get_all_objects("ALL",e),r=0;r<t.length;r++)o.change_visibility(t[r],!0)},t.show_all_by_data_id=function(e){for(var t=a.get_all_objects("ALL",e),r=0;r<t.length;r++)o.change_visibility(t[r],!1)}}),o("particles",function(e,t){var r=N(e),a=m(e);t.set_size=function(e,t,n){r.obj_has_psys(e,t)?r.set_size(e,t,n):a.error('set_size(): Object "'+e.name+'" has not a particle system named "'+t+'"')},t.set_normal_factor=function(e,t,n){r.obj_has_psys(e,t)?r.set_normal_factor(e,t,n):a.error('set_normal_factor(): Object "'+e.name+'" has not a particle system named "'+t+'"')},t.set_factor=function(e,t,n){r.obj_has_psys(e,t)?(n=Math.min(n,1),n=Math.max(n,0),r.set_factor(e,t,n)):a.error('set_factor(): Object "'+e.name+'" has not a particle system named "'+t+'"')}}),o("rgb",function(e,t){var r=h(e),a=new Float32Array(3);t.create=function(){return new Float32Array(3)},t.from_values=function(e,t,r){var a=new Float32Array(3);return a[0]=e,a[1]=t,a[2]=r,a},t.set=function(e,t,r,a){return a[0]=e,a[1]=t,a[2]=r,a},t.css_to_rgb=function(e,t,a,n){return n=n||new Float32Array(3),n[0]=e/255,n[1]=t/255,n[2]=a/255,r.srgb_to_lin(n,n),n},t.rgb_to_css=function(e){var t=r.lin_to_srgb(e,a);return[Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])]},t.rgb_to_css_hex=function(e){var t=function(e){var t=Math.round(255*e).toString(16);return 1==t.length?"0"+t:t},n=r.lin_to_srgb(e,a);return"#"+t(n[0])+t(n[1])+t(n[2])}}),o("textures",function(e,t){var r=m(e),a=j(e),n=ee(e),_=k(e),s=h(e),o=F(e);t.play_video=function(e,t){t||(t=0);var _=n.get_video_texture(e,t);_?a.get_active().b4w_use_nla&&n.video_allow_nla(_)?r.error("NLA texture can't be controlled directly through API."):n.play_video(_):r.error('Texture with name "'+e+'" not found!')},t.pause_video=function(e,t){t||(t=0);var _=n.get_video_texture(e,t);_?a.get_active().b4w_use_nla&&n.video_allow_nla(_)?r.error("NLA texture can't be controlled directly through API."):n.pause_video(_):r.error('Texture with name "'+e+'" not found!')},t.reset_video=function(e,t){t||(t=0);var _=n.get_video_texture(e,t);_?a.get_active().b4w_use_nla&&n.video_allow_nla(_)?r.error("NLA texture can't be controlled directly through API."):n.reset_video(_):r.error('Texture with name "'+e+'" not found!')},t.get_canvas_ctx=function(e,t){if(_.is_mesh(e)){var a=n.get_canvas_context_by_object(e,t);if(a)return a;r.error("Couldn't find canvas texture with this name: "+t)}else r.error("Object must be type of mesh.");return null},t.update_canvas_ctx=function(e,t){if(!_.is_mesh(e))return r.error("Object must be type of mesh."),!1;var a=n.get_texture_by_name(e,t);return a&&"CANVAS"==a.source?(n.update_texture_canvas(a),!0):(r.error("Couldn't find canvas texture \""+t+'" in object "'+e.name+'".'),!1)},t.change_image=function(e,t,a,_){r.error_deprecated("change_image","replace_image"),_=_||function(){};var i=n.get_texture_by_name(e,t);if(!i)return r.error("Couldn't find texture \""+t+'" in object "'+e.name+'".'),void _(!1);if(i.is_movie)return r.error("Changing video textures is forbidden."),void _(!1);var l=s.normpath_preserve_protocol(a);if(i.img_full_filepath!=l){var c={id:a,type:o.AT_IMAGE_ELEMENT,url:a,request_method:"GET"};o.enqueue([c],function(r,s,o,l){r?(n.change_image(e,i,t,r,a),_(!0)):_(!1)},null,null)}else _(!0)},t.replace_image=function(e,t,a,_){_=_||function(){};var s=n.get_texture_by_name(e,t);if(!s)return r.error("Couldn't find texture \""+t+'" in object "'+e.name+'".'),void _(!1);if(s.is_movie)return r.error("Changing video textures is forbidden."),void _(!1);if(!("src"in a))return r.error("Incorrect image."),void _(!1);var o=a.src;n.change_image(e,s,t,a,o)},t.get_texture_names=function(e){return _.is_mesh(e)?n.get_texture_names(e):(r.error("Object must be type of mesh."),[])}}),o("version",function(e,t){var r=U(e);t.version=r.version,t.version_str=r.version_str,t.type=r.type,t.date=r.date,t.date_str=r.date_str,t.get_build_version=r.get_build_version}),o("__gpp_parser",function(e,t){t.parser=function(){function e(e,t,r,a,n,_){this.message=e,this.expected=t,this.found=r,this.offset=a,this.line=n,this.column=_,this.name="SyntaxError"}return function(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}(e,Error),{SyntaxError:e,parse:function(t){function r(e){return $s!==e&&($s>e&&($s=0,eo={line:1,column:1,seenCR:!1}),function(e,r,a){var n,_;for(n=$s;n<a;n++)"\n"===(_=t.charAt(n))?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===_||"\u2028"===_||"\u2029"===_?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1)}(eo,0,e),$s=e),eo}function a(e){Js<to||(Js>to&&(to=Js,ro=[]),ro.push(e))}function n(){var e,t;return e=Js,We()!==nt&&(t=_())!==nt&&We()!==nt?e=ot(t):(Js=e,e=nt),e}function _(){var e;return(e=s())===nt&&(e=null),e!==nt&&(e=it(e)),e}function s(){var e,t,r,a,n,_;if(e=Js,(t=o())!==nt){for(r=[],a=Js,(n=We())!==nt&&(_=o())!==nt?a=n=[n,_]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=We())!==nt&&(_=o())!==nt?a=n=[n,_]:(Js=a,a=nt);r!==nt?e=t=lt(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function o(){var e;return(e=i())===nt&&(e=f())===nt&&(e=m())===nt&&(e=M()),e}function i(){var e,t,r,a,n;if(e=Js,(t=l())!==nt)if(We()!==nt){for(r=[],a=c();a!==nt;)r.push(a),a=c();r!==nt&&(a=We())!==nt?((n=u())===nt&&(n=null),n!==nt&&We()!==nt&&d()!==nt?e=t=ct(t,r,n):(Js=e,e=nt)):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;return e}function l(){var e,r,n,s,o;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,2)===ft?(n=ft,Js+=2):(n=nt,0===ao&&a(mt)),n!==nt&&He()!==nt&&(s=S())!==nt&&Ye()!==nt&&Xe()!==nt&&We()!==nt&&(o=_())!==nt?e=r=pt(s,o):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,5)===ht?(n=ht,Js+=5):(n=nt,0===ao&&a(vt)),n!==nt&&He()!==nt&&(s=Z())!==nt&&Ye()!==nt&&Xe()!==nt&&We()!==nt&&(o=_())!==nt?e=r=bt(s,o):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,6)===gt?(n=gt,Js+=6):(n=nt,0===ao&&a(yt)),n!==nt&&He()!==nt&&(s=Z())!==nt&&Ye()!==nt&&Xe()!==nt&&We()!==nt&&(o=_())!==nt?e=r=Et(s,o):(Js=e,e=nt)):(Js=e,e=nt))),e}function c(){var e,r,n,s,o;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,4)===wt?(n=wt,Js+=4):(n=nt,0===ao&&a(At)),n!==nt&&He()!==nt&&(s=S())!==nt&&Ye()!==nt&&Xe()!==nt&&We()!==nt&&(o=_())!==nt&&We()!==nt?e=r=Tt(s,o):(Js=e,e=nt)):(Js=e,e=nt),e}function u(){var e,r,n,s;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,4)===xt?(n=xt,Js+=4):(n=nt,0===ao&&a(Ot)),n!==nt&&Ye()!==nt&&Xe()!==nt&&We()!==nt&&(s=_())!==nt?e=r=Rt(s):(Js=e,e=nt)):(Js=e,e=nt),e}function d(){var e,r,n,_,s,o;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&(n=Ye())!==nt?(t.substr(Js,5)===kt?(_=kt,Js+=5):(_=nt,0===ao&&a(Nt)),_!==nt&&(s=Ye())!==nt&&(o=Ke())!==nt?e=r=[r,n,_,s,o]:(Js=e,e=nt)):(Js=e,e=nt),e}function f(){var e,r,n,_,s,o,i,l;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,7)===Mt?(n=Mt,Js+=7):(n=nt,0===ao&&a(It)),n!==nt&&(_=Ye())!==nt&&(s=ce())!==nt&&(o=Ye())!==nt&&(i=Ke())!==nt?e=r=St(s):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,6)===Lt?(n=Lt,Js+=6):(n=nt,0===ao&&a(Ct)),n===nt&&(t.substr(Js,3)===Pt?(n=Pt,Js+=3):(n=nt,0===ao&&a(Dt))),n!==nt&&(_=He())!==nt&&(s=Z())!==nt?(o=Js,(i=He())!==nt&&(l=I())!==nt?o=i=[i,l]:(Js=o,o=nt),o===nt&&(o=null),o!==nt&&(i=Ye())!==nt&&(l=Ke())!==nt?e=r=Ut(n,s,o):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,5)===Ft?(n=Ft,Js+=5):(n=nt,0===ao&&a(Bt)),n!==nt?(_=Js,(s=He())!==nt&&(o=I())!==nt?_=s=[s,o]:(Js=_,_=nt),_===nt&&(_=null),_!==nt&&(s=Ye())!==nt&&(o=Ke())!==nt?e=r=Gt(_):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,4)===jt?(n=jt,Js+=4):(n=nt,0===ao&&a(zt)),n!==nt&&(_=He())!==nt&&(s=I())!==nt&&(o=Ye())!==nt&&(i=Ke())!==nt?e=r=Yt(s):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,6)===Ht?(n=Ht,Js+=6):(n=nt,0===ao&&a(Wt)),n!==nt&&(_=He())!==nt&&(s=Z())!==nt&&(o=He())!==nt&&(i=I())!==nt&&(l=Ye())!==nt&&Ke()!==nt?e=r=qt(s,i):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,5)===Vt?(n=Vt,Js+=5):(n=nt,0===ao&&a(Xt)),n!==nt&&(_=He())!==nt&&(s=Z())!==nt&&(o=Ye())!==nt&&(i=Ke())!==nt?e=r=Kt(s):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,7)===Zt?(n=Zt,Js+=7):(n=nt,0===ao&&a(Qt)),n!==nt?(_=Js,(s=He())!==nt&&(o=I())!==nt?_=s=[s,o]:(Js=_,_=nt),_===nt&&(_=null),_!==nt&&(s=Ye())!==nt&&(o=Ke())!==nt?e=r=Jt(_):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,9)===$t?(n=$t,Js+=9):(n=nt,0===ao&&a(er)),n!==nt?(_=Js,(s=He())!==nt&&(o=I())!==nt?_=s=[s,o]:(Js=_,_=nt),_===nt&&(_=null),_!==nt&&(s=Ye())!==nt&&(o=Ke())!==nt?e=r=tr(_):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,7)===rr?(n=rr,Js+=7):(n=nt,0===ao&&a(ar)),n!==nt&&(_=He())!==nt&&(s=fe())!==nt&&(o=Ye())!==nt&&(i=Ke())!==nt?e=r=nr(s):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt&&(n=Ke())!==nt?e=r=_r():(Js=e,e=nt)))))))))),e}function m(){var e,t;return e=Js,(t=p())!==nt&&We()!==nt&&h()!==nt?e=t=sr(t):(Js=e,e=nt),e===nt&&(e=k())===nt&&(e=N()),e}function p(){var e,r,n,_,s,o,i,l,c,u;if(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt)if(Ye()!==nt)if(t.substr(Js,4)===or?(n=or,Js+=4):(n=nt,0===ao&&a(ir)),n!==nt)if(He()!==nt)if((_=Z())!==nt)if(Ye()!==nt)if(Xe()!==nt)if(We()!==nt){for(s=[],o=Js,(i=v())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);o!==nt;)s.push(o),o=Js,(i=v())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);if(s!==nt){for(o=[],i=Js,(l=b())!==nt&&(c=We())!==nt?i=l=[l,c]:(Js=i,i=nt);i!==nt;)o.push(i),i=Js,(l=b())!==nt&&(c=We())!==nt?i=l=[l,c]:(Js=i,i=nt);if(o!==nt){for(i=[],l=Js,(c=g())!==nt&&(u=We())!==nt?l=c=[c,u]:(Js=l,l=nt);l!==nt;)i.push(l),l=Js,(c=g())!==nt&&(u=We())!==nt?l=c=[c,u]:(Js=l,l=nt);i!==nt?e=r=lr(_,s,o,i):(Js=e,e=nt)}else Js=e,e=nt}else Js=e,e=nt}else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;return e}function h(){var e,r,n,_,s,o;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&(n=Ye())!==nt?(t.substr(Js,7)===cr?(_=cr,Js+=7):(_=nt,0===ao&&a(ur)),_!==nt&&(s=Ye())!==nt?((o=Ke())===nt&&(o=null),o!==nt?e=r=[r,n,_,s,o]:(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e}function v(){var e,r,n,_,s,o,i;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,8)===dr?(n=dr,Js+=8):(n=nt,0===ao&&a(fr)),n!==nt&&He()!==nt&&(_=Z())!==nt?(s=Js,(o=He())!==nt&&(i=I())!==nt?s=o=[o,i]:(Js=s,s=nt),s===nt&&(s=null),s!==nt&&(o=Ye())!==nt&&(i=Xe())!==nt?e=r=mr(_,s):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e}function b(){var e;return(e=x())===nt&&(e=O())===nt&&(e=R()),e}function g(){var e;return(e=y())===nt&&(e=M()),e}function y(){var e,t,r,a,n;if(e=Js,(t=E())!==nt)if(We()!==nt){for(r=[],a=w();a!==nt;)r.push(a),a=w();r!==nt&&(a=We())!==nt?((n=A())===nt&&(n=null),n!==nt&&We()!==nt&&T()!==nt?e=t=pr(t,r,n):(Js=e,e=nt)):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;return e}function E(){var e,r,n,_,s,o,i,l;if(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt)if(Ye()!==nt)if(t.substr(Js,7)===hr?(n=hr,Js+=7):(n=nt,0===ao&&a(vr)),n!==nt)if(He()!==nt)if((_=S())!==nt)if(Ye()!==nt)if(Xe()!==nt)if(We()!==nt){for(s=[],o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);o!==nt;)s.push(o),o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);s!==nt?e=r=br(_,s):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;if(e===nt){if(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt)if(Ye()!==nt)if(t.substr(Js,10)===gr?(n=gr,Js+=10):(n=nt,0===ao&&a(yr)),n!==nt)if(He()!==nt)if((_=Z())!==nt)if(Ye()!==nt)if(Xe()!==nt)if(We()!==nt){for(s=[],o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);o!==nt;)s.push(o),o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);s!==nt?e=r=Er(_,s):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;if(e===nt)if(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt)if(Ye()!==nt)if(t.substr(Js,11)===wr?(n=wr,Js+=11):(n=nt,0===ao&&a(Ar)),n!==nt)if(He()!==nt)if((_=Z())!==nt)if(Ye()!==nt)if(Xe()!==nt)if(We()!==nt){for(s=[],o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);o!==nt;)s.push(o),o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);s!==nt?e=r=Tr(_,s):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt}return e}function w(){var e,r,n,_,s,o,i,l;if(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt)if(Ye()!==nt)if(t.substr(Js,9)===xr?(n=xr,Js+=9):(n=nt,0===ao&&a(Or)),n!==nt)if(He()!==nt)if((_=S())!==nt)if(Ye()!==nt)if(Xe()!==nt)if(We()!==nt){for(s=[],o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);o!==nt;)s.push(o),o=Js,(i=g())!==nt&&(l=We())!==nt?o=i=[i,l]:(Js=o,o=nt);s!==nt&&(o=We())!==nt?e=r=Rr(_,s):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;return e}function A(){var e,r,n,_,s,o,i;if(e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt)if(Ye()!==nt)if(t.substr(Js,9)===kr?(n=kr,Js+=9):(n=nt,0===ao&&a(Nr)),n!==nt)if(Ye()!==nt)if(Xe()!==nt)if(We()!==nt){for(_=[],s=Js,(o=g())!==nt&&(i=We())!==nt?s=o=[o,i]:(Js=s,s=nt);s!==nt;)_.push(s),s=Js,(o=g())!==nt&&(i=We())!==nt?s=o=[o,i]:(Js=s,s=nt);_!==nt?e=r=Mr(_):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;else Js=e,e=nt;return e}function T(){var e,r,n,_,s,o;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&(n=Ye())!==nt?(t.substr(Js,10)===Ir?(_=Ir,Js+=10):(_=nt,0===ao&&a(Sr)),_!==nt&&(s=Ye())!==nt&&(o=Ke())!==nt?e=r=[r,n,_,s,o]:(Js=e,e=nt)):(Js=e,e=nt),e}function x(){var e,r,n,_,s,o,i;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,7)===Lr?(n=Lr,Js+=7):(n=nt,0===ao&&a(Cr)),n!==nt?(_=Js,(s=He())!==nt?(t.substr(Js,8)===Pr?(o=Pr,Js+=8):(o=nt,0===ao&&a(Dr)),o!==nt?_=s=[s,o]:(Js=_,_=nt)):(Js=_,_=nt),_===nt&&(_=null),_!==nt?(s=Js,(o=He())!==nt&&(i=I())!==nt?s=o=[o,i]:(Js=s,s=nt),s===nt&&(s=null),s!==nt&&(o=Ye())!==nt&&(i=Xe())!==nt?e=r=Ur(_,s):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e}function O(){var e,r,n,_,s,o,i;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,8)===Fr?(n=Fr,Js+=8):(n=nt,0===ao&&a(Br)),n!==nt?(_=Js,(s=He())!==nt?(t.substr(Js,8)===Pr?(o=Pr,Js+=8):(o=nt,0===ao&&a(Dr)),o!==nt?_=s=[s,o]:(Js=_,_=nt)):(Js=_,_=nt),_===nt&&(_=null),_!==nt?(s=Js,(o=He())!==nt&&(i=I())!==nt?s=o=[o,i]:(Js=s,s=nt),s===nt&&(s=null),s!==nt&&(o=Ye())!==nt&&(i=Xe())!==nt?e=r=Gr(_,s):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e}function R(){var e,r,n,_,s,o,i;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,10)===jr?(n=jr,Js+=10):(n=nt,0===ao&&a(zr)),n!==nt?(_=Js,(s=He())!==nt?(t.substr(Js,8)===Pr?(o=Pr,Js+=8):(o=nt,0===ao&&a(Dr)),o!==nt?_=s=[s,o]:(Js=_,_=nt)):(Js=_,_=nt),_===nt&&(_=null),_!==nt?(s=Js,(o=He())!==nt&&(i=I())!==nt?s=o=[o,i]:(Js=s,s=nt),s===nt&&(s=null),s!==nt&&(o=Ye())!==nt&&(i=Xe())!==nt?e=r=Yr(_,s):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e}function k(){var e,r,n;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,12)===Hr?(n=Hr,Js+=12):(n=nt,0===ao&&a(Wr)),n!==nt&&Ye()!==nt&&Ke()!==nt?e=r=qr():(Js=e,e=nt)):(Js=e,e=nt),e}function N(){var e,r,n;return e=Js,35===t.charCodeAt(Js)?(r=ut,Js++):(r=nt,0===ao&&a(dt)),r!==nt&&Ye()!==nt?(t.substr(Js,10)===Vr?(n=Vr,Js+=10):(n=nt,0===ao&&a(Xr)),n!==nt&&Ye()!==nt&&Ke()!==nt?e=r=Kr():(Js=e,e=nt)):(Js=e,e=nt),e}function M(){var e;return(e=I())!==nt&&(e=Zr(e)),e}function I(){var e,t,r,a,n,_;if(e=Js,(t=fe())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=fe())!==nt?a=n=[n,_]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=fe())!==nt?a=n=[n,_]:(Js=a,a=nt);r!==nt?e=t=lt(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function S(){var e,r,n,_,s,o,i,l;if(e=Js,(r=L())!==nt){for(n=[],_=Js,(s=Ye())!==nt?(44===t.charCodeAt(Js)?(o=Qr,Js++):(o=nt,0===ao&&a(Jr)),o!==nt&&(i=Ye())!==nt&&(l=L())!==nt?_=s=[s,o,i,l]:(Js=_,_=nt)):(Js=_,_=nt);_!==nt;)n.push(_),_=Js,(s=Ye())!==nt?(44===t.charCodeAt(Js)?(o=Qr,Js++):(o=nt,0===ao&&a(Jr)),o!==nt&&(i=Ye())!==nt&&(l=L())!==nt?_=s=[s,o,i,l]:(Js=_,_=nt)):(Js=_,_=nt);n!==nt?e=r=$r(r,n):(Js=e,e=nt)}else Js=e,e=nt;return e}function L(){var e,r,n,_,s,o;return e=Js,(r=C())!==nt&&Ye()!==nt?(63===t.charCodeAt(Js)?(n=ea,Js++):(n=nt,0===ao&&a(ta)),n!==nt&&Ye()!==nt&&(_=S())!==nt&&Ye()!==nt?(58===t.charCodeAt(Js)?(s=ra,Js++):(s=nt,0===ao&&a(aa)),s!==nt&&Ye()!==nt&&(o=S())!==nt?e=r=na(r,_,o):(Js=e,e=nt)):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=C()),e}function C(){var e,t,r,a,n,_,s,o;if(e=Js,(t=P())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=le())!==nt&&(s=Ye())!==nt&&(o=P())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=le())!==nt&&(s=Ye())!==nt&&(o=P())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=_a(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function P(){var e,t,r,a,n,_,s,o;if(e=Js,(t=D())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=ie())!==nt&&(s=Ye())!==nt&&(o=D())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=ie())!==nt&&(s=Ye())!==nt&&(o=D())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=sa(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function D(){var e,t,r,a,n,_,s,o;if(e=Js,(t=U())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=oe())!==nt&&(s=Ye())!==nt&&(o=U())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=oe())!==nt&&(s=Ye())!==nt&&(o=U())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=oa(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function U(){var e,t,r,a,n,_,s,o;if(e=Js,(t=F())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=se())!==nt&&(s=Ye())!==nt&&(o=F())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=se())!==nt&&(s=Ye())!==nt&&(o=F())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=ia(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function F(){var e,t,r,a,n,_,s,o;if(e=Js,(t=B())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=_e())!==nt&&(s=Ye())!==nt&&(o=B())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=_e())!==nt&&(s=Ye())!==nt&&(o=B())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=la(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function B(){var e,t,r,a,n,_,s,o;if(e=Js,(t=G())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=ne())!==nt&&(s=Ye())!==nt&&(o=G())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=ne())!==nt&&(s=Ye())!==nt&&(o=G())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=ca(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function G(){var e,t,r,a,n,_,s,o;if(e=Js,(t=j())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=ae())!==nt&&(s=Ye())!==nt&&(o=j())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=ae())!==nt&&(s=Ye())!==nt&&(o=j())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=ua(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function j(){var e,t,r,a,n,_,s,o;if(e=Js,(t=z())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=re())!==nt&&(s=Ye())!==nt&&(o=z())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=re())!==nt&&(s=Ye())!==nt&&(o=z())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=da(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function z(){var e,t,r,a,n,_,s,o;if(e=Js,(t=Y())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=te())!==nt&&(s=Ye())!==nt&&(o=Y())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=te())!==nt&&(s=Ye())!==nt&&(o=Y())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=fa(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function Y(){var e,t,r,a,n,_,s,o;if(e=Js,(t=H())!==nt){for(r=[],a=Js,(n=Ye())!==nt&&(_=ee())!==nt&&(s=Ye())!==nt&&(o=H())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);a!==nt;)r.push(a),a=Js,(n=Ye())!==nt&&(_=ee())!==nt&&(s=Ye())!==nt&&(o=H())!==nt?a=n=[n,_,s,o]:(Js=a,a=nt);r!==nt?e=t=ma(t,r):(Js=e,e=nt)}else Js=e,e=nt;return e}function H(){var e,r,n;return e=Js,t.substr(Js,7)===pa?(r=pa,Js+=7):(r=nt,0===ao&&a(ha)),r!==nt&&Ye()!==nt&&(n=V())!==nt?e=r=va(n):(Js=e,e=nt),e===nt&&(e=W())===nt&&(e=Js,(r=$())!==nt&&Ye()!==nt&&(n=H())!==nt?e=r=ba(r,n):(Js=e,e=nt)),e}function W(){var e,t,r;return e=Js,(t=q())!==nt&&Ye()!==nt&&(r=J())!==nt?e=t=ga(t,r):(Js=e,e=nt),e===nt&&(e=q()),e}function q(){var e,r,n,_;return e=Js,(r=X())!==nt&&(r=ya(r)),(e=r)===nt&&(e=Js,(r=Z())!==nt&&(r=Ea(r)),(e=r)===nt&&(e=Js,40===t.charCodeAt(Js)?(r=wa,Js++):(r=nt,0===ao&&a(Aa)),r!==nt&&Ye()!==nt&&(n=S())!==nt&&Ye()!==nt?(41===t.charCodeAt(Js)?(_=Ta,Js++):(_=nt,0===ao&&a(xa)),_!==nt?e=r=Oa(n):(Js=e,e=nt)):(Js=e,e=nt))),e}function V(){var e,r,n,_,s,o;if(e=Js,(r=Z())!==nt&&(r=Ea(r)),(e=r)===nt){if(e=Js,r=[],n=Js,_=Js,ao++,40===t.charCodeAt(Js)?(s=wa,Js++):(s=nt,0===ao&&a(Aa)),s===nt&&(41===t.charCodeAt(Js)?(s=Ta,Js++):(s=nt,0===ao&&a(xa))),ao--,s===nt?_=void 0:(Js=_,_=nt),_!==nt&&(s=et())!==nt?n=_=[_,s]:(Js=n,n=nt),n!==nt)for(;n!==nt;)r.push(n),n=Js,_=Js,ao++,40===t.charCodeAt(Js)?(s=wa,Js++):(s=nt,0===ao&&a(Aa)),s===nt&&(41===t.charCodeAt(Js)?(s=Ta,Js++):(s=nt,0===ao&&a(xa))),ao--,s===nt?_=void 0:(Js=_,_=nt),_!==nt&&(s=et())!==nt?n=_=[_,s]:(Js=n,n=nt);else r=nt;r!==nt&&(r=Ra()),(e=r)===nt&&(e=Js,40===t.charCodeAt(Js)?(r=wa,Js++):(r=nt,0===ao&&a(Aa)),r!==nt&&(n=Ye())!==nt&&(_=V())!==nt&&(s=Ye())!==nt?(41===t.charCodeAt(Js)?(o=Ta,Js++):(o=nt,0===ao&&a(xa)),o!==nt?e=r=Oa(_):(Js=e,e=nt)):(Js=e,e=nt))}return e}function X(){var e,t;return ao++,e=Js,(t=Ee())===nt&&(t=K()),t!==nt&&(t=Na(t)),e=t,ao--,e===nt&&(t=nt,0===ao&&a(ka)),e}function K(){var e,r;return e=Js,r=we(),(e=r!==nt?t.substring(e,Js):r)!==nt&&(e=Ma(e)),e}function Z(){var e,t,r;return ao++,e=Js,t=Js,ao++,r=Q(),ao--,r===nt?t=void 0:(Js=t,t=nt),t!==nt&&(r=me())!==nt?e=t=Sa(r):(Js=e,e=nt),ao--,e===nt&&(t=nt,0===ao&&a(Ia)),e}function Q(){var e,r,n,_;return e=Js,t.substr(Js,7)===pa?(r=pa,Js+=7):(r=nt,0===ao&&a(ha)),r!==nt?(n=Js,ao++,_=he(),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=[r,n]:(Js=e,e=nt)):(Js=e,e=nt),e}function J(){var e;return t.substr(Js,2)===La?(e=La,Js+=2):(e=nt,0===ao&&a(Ca)),e===nt&&(t.substr(Js,2)===Pa?(e=Pa,Js+=2):(e=nt,0===ao&&a(Da))),e}function $(){var e;return t.substr(Js,2)===La?(e=La,Js+=2):(e=nt,0===ao&&a(Ca)),e===nt&&(t.substr(Js,2)===Pa?(e=Pa,Js+=2):(e=nt,0===ao&&a(Da)),e===nt&&(43===t.charCodeAt(Js)?(e=Ua,Js++):(e=nt,0===ao&&a(Fa)),e===nt&&(45===t.charCodeAt(Js)?(e=Ba,Js++):(e=nt,0===ao&&a(Ga)),e===nt&&(126===t.charCodeAt(Js)?(e=ja,Js++):(e=nt,0===ao&&a(za)),e===nt&&(33===t.charCodeAt(Js)?(e=Ya,Js++):(e=nt,0===ao&&a(Ha))))))),e}function ee(){var e,r,n,_;return e=Js,42===t.charCodeAt(Js)?(r=Wa,Js++):(r=nt,0===ao&&a(qa)),r===nt&&(47===t.charCodeAt(Js)?(r=Va,Js++):(r=nt,0===ao&&a(Xa)),r===nt&&(37===t.charCodeAt(Js)?(r=Ka,Js++):(r=nt,0===ao&&a(Za)))),r!==nt?(n=Js,ao++,61===t.charCodeAt(Js)?(_=Qa,Js++):(_=nt,0===ao&&a(Ja)),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=$a(r):(Js=e,e=nt)):(Js=e,e=nt),e}function te(){var e,r,n,_;return e=Js,43===t.charCodeAt(Js)?(r=Ua,Js++):(r=nt,0===ao&&a(Fa)),r!==nt?(n=Js,ao++,43===t.charCodeAt(Js)?(_=Ua,Js++):(_=nt,0===ao&&a(Fa)),_===nt&&(61===t.charCodeAt(Js)?(_=Qa,Js++):(_=nt,0===ao&&a(Ja))),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=en():(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,45===t.charCodeAt(Js)?(r=Ba,Js++):(r=nt,0===ao&&a(Ga)),r!==nt?(n=Js,ao++,45===t.charCodeAt(Js)?(_=Ba,Js++):(_=nt,0===ao&&a(Ga)),_===nt&&(61===t.charCodeAt(Js)?(_=Qa,Js++):(_=nt,0===ao&&a(Ja))),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=tn():(Js=e,e=nt)):(Js=e,e=nt)),e}function re(){var e;return t.substr(Js,2)===rn?(e=rn,Js+=2):(e=nt,0===ao&&a(an)),e===nt&&(t.substr(Js,2)===nn?(e=nn,Js+=2):(e=nt,0===ao&&a(_n))),e}function ae(){var e;return t.substr(Js,2)===sn?(e=sn,Js+=2):(e=nt,0===ao&&a(on)),e===nt&&(t.substr(Js,2)===ln?(e=ln,Js+=2):(e=nt,0===ao&&a(cn)),e===nt&&(60===t.charCodeAt(Js)?(e=un,Js++):(e=nt,0===ao&&a(dn)),e===nt&&(62===t.charCodeAt(Js)?(e=fn,Js++):(e=nt,0===ao&&a(mn))))),e}function ne(){var e;return t.substr(Js,2)===pn?(e=pn,Js+=2):(e=nt,0===ao&&a(hn)),e===nt&&(t.substr(Js,2)===vn?(e=vn,Js+=2):(e=nt,0===ao&&a(bn))),e}function _e(){var e,r,n,_;return e=Js,38===t.charCodeAt(Js)?(r=gn,Js++):(r=nt,0===ao&&a(yn)),r!==nt?(n=Js,ao++,38===t.charCodeAt(Js)?(_=gn,Js++):(_=nt,0===ao&&a(yn)),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=En():(Js=e,e=nt)):(Js=e,e=nt),e}function se(){var e,r,n,_;return e=Js,94===t.charCodeAt(Js)?(r=wn,Js++):(r=nt,0===ao&&a(An)),r!==nt?(n=Js,ao++,94===t.charCodeAt(Js)?(_=wn,Js++):(_=nt,0===ao&&a(An)),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=Tn():(Js=e,e=nt)):(Js=e,e=nt),e}function oe(){var e,r,n,_;return e=Js,124===t.charCodeAt(Js)?(r=xn,Js++):(r=nt,0===ao&&a(On)),r!==nt?(n=Js,ao++,124===t.charCodeAt(Js)?(_=xn,Js++):(_=nt,0===ao&&a(On)),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=Rn():(Js=e,e=nt)):(Js=e,e=nt),e}function ie(){var e;return t.substr(Js,2)===kn?(e=kn,Js+=2):(e=nt,0===ao&&a(Nn)),e!==nt&&(e=Mn()),e}function le(){var e;return t.substr(Js,2)===In?(e=In,Js+=2):(e=nt,0===ao&&a(Sn)),e!==nt&&(e=Ln()),e}function ce(){var e,r,n,_;return e=Js,60===t.charCodeAt(Js)?(r=un,Js++):(r=nt,0===ao&&a(dn)),r!==nt&&Ye()!==nt&&(n=ue())!==nt&&Ye()!==nt?(62===t.charCodeAt(Js)?(_=fn,Js++):(_=nt,0===ao&&a(mn)),_!==nt?e=r=Sa(n):(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=Js,34===t.charCodeAt(Js)?(r=Cn,Js++):(r=nt,0===ao&&a(Pn)),r!==nt&&Ye()!==nt&&(n=de())!==nt&&Ye()!==nt?(34===t.charCodeAt(Js)?(_=Cn,Js++):(_=nt,0===ao&&a(Pn)),_!==nt?e=r=Sa(n):(Js=e,e=nt)):(Js=e,e=nt)),e}function ue(){var e,r,n,_;for(e=[],r=Js,n=Js,ao++,(_=Ke())===nt&&(62===t.charCodeAt(Js)?(_=fn,Js++):(_=nt,0===ao&&a(mn))),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt&&(_=et())!==nt?r=n=[n,_]:(Js=r,r=nt);r!==nt;)e.push(r),r=Js,n=Js,ao++,(_=Ke())===nt&&(62===t.charCodeAt(Js)?(_=fn,Js++):(_=nt,0===ao&&a(mn))),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt&&(_=et())!==nt?r=n=[n,_]:(Js=r,r=nt);return e!==nt&&(e=Dn(e)),e}function de(){var e,r,n,_;for(e=[],r=Js,n=Js,ao++,(_=Ke())===nt&&(34===t.charCodeAt(Js)?(_=Cn,Js++):(_=nt,0===ao&&a(Pn))),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt&&(_=et())!==nt?r=n=[n,_]:(Js=r,r=nt);r!==nt;)e.push(r),r=Js,n=Js,ao++,(_=Ke())===nt&&(34===t.charCodeAt(Js)?(_=Cn,Js++):(_=nt,0===ao&&a(Pn))),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt&&(_=et())!==nt?r=n=[n,_]:(Js=r,r=nt);return e!==nt&&(e=Dn(e)),e}function fe(){var e;return(e=Z())===nt&&(e=ge())===nt&&(e=Me())===nt&&(e=ze()),e}function Z(){var e,t,r;return ao++,e=Js,t=Js,ao++,r=be(),ao--,r===nt?t=void 0:(Js=t,t=nt),t!==nt&&(r=me())!==nt?e=t=Sa(r):(Js=e,e=nt),ao--,e===nt&&(t=nt,0===ao&&a(Ia)),e}function me(){var e,t,r,n;if(ao++,e=Js,(t=pe())!==nt){for(r=[],n=he();n!==nt;)r.push(n),n=he();r!==nt?e=t=Un(t,r):(Js=e,e=nt)}else Js=e,e=nt;return ao--,e===nt&&(t=nt,0===ao&&a(Ia)),e}function pe(){var e;return(e=ve())===nt&&(36===t.charCodeAt(Js)?(e=Fn,Js++):(e=nt,0===ao&&a(Bn)),e===nt&&(95===t.charCodeAt(Js)?(e=Gn,Js++):(e=nt,0===ao&&a(jn)))),e}function he(){var e;return(e=pe())===nt&&(e=Te()),e}function ve(){var e;return zn.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(Yn)),e}function be(){var e,r,n,_;return e=Js,t.substr(Js,7)===Hn?(r=Hn,Js+=7):(r=nt,0===ao&&a(Wn)),r===nt&&(t.substr(Js,5)===qn?(r=qn,Js+=5):(r=nt,0===ao&&a(Vn)),r===nt&&(t.substr(Js,5)===Xn?(r=Xn,Js+=5):(r=nt,0===ao&&a(Kn)),r===nt&&(t.substr(Js,6)===Zn?(r=Zn,Js+=6):(r=nt,0===ao&&a(Qn)),r===nt&&(t.substr(Js,6)===Jn?(r=Jn,Js+=6):(r=nt,0===ao&&a($n)),r===nt&&(t.substr(Js,3)===e_?(r=e_,Js+=3):(r=nt,0===ao&&a(t_)),r===nt&&(t.substr(Js,6)===r_?(r=r_,Js+=6):(r=nt,0===ao&&a(a_)),r===nt&&(t.substr(Js,7)===n_?(r=n_,Js+=7):(r=nt,0===ao&&a(__)),r===nt&&(t.substr(Js,8)===s_?(r=s_,Js+=8):(r=nt,0===ao&&a(o_)),r===nt&&(t.substr(Js,5)===i_?(r=i_,Js+=5):(r=nt,0===ao&&a(l_)),r===nt&&(t.substr(Js,7)===c_?(r=c_,Js+=7):(r=nt,0===ao&&a(u_)),r===nt&&(t.substr(Js,8)===d_?(r=d_,Js+=8):(r=nt,0===ao&&a(f_)),r===nt&&(t.substr(Js,8)===m_?(r=m_,Js+=8):(r=nt,0===ao&&a(p_)),r===nt&&(t.substr(Js,3)===Pt?(r=Pt,Js+=3):(r=nt,0===ao&&a(Dt))))))))))))))),r!==nt?(n=Js,ao++,_=he(),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=[r,n]:(Js=e,e=nt)):(Js=e,e=nt),e}function ge(){var e,t,r,n;return ao++,e=Js,(t=Ee())===nt&&(t=ye()),t!==nt?(r=Js,ao++,n=pe(),ao--,n===nt?r=void 0:(Js=r,r=nt),r!==nt?e=t=Na(t):(Js=e,e=nt)):(Js=e,e=nt),ao--,e===nt&&(t=nt,0===ao&&a(ka)),e}function ye(){var e,r,n,_,s,o,i;return e=Js,r=Js,n=Js,(_=we())!==nt?(46===t.charCodeAt(Js)?(s=h_,Js++):(s=nt,0===ao&&a(v_)),s!==nt?((o=Ae())===nt&&(o=null),o!==nt?((i=Oe())===nt&&(i=null),i!==nt?n=_=[_,s,o,i]:(Js=n,n=nt)):(Js=n,n=nt)):(Js=n,n=nt)):(Js=n,n=nt),(r=n!==nt?t.substring(r,Js):n)!==nt&&(r=w_(r)),(e=r)===nt&&(e=Js,r=Js,n=Js,46===t.charCodeAt(Js)?(_=h_,Js++):(_=nt,0===ao&&a(v_)),_!==nt&&(s=Ae())!==nt?((o=Oe())===nt&&(o=null),o!==nt?n=_=[_,s,o]:(Js=n,n=nt)):(Js=n,n=nt),(r=n!==nt?t.substring(r,Js):n)!==nt&&(r=A_(r)),(e=r)===nt&&(e=Js,r=Js,n=Js,(_=we())!==nt?((s=Oe())===nt&&(s=null),s!==nt?n=_=[_,s]:(Js=n,n=nt)):(Js=n,n=nt),(r=n!==nt?t.substring(r,Js):n)!==nt&&(r=A_(r)),e=r)),e}function Ee(){var e,r,n,_,s,o;if(e=Js,48===t.charCodeAt(Js)?(r=b_,Js++):(r=nt,0===ao&&a(g_)),r!==nt)if(y_.test(t.charAt(Js))?(n=t.charAt(Js),Js++):(n=nt,0===ao&&a(E_)),n!==nt){if(_=Js,s=[],(o=Ne())!==nt)for(;o!==nt;)s.push(o),o=Ne();else s=nt;(_=s!==nt?t.substring(_,Js):s)!==nt?e=r=T_(_):(Js=e,e=nt)}else Js=e,e=nt;else Js=e,e=nt;return e}function we(){var e,r,n;return 48===t.charCodeAt(Js)?(e=b_,Js++):(e=nt,0===ao&&a(g_)),e===nt&&(e=Js,(r=xe())!==nt?((n=Ae())===nt&&(n=null),n!==nt?e=r=[r,n]:(Js=e,e=nt)):(Js=e,e=nt)),e}function Ae(){var e,t;if(e=[],(t=Te())!==nt)for(;t!==nt;)e.push(t),t=Te();else e=nt;return e}function Te(){var e;return x_.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(O_)),e}function xe(){var e;return R_.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(k_)),e}function Oe(){var e,t,r;return e=Js,(t=Re())!==nt&&(r=ke())!==nt?e=t=[t,r]:(Js=e,e=nt),e}function Re(){var e;return N_.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(M_)),e}function ke(){var e,r,n;return e=Js,I_.test(t.charAt(Js))?(r=t.charAt(Js),Js++):(r=nt,0===ao&&a(S_)),r===nt&&(r=null),r!==nt&&(n=Ae())!==nt?e=r=[r,n]:(Js=e,e=nt),e}function Ne(){var e;return L_.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(C_)),e}function Me(){var e,r,n,_,s;return ao++,e=Js,r=Js,34===t.charCodeAt(Js)?(n=Cn,Js++):(n=nt,0===ao&&a(Pn)),n!==nt?((_=Ie())===nt&&(_=null),_!==nt?(34===t.charCodeAt(Js)?(s=Cn,Js++):(s=nt,0===ao&&a(Pn)),s!==nt?r=n=[n,_,s]:(Js=r,r=nt)):(Js=r,r=nt)):(Js=r,r=nt),r===nt&&(r=Js,39===t.charCodeAt(Js)?(n=D_,Js++):(n=nt,0===ao&&a(U_)),n!==nt?((_=Se())===nt&&(_=null),_!==nt?(39===t.charCodeAt(Js)?(s=D_,Js++):(s=nt,0===ao&&a(U_)),s!==nt?r=n=[n,_,s]:(Js=r,r=nt)):(Js=r,r=nt)):(Js=r,r=nt)),r!==nt&&(r=F_(r)),e=r,ao--,e===nt&&(r=nt,0===ao&&a(P_)),e}function Ie(){var e,t;if(e=[],(t=Le())!==nt)for(;t!==nt;)e.push(t),t=Le();else e=nt;return e!==nt&&(e=B_(e)),e}function Se(){var e,t;if(e=[],(t=Ce())!==nt)for(;t!==nt;)e.push(t),t=Ce();else e=nt;return e!==nt&&(e=B_(e)),e}function Le(){var e,r,n;return e=Js,r=Js,ao++,34===t.charCodeAt(Js)?(n=Cn,Js++):(n=nt,0===ao&&a(Pn)),n===nt&&(92===t.charCodeAt(Js)?(n=G_,Js++):(n=nt,0===ao&&a(j_)),n===nt&&(n=Ve())),ao--,n===nt?r=void 0:(Js=r,r=nt),r!==nt&&(n=et())!==nt?e=r=z_(n):(Js=e,e=nt),e===nt&&(e=Js,92===t.charCodeAt(Js)?(r=G_,Js++):(r=nt,0===ao&&a(j_)),r!==nt&&(n=De())!==nt?e=r=Y_(n):(Js=e,e=nt),e===nt&&(e=Pe())),e}function Ce(){var e,r,n;return e=Js,r=Js,ao++,39===t.charCodeAt(Js)?(n=D_,Js++):(n=nt,0===ao&&a(U_)),n===nt&&(92===t.charCodeAt(Js)?(n=G_,Js++):(n=nt,0===ao&&a(j_)),n===nt&&(n=Ve())),ao--,n===nt?r=void 0:(Js=r,r=nt),r!==nt&&(n=et())!==nt?e=r=z_(n):(Js=e,e=nt),e===nt&&(e=Js,92===t.charCodeAt(Js)?(r=G_,Js++):(r=nt,0===ao&&a(j_)),r!==nt&&(n=De())!==nt?e=r=Y_(n):(Js=e,e=nt),e===nt&&(e=Pe())),e}function Pe(){var e,r,n;return e=Js,92===t.charCodeAt(Js)?(r=G_,Js++):(r=nt,0===ao&&a(j_)),r!==nt&&(n=Ke())!==nt?e=r=H_(n):(Js=e,e=nt),e}function De(){var e,r,n,_;return(e=Ue())===nt&&(e=Js,48===t.charCodeAt(Js)?(r=b_,Js++):(r=nt,0===ao&&a(g_)),r!==nt?(n=Js,ao++,_=Te(),ao--,_===nt?n=void 0:(Js=n,n=nt),n!==nt?e=r=W_():(Js=e,e=nt)):(Js=e,e=nt),e===nt&&(e=je())),e}function Ue(){var e;return(e=Fe())===nt&&(e=Be()),e}function Fe(){var e;return q_.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(V_)),e!==nt&&(e=X_(e)),e}function Be(){var e,t,r;return e=Js,t=Js,ao++,r=Ge(),ao--,r===nt?t=void 0:(Js=t,t=nt),t===nt&&(t=Ve()),t!==nt&&(r=et())!==nt?e=t=K_(r):(Js=e,e=nt),e}function Ge(){var e;return(e=Fe())===nt&&(e=Te())===nt&&(120===t.charCodeAt(Js)?(e=Z_,Js++):(e=nt,0===ao&&a(Q_)),e===nt&&(117===t.charCodeAt(Js)?(e=J_,Js++):(e=nt,0===ao&&a($_)))),e}function je(){var e,r,n,_,s,o;return e=Js,120===t.charCodeAt(Js)?(r=Z_,Js++):(r=nt,0===ao&&a(Q_)),r!==nt?(n=Js,_=Js,(s=Ne())!==nt&&(o=Ne())!==nt?_=s=[s,o]:(Js=_,_=nt),(n=_!==nt?t.substring(n,Js):_)!==nt?e=r=es(n):(Js=e,e=nt)):(Js=e,e=nt),e}function ze(){var e;return ao++,t.substr(Js,2)===rs?(e=rs,Js+=2):(e=nt,0===ao&&a(as)),e===nt&&(t.substr(Js,2)===ns?(e=ns,Js+=2):(e=nt,0===ao&&a(_s)),e===nt&&(t.substr(Js,2)===ss?(e=ss,Js+=2):(e=nt,0===ao&&a(os)),e===nt&&(t.substr(Js,2)===is?(e=is,Js+=2):(e=nt,0===ao&&a(ls)),e===nt&&(t.substr(Js,2)===cs?(e=cs,Js+=2):(e=nt,0===ao&&a(us)),e===nt&&(t.substr(Js,2)===ds?(e=ds,Js+=2):(e=nt,0===ao&&a(fs)),e===nt&&(t.substr(Js,2)===ms?(e=ms,Js+=2):(e=nt,0===ao&&a(ps)),e===nt&&(t.substr(Js,2)===hs?(e=hs,Js+=2):(e=nt,0===ao&&a(vs)),e===nt&&(t.substr(Js,2)===rn?(e=rn,Js+=2):(e=nt,0===ao&&a(an)),e===nt&&(t.substr(Js,2)===nn?(e=nn,Js+=2):(e=nt,0===ao&&a(_n)),e===nt&&(t.substr(Js,3)===bs?(e=bs,Js+=3):(e=nt,0===ao&&a(gs)),e===nt&&(t.substr(Js,3)===ys?(e=ys,Js+=3):(e=nt,0===ao&&a(Es)),e===nt&&(t.substr(Js,2)===pn?(e=pn,Js+=2):(e=nt,0===ao&&a(hn)),e===nt&&(t.substr(Js,2)===vn?(e=vn,Js+=2):(e=nt,0===ao&&a(bn)),e===nt&&(t.substr(Js,2)===sn?(e=sn,Js+=2):(e=nt,0===ao&&a(on)),e===nt&&(t.substr(Js,2)===ln?(e=ln,Js+=2):(e=nt,0===ao&&a(cn)),e===nt&&(t.substr(Js,2)===kn?(e=kn,Js+=2):(e=nt,0===ao&&a(Nn)),e===nt&&(t.substr(Js,2)===In?(e=In,Js+=2):(e=nt,0===ao&&a(Sn)),e===nt&&(t.substr(Js,2)===La?(e=La,Js+=2):(e=nt,0===ao&&a(Ca)),e===nt&&(t.substr(Js,2)===Pa?(e=Pa,Js+=2):(e=nt,0===ao&&a(Da)),e===nt&&(123===t.charCodeAt(Js)?(e=ws,Js++):(e=nt,0===ao&&a(As)),e===nt&&(125===t.charCodeAt(Js)?(e=Ts,Js++):(e=nt,0===ao&&a(xs)),e===nt&&(91===t.charCodeAt(Js)?(e=Os,Js++):(e=nt,0===ao&&a(Rs)),e===nt&&(93===t.charCodeAt(Js)?(e=ks,Js++):(e=nt,0===ao&&a(Ns)),e===nt&&(40===t.charCodeAt(Js)?(e=wa,Js++):(e=nt,0===ao&&a(Aa)),e===nt&&(41===t.charCodeAt(Js)?(e=Ta,Js++):(e=nt,0===ao&&a(xa)),e===nt&&(59===t.charCodeAt(Js)?(e=Ms,Js++):(e=nt,0===ao&&a(Is)),e===nt&&(58===t.charCodeAt(Js)?(e=ra,Js++):(e=nt,0===ao&&a(aa)),e===nt&&(63===t.charCodeAt(Js)?(e=ea,Js++):(e=nt,0===ao&&a(ta)),e===nt&&(46===t.charCodeAt(Js)?(e=h_,Js++):(e=nt,0===ao&&a(v_)),e===nt&&(43===t.charCodeAt(Js)?(e=Ua,Js++):(e=nt,0===ao&&a(Fa)),e===nt&&(45===t.charCodeAt(Js)?(e=Ba,Js++):(e=nt,0===ao&&a(Ga)),e===nt&&(42===t.charCodeAt(Js)?(e=Wa,Js++):(e=nt,0===ao&&a(qa)),e===nt&&(47===t.charCodeAt(Js)?(e=Va,Js++):(e=nt,0===ao&&a(Xa)),e===nt&&(37===t.charCodeAt(Js)?(e=Ka,Js++):(e=nt,0===ao&&a(Za)),e===nt&&(94===t.charCodeAt(Js)?(e=wn,Js++):(e=nt,0===ao&&a(An)),e===nt&&(38===t.charCodeAt(Js)?(e=gn,Js++):(e=nt,0===ao&&a(yn)),e===nt&&(124===t.charCodeAt(Js)?(e=xn,Js++):(e=nt,0===ao&&a(On)),e===nt&&(126===t.charCodeAt(Js)?(e=ja,Js++):(e=nt,0===ao&&a(za)),e===nt&&(33===t.charCodeAt(Js)?(e=Ya,Js++):(e=nt,0===ao&&a(Ha)),e===nt&&(61===t.charCodeAt(Js)?(e=Qa,Js++):(e=nt,0===ao&&a(Ja)),e===nt&&(60===t.charCodeAt(Js)?(e=un,Js++):(e=nt,0===ao&&a(dn)),e===nt&&(62===t.charCodeAt(Js)?(e=fn,Js++):(e=nt,0===ao&&a(mn)),e===nt&&(44===t.charCodeAt(Js)?(e=Qr,Js++):(e=nt,0===ao&&a(Jr))))))))))))))))))))))))))))))))))))))))))))),ao--,e===nt&&0===ao&&a(ts),e}function Ye(){var e,t;for(e=[],(t=qe())===nt&&(t=Pe())===nt&&(t=Je())===nt&&(t=$e());t!==nt;)e.push(t),(t=qe())===nt&&(t=Pe())===nt&&(t=Je())===nt&&(t=$e());return e}function He(){var e,t;if(e=[],(t=qe())===nt&&(t=Pe())===nt&&(t=Je())===nt&&(t=$e()),t!==nt)for(;t!==nt;)e.push(t),(t=qe())===nt&&(t=Pe())===nt&&(t=Je())===nt&&(t=$e());else e=nt;return e}function We(){var e,t;for(e=[],(t=qe())===nt&&(t=Pe())===nt&&(t=Xe())===nt&&(t=Ze());t!==nt;)e.push(t),(t=qe())===nt&&(t=Pe())===nt&&(t=Xe())===nt&&(t=Ze());return e}function qe(){var e;return ao++,Ls.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(Cs)),ao--,e===nt&&0===ao&&a(Ss),e}function Ve(){var e;return Ps.test(t.charAt(Js))?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(Ds)),e}function Xe(){var e;return ao++,10===t.charCodeAt(Js)?(e=Fs,Js++):(e=nt,0===ao&&a(Bs)),e===nt&&(t.substr(Js,2)===Gs?(e=Gs,Js+=2):(e=nt,0===ao&&a(js)),e===nt&&(13===t.charCodeAt(Js)?(e=zs,Js++):(e=nt,0===ao&&a(Ys)))),ao--,e===nt&&0===ao&&a(Us),e}function Ke(){var e;return(e=Xe())===nt&&(e=tt()),e}function Ze(){var e;return ao++,(e=Qe())===nt&&(e=$e()),ao--,e===nt&&0===ao&&a(Hs),e}function Qe(){var e,r,n,_,s,o;if(e=Js,t.substr(Js,2)===Ws?(r=Ws,Js+=2):(r=nt,0===ao&&a(qs)),r!==nt){for(n=[],_=Js,s=Js,ao++,t.substr(Js,2)===Vs?(o=Vs,Js+=2):(o=nt,0===ao&&a(Xs)),ao--,o===nt?s=void 0:(Js=s,s=nt),s!==nt&&(o=et())!==nt?_=s=[s,o]:(Js=_,_=nt);_!==nt;)n.push(_),_=Js,s=Js,ao++,t.substr(Js,2)===Vs?(o=Vs,Js+=2):(o=nt,0===ao&&a(Xs)),ao--,o===nt?s=void 0:(Js=s,s=nt),s!==nt&&(o=et())!==nt?_=s=[s,o]:(Js=_,_=nt);n!==nt?(t.substr(Js,2)===Vs?(_=Vs,Js+=2):(_=nt,0===ao&&a(Xs)),_!==nt?e=r=[r,n,_]:(Js=e,e=nt)):(Js=e,e=nt)}else Js=e,e=nt;return e}function Je(){var e,r,n,_,s,o;if(e=Js,t.substr(Js,2)===Ws?(r=Ws,Js+=2):(r=nt,0===ao&&a(qs)),r!==nt){for(n=[],_=Js,s=Js,ao++,t.substr(Js,2)===Vs?(o=Vs,Js+=2):(o=nt,0===ao&&a(Xs)),o===nt&&(o=Ve()),ao--,o===nt?s=void 0:(Js=s,s=nt),s!==nt&&(o=et())!==nt?_=s=[s,o]:(Js=_,_=nt);_!==nt;)n.push(_),_=Js,s=Js,ao++,t.substr(Js,2)===Vs?(o=Vs,Js+=2):(o=nt,0===ao&&a(Xs)),o===nt&&(o=Ve()),ao--,o===nt?s=void 0:(Js=s,s=nt),s!==nt&&(o=et())!==nt?_=s=[s,o]:(Js=_,_=nt);n!==nt?(t.substr(Js,2)===Vs?(_=Vs,Js+=2):(_=nt,0===ao&&a(Xs)),_!==nt?e=r=[r,n,_]:(Js=e,e=nt)):(Js=e,e=nt)}else Js=e,e=nt;return e}function $e(){var e,r,n,_,s,o;if(e=Js,t.substr(Js,2)===Ks?(r=Ks,Js+=2):(r=nt,0===ao&&a(Zs)),r!==nt){for(n=[],_=Js,s=Js,ao++,o=Ve(),ao--,o===nt?s=void 0:(Js=s,s=nt),s!==nt&&(o=et())!==nt?_=s=[s,o]:(Js=_,_=nt);_!==nt;)n.push(_),_=Js,s=Js,ao++,o=Ve(),ao--,o===nt?s=void 0:(Js=s,s=nt),s!==nt&&(o=et())!==nt?_=s=[s,o]:(Js=_,_=nt);n!==nt?e=r=[r,n]:(Js=e,e=nt)}else Js=e,e=nt;return e}function et(){var e;return t.length>Js?(e=t.charAt(Js),Js++):(e=nt,0===ao&&a(Qs)),e}function tt(){var e,r;return e=Js,ao++,t.length>Js?(r=t.charAt(Js),Js++):(r=nt,0===ao&&a(Qs)),ao--,r===nt?e=void 0:(Js=e,e=nt),e}var rt,at=arguments.length>1?arguments[1]:{},nt={},_t={start:n},st=n,ot=function(e){return e},it=function(e){return{TYPE:"grp",PARTS:null!==e?e:[]}},lt=function(e,t){for(var r=[e],a=0;a<t.length;a++)r.push(t[a][1]);return r},ct=function(e,t,r){for(var a=[e],n=0;n<t.length;n++)a.push(t[n]);return null!==r&&a.push(r),{TYPE:"cond",PARTS:a}},ut="#",dt={type:"literal",value:"#",description:'"#"'},ft="if",mt={type:"literal",value:"if",description:'"if"'},pt=function(e,t){return{TYPE:"if",EXPRESSION:e,GROUP:t}},ht="ifdef",vt={type:"literal",value:"ifdef",description:'"ifdef"'},bt=function(e,t){return{TYPE:"ifdef",NAME:e,GROUP:t}},gt="ifndef",yt={type:"literal",value:"ifndef",description:'"ifndef"'},Et=function(e,t){return{TYPE:"ifndef",NAME:e,GROUP:t}},wt="elif",At={type:"literal",value:"elif",description:'"elif"'},Tt=function(e,t){return{TYPE:"elif",EXPRESSION:e,GROUP:t}},xt="else",Ot={type:"literal",value:"else",description:'"else"'},Rt=function(e){return{TYPE:"else",GROUP:e}},kt="endif",Nt={type:"literal",value:"endif",description:'"endif"'},Mt="include",It={type:"literal",value:"include",description:'"include"'},St=function(e){return{TYPE:"include",FILE:e}},Lt="define",Ct={type:"literal",value:"define",description:'"define"'},Pt="var",Dt={type:"literal",value:"var",description:'"var"'},Ut=function(e,t,r){var a=[];if(null===r)a.push("");else for(var n=0;n<r[1].length;n++)a.push(r[1][n]);return{TYPE:e,NAME:t,TOKENS:a}},Ft="error",Bt={type:"literal",value:"error",description:'"error"'},Gt=function(e){var t=[];if(null!==e)for(var r=0;r<e[1].length;r++)t.push(e[1][r]);return{TYPE:"error",TOKENS:t}},jt="line",zt={type:"literal",value:"line",description:'"line"'},Yt=function(e){return{TYPE:"line",TOKENS:e}},Ht="pragma",Wt={type:"literal",value:"pragma",description:'"pragma"'},qt=function(e,t){return{TYPE:"pragma",NAME:e,TOKENS:t}},Vt="undef",Xt={type:"literal",value:"undef",description:'"undef"'},Kt=function(e){return{TYPE:"undef",NAME:e}},Zt="warning",Qt={type:"literal",value:"warning",description:'"warning"'},Jt=function(e){var t=[];if(null!==e)for(var r=0;r<e[1].length;r++)t.push(e[1][r]);return{TYPE:"warning",TOKENS:t}},$t="extension",er={type:"literal",value:"extension",description:'"extension"'},tr=function(e){var t=[];if(null!==e)for(var r=0;r<e[1].length;r++)t.push(e[1][r]);return{TYPE:"extension",TOKENS:t}},rr="version",ar={type:"literal",value:"version",description:'"version"'},nr=function(e){var t=[];return null!==e&&t.push(e),{TYPE:"version",TOKENS:t}},_r=function(){return{TYPE:"#"}},sr=function(e){return e},or="node",ir={type:"literal",value:"node",description:'"node"'},lr=function(e,t,r,a){for(var n=[],_=0;_<t.length;_++)n.push(t[_][0]);for(var s=[],_=0;_<r.length;_++)s.push(r[_][0]);for(var o=[],_=0;_<a.length;_++)o.push(a[_][0]);return{TYPE:"node",NAME:e,NODE_VARS:n,DECLARATIONS:s,STATEMENTS:o}},cr="endnode",ur={type:"literal",value:"endnode",description:'"endnode"'},dr="node_var",fr={type:"literal",value:"node_var",description:'"node_var"'},mr=function(e,t){var r=[];if(null===t)r.push("");else for(var a=0;a<t[1].length;a++)r.push(t[1][a]);return{TYPE:"node_var",NAME:e,TOKENS:r}},pr=function(e,t,r){for(var a=[e],n=0;n<t.length;n++)a.push(t[n]);return null!==r&&a.push(r),{TYPE:"node_cond",PARTS:a}},hr="node_if",vr={type:"literal",value:"node_if",description:'"node_if"'},br=function(e,t){for(var r=[],a=0;a<t.length;a++)r.push(t[a][0]);return{TYPE:"node_if",EXPRESSION:e,STATEMENTS:r}},gr="node_ifdef",yr={type:"literal",value:"node_ifdef",description:'"node_ifdef"'},Er=function(e,t){for(var r=[],a=0;a<t.length;a++)r.push(t[a][0]);return{TYPE:"node_ifdef",NAME:e,STATEMENTS:r}},wr="node_ifndef",Ar={type:"literal",value:"node_ifndef",description:'"node_ifndef"'},Tr=function(e,t){for(var r=[],a=0;a<t.length;a++)r.push(t[a][0]);return{TYPE:"node_ifndef",NAME:e,STATEMENTS:r}},xr="node_elif",Or={type:"literal",value:"node_elif",description:'"node_elif"'},Rr=function(e,t){for(var r=[],a=0;a<t.length;a++)r.push(t[a][0]);return{TYPE:"node_elif",EXPRESSION:e,STATEMENTS:r}},kr="node_else",Nr={type:"literal",value:"node_else",description:'"node_else"'},Mr=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r][0]);return{TYPE:"node_else",STATEMENTS:t}},Ir="node_endif",Sr={type:"literal",value:"node_endif",description:'"node_endif"'},Lr="node_in",Cr={type:"literal",value:"node_in",description:'"node_in"'},Pr="optional",Dr={type:"literal",value:"optional",description:'"optional"'},Ur=function(e,t){var r=[];if(null!==t)for(var a=0;a<t[1].length;a++)r.push(t[1][a]);return{TYPE:"node_in",NAME:r.pop(),QUALIFIER:r,IS_OPTIONAL:Boolean(e)}},Fr="node_out",Br={type:"literal",value:"node_out",description:'"node_out"'},Gr=function(e,t){var r=[];if(null!==t)for(var a=0;a<t[1].length;a++)r.push(t[1][a]);return{TYPE:"node_out",NAME:r.pop(),QUALIFIER:r,IS_OPTIONAL:Boolean(e)}},jr="node_param",zr={type:"literal",value:"node_param",description:'"node_param"'},Yr=function(e,t){var r=[];if(null!==t)for(var a=0;a<t[1].length;a++)r.push(t[1][a]);return{TYPE:"node_param",NAME:r.pop(),QUALIFIER:r,IS_OPTIONAL:Boolean(e)}},Hr="nodes_global",Wr={type:"literal",value:"nodes_global",description:'"nodes_global"'},qr=function(){return{TYPE:"nodes_global"}},Vr="nodes_main",Xr={type:"literal",value:"nodes_main",description:'"nodes_main"'},Kr=function(){return{TYPE:"nodes_main"}},Zr=function(e){return{TYPE:"txt",TOKENS:e}},Qr=",",Jr={type:"literal",value:",",description:'","'},$r=function(e,t){return 0==t.length?e:t[t.length-1]},ea="?",ta={type:"literal",value:"?",description:'"?"'},ra=":",aa={type:"literal",value:":",description:'":"'},na=function(e,t,r){var a=e;return a.push.apply(a,t),a.push.apply(a,r),a.push({TYPE:"conditional_expr",PLACES:3}),a},_a=function(e,t){var r=e;if(t.length){for(var a={TYPE:"logical_or_expr",PLACES:t.length+1},n=0;n<t.length;n++)r.push.apply(r,t[n][3]);r.push(a)}return r},sa=function(e,t){var r=e;if(t.length){for(var a={TYPE:"logical_and_expr",PLACES:t.length+1},n=0;n<t.length;n++)r.push.apply(r,t[n][3]);r.push(a)}return r},oa=function(e,t){var r=e;if(t.length){for(var a={TYPE:"logical_bitor_expr",PLACES:t.length+1},n=0;n<t.length;n++)r.push.apply(r,t[n][3]);r.push(a)}return r},ia=function(e,t){var r=e;if(t.length){for(var a={TYPE:"logical_bitxor_expr",PLACES:t.length+1},n=0;n<t.length;n++)r.push.apply(r,t[n][3]);r.push(a)}return r},la=function(e,t){var r=e;if(t.length){for(var a={TYPE:"logical_bitand_expr",PLACES:t.length+1},n=0;n<t.length;n++)r.push.apply(r,t[n][3]);r.push(a)}return r},ca=function(e,t){for(var r=e,a=0;a<t.length;a++)switch(t[a][1]){case"==":n={TYPE:"equal_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case"!=":var n={TYPE:"non_equal_expr",PLACES:2};r.push.apply(r,t[a][3]),r.push(n)}return r},ua=function(e,t){for(var r=e,a=0;a<t.length;a++)switch(t[a][1]){case"<=":n={TYPE:"le_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case">=":n={TYPE:"ge_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case"<":n={TYPE:"l_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case">":var n={TYPE:"g_expr",PLACES:2};r.push.apply(r,t[a][3]),r.push(n)}return r},da=function(e,t){for(var r=e,a=0;a<t.length;a++)switch(t[a][1]){case"<<":n={TYPE:"left_shift_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case">>":var n={TYPE:"right_shift_expr",PLACES:2};r.push.apply(r,t[a][3]),r.push(n)}return r},fa=function(e,t){for(var r=e,a=0;a<t.length;a++)switch(t[a][1]){case"+":n={TYPE:"add_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case"-":var n={TYPE:"sub_expr",PLACES:2};r.push.apply(r,t[a][3]),r.push(n)}return r},ma=function(e,t){for(var r=e,a=0;a<t.length;a++)switch(t[a][1]){case"*":n={TYPE:"mul_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case"/":n={TYPE:"div_expr",PLACES:2},r.push.apply(r,t[a][3]),r.push(n);break;case"%":var n={TYPE:"mod_expr",PLACES:2};r.push.apply(r,t[a][3]),r.push(n)}return r},pa="defined",ha={type:"literal",value:"defined",description:'"defined"'},va=function(e){return e},ba=function(e,t){var r=t;switch(e){case"++":a={TYPE:"pre_inc_expr",PLACES:1},r.push(a);break;case"--":a={TYPE:"pre_dec_expr",PLACES:1},r.push(a);break;case"+":a={TYPE:"positive_expr",PLACES:1},r.push(a);break;case"-":a={TYPE:"negative_expr",PLACES:1},r.push(a);break;case"~":a={TYPE:"one_compl_expr",PLACES:1},r.push(a);break;case"!":var a={TYPE:"logic_negative_expr",PLACES:1};r.push(a)}return r},ga=function(e,t){var r=e;switch(t){case"++":a={TYPE:"post_inc_expr",PLACES:1},r.push(a);break;case"--":var a={TYPE:"post_dec_expr",PLACES:1};r.push(a)}return r},ya=function(e){return[e]},Ea=function(e){return[e]},wa="(",Aa={type:"literal",value:"(",description:'"("'},Ta=")",xa={type:"literal",value:")",description:'")"'},Oa=function(e){return e},Ra=function(){return 1},ka={type:"other",description:"number"},Na=function(e){return e},Ma=function(e){return parseInt(e)},Ia={type:"other",description:"identifier"},Sa=function(e){return e},La="++",Ca={type:"literal",value:"++",description:'"++"'},Pa="--",Da={type:"literal",value:"--",description:'"--"'},Ua="+",Fa={type:"literal",value:"+",description:'"+"'},Ba="-",Ga={type:"literal",value:"-",description:'"-"'},ja="~",za={type:"literal",value:"~",description:'"~"'},Ya="!",Ha={type:"literal",value:"!",description:'"!"'},Wa="*",qa={type:"literal",value:"*",description:'"*"'},Va="/",Xa={type:"literal",value:"/",description:'"/"'},Ka="%",Za={type:"literal",value:"%",description:'"%"'},Qa="=",Ja={type:"literal",value:"=",description:'"="'},$a=function(e){return e},en=function(){return"+"},tn=function(){return"-"},rn="<<",an={type:"literal",value:"<<",description:'"<<"'},nn=">>",_n={type:"literal",value:">>",description:'">>"'},sn="<=",on={type:"literal",value:"<=",description:'"<="'},ln=">=",cn={type:"literal",value:">=",description:'">="'},un="<",dn={type:"literal",value:"<",description:'"<"'},fn=">",mn={type:"literal",value:">",description:'">"'},pn="==",hn={type:"literal",value:"==",description:'"=="'},vn="!=",bn={type:"literal",value:"!=",description:'"!="'},gn="&",yn={type:"literal",value:"&",description:'"&"'},En=function(){return"&"},wn="^",An={type:"literal",value:"^",description:'"^"'},Tn=function(){return"^"},xn="|",On={type:"literal",value:"|",description:'"|"'},Rn=function(){return"|"},kn="&&",Nn={type:"literal",value:"&&",description:'"&&"'},Mn=function(){return"&&"},In="||",Sn={type:"literal",value:"||",description:'"||"'},Ln=function(){return"||"},Cn='"',Pn={type:"literal",value:'"',description:'"\\""'},Dn=function(e){for(var t="",r=0;r<e.length;r++)t+=e[r][1];return t},Un=function(e,t){return e+t.join("")},Fn="$",Bn={type:"literal",value:"$",description:'"$"'},Gn="_",jn={type:"literal",value:"_",description:'"_"'},zn=/^[a-zA-Z]/,Yn={type:"class",value:"[a-zA-Z]",description:"[a-zA-Z]"},Hn="#define",Wn={type:"literal",value:"#define",description:'"#define"'},qn="#elif",Vn={type:"literal",value:"#elif",description:'"#elif"'},Xn="#else",Kn={type:"literal",value:"#else",description:'"#else"'},Zn="#endif",Qn={type:"literal",value:"#endif",description:'"#endif"'},Jn="#error",$n={type:"literal",value:"#error",description:'"#error"'},e_="#if",t_={type:"literal",value:"#if",description:'"#if"'},r_="#ifdef",a_={type:"literal",value:"#ifdef",description:'"#ifdef"'},n_="#ifndef",__={type:"literal",value:"#ifndef",description:'"#ifndef"'},s_="#include",o_={type:"literal",value:"#include",description:'"#include"'},i_="#line",l_={type:"literal",value:"#line",description:'"#line"'},c_="#pragma",u_={type:"literal",value:"#pragma",description:'"#pragma"'},d_="#warning",f_={type:"literal",value:"#warning",description:'"#warning"'},m_="#version",p_={type:"literal",value:"#version",description:'"#version"'},h_=".",v_={type:"literal",value:".",description:'"."'},b_="0",g_={type:"literal",value:"0",description:'"0"'},y_=/^[xX]/,E_={type:"class",value:"[xX]",description:"[xX]"},w_=function(e){return e},A_=function(e){return e},T_=function(e){return String(parseInt("0x"+e))},x_=/^[0-9]/,O_={type:"class",value:"[0-9]",description:"[0-9]"},R_=/^[1-9]/,k_={type:"class",value:"[1-9]",description:"[1-9]"},N_=/^[eE]/,M_={type:"class",value:"[eE]",description:"[eE]"},I_=/^[\-+]/,S_={type:"class",value:"[-+]",description:"[-+]"},L_=/^[0-9a-fA-F]/,C_={type:"class",value:"[0-9a-fA-F]",description:"[0-9a-fA-F]"},P_={type:"other",description:"string"},D_="'",U_={type:"literal",value:"'",description:'"\'"'},F_=function(e){return'"'+e[1]+'"'},B_=function(e){return e.join("")},G_="\\",j_={type:"literal",value:"\\",description:'"\\\\"'},z_=function(e){return e},Y_=function(e){return e},H_=function(e){return e},W_=function(){return"\0"},q_=/^['"\\bfnrtv]/,V_={type:"class",value:"['\"\\\\bfnrtv]",description:"['\"\\\\bfnrtv]"},X_=function(e){return e.replace("b","\b").replace("f","\f").replace("n","\n").replace("r","\r").replace("t","\t").replace("v","\v")},K_=function(e){return e},Z_="x",Q_={type:"literal",value:"x",description:'"x"'},J_="u",$_={type:"literal",value:"u",description:'"u"'},es=function(e){return String.fromCharCode(parseInt("0x"+e))},ts={type:"other",description:"punctuation"},rs="+=",as={type:"literal",value:"+=",description:'"+="'},ns="-=",_s={type:"literal",value:"-=",description:'"-="'},ss="*=",os={type:"literal",value:"*=",description:'"*="'},is="/=",ls={type:"literal",value:"/=",description:'"/="'},cs="%=",us={type:"literal",value:"%=",description:'"%="'},ds="^=",fs={type:"literal",value:"^=",description:'"^="'},ms="&=",ps={type:"literal",value:"&=",description:'"&="'},hs="|=",vs={type:"literal",value:"|=",description:'"|="'},bs="<<=",gs={type:"literal",value:"<<=",description:'"<<="'},ys=">>=",Es={type:"literal",value:">>=",description:'">>="'},ws="{",As={type:"literal",value:"{",description:'"{"'},Ts="}",xs={type:"literal",value:"}",description:'"}"'},Os="[",Rs={type:"literal",value:"[",description:'"["'},ks="]",Ns={type:"literal",value:"]",description:'"]"'},Ms=";",Is={type:"literal",value:";",description:'";"'},Ss={type:"other",description:"whitespace"},Ls=/^[\t\x0B\f ]/,Cs={type:"class",value:"[\\t\\v\\f ]",description:"[\\t\\v\\f ]"},Ps=/^[\n\r]/,Ds={type:"class",value:"[\\n\\r]",description:"[\\n\\r]"},Us={type:"other",description:"end of line"},Fs="\n",Bs={type:"literal",value:"\n",description:'"\\n"'},Gs="\r\n",js={type:"literal",value:"\r\n",description:'"\\r\\n"'},zs="\r",Ys={type:"literal",value:"\r",description:'"\\r"'},Hs={type:"other",description:"comment"},Ws="/*",qs={type:"literal",value:"/*",description:'"/*"'},Vs="*/",Xs={type:"literal",value:"*/",description:'"*/"'},Ks="//",Zs={type:"literal",value:"//",description:'"//"'},Qs={type:"any",description:"any character"},Js=0,$s=0,eo={line:1,column:1,seenCR:!1},to=0,ro=[],ao=0;if("startRule"in at){if(!(at.startRule in _t))throw new Error("Can't start parsing from rule \""+at.startRule+'".');st=_t[at.startRule]}if((rt=st())!==nt&&Js===t.length)return rt;throw rt!==nt&&Js<t.length&&a({type:"end",description:"end of input"}),function(a,n,_){var s=r(_),o=_<t.length?t.charAt(_):null;return null!==n&&function(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}(n),new e(null!==a?a:function(e,t){var r,a,n,_=new Array(e.length);for(n=0;n<e.length;n++)_[n]=e[n].description;return r=e.length>1?_.slice(0,-1).join(", ")+" or "+_[e.length-1]:_[0],a=t?'"'+function(e){function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+r(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+r(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+r(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+r(e)})}()+'"':"end of input","Expected "+r+" but "+a+" found."}(n,o),n,o,_,s.line,s.column)}(null,ro,to)}}}()});return{}});
